## 1. Vấn đề
1. Không có key
2. có key nhưng null/none => trả về none gây lỗi => Cần fix để nó trả về {} khi gặp case này
3. CÓ data
  

### Triệu chứng

- API `/search_facts` trả về lỗi 500 Internal Server Error

- Error message: `'NoneType' object has no attribute 'get'`

- Lỗi xảy ra ở line 194 trong hàm `transform_search_results_to_facts()`

  
  

### Error log

```

File "/app/main.py", line 194, in transform_search_results_to_facts

    "fact_type": metadata.get("categories", []),

                 ^^^^^^^^^^^^

AttributeError: 'NoneType' object has no attribute 'get'

```

  

---

  

## 2. Nguyên nhân

  

### Root cause

  

Code cũ:

```python

metadata = result.get("metadata", {})

```

  

Vấn đề với `.get(key, default)`:

- Chỉ dùng default khi key không tồn tại

- Nếu key tồn tại nhưng giá trị là `None`, nó trả về `None`, không dùng default

### Ví dụ minh họa

  

```python

# Case 1: Key không tồn tại

result = {"id": "123"}

metadata = result.get("metadata", {})  # → {} ✅ OK

  

# Case 2: Key tồn tại và có giá trị

result = {"id": "123", "metadata": {"categories": ["hobbies"]}}

metadata = result.get("metadata", {})  # → {"categories": ["hobbies"]} ✅ OK

  

# Case 3: Key tồn tại nhưng giá trị là None

result = {"id": "123", "metadata": None}

metadata = result.get("metadata", {})  # → None ❌ BUG!

# Sau đó:

metadata.get("categories", [])  # → AttributeError: 'NoneType' object has no attribute 'get'

```

  
  
  

Cách này xử lý cả 3 trường hợp: key không tồn tại, key có giá trị `None`, và key có giá trị hợp lệ.

  
  

So sánh code trước và sau khi fix:

  

## 1. Code lúc trước (có bug)

  

```python

def transform_search_results_to_facts(results: List[Dict[str, Any]]) -> Dict[str, Any]:

    facts = []

    for result in results:

        metadata = result.get("metadata", {})  # ❌ BUG: Nếu metadata = None, vẫn trả về None

        fact = {

            "id": result.get("id"),

            "fact_value": result.get("memory", ""),

            "fact_type": metadata.get("categories", []),  # ❌ Lỗi ở đây khi metadata = None

            "score": result.get("score"),

            "user_id": result.get("user_id"),

            "metadata": metadata

        }

        facts.append(fact)

    return {"status": "ok", "count": len(facts), "facts": facts}

```

  

Vấn đề:

- `result.get("metadata", {})` chỉ dùng default `{}` khi key không tồn tại

- Nếu key tồn tại nhưng giá trị là `None`, nó trả về `None`

- Khi `metadata = None`, gọi `metadata.get("categories", [])` sẽ lỗi: `AttributeError: 'NoneType' object has no attribute 'get'`

  

## 2. Code hiện tại (đã fix)

  

```python

def transform_search_results_to_facts(results: List[Dict[str, Any]]) -> Dict[str, Any]:

    facts = []

    for result in results:

        # Fix: Ensure metadata is always a dict, not None

        metadata = result.get("metadata") or {}  # ✅ Fix: Xử lý cả None

        # Thứ tự các trường quan trọng: id, fact_value, fact_type, score, user_id, metadata

        fact = {

            "id": result.get("id"),

            "fact_value": result.get("memory", ""),

            "fact_type": metadata.get("categories", []),  # ✅ An toàn vì metadata luôn là dict

            "score": result.get("score"),

            "user_id": result.get("user_id"),

            "metadata": metadata

        }

        facts.append(fact)

    return {"status": "ok", "count": len(facts), "facts": facts}

```

  

Cách fix:

- `result.get("metadata") or {}` xử lý cả hai trường hợp:

  - Key không tồn tại → `None` → `or {}` → `{}`

  - Key tồn tại nhưng giá trị là `None` → `None` → `or {}` → `{}`

  - Key tồn tại và có giá trị → trả về giá trị đó

  

## So sánh

  

| Trường hợp | Code cũ | Code mới |

|------------|---------|----------|

| `metadata` không tồn tại | `{}` | `{}` |

| `metadata = None` | `None` → lỗi | `{}` |

| `metadata = {...}` | `{...}` | `{...}` |

  

Kết quả: Code mới xử lý an toàn cả 3 trường hợp, không còn lỗi khi `metadata = None`.