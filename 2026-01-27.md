
  

# Plan: Refactor initConversation với meta_data

  

## 1. Tổng quan

  

### 1.1. Mục tiêu

  

- Gộp logic `initWelcomeBack` vào `initConversation` thông qua field `meta_data`

- Bỏ endpoint `/initWelcomeBack` riêng

- **BE tự quyết định `conversation_id`**:

  - `is_done = true` → BE tự tạo `conversation_id` mới và truyền vào

  - `is_done = false` → BE tự dùng `conversation_id` cũ và truyền vào

- **InitConversation check đồng thời**:

  - `is_done`: Quyết định tạo conversation mới hay load conversation cũ (dựa vào `conversation_id` đã có)

  - `is_reopening`: Quyết định có gen câu chào từ prompt hay không (chỉ khi = true)

  

### 1.2. Architecture Flow

  

```

BE Side:

    ↓

Check is_done và is_reopening

    ├─ is_done = true → Tạo conversation_id mới

    └─ is_done = false → Dùng conversation_id cũ

    ↓

Gọi InitConversation với conversation_id đã quyết định

  

InitConversation Side:

    ↓

Check meta_data đồng thời:

    ├─ is_done:

    │   ├─ true → Tạo conversation mới (conversation_id mới từ BE)

    │   └─ false → Load conversation cũ từ Redis (conversation_id cũ từ BE)

    │

    └─ is_reopening:

        ├─ true → Gen reopening_message từ prompt

        │   ↓

        │   Lưu reopening_message vào session

        └─ false hoặc không có → Không làm gì

  

Webhook đầu tiên

    ↓

Check reopening_message (ưu tiên)

    ├─ Có reopening_message → Trả về reopening_message ngay lập tức

    │   ↓

    │   Clear reopening_message khỏi session

    │   (Tiếp tục check welcome_back_message nếu có)

    │

    └─ Không có reopening_message

        ↓

        Check welcome_back_needed

        ├─ true → Trả về welcome_back_message ngay lập tức

        │   ↓

        │   Clear welcome_back_needed và welcome_back_message

        └─ false → Xử lý bình thường với AI

```

  

## 2. Data Structure

  

### 2.1. Request Format

  

**Base Request (giữ nguyên):**

  

```json

{

  "bot_id": 431,

  "conversation_id": "b87be6b6-395d-4b13-9748-05d119e03036_40647ede-651d-4c63-965d-75bf398d9af7",

  "user_id": "019b4ec1-2542-7669-b8ea-b405dbbbf210",

  "input_slots": {}

}

```

  

**meta_data Structure:**

  

```python

meta_data = {

    # Reopening data

    "reopening_data": Optional[Dict[str, Any]] = {

        # Từ BE (gửi lên trong request)

        "from_be": {

            "is_reopening": bool,  # true/false

            "time_away_seconds": Optional[int],

            "previous_lesson_name": Optional[str],

            "current_lesson_name": Optional[str]

        },

        # Từ prompt (extract sau, luôn là {} trong request)

        "from_context_handling": {

            "intent_to_continue": Optional[bool],

            "leave_reason": Optional[str],

            "previous_lesson_summary": Optional[str]

        }

    },

    # Trạng thái bài trước

    "is_done": bool  # true = DONE, false = NOT DONE

}

```

  

### 2.2. Logic Decision Matrix

  

| is_done | is_reopening | Action | Message Source |

  

|---------|--------------|--------|----------------|

  

| true | true | Tạo conversation mới | reopening_message (gen từ prompt) |

  

| true | false/None | Tạo conversation mới | Không có |

  

| false | true | Load conversation cũ | reopening_message (gen từ prompt) + welcome_back_message (lấy từ DB)|

  

| false | false/None | Load conversation cũ | welcome_back_message (lấy từ DB) |

  

| None | - | Tạo conversation mới (backward compat) | Không có |

  

  

## 4. Full cURL Examples

  

### 4.1. DONE - Backward compatibility (không có meta_data)

  

```bash

curl --location 'http://localhost:30000/robot-ai-workflow/api/v1/bot/initConversation' \

--header 'Content-Type: application/json' \

--header 'accept: application/json' \

--data '{

  "bot_id": 431,

  "conversation_id": "b87be6b6-395d-4b13-9748-05d119e03036_40647ede-651d-4c63-965d-75bf398d9af7",

  "user_id": "019b4ec1-2542-7669-b8ea-b405dbbbf210",

  "input_slots": {}

}'

```

  

### 4.2. DONE + is_reopening = true

  

```bash

curl --location 'http://localhost:30000/robot-ai-workflow/api/v1/bot/initConversation' \

--header 'Content-Type: application/json' \

--header 'accept: application/json' \

--data '{

  "bot_id": 431,

  "conversation_id": "b87be6b6-395d-4b13-9748-05d119e03036_40647ede-651d-4c63-965d-75bf398d9af7",

  "user_id": "019b4ec1-2542-7669-b8ea-b405dbbbf210",

  "input_slots": {},

  "meta_data": {

    "is_done": true,

    "reopening_data": {

      "from_be": {

        "is_reopening": true,

        "time_away_seconds": 7200,

        "previous_lesson_name": "Bài học số 1",

        "current_lesson_name": "Bài học số 2"

      },

      "from_context_handling": {}

    }

  }

}'

```

  
