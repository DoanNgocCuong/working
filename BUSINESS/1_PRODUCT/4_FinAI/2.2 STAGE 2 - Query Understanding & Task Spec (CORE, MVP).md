
# Stage 2 – Query Understanding & Task Spec (CORE, MVP)

> Tiếp nối Stage 1 – UnifiedInputCore  
> Input: `UnifiedInputCore`  
> Output: `TaskSpecV1` bọc trong `QUOutputV1` cho planner/agents.

---

## 0. Mục tiêu & Scope

### Mục tiêu

- Nhận `UnifiedInputCore` từ **Stage 1**.
- Hiểu ý định + bối cảnh → sinh **TaskSpecV1** có cấu trúc cho planner/agents:
  - `intent`: `summarize | explain | act`
  - `scope`: `page | multi_page | web | personal | general`
  - `artifact`: `brief | answer | compare | plan | extract`
  - `action_level`: `Act-0 | Act-1 | Act-2`
  - `risk`: `low | medium | high`
  - `entities`: budget, time, quantity, travel, preferences, sources…
  - `policy`: PII risk, injection, requires_confirm, missing_slots…

### Không làm ở Stage 2

- ❌ Không fetch HTML, không web search.
- ❌ Không thực thi task (send mail, thanh toán, submit form).
- ❌ Không gọi LLM to; nếu cần model → **1 SLM nhỏ**.

Stage 2 là lớp **“Query Understanding (QU)”**: chuẩn hoá *ý định* thay vì *input thô*.

---

## 1. Kiến trúc tổng & sơ đồ

Stage 2 được thiết kế theo pattern:

- **Rule-first** (rẻ, nhanh, explainable).
- **SLM-backup** (1 call, joint A+B+C) chỉ khi rule không chắc.

Có hai đường chạy:

- **Fast path (Rule-only)**: đa số request → chỉ dùng Rule Engine.
- **Slow path (Rule + 1 SLM)**: cho câu khó/mơ hồ.

```text
                 +--------------------------------------+
                 |      STAGE 1 – UnifiedInputCore      |
                 |   (normalize input: text / URL / …)  |
                 +-----------------+--------------------+
                                   |
                                   v
                 +--------------------------------------+
                 |      STAGE 2 – Query Understanding   |
                 |      (build TaskSpecV1 skeleton)     |
                 +-----------------+--------------------+
                                   |
                                   v
                    +-------------------------------+
                    |  RULE ENGINE (A+B+C+D guess)  |
                    |  - 4.1 Intent (A)             |
                    |  - 4.2 Facets (B)             |
                    |  - 4.3 Entities-hard (C)      |
                    |  - 4.4 Policy-base (D)        |
                    +-----------------+-------------+
                                      |
                           +----------+----------+
                           |  confidence ≥ 0.85? |
                           +----------+----------+
                                      |
                         yes          |          no
                (FAST PATH)           |    (SLOW PATH – SLM)
                                      |
                                      |
             +------------------------+--------------------------+
             |                                                   |
             v                                                   v
+-------------------------------+                 +-------------------------------+
| Build TaskSpec from RULES     |                 | call_QU_SLM (joint A+B+C)     |
| - intent / scope / artifact   |                 | input:                        |
| - action_level / risk         |                 |   - UnifiedInputCore         |
| - entities (hard parsed)      |                 |   - rule_engine suggestions  |
+---------------+---------------+                 | output:                      |
                |                                 |   - intent, facets, entities |
                |                                 +---------------+-------------+
                |                                                 |
                +------------------------+------------------------+
                                         v
                          +----------------------------------+
                          |  POLICY OVERRIDES (Stage D final)|
                          |  - enforce Act-2 ⇒ confirm       |
                          |  - PII / injection checks        |
                          |  - fix requires_confirm, risk    |
                          +-----------------+----------------+
                                            |
                                            v
                                +--------------------------+
                                |   FINAL TaskSpecV1 OUT   |
                                |   (for planner/agents)   |
                                +--------------------------+
```

---

## 2. Data Model (tóm tắt)

### 2.1. Intent & Facets

```ts
type IntentKernel = "summarize" | "explain" | "act";

type Scope =
  | "page"
  | "multi_page"
  | "web"
  | "personal"
  | "general";

type Artifact =
  | "brief"
  | "answer"
  | "compare"
  | "plan"
  | "extract";

type ActionLevel = "Act-0" | "Act-1" | "Act-2";
type RiskLevel = "low" | "medium" | "high";
```

### 2.2. Entities / Constraints

```ts
type MoneyConstraint = {
  amount: number;
  currency: string;
  original_text?: string;
};

type QuantityConstraint = {
  shortlist?: number;
  compare_pool?: number;
};

type TimeConstraint = {
  date_from?: string;
  date_to?: string;
  specific_date?: string;
  original_text?: string;
};

type TravelConstraint = {
  from?: string;
  to?: string;
  date?: string;
  original_text?: string;
};

type SourceConstraint = {
  include_domains?: string[];
  exclude_domains?: string[];
  only_official?: boolean;
};

type EntityBag = {
  budget?: MoneyConstraint;
  time?: TimeConstraint;
  quantity?: QuantityConstraint;
  travel?: TravelConstraint;
  sources?: SourceConstraint;

  preferences?: string[];
  raw_slots?: Record<string, any>;
};
```

### 2.3. Policy Hints

```ts
type PolicyHints = {
  pii_risk: "none" | "possible" | "likely";
  injection_risk: boolean;
  has_sensitive_action: boolean;
  requires_confirm: boolean;
  missing_slots: string[];
};
```

### 2.4. TaskSpecV1 & QUOutputV1

```ts
type TaskContext = {
  language: string;
  normalized_text: string;
  urls_in_text: string[];
  page_context?: UnifiedInputCore["page_context"];
};

type TaskSpecV1 = {
  spec_id: string;
  version: "v1";

  input_id: string;

  intent: IntentKernel;
  scope: Scope;
  artifact: Artifact;
  action_level: ActionLevel;
  risk: RiskLevel;

  entities: EntityBag;
  context: TaskContext;
  policy: PolicyHints;

  _from_slm?: boolean;
  _rule_confidence?: number;
};

type Stage2Telemetry = {
  stage2_total_latency_ms: number;
  modules: Record<string, number>;
  model_calls: number; // 0 hoặc 1
};

type QUOutputV1 = {
  input: UnifiedInputCore;
  task_spec: TaskSpecV1;
  telemetry: Stage2Telemetry;
};
```

---

## 3. Rule Engine – Trái tim của Stage 2

**Rule Engine là module bắt buộc, chạy cho *mọi* request.**

Nhiệm vụ:

- Đoán nhanh 4 lớp A/B/C/D:
  - A – `intent` (kernel)
  - B – `scope`, `artifact`, `action_level`, `risk`
  - C – `entities_hard`: các entity “cứng” (budget, time, quantity, travel)
  - D – `policy_base`: vài flag thô (PII/injection)
- Trả ra thêm `confidence` để quyết định:
  - `confidence ≥ 0.85` → **Fast path** (chỉ rule)
  - `< 0.85` → **Slow path** (gọi SLM)

### 3.1. Kiểu dữ liệu `RuleEngineResult`

```ts
type RuleEngineResult = {
  intent: IntentKernel;
  scope: Scope;
  artifact: Artifact;
  action_level: ActionLevel;
  risk: RiskLevel;

  entities_hard: Partial<EntityBag>;
  policy_base: Partial<PolicyHints>;

  confidence: number; // 0–1
};
```

### 3.2. Logic chính (pseudo-code)

```ts
function runRuleEngine_ABCD(envelope: UnifiedInputCore): RuleEngineResult {
  const text = envelope.query.text_normalized.toLowerCase();
  const urls = envelope.query.urls_in_text || [];
  const pc = envelope.page_context || {};
  const sf = envelope.safety_flags || {};

  // --- A) Intent ---
  let intent: IntentKernel = "explain";
  let intent_score = 0.3;

  if (/tóm tắt|summary|summarize|tl;dr/.test(text)) {
    intent = "summarize"; intent_score = 0.95;
  } else if (/giải thích|tại sao|vì sao|why|how|khác gì|difference/.test(text)) {
    intent = "explain"; intent_score = 0.9;
  } else if (/chọn|so sánh|lên plan|đặt vé|điền form|mua giúp|đặt hàng|book/.test(text)) {
    intent = "act"; intent_score = 0.9;
  }

  // --- B1) Scope ---
  let scope: Scope = "general";
  if (/bài này|trang này|this page|current tab/.test(text) && pc.active_url) {
    scope = "page";
  } else if (urls.length > 1) {
    scope = "multi_page";
  } else if (urls.length === 1 && !pc.active_url) {
    scope = "multi_page";
  } else if (/email|gmail|calendar|lịch|drive|tệp cá nhân/.test(text)) {
    scope = "personal";
  } else if (/trên mạng|web|search|tìm giúp/.test(text)) {
    scope = "web";
  }

  // --- B2) Artifact ---
  let artifact: Artifact = "answer";
  if (intent === "summarize") {
    artifact = "brief";
  } else if (intent === "explain") {
    artifact = "answer";
  } else if (intent === "act") {
    if (/so sánh|shortlist|chọn/.test(text)) artifact = "compare";
    else if (/lên plan|lịch trình|itinerary|checklist/.test(text)) artifact = "plan";
    else if (/trích|extract|liệt kê|bảng|table/.test(text)) artifact = "extract";
  }

  // --- B3) Action level ---
  let action_level: ActionLevel = "Act-0";
  if (/soạn nháp|draft|nháp/.test(text)) action_level = "Act-1";
  if (/gửi|send|submit|thanh toán|đặt vé|book|checkout/.test(text)) {
    action_level = "Act-2";
  }

  // --- B4) Risk (thô) ---
  let risk: RiskLevel = "low";
  if (scope === "personal" || sf.raw_input_too_long) risk = "medium";
  if (action_level === "Act-2") risk = "high";

  // --- C) Entities-hard ---
  const entities_hard: Partial<EntityBag> = {};
  entities_hard.budget   = parseBudget(text);       // "20tr", "<500k", "18-22tr"
  entities_hard.quantity = parseQuantity(text);     // "chọn 2", "gợi ý 3"
  entities_hard.time     = parseTimeConstraints(text);
  entities_hard.travel   = parseTravel(text);

  // --- D) Policy-base ---
  const policy_base: Partial<PolicyHints> = {};
  if (/\d{16}/.test(text) || /otp|one-time password|mã xác thực/.test(text)) {
    policy_base.pii_risk = "likely";
  } else if (/số tài khoản|số thẻ|mật khẩu|password|pin/.test(text)) {
    policy_base.pii_risk = "possible";
  } else {
    policy_base.pii_risk = "none";
  }

  policy_base.injection_risk =
    /ignore previous instructions|bỏ qua mọi hướng dẫn trước đó|bỏ hết rule/.test(text) || false;

  // --- Confidence tổng (simple heuristic) ---
  const confidence = Math.min(
    1,
    0.4 * intent_score +
      0.2 * (entities_hard.budget ? 1 : 0.5) +
      0.2 * (entities_hard.time ? 1 : 0.5) +
      0.2 * (scope !== "general" ? 1 : 0.5)
  );

  return {
    intent,
    scope,
    artifact,
    action_level,
    risk,
    entities_hard,
    policy_base,
    confidence
  };
}
```

---

## 4. SLM joint module (Slow path – A+B+C)

Khi `ruleResult.confidence < 0.85`, Stage 2 dùng **1 SLM nhỏ** để refine:

- `intent`
- `scope`, `artifact`, `action_level`, `risk`
- `entities` đầy đủ (bao gồm preferences, sources, raw_slots…)

```ts
async function call_QU_SLM(
  envelope: UnifiedInputCore,
  ruleResult: RuleEngineResult
): Promise<TaskSpecV1> {
  const prompt = buildPromptFor_QU_SLM(envelope, ruleResult);
  const raw = await callSmallModel(prompt);
  const parsed = safeJsonParse(raw);

  const spec: TaskSpecV1 = {
    spec_id: uuidv4(),
    version: "v1",
    input_id: envelope.input_id,

    intent: parsed.intent,
    scope: parsed.scope,
    artifact: parsed.artifact,
    action_level: parsed.action_level,
    risk: parsed.risk,

    entities: parsed.entities,
    context: {
      language: envelope.query.detected_lang,
      normalized_text: envelope.query.text_normalized,
      urls_in_text: envelope.query.urls_in_text || [],
      page_context: envelope.page_context
    },
    policy: parsed.policy || {
      pii_risk: "none",
      injection_risk: false,
      has_sensitive_action: false,
      requires_confirm: false,
      missing_slots: []
    },

    _from_slm: true,
    _rule_confidence: ruleResult.confidence
  };

  return spec;
}
```

Prompt QU_SLM có thể:

- Nhét:
  - `text_normalized`, `detected_lang`, `urls_in_text`, `page_context`
  - `rule_guess` (intent/scope/…/entities_hard)
- Yêu cầu output chuẩn JSON theo schema `TaskSpecV1` (trừ `spec_id`, `input_id`).

---

## 5. Policy Overrides (Stage D final – Rule-only)

Bất kể là fast hay slow path, luôn chạy **policy override** cuối cùng:

- Enforce invariant an toàn.
- Bắt PII/injection rõ hơn.
- Điền `missing_slots`.

```ts
function runPolicyOverrides(
  envelope: UnifiedInputCore,
  taskSpec: TaskSpecV1,
  ruleResult?: RuleEngineResult
): PolicyHints {
  const text = envelope.query.text_normalized.toLowerCase();
  const base = taskSpec.policy || {};

  // 1) PII risk (ưu tiên max)
  let pii_risk: PolicyHints["pii_risk"] = base.pii_risk || "none";
  if (/\d{16}/.test(text) || /otp|one-time password|mã xác thực/.test(text)) {
    pii_risk = "likely";
  } else if (/số tài khoản|số thẻ|mật khẩu|password|pin/.test(text)) {
    pii_risk = "possible";
  }

  // 2) Injection risk
  const injection_risk =
    base.injection_risk ||
    /ignore previous instructions|bỏ qua mọi hướng dẫn trước đó|bỏ hết rule/.test(text);

  // 3) Sensitive action
  const has_sensitive_action =
    base.has_sensitive_action ||
    taskSpec.action_level === "Act-2" ||
    /thanh toán|chuyển khoản|transfer|payment|checkout|đặt vé|book/.test(text);

  // 4) Requires confirm
  let requires_confirm =
    base.requires_confirm || has_sensitive_action || pii_risk !== "none";

  // 5) Missing slots
  const missing_slots = base.missing_slots ? [...base.missing_slots] : [];

  if (taskSpec.intent === "act") {
    if (taskSpec.entities.travel && !taskSpec.entities.travel.date) {
      missing_slots.push("travel.date");
    }
    if (!taskSpec.entities.budget &&
        /laptop|điện thoại|phone|pc|màn hình/.test(text)) {
      missing_slots.push("budget");
    }
  }

  return {
    pii_risk,
    injection_risk,
    has_sensitive_action,
    requires_confirm,
    missing_slots
  };
}
```

---

## 6. Orchestration – `runQueryUnderstanding`

```ts
async function runQueryUnderstanding(
  envelope: UnifiedInputCore
): Promise<QUOutputV1> {
  const t0 = now();
  const modulesLatency: Record<string, number> = {};
  let modelCalls = 0;

  // 1) Rule Engine
  const tRule0 = now();
  const ruleRes = runRuleEngine_ABCD(envelope);
  modulesLatency["ruleEngine"] = now() - tRule0;

  // 2) Fast vs Slow
  let taskSpec: TaskSpecV1;
  if (ruleRes.confidence >= 0.85) {
    const tBuild0 = now();
    taskSpec = buildTaskSpecFromRule(envelope, ruleRes);
    modulesLatency["buildFromRule"] = now() - tBuild0;
  } else {
    const tSLM0 = now();
    taskSpec = await call_QU_SLM(envelope, ruleRes);
    modulesLatency["QU_SLM"] = now() - tSLM0;
    modelCalls += 1;
  }

  // 3) Policy overrides (D final)
  const tPol0 = now();
  const finalPolicy = runPolicyOverrides(envelope, taskSpec, ruleRes);
  taskSpec.policy = finalPolicy;
  modulesLatency["policyOverrides"] = now() - tPol0;

  // 4) Telemetry
  const total = now() - t0;
  const telemetry: Stage2Telemetry = {
    stage2_total_latency_ms: total,
    modules: modulesLatency,
    model_calls: modelCalls
  };

  return { input: envelope, task_spec: taskSpec, telemetry };
}
```

`buildTaskSpecFromRule`:

- Map trực tiếp `ruleRes.intent/scope/artifact/action_level/risk` vào `TaskSpecV1`.
- `entities = merge(ruleRes.entities_hard, { preferences: [], raw_slots: {} })`.
- `policy = ruleRes.policy_base` (sau đó `runPolicyOverrides` chỉnh lại).
- Gán `_from_slm = false`, `_rule_confidence = ruleRes.confidence`.

---

## 7. Ví dụ input–output ngắn (sanity check)

User:

> “Chọn 2 laptop dưới 20tr, nhẹ, pin trâu, màn đẹp, so sánh tối đa 5 lựa chọn.”

- Rule Engine:
  - `intent = "act"`
  - `scope = "web"`
  - `artifact = "compare"`
  - `action_level = "Act-0"`
  - `risk = "low"`
  - `entities_hard.budget = { amount: 20000000, currency: "VND", original_text: "20tr" }`
  - `entities_hard.quantity = { shortlist: 2, compare_pool: 5 }`
  - `confidence ≈ 0.9` → **Fast path**.
- TaskSpecV1 (rút gọn):

```json
{
  "intent": "act",
  "scope": "web",
  "artifact": "compare",
  "action_level": "Act-0",
  "risk": "low",
  "entities": {
    "budget": { "amount": 20000000, "currency": "VND", "original_text": "20tr" },
    "quantity": { "shortlist": 2, "compare_pool": 5 },
    "preferences": ["lightweight", "long_battery", "good_display"],
    "raw_slots": {}
  }
}
```

Planner/agents có thể đọc trực tiếp TaskSpec này để:

- Biết phải **search web**,
- Biết dạng output là **compare**,
- Biết constraints: budget / số lượng / preference.

---

Doc Stage 2 đến đây là đủ “xương sống” để dev implement, MLOps theo dõi, và Stage 3 Planner tiêu thụ.
