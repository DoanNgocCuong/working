# AI-Native Browser (Comet-like) ‚Äî Spec MVP chu·∫©n enterprise (v1, ti·∫øng Vi·ªát)

> **Ph·∫°m vi MVP:** Text + Web HTML. Voice/YouTube = **future hooks** (interface-ready, not implemented heavy).

---

## A. T√≥m t·∫Øt ƒëi·ªÅu h√†nh (Executive Summary)

- MVP tri·ªÉn khai pipeline **agentic** theo m√¥ h√¨nh **single orchestrator**: 1 b·ªô ƒëi·ªÅu ph·ªëi trung t√¢m l·∫≠p k·∫ø ho·∫°ch + gi√°m s√°t th·ª±c thi tool, t·ªëi ∆∞u latency/cost b·∫±ng c√°ch ‚Äúƒë·ªÉ model l·ªõn ch·ªâ b·∫≠t ·ªü v√†i ƒëi·ªÉm‚Äù.  
- Stage 1‚Äì2 ch·∫°y **sync** ƒë·ªÉ tr·∫£ **TaskSpecV1** nhanh, deterministic v√† d·ªÖ debug; Stage 3‚Äì6 ch·∫°y **async** (khuy·∫øn ngh·ªã m·∫∑c ƒë·ªãnh) ƒë·ªÉ m·ªü r·ªông d·∫ßn m√† kh√¥ng ph√° API.
- Stage 3 t·∫°o **ActionPlan** tuy·∫øn t√≠nh (steps c√≥ goal/tool/constraints/expected_output) v√† √°p **budget & safety gates** tr∆∞·ªõc khi cho ph√©p browse/tool actions.
- Stage 4 th·ª±c thi plan: retrieval ‚Üí rerank ‚Üí fetch HTML ‚Üí extract main content/tables ‚Üí build **EvidencePack** (ƒë√£ l·ªçc + trace + safety trace).
- Stage 5 suy lu·∫≠n tr√™n EvidencePack (kh√¥ng nh√©t web th√¥): t·∫°o **AnswerSkeleton** (claims + structure) + **CitationMap** + **OpenQuestions**.
- Stage 6 t·ªïng h·ª£p AnswerSkeleton th√†nh **Final Answer** (markdown/blocks), ch√®n citations, c√° nh√¢n ho√° theo profile, ch·∫°y output-safety check.
- NFR (y√™u c·∫ßu phi ch·ª©c nƒÉng): p95 latency (Stage 1‚Äì2) < 1.5s; full run (Stage 3‚Äì6) < 8‚Äì12s (tu·ª≥ allow_browse), c√≥ budget guardrails, retries + idempotency, rate-limit, privacy by design.
- Repo monorepo khuy·∫øn ngh·ªã: `packages/shared` (types/schemas), `services/orchestrator`, `services/retrieval`, `services/web-worker`, `services/model-gateway`, `apps/extension` (optional).
- What‚Äôs next: headless browsing (Playwright), VLM/PDF pipeline, interactive actions (click/fill) v·ªõi sandbox + human approval, personalization ranking, on-device lite models (optional).

---

## B. M·ª•c ti√™u / Kh√¥ng l√†m (Goals / Non-goals)

### Goals (MVP)
- Chu·∫©n ho√° input v·ªÅ **NormalizedInput** (text + optional URL/tab context).
- Sinh **TaskSpecV1** (intent/slots/routing/constraints) ·ªïn ƒë·ªãnh schema.
- L·∫≠p **ActionPlan** + ch·∫°y retrieval/fetch/extract ƒë·ªÉ t·∫°o **EvidencePack**.
- Tr·∫£ l·ªùi c√≥ c·∫•u tr√∫c + citations + error model chu·∫©n.
- C√≥ security/privacy/ops ƒë·ªß ƒë·ªÉ team **build/run/observe**.

### Non-goals (MVP)
- Kh√¥ng build multi-agent swarm song song; kh√¥ng t·ªëi ∆∞u m·ªçi website ‚Äúkh√≥‚Äù.
- Kh√¥ng th·ª±c hi·ªán h√†nh ƒë·ªông nguy hi·ªÉm (submit/payment/login); ch·ªâ duy·ªát web read-only m·∫∑c ƒë·ªãnh.
- Kh√¥ng cam k·∫øt vendor/model c·ª• th·ªÉ; m·ªçi model/tool l√† **config-driven**.

### Assumptions
- Backend ch·∫°y server-side; FE/extension optional.
- C√≥ 1 state store (Redis) + optional DB (Postgres).
- C√≥ kh·∫£ nƒÉng fetch HTML (HTTP client) v√† parse DOM; headless browsing l√† P1.

---


## Thu·∫≠t ng·ªØ (Glossary)

- **Stage**: giai ƒëo·∫°n trong pipeline (Stage 1‚Üí6).
- **Module**: th√†nh ph·∫ßn tri·ªÉn khai trong m·ªôt Stage.
- **Orchestrator**: b·ªô ƒëi·ªÅu ph·ªëi trung t√¢m (single orchestrator) l·∫≠p k·∫ø ho·∫°ch v√† gi√°m s√°t th·ª±c thi.
- **TaskSpecV1 / ActionPlan / EvidencePack**: c√°c ƒë·ªëi t∆∞·ª£ng canonical d√πng xuy√™n su·ªët pipeline.

## C. T·ªïng quan h·ªá th·ªëng (System Overview, C4 Level 1‚Äì2)

### C1 ‚Äî Ng·ªØ c·∫£nh (Context, Level 1)

```mermaid
flowchart LR
  U[User] --> FE[Browser UI / Extension (optional)]
  FE --> GW[API Gateway + WAF + Rate Limit]
  GW --> ORCH[Orchestrator API (Stages 1-6)]
  ORCH --> MG[Model Gateway]
  ORCH --> RET[Retrieval Service]
  ORCH --> WW[Web Worker (Fetch/Parse/Extract)]
  ORCH --> ST[(State Store)]
  ORCH --> OBS[Observability (OTel)]
  MG --> OBS
  RET --> OBS
  WW --> OBS
```

### C2 ‚Äî C√°c kh·ªëi d·ªãch v·ª• (Containers, Level 2)

**API Gateway / WAF**
- AuthN/AuthZ, rate-limit, request size limit, header normalization, WAF rules.

**Orchestrator Service**
- Ch·ªãu tr√°ch nhi·ªám ƒëi·ªÅu ph·ªëi workflow Stage 1‚Äì6, state machine tr·∫°ng th√°i task, budgets, safety gates, orchestration.

**Model Gateway**
- Adapters: SLM/LLM/Embeddings/Reranker/VLM (optional), retry/backoff, enforce budget.

**Retrieval Service**
- Query expansion, vector search (cache/session/index), BM25/search provider (optional), kh·ª≠ tr√πng l·∫∑p (dedupe), candidate scoring.

**Web Worker**
- HTTP fetch + sanitize + main-content extraction + table extraction; (P1) headless browsing & screenshots.

**State Store**
- Idempotency cache, task status, artifacts (TaskSpec/Evidence/Answer), session snippets.

---

## D. Pipeline end-to-end (End-to-End Pipeline)

### ASCII (one-way)

```
RawRequest
   |
   v
Stage 1: UnifiedInputCore  --> NormalizedInput + TraceContext
   |
   v
Stage 2: Query Understanding --> TaskSpecV1 (intent/slots/routing/constraints)
   |
   v
Stage 3: Planner/Orchestrator --> ActionPlan (steps + budgets + guards)
   |
   v
Stage 4: Search & Tool Use --> EvidencePack (filtered evidence + traces)
   |
   v
Stage 5: Reasoning --> AnswerSkeleton + CitationMap + OpenQuestions
   |
   v
Stage 6: Answer Synthesis --> FinalAnswer (+ optional audio later)
```

### Mermaid (flowchart)

```mermaid
flowchart TB
  A[RawRequest] --> B[Stage 1\nUnifiedInputCore]
  B --> C[Stage 2\nQuery Understanding]
  C --> D[Stage 3\nPlanner/Orchestrator]
  D --> E[Stage 4\nSearch & Tool Use]
  E --> F[Stage 5\nReasoning]
  F --> G[Stage 6\nAnswer Synthesis]
  G --> H[Response + Telemetry]
```

---

## E. Ph√¢n r√£ module theo stage (Module Breakdown)

> Format per module: **Purpose / Inputs / Outputs / Responsibilities / Dependencies / Failure modes**

### Stage 1 ‚Äî UnifiedInputCore (Normalize Input)

#### 1.1 InputAdapter
- **Purpose:** nh·∫≠n request t·ª´ FE/API, validate schema, attach trace, enforce idempotency.
- **Inputs:** RawRequest, headers (Auth, Idempotency-Key, Correlation-Id).
- **Outputs:** Validated RawRequest + TraceContext.
- **Responsibilities:** schema validation, size limit, payload hash, idempotency lookup.
- **Dependencies:** state store (idempotency), auth context.
- **Failure modes:** 400 invalid schema; 413 too large; 409 idempotency conflict.

#### 1.2 ContextCollector (MVP-lite)
- **Purpose:** gom context t·ªëi thi·ªÉu: current_url, tab_title, selected_text, locale.
- **Inputs:** RawRequest.context.
- **Outputs:** ContextBundle.
- **Failure modes:** thi·∫øu context ‚Üí gi·∫£m c·∫•p (degrade gracefully) to text-only.

#### 1.3 Normalizer
- **Purpose:** chu·∫©n ho√° v·ªÅ NormalizedInput.
- **Inputs:** Validated RawRequest + ContextBundle.
- **Outputs:** NormalizedInput.
- **Responsibilities:** normalize whitespace, detect language, URL parse, create fetch intent (kh√¥ng fetch ngay n·∫øu async).
- **Failure modes:** 422 unsupported input type; 400 invalid URL.

#### 1.4 SafetyPrecheck (fast gate)
- **Purpose:** ch·∫∑n s·ªõm prompt-injection/SSRF obvious tr∆∞·ªõc khi t·ªën model.
- **Inputs:** NormalizedInput.
- **Outputs:** safety baseline flags.
- **Failure modes:** mark blocked/sanitize; allow with warnings.

---

### Stage 2 ‚Äî Query Understanding (TaskSpec skeleton)

#### 2.1 Policy Classifiers
- **Purpose:** toxicity/illegal/self-harm, prompt-injection, PII.
- **Inputs:** NormalizedInput + ContextBundle.
- **Outputs:** safety_flags, pii_spans, injection_score.
- **Failure modes:** timeout ‚Üí ‚Äúcautious‚Äù default, log.

#### 2.2 Intent & Slot Extractor (SLM)
- **Purpose:** intent classification + slot filling + query normalization.
- **Inputs:** sanitized query + optional related_history_snippets.
- **Outputs:** intent, slots, normalized_query, routing_hints.
- **Failure modes:** malformed JSON ‚Üí retry once; ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) rules.

#### 2.3 Rule Engine (deterministic router)
- **Purpose:** quy·∫øt ƒë·ªãnh routing ·ªïn ƒë·ªãnh: quick_path vs browse vs extract vs summarize.
- **Inputs:** intent/slots/routing_hints + safety_flags + options.
- **Outputs:** TaskSpecV1.
- **Failure modes:** rule conflict ‚Üí choose safest path.

#### 2.4 Embedding Prep
- **Purpose:** t·∫°o query embedding + retrieve session history snippets.
- **Inputs:** normalized_query.
- **Outputs:** query_embedding_ref, related_history_snippets.
- **Failure modes:** embedding unavailable ‚Üí disable retrieval (gi·∫£m c·∫•p (degrade gracefully)).

---

### Stage 3 ‚Äî Planner / Orchestrator (Single Orchestrator)

> **M·ª•c ti√™u:** t·∫°o plan tuy·∫øn t√≠nh + gi√°m s√°t th·ª±c thi tool-use; model l·ªõn ch·ªâ ‚Äúb·∫≠t‚Äù khi c·∫ßn.

#### 3.0 Kh√°i ni·ªám ch√≠nh (Key Concepts) (Stage 3)

**ActionPlan** l√† danh s√°ch step *tuy·∫øn t√≠nh* (c√≥ th·ªÉ c√≥ nh√°nh ‚Äúearly stop‚Äù theo condition).  
M·ªói step c√≥: `goal`, `tool`, `input`, `constraints`, `expected_output`, `stop_condition`, `budget`.

**Chi·∫øn l∆∞·ª£c m·∫∑c ƒë·ªãnh (MVP):**
- N·∫øu `quick_path=true` v√† `needs_browse=false` ‚Üí skip Stage 4, sang Stage 5/6 v·ªõi minimal evidence (history + user text).
- N·∫øu `needs_browse=true` ‚Üí Stage 4 ch·∫°y duy·ªát web read-only: search ‚Üí fetch HTML ‚Üí extract.

#### 3.1 PlanBuilder (Planner LLM/LAM in planning mode)
- **Purpose:** chuy·ªÉn TaskSpecV1 th√†nh ActionPlan h·ª£p l·ªá.
- **Inputs:** TaskSpecV1, user_profile_features (optional), policy_context.
- **Outputs:** ActionPlan (draft).
- **Responsibilities:**
  - Query decomposition: t·∫°o sub-queries (n·∫øu c·∫ßn).
  - Decide tool sequence: `search ‚Üí fetch ‚Üí extract ‚Üí kh·ª≠ tr√πng l·∫∑p (dedupe) ‚Üí synth`.
  - Define success criteria & stop conditions.
- **Dependencies:** Model Gateway (planner model), Tool Registry (capabilities).
- **Failure modes:** plan invalid schema ‚Üí retry; fail ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) plan template.

#### 3.2 PlanValidator (deterministic)
- **Purpose:** ƒë·∫£m b·∫£o plan tu√¢n policy + budget + capability constraints.
- **Inputs:** draft ActionPlan + safety_flags + tenant policies.
- **Outputs:** validated ActionPlan ho·∫∑c blocked.
- **Responsibilities:**
  - Remove forbidden tools/actions (e.g., fill_form in MVP).
  - Enforce max_steps, max_domains, deny SSRF ranges, safe browsing.
  - Enforce budget: max model calls, max fetches, max tokens.
- **Failure modes:** policy violation ‚Üí return POLICY_BLOCKED; budget exceed ‚Üí downgrade plan (less steps).

#### 3.3 BudgetManager
- **Purpose:** qu·∫£n l√Ω ‚Äúcost envelope‚Äù theo request.
- **Inputs:** options (max_latency_ms), tenant budget policy, historical cost signals.
- **Outputs:** per-stage budgets (time/token/fetch count).
- **Responsibilities:** dynamic throttling (reduce evidence count, skip reranker, smaller model).
- **Failure modes:** no budget config ‚Üí conservative defaults.

#### 3.4 StateManager (Task State Machine)
- **Purpose:** l∆∞u tr·∫°ng th√°i task, artifacts, retries, idempotency mapping.
- **Inputs:** Task events (PLAN_BUILT, STEP_DONE, FAILED‚Ä¶).
- **Outputs:** persistent state, progress snapshots.
- **Dependencies:** state-store/DB.
- **Failure modes:** store unavailable ‚Üí fail fast 503 (idempotency risk).

#### 3.5 Orchestrator Runtime (StepExecutor)
- **Purpose:** ch·∫°y ActionPlan step-by-step, ghi trace, handle retries.
- **Inputs:** validated ActionPlan, TraceContext.
- **Outputs:** EvidencePack (from Stage 4), intermediate artifacts, execution_trace.
- **Responsibilities:**
  - Dispatch tool calls (search/fetch/extract).
  - Run steps in parallel when safe (e.g., multi-fetch fan-out) nh∆∞ng v·∫´n ‚Äúsingle orchestrator‚Äù quy·∫øt ƒë·ªãnh.
  - Apply retry policy per tool (with backoff), and **idempotent tool calls** (tool-level keys).
  - Early stop when sufficient evidence (confidence threshold).
- **Failure modes:** repeated tool failure ‚Üí gi·∫£m c·∫•p (degrade gracefully) (partial answer) or fail with retryable flag.

#### 3.6 Personalization Hook (optional, MVP-lite)
- **Purpose:** adjust depth/style/source preferences.
- **Inputs:** session signals, user profile features.
- **Outputs:** plan modifiers (depth=quick/deep, source priorities).
- **Failure modes:** missing profile ‚Üí default ‚Äúbalanced‚Äù.

---

### Stage 4 ‚Äî Search & Tool Use

> **M·ª•c ti√™u:** th·ª±c thi plan ƒë·ªÉ t·∫°o **EvidencePack ƒë√£ l·ªçc**; t√°ch ‚Äútool execution‚Äù kh·ªèi reasoning ƒë·ªÉ ti·∫øt ki·ªám token.

#### 4.0 Ch·∫ø ƒë·ªô th·ª±c thi (Execution Modes)
- **Mode A (MVP default): Read-only Web**  
  search ‚Üí HTTP fetch ‚Üí DOM parse ‚Üí content extract ‚Üí evidence pack.
- **Mode B (P1): Headless / Interactive**  
  open_tab/click/scroll v·ªõi sandbox + allowlist + human approval for dangerous actions.

#### 4.1 RetrievalEngine
- **Purpose:** l·∫•y candidates t·ª´ session cache + web search/index.
- **Inputs:** query_embedding_ref, normalized_query, sub_queries.
- **Outputs:** CandidateList (50‚Äì100).
- **Responsibilities:**
  - Hybrid retrieval: vector + keyword (configurable).
  - Dedupe by URL + near-duplicate text hash.
  - Domain scoring (trusted sources bias) theo tenant policy.
- **Dependencies:** vector store, optional search provider.
- **Failure modes:** retrieval unavailable ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) to direct fetch (if URL provided) ho·∫∑c no-browse.

#### 4.2 Reranker
- **Purpose:** rerank candidates ‚Üí ch·ªçn top evidence ch·∫•t l∆∞·ª£ng.
- **Inputs:** CandidateList, query.
- **Outputs:** TopEvidence (5‚Äì10).
- **Responsibilities:** cross-encoder rerank; enforce diversity by domain.
- **Failure modes:** reranker unavailable ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) to similarity score.

#### 4.3 WebFetch (HTTP) + SSRF Guard
- **Purpose:** t·∫£i HTML an to√†n.
- **Inputs:** URL list, fetch policy.
- **Outputs:** FetchResult (status, headers, html_bytes).
- **Responsibilities:**
  - SSRF block (private IPs, metadata IPs).
  - Respect robots/timeout/size; retries with backoff.
  - Content-type guard (only html/text in MVP).
- **Failure modes:** 404/403/timeout; blocked by policy; returns typed errors.

#### 4.4 DOMParser & MainContentExtractor
- **Purpose:** parse DOM v√† tr√≠ch xu·∫•t main content vs nav/ads/sidebar.
- **Inputs:** html_bytes, base_url.
- **Outputs:** StructuredPageView: title, headings, paragraphs, links, tables (basic).
- **Responsibilities:** boilerplate removal, readability extraction, normalize whitespace, language detect.
- **Failure modes:** malformed HTML ‚Üí best-effort parse; empty main content ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) to snippet-based evidence.

#### 4.5 TableExtractor (MVP-basic)
- **Purpose:** extract tables (HTML) th√†nh structured rows.
- **Inputs:** DOM tree.
- **Outputs:** table artifacts (csv/json).
- **Failure modes:** complex tables ‚Üí include as raw html fragment + warning.

#### 4.6 VLM/OCR Hook (P1+)
- **Purpose:** x·ª≠ l√Ω PDF/chart/layout l·∫° b·∫±ng screenshot ‚Üí structured view.
- **Inputs:** screenshot/pdf bytes.
- **Outputs:** structured_page_views, extracted tables/charts.
- **Note:** not required in MVP; interface only.

#### 4.7 Tool Sandbox / ActionPolicy (for agentic browsing)
- **Purpose:** enforce allowed actions & safe execution.
- **Inputs:** tool call request (tool_name, args), policy.
- **Outputs:** tool call result or block.
- **Responsibilities:** allowlist tools, domain allowlist, redact secrets, no credential entry in MVP.
- **Failure modes:** blocked tool call with POLICY_BLOCKED (not retryable).

#### 4.8 EvidenceBuilder
- **Purpose:** build EvidencePack ƒë√£ l·ªçc ƒë·ªÉ Stage 5 reasoning.
- **Inputs:** TopEvidence + StructuredPageViews + tables.
- **Outputs:** EvidencePack.
- **Responsibilities:**
  - Chunking & citation anchors (url + offsets + hashes).
  - Keep only relevant spans (reduce token).
  - Safety sanitize: remove PII spans, strip prompt-injection text patterns.
- **Failure modes:** empty evidence ‚Üí return EvidencePack with warnings.

#### 4.9 ExecutionTraceCollector
- **Purpose:** capture `execution_trace` v√† `safety_trace`.
- **Inputs:** all tool events.
- **Outputs:** trace artifacts.
- **Responsibilities:** correlation_id propagation, sampling, redaction.
- **Failure modes:** trace sink down ‚Üí drop non-critical traces.

---

### Stage 5 ‚Äî Reasoning

> **M·ª•c ti√™u:** suy lu·∫≠n ƒëa b∆∞·ªõc d·ª±a tr√™n evidence **ƒë√£ n√©n**, gi·∫£i quy·∫øt m√¢u thu·∫´n, t·∫°o skeleton + citations map.

#### 5.1 EvidenceSummarizer (token reducer)
- **Purpose:** n√©n EvidencePack th√†nh ‚Äúevidence digest‚Äù theo schema.
- **Inputs:** EvidencePack.
- **Outputs:** EvidenceDigest (facts list, key quotes, table summaries).
- **Responsibilities:** minimize tokens, keep provenance pointers.
- **Failure modes:** summarizer fail ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) to truncated raw snippets.

#### 5.2 ReasoningCore (Reasoning LLM/LAM)
- **Purpose:** t·∫°o AnswerSkeleton + claim graph.
- **Inputs:** TaskSpecV1, EvidenceDigest, constraints (style/depth).
- **Outputs:** AnswerSkeleton, ClaimList, OpenQuestions.
- **Responsibilities:**
  - Build answer outline (sections).
  - Extract atomic claims (each claim must be backed by ‚â•1 evidence item OR marked as assumption).
  - Resolve contradictions: prefer higher-trust sources; flag uncertain areas.
- **Failure modes:** low confidence / insufficient evidence ‚Üí produce partial answer + OpenQuestions (kh√¥ng h·ªèi ng∆∞·ª£c ng∆∞·ªùi d√πng trong MVP response; ch·ªâ b√°o ‚Äúthi·∫øu d·ªØ li·ªáu‚Äù).

#### 5.3 CitationMapper (claim ‚Üí evidence)
- **Purpose:** map claim IDs to evidence anchors.
- **Inputs:** ClaimList, EvidencePack.
- **Outputs:** CitationMap.
- **Responsibilities:** ensure no claim without mapping unless labeled assumption.
- **Failure modes:** missing mapping ‚Üí downgrade claim to ‚Äúuncertain‚Äù + warning.

#### 5.4 OutputSafetyCheck (draft-level)
- **Purpose:** safety check cho intermediate drafts.
- **Inputs:** AnswerSkeleton + claims.
- **Outputs:** allow / sanitize / block.
- **Failure modes:** false positive ‚Üí sanitize minimally, log.

---

### Stage 6 ‚Äî Answer Synthesis

> **M·ª•c ti√™u:** bi·∫øn skeleton th√†nh c√¢u tr·∫£ l·ªùi r√µ r√†ng + ƒë·ªãnh d·∫°ng + citations; quick path b·∫±ng SLM khi task ƒë∆°n gi·∫£n.

#### 6.1 SynthesisComposer (LLM)
- **Purpose:** generate final answer text from skeleton.
- **Inputs:** AnswerSkeleton, CitationMap, style options.
- **Outputs:** FinalAnswer (markdown blocks), AnswerMetadata.
- **Responsibilities:**
  - Rendering policy: headings/bullets/tables.
  - Insert citations inline (e.g., [1], [2]) + reference list.
  - Respect length/depth constraints and user profile.
- **Failure modes:** model timeout ‚Üí ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback) ‚Äúshort answer‚Äù template + skeleton.

#### 6.2 QuickPathSynth (SLM)
- **Purpose:** answer nhanh khi kh√¥ng browse / √≠t evidence.
- **Inputs:** TaskSpecV1 + minimal evidence.
- **Outputs:** FinalAnswer.
- **Failure modes:** escalate to 6.1 if quality < threshold.

#### 6.3 PersonalizationFormatter
- **Purpose:** adjust tone/depth/verbosity based on profile features.
- **Inputs:** user_profile_features.
- **Outputs:** formatting parameters (verbosity, style).
- **Failure modes:** missing profile ‚Üí default.

#### 6.4 PostProcessor
- **Purpose:** deterministic cleanup.
- **Inputs:** FinalAnswer draft.
- **Outputs:** FinalAnswer sanitized.
- **Responsibilities:** strip leaked system prompts, redact PII, normalize markdown, enforce max length.
- **Failure modes:** if violation persists ‚Üí block with safe message.

#### 6.5 ResponsePackaging
- **Purpose:** package for FE: answer blocks + citations + artifacts.
- **Inputs:** FinalAnswer + EvidencePack.
- **Outputs:** API response body (ResponseV1).
- **Failure modes:** artifacts too large ‚Üí return truncated artifacts + link refs.

---

## F. M√¥ h√¨nh d·ªØ li·ªáu (Data Model)

### Canonical Objects
- **RawRequest**: input t·ª´ FE/API.
- **NormalizedInput**: canonical normalized query + context.
- **TaskSpecV1**: intent/slots/routing/constraints/budget hints.
- **ActionPlan**: list of steps (tool calls & success conditions).
- **EvidencePack**: filtered evidence + provenance + traces.
- **AnswerSkeleton**: structured outline + claims.
- **FinalAnswer**: user-facing content blocks + citations.
- **TraceContext**: request_id/correlation_id/session_id.

### Mini JSON Schemas (core fields)

#### RawRequest
```json
{
  "request_id": "req_...",
  "idempotency_key": "idem_...",
  "user": { "user_id": "u_123", "session_id": "s_456" },
  "input": {
    "type": "text|web_url|html_snapshot",
    "text": "‚Ä¶",
    "url": "https://‚Ä¶",
    "html": "<html>‚Ä¶</html>"
  },
  "context": {
    "current_url": "https://‚Ä¶",
    "tab_title": "‚Ä¶",
    "selected_text": "‚Ä¶",
    "locale": "vi-VN",
    "timezone": "Asia/Bangkok"
  },
  "options": {
    "mode": "auto|quick|deep",
    "allow_browse": true,
    "max_latency_ms": 8000
  },
  "trace": { "correlation_id": "corr_..." }
}
```

#### TaskSpecV1
```json
{
  "task_id": "task_...",
  "request_id": "req_...",
  "intent": "qa|summarize|extract|compare|navigate",
  "slots": { "entities": ["..."], "timeframe": "..." },
  "routing": {
    "quick_path": false,
    "needs_browse": true,
    "needs_citations": true
  },
  "constraints": {
    "allow_domains": ["*"],
    "deny_domains": ["localhost", "169.254.169.254"],
    "max_steps": 6,
    "max_fetch": 8
  },
  "budget": {
    "max_model_calls": 6,
    "max_tokens_total": 12000
  },
  "trace": { "correlation_id": "corr_..." }
}
```

#### ActionPlan
```json
{
  "task_id": "task_...",
  "steps": [
    {
      "step_id": "s1",
      "goal": "Find authoritative sources",
      "tool": "retrieval.search",
      "input": { "query": "..." },
      "constraints": { "max_candidates": 80 },
      "expected_output": { "type": "CandidateList" },
      "stop_condition": { "type": "always" }
    },
    {
      "step_id": "s2",
      "goal": "Fetch top pages",
      "tool": "web.fetch",
      "input": { "urls_ref": "cand_top10" },
      "constraints": { "timeout_ms": 2500, "max_bytes": 2000000 },
      "expected_output": { "type": "FetchResults" },
      "stop_condition": { "type": "on_error_budget", "max_errors": 3 }
    }
  ],
  "global_constraints": { "max_steps": 6, "allow_actions": ["read_only"] }
}
```

#### EvidencePack
```json
{
  "task_id": "task_...",
  "items": [
    {
      "evidence_id": "e1",
      "source_url": "https://...",
      "title": "...",
      "type": "snippet|table|structured_view",
      "content": "‚Ä¶",
      "anchors": { "hash": "sha256(...)", "offsets": [120, 420] },
      "score": 0.92
    }
  ],
  "execution_trace": [{ "tool": "web.fetch", "url": "...", "status": 200 }],
  "safety_trace": [{ "check": "pii", "result": "redacted" }]
}
```

#### AnswerSkeleton + CitationMap
```json
{
  "outline": [
    { "section": "Overview", "bullets": ["..."] }
  ],
  "claims": [
    { "claim_id": "c1", "text": "...", "confidence": 0.8, "assumption": false }
  ],
  "citation_map": {
    "c1": ["e1", "e3"]
  },
  "open_questions": ["Missing ... from authoritative sources"]
}
```

### Idempotency / request_id / session_id / user_id
- `Idempotency-Key` b·∫Øt bu·ªôc cho `/tasks:execute`.  
- Kh√¥ng log `user_id` raw; d√πng hash/pseudonymous trong logs/traces.  
- `session_id` d√πng ƒë·ªÉ truy xu·∫•t history snippets (retention ng·∫Øn).

---

## G. ƒê·∫∑c t·∫£ API (API Spec)

### Endpoints (REST)

#### `POST /v1/tasks:execute`
- **Purpose:** execute Stage 1‚Äì6 (default async), ho·∫∑c sync-only Stage 1‚Äì2 (config).
- **Headers:**
  - `Authorization: Bearer <token>`
  - `Idempotency-Key: <string>`
  - `X-Correlation-Id: <string>` (optional)
- **Request:** RawRequest
- **Responses:**
  - `202 Accepted` (recommended): returns task_id
  - `200 OK` (sync mode): returns ResponseV1 (final)
- **Example (202):**
```json
{ "task_id": "task_123", "status": "RUNNING", "correlation_id": "corr_..." }
```

#### `GET /v1/tasks/{task_id}`
- **Purpose:** poll status + fetch artifacts.
- **Response:**
```json
{
  "task_id": "task_123",
  "status": "RUNNING|SUCCEEDED|FAILED",
  "artifacts": {
    "task_spec": { },
    "evidence_pack": null,
    "final_answer": null
  },
  "correlation_id": "corr_..."
}
```

#### `GET /healthz`, `GET /readyz`

### Status Model
- `RUNNING`: executing plan steps
- `SUCCEEDED`: final_answer ready
- `FAILED`: failed with error (retryable?)

### Standard Error Model
```json
{
  "error_code": "INVALID_ARGUMENT|UNAUTHORIZED|RATE_LIMITED|MODEL_TIMEOUT|FETCH_FAILED|POLICY_BLOCKED|INTERNAL",
  "message": "human readable",
  "retryable": true,
  "correlation_id": "corr_...",
  "details": { "stage": 4, "tool": "web.fetch" }
}
```

### Rate Limit + Auth
- Gateway enforced: per-user + per-IP. Default: 60 rpm/user (config).
- Auth: JWT/OAuth2 recommended; API keys allowed for MVP internal.

---

## H. B·∫£o m·∫≠t & Quy·ªÅn ri√™ng t∆∞ (Security & Privacy)

### Threat Model (short)
- Prompt-injection t·ª´ web content.
- SSRF via URL fetch.
- Data exfiltration (secrets/system prompt).
- Abuse/cost blow-up (spam).
- PII leakage in logs/artifacts.

### Controls
- **Network boundary:** GW/WAF at edge; services in private network; egress proxy for web-worker.
- **SSRF guard:** block RFC1918, link-local, metadata, localhost, non-HTTP(s).
- **Secrets management:** Vault/KMS; rotate; no secrets in logs.
- **PII handling:** detect + redact in logs and EvidencePack (config).
- **Action sandbox:** MVP allowlist read-only; interactive actions require P1 human approval.

### Data Retention (default suggestions)
- Traces/logs: 7‚Äì14 days.
- Artifacts (TaskSpec/Evidence/Answer): 1‚Äì7 days.
- Tenant-configurable; ‚Äúno-store‚Äù mode for enterprise.

---

## I. Quan s√°t h·ªá th·ªëng & V·∫≠n h√†nh (Observability & Ops)

### Logging
- JSON logs: request_id, correlation_id, user_hash, stage, step_id, tool, latency_ms, retry_count, cost_estimate.

### Tracing
- OpenTelemetry spans per stage and per tool call.

### Metrics
- request_count/status
- latency p50/p95/p99 per stage
- model_calls + token_in/out
- fetch_success_rate + ssrf_block_count
- policy_block_rate
- cache_hit_rate (idempotency, retrieval)

### SLO (suggested)
- Stage 1‚Äì2 p95 < 1500ms
- Full pipeline p95 < 8‚Äì12s (browse on)
- Availability 99.9% for core API

---

## J. C·∫•u tr√∫c repo / th∆∞ m·ª•c (Repo / Folder Structure)

```
repo/
  docs/
    spec.md
    api.md
    threat-model.md
    runbook.md
  packages/
    shared/
      src/
        types/
        schemas/
        utils/
  services/
    orchestrator/
      src/
        api/
        stages/
        runtime/
        policies/
        observability/
      tests/
    model-gateway/
      src/
        adapters/
        policies/
      tests/
    retrieval/
      src/
        hybrid/
        rerank/
        cache/
      tests/
    web-worker/
      src/
        fetch/
        extract/
        sandbox/
      tests/
  apps/
    extension/   # optional
    web-ui/      # optional
  infra/
    k8s/
    terraform/
    ci/
```

---

## K. K·∫ø ho·∫°ch ki·ªÉm th·ª≠ (Test Plan)

### Unit
- PlanValidator rules: forbid interactive actions in MVP.
- SSRF guard: block private ranges.
- EvidenceBuilder: kh·ª≠ tr√πng l·∫∑p (dedupe) + anchors.
- CitationMapper: no claim without evidence unless assumption.

### Integration
- Orchestrator ‚Üî retrieval ‚Üî web-worker ‚Üî model-gateway happy path.
- Retries/backoff for web.fetch and model calls.
- Idempotency: same key returns same task_id/result.

### E2E
- Text-only: quick path.
- Text + URL: fetch/extract ‚Üí answer with citations.
- Prompt injection page: sanitize/skip, still answer safely.

### Golden Tests
- Deterministic TaskSpecV1 output for given inputs.
- Deterministic plan template outputs (when planner disabled).

### Edge Cases Checklist
- Empty/very long text; mixed languages.
- 403/404/timeout; redirect loops.
- Paywall/login pages.
- Duplicated sources; contradictory sources.
- Evidence too large ‚Üí truncation path.

---

## L. Ti√™u ch√≠ nghi·ªám thu (Acceptance Criteria)

### P0 (must)
- Stage 1‚Äì6 ch·∫°y end-to-end (at least Mode A read-only browse).
- Idempotency works; error model includes correlation_id.
- SSRF protection + rate limit + auth in place.
- EvidencePack built and citations inserted for evidence-backed claims.
- Observability: logs + traces + metrics minimal dashboards.

### P1 (should)
- Async tasks with progress events; streaming answer blocks.
- Headless browsing (Playwright) for JS-heavy sites.
- Reranker + diversity enforcement; better citation anchors.
- Tenant-configurable retention + no-store mode.

### P2 (nice)
- VLM/PDF pipeline; OCR for scanned docs.
- Interactive actions with sandbox + human approval.
- Strong personalization (source ranking + style).

---

## M. C√¢u h·ªèi m·ªü / Future hooks (Open Questions / Future Hooks)

1) Sync vs Async default: MVP recommended async for Stage 3‚Äì6 to avoid gateway timeouts; keep sync for internal/dev mode.
2) Retrieval strategy: external search API vs self-index. Default: external search for MVP; keep interface for self-index.
3) Headless browsing: enable P1; keep HTTP fetch path as ph∆∞∆°ng √°n d·ª± ph√≤ng (fallback).
4) Citation UX format: inline numeric vs hover cards. Keep metadata in ResponseV1 for FE rendering.
5) Multi-tenant policy: domain allowlist/denylist, retention, budgets.

---
# 6 Modules Quick Reference Guide
## Comet AI Browser - MVP Enterprise Architecture

---

## üì¶ Module Stack Overview

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ USER INPUT (Text, URL, Page Context)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 1: UnifiedInputCore     ‚îÇ
        ‚îÇ  ‚îú‚îÄ Validate input             ‚îÇ
        ‚îÇ  ‚îú‚îÄ Normalize text             ‚îÇ
        ‚îÇ  ‚îú‚îÄ Extract URLs               ‚îÇ
        ‚îÇ  ‚îú‚îÄ Detect language            ‚îÇ
        ‚îÇ  ‚îú‚îÄ Safety precheck            ‚îÇ
        ‚îÇ  ‚îî‚îÄ Attach context             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                    NormalizedInput
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 2: QueryUnderstanding      ‚îÇ
        ‚îÇ  ‚îú‚îÄ Intent classification         ‚îÇ
        ‚îÇ  ‚îú‚îÄ Slot filling                 ‚îÇ
        ‚îÇ  ‚îú‚îÄ Entity extraction            ‚îÇ
        ‚îÇ  ‚îú‚îÄ Policy checks (PII/injection)‚îÇ
        ‚îÇ  ‚îú‚îÄ SLM fallback (optional)      ‚îÇ
        ‚îÇ  ‚îî‚îÄ Task specification           ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                      TaskSpecV1
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 3: RouterPlanner        ‚îÇ
        ‚îÇ  ‚îú‚îÄ Extract signals            ‚îÇ
        ‚îÇ  ‚îú‚îÄ Select mode (A/B/C/D)     ‚îÇ
        ‚îÇ  ‚îú‚îÄ Generate ActionPlan        ‚îÇ
        ‚îÇ  ‚îú‚îÄ Validate constraints       ‚îÇ
        ‚îÇ  ‚îú‚îÄ Budget management          ‚îÇ
        ‚îÇ  ‚îî‚îÄ State persistence          ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                     ActionPlan
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 4: UnifiedExecutor (4 Modes)
        ‚îÇ                                   ‚îÇ
        ‚îÇ  ‚îå‚îÄ 4.1 Retrieve:                ‚îÇ
        ‚îÇ  ‚îÇ   Hybrid search (BM25+Vector) ‚îÇ
        ‚îÇ  ‚îÇ   Rerank & dedupe             ‚îÇ
        ‚îÇ  ‚îÇ                               ‚îÇ
        ‚îÇ  ‚îú‚îÄ 4.2 FetchData:               ‚îÇ
        ‚îÇ  ‚îÇ   HTTP fetch (SSRF guard)     ‚îÇ
        ‚îÇ  ‚îÇ   Parse tables & metadata     ‚îÇ
        ‚îÇ  ‚îÇ                               ‚îÇ
        ‚îÇ  ‚îú‚îÄ 4.3 Compute:                 ‚îÇ
        ‚îÇ  ‚îÇ   Score & transform data      ‚îÇ
        ‚îÇ  ‚îÇ   Reasoning (no UI actions)   ‚îÇ
        ‚îÇ  ‚îÇ                               ‚îÇ
        ‚îÇ  ‚îî‚îÄ 4.4 Act:                     ‚îÇ
        ‚îÇ      Headless browser            ‚îÇ
        ‚îÇ      Click/type/fill (no submit) ‚îÇ
        ‚îÇ      Policy gates & approval     ‚îÇ
        ‚îÇ      Receipt generation          ‚îÇ
        ‚îÇ                                   ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
               EvidencePack + Receipt
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 5: Reasoning               ‚îÇ
        ‚îÇ  ‚îú‚îÄ Compress evidence            ‚îÇ
        ‚îÇ  ‚îú‚îÄ Extract atomic claims        ‚îÇ
        ‚îÇ  ‚îú‚îÄ Map citations                ‚îÇ
        ‚îÇ  ‚îú‚îÄ Resolve contradictions       ‚îÇ
        ‚îÇ  ‚îú‚îÄ Safety validation            ‚îÇ
        ‚îÇ  ‚îî‚îÄ Open questions               ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
         AnswerSkeleton + CitationMap
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ  STAGE 6: AnswerSynthesis         ‚îÇ
        ‚îÇ  ‚îú‚îÄ Compose final answer         ‚îÇ
        ‚îÇ  ‚îú‚îÄ Insert citations             ‚îÇ
        ‚îÇ  ‚îú‚îÄ Personalize format           ‚îÇ
        ‚îÇ  ‚îú‚îÄ Post-process (redact, etc)   ‚îÇ
        ‚îÇ  ‚îú‚îÄ Safety check                 ‚îÇ
        ‚îÇ  ‚îî‚îÄ Package response             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                    FinalAnswer
                         ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ USER RESPONSE (Markdown + Citations)
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ Each Module's Responsibility

### Stage 1: UnifiedInputCore
**Input**: RawRequest (text, URL, page context)  
**Output**: NormalizedInput (validated, normalized)  
**Key Modules**:
- `InputAdapter` - Schema validation, idempotency
- `ContextCollector` - Gather browser context
- `Normalizer` - Whitespace, language detection
- `SafetyPrecheck` - Block obvious injection/SSRF

**Latency Target**: <200ms (p95)

---

### Stage 2: QueryUnderstanding
**Input**: NormalizedInput  
**Output**: TaskSpecV1 (intent, slots, constraints)  
**Key Modules**:
- `RuleEngine` - Fast path (A/B/C/D classification)
- `IntentExtractor` - Intent + slot extraction
- `EntityParser` - Budget, time, travel, quantity parsing
- `PolicyEngine` - PII risk, injection, confirmation logic
- `SLMModule` - Fallback for ambiguous cases

**Execution Path**:
- Fast path (>85% confidence): Rule-only
- Slow path (<85% confidence): Rule + SLM call

**Latency Target**: <500ms with rule-only path

---

### Stage 3: RouterPlanner
**Input**: TaskSpecV1  
**Output**: ActionPlan (mode, steps, budgets, policies)  
**Key Modules**:
- `SignalExtractor` - Extract routing hints from TaskSpec
- `ModeSelector` - Choose A/B/C/D mode
- `PlanBuilder` - LLM-powered plan generation
- `PlanValidator` - Policy & capability validation
- `BudgetManager` - Dynamic cost envelope
- `StateManager` - Task FSM & idempotency

**4 Execution Modes**:
- **Mode A (Research-only)**: Perplexity-like, no actions
- **Mode B (Action-only)**: Known workflow, no research
- **Mode C (Research‚ÜíAction)**: Find info, then execute
- **Mode D (Action‚ÜíResearch)**: Check state, then explain

---

### Stage 4: UnifiedExecutor
**Input**: ActionPlan  
**Output**: EvidencePack + Receipt (if action)  
**Key Modules**:
- `RetrievalEngine` - BM25 + vector hybrid search
- `Reranker` - Cross-encoder ranking & diversity
- `WebFetch` - HTTP client with retry/backoff
- `SSRFGuard` - Block private IP ranges
- `DOMParser` - HTML parsing & extraction
- `TableExtractor` - Structured table parsing
- `ToolSandbox` - Policy enforcement
- `EvidenceBuilder` - Package evidence with citations
- `ExecutionTrace` - Audit trail

**Execution Substeps**:
1. **4.1 Retrieve**: Search for candidates
2. **4.2 FetchData**: Load & parse URLs
3. **4.3 Compute**: Transform/score data
4. **4.4 Act**: Browser automation (optional)

---

### Stage 5: Reasoning
**Input**: EvidencePack + Receipt  
**Output**: AnswerSkeleton + CitationMap  
**Key Modules**:
- `EvidenceSummarizer` - Token reduction
- `ReasoningCore` - LLM-powered reasoning
- `CitationMapper` - Claim ‚Üî evidence mapping
- `SafetyCheck` - Output validation

**Outputs**:
- Structured answer outline (sections, bullets)
- Atomic claims (each backed by evidence)
- Citation references (url + offset)
- Open questions (missing data indicators)

---

### Stage 6: AnswerSynthesis
**Input**: AnswerSkeleton + CitationMap  
**Output**: FinalAnswer (markdown + citations)  
**Key Modules**:
- `SynthesisComposer` - LLM renders skeleton ‚Üí text
- `QuickPathSynth` - SLM for simple queries
- `PersonalizationFormatter` - User preference styling
- `PostProcessor` - Cleanup & redaction
- `ResponseBuilder` - API response construction

**Final Checks**:
- Citation format validation
- PII redaction
- Markdown validity
- Length constraints

---

## üèóÔ∏è Directory Structure Map

```
comet-ai-browser/
‚îú‚îÄ‚îÄ packages/shared/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ types/          ‚Üê Canonical types across all stages
‚îÇ       ‚îú‚îÄ‚îÄ schemas/        ‚Üê JSON validation schemas
‚îÇ       ‚îî‚îÄ‚îÄ utils/          ‚Üê Shared utilities (logging, hashing, etc.)
‚îÇ
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-1-unified-input-core/     ‚Üê 8 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-2-query-understanding/    ‚Üê 5 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-3-router-planner/         ‚Üê 7 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-4-unified-executor/       ‚Üê 9 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-5-reasoning/              ‚Üê 4 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ STAGE-6-answer-synthesis/       ‚Üê 5 sub-modules
‚îÇ   ‚îú‚îÄ‚îÄ model-gateway/                  ‚Üê LLM/SLM/embeddings adapter
‚îÇ   ‚îú‚îÄ‚îÄ retrieval-service/              ‚Üê Hybrid search engine
‚îÇ   ‚îî‚îÄ‚îÄ web-worker/                     ‚Üê HTTP fetch + headless browser
‚îÇ
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ extension/                       ‚Üê Browser extension (optional)
‚îÇ   ‚îî‚îÄ‚îÄ web-ui/                          ‚Üê Web interface (optional)
‚îÇ
‚îú‚îÄ‚îÄ infra/
‚îÇ   ‚îú‚îÄ‚îÄ k8s/                             ‚Üê Kubernetes manifests (6 stage deployments)
‚îÇ   ‚îú‚îÄ‚îÄ terraform/                       ‚Üê Infrastructure as Code
‚îÇ   ‚îî‚îÄ‚îÄ ci/                              ‚Üê GitHub Actions / GitLab CI
‚îÇ
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ ARCHITECTURE.md                  ‚Üê System design
    ‚îú‚îÄ‚îÄ API.md                           ‚Üê API specifications
    ‚îú‚îÄ‚îÄ THREAT-MODEL.md                  ‚Üê Security analysis
    ‚îú‚îÄ‚îÄ RUNBOOK.md                       ‚Üê Operations guide
    ‚îî‚îÄ‚îÄ GLOSSARY.md                      ‚Üê Terminology
```

---

## üîÑ Data Flow: Types & Objects

| Stage | Input Type | Output Type | Key Decisions |
|-------|-----------|------------|---|
| **1** | RawRequest | UnifiedInputCore | Normalize, validate, language detect |
| **2** | UnifiedInputCore | TaskSpecV1 | Intent, slots, risk, routing |
| **3** | TaskSpecV1 | ActionPlan | Mode (A/B/C/D), steps, budget |
| **4** | ActionPlan | EvidencePack + Receipt | Search, fetch, compute, act |
| **5** | EvidencePack | AnswerSkeleton + CitationMap | Claims, evidence mapping |
| **6** | AnswerSkeleton | FinalAnswer | Render, personalize, package |

---

## üöÄ Deployment Strategy

### Development
- `docker-compose.yml` spins up all 6 stages + Redis + Postgres
- `.env.example` provides defaults

### Staging / Production
- Kubernetes manifests (separate deployment per stage)
- Terraform for cloud infrastructure (AWS/GCP/Azure)
- Persistent state in Redis + Postgres
- Observability: Prometheus + Grafana + OpenTelemetry

---

## üìä Key Metrics per Stage

| Stage | P95 Latency | Key Metrics |
|-------|------------|---|
| **1** | <200ms | Input length, URL count, language detection |
| **2** | <500ms | Intent confidence, SLM call rate |
| **3** | <1s | Plan validity, policy violations |
| **4** | <5s | Retrieve success rate, fetch latency, action success |
| **5** | <2s | Evidence compression ratio, claim extraction rate |
| **6** | <2s | Citation coverage, synthesis latency |
| **Full** | <12s | End-to-end latency, error rate, cost/request |

---

## üîê Security Checkpoints

- **Stage 1**: Input size, URL format, language safety
- **Stage 2**: PII detection, injection pattern filtering
- **Stage 3**: Policy enforcement (no delete/submit in MVP)
- **Stage 4**: SSRF blocking, robots.txt respect, content sanitization
- **Stage 5**: Claim validation, evidence quality checks
- **Stage 6**: PII redaction, system prompt leak prevention

---

## ‚öôÔ∏è Supporting Services

### model-gateway/
- Abstraction over LLM providers (GPT-4, Claude, Llama, etc.)
- Token budgeting & cost tracking
- Retry policies with exponential backoff
- Model fallback chains (primary ‚Üí secondary ‚Üí tertiary)
- Embedding service integration
- Reranking service integration

### retrieval-service/
- Hybrid search combining BM25 (keyword) + vector (semantic)
- Deduplication (URL-based + content-hash)
- Domain scoring (trusted sources prioritization)
- Result caching (session-based)
- Diversity enforcement (avoid monotone results)

### web-worker/
- HTTP client with timeout/retry/size limits
- SSRF protection (blocklist private IPs)
- HTML parsing (jsdom, cheerio, readability)
- Table structure extraction
- Headless browser pool (Playwright/Puppeteer) - P1
- Screenshot & state capture
- Action sandbox with policy gates

---

## üß™ Testing Strategy

### Per Stage
- **Unit Tests**: Individual module behavior (validators, parsers, extractors)
- **Integration Tests**: Module interactions within stage
- **Golden Tests**: Deterministic outputs for regression prevention
- **E2E Tests**: Full pipeline with test data

### Cross-Stage
- **Contract Tests**: Type compatibility between stages
- **Scenario Tests**: Mode A/B/C/D workflows
- **Security Tests**: SSRF, injection, PII handling
- **Load Tests**: Throughput & latency under stress

---

## üéì Implementation Sequence

**Phase 1 (MVP Core)**
1. Stages 1-2 (sync path)
2. Stages 3-4-5-6 (async completion)
3. model-gateway + retrieval + web-worker
4. Local docker-compose setup

**Phase 2 (Production)**
5. Kubernetes manifests
6. Terraform infrastructure
7. CI/CD pipelines
8. Monitoring & observability

**Phase 3 (Advanced)**
9. Headless browser (Stage 4 interactive actions)
10. VLM/PDF pipeline (OCR for documents)
11. Personalization ranking
12. On-device lite models

---

## üìö Key Documentation Files

Each service has:
- `README.md` - Service overview & quick start
- `src/config.ts` - Configuration schema
- `tests/` - Unit, integration, E2E test suites

Root-level docs:
- `docs/ARCHITECTURE.md` - C4 diagrams, data model
- `docs/API.md` - OpenAPI spec, endpoint schemas
- `docs/THREAT-MODEL.md` - Security analysis
- `docs/RUNBOOK.md` - Deployment, troubleshooting

---

## üîó Service Communication

```
API Gateway (WAF, Auth, Rate Limit)
    ‚Üì
Orchestrator Service (Stage 3 router)
    ‚îú‚îÄ‚îÄ ‚Üí Stage 1 Service
    ‚îú‚îÄ‚îÄ ‚Üí Stage 2 Service
    ‚îú‚îÄ‚îÄ ‚Üí Stage 4 Service
    ‚îÇ   ‚îú‚îÄ‚îÄ ‚Üí Retrieval Service
    ‚îÇ   ‚îú‚îÄ‚îÄ ‚Üí Web Worker Service
    ‚îÇ   ‚îî‚îÄ‚îÄ ‚Üí Model Gateway
    ‚îú‚îÄ‚îÄ ‚Üí Stage 5 Service
    ‚îî‚îÄ‚îÄ ‚Üí Stage 6 Service
    
All stages ‚Üî Redis (idempotency, state)
All stages ‚Üî Postgres (artifacts storage)
All stages ‚Üí OpenTelemetry (traces/metrics)
```

---

**Status**: Implementation Ready ‚úÖ  
**Version**: 1.0 MVP Enterprise  
**Last Updated**: December 2025



---


# AI-Native Browser (Comet-like) - Complete Folder Structure
## 6 Modules Enterprise MVP Architecture

```
comet-ai-browser/
‚îÇ
‚îú‚îÄ‚îÄ üìÅ docs/
‚îÇ   ‚îú‚îÄ‚îÄ README.md                           # Main project documentation
‚îÇ   ‚îú‚îÄ‚îÄ ARCHITECTURE.md                     # System architecture overview
‚îÇ   ‚îú‚îÄ‚îÄ API.md                              # API specifications (endpoints, schemas)
‚îÇ   ‚îú‚îÄ‚îÄ THREAT-MODEL.md                     # Security threat model & mitigations
‚îÇ   ‚îú‚îÄ‚îÄ RUNBOOK.md                          # Operations & troubleshooting guide
‚îÇ   ‚îú‚îÄ‚îÄ ROADMAP.md                          # Future features & milestones
‚îÇ   ‚îî‚îÄ‚îÄ GLOSSARY.md                         # Terminology & definitions
‚îÇ
‚îú‚îÄ‚îÄ üìÅ packages/
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ types/                      # Shared TypeScript types
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ common.ts               # RawRequest, NormalizedInput
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ task-spec.ts            # TaskSpecV1, ActionPlan
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ evidence.ts             # EvidencePack, EvidenceItem
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ answer.ts               # AnswerSkeleton, FinalAnswer
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ errors.ts               # Error types, exception classes
‚îÇ           ‚îú‚îÄ‚îÄ schemas/                    # Validation schemas & serializers
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ input.schema.ts         # RawRequestV1 validation
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ task.schema.ts          # TaskSpecV1 validation
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ evidence.schema.ts      # EvidencePack validation
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ answer.schema.ts        # FinalAnswer validation
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ api.schema.ts           # API response/request schemas
‚îÇ           ‚îî‚îÄ‚îÄ utils/
‚îÇ               ‚îú‚îÄ‚îÄ logger.ts               # Structured logging setup
‚îÇ               ‚îú‚îÄ‚îÄ tracer.ts               # OpenTelemetry tracing
‚îÇ               ‚îú‚îÄ‚îÄ hashing.ts              # SHA256, payload hashing
‚îÇ               ‚îú‚îÄ‚îÄ url-parser.ts           # URL parsing & validation
‚îÇ               ‚îú‚îÄ‚îÄ validators.ts           # Common validators
‚îÇ               ‚îî‚îÄ‚îÄ constants.ts            # Global constants, limits
‚îÇ
‚îú‚îÄ‚îÄ üìÅ services/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-1-unified-input-core/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts                    # Service entrypoint
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts                   # Configuration & env vars
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts                # Local constants (MAX_INPUT_LENGTH, etc.)
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts               # Custom exception classes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts               # FastAPI/Express route handlers
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts             # Request/response handlers
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ middleware.ts           # Auth, CORS, logging middleware
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts              # API request/response schemas
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage1/                 # Stage 1 pipeline logic
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ validator.ts        # 1.1 validateRawRequest
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ env-builder.ts      # 1.2 buildEnv
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ envelope.ts         # 1.3 initEnvelope
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ classifier.ts       # 1.4 runInputClassifier
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ normalizer.ts       # 1.5 runTextNormalizer
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ context.ts          # 1.6 attachPageContext
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ safety.ts           # 1.7 computeSafetyFlags
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ telemetry.ts        # 1.8 buildTelemetry
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ input-adapter.ts        # InputAdapter component
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ context-collector.ts    # ContextCollector component
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ normalizer.ts           # Normalizer component
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ redis.ts                # Redis client for idempotency
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cache.ts                # Caching layer
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ vault.ts                # Secrets management
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts              # Structured JSON logging
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts              # Prometheus metrics
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts              # OpenTelemetry spans
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ normalizer.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ classifier.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ safety.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ validator.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ api.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ redis.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ pipeline.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ e2e/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ full-flow.test.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ idempotency.test.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-2-query-understanding/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage2/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.ts     # runQueryUnderstanding entrypoint
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ rule-engine.ts      # 2.1 Rule-based classification (A, B, C, D)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ intent-extractor.ts # Intent & Slot extraction
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ entity-parser.ts    # Parse budget, time, travel, quantity
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ policy-engine.ts    # 2.2 Policy overrides & safety checks
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ slm-module.ts       # 2.3 SLM call for slow path
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ policy-classifier.ts    # Toxicity, PII, injection detection
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ embedding-prep.ts       # Query embedding generation
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ rules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ intent-rules.ts         # Intent classification rules
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ entity-rules.ts         # Entity extraction rules
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ policy-rules.ts         # Policy & safety rules
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway.ts        # SLM model calls
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ embeddings.ts           # Embedding service
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ rule-engine.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ entity-parser.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ policy-engine.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ slm-call.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ end-to-end.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ golden/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ golden-tests.ts         # Deterministic outputs
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-3-router-planner/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage3/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.ts     # Main Stage 3 orchestrator
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ signal-extractor.ts # 3.1 Extract routing signals
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ mode-selector.ts    # 3.2 Mode selection (A, B, C, D)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ plan-builder.ts     # 3.3 PlanBuilder (Planner LLM)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ plan-validator.ts   # 3.4 PlanValidator
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ budget-manager.ts   # 3.5 BudgetManager
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ state-manager.ts    # 3.6 StateManager & task FSM
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ step-executor.ts    # 3.7 Runtime step execution
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ plan-generator.ts       # ActionPlan generation
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ policy-enforcer.ts      # Policy constraints enforcement
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ personalization.ts      # User preference adjustments
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway.ts        # LLM/Planner calls
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ state-store.ts          # Redis/DB state persistence
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ tool-registry.ts        # Capability registry
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ plan-validator.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ budget-manager.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ state-manager.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ mode-selection.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ plan-generation.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ scenario/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ mode-a.scenario.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ mode-b.scenario.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ mode-c.scenario.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ mode-d.scenario.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-4-unified-executor/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage4/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.ts     # Stage 4 main executor
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 4.1-retrieval.ts    # 4.1 RetrievalEngine
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 4.2-fetch.ts        # 4.2 WebFetch & SSRF Guard
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 4.3-extract.ts      # 4.3 DOM parsing & extraction
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 4.4-action.ts       # 4.4 Action execution
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ evidence-builder.ts # EvidenceBuilder & packaging
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ retrieval-engine.ts     # Hybrid search (BM25 + vector)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ reranker.ts             # Cross-encoder reranking
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ web-fetch.ts            # HTTP client with retries
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ssrf-guard.ts           # SSRF protection
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dom-parser.ts           # HTML parsing & extraction
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ table-extractor.ts      # Table structure extraction
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ content-extractor.ts    # Main content extraction
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ tool-sandbox.ts         # Tool execution sandbox
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ action-policy.ts        # Action allowlisting
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ execution-trace.ts      # Trace collection
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway.ts        # VLM/OCR calls
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ vector-store.ts         # Embedding search
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ search-provider.ts      # External search API (optional)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ headless-browser.ts     # Playwright/Puppeteer
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ http-client.ts          # HTTP fetching
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ssrf-guard.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ dom-parser.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ retrieval.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ web-fetch.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ action-execution.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ end-to-end.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ security/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ ssrf.test.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ injection.test.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-5-reasoning/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage5/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.ts     # Stage 5 reasoning orchestrator
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 5.1-summarizer.ts   # 5.1 EvidenceSummarizer
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 5.2-reasoning.ts    # 5.2 ReasoningCore (Reasoning LLM)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 5.3-citation.ts     # 5.3 CitationMapper
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ 5.4-safety.ts       # 5.4 OutputSafetyCheck
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ evidence-summarizer.ts  # Token reduction & compression
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ claim-extractor.ts      # Atomic claim extraction
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ citation-mapper.ts      # Claim-to-evidence mapping
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ contradiction-resolver.ts # Handle conflicting sources
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ safety-checker.ts       # Output safety validation
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway.ts        # Reasoning LLM calls
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ state-store.ts          # Evidence retrieval
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ claim-extractor.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ citation-mapper.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ reasoning-flow.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ safety-check.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ quality/
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ citation-quality.test.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ STAGE-6-answer-synthesis/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ constants.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ exceptions.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ routes.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ handlers.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ schemas.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ stages/
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ stage6/
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ orchestrator.ts     # Stage 6 main orchestrator
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 6.1-composer.ts     # 6.1 SynthesisComposer (LLM)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 6.2-quick.ts        # 6.2 QuickPathSynth (SLM)
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 6.3-format.ts       # 6.3 PersonalizationFormatter
‚îÇ   ‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ 6.4-postproc.ts     # 6.4 PostProcessor
‚îÇ   ‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ 6.5-package.ts      # 6.5 ResponsePackaging
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ composer.ts             # Answer composition
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ formatter.ts            # Markdown/block formatting
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ personalizer.ts         # User preference application
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ post-processor.ts       # Cleanup & validation
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ response-builder.ts     # API response construction
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ answer-template.ts      # Answer structure templates
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ citation-format.ts      # Citation rendering
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ error-messages.ts       # Standard error responses
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integrations/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway.ts        # LLM calls (composer)
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ state-store.ts          # Evidence & skeleton retrieval
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ tracing.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ composer.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ formatter.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ post-processor.test.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ synthesis-flow.test.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ response-build.test.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ output-quality/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ citation-format.test.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ markdown-validity.test.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ model-gateway/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ adapters/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ llm-adapter.ts          # LLM (GPT-4, Claude, etc.)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ slm-adapter.ts          # Small LM (Llama, Phi, etc.)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ embeddings-adapter.ts   # Embeddings (OpenAI, local)
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ reranker-adapter.ts     # Cross-encoder reranking
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ vlm-adapter.ts          # Vision-Language Model
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ policies/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ retry-policy.ts         # Exponential backoff
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ budget-policy.ts        # Token/cost enforcement
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ timeout-policy.ts       # Request timeouts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ fallback-policy.ts      # Model fallback chains
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ embedding-cache.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ model-response-cache.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ cache-invalidation.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ cost-tracking.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ integration/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ üî∑ retrieval-service/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ README.md
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ config.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ hybrid/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ hybrid-search.ts        # BM25 + Vector hybrid
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ bm25-engine.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ vector-engine.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ rerank/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ cross-encoder.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ diversity-ranker.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cache/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ session-cache.ts        # Session-based caching
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ result-cache.ts
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dedup/
‚îÇ   ‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ url-dedup.ts
‚îÇ   ‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ content-dedup.ts
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ observability/
‚îÇ   ‚îÇ           ‚îú‚îÄ‚îÄ logging.ts
‚îÇ   ‚îÇ           ‚îî‚îÄ‚îÄ metrics.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ üî∑ web-worker/
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ       ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ       ‚îú‚îÄ‚îÄ .env.example
‚îÇ       ‚îú‚îÄ‚îÄ tsconfig.json
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îú‚îÄ‚îÄ README.md
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ index.ts
‚îÇ           ‚îú‚îÄ‚îÄ config.ts
‚îÇ           ‚îú‚îÄ‚îÄ fetch/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ http-client.ts          # HTTP fetching with retries
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ ssrf-guard.ts           # SSRF protection
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ robots-checker.ts       # robots.txt compliance
‚îÇ           ‚îú‚îÄ‚îÄ extract/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ dom-parser.ts           # HTML parsing
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ content-extractor.ts    # Main content extraction
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ table-extractor.ts      # Table structure extraction
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ metadata-extractor.ts   # Title, author, date, etc.
‚îÇ           ‚îú‚îÄ‚îÄ sanitize/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ html-sanitizer.ts       # XSS protection
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ pii-redactor.ts         # PII redaction
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ injection-filter.ts     # Prompt injection filtering
‚îÇ           ‚îú‚îÄ‚îÄ sandbox/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ action-sandbox.ts       # Action execution sandbox
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ allowlist-manager.ts    # Tool/domain allowlisting
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ approval-handler.ts     # Human approval workflow
‚îÇ           ‚îú‚îÄ‚îÄ headless/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ browser-pool.ts         # Playwright/Puppeteer pool
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ screenshot-engine.ts    # Screenshot capture
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ interaction-handler.ts  # Click, type, fill, submit
‚îÇ           ‚îî‚îÄ‚îÄ observability/
‚îÇ               ‚îú‚îÄ‚îÄ logging.ts
‚îÇ               ‚îî‚îÄ‚îÄ metrics.ts
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îÇ
‚îú‚îÄ‚îÄ üìÅ apps/
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ extension/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ manifest.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ popup.html / popup.ts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background.ts               # Service worker
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ content-script.ts           # Page context capture
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ api-client.ts               # Backend API calls
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tests/
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ web-ui/
‚îÇ       ‚îú‚îÄ‚îÄ package.json
‚îÇ       ‚îú‚îÄ‚îÄ vite.config.ts / next.config.js # Build config
‚îÇ       ‚îú‚îÄ‚îÄ public/
‚îÇ       ‚îú‚îÄ‚îÄ src/
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ home.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ results.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ query-input.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ answer-display.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ citations.tsx
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ progress.tsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ api-client.ts
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ styles/
‚îÇ       ‚îî‚îÄ‚îÄ tests/
‚îÇ
‚îú‚îÄ‚îÄ üìÅ infra/
‚îÇ   ‚îú‚îÄ‚îÄ k8s/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ namespace.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage1-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage2-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage3-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage4-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage5-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ stage6-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ model-gateway-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ retrieval-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ web-worker-deployment.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ configmaps/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.yaml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ secrets/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.yaml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ingress/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ *.yaml
‚îÇ   ‚îú‚îÄ‚îÄ terraform/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ redis.tf                       # Redis infrastructure
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ postgres.tf                    # PostgreSQL for artifacts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ kubernetes.tf                  # K8s cluster
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring.tf                  # Prometheus, Grafana
‚îÇ   ‚îú‚îÄ‚îÄ docker-compose.yml                 # Local development
‚îÇ   ‚îú‚îÄ‚îÄ .env.example
‚îÇ   ‚îî‚îÄ‚îÄ ci/
‚îÇ       ‚îú‚îÄ‚îÄ .github/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ workflows/
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ test.yml               # Unit & integration tests
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ lint.yml               # Code quality checks
‚îÇ       ‚îÇ       ‚îú‚îÄ‚îÄ security.yml           # Security scanning
‚îÇ       ‚îÇ       ‚îî‚îÄ‚îÄ deploy.yml             # CD pipeline
‚îÇ       ‚îî‚îÄ‚îÄ gitlab-ci.yml                  # Alternative CI/CD
‚îÇ
‚îú‚îÄ‚îÄ üìÑ .gitignore
‚îú‚îÄ‚îÄ üìÑ .env.example
‚îú‚îÄ‚îÄ üìÑ docker-compose.yml                  # Full stack local dev
‚îú‚îÄ‚îÄ üìÑ package.json                        # Root monorepo config
‚îú‚îÄ‚îÄ üìÑ pnpm-workspace.yaml                 # pnpm monorepo setup
‚îú‚îÄ‚îÄ üìÑ tsconfig.json                       # Root TS config
‚îú‚îÄ‚îÄ üìÑ README.md                           # Project overview
‚îú‚îÄ‚îÄ üìÑ CONTRIBUTING.md                     # Development guidelines
‚îú‚îÄ‚îÄ üìÑ LICENSE                             # License file
‚îî‚îÄ‚îÄ üìÑ CHANGELOG.md                        # Version history
```

---

## üìä Module Overview

### üî∑ STAGE 1: UnifiedInputCore
**Purpose**: Normalize and validate user input
- **Components**: InputAdapter, ContextCollector, Normalizer, SafetyPrecheck
- **Key Tasks**: 
  - Validate RawRequest schema
  - Normalize text & URL extraction
  - Detect language
  - Attach page context
  - Compute safety flags
- **Output**: `UnifiedInputCoreV1`

### üî∑ STAGE 2: QueryUnderstanding  
**Purpose**: Intent classification and task specification
- **Components**: PolicyClassifiers, IntentExtractor, RuleEngine, EmbeddingPrep
- **Key Tasks**:
  - Classify intent (qa, summarize, extract, etc.)
  - Extract slots & entities (budget, time, travel, etc.)
  - Apply policy overrides (PII, injection, confirmation)
  - Optional SLM call for complex queries
- **Output**: `TaskSpecV1`

### üî∑ STAGE 3: RouterPlanner
**Purpose**: Plan generation and orchestration strategy
- **Components**: SignalExtractor, ModeSelector, PlanBuilder, PlanValidator, BudgetManager, StateManager
- **Key Tasks**:
  - Extract routing signals from TaskSpec
  - Select execution mode (A=Research, B=Action, C=Research+Action, D=Action+Research)
  - Generate ActionPlan with steps, budgets, policy gates
  - Validate against policies & constraints
- **Output**: `ActionPlan` (with mode, steps, budgets)

### üî∑ STAGE 4: UnifiedExecutor
**Purpose**: Execute plan steps (retrieval, fetch, compute, action)
- **Components**: RetrievalEngine, Reranker, WebFetch, DOMParser, TableExtractor, ToolSandbox, EvidenceBuilder
- **Key Tasks**:
  - **4.1 Retrieve**: Hybrid search (BM25 + vector) with dedup
  - **4.2 FetchData**: HTTP fetch with SSRF protection, parse tables
  - **4.3 Compute**: Structured reasoning without UI actions (scoring, recommendations)
  - **4.4 Act**: Headless browser automation with policy gates & receipts
- **Output**: `EvidencePack` + `Receipt` (for actions)

### üî∑ STAGE 5: Reasoning
**Purpose**: Multi-step reasoning over evidence
- **Components**: EvidenceSummarizer, ReasoningCore, CitationMapper, OutputSafetyCheck
- **Key Tasks**:
  - Compress EvidencePack into digest
  - Extract atomic claims (each with evidence backing)
  - Resolve contradictions, flag uncertainties
  - Map claims to evidence (citations)
  - Safety validation
- **Output**: `AnswerSkeleton` + `CitationMap` + `OpenQuestions`

### üî∑ STAGE 6: AnswerSynthesis
**Purpose**: Generate final user-facing answer
- **Components**: SynthesisComposer, QuickPathSynth, PersonalizationFormatter, PostProcessor, ResponsePackaging
- **Key Tasks**:
  - Compose answer from AnswerSkeleton
  - Insert citations (inline + reference list)
  - Apply user personalization (tone, depth)
  - Post-processing (strip leaked system prompts, PII redaction)
  - Package response for FE
- **Output**: `FinalAnswer` + `ResponseV1`

---

## üîß Supporting Services

### model-gateway/
- Adapters for LLM, SLM, embeddings, reranker, VLM
- Retry policies, budget enforcement, caching
- Cost tracking & model fallback chains

### retrieval-service/
- Hybrid search engine (BM25 + vector)
- Reranking & diversity enforcement
- Session-based result caching
- URL & content deduplication

### web-worker/
- HTTP fetching with retries & SSRF protection
- HTML parsing & content extraction
- Table structure extraction
- Headless browser automation (P1)
- Sandbox for action execution
- PII redaction & injection filtering

---

## üöÄ Infrastructure & DevOps

### K8s (Kubernetes)
- Separate deployments for each stage service
- ConfigMaps for environment config
- Secrets for API keys & credentials
- Ingress for API Gateway
- Service mesh optional (Istio)

### Terraform
- Infrastructure as Code
- Redis cluster setup
- PostgreSQL database
- K8s cluster provisioning
- Monitoring stack (Prometheus, Grafana)

### CI/CD
- GitHub Actions workflows (test, lint, security, deploy)
- Automated testing on PR
- Security scanning (SAST/dependency)
- Containerized builds & registry push

### Local Development
- `docker-compose.yml` for full stack setup
- `.env.example` for configuration template

---

## üìö Documentation

- **ARCHITECTURE.md**: System design overview
- **API.md**: Endpoint specs, request/response schemas
- **THREAT-MODEL.md**: Security considerations & mitigations
- **RUNBOOK.md**: Operational procedures, troubleshooting
- **GLOSSARY.md**: Terminology definitions

---

## üîê Security & Observability

### Security
- SSRF protection (private IP blocklist)
- Prompt injection filtering
- PII detection & redaction
- Input validation & sanitization
- Action sandbox with policy gates
- Rate limiting & auth

### Observability
- **Logging**: Structured JSON logs (no sensitive data)
- **Metrics**: Prometheus (request count, latency, errors)
- **Tracing**: OpenTelemetry (distributed tracing)
- **Dashboards**: Grafana for monitoring

---

## üìã Key Files Reference

| File | Purpose |
|------|---------|
| `packages/shared/types/` | Canonical types (TaskSpec, Evidence, Answer) |
| `packages/shared/schemas/` | Validation schemas & serializers |
| `services/*/src/stages/` | Core stage logic (1-6) |
| `services/*/src/modules/` | Individual components per stage |
| `services/*/tests/` | Unit, integration, E2E tests |
| `infra/k8s/*.yaml` | Kubernetes manifests |
| `infra/terraform/` | IaC for cloud infrastructure |
| `docs/*.md` | Architecture, API, operations guides |

---

## üîÑ Data Flow Summary

```
User Input
    ‚Üì
Stage 1: UnifiedInputCore
    ‚Üì NormalizedInput
Stage 2: QueryUnderstanding
    ‚Üì TaskSpecV1
Stage 3: RouterPlanner
    ‚Üì ActionPlan
Stage 4: UnifiedExecutor
    ‚Üì EvidencePack + Receipt
Stage 5: Reasoning
    ‚Üì AnswerSkeleton + CitationMap
Stage 6: AnswerSynthesis
    ‚Üì FinalAnswer (Markdown + Citations)
```

---

**Created**: December 2025  
**Version**: 1.0 (MVP Enterprise)  
**Status**: Implementation Ready

---



