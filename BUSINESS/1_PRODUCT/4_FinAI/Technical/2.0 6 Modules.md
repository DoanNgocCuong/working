# AI-Native Browser (Comet-like) — Spec MVP chuẩn enterprise (v1, tiếng Việt)

> **Phạm vi MVP:** Text + Web HTML. Voice/YouTube = **future hooks** (interface-ready, not implemented heavy).

---

## A. Tóm tắt điều hành (Executive Summary)

- MVP triển khai pipeline **agentic** theo mô hình **single orchestrator**: 1 bộ điều phối trung tâm lập kế hoạch + giám sát thực thi tool, tối ưu latency/cost bằng cách “để model lớn chỉ bật ở vài điểm”.  
- Stage 1–2 chạy **sync** để trả **TaskSpecV1** nhanh, deterministic và dễ debug; Stage 3–6 chạy **async** (khuyến nghị mặc định) để mở rộng dần mà không phá API.
- Stage 3 tạo **ActionPlan** tuyến tính (steps có goal/tool/constraints/expected_output) và áp **budget & safety gates** trước khi cho phép browse/tool actions.
- Stage 4 thực thi plan: retrieval → rerank → fetch HTML → extract main content/tables → build **EvidencePack** (đã lọc + trace + safety trace).
- Stage 5 suy luận trên EvidencePack (không nhét web thô): tạo **AnswerSkeleton** (claims + structure) + **CitationMap** + **OpenQuestions**.
- Stage 6 tổng hợp AnswerSkeleton thành **Final Answer** (markdown/blocks), chèn citations, cá nhân hoá theo profile, chạy output-safety check.
- NFR (yêu cầu phi chức năng): p95 latency (Stage 1–2) < 1.5s; full run (Stage 3–6) < 8–12s (tuỳ allow_browse), có budget guardrails, retries + idempotency, rate-limit, privacy by design.
- Repo monorepo khuyến nghị: `packages/shared` (types/schemas), `services/orchestrator`, `services/retrieval`, `services/web-worker`, `services/model-gateway`, `apps/extension` (optional).
- What’s next: headless browsing (Playwright), VLM/PDF pipeline, interactive actions (click/fill) với sandbox + human approval, personalization ranking, on-device lite models (optional).

---

## B. Mục tiêu / Không làm (Goals / Non-goals)

### Goals (MVP)
- Chuẩn hoá input về **NormalizedInput** (text + optional URL/tab context).
- Sinh **TaskSpecV1** (intent/slots/routing/constraints) ổn định schema.
- Lập **ActionPlan** + chạy retrieval/fetch/extract để tạo **EvidencePack**.
- Trả lời có cấu trúc + citations + error model chuẩn.
- Có security/privacy/ops đủ để team **build/run/observe**.

### Non-goals (MVP)
- Không build multi-agent swarm song song; không tối ưu mọi website “khó”.
- Không thực hiện hành động nguy hiểm (submit/payment/login); chỉ duyệt web read-only mặc định.
- Không cam kết vendor/model cụ thể; mọi model/tool là **config-driven**.

### Assumptions
- Backend chạy server-side; FE/extension optional.
- Có 1 state store (Redis) + optional DB (Postgres).
- Có khả năng fetch HTML (HTTP client) và parse DOM; headless browsing là P1.

---


## Thuật ngữ (Glossary)

- **Stage**: giai đoạn trong pipeline (Stage 1→6).
- **Module**: thành phần triển khai trong một Stage.
- **Orchestrator**: bộ điều phối trung tâm (single orchestrator) lập kế hoạch và giám sát thực thi.
- **TaskSpecV1 / ActionPlan / EvidencePack**: các đối tượng canonical dùng xuyên suốt pipeline.

## C. Tổng quan hệ thống (System Overview, C4 Level 1–2)

### C1 — Ngữ cảnh (Context, Level 1)

```mermaid
flowchart LR
  U[User] --> FE[Browser UI / Extension (optional)]
  FE --> GW[API Gateway + WAF + Rate Limit]
  GW --> ORCH[Orchestrator API (Stages 1-6)]
  ORCH --> MG[Model Gateway]
  ORCH --> RET[Retrieval Service]
  ORCH --> WW[Web Worker (Fetch/Parse/Extract)]
  ORCH --> ST[(State Store)]
  ORCH --> OBS[Observability (OTel)]
  MG --> OBS
  RET --> OBS
  WW --> OBS
```

### C2 — Các khối dịch vụ (Containers, Level 2)

**API Gateway / WAF**
- AuthN/AuthZ, rate-limit, request size limit, header normalization, WAF rules.

**Orchestrator Service**
- Chịu trách nhiệm điều phối workflow Stage 1–6, state machine trạng thái task, budgets, safety gates, orchestration.

**Model Gateway**
- Adapters: SLM/LLM/Embeddings/Reranker/VLM (optional), retry/backoff, enforce budget.

**Retrieval Service**
- Query expansion, vector search (cache/session/index), BM25/search provider (optional), khử trùng lặp (dedupe), candidate scoring.

**Web Worker**
- HTTP fetch + sanitize + main-content extraction + table extraction; (P1) headless browsing & screenshots.

**State Store**
- Idempotency cache, task status, artifacts (TaskSpec/Evidence/Answer), session snippets.

---

## D. Pipeline end-to-end (End-to-End Pipeline)

### ASCII (one-way)

```
RawRequest
   |
   v
Stage 1: UnifiedInputCore  --> NormalizedInput + TraceContext
   |
   v
Stage 2: Query Understanding --> TaskSpecV1 (intent/slots/routing/constraints)
   |
   v
Stage 3: Planner/Orchestrator --> ActionPlan (steps + budgets + guards)
   |
   v
Stage 4: Search & Tool Use --> EvidencePack (filtered evidence + traces)
   |
   v
Stage 5: Reasoning --> AnswerSkeleton + CitationMap + OpenQuestions
   |
   v
Stage 6: Answer Synthesis --> FinalAnswer (+ optional audio later)
```

### Mermaid (flowchart)

```mermaid
flowchart TB
  A[RawRequest] --> B[Stage 1\nUnifiedInputCore]
  B --> C[Stage 2\nQuery Understanding]
  C --> D[Stage 3\nPlanner/Orchestrator]
  D --> E[Stage 4\nSearch & Tool Use]
  E --> F[Stage 5\nReasoning]
  F --> G[Stage 6\nAnswer Synthesis]
  G --> H[Response + Telemetry]
```

---

## E. Phân rã module theo stage (Module Breakdown)

> Format per module: **Purpose / Inputs / Outputs / Responsibilities / Dependencies / Failure modes**

### Stage 1 — UnifiedInputCore (Normalize Input)

#### 1.1 InputAdapter
- **Purpose:** nhận request từ FE/API, validate schema, attach trace, enforce idempotency.
- **Inputs:** RawRequest, headers (Auth, Idempotency-Key, Correlation-Id).
- **Outputs:** Validated RawRequest + TraceContext.
- **Responsibilities:** schema validation, size limit, payload hash, idempotency lookup.
- **Dependencies:** state store (idempotency), auth context.
- **Failure modes:** 400 invalid schema; 413 too large; 409 idempotency conflict.

#### 1.2 ContextCollector (MVP-lite)
- **Purpose:** gom context tối thiểu: current_url, tab_title, selected_text, locale.
- **Inputs:** RawRequest.context.
- **Outputs:** ContextBundle.
- **Failure modes:** thiếu context → giảm cấp (degrade gracefully) to text-only.

#### 1.3 Normalizer
- **Purpose:** chuẩn hoá về NormalizedInput.
- **Inputs:** Validated RawRequest + ContextBundle.
- **Outputs:** NormalizedInput.
- **Responsibilities:** normalize whitespace, detect language, URL parse, create fetch intent (không fetch ngay nếu async).
- **Failure modes:** 422 unsupported input type; 400 invalid URL.

#### 1.4 SafetyPrecheck (fast gate)
- **Purpose:** chặn sớm prompt-injection/SSRF obvious trước khi tốn model.
- **Inputs:** NormalizedInput.
- **Outputs:** safety baseline flags.
- **Failure modes:** mark blocked/sanitize; allow with warnings.

---

### Stage 2 — Query Understanding (TaskSpec skeleton)

#### 2.1 Policy Classifiers
- **Purpose:** toxicity/illegal/self-harm, prompt-injection, PII.
- **Inputs:** NormalizedInput + ContextBundle.
- **Outputs:** safety_flags, pii_spans, injection_score.
- **Failure modes:** timeout → “cautious” default, log.

#### 2.2 Intent & Slot Extractor (SLM)
- **Purpose:** intent classification + slot filling + query normalization.
- **Inputs:** sanitized query + optional related_history_snippets.
- **Outputs:** intent, slots, normalized_query, routing_hints.
- **Failure modes:** malformed JSON → retry once; phương án dự phòng (fallback) rules.

#### 2.3 Rule Engine (deterministic router)
- **Purpose:** quyết định routing ổn định: quick_path vs browse vs extract vs summarize.
- **Inputs:** intent/slots/routing_hints + safety_flags + options.
- **Outputs:** TaskSpecV1.
- **Failure modes:** rule conflict → choose safest path.

#### 2.4 Embedding Prep
- **Purpose:** tạo query embedding + retrieve session history snippets.
- **Inputs:** normalized_query.
- **Outputs:** query_embedding_ref, related_history_snippets.
- **Failure modes:** embedding unavailable → disable retrieval (giảm cấp (degrade gracefully)).

---

### Stage 3 — Planner / Orchestrator (Single Orchestrator)

> **Mục tiêu:** tạo plan tuyến tính + giám sát thực thi tool-use; model lớn chỉ “bật” khi cần.

#### 3.0 Khái niệm chính (Key Concepts) (Stage 3)

**ActionPlan** là danh sách step *tuyến tính* (có thể có nhánh “early stop” theo condition).  
Mỗi step có: `goal`, `tool`, `input`, `constraints`, `expected_output`, `stop_condition`, `budget`.

**Chiến lược mặc định (MVP):**
- Nếu `quick_path=true` và `needs_browse=false` → skip Stage 4, sang Stage 5/6 với minimal evidence (history + user text).
- Nếu `needs_browse=true` → Stage 4 chạy duyệt web read-only: search → fetch HTML → extract.

#### 3.1 PlanBuilder (Planner LLM/LAM in planning mode)
- **Purpose:** chuyển TaskSpecV1 thành ActionPlan hợp lệ.
- **Inputs:** TaskSpecV1, user_profile_features (optional), policy_context.
- **Outputs:** ActionPlan (draft).
- **Responsibilities:**
  - Query decomposition: tạo sub-queries (nếu cần).
  - Decide tool sequence: `search → fetch → extract → khử trùng lặp (dedupe) → synth`.
  - Define success criteria & stop conditions.
- **Dependencies:** Model Gateway (planner model), Tool Registry (capabilities).
- **Failure modes:** plan invalid schema → retry; fail → phương án dự phòng (fallback) plan template.

#### 3.2 PlanValidator (deterministic)
- **Purpose:** đảm bảo plan tuân policy + budget + capability constraints.
- **Inputs:** draft ActionPlan + safety_flags + tenant policies.
- **Outputs:** validated ActionPlan hoặc blocked.
- **Responsibilities:**
  - Remove forbidden tools/actions (e.g., fill_form in MVP).
  - Enforce max_steps, max_domains, deny SSRF ranges, safe browsing.
  - Enforce budget: max model calls, max fetches, max tokens.
- **Failure modes:** policy violation → return POLICY_BLOCKED; budget exceed → downgrade plan (less steps).

#### 3.3 BudgetManager
- **Purpose:** quản lý “cost envelope” theo request.
- **Inputs:** options (max_latency_ms), tenant budget policy, historical cost signals.
- **Outputs:** per-stage budgets (time/token/fetch count).
- **Responsibilities:** dynamic throttling (reduce evidence count, skip reranker, smaller model).
- **Failure modes:** no budget config → conservative defaults.

#### 3.4 StateManager (Task State Machine)
- **Purpose:** lưu trạng thái task, artifacts, retries, idempotency mapping.
- **Inputs:** Task events (PLAN_BUILT, STEP_DONE, FAILED…).
- **Outputs:** persistent state, progress snapshots.
- **Dependencies:** state-store/DB.
- **Failure modes:** store unavailable → fail fast 503 (idempotency risk).

#### 3.5 Orchestrator Runtime (StepExecutor)
- **Purpose:** chạy ActionPlan step-by-step, ghi trace, handle retries.
- **Inputs:** validated ActionPlan, TraceContext.
- **Outputs:** EvidencePack (from Stage 4), intermediate artifacts, execution_trace.
- **Responsibilities:**
  - Dispatch tool calls (search/fetch/extract).
  - Run steps in parallel when safe (e.g., multi-fetch fan-out) nhưng vẫn “single orchestrator” quyết định.
  - Apply retry policy per tool (with backoff), and **idempotent tool calls** (tool-level keys).
  - Early stop when sufficient evidence (confidence threshold).
- **Failure modes:** repeated tool failure → giảm cấp (degrade gracefully) (partial answer) or fail with retryable flag.

#### 3.6 Personalization Hook (optional, MVP-lite)
- **Purpose:** adjust depth/style/source preferences.
- **Inputs:** session signals, user profile features.
- **Outputs:** plan modifiers (depth=quick/deep, source priorities).
- **Failure modes:** missing profile → default “balanced”.

---

### Stage 4 — Search & Tool Use

> **Mục tiêu:** thực thi plan để tạo **EvidencePack đã lọc**; tách “tool execution” khỏi reasoning để tiết kiệm token.

#### 4.0 Chế độ thực thi (Execution Modes)
- **Mode A (MVP default): Read-only Web**  
  search → HTTP fetch → DOM parse → content extract → evidence pack.
- **Mode B (P1): Headless / Interactive**  
  open_tab/click/scroll với sandbox + allowlist + human approval for dangerous actions.

#### 4.1 RetrievalEngine
- **Purpose:** lấy candidates từ session cache + web search/index.
- **Inputs:** query_embedding_ref, normalized_query, sub_queries.
- **Outputs:** CandidateList (50–100).
- **Responsibilities:**
  - Hybrid retrieval: vector + keyword (configurable).
  - Dedupe by URL + near-duplicate text hash.
  - Domain scoring (trusted sources bias) theo tenant policy.
- **Dependencies:** vector store, optional search provider.
- **Failure modes:** retrieval unavailable → phương án dự phòng (fallback) to direct fetch (if URL provided) hoặc no-browse.

#### 4.2 Reranker
- **Purpose:** rerank candidates → chọn top evidence chất lượng.
- **Inputs:** CandidateList, query.
- **Outputs:** TopEvidence (5–10).
- **Responsibilities:** cross-encoder rerank; enforce diversity by domain.
- **Failure modes:** reranker unavailable → phương án dự phòng (fallback) to similarity score.

#### 4.3 WebFetch (HTTP) + SSRF Guard
- **Purpose:** tải HTML an toàn.
- **Inputs:** URL list, fetch policy.
- **Outputs:** FetchResult (status, headers, html_bytes).
- **Responsibilities:**
  - SSRF block (private IPs, metadata IPs).
  - Respect robots/timeout/size; retries with backoff.
  - Content-type guard (only html/text in MVP).
- **Failure modes:** 404/403/timeout; blocked by policy; returns typed errors.

#### 4.4 DOMParser & MainContentExtractor
- **Purpose:** parse DOM và trích xuất main content vs nav/ads/sidebar.
- **Inputs:** html_bytes, base_url.
- **Outputs:** StructuredPageView: title, headings, paragraphs, links, tables (basic).
- **Responsibilities:** boilerplate removal, readability extraction, normalize whitespace, language detect.
- **Failure modes:** malformed HTML → best-effort parse; empty main content → phương án dự phòng (fallback) to snippet-based evidence.

#### 4.5 TableExtractor (MVP-basic)
- **Purpose:** extract tables (HTML) thành structured rows.
- **Inputs:** DOM tree.
- **Outputs:** table artifacts (csv/json).
- **Failure modes:** complex tables → include as raw html fragment + warning.

#### 4.6 VLM/OCR Hook (P1+)
- **Purpose:** xử lý PDF/chart/layout lạ bằng screenshot → structured view.
- **Inputs:** screenshot/pdf bytes.
- **Outputs:** structured_page_views, extracted tables/charts.
- **Note:** not required in MVP; interface only.

#### 4.7 Tool Sandbox / ActionPolicy (for agentic browsing)
- **Purpose:** enforce allowed actions & safe execution.
- **Inputs:** tool call request (tool_name, args), policy.
- **Outputs:** tool call result or block.
- **Responsibilities:** allowlist tools, domain allowlist, redact secrets, no credential entry in MVP.
- **Failure modes:** blocked tool call with POLICY_BLOCKED (not retryable).

#### 4.8 EvidenceBuilder
- **Purpose:** build EvidencePack đã lọc để Stage 5 reasoning.
- **Inputs:** TopEvidence + StructuredPageViews + tables.
- **Outputs:** EvidencePack.
- **Responsibilities:**
  - Chunking & citation anchors (url + offsets + hashes).
  - Keep only relevant spans (reduce token).
  - Safety sanitize: remove PII spans, strip prompt-injection text patterns.
- **Failure modes:** empty evidence → return EvidencePack with warnings.

#### 4.9 ExecutionTraceCollector
- **Purpose:** capture `execution_trace` và `safety_trace`.
- **Inputs:** all tool events.
- **Outputs:** trace artifacts.
- **Responsibilities:** correlation_id propagation, sampling, redaction.
- **Failure modes:** trace sink down → drop non-critical traces.

---

### Stage 5 — Reasoning

> **Mục tiêu:** suy luận đa bước dựa trên evidence **đã nén**, giải quyết mâu thuẫn, tạo skeleton + citations map.

#### 5.1 EvidenceSummarizer (token reducer)
- **Purpose:** nén EvidencePack thành “evidence digest” theo schema.
- **Inputs:** EvidencePack.
- **Outputs:** EvidenceDigest (facts list, key quotes, table summaries).
- **Responsibilities:** minimize tokens, keep provenance pointers.
- **Failure modes:** summarizer fail → phương án dự phòng (fallback) to truncated raw snippets.

#### 5.2 ReasoningCore (Reasoning LLM/LAM)
- **Purpose:** tạo AnswerSkeleton + claim graph.
- **Inputs:** TaskSpecV1, EvidenceDigest, constraints (style/depth).
- **Outputs:** AnswerSkeleton, ClaimList, OpenQuestions.
- **Responsibilities:**
  - Build answer outline (sections).
  - Extract atomic claims (each claim must be backed by ≥1 evidence item OR marked as assumption).
  - Resolve contradictions: prefer higher-trust sources; flag uncertain areas.
- **Failure modes:** low confidence / insufficient evidence → produce partial answer + OpenQuestions (không hỏi ngược người dùng trong MVP response; chỉ báo “thiếu dữ liệu”).

#### 5.3 CitationMapper (claim → evidence)
- **Purpose:** map claim IDs to evidence anchors.
- **Inputs:** ClaimList, EvidencePack.
- **Outputs:** CitationMap.
- **Responsibilities:** ensure no claim without mapping unless labeled assumption.
- **Failure modes:** missing mapping → downgrade claim to “uncertain” + warning.

#### 5.4 OutputSafetyCheck (draft-level)
- **Purpose:** safety check cho intermediate drafts.
- **Inputs:** AnswerSkeleton + claims.
- **Outputs:** allow / sanitize / block.
- **Failure modes:** false positive → sanitize minimally, log.

---

### Stage 6 — Answer Synthesis

> **Mục tiêu:** biến skeleton thành câu trả lời rõ ràng + định dạng + citations; quick path bằng SLM khi task đơn giản.

#### 6.1 SynthesisComposer (LLM)
- **Purpose:** generate final answer text from skeleton.
- **Inputs:** AnswerSkeleton, CitationMap, style options.
- **Outputs:** FinalAnswer (markdown blocks), AnswerMetadata.
- **Responsibilities:**
  - Rendering policy: headings/bullets/tables.
  - Insert citations inline (e.g., [1], [2]) + reference list.
  - Respect length/depth constraints and user profile.
- **Failure modes:** model timeout → phương án dự phòng (fallback) “short answer” template + skeleton.

#### 6.2 QuickPathSynth (SLM)
- **Purpose:** answer nhanh khi không browse / ít evidence.
- **Inputs:** TaskSpecV1 + minimal evidence.
- **Outputs:** FinalAnswer.
- **Failure modes:** escalate to 6.1 if quality < threshold.

#### 6.3 PersonalizationFormatter
- **Purpose:** adjust tone/depth/verbosity based on profile features.
- **Inputs:** user_profile_features.
- **Outputs:** formatting parameters (verbosity, style).
- **Failure modes:** missing profile → default.

#### 6.4 PostProcessor
- **Purpose:** deterministic cleanup.
- **Inputs:** FinalAnswer draft.
- **Outputs:** FinalAnswer sanitized.
- **Responsibilities:** strip leaked system prompts, redact PII, normalize markdown, enforce max length.
- **Failure modes:** if violation persists → block with safe message.

#### 6.5 ResponsePackaging
- **Purpose:** package for FE: answer blocks + citations + artifacts.
- **Inputs:** FinalAnswer + EvidencePack.
- **Outputs:** API response body (ResponseV1).
- **Failure modes:** artifacts too large → return truncated artifacts + link refs.

---

## F. Mô hình dữ liệu (Data Model)

### Canonical Objects
- **RawRequest**: input từ FE/API.
- **NormalizedInput**: canonical normalized query + context.
- **TaskSpecV1**: intent/slots/routing/constraints/budget hints.
- **ActionPlan**: list of steps (tool calls & success conditions).
- **EvidencePack**: filtered evidence + provenance + traces.
- **AnswerSkeleton**: structured outline + claims.
- **FinalAnswer**: user-facing content blocks + citations.
- **TraceContext**: request_id/correlation_id/session_id.

### Mini JSON Schemas (core fields)

#### RawRequest
```json
{
  "request_id": "req_...",
  "idempotency_key": "idem_...",
  "user": { "user_id": "u_123", "session_id": "s_456" },
  "input": {
    "type": "text|web_url|html_snapshot",
    "text": "…",
    "url": "https://…",
    "html": "<html>…</html>"
  },
  "context": {
    "current_url": "https://…",
    "tab_title": "…",
    "selected_text": "…",
    "locale": "vi-VN",
    "timezone": "Asia/Bangkok"
  },
  "options": {
    "mode": "auto|quick|deep",
    "allow_browse": true,
    "max_latency_ms": 8000
  },
  "trace": { "correlation_id": "corr_..." }
}
```

#### TaskSpecV1
```json
{
  "task_id": "task_...",
  "request_id": "req_...",
  "intent": "qa|summarize|extract|compare|navigate",
  "slots": { "entities": ["..."], "timeframe": "..." },
  "routing": {
    "quick_path": false,
    "needs_browse": true,
    "needs_citations": true
  },
  "constraints": {
    "allow_domains": ["*"],
    "deny_domains": ["localhost", "169.254.169.254"],
    "max_steps": 6,
    "max_fetch": 8
  },
  "budget": {
    "max_model_calls": 6,
    "max_tokens_total": 12000
  },
  "trace": { "correlation_id": "corr_..." }
}
```

#### ActionPlan
```json
{
  "task_id": "task_...",
  "steps": [
    {
      "step_id": "s1",
      "goal": "Find authoritative sources",
      "tool": "retrieval.search",
      "input": { "query": "..." },
      "constraints": { "max_candidates": 80 },
      "expected_output": { "type": "CandidateList" },
      "stop_condition": { "type": "always" }
    },
    {
      "step_id": "s2",
      "goal": "Fetch top pages",
      "tool": "web.fetch",
      "input": { "urls_ref": "cand_top10" },
      "constraints": { "timeout_ms": 2500, "max_bytes": 2000000 },
      "expected_output": { "type": "FetchResults" },
      "stop_condition": { "type": "on_error_budget", "max_errors": 3 }
    }
  ],
  "global_constraints": { "max_steps": 6, "allow_actions": ["read_only"] }
}
```

#### EvidencePack
```json
{
  "task_id": "task_...",
  "items": [
    {
      "evidence_id": "e1",
      "source_url": "https://...",
      "title": "...",
      "type": "snippet|table|structured_view",
      "content": "…",
      "anchors": { "hash": "sha256(...)", "offsets": [120, 420] },
      "score": 0.92
    }
  ],
  "execution_trace": [{ "tool": "web.fetch", "url": "...", "status": 200 }],
  "safety_trace": [{ "check": "pii", "result": "redacted" }]
}
```

#### AnswerSkeleton + CitationMap
```json
{
  "outline": [
    { "section": "Overview", "bullets": ["..."] }
  ],
  "claims": [
    { "claim_id": "c1", "text": "...", "confidence": 0.8, "assumption": false }
  ],
  "citation_map": {
    "c1": ["e1", "e3"]
  },
  "open_questions": ["Missing ... from authoritative sources"]
}
```

### Idempotency / request_id / session_id / user_id
- `Idempotency-Key` bắt buộc cho `/tasks:execute`.  
- Không log `user_id` raw; dùng hash/pseudonymous trong logs/traces.  
- `session_id` dùng để truy xuất history snippets (retention ngắn).

---

## G. Đặc tả API (API Spec)

### Endpoints (REST)

#### `POST /v1/tasks:execute`
- **Purpose:** execute Stage 1–6 (default async), hoặc sync-only Stage 1–2 (config).
- **Headers:**
  - `Authorization: Bearer <token>`
  - `Idempotency-Key: <string>`
  - `X-Correlation-Id: <string>` (optional)
- **Request:** RawRequest
- **Responses:**
  - `202 Accepted` (recommended): returns task_id
  - `200 OK` (sync mode): returns ResponseV1 (final)
- **Example (202):**
```json
{ "task_id": "task_123", "status": "RUNNING", "correlation_id": "corr_..." }
```

#### `GET /v1/tasks/{task_id}`
- **Purpose:** poll status + fetch artifacts.
- **Response:**
```json
{
  "task_id": "task_123",
  "status": "RUNNING|SUCCEEDED|FAILED",
  "artifacts": {
    "task_spec": { },
    "evidence_pack": null,
    "final_answer": null
  },
  "correlation_id": "corr_..."
}
```

#### `GET /healthz`, `GET /readyz`

### Status Model
- `RUNNING`: executing plan steps
- `SUCCEEDED`: final_answer ready
- `FAILED`: failed with error (retryable?)

### Standard Error Model
```json
{
  "error_code": "INVALID_ARGUMENT|UNAUTHORIZED|RATE_LIMITED|MODEL_TIMEOUT|FETCH_FAILED|POLICY_BLOCKED|INTERNAL",
  "message": "human readable",
  "retryable": true,
  "correlation_id": "corr_...",
  "details": { "stage": 4, "tool": "web.fetch" }
}
```

### Rate Limit + Auth
- Gateway enforced: per-user + per-IP. Default: 60 rpm/user (config).
- Auth: JWT/OAuth2 recommended; API keys allowed for MVP internal.

---

## H. Bảo mật & Quyền riêng tư (Security & Privacy)

### Threat Model (short)
- Prompt-injection từ web content.
- SSRF via URL fetch.
- Data exfiltration (secrets/system prompt).
- Abuse/cost blow-up (spam).
- PII leakage in logs/artifacts.

### Controls
- **Network boundary:** GW/WAF at edge; services in private network; egress proxy for web-worker.
- **SSRF guard:** block RFC1918, link-local, metadata, localhost, non-HTTP(s).
- **Secrets management:** Vault/KMS; rotate; no secrets in logs.
- **PII handling:** detect + redact in logs and EvidencePack (config).
- **Action sandbox:** MVP allowlist read-only; interactive actions require P1 human approval.

### Data Retention (default suggestions)
- Traces/logs: 7–14 days.
- Artifacts (TaskSpec/Evidence/Answer): 1–7 days.
- Tenant-configurable; “no-store” mode for enterprise.

---

## I. Quan sát hệ thống & Vận hành (Observability & Ops)

### Logging
- JSON logs: request_id, correlation_id, user_hash, stage, step_id, tool, latency_ms, retry_count, cost_estimate.

### Tracing
- OpenTelemetry spans per stage and per tool call.

### Metrics
- request_count/status
- latency p50/p95/p99 per stage
- model_calls + token_in/out
- fetch_success_rate + ssrf_block_count
- policy_block_rate
- cache_hit_rate (idempotency, retrieval)

### SLO (suggested)
- Stage 1–2 p95 < 1500ms
- Full pipeline p95 < 8–12s (browse on)
- Availability 99.9% for core API

---

## J. Cấu trúc repo / thư mục (Repo / Folder Structure)

```
repo/
  docs/
    spec.md
    api.md
    threat-model.md
    runbook.md
  packages/
    shared/
      src/
        types/
        schemas/
        utils/
  services/
    orchestrator/
      src/
        api/
        stages/
        runtime/
        policies/
        observability/
      tests/
    model-gateway/
      src/
        adapters/
        policies/
      tests/
    retrieval/
      src/
        hybrid/
        rerank/
        cache/
      tests/
    web-worker/
      src/
        fetch/
        extract/
        sandbox/
      tests/
  apps/
    extension/   # optional
    web-ui/      # optional
  infra/
    k8s/
    terraform/
    ci/
```

---

## K. Kế hoạch kiểm thử (Test Plan)

### Unit
- PlanValidator rules: forbid interactive actions in MVP.
- SSRF guard: block private ranges.
- EvidenceBuilder: khử trùng lặp (dedupe) + anchors.
- CitationMapper: no claim without evidence unless assumption.

### Integration
- Orchestrator ↔ retrieval ↔ web-worker ↔ model-gateway happy path.
- Retries/backoff for web.fetch and model calls.
- Idempotency: same key returns same task_id/result.

### E2E
- Text-only: quick path.
- Text + URL: fetch/extract → answer with citations.
- Prompt injection page: sanitize/skip, still answer safely.

### Golden Tests
- Deterministic TaskSpecV1 output for given inputs.
- Deterministic plan template outputs (when planner disabled).

### Edge Cases Checklist
- Empty/very long text; mixed languages.
- 403/404/timeout; redirect loops.
- Paywall/login pages.
- Duplicated sources; contradictory sources.
- Evidence too large → truncation path.

---

## L. Tiêu chí nghiệm thu (Acceptance Criteria)

### P0 (must)
- Stage 1–6 chạy end-to-end (at least Mode A read-only browse).
- Idempotency works; error model includes correlation_id.
- SSRF protection + rate limit + auth in place.
- EvidencePack built and citations inserted for evidence-backed claims.
- Observability: logs + traces + metrics minimal dashboards.

### P1 (should)
- Async tasks with progress events; streaming answer blocks.
- Headless browsing (Playwright) for JS-heavy sites.
- Reranker + diversity enforcement; better citation anchors.
- Tenant-configurable retention + no-store mode.

### P2 (nice)
- VLM/PDF pipeline; OCR for scanned docs.
- Interactive actions with sandbox + human approval.
- Strong personalization (source ranking + style).

---

## M. Câu hỏi mở / Future hooks (Open Questions / Future Hooks)

1) Sync vs Async default: MVP recommended async for Stage 3–6 to avoid gateway timeouts; keep sync for internal/dev mode.
2) Retrieval strategy: external search API vs self-index. Default: external search for MVP; keep interface for self-index.
3) Headless browsing: enable P1; keep HTTP fetch path as phương án dự phòng (fallback).
4) Citation UX format: inline numeric vs hover cards. Keep metadata in ResponseV1 for FE rendering.
5) Multi-tenant policy: domain allowlist/denylist, retention, budgets.

---
