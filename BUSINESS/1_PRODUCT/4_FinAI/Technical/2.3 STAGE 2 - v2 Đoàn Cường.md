# TECHNICAL DEEP-DIVE SPECIFICATION (TDD)

**Version 3.0 - Universal Pro Edition**

---

## ğŸ“‹ **METADATA (Document Header)**

- **Title:** Module 2 - Query Understanding & Task Spec
- **Author:** Manus AI (Ä‘Ã³ng vai Chief Architect)
- **Reviewers:** Tech Lead, Product Manager, AI/ML Lead
- **Status:** Draft
- **Created:** 2025-12-10
- **Last Updated:** 2025-12-10
- **Version:** 1.0
- **Related Docs:** [STAGE 1 - Input & Ingestion](link-to-stage1-doc), [STAGE 3 - Router & Planner](link-to-stage3-doc)

---

## 1. OVERVIEW & CONTEXT

### 1.1. Executive Summary (TL;DR)

- **Problem Statement:** CÃ¡c module xá»­ lÃ½ phÃ­a sau (Planner, Agents) khÃ´ng thá»ƒ hoáº¡t Ä‘á»™ng má»™t cÃ¡ch Ä‘Ã¡ng tin cáº­y vá»›i input thÃ´, khÃ´ng cÃ³ cáº¥u trÃºc tá»« ngÆ°á»i dÃ¹ng. Cáº§n má»™t lá»›p trung gian Ä‘á»ƒ "hiá»ƒu" vÃ  "chuáº©n hÃ³a" yÃªu cáº§u.
- **Proposed Solution:** XÃ¢y dá»±ng má»™t pipeline xá»­ lÃ½ 2 giai Ä‘oáº¡n (`Rule-first, SLM-backup`) Ä‘á»ƒ phÃ¢n tÃ­ch `UnifiedInputCore` tá»« Stage 1, táº¡o ra má»™t Ä‘á»‘i tÆ°á»£ng `TaskSpecV1` cÃ³ cáº¥u trÃºc, rÃµ rÃ ng vá» Ã½ Ä‘á»‹nh, pháº¡m vi, thá»±c thá»ƒ, vÃ  cÃ¡c cá» chÃ­nh sÃ¡ch.
- **Impact:** TÄƒng Ä‘á»™ tin cáº­y vÃ  kháº£ nÄƒng dá»± Ä‘oÃ¡n cá»§a toÃ n bá»™ há»‡ thá»‘ng. Giáº£m Ä‘Ã¡ng ká»ƒ Ä‘á»™ phá»©c táº¡p cho cÃ¡c module phÃ­a sau. Cho phÃ©p Ä‘á»‹nh tuyáº¿n vÃ  thá»±c thi tÃ¡c vá»¥ má»™t cÃ¡ch an toÃ n vÃ  hiá»‡u quáº£.

### 1.2. Background & Motivation

- **Why now?** ÄÃ¢y lÃ  module ná»n táº£ng, trÃ¡i tim cá»§a há»‡ thá»‘ng agentic. KhÃ´ng cÃ³ nÃ³, há»‡ thá»‘ng chá»‰ lÃ  má»™t chuá»—i cÃ¡c lá»i gá»i LLM khÃ´ng thá»ƒ kiá»ƒm soÃ¡t, dáº«n Ä‘áº¿n káº¿t quáº£ khÃ´ng nháº¥t quÃ¡n vÃ  rá»§i ro cao.
- **Current Pain Points:** Náº¿u khÃ´ng cÃ³ Stage 2, Stage 3 (Planner) sáº½ pháº£i tá»± mÃ¬nh phÃ¢n tÃ­ch vÄƒn báº£n thÃ´, dáº«n Ä‘áº¿n viá»‡c logic láº­p káº¿ hoáº¡ch bá»‹ trá»™n láº«n vá»›i logic hiá»ƒu ngÃ´n ngá»¯, vi pháº¡m nguyÃªn táº¯c Single Responsibility.
- **Alternatives Considered:**
    - **Chá»‰ dÃ¹ng LLM:** Gá»i má»™t LLM lá»›n Ä‘á»ƒ chuyá»ƒn Ä‘á»•i trá»±c tiáº¿p tá»« input thÃ´ sang `TaskSpecV1`. **LÃ½ do loáº¡i bá»:** Chi phÃ­ cao, Ä‘á»™ trá»… lá»›n, khÃ³ kiá»ƒm soÃ¡t, khÃ³ debug, vÃ  khÃ´ng cáº§n thiáº¿t cho pháº§n lá»›n cÃ¡c yÃªu cáº§u Ä‘Æ¡n giáº£n.
    - **Chá»‰ dÃ¹ng Rule Engine:** Chá»‰ sá»­ dá»¥ng cÃ¡c quy táº¯c regex/keyword. **LÃ½ do loáº¡i bá»:** KhÃ´ng Ä‘á»§ linh hoáº¡t Ä‘á»ƒ xá»­ lÃ½ cÃ¡c yÃªu cáº§u phá»©c táº¡p, mÆ¡ há»“ hoáº·c cÃ¡c thá»±c thá»ƒ khÃ´ng cÃ³ cáº¥u trÃºc (vÃ­ dá»¥: `preferences`).

### 1.3. Success Criteria

- **Accuracy:** >95% phÃ¢n loáº¡i chÃ­nh xÃ¡c `intent`, `scope`, `artifact` trÃªn bá»™ dá»¯ liá»‡u Ä‘Ã¡nh giÃ¡.
- **Latency:** P99 latency cho "Fast Path" (chá»‰ dÃ¹ng Rule Engine) < 50ms. P95 latency cho "Slow Path" (cÃ³ gá»i SLM) < 500ms.
- **Coverage:** Rule Engine cÃ³ thá»ƒ xá»­ lÃ½ >80% tá»•ng sá»‘ request mÃ  khÃ´ng cáº§n gá»i SLM (confidence â‰¥ 0.85).

---

## 2. GOALS / SCOPE / NON-GOALS / ASSUMPTIONS

### 2.1. Goals

- **Business Goals:** Äáº£m báº£o cÃ¡c tÃ¡c vá»¥ cá»§a ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c hiá»ƒu Ä‘Ãºng ngay tá»« Ä‘áº§u, giáº£m tá»· lá»‡ thá»±c thi tháº¥t báº¡i do hiá»ƒu sai yÃªu cáº§u.
- **Technical Goals:** Cung cáº¥p má»™t `TaskSpecV1` á»•n Ä‘á»‹nh, cÃ³ cáº¥u trÃºc cho cÃ¡c module phÃ­a sau. Äáº¡t Ä‘Æ°á»£c cÃ¡c chá»‰ sá»‘ vá» latency vÃ  accuracy Ä‘Ã£ Ä‘á» ra.
- **User Experience Goals:** Pháº£n há»“i nhanh cho cÃ¡c yÃªu cáº§u Ä‘Æ¡n giáº£n, Ä‘áº£m báº£o há»‡ thá»‘ng khÃ´ng "Ä‘oÃ¡n mÃ²" má»™t cÃ¡ch nguy hiá»ƒm vá»›i cÃ¡c yÃªu cáº§u phá»©c táº¡p.

### 2.2. In-Scope

- XÃ¢y dá»±ng **Rule Engine** Ä‘á»ƒ phÃ¢n tÃ­ch nhanh `intent`, `scope`, `artifact`, `action_level`, `risk`, vÃ  cÃ¡c thá»±c thá»ƒ cá»©ng.
- TÃ­ch há»£p má»™t **Small Language Model (SLM)** Ä‘á»ƒ xá»­ lÃ½ cÃ¡c trÆ°á»ng há»£p mÃ  Rule Engine khÃ´ng cháº¯c cháº¯n.
- XÃ¢y dá»±ng module **Policy Overrides** Ä‘á»ƒ Ã¡p Ä‘áº·t cÃ¡c quy táº¯c an toÃ n cuá»‘i cÃ¹ng.
- Äá»‹nh nghÄ©a vÃ  sinh ra Ä‘á»‘i tÆ°á»£ng `TaskSpecV1` hoÃ n chá»‰nh.

### 2.3. Out-of-Scope / Non-Goals

- **KHÃ”NG** thá»±c hiá»‡n báº¥t ká»³ hÃ nh Ä‘á»™ng nÃ o (web search, API call bÃªn ngoÃ i, thao tÃ¡c UI).
- **KHÃ”NG** tÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i ngÆ°á»i dÃ¹ng Ä‘á»ƒ lÃ m rÃµ yÃªu cáº§u (Ä‘Ã³ lÃ  nhiá»‡m vá»¥ cá»§a Stage 5 - Clarification).
- **KHÃ”NG** giá»¯ láº¡i báº¥t ká»³ tráº¡ng thÃ¡i nÃ o giá»¯a cÃ¡c request.

### 2.4. Assumptions

- `UnifiedInputCore` nháº­n tá»« Stage 1 Ä‘Ã£ Ä‘Æ°á»£c chuáº©n hÃ³a vÃ  chá»©a Ä‘áº§y Ä‘á»§ thÃ´ng tin cáº§n thiáº¿t (vÄƒn báº£n Ä‘Ã£ chuáº©n hÃ³a, URL, context trang).
- CÃ³ má»™t SLM (vÃ­ dá»¥: Llama3-8B, Gemma-7B) Ä‘Ã£ Ä‘Æ°á»£c triá»ƒn khai vÃ  sáºµn sÃ ng Ä‘á»ƒ gá»i qua má»™t API ná»™i bá»™.

### 2.5. Constraints

- **Technical:** Pháº£i Ä‘Æ°á»£c viáº¿t báº±ng Python. Pháº£i hoáº¡t Ä‘á»™ng nhÆ° má»™t service stateless.
- **Compliance:** Pháº£i cÃ³ kháº£ nÄƒng phÃ¡t hiá»‡n vÃ  gáº¯n cá» cÃ¡c rá»§i ro vá» PII vÃ  injection.

### 2.6. Dependencies

- **Upstream:** Phá»¥ thuá»™c hoÃ n toÃ n vÃ o output `UnifiedInputCore` cá»§a **Stage 1**.
- **Downstream:** Cung cáº¥p input `TaskSpecV1` cho **Stage 3 (Router/Planner)**.
- **Internal:** Phá»¥ thuá»™c vÃ o má»™t service ná»™i bá»™ Ä‘á»ƒ gá»i SLM.

---

## 3. USER STORIES / USE CASES

### 3.1. Primary Actors

- **Downstream Services:** Chá»§ yáº¿u lÃ  Stage 3 (Router/Planner), nhÆ°ng cÅ©ng cÃ³ thá»ƒ lÃ  cÃ¡c há»‡ thá»‘ng giÃ¡m sÃ¡t hoáº·c phÃ¢n tÃ­ch.

### 3.2. User Stories

- **US-01 (Simple Summary):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` vá»›i `intent: summarize`, `scope: page`, `artifact: brief` **when** the user input is "tÃ³m táº¯t trang nÃ y".
  - **So that** I can route the task to a simple summarization agent.

- **US-02 (Complex Action):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` vá»›i `intent: act`, `artifact: compare`, vÃ  `entities` chá»©a `budget` vÃ  `preferences` **when** the user input is "tÃ¬m cho tÃ´i 3 laptop gaming dÆ°á»›i 40tr, Æ°u tiÃªn mÃ n hÃ¬nh Ä‘áº¹p vÃ  bÃ n phÃ­m tá»‘t".
  - **So that** I can create a research plan to find and compare laptops based on these constraints.

- **US-03 (Sensitive Action):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` vá»›i `action_level: Act-2`, `risk: high`, vÃ  `policy.requires_confirm: true` **when** the user input is "Ä‘áº·t vÃ© mÃ¡y bay Ä‘i Singapore vÃ o ngÃ y mai".
  - **So that** I can ensure the execution plan includes a confirmation step before performing the booking.

### 3.4. Edge Cases & Error Scenarios

- **Input mÆ¡ há»“:** "lÃ m gÃ¬ Ä‘Ã³ vá»›i cÃ¡i nÃ y Ä‘i" â†’ Rule Engine sáº½ cÃ³ `confidence` tháº¥p, kÃ­ch hoáº¡t SLM Ä‘á»ƒ cá»‘ gáº¯ng diá»…n giáº£i. `TaskSpecV1` cÃ³ thá»ƒ cÃ³ `missing_slots`.
- **Input chá»©a PII:** "tÃ³m táº¯t email cá»§a tÃ´i tá»« sáº¿p vá» dá»± Ã¡n X" â†’ `policy.pii_risk` sáº½ Ä‘Æ°á»£c Ä‘áº·t lÃ  `likely`.
- **Input cÃ³ dáº¥u hiá»‡u injection:** "tÃ³m táº¯t trang nÃ y vÃ  sau Ä‘Ã³ `DROP TABLE users;`" â†’ `policy.injection_risk` sáº½ lÃ  `true`.

---

## 4. API CONTRACT & INTERFACES

Module nÃ y hoáº¡t Ä‘á»™ng nhÆ° má»™t hÃ m xá»­ lÃ½ ná»™i bá»™, khÃ´ng pháº£i lÃ  má»™t public API. Giao diá»‡n chÃ­nh cá»§a nÃ³ lÃ  cÃ¡c Ä‘á»‘i tÆ°á»£ng dá»¯ liá»‡u Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra.

### 4.1. Function Signature

```python
async def process_stage2(input_envelope: UnifiedInputCore) -> QUOutputV1:
    # ... implementation ...
```

### 4.3. Data Models (Schemas)

*ÄÃ¢y lÃ  cÃ¡c cáº¥u trÃºc dá»¯ liá»‡u cá»‘t lÃµi, Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a báº±ng Pydantic Ä‘á»ƒ validate.* 

- **Input:** `UnifiedInputCore` (tá»« Stage 1)
- **Output:** `QUOutputV1`

```python
from pydantic import BaseModel, Field
from typing import Literal, List, Dict, Any

# (DÃ¡n cÃ¡c class Pydantic tÆ°Æ¡ng á»©ng vá»›i cÃ¡c type TypeScript trong tÃ i liá»‡u Stage 2)
# VÃ­ dá»¥:
class TaskSpecV1(BaseModel):
    spec_id: str
    version: Literal["v1"]
    input_id: str
    intent: Literal["summarize", "explain", "act"]
    scope: Literal["page", "multi_page", "web", "personal", "general"]
    artifact: Literal["brief", "answer", "compare", "plan", "extract"]
    action_level: Literal["Act-0", "Act-1", "Act-2"]
    risk: Literal["low", "medium", "high"]
    entities: Dict[str, Any] # EntityBag
    context: Dict[str, Any] # TaskContext
    policy: Dict[str, Any]  # PolicyHints
    _from_slm: bool = False
    _rule_confidence: float = 0.0

class QUOutputV1(BaseModel):
    input: Any # UnifiedInputCore
    task_spec: TaskSpecV1
    telemetry: Dict[str, Any]
```

---

## 6. SYSTEM ARCHITECTURE & FLOW

### 6.1. High-Level Architecture

Kiáº¿n trÃºc cá»§a Stage 2 lÃ  má»™t pipeline tuáº§n tá»± vá»›i má»™t Ä‘iá»ƒm ráº½ nhÃ¡nh.

```mermaid
graph TD
    A[Input: UnifiedInputCore] --> B{Rule Engine};
    B --> C{Confidence >= 0.85?};
    C -- Yes (Fast Path) --> D[Build TaskSpec from Rules];
    C -- No (Slow Path) --> E[Call QU_SLM];
    E --> F[Merge SLM results];
    D --> G{Policy Overrides};
    F --> G;
    G --> H[Output: QUOutputV1];
```

### 6.4. Sequence Diagrams

#### Fast Path

```mermaid
sequenceDiagram
    participant Orchestrator
    participant RuleEngine
    participant PolicyModule

    Orchestrator->>RuleEngine: runRuleEngine_ABCD(input)
    RuleEngine-->>Orchestrator: return ruleResult (confidence=0.9)
    Orchestrator->>Orchestrator: buildTaskSpecFromRule(ruleResult)
    Orchestrator->>PolicyModule: runPolicyOverrides(taskSpec)
    PolicyModule-->>Orchestrator: return finalTaskSpec
```

#### Slow Path

```mermaid
sequenceDiagram
    participant Orchestrator
    participant RuleEngine
    participant SLM_Service
    participant PolicyModule

    Orchestrator->>RuleEngine: runRuleEngine_ABCD(input)
    RuleEngine-->>Orchestrator: return ruleResult (confidence=0.6)
    Orchestrator->>SLM_Service: call_QU_SLM(input, ruleResult)
    SLM_Service-->>Orchestrator: return slmResult
    Orchestrator->>Orchestrator: buildTaskSpecFromSLM(slmResult)
    Orchestrator->>PolicyModule: runPolicyOverrides(taskSpec)
    PolicyModule-->>Orchestrator: return finalTaskSpec
```

---

## 7. IMPLEMENTATION DETAILS (Deep-Dive)

### 7.1. Processing Pipeline Overview

1.  **Rule Engine Execution:** LuÃ´n cháº¡y Ä‘áº§u tiÃªn. PhÃ¢n tÃ­ch input dá»±a trÃªn keywords vÃ  patterns Ä‘á»ƒ Ä‘Æ°a ra má»™t phá»ng Ä‘oÃ¡n ban Ä‘áº§u (`RuleEngineResult`) vÃ  má»™t Ä‘iá»ƒm `confidence`.
2.  **Path Selection:** Dá»±a vÃ o `confidence` score, quyáº¿t Ä‘á»‹nh Ä‘i theo "Fast Path" (chá»‰ dÃ¹ng káº¿t quáº£ cá»§a Rule Engine) hay "Slow Path" (gá»i thÃªm SLM).
3.  **TaskSpec Generation:**
    - **Fast Path:** Ãnh xáº¡ trá»±c tiáº¿p káº¿t quáº£ tá»« Rule Engine vÃ o cáº¥u trÃºc `TaskSpecV1`.
    - **Slow Path:** Gá»­i input gá»‘c vÃ  gá»£i Ã½ cá»§a Rule Engine Ä‘áº¿n SLM. Nháº­n káº¿t quáº£ cÃ³ cáº¥u trÃºc tá»« SLM vÃ  xÃ¢y dá»±ng `TaskSpecV1`.
4.  **Policy Overrides:** Ãp dá»¥ng má»™t lá»›p quy táº¯c an toÃ n cuá»‘i cÃ¹ng lÃªn `TaskSpecV1` Ä‘Ã£ Ä‘Æ°á»£c táº¡o Ä‘á»ƒ Ä‘áº£m báº£o cÃ¡c cá» chÃ­nh sÃ¡ch quan trá»ng (vÃ­ dá»¥: `requires_confirm`) Ä‘Æ°á»£c Ä‘áº·t Ä‘Ãºng.

### 7.2. Per-Module Specification

#### Module: Rule Engine

- **Responsibility:** PhÃ¢n tÃ­ch nhanh input, Ä‘Æ°a ra phá»ng Ä‘oÃ¡n ban Ä‘áº§u vá» Ã½ Ä‘á»‹nh vÃ  cÃ¡c thuá»™c tÃ­nh khÃ¡c.
- **Input:** `UnifiedInputCore`
- **Output:** `RuleEngineResult` (bao gá»“m `confidence` score)
- **Algorithm/Pseudocode:**
  ```python
  def run_rule_engine(text: str, context: PageContext) -> RuleEngineResult:
      # 1. PhÃ¢n tÃ­ch Intent
      intent, intent_score = classify_intent(text)

      # 2. PhÃ¢n tÃ­ch Facets (Scope, Artifact, ...)
      scope = classify_scope(text, context)
      # ... vÃ  cÃ¡c facets khÃ¡c

      # 3. TrÃ­ch xuáº¥t Entities cá»©ng
      budget = parse_budget(text)
      quantity = parse_quantity(text)

      # 4. TÃ­nh toÃ¡n Confidence Score
      # Dá»±a trÃªn Ä‘á»™ máº¡nh cá»§a cÃ¡c keyword khá»›p Ä‘Æ°á»£c
      # VÃ­ dá»¥: "tÃ³m táº¯t" -> score cao, "cho tÃ´i biáº¿t vá»" -> score tháº¥p
      confidence = calculate_confidence(intent_score, ...)

      return RuleEngineResult(..., confidence=confidence)
  ```

#### Module: SLM Caller (`call_QU_SLM`)

- **Responsibility:** Diá»…n giáº£i cÃ¡c yÃªu cáº§u phá»©c táº¡p hoáº·c mÆ¡ há»“ mÃ  Rule Engine khÃ´ng xá»­ lÃ½ Ä‘Æ°á»£c.
- **Input:** `UnifiedInputCore`, `RuleEngineResult` (dÃ¹ng lÃ m gá»£i Ã½)
- **Output:** Má»™t Ä‘á»‘i tÆ°á»£ng JSON cÃ³ cáº¥u trÃºc gáº§n giá»‘ng `TaskSpecV1`.
- **Algorithm/Pseudocode (Prompt Engineering):**
  ```
  SYSTEM_PROMPT = """
  You are an expert system for understanding user requests. Your task is to analyze the user's query and context, and fill in the values for a JSON object representing the task specification. The user's query is in Vietnamese.
  
  You must respond ONLY with a valid JSON object. The JSON object should have the following keys: "intent", "scope", "artifact", "action_level", "risk", and "entities".
  
  Here are the possible values for each key:
  - intent: "summarize", "explain", "act"
  - scope: "page", "multi_page", "web", "personal", "general"
  - ... (liá»‡t kÃª táº¥t cáº£ cÃ¡c giÃ¡ trá»‹ kháº£ dÄ©)
  """
  
  USER_PROMPT_TEMPLATE = """
  Here is the analysis from a preliminary rule-based system (these are suggestions, you can override them):
  {rule_engine_suggestions_json}
  
  Here is the user's full request context:
  User Query: "{user_query_text}"
  Page URL: {page_url}
  Page Title: {page_title}
  
  Now, provide the final JSON object.
  """
  ```

#### Module: Policy Overrides

- **Responsibility:** Äáº£m báº£o an toÃ n báº±ng cÃ¡ch Ã¡p Ä‘áº·t cÃ¡c quy táº¯c khÃ´ng thá»ƒ bá»‹ bá» qua.
- **Input:** `TaskSpecV1` (tá»« Rule Engine hoáº·c SLM), `UnifiedInputCore`
- **Output:** `TaskSpecV1` Ä‘Ã£ Ä‘Æ°á»£c chá»‰nh sá»­a `policy` vÃ  `risk`.
- **Algorithm/Pseudocode:**
  ```python
  def run_policy_overrides(task_spec: TaskSpecV1) -> TaskSpecV1:
      # Rule 1: Náº¿u lÃ  hÃ nh Ä‘á»™ng cáº¥p 2, luÃ´n yÃªu cáº§u xÃ¡c nháº­n
      if task_spec.action_level == "Act-2":
          task_spec.policy.requires_confirm = True
          task_spec.risk = "high"

      # Rule 2: Náº¿u cÃ³ rá»§i ro PII, nÃ¢ng má»©c Ä‘á»™ rá»§i ro
      if task_spec.policy.pii_risk == "likely":
          if task_spec.risk == "low": task_spec.risk = "medium"

      # Rule 3: Náº¿u cÃ³ rá»§i ro injection, Ä‘áº·t má»©c rá»§i ro cao nháº¥t vÃ  cháº·n hÃ nh Ä‘á»™ng
      if task_spec.policy.injection_risk:
          task_spec.risk = "high"
          task_spec.action_level = "Act-0" # VÃ´ hiá»‡u hÃ³a hÃ nh Ä‘á»™ng

      return task_spec
  ```

---

## 8. SECURITY & COMPLIANCE

- **PII Detection:** Rule Engine sáº½ tÃ¬m kiáº¿m cÃ¡c pattern cá»§a thÃ´ng tin nháº¡y cáº£m (email, SÄT, sá»‘ tháº» tÃ­n dá»¥ng) trong input thÃ´ Ä‘á»ƒ gáº¯n cá» `pii_risk`.
- **Injection Detection:** Rule Engine sáº½ tÃ¬m kiáº¿m cÃ¡c chuá»—i kÃ½ tá»± Ä‘Ã¡ng ngá» (SQL keywords, script tags) Ä‘á»ƒ gáº¯n cá» `injection_risk`. Module Policy Overrides sáº½ vÃ´ hiá»‡u hÃ³a hÃ nh Ä‘á»™ng náº¿u cá» nÃ y Ä‘Æ°á»£c báº­t.
- **Data Handling:** Module nÃ y khÃ´ng lÆ°u trá»¯ báº¥t ká»³ dá»¯ liá»‡u nÃ o cá»§a ngÆ°á»i dÃ¹ng. Má»i thÃ´ng tin chá»‰ Ä‘Æ°á»£c xá»­ lÃ½ trong bá»™ nhá»› vÃ  truyá»n cho Stage 3.

---

## 9. NON-FUNCTIONAL REQUIREMENTS (NFRs)

- **Latency:** NhÆ° Ä‘Ã£ nÃªu trong Success Criteria. Fast path pháº£i cá»±c nhanh Ä‘á»ƒ khÃ´ng áº£nh hÆ°á»Ÿng Ä‘áº¿n tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng.
- **Scalability:** Service pháº£i lÃ  stateless Ä‘á»ƒ cÃ³ thá»ƒ scale ngang dá»… dÃ ng. VÃ¬ cÃ³ SLM, cáº§n cÃ³ cÆ¡ cháº¿ quáº£n lÃ½ concurrency Ä‘á»ƒ khÃ´ng lÃ m quÃ¡ táº£i SLM service.
- **Accuracy:** CÃ¡c bá»™ quy táº¯c trong Rule Engine pháº£i Ä‘Æ°á»£c kiá»ƒm thá»­ ká»¹ lÆ°á»¡ng vá»›i má»™t bá»™ dá»¯ liá»‡u lá»›n Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»™ chÃ­nh xÃ¡c vÃ  giáº£m thiá»ƒu viá»‡c pháº£i gá»i SLM má»™t cÃ¡ch khÃ´ng cáº§n thiáº¿t.

---

## 12. TESTING STRATEGY

- **Unit Testing:**
  - Test tá»«ng hÃ m trong Rule Engine (vÃ­ dá»¥: `test_classify_intent`, `test_parse_budget`).
  - Test tá»«ng quy táº¯c trong Policy Overrides.
  - Mock lá»i gá»i Ä‘áº¿n SLM service.
- **Integration Testing:**
  - Test toÃ n bá»™ pipeline cá»§a Stage 2 vá»›i cÃ¡c input máº«u, kiá»ƒm tra `TaskSpecV1` output.
- **Golden File Testing:**
  - Chuáº©n bá»‹ má»™t file `test_cases.jsonl` chá»©a hÃ ng trÄƒm cáº·p `input` -> `expected_task_spec`.
  - Cháº¡y má»™t script Ä‘á»ƒ so sÃ¡nh output thá»±c táº¿ vá»›i output mong muá»‘n cho má»i test case. Viá»‡c nÃ y cá»±c ká»³ quan trá»ng Ä‘á»ƒ phÃ¡t hiá»‡n regression khi thay Ä‘á»•i logic cá»§a Rule Engine hoáº·c prompt cá»§a SLM.

---

## 14. TRADE-OFFS & ALTERNATIVES

- **Quyáº¿t Ä‘á»‹nh:** Sá»­ dá»¥ng kiáº¿n trÃºc `Rule-first, SLM-backup`.
- **Bá»‘i cáº£nh:** Cáº§n cÃ¢n báº±ng giá»¯a tá»‘c Ä‘á»™, chi phÃ­, vÃ  kháº£ nÄƒng xá»­ lÃ½ cÃ¡c yÃªu cáº§u phá»©c táº¡p.
- **Há»‡ quáº£:**
  - **TÃ­ch cá»±c:** Pháº§n lá»›n request Ä‘Æ°á»£c xá»­ lÃ½ ráº¥t nhanh vÃ  ráº». Há»‡ thá»‘ng cÃ³ kháº£ nÄƒng "graceful degradation" - khi SLM lá»—i, Rule Engine váº«n cÃ³ thá»ƒ xá»­ lÃ½ cÃ¡c case Ä‘Æ¡n giáº£n.
  - **TiÃªu cá»±c:** TÄƒng Ä‘á»™ phá»©c táº¡p cá»§a codebase (pháº£i duy trÃ¬ cáº£ hai luá»“ng logic). Cáº§n má»™t bá»™ test tá»‘t Ä‘á»ƒ Ä‘áº£m báº£o sá»± nháº¥t quÃ¡n giá»¯a hai luá»“ng.
- **PhÆ°Æ¡ng Ã¡n khÃ¡c Ä‘Ã£ cÃ¢n nháº¯c:**
  - **SLM-only:** Nhanh hÆ¡n LLM nhÆ°ng váº«n cháº­m vÃ  tá»‘n kÃ©m hÆ¡n Rule Engine. KhÃ³ Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n 100%.
  - **Rule-only:** ÄÆ¡n giáº£n nhÆ°ng yáº¿u, khÃ´ng thá»ƒ trá»Ÿ thÃ nh má»™t sáº£n pháº©m thÃ´ng minh thá»±c sá»±.
