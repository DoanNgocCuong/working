# Stage 3 & Stage 4 (Comet-like AI Browser) — Giải thích kỹ hơn, có walkthrough theo từng mode + ví dụ I/O + diagram

Tài liệu này **chỉ** mô tả **Stage 3 (Router/Planner)** và **Stage 4 (Unified Executor)** theo đúng pipeline bạn đã chốt.  
Mục tiêu: **human đọc hiểu**, team dev vẫn có đủ “xương sống” để build/run/test.

---

## Diagram (nguồn sự thật)

```text
+====================================================================================================+
|                 PIPELINE (STAGE 1–2 DÙNG CHUNG) → STAGE 3 RẼ NHÁNH THEO CHẾ ĐỘ THỰC THI            |
+====================================================================================================+

Đầu vào: Người dùng (text/voice) + Ngữ cảnh tab (URL/DOM/selection) + File đính kèm
    |
    v
+--------------------------------------+
| STAGE 1: Input hợp nhất              |
| - chuẩn hoá input + tạo ContextPack  |
+--------------------------------------+
    |
    v
+--------------------------------------+
| STAGE 2: Hiểu truy vấn (QueryUnderstanding) |
| - ý định / thực thể / ràng buộc      |
| - domain_hint + cờ rủi ro            |
| => TaskSpecV1                        |
+--------------------------------------+
    |
    v
+--------------------------------------+
| STAGE 3: Định tuyến / Lập kế hoạch   |
| - chọn CHẾ ĐỘ (A/B/C/D)              |
| - tạo ExecutionPlan (kế hoạch chạy): |
|   * sub_queries[] + vai trò (CHỈ khi có research) |
|   * act_plan[] (CHỈ khi có action)              |
|   * data_plan[]/compute_plan[] (khi cần)         |
|   * budget + policy gates + tiêu chí verify      |
| - QUAN TRỌNG: Stage 3 chỉ "lập kế hoạch",        |
|   chưa chạy retrieval/compute/action             |
+--------------------------------------+
    |
    +--------------------------------------------------------------------------------------------------+
    |                                                                                                  |
    |     (A) CHỈ NGHIÊN CỨU              (B) CHỈ HÀNH ĐỘNG             (C) NGHIÊN CỨU → HÀNH ĐỘNG      (D) HÀNH ĐỘNG → NGHIÊN CỨU
    |     (kiểu Perplexity)              (làm việc luôn)               (phổ biến nhất)                 (hiếm)
    |                                                                                                  |
    v                                                                                                  v

+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
| CHẾ ĐỘ A: CHỈ NGHIÊN CỨU      |   | CHẾ ĐỘ B: CHỈ HÀNH ĐỘNG        |   | CHẾ ĐỘ C: NGHIÊN CỨU → HÀNH ĐỘNG  |   | CHẾ ĐỘ D: HÀNH ĐỘNG → NGHIÊN CỨU  |
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
| STAGE 4: EXECUTOR (chạy theo ExecutionPlan; Stage 4 gồm 4 "loại bước" 4.1/4.2/4.3/4.4)                                              |
|                                                                                                                                         |
| 4.1 TRUY XUẤT BẰNG CHỨNG      | 4.1 TRUY XUẤT BẰNG CHỨNG           | 4.1 TRUY XUẤT BẰNG CHỨNG           | 4.1 TRUY XUẤT BẰNG CHỨNG
| (Retrieve)                    | (Retrieve)                         | (Retrieve)                           | (Retrieve)
| (1) BẬT (bắt buộc)            | (1) TẮT (mặc định)                  | (1) BẬT (bắt buộc, chạy TRƯỚC)       | (1) BẬT (tuỳ chọn, chạy SAU)
| - multi-query → hybrid         | - chỉ bật nếu cần "hướng dẫn thao tác" | - multi-query → hybrid               | - dùng để giải thích/đối chiếu
|   (BM25 + Vector)              |   hoặc cần kiểm chứng nguồn         |   (BM25 + Vector)                    |   sau khi đã thao tác
| - gộp/loại trùng → rerank       |                                     | - gộp/loại trùng → rerank evidence   | - có thể sinh sub_queries nếu cần
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
            |                               |                               |                               |
            v                               v                               v                               v
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
| 4.2 LẤY DỮ LIỆU CẤU TRÚC      |   | 4.2 LẤY DỮ LIỆU CẤU TRÚC      |   | 4.2 LẤY DỮ LIỆU CẤU TRÚC          |   | 4.2 LẤY DỮ LIỆU CẤU TRÚC
| (Fetch_Data) (2) tuỳ chọn     |   | (Fetch_Data) (2) tuỳ chọn     |   | (Fetch_Data) (2) tuỳ chọn          |   | (Fetch_Data) (2) tuỳ chọn
| - gọi API/filings/DB nội bộ   |   | - lấy dữ liệu để điền form    |   | - finance: giá/FS/macro, filings   |   | - đọc state/receipt → dữ liệu
| - finance: giá/FS/macro...    |   |   hoặc đối chiếu nhanh         |   | - các domain khác: data adapters   |   |   có cấu trúc để phân tích
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
            |                               |                               |                               |
            v                               v                               v                               v
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
| 4.3 TÍNH TOÁN/BIẾN ĐỔI        |   | 4.3 TÍNH TOÁN/BIẾN ĐỔI        |   | 4.3 TÍNH TOÁN/BIẾN ĐỔI             |   | 4.3 TÍNH TOÁN/BIẾN ĐỔI
| (Compute) (3) tuỳ chọn        |   | (Compute) (3) tuỳ chọn        |   | (Compute) (3) tuỳ chọn             |   | (Compute) (3) tuỳ chọn
| - metrics/định giá/transform  |   | - transform payload/điều kiện  |   | - finance: metrics/DCF/RI, risk     |   | - chuyển state→số liệu→tính toán
| - KHÔNG thao tác UI           |   |   để thực hiện action          |   | - chuẩn hoá kết quả để action        |   | - tạo phần "giải thích" hậu kiểm
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
            |                               |                               |                               |
            v                               v                               v                               v
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
| 4.4 THAO TÁC (Act)            |   | 4.4 THAO TÁC (Act)            |   | 4.4 THAO TÁC (Act)                 |   | 4.4 THAO TÁC (Act)
| (4) TẮT (bắt buộc)            |   | (4) BẬT (bắt buộc)            |   | (4) BẬT (bắt buộc, chạy SAU)        |   | (4) BẬT (bắt buộc, chạy TRƯỚC)
| - không click/submit           |   | - web/app automation          |   | - dùng kết quả research/compute      |   | - thao tác để lấy state/receipt
| - chỉ “đọc & tổng hợp”         |   |   click/type/submit/...       |   |   để click/type/submit/...           |   | - checkpoint + xin phép/policy
|                                |   | - checkpoint + xin phép/policy|   | - checkpoint + xin phép/policy       |   | - capture screenshot/DOM/receipt
+-------------------------------+   +-------------------------------+   +----------------------------------+   +----------------------------------+
```

---

## Từ điển nhanh (để mọi người nói cùng “ngôn ngữ”)
- **TaskSpecV1**: “đề bài đã hiểu” (user muốn gì, entities, constraints, risk).
- **ExecutionPlan**: “kịch bản chạy” (mode, các bước 4.1–4.4, budget, checkpoint).
- **EvidenceItem**: “mảnh bằng chứng” (URL, snippet, thời điểm lấy, độ tin cậy).
- **Receipt**: “biên lai hành động” (đã click/type gì, screenshot nào, state cuối).
- **Policy Gate**: “điểm xin phép” trước bước nhạy cảm (login/submit/payment...).

---

# STAGE 3 — Router/Planner (Giải thích kỹ)

## 1) Mục tiêu & chức năng
Stage 3 trả lời 3 câu hỏi sống còn:
1) **Chạy theo mode nào?** (A/B/C/D)  
2) **Cụ thể sẽ chạy những bước gì?** (bật/tắt 4.1–4.4, thứ tự)  
3) **Chạy đến mức nào là đủ & có an toàn không?** (budget + policy gates + verify criteria)

> Nói thẳng: Stage 3 là chỗ “ăn tiền” vì nó quyết định **đúng hướng / sai hướng**, **tốn ít / tốn nhiều**, và **an toàn / nguy hiểm**.

## 2) Các bước trong Stage 3 (mục tiêu & kết quả)

### 2.1 Thu tín hiệu để chọn mode (Signal extraction)
**Mục tiêu**: đọc TaskSpecV1 để lấy “tín hiệu” rõ ràng.  
**Kết quả**: `signals{}` như: `needs_research`, `needs_action`, `needs_state_first`, `risk_level`.

Ví dụ tín hiệu:
- “so sánh/tổng hợp/có nguồn” → `needs_research=true`
- “mở/điền/submit” → `needs_action=true`
- “xem gói hiện tại/tài khoản đang dùng gì” → `needs_state_first=true`
- login/payment/PII/investment → `risk_level=high`

### 2.2 Chọn mode (A/B/C/D)
**Mục tiêu**: chọn 1 mode “đúng bản chất”.  
**Kết quả**: `mode` + `reason_codes[]` (để explain/debug).

Default MVP nên là:
- Nếu vừa research vừa action → **Mode C**
- Nếu chỉ cần trả lời có nguồn → **Mode A**
- Nếu user nói “làm luôn, không cần tìm hiểu” → **Mode B**
- Nếu phải vào UI mới biết trạng thái → **Mode D**

### 2.3 Dựng ExecutionPlan (skeleton + details)
**Mục tiêu**: biến mode thành danh sách step đúng thứ tự, kèm config.  
**Kết quả**: `steps[]` + `sub_queries[]` (nếu có) + `act` blueprint (nếu có).

- Với **research**: chuẩn bị `sub_queries[]` có “vai trò” (official/news/data/background).
- Với **action**: chuẩn bị `act_plan` (open → locate → fill → verify → stop/submit).

### 2.4 Cắm budget + policy gates + verify criteria
**Mục tiêu**: giới hạn và kiểm soát rủi ro.  
**Kết quả**: `budget`, `policy_gates`, `verify_criteria`.

- Budget: giới hạn số query, số nguồn, thời gian, số tool calls.
- Gate: trước login/submit/payment/delete… **bắt buộc xin phép**.
- Verify criteria: cần citations không? cần receipt không? cần freshness không?

## 3) Ví dụ input/output (Stage 3)

### S3-C (Mode C) — đề bài “research + action” (walkthrough ngắn)
**Input (TaskSpecV1 + ContextPack)**

```json
{
  "task": {
    "task_id": "tsk_S3C_001",
    "user_query": "Nghiên cứu gói datafeed Vietstock phù hợp cho FinAI rồi mở trang đăng ký điền sẵn form (đừng submit).",
    "intent": "research_then_action",
    "domain_hint": "finance",
    "constraints": {"must_have_citations": true, "no_submit": true, "language": "vi"},
    "risk_flags": ["external_side_effect"]
  },
  "context": {
    "context_id": "ctx_S3C_001",
    "active_tab": {"url": "https://dichvu.vietstock.vn/du-lieu-tai-chinh/datafeed---du-lieu-tai-chinh-tich-hop-chuyen-nghiep"},
    "selection_text": ""
  }
}
```

**Stage 3 reasoning (tại sao chọn Mode C)**
- Có “nghiên cứu” → cần **Retrieve**
- Có “mở trang/điền form” → cần **Act**
- Có “đừng submit” → rủi ro thấp hơn submit, nhưng vẫn cần **policy gate trước Act**
→ Chọn **Mode C (Research → Action)**

**Output (ExecutionPlan C)**

```json
{
  "plan_id": "plan_S3C_001",
  "mode": "C",
  "sub_queries": [
    {"q":"Vietstock datafeed điều khoản sử dụng cho sản phẩm thương mại/SaaS","role":"official"},
    {"q":"Vietstock datafeed pricing packages bảng giá gói dữ liệu","role":"data"},
    {"q":"Vietstock datafeed terms commercial use licensing","role":"official"}
  ],
  "steps": [
    {"step_id":"stp_r1","type":"RETRIEVE","name":"Retrieve evidence","config":{"top_k":8}},
    {"step_id":"stp_f1","type":"FETCH_DATA","name":"Parse packages table","depends_on":["stp_r1"],"optional":true},
    {"step_id":"stp_c1","type":"COMPUTE","name":"Score & recommend package","depends_on":["stp_r1","stp_f1"],"optional":true},
    {"step_id":"stp_a1","type":"ACT","name":"Prefill signup form (no submit)","depends_on":["stp_c1"],"policy_gate_id":"gate_prefill"}
  ],
  "policy_gates": [
    {
      "gate_id":"gate_prefill",
      "requires_user_confirm":true,
      "reason":"Sắp thao tác điền form theo gói đã recommend (không submit). Xác nhận trước.",
      "blocked_actions":["submit","purchase","delete"]
    }
  ],
  "budget": {"max_time_ms": 60000, "max_tool_calls": 18},
  "verify_criteria": {"require_citations": true, "ui_receipt_required": true},
  "reason_codes": ["MODE_C:research_then_action","HAS_ACTION_VERBS","NO_SUBMIT_ENFORCED"]
}
```

---

# STAGE 4 — Unified Executor (Giải thích kỹ + walkthrough theo mode)

## 1) Mục tiêu & chức năng
Stage 4 nhận `ExecutionPlan` và chạy “từng bước một”:
- Thực thi `steps[]` theo thứ tự (deterministic).
- Mỗi step sinh ra `StepResult` (status + outputs + warnings).
- Nếu có Act: luôn sinh **Receipt + StateSnapshot**.
- Nếu gặp policy gate: trả về **NEED_CONFIRMATION** và dừng (để user duyệt).

## 2) 4 “viên gạch” (4.1–4.4) — giải thích bằng ngôn ngữ đời thường

### 4.1 Retrieve — “đi tìm bằng chứng”
- Giống như: bạn mở 5–10 tab, đọc nhanh, chép lại đoạn quan trọng.
- Output: danh sách EvidenceItem (URL + snippet + timestamp + confidence).

### 4.2 Fetch_Data — “bốc dữ liệu thành bảng”
- Giống như: bạn copy bảng giá/bảng gói, chuẩn hóa thành JSON/table.
- Output: data_ref (để Compute dùng).

### 4.3 Compute — “nghĩ & tính” (nhưng không đụng UI)
- Giống như: bạn chấm điểm, xếp hạng, hoặc chuẩn bị payload để điền form.
- Output: artifacts_ref (vd: recommendation, payload).

### 4.4 Act — “làm việc trên web/app”
- Giống như: bạn mở đúng trang, click đúng chỗ, gõ đúng ô.
- Khác biệt quan trọng: Act phải **có checkpoint xin phép** và **biên lai (receipt)**.

---

## 3) Walkthrough theo từng mode (mỗi mode có pipeline + ví dụ + giải thích)

> Lưu ý: Stage 5/6 không nằm trong doc này, nhưng mình vẫn nhắc “hook” ở cuối mỗi walkthrough
> để mọi người hình dung đoạn verify/synthesis sẽ dựa vào evidence/receipt như thế nào.

---

## Mode C — NGHIÊN CỨU → HÀNH ĐỘNG (trường hợp “đúng” với query bạn đưa)

### Pipeline (Mode C)
```text
RETRIEVE  →  FETCH_DATA  →  COMPUTE  →  ACT
```

### Vì sao Stage 3 chọn Mode C?
- User vừa nói “nghiên cứu gói phù hợp” (cần hiểu & có nguồn)
- Vừa nói “mở trang đăng ký và điền sẵn form” (cần thao tác)
→ “nghĩ cho đúng rồi mới làm” = Mode C.

### STAGE 4 (Mode C) — đi từng bước như người thật làm

#### 4.1 Retrieve — Bắt đầu bằng research
**Mục tiêu**: gom đủ bằng chứng về *gói*, *phạm vi dữ liệu*, *điều khoản sử dụng/bản quyền*.

**Sinh sub_queries kiểu (ví dụ)**:
- “Vietstock datafeed bản quyền sử dụng cho sản phẩm SaaS”
- “Vietstock datafeed điều khoản thương mại / commercial use”
- “Vietstock datafeed pricing packages bảng giá”

**Chạy hybrid search** (BM25 + vector) để:
- gom trang pricing
- gom docs product / terms
- gom các đoạn nêu rõ điều khoản

**Rerank + lọc** để giữ lại đoạn nói về:
- tên gói, phạm vi dữ liệu (HOSE/HNX/…)
- giới hạn sử dụng (internal use vs commercial)
- điều khoản khai thác / redistribution / caching

**Output**: EvidenceItem[] (có nguồn + timestamp).

#### 4.2 Fetch_Data — Lấy dữ liệu có cấu trúc
**Mục tiêu**: biến “thông tin rải rác” thành “bảng rõ ràng” để chấm điểm.

**Làm gì cụ thể**:
- Parse bảng gói/giá trên site (hoặc gọi API nếu có)
- Chuẩn hóa về dạng table/JSON: `package_name`, `price`, `coverage`, `history_depth`, `rate_limit`, `license_notes`…

**Có thể áp constraint** (nếu có):
- ngân sách tối đa
- chỉ cần HOSE/HNX
- chỉ cần EOD hay cần intraday

**Output**: data_ref trỏ tới bảng packages.

#### 4.3 Compute — Chấm điểm / chọn gói
**Mục tiêu**: chọn “gói phù hợp nhất” dựa trên rule/score.

**Ví dụ rule-based scoring**:
- Coverage score: HOSE/HNX/UPCoM?
- Legal score: cho phép dùng thương mại? điều khoản rõ?
- Cost score: phù hợp budget?
- Operational score: rate limit, SLA, dữ liệu lịch sử bao sâu?

**Kết quả**:
- “Gói X phù hợp nhất, Y là phương án 2”
- Tạo payload điền form: gói X + thông tin công ty.

**Output**: artifacts_ref (recommendation + payload).

#### 4.4 Act — Thao tác trên web (điền form, KHÔNG submit)
**Mục tiêu**: làm hộ user phần “điền sẵn”, nhưng dừng trước hành động gây side-effect.

**Flow thao tác**:
- Mở trang đăng ký Vietstock
- Chọn gói X (từ Compute)
- Điền: tên công ty, email, thông tin cơ bản
- Dừng trước nút Submit (theo constraint `no_submit=true`)

**Bắt buộc**:
- Có **policy gate** trước khi bắt đầu điền (user confirm)
- Lưu **receipt**: action log + screenshot + state snapshot (URL/DOM hash…)

**Output**: Receipt + StateSnapshot (để Stage 5 verify “điền đúng gói chưa”).

### Ví dụ input/output (Mode C run)

**Input (ExecutionPlan C)**

```json
{
  "plan_id":"plan_C_001",
  "mode":"C",
  "steps":[
    {"step_id":"stp_r1","type":"RETRIEVE","name":"Retrieve evidence"},
    {"step_id":"stp_f1","type":"FETCH_DATA","name":"Parse packages","depends_on":["stp_r1"]},
    {"step_id":"stp_c1","type":"COMPUTE","name":"Recommend best package","depends_on":["stp_r1","stp_f1"]},
    {"step_id":"stp_a1","type":"ACT","name":"Prefill signup (no submit)","depends_on":["stp_c1"],"policy_gate_id":"gate_prefill"}
  ],
  "policy_gates":[
    {"gate_id":"gate_prefill","requires_user_confirm":true,"reason":"Sắp điền form theo gói đã recommend (không submit).","blocked_actions":["submit"]}
  ]
}
```

**Output (ExecutorRun C — minh hoạ)**

```json
{
  "run_id":"run_C_001",
  "trace_id":"trace_C_001",
  "final_status":"SUCCEEDED",
  "step_results":[
    {"step_id":"stp_r1","status":"SUCCEEDED","outputs":{"evidence":[{"source_url":"https://dichvu.vietstock.vn/...","snippet":"...điều khoản...","retrieved_at":"2025-12-10T11:10:00Z"}]}},
    {"step_id":"stp_f1","status":"SUCCEEDED","outputs":{"data_ref":"data_packages_v1"}},
    {"step_id":"stp_c1","status":"SUCCEEDED","outputs":{"artifacts_ref":["art_reco_v1","art_prefill_payload_v1"]}},
    {"step_id":"stp_a1","status":"SUCCEEDED","outputs":{"receipt":{"receipt_id":"rcpt_C","checkpoints":[{"gate_id":"gate_prefill","status":"approved"}],"actions":[{"action":"navigate","result":"ok"},{"action":"type","target":"input[email]","value":"[REDACTED]","result":"ok"}],"final_state":{"url":"https://.../signup","screenshot_ref":"ss_C_001"}}}}
  ]
}
```

**Hook sang Stage 5 (để human hiểu bước tiếp theo sẽ làm gì)**
- Verify: form đã chọn đúng gói X? đã điền đủ field chưa?
- Synthesis: “recommend gói X, vì A/B/C, kèm citations, và đây là preview/receipt”.

---

## Mode A — CHỈ NGHIÊN CỨU (Perplexity-like)

### Pipeline (Mode A)
```text
RETRIEVE  →  (FETCH_DATA?)  →  (COMPUTE?)  →  STOP
(no ACT)
```

### Khi nào hệ thống chọn Mode A?
- User chỉ cần “giải thích/so sánh/tổng hợp có nguồn”.
- Hoặc policy không cho tự động thao tác (đặc biệt khi dính login/PII).

### Stage 4 chạy ra sao?
- 4.1 Retrieve để lấy citations/evidence
- (tuỳ) 4.2 Fetch_Data để bóc bảng/giá thành dữ liệu sạch
- (tuỳ) 4.3 Compute để tổng hợp, chấm điểm, viết kết luận
- 4.4 Act **tắt**, thay bằng “hướng dẫn thao tác” ở output

### Ví dụ output mong muốn (ngôn ngữ người dùng)
- “Nên chọn gói X vì …, đây là nguồn …, và đây là hướng dẫn 5 bước để bạn tự điền form”.

---

## Mode B — CHỈ HÀNH ĐỘNG (làm việc luôn, ít research)

### Pipeline (Mode B)
```text
(FETCH_DATA?)  →  (COMPUTE?)  →  ACT  →  STOP
(RETRIEVE off by default)
```

### Khi nào hệ thống chọn Mode B?
- User nói “đã biết làm gì rồi, chỉ làm hộ thao tác”, ví dụ:
  - “Vào link này, điền form theo template này, đừng submit.”
- Hoặc workflow lặp lại (repeatable), không cần đào sâu nữa.

### Stage 4 chạy ra sao?
- 4.2 Fetch_Data lấy template dữ liệu (company profile) nếu cần
- 4.3 Compute chỉ để transform payload (vd: format số điện thoại, email)
- 4.4 Act là lõi: open → locate → type → stop
- 4.1 Retrieve thường tắt để tiết kiệm thời gian/cost

### Hook sang Stage 5
- Verify: đã điền đúng chưa, state/screenshot ok không?
- Synthesis: tóm tắt + receipts.

---

## Mode D — HÀNH ĐỘNG → NGHIÊN CỨU (hậu kiểm / giải thích state)

### Pipeline (Mode D)
```text
ACT  →  (RETRIEVE?)  →  (FETCH_DATA?)  →  (COMPUTE?)
```

### Khi nào hệ thống chọn Mode D?
- User hỏi: “đang ở đâu/đang dùng gói gì/đang bật setting nào?”
- Muốn hệ thống “vào xem” trước rồi mới giải thích/so sánh.

### Stage 4 chạy ra sao?
- 4.4 Act chạy trước để lấy state: vào account/subscription, đọc current plan
- 4.1 Retrieve chạy sau để tìm docs công khai giải thích gói đó
- 4.3 Compute để so sánh & đưa khuyến nghị

### Hook sang Stage 5
- Verify: state đọc từ UI có khớp docs công khai không?
- Synthesis: “hiện tại bạn đang dùng gói X, có các đặc điểm…, so với gói Y/Z…”.

---

## Checklist nhanh (đúng logic theo diagram)
- Mode A: **không Act**
- Mode B: **Act là lõi**, Retrieve mặc định tắt
- Mode C: **Retrieve trước, Act sau**
- Mode D: **Act trước**, rồi mới Retrieve/Compute

---

## Phần dành cho dev (ngắn gọn, đủ để align)
- Stage 3 (`/plan`) **không side-effect**: chỉ tạo plan + reason_codes.
- Stage 4 (`/execute`) có thể trả:
  - `SUCCEEDED`
  - `FAILED`
  - `NEED_CONFIRMATION` (khi gặp policy gate)
- Bất kỳ Act step nào cũng phải sinh **Receipt + StateSnapshot** (audit-ready).
