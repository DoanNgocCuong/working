## 6. IMPLEMENTATION DETAILS

## 6.1. Rule Engine (ABCD) - Core Module

**Module Overview**​

Rule Engine là trái tim của Stage 2, chạy cho **mọi** request để:

- Đoán nhanh 4 lớp A/B/C/D
    
- Trả ra `confidence` để quyết định Fast vs Slow path
    

**RuleEngineResult Schema**​

typescript

`type RuleEngineResult = {   intent: IntentKernel;  scope: Scope;  artifact: Artifact;  action_level: ActionLevel;  risk: RiskLevel;  entities_hard: Partial<EntityBag>;  policy_base: Partial<PolicyHints>;  confidence: number; // 0-1 };`

**Implementation (Pseudo-code)**​

python

`def run_rule_engine_ABCD(envelope: UnifiedInputCore) -> RuleEngineResult:     text = envelope.query.text_normalized.lower()    urls = envelope.query.urls_in_text or []    pc = envelope.page_context or {}    sf = envelope.safety_flags or {}         # --- A) Intent ---    intent = "explain"  # default    intent_score = 0.3         if re.search(r'tóm tắt|summary|summarize|tl;dr', text):        intent = "summarize"        intent_score = 0.95    elif re.search(r'giải thích|tại sao|vì sao|why|how|khác gì|difference', text):        intent = "explain"        intent_score = 0.9    elif re.search(r'chọn|so sánh|lên plan|đặt vé|điền form|mua giúp|đặt hàng|book', text):        intent = "act"        intent_score = 0.9         # --- B1) Scope ---    scope = "general"  # default         if re.search(r'bài này|trang này|this page|current tab', text) and pc.get('active_url'):        scope = "page"    elif len(urls) > 1:        scope = "multi_page"    elif len(urls) == 1 and not pc.get('active_url'):        scope = "multi_page"    elif re.search(r'email|gmail|calendar|lịch|drive|tệp cá nhân', text):        scope = "personal"    elif re.search(r'trên mạng|web|search|tìm giúp', text):        scope = "web"         # --- B2) Artifact ---    artifact = "answer"  # default         if intent == "summarize":        artifact = "brief"    elif intent == "explain":        artifact = "answer"    elif intent == "act":        if re.search(r'so sánh|shortlist|chọn', text):            artifact = "compare"        elif re.search(r'lên plan|lịch trình|itinerary|checklist', text):            artifact = "plan"        elif re.search(r'trích|extract|liệt kê|bảng|table', text):            artifact = "extract"         # --- B3) Action level ---    action_level = "Act-0"  # default         if re.search(r'soạn nháp|draft|nháp', text):        action_level = "Act-1"    if re.search(r'gửi|send|submit|thanh toán|đặt vé|book|checkout', text):        action_level = "Act-2"         # --- B4) Risk (preliminary) ---    risk = "low"  # default         if scope == "personal" or sf.get('raw_input_too_long'):        risk = "medium"    if action_level == "Act-2":        risk = "high"         # --- C) Entities-hard ---    entities_hard = {}    entities_hard['budget'] = parse_budget(text)      # "20tr", "<500k", "18-22tr"    entities_hard['quantity'] = parse_quantity(text)  # "chọn 2", "gợi ý 3"    entities_hard['time'] = parse_time_constraints(text)    entities_hard['travel'] = parse_travel(text)         # --- D) Policy-base ---    policy_base = {}         # PII risk    if re.search(r'\b\d{16}\b', text) or re.search(r'otp|one-time password|mã xác thực', text):        policy_base['pii_risk'] = "likely"    elif re.search(r'số tài khoản|số thẻ|mật khẩu|password|pin', text):        policy_base['pii_risk'] = "possible"    else:        policy_base['pii_risk'] = "none"         # Injection risk    policy_base['injection_risk'] = bool(        re.search(r'ignore previous instructions|bỏ qua mọi hướng dẫn trước đó|bỏ hết rule', text)    )         # --- Confidence (heuristic) ---    confidence = min(1.0,        0.4 * intent_score +        0.2 * (1 if entities_hard.get('budget') else 0.5) +        0.2 * (1 if entities_hard.get('time') else 0.5) +        0.2 * (1 if scope != "general" else 0.5)    )         return RuleEngineResult(        intent=intent,        scope=scope,        artifact=artifact,        action_level=action_level,        risk=risk,        entities_hard=entities_hard,        policy_base=policy_base,        confidence=confidence    )`

**Entity Parsing Functions (examples)**​

python

`def parse_budget(text: str) -> Optional[MoneyConstraint]:     """    Parse budget expressions:    - "20tr" → 20,000,000 VND    - "<500k" → 500,000 VND (max)    - "18-22tr" → 18,000,000-22,000,000 VND (range)    """    # Regex pattern for Vietnamese money format    pattern = r'([<>~]?)(\d+(?:\.\d+)?)(tr|k|triệu|nghìn|m|b)'    match = re.search(pattern, text.lower())         if not match:        return None         operator, value, unit = match.groups()    amount = float(value)         # Convert to VND    if unit in ['tr', 'triệu']:        amount *= 1_000_000    elif unit in ['k', 'nghìn']:        amount *= 1_000    elif unit == 'm':  # million USD        amount *= 1_000_000    elif unit == 'b':  # billion USD        amount *= 1_000_000_000         return {        "amount": int(amount),        "currency": "VND",        "original_text": match.group(0)    } def parse_quantity(text: str) -> Optional[QuantityConstraint]:     """    Parse quantity expressions:    - "chọn 2" → shortlist: 2    - "gợi ý 3" → shortlist: 3    - "so sánh tối đa 5" → compare_pool: 5    """    result = {}         # Shortlist    match = re.search(r'(chọn|gợi ý|suggest)\s+(\d+)', text.lower())    if match:        result['shortlist'] = int(match.group(2))         # Compare pool    match = re.search(r'(so sánh|compare)\s+(tối đa|max|up to)\s+(\d+)', text.lower())    if match:        result['compare_pool'] = int(match.group(3))         return result if result else None def parse_time_constraints(text: str) -> Optional[TimeConstraint]:     """Parse date expressions."""    # Implementation similar to parse_budget    # Handle: "ngày 15/12", "từ 20-25/12", "tháng sau"    pass def parse_travel(text: str) -> Optional[TravelConstraint]:     """Parse travel expressions."""    # Implementation similar to parse_budget    # Handle: "từ Hà Nội đi Sài Gòn", "bay từ HAN sang SGN"    pass`

## 6.2. SLM Module (Slow Path)

**Purpose:** Refine intent + entities khi Rule Engine không tự tin​

**call_QU_SLM Implementation**​

python

`async def call_QU_SLM(     envelope: UnifiedInputCore,    rule_result: RuleEngineResult ) -> TaskSpecV1:     """    Call Small Language Model for joint A+B+C refinement.         Input:    - envelope: Original UnifiedInputCore    - rule_result: Rule Engine's best guess (for context)         Output:    - TaskSpecV1 with refined intent/entities    """    # Build prompt    prompt = build_prompt_for_QU_SLM(envelope, rule_result)         # Call SLM (example: Ollama/FastEmbed/Claude-Haiku)    raw_response = await call_small_model(prompt)         # Parse JSON response    parsed = safe_json_parse(raw_response)         # Build TaskSpecV1    task_spec = TaskSpecV1(        spec_id=str(uuid.uuid4()),        version="v1",        input_id=envelope.input_id,                 intent=parsed['intent'],        scope=parsed['scope'],        artifact=parsed['artifact'],        action_level=parsed['action_level'],        risk=parsed['risk'],                 entities=parsed['entities'],        context=TaskContext(            language=envelope.query.detected_lang,            normalized_text=envelope.query.text_normalized,            urls_in_text=envelope.query.urls_in_text or [],            page_context=envelope.page_context        ),        policy=parsed.get('policy', {            "pii_risk": "none",            "injection_risk": False,            "has_sensitive_action": False,            "requires_confirm": False,            "missing_slots": []        }),                 _from_slm=True,        _rule_confidence=rule_result.confidence    )         return task_spec def build_prompt_for_QU_SLM(     envelope: UnifiedInputCore,    rule_result: RuleEngineResult ) -> str:     """    Build structured prompt for SLM.         Prompt structure:    1. System role    2. Input context (text, page_context, detected_lang)    3. Rule Engine guess (as hint)    4. Output schema requirements    """    prompt = f"""You are a query understanding agent for a financial AI assistant. INPUT: - User query: {envelope.query.text_normalized} - Detected language: {envelope.query.detected_lang} - URLs in text: {envelope.query.urls_in_text} - Page context: {envelope.page_context} RULE ENGINE GUESS (as hint): - Intent: {rule_result.intent} - Scope: {rule_result.scope} - Entities: {rule_result.entities_hard} - Confidence: {rule_result.confidence} YOUR TASK: Refine the intent, scope, artifact, action_level, risk, and extract ALL entities. OUTPUT FORMAT (JSON): {{   "intent": "summarize|explain|act",  "scope": "page|multi_page|web|personal|general",  "artifact": "brief|answer|compare|plan|extract",  "action_level": "Act-0|Act-1|Act-2",  "risk": "low|medium|high",  "entities": {{    "budget": {{"amount": <number>, "currency": "<string>", "original_text": "<string>"}},    "time": {{"date_from": "<YYYY-MM-DD>", "date_to": "<YYYY-MM-DD>"}},    "quantity": {{"shortlist": <number>, "compare_pool": <number>}},    "preferences": ["<string>", ...],    ...  }},  "policy": {{    "pii_risk": "none|possible|likely",    "injection_risk": <boolean>,    "has_sensitive_action": <boolean>,    "requires_confirm": <boolean>,    "missing_slots": ["<string>", ...]  }} }} RESPOND WITH ONLY THE JSON, NO EXPLANATIONS. """     return prompt`

## 6.3. Policy Overrides (Stage D Final)

**Purpose:** Enforce invariants an toàn bất kể fast/slow path​

python

`def run_policy_overrides(     envelope: UnifiedInputCore,    task_spec: TaskSpecV1,    rule_result: Optional[RuleEngineResult] = None ) -> PolicyHints:     """    Final policy enforcement:    1. PII risk (max priority)    2. Injection risk    3. Sensitive action detection    4. Requires confirm logic    5. Missing slots detection    """    text = envelope.query.text_normalized.lower()    base_policy = task_spec.policy or {}         # 1) PII risk (max)    pii_risk = base_policy.get('pii_risk', 'none')    if re.search(r'\b\d{16}\b', text) or re.search(r'otp|one-time password|mã xác thực', text):        pii_risk = "likely"    elif re.search(r'số tài khoản|số thẻ|mật khẩu|password|pin', text):        pii_risk = max(pii_risk, "possible", key=lambda x: ["none", "possible", "likely"].index(x))         # 2) Injection risk    injection_risk = base_policy.get('injection_risk', False) or bool(        re.search(r'ignore previous instructions|bỏ qua mọi hướng dẫn trước đó|bỏ hết rule', text)    )         # 3) Sensitive action    has_sensitive_action = (        base_policy.get('has_sensitive_action', False) or        task_spec.action_level == "Act-2" or        bool(re.search(r'thanh toán|chuyển khoản|transfer|payment|checkout|đặt vé|book', text))    )         # 4) Requires confirm    requires_confirm = (        base_policy.get('requires_confirm', False) or        has_sensitive_action or        pii_risk != "none"    )         # 5) Missing slots    missing_slots = list(base_policy.get('missing_slots', []))         if task_spec.intent == "act":        # Check travel missing date        if task_spec.entities.get('travel') and not task_spec.entities['travel'].get('date'):            missing_slots.append("travel.date")                 # Check budget missing for purchase        if not task_spec.entities.get('budget') and re.search(r'laptop|điện thoại|phone|pc|màn hình', text):            missing_slots.append("budget")         return PolicyHints(        pii_risk=pii_risk,        injection_risk=injection_risk,        has_sensitive_action=has_sensitive_action,        requires_confirm=requires_confirm,        missing_slots=list(set(missing_slots))  # deduplicate    )`