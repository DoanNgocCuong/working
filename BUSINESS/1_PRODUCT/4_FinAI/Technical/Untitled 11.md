# SOFTWARE DESIGN DOCUMENT (SDD) - finAI FINANCE AGENT WEB BROWSER

**Production Quality Standard | Version 5.0 ULTIMATE**

> üéØ **Template n√†y k·∫øt h·ª£p 100% best practices t·ª´:**
> - IEEE 1016-2009 Standard
> - Google Design Docs & SRE Book
> - AWS Well-Architected Framework
> - Netflix/Stripe/Meta Production Standards
> - 40-Chapter Production Quality Guide
> - MLOps Best Practices

---

### üìã DOCUMENT METADATA

```yaml
## ============================================
## DOCUMENT INFORMATION
## ============================================
Title: "Software Design Document: finAI Finance Agent Web Browser (MVP)"
Document_ID: "SDD-FINAI-AGENT-V1.0"

## Ownership
Author: "Manus AI (Ki·∫øn tr√∫c s∆∞ H·ªá th·ªëng)"
Co_Authors: 
  - "[T√™n K·ªπ s∆∞ AI/ML]"
  - "[T√™n K·ªπ s∆∞ Backend]"

## Review & Approval
Reviewers:
  Technical_Lead: "[T√™n Tr∆∞·ªüng nh√≥m K·ªπ thu·∫≠t]"
  Product_Manager: "[T√™n Qu·∫£n l√Ω S·∫£n ph·∫©m]"
  Security_Engineer: "[T√™n K·ªπ s∆∞ B·∫£o m·∫≠t]"
  QA_Lead: "[T√™n Tr∆∞·ªüng nh√≥m QA]"
  ML_Engineer: "[T√™n K·ªπ s∆∞ ML]"
Approved_By: "[T√™n, Vai tr√≤]"

## Status Tracking
Status: "Draft"
Priority: "P0-Critical"

## Timeline
Created_Date: "2025-12-16"
Last_Updated: "2025-12-16"
Target_Release: "Q3 2026 (MVP)"
Review_Deadline: "2026-01-15"

## Versioning (Semantic: X.Y.Z)
Version: "1.0.0"

## Related Documents
Related_Docs:
  PRD: "[Link ƒë·∫øn Product Requirements Document]"
  Competitor_Analysis: "Ph·∫ßn A - Ph√¢n t√≠ch ƒê·ªëi th·ªß C·∫°nh tranh"
  Architecture_Proposal: "Ph·∫ßn B - Ki·∫øn tr√∫c D·ª± ki·∫øn"
  UI_Design: "[Link ƒë·∫øn Figma/Sketch]"
  Test_Plan: "[Link ƒë·∫øn Test Plan]"
```

---

### üìñ TABLE OF CONTENTS

#### Part I: Foundation & Architecture
1. Executive Summary (TL;DR)
2. Introduction
3. Goals, Scope & Constraints
4. System Overview
5. High-Level Design (HLD)
6. Low-Level Design (LLD)

#### Part II: Implementation Details
7. API Design & Contracts
8. Data Design
9. Security Design

#### Part III: Production Readiness
10. Resilience & Reliability
11. Observability & Monitoring
12. Deployment & Operations
13. Testing Strategy

#### Part IV: Quality & Governance
14. Non-Functional Requirements (NFR)
15. Performance & Capacity Planning
16. Cost Optimization
17. Trade-offs & Architecture Decisions

#### Part V: Operations & MLOps
18. Incident Response & Runbooks
19. MLOps (Machine Learning Operations)

#### Part VI: Launch & Beyond
20. Implementation Roadmap
21. Production Readiness Checklist
22. Common Mistakes & Anti-Patterns
23. Tool Recommendations
24. Appendices

---

## PART I: FOUNDATION & ARCHITECTURE

---

## 1. EXECUTIVE SUMMARY (TL;DR)

> üí° **M·ª•c ƒë√≠ch**: T√≥m t·∫Øt to√†n b·ªô document trong 1 trang, t·∫≠p trung v√†o c√°c quy·∫øt ƒë·ªãnh quan tr·ªçng nh·∫•t.

### 1.1 Summary Table

| Aspect | Details |
| :--- | :--- |
| **Problem Statement** | Quy tr√¨nh nghi√™n c·ª©u t√†i ch√≠nh hi·ªán t·∫°i (10-50 tab) l√† **c·ª±c k·ª≥ k√©m hi·ªáu qu·∫£** v√† d·ªÖ m·∫Øc l·ªói. C√°c Agent duy·ªát web hi·ªán t·∫°i kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c y√™u c·∫ßu v·ªÅ **ƒê·ªô ch√≠nh x√°c, Ngu·ªìn g·ªëc v√† Tu√¢n th·ªß** c·ªßa ng√†nh t√†i ch√≠nh. |
| **Proposed Solution** | X√¢y d·ª±ng **finAI Research Agent (Chrome Extension)**, m·ªôt tr√¨nh duy·ªát AI-Native chuy√™n bi·ªát cho t√†i ch√≠nh. Ki·∫øn tr√∫c c·ªët l√µi l√† **Hybrid Agentic Browser** s·ª≠ d·ª•ng **LangGraph** ƒë·ªÉ qu·∫£n l√Ω lu·ªìng c√¥ng vi·ªác ph·ª©c t·∫°p v√† **Hybrid DOM/Vision** ƒë·ªÉ t∆∞∆°ng t√°c web b·ªÅn b·ªâ. |
| **Business Impact** | Gi√∫p c√°c chuy√™n gia t√†i ch√≠nh ƒë∆∞a ra quy·∫øt ƒë·ªãnh **nhanh h∆°n 10 l·∫ßn** v√† **ƒë∆∞·ª£c th√¥ng tin t·ªët h∆°n 100 l·∫ßn**. M·ª•c ti√™u: 1K ng∆∞·ªùi d√πng tr·∫£ ph√≠, $10K MRR trong 18 th√°ng. |
| **Technical Impact** | Thi·∫øt l·∫≠p ti√™u chu·∫©n **Compliance-first Architecture** v·ªõi **Human-in-the-Loop (HITL)** v√† **Audit Trail** t·ª´ ng√†y ƒë·∫ßu, t·∫°o l·ª£i th·∫ø c·∫°nh tranh b·ªÅn v·ªØng (Moat Layer 2). |
| **Key Technology** | **LangGraph** (Agent Core), **Playwright** (Browser Control), **GPT-4o/Claude 3.5** (LLM), **Redis** (Memory), **PostgreSQL** (Persistence). |
| **Estimated Effort** | 5 ng∆∞·ªùi (1 AI Lead, 1 Finance Expert, 2 Full-stack, 1 Designer) trong 18 th√°ng ƒë·ªÉ ƒë·∫°t PMF. |
| **Risk Level** | **Medium-High.** R·ªßi ro ch√≠nh l√† **Hallucination** (AI ƒë∆∞a ra s·ªë li·ªáu sai) v√† **Regulatory** (b·ªã coi l√† t∆∞ v·∫•n ƒë·∫ßu t∆∞). |
| **Timeline** | **MVP (finAI Research Agent):** 18 th√°ng. **Production Ready:** 24 th√°ng. |
| **Key Stakeholders** | Team K·ªπ thu·∫≠t, Team S·∫£n ph·∫©m, Team Ph√°p l√Ω/Tu√¢n th·ªß. |
| **Total Cost (Year 1)** | $500K (Resources) + Chi ph√≠ h·∫° t·∫ßng Cloud/LLM (∆Ø·ªõc t√≠nh $5K - $10K/th√°ng ban ƒë·∫ßu). |

### 1.2 Architecture Overview

Ki·∫øn tr√∫c finAI ƒë∆∞·ª£c thi·∫øt k·∫ø theo m√¥ h√¨nh **4-Layer MECE Framework** ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn, kh·∫£ nƒÉng m·ªü r·ªông v√† tu√¢n th·ªß.

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#0f1','primaryTextColor':'#fff','primaryBorderColor':'#3b8','fontSize':'13px'}}}%%

flowchart TB
    %% ==================== USER & INPUT ====================
    User([üë§ USER<br/>Natural Language Goal])
    
    %% ==================== LAYER 1: PERCEPTION ====================
    subgraph L1["üîç LAYER 1: PERCEPTION - Browser State Awareness"]
        direction TB
        IP["üì• Input Processor"]
        BM["üåê Browser Monitor"]
        IP --> Context
        BM --> Context
    end
    
    %% ==================== LAYER 2: COGNITION ====================
    subgraph L2["üß† LAYER 2: COGNITION - Agent Brain (LangGraph Core)"]
        direction TB
        Context --> StateGraph["üìä LangGraph StateGraph<br/>(ReAct Loop)"]
        StateGraph --> Decision["üìã ACTION DECISION"]
    end
    
    %% ==================== LAYER 3: ACTION ====================
    subgraph L3["‚ö° LAYER 3: ACTION - Browser Control & Execution"]
        direction TB
        Decision --> ToolRouter{Tool Router}
        ToolRouter --> Executor["üöÄ Execution Engine (Playwright)"]
        Executor --> Browser["üåê HEADLESS CHROMIUM"]
        Browser --> Result["üìã EXECUTION RESULT"]
    end
    
    %% ==================== LAYER 4: GOVERNANCE ====================
    subgraph L4["üõ°Ô∏è LAYER 4: GOVERNANCE - Safety & Human Control"]
        direction TB
        Guard["‚öñÔ∏è Guardrails"]
        HITL["üë§ Human-in-the-Loop"]
        Guard ~~~ HITL
    end
    
    %% ==================== FEEDBACK LOOP ====================
    Result --> L1
    
    %% ==================== GOVERNANCE MONITORING ====================
    L4 -.->|Monitor & Control| L2
    L4 -.->|Block if Unsafe| L3
    
    %% ==================== FINAL OUTPUT ====================
    Result --> Check{Goal<br/>Achieved?}
    Check -->|No| L2
    Check -->|Yes| Output([üì§ FINAL OUTPUT<br/>Answer + Evidence Pack])
    
    %% ==================== USER INTERACTION ====================
    User --> L1
    Output --> User
    
    style L1 fill:##1e3a8a,stroke:##3b82f6,stroke-width:4px,color:##fff
    style L2 fill:##78350f,stroke:##f59e0b,stroke-width:4px,color:##fff
    style L3 fill:##064e3b,stroke:##10b981,stroke-width:4px,color:##fff
    style L4 fill:##7f1d1d,stroke:##ef4444,stroke-width:4px,color:##fff
    
    style User fill:##6366f1,stroke:##4f46e5,stroke-width:3px,color:##fff
    style Output fill:##22c55e,stroke:##16a34a,stroke-width:3px,color:##fff
    style Browser fill:##0891b2,stroke:##0e7490,stroke-width:3px,color:##fff
    
    style Context fill:##fbbf24,stroke:##f59e0b,stroke-width:2px,color:##000
    style StateGraph fill:##fb923c,stroke:##ea580c,stroke-width:2px,color:##fff
    style Decision fill:##fbbf24,stroke:##f59e0b,stroke-width:2px,color:##000
    style Result fill:##86efac,stroke:##22c55e,stroke-width:2px,color:##000
    
    style Check fill:##f87171,stroke:##dc2626,stroke-width:3px,color:##fff
```

### 1.3 Key Metrics & Success Criteria

| KPI | Current | Target (MVP) | Measurement Method |
| :--- | :--- | :--- | :--- |
| **Metric Extraction Accuracy** | N/A | **>90%** (Key Metrics: Revenue, EBITDA) | Automated Test Suite (Ground Truth Validation) |
| **Hallucination Rate** | N/A | **<2%** (S·ªë li·ªáu kh√¥ng c√≥ ngu·ªìn g·ªëc) | Audit Log & Manual Review (Risk 2 Mitigation) |
| **Time-to-Snapshot** | 5-10 gi·ªù (Manual) | **<60 gi√¢y** (T·ª´ Ticker ƒë·∫øn Snapshot) | Performance Monitoring (Latency p95) |
| **Agent Success Rate** | N/A | **>85%** (Ho√†n th√†nh t√°c v·ª• kh√¥ng c·∫ßn can thi·ªáp) | LangSmith/LangFuse Tracing |
| **Compliance Log Coverage** | N/A | **100%** (M·ªçi h√†nh ƒë·ªông/quy·∫øt ƒë·ªãnh c·ªßa Agent) | Audit Log Integrity Check |

### 1.4 Risk Summary

| Risk | Probability | Impact | Mitigation |
| :--- | :--- | :--- | :--- |
| **Regulatory (Investment Advice)** | Medium | Game Over | **L·ªõp Governance (L4)**: Ch·ªâ cung c·∫•p "nghi√™n c·ª©u" v√† "ph√¢n t√≠ch k·ªãch b·∫£n", kh√¥ng "khuy·∫øn ngh·ªã mua/b√°n". **HITL** cho c√°c h√†nh ƒë·ªông nh·∫°y c·∫£m. |
| **Technical (AI Hallucination)** | High | Trust Destroyed | **Node Verifier (L2)**: Lu√¥n ki·ªÉm tra ch√©o s·ªë li·ªáu v·ªõi ngu·ªìn g·ªëc. **Source Attribution** b·∫Øt bu·ªôc cho m·ªçi ƒë·∫ßu ra. **Confidence Score** hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng. |
| **Competitive (Big Tech Copycat)** | Very High | Medium-High | **T·ªëc ƒë·ªô x√¢y d·ª±ng Moat:** T·∫≠p trung v√†o **Data Moat** (ph√¢n t√≠ch workflow t√†i ch√≠nh ƒë·ªôc quy·ªÅn) v√† **Compliance-first Architecture** (kh√≥ sao ch√©p). |

---

## 2. INTRODUCTION

### 2.1 Document Purpose

T√†i li·ªáu n√†y cung c·∫•p **b·∫£n thi·∫øt k·∫ø production-ready** chi ti·∫øt cho **finAI Finance Agent Web Browser (MVP)**. M·ª•c ƒë√≠ch ch√≠nh l√†:
1.  **HLD & LLD:** M√¥ t·∫£ ki·∫øn tr√∫c t·ªïng th·ªÉ (High-Level Design) v√† chi ti·∫øt tri·ªÉn khai (Low-Level Design) c·ªßa h·ªá th·ªëng Agent.
2.  **Ti√™u chu·∫©n S·∫£n xu·∫•t:** ƒê·∫∑t ra c√°c ti√™u chu·∫©n nghi√™m ng·∫∑t v·ªÅ B·∫£o m·∫≠t (Security), Kh·∫£ nƒÉng Quan s√°t (Observability), v√† ƒê·ªô tin c·∫≠y (Reliability) theo y√™u c·∫ßu c·ªßa ng√†nh t√†i ch√≠nh.
3.  **Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c:** Ghi l·∫°i c√°c quy·∫øt ƒë·ªãnh k·ªπ thu·∫≠t quan tr·ªçng (v√≠ d·ª•: L·ª±a ch·ªçn LangGraph, M√¥ h√¨nh Hybrid DOM/Vision) v√† ph√¢n t√≠ch ƒë√°nh ƒë·ªïi (Trade-offs) ƒë·ªÉ l√†m c∆° s·ªü cho vi·ªác tri·ªÉn khai.

### 2.2 Target Audience

| Audience | Primary Use | Key Sections |
| :--- | :--- | :--- |
| **Technical Lead** | ƒê√°nh gi√° t√≠nh kh·∫£ thi, t√≠nh to√†n v·∫πn c·ªßa ki·∫øn tr√∫c, v√† ph√¢n c√¥ng c√¥ng vi·ªác. | HLD, LLD, Resilience & Reliability, Testing Strategy. |
| **Product Manager** | Hi·ªÉu r√µ gi·ªõi h·∫°n k·ªπ thu·∫≠t, ph·∫°m vi MVP, v√† c√°c r·ªßi ro li√™n quan ƒë·∫øn t√≠nh nƒÉng. | Executive Summary, Goals, Scope & Constraints, Implementation Roadmap. |
| **Security/Compliance Engineer** | ƒê·∫£m b·∫£o h·ªá th·ªëng ƒë√°p ·ª©ng c√°c y√™u c·∫ßu v·ªÅ b·∫£o m·∫≠t d·ªØ li·ªáu v√† tu√¢n th·ªß ph√°p l√Ω. | Security Design, Governance, Incident Response. |
| **ML/AI Engineer** | Tri·ªÉn khai Agent Core, MLOps, v√† c√°c m√¥ h√¨nh LLM/Vision. | Cognition Layer (L2), MLOps, Performance & Capacity Planning. |
| **Operations/SRE** | Chu·∫©n b·ªã h·∫° t·∫ßng, tri·ªÉn khai, gi√°m s√°t v√† v·∫≠n h√†nh h·ªá th·ªëng. | Deployment & Operations, Observability & Monitoring, Runbooks. |

---

## 3. GOALS, SCOPE & CONSTRAINTS

### 3.1 Project Goals (M·ª•c ti√™u Kinh doanh & K·ªπ thu·∫≠t)

#### 3.1.1 Business Goals (M·ª•c ti√™u MVP - 18 th√°ng)
1.  **ƒê·∫°t Product-Market Fit (PMF):** ƒê·∫°t 1K ng∆∞·ªùi d√πng tr·∫£ ph√≠ v√† $10K MRR.
2.  **Gi·∫£i quy·∫øt "Killer Use Case":** Gi·∫£m th·ªùi gian nghi√™n c·ª©u m·ªôt c·ªï phi·∫øu t·ª´ 5-10 gi·ªù xu·ªëng d∆∞·ªõi 60 gi√¢y ƒë·ªÉ t·∫°o ra "1-Page Investment Snapshot".
3.  **X√¢y d·ª±ng Moat:** Thi·∫øt l·∫≠p **Compliance-first Architecture** ƒë·ªÉ t·∫°o l·ª£i th·∫ø c·∫°nh tranh b·ªÅn v·ªØng so v·ªõi c√°c Agent chung chung.

#### 3.1.2 Technical Goals
1.  **Ki·∫øn tr√∫c Agentic:** Tri·ªÉn khai Agent Core s·ª≠ d·ª•ng **LangGraph** ƒë·ªÉ qu·∫£n l√Ω lu·ªìng c√¥ng vi·ªác ph·ª©c t·∫°p, c√≥ kh·∫£ nƒÉng t·ª± ph·ª•c h·ªìi (self-healing) v√† t√°i l·∫≠p k·∫ø ho·∫°ch (re-planning).
2.  **T∆∞∆°ng t√°c Web B·ªÅn b·ªâ:** ƒê·∫°t t·ª∑ l·ªá th√†nh c√¥ng >90% khi tr√≠ch xu·∫•t d·ªØ li·ªáu t·ª´ c√°c trang web t√†i ch√≠nh ph·ª©c t·∫°p (EDGAR, b√°o c√°o thu nh·∫≠p, tin t·ª©c).
3.  **ƒê·ªô tin c·∫≠y T√†i ch√≠nh:** ƒê·∫£m b·∫£o **Metric Extraction Accuracy >90%** v√† **Hallucination Rate <2%** cho c√°c s·ªë li·ªáu t√†i ch√≠nh quan tr·ªçng.

### 3.2 Scope of Work (Ph·∫°m vi MVP - finAI Research Agent)

| T√≠nh nƒÉng (Feature) | M√¥ t·∫£ Chi ti·∫øt | Thu·ªôc Scope (MVP) |
| :--- | :--- | :--- |
| **Document Understanding** | Agent t·ª± ƒë·ªông ph√¢n t√≠ch v√† t√≥m t·∫Øt n·ªôi dung khi ng∆∞·ªùi d√πng m·ªü c√°c t√†i li·ªáu t√†i ch√≠nh (10-K, 10-Q, B√°o c√°o thu nh·∫≠p). | ‚úÖ |
| **Metric Extraction** | Tr√≠ch xu·∫•t c√°c s·ªë li·ªáu t√†i ch√≠nh c·ªët l√µi (Revenue, EBITDA, Margin, Debt, Guidance) v·ªõi ngu·ªìn g·ªëc r√µ r√†ng. | ‚úÖ |
| **Risk Flagging** | T·ª± ƒë·ªông ph√°t hi·ªán v√† c·∫£nh b√°o c√°c r·ªßi ro (v√≠ d·ª•: vi ph·∫°m giao ∆∞·ªõc n·ª£, n·ª£ tƒÉng ƒë·ªôt bi·∫øn, d·ª± b√°o doanh thu th·∫•p h∆°n k·ª≥ v·ªçng). | ‚úÖ |
| **1-Page Snapshot** | T·∫°o ra m·ªôt b·∫£n t√≥m t·∫Øt ƒë·∫ßu t∆∞ 1 trang, c√≥ th·ªÉ xu·∫•t (export) ƒë∆∞·ª£c, bao g·ªìm lu·∫≠n ƒëi·ªÉm, s·ªë li·ªáu ch√≠nh, v√† r·ªßi ro. | ‚úÖ |
| **Source Attribution** | M·ªçi s·ªë li·ªáu v√† tr√≠ch d·∫´n ph·∫£i li√™n k·∫øt tr·ª±c ti·∫øp ƒë·∫øn ngu·ªìn t√†i li·ªáu g·ªëc (Provenance). | ‚úÖ |
| **Portfolio Context** | T√≠ch h·ª£p c∆° b·∫£n ƒë·ªÉ l√†m n·ªïi b·∫≠t c√°c v·ªã th·∫ø, m·ª©c ƒë·ªô ti·∫øp x√∫c ng√†nh (sector exposure) li√™n quan ƒë·∫øn nghi√™n c·ª©u. | ‚úÖ |
| **Version History** | Theo d√µi l·ªãch s·ª≠ thay ƒë·ªïi c·ªßa ph√¢n t√≠ch khi c√≥ th√¥ng tin m·ªõi. | ‚úÖ |
| **Multi-document Synthesis** | T·ªïng h·ª£p th√¥ng tin t·ª´ nhi·ªÅu t√†i li·ªáu/ngu·ªìn kh√°c nhau ƒë·ªÉ t·∫°o ra m·ªôt b√°o c√°o t·ªïng th·ªÉ. | ‚ùå (V1.5) |
| **Broker Integrations** | T√≠ch h·ª£p API v·ªõi c√°c nh√† m√¥i gi·ªõi (broker) ƒë·ªÉ theo d√µi danh m·ª•c ƒë·∫ßu t∆∞ v√† th·ª±c hi·ªán giao d·ªãch. | ‚ùå (V2) |
| **Team Collaboration** | T√≠nh nƒÉng chia s·∫ª, b√¨nh lu·∫≠n, v√† qu·∫£n l√Ω quy·ªÅn truy c·∫≠p cho nh√≥m. | ‚ùå (V2) |

### 3.3 Constraints (R√†ng bu·ªôc K·ªπ thu·∫≠t & Nghi·ªáp v·ª•)

| Lo·∫°i R√†ng bu·ªôc | M√¥ t·∫£ Chi ti·∫øt | T√°c ƒë·ªông ƒë·∫øn Thi·∫øt k·∫ø |
| :--- | :--- | :--- |
| **Nghi·ªáp v·ª• (Compliance)** | **Kh√¥ng ƒë∆∞·ª£c ƒë∆∞a ra l·ªùi khuy√™n ƒë·∫ßu t∆∞.** M·ªçi ƒë·∫ßu ra ph·∫£i l√† "c√¥ng c·ª• nghi√™n c·ª©u" (research tool). | **L·ªõp Governance (L4)** ph·∫£i l√† th√†nh ph·∫ßn c·ªët l√µi, kh√¥ng th·ªÉ b·ªè qua. C·∫ßn c√≥ c√°c Guardrails v·ªÅ ng√¥n ng·ªØ. |
| **K·ªπ thu·∫≠t (Agent Core)** | **B·∫Øt bu·ªôc s·ª≠ d·ª•ng LangGraph** l√†m l√µi qu·∫£n l√Ω tr·∫°ng th√°i v√† lu·ªìng c√¥ng vi·ªác c·ªßa Agent. | Ki·∫øn tr√∫c ph·∫£i xoay quanh State Machine c·ªßa LangGraph (ReAct Loop, Nodes, Edges). |
| **K·ªπ thu·∫≠t (T∆∞∆°ng t√°c Web)** | Ph·∫£i s·ª≠ d·ª•ng m√¥ h√¨nh **Hybrid DOM + Vision** ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô b·ªÅn b·ªâ tr√™n c√°c trang web t√†i ch√≠nh. | **L·ªõp Perception (L1)** ph·∫£i t√≠ch h·ª£p c·∫£ Playwright (DOM/A11y Tree) v√† GPT-4V (Vision) ho·∫∑c m√¥ h√¨nh Vision t∆∞∆°ng ƒë∆∞∆°ng. |
| **Hi·ªáu su·∫•t (Latency)** | Th·ªùi gian ph·∫£n h·ªìi cho t√°c v·ª• tr√≠ch xu·∫•t s·ªë li·ªáu (Metric Extraction) ph·∫£i d∆∞·ªõi **5 gi√¢y** (p95). | C·∫ßn s·ª≠ d·ª•ng c√°c c∆° ch·∫ø caching (Redis) v√† t·ªëi ∆∞u h√≥a s·ªë l∆∞·ª£ng LLM calls. |
| **B·∫£o m·∫≠t (Security)** | D·ªØ li·ªáu danh m·ª•c ƒë·∫ßu t∆∞ (Portfolio Data) v√† th√¥ng tin c√° nh√¢n (PII) ph·∫£i ƒë∆∞·ª£c m√£ h√≥a **End-to-End** v√† l∆∞u tr·ªØ tu√¢n th·ªß. | **L·ªõp Security (P2)** ph·∫£i ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi m√£ h√≥a d·ªØ li·ªáu ngh·ªâ (at rest) v√† d·ªØ li·ªáu truy·ªÅn (in transit). |

---

## 4. SYSTEM OVERVIEW (T·ªïng quan H·ªá th·ªëng)

H·ªá th·ªëng finAI Finance Agent Web Browser l√† m·ªôt **H·ªá th·ªëng Agentic lai (Hybrid Agentic System)** ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ ho·∫°t ƒë·ªông nh∆∞ m·ªôt **Tr√¨nh duy·ªát Th√¥ng minh (Intelligent Browser)**. N√≥ kh√¥ng ch·ªâ l√† m·ªôt chatbot, m√† l√† m·ªôt c·ªó m√°y t·ª± ƒë·ªông h√≥a quy tr√¨nh nghi√™n c·ª©u ph·ª©c t·∫°p.

### 4.1 B·ªëi c·∫£nh H·ªá th·ªëng (System Context)

H·ªá th·ªëng bao g·ªìm ba th√†nh ph·∫ßn ch√≠nh giao ti·∫øp v·ªõi nhau:
1.  **Client (Chrome Extension):** Giao di·ªán ng∆∞·ªùi d√πng, n∆°i ng∆∞·ªùi d√πng nh·∫≠p m·ª•c ti√™u v√† xem k·∫øt qu·∫£. N√≥ c≈©ng l√† c·∫ßu n·ªëi ƒë·ªÉ Agent "nh√¨n" v√† "thao t√°c" tr√™n c√°c trang web.
2.  **Agent Service (Backend):** L√µi x·ª≠ l√Ω logic, n∆°i LangGraph State Machine ch·∫°y. ƒê√¢y l√† n∆°i quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông ti·∫øp theo.
3.  **Data & External Services:** C√°c d·ªãch v·ª• b√™n ngo√†i cung c·∫•p d·ªØ li·ªáu, LLM, v√† l∆∞u tr·ªØ.

### 4.2 Ki·∫øn tr√∫c 4 L·ªõp (4-Layer Architecture)

Ki·∫øn tr√∫c ƒë∆∞·ª£c chia th√†nh 4 l·ªõp ƒë·ªôc l·∫≠p, tu√¢n th·ªß nguy√™n t·∫Øc **Separation of Concerns**, v·ªõi lu·ªìng d·ªØ li·ªáu ch√≠nh l√† m·ªôt **V√≤ng l·∫∑p Ph·∫£n h·ªìi (Feedback Loop)** li√™n t·ª•c:

| L·ªõp (Layer) | Ch·ª©c nƒÉng Ch√≠nh | C√¥ng ngh·ªá C·ªët l√µi | ƒê·∫ßu v√†o | ƒê·∫ßu ra |
| :--- | :--- | :--- | :--- | :--- |
| **L1: PERCEPTION** | Thu th·∫≠p v√† x·ª≠ l√Ω ƒë·∫ßu v√†o (m·ª•c ti√™u ng∆∞·ªùi d√πng, tr·∫°ng th√°i tr√¨nh duy·ªát) ƒë·ªÉ t·∫°o ra **Ng·ªØ c·∫£nh Th·ªëng nh·∫•t (Unified Context)**. | Playwright, GPT-4V (Vision), Input Parser. | M·ª•c ti√™u ng∆∞·ªùi d√πng, ·∫¢nh ch·ª•p m√†n h√¨nh, C√¢y A11y/DOM. | Unified Context (JSON/Pydantic Model). |
| **L2: COGNITION** | "B·ªô n√£o" c·ªßa Agent. S·ª≠ d·ª•ng LangGraph ƒë·ªÉ l·∫≠p k·∫ø ho·∫°ch, ra quy·∫øt ƒë·ªãnh, v√† qu·∫£n l√Ω tr·∫°ng th√°i. | LangGraph, LLM (GPT-4o/Claude 3.5), Redis (Memory). | Unified Context. | Action Decision (`tool_name`, `params`, `confidence`). |
| **L3: ACTION** | Th·ª±c thi h√†nh ƒë·ªông ƒë√£ ƒë∆∞·ª£c quy·∫øt ƒë·ªãnh b·ªüi L2 tr√™n tr√¨nh duy·ªát ho·∫∑c c√°c c√¥ng c·ª• kh√°c. | Playwright, Execution Engine, Tool Registry. | Action Decision. | Execution Result (`status`, `data`, `screenshot`). |
| **L4: GOVERNANCE** | Gi√°m s√°t v√† ki·ªÉm so√°t to√†n b·ªô lu·ªìng c√¥ng vi·ªác ƒë·ªÉ ƒë·∫£m b·∫£o **An to√†n, Tu√¢n th·ªß v√† Ki·ªÉm so√°t c·ªßa Con ng∆∞·ªùi (HITL)**. | Guardrails, Audit Log, Access Control. | M·ªçi tr·∫°ng th√°i v√† h√†nh ƒë·ªông. | Ph√™ duy·ªát/T·ª´ ch·ªëi H√†nh ƒë·ªông, C·∫£nh b√°o. |

### 4.3 Lu·ªìng D·ªØ li·ªáu (Data Flow)

1.  **B·∫Øt ƒë·∫ßu:** Ng∆∞·ªùi d√πng nh·∫≠p **M·ª•c ti√™u** (v√≠ d·ª•: "Ph√¢n t√≠ch b√°o c√°o 10-K c·ªßa Apple") v√†o Client (Extension).
2.  **L1 (Perception):** Client g·ª≠i M·ª•c ti√™u + Tr·∫°ng th√°i tr√¨nh duy·ªát hi·ªán t·∫°i (URL, Screenshot, A11y Tree) ƒë·∫øn Agent Service. L1 x·ª≠ l√Ω v√† t·∫°o **Unified Context**.
3.  **L2 (Cognition):** LangGraph StateGraph nh·∫≠n Context, ch·∫°y qua **Planner Node** ƒë·ªÉ quy·∫øt ƒë·ªãnh **Action Decision** ti·∫øp theo (v√≠ d·ª•: `navigate` ƒë·∫øn trang EDGAR).
4.  **L4 (Governance):** L·ªõp Governance ki·ªÉm tra Action Decision (v√≠ d·ª•: URL c√≥ n·∫±m trong danh s√°ch ƒëen kh√¥ng? H√†nh ƒë·ªông c√≥ nh·∫°y c·∫£m kh√¥ng?). N·∫øu an to√†n, cho ph√©p ti·∫øp t·ª•c.
5.  **L3 (Action):** Execution Engine (Playwright) th·ª±c thi Action Decision tr√™n Headless Browser.
6.  **Ph·∫£n h·ªìi (Feedback Loop):** K·∫øt qu·∫£ th·ª±c thi (**Execution Result**) ƒë∆∞·ª£c g·ª≠i ng∆∞·ª£c l·∫°i L1 (Perception) ƒë·ªÉ c·∫≠p nh·∫≠t Tr·∫°ng th√°i Tr√¨nh duy·ªát (v√≠ d·ª•: Trang web m·ªõi ƒë√£ t·∫£i).
7.  **L·∫∑p l·∫°i:** L2 nh·∫≠n Context m·ªõi v√† ti·∫øp t·ª•c v√≤ng l·∫∑p (ReAct Loop) cho ƒë·∫øn khi M·ª•c ti√™u ho√†n th√†nh.
8.  **K·∫øt th√∫c:** Khi M·ª•c ti√™u ho√†n th√†nh, Agent t·∫°o **Final Output** (1-Page Snapshot + Evidence Pack) v√† g·ª≠i v·ªÅ Client.

---

## 5. HIGH-LEVEL DESIGN (HLD)

### 5.1 Quy·∫øt ƒë·ªãnh Ki·∫øn tr√∫c C·ªët l√µi (Core Architectural Decision)

**Quy·∫øt ƒë·ªãnh:** S·ª≠ d·ª•ng **Ki·∫øn tr√∫c A: Hybrid Agentic Browser v·ªõi LangGraph Core** l√†m n·ªÅn t·∫£ng.

**L√Ω do (D·ª±a tr√™n Brainstorm):**
*   **Ki·ªÉm so√°t Tu√¢n th·ªß:** LangGraph cung c·∫•p c·∫•u tr√∫c State Machine r√µ r√†ng, cho ph√©p nh√∫ng c√°c Node ki·ªÉm tra (Verifier, Guardrails) v√†o lu·ªìng c√¥ng vi·ªác, ƒë√°p ·ª©ng y√™u c·∫ßu **Compliance-first** c·ªßa finAI.
*   **ƒê·ªô b·ªÅn b·ªâ:** M√¥ h√¨nh **Hybrid DOM + Vision** (ƒë∆∞·ª£c tri·ªÉn khai trong L1) gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ ƒë·ªô b·ªÅn b·ªâ c·ªßa t∆∞∆°ng t√°c web, m·ªôt ƒëi·ªÉm y·∫øu c·ªßa c√°c Agent ch·ªâ d·ª±a tr√™n DOM.
*   **Kh·∫£ nƒÉng m·ªü r·ªông:** Ki·∫øn tr√∫c 4 l·ªõp ƒë·∫£m b·∫£o t√≠nh module h√≥a. L√µi Agent (L2) c√≥ th·ªÉ ƒë∆∞·ª£c n√¢ng c·∫•p ƒë·ªôc l·∫≠p v·ªõi c∆° ch·∫ø t∆∞∆°ng t√°c web (L1/L3) v√† c∆° ch·∫ø tu√¢n th·ªß (L4).

### 5.2 Thi·∫øt k·∫ø Chi ti·∫øt 4 L·ªõp

#### 5.2.1 L·ªõp 1: PERCEPTION (Browser State Awareness)

| Module | C√¥ng ngh·ªá | Vai tr√≤ | Chi ti·∫øt K·ªπ thu·∫≠t |
| :--- | :--- | :--- | :--- |
| **Input Processor** | Python/Pydantic | Ph√¢n t√≠ch M·ª•c ti√™u ng∆∞·ªùi d√πng th√†nh Intent, Entities, Constraints. | S·ª≠ d·ª•ng LLM (ho·∫∑c m√¥ h√¨nh nh·ªè h∆°n) ƒë·ªÉ ph√¢n lo·∫°i √Ω ƒë·ªãnh (v√≠ d·ª•: `research_stock`, `compare_metrics`). |
| **Browser Monitor** | Playwright, GPT-4V | Thu th·∫≠p tr·∫°ng th√°i tr√¨nh duy·ªát. | **A11y Tree (90%):** Tr√≠ch xu·∫•t c√¢y truy c·∫≠p (Accessibility Tree) ƒë·ªÉ c√≥ c·∫•u tr√∫c trang s·∫°ch. **Screenshot (10%):** Ch·ªâ s·ª≠ d·ª•ng ·∫£nh ch·ª•p m√†n h√¨nh khi A11y Tree kh√¥ng ƒë·ªß (v√≠ d·ª•: bi·ªÉu ƒë·ªì, CAPTCHA). |
| **Unified Context** | Redis Cache | L∆∞u tr·ªØ tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa Agent. | L√† m·ªôt Pydantic Model duy nh·∫•t ch·ª©a: `goal`, `current_url`, `page_state` (A11y/Screenshot), `action_history`, `memory_pointer`. |

#### 5.2.2 L·ªõp 2: COGNITION (LangGraph Core)

L√µi c·ªßa h·ªá th·ªëng l√† **LangGraph StateGraph** v·ªõi m√¥ h√¨nh **ReAct Loop** m·ªü r·ªông:

**State:** `AgentState` (ƒê·ªìng b·ªô v·ªõi Unified Context).

**Nodes (C√°c Tr·∫°ng th√°i Ch√≠nh):**
1.  **PLANNER_NODE:** Nh·∫≠n Context, quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông ti·∫øp theo (`tool_name`, `params`).
2.  **EXECUTOR_NODE:** G·ª≠i Action Decision ƒë·∫øn L3 (Action) ƒë·ªÉ th·ª±c thi.
3.  **VERIFIER_NODE:** **(Quan tr·ªçng cho finAI)** Ki·ªÉm tra k·∫øt qu·∫£ th·ª±c thi (Execution Result). N·∫øu l√† tr√≠ch xu·∫•t s·ªë li·ªáu, Node n√†y s·∫Ω ki·ªÉm tra ch√©o v·ªõi ngu·ªìn g·ªëc v√† t√≠nh to√°n **Confidence Score**.
4.  **REPLAN_NODE:** X·ª≠ l√Ω l·ªói (v√≠ d·ª•: `ElementNotFound`, `Timeout`, `LowConfidence`). Ph√¢n t√≠ch l·ªói v√† t·∫°o ra m·ªôt k·∫ø ho·∫°ch m·ªõi (quay l·∫°i PLANNER_NODE).
5.  **FINAL_NODE:** Khi m·ª•c ti√™u ho√†n th√†nh, t·ªïng h·ª£p k·∫øt qu·∫£ v√† chuy·ªÉn sang L4 (Governance) ƒë·ªÉ t·∫°o Audit Log v√† Output.

**Edges (C√°c Chuy·ªÉn ƒë·ªïi Tr·∫°ng th√°i):**
*   `PLANNER` -> `EXECUTOR`
*   `EXECUTOR` -> `VERIFIER`
*   `VERIFIER` -> **Conditional Edge:** N·∫øu `Success` -> `PLANNER` (cho b∆∞·ªõc ti·∫øp theo); N·∫øu `Failure` -> `REPLAN`.
*   `REPLAN` -> `PLANNER` (v·ªõi Context ƒë√£ ƒë∆∞·ª£c s·ª≠a ƒë·ªïi).
*   `VERIFIER` -> **Conditional Edge:** N·∫øu `Goal Achieved` -> `FINAL_NODE`.

#### 5.2.3 L·ªõp 3: ACTION (Browser Control & Execution)

| Module | C√¥ng ngh·ªá | Vai tr√≤ | Chi ti·∫øt K·ªπ thu·∫≠t |
| :--- | :--- | :--- | :--- |
| **Tool Registry** | Python Decorators | Danh s√°ch c√°c c√¥ng c·ª• c√≥ s·∫µn cho Agent. | Bao g·ªìm c√°c c√¥ng c·ª• duy·ªát web (`click`, `type`, `navigate`, `scroll`) v√† c√¥ng c·ª• t√†i ch√≠nh chuy√™n bi·ªát (`extract_metric`, `flag_risk`). |
| **Execution Engine** | Playwright Controller | Th·ª±c thi l·ªánh tr√™n tr√¨nh duy·ªát. | Qu·∫£n l√Ω **Browser Pool** (nhi·ªÅu phi√™n b·∫£n Headless Chromium) ƒë·ªÉ x·ª≠ l√Ω song song v√† c√¥ l·∫≠p phi√™n l√†m vi·ªác. |
| **Error Handler** | Python Try/Except | X·ª≠ l√Ω l·ªói c·∫•p th·∫•p (v√≠ d·ª•: network error, element not found). | √Åp d·ª•ng logic Retry (3 l·∫ßn) tr∆∞·ªõc khi chuy·ªÉn l·ªói l√™n L2 (REPLAN_NODE). |

#### 5.2.4 L·ªõp 4: GOVERNANCE (Safety & Human Control)

L·ªõp n√†y ho·∫°t ƒë·ªông nh∆∞ m·ªôt **Middleware** gi√°m s√°t L2 v√† L3.

| Module | Vai tr√≤ | Chi ti·∫øt K·ªπ thu·∫≠t |
| :--- | :--- | :--- |
| **Guardrails** | NgƒÉn ch·∫∑n c√°c h√†nh ƒë·ªông nguy hi·ªÉm/kh√¥ng tu√¢n th·ªß. | **URL Whitelist/Blacklist:** Ch·ªâ cho ph√©p truy c·∫≠p c√°c trang web t√†i ch√≠nh ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát. **Sensitive Data Filter:** NgƒÉn Agent nh·∫≠p/tr√≠ch xu·∫•t PII ho·∫∑c th√¥ng tin nh·∫°y c·∫£m. |
| **Human-in-the-Loop (HITL)** | Y√™u c·∫ßu ng∆∞·ªùi d√πng ph√™ duy·ªát c√°c h√†nh ƒë·ªông r·ªßi ro cao. | **Checkpoint Triggers:** K√≠ch ho·∫°t khi: 1) H√†nh ƒë·ªông t√†i ch√≠nh (v√≠ d·ª•: truy c·∫≠p broker API - V2), 2) Confidence Score th·∫•p (<70%), 3) L·∫ßn ƒë·∫ßu truy c·∫≠p m·ªôt domain. |
| **Audit Log** | Ghi l·∫°i m·ªçi quy·∫øt ƒë·ªãnh v√† h√†nh ƒë·ªông c·ªßa Agent. | L∆∞u tr·ªØ **Action Decision (L2)**, **Execution Result (L3)**, v√† **Verifier Score (L2)** v√†o c∆° s·ªü d·ªØ li·ªáu kh√¥ng thay ƒë·ªïi (Immutable Log) ƒë·ªÉ ph·ª•c v·ª• m·ª•c ƒë√≠ch tu√¢n th·ªß. |

---

## 6. LOW-LEVEL DESIGN (LLD)

### 6.1 Thi·∫øt k·∫ø L√µi LangGraph (L2 LLD)

#### 6.1.1 State Model (M√¥ h√¨nh Tr·∫°ng th√°i)

S·ª≠ d·ª•ng Pydantic ƒë·ªÉ ƒë·ªãnh nghƒ©a tr·∫°ng th√°i Agent, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n v√† kh·∫£ nƒÉng tu·∫ßn t·ª± h√≥a (serialization) cho Persistence.

```python
from typing import List, Optional
from pydantic import BaseModel, Field

class BBox(BaseModel):
    x: float
    y: float
    text: str
    ariaLabel: str

class PageState(BaseModel):
    url: str
    screenshot_b64: str
    a11y_tree_json: str
    
class ActionDecision(BaseModel):
    tool_name: str
    tool_params: dict
    confidence_score: float = Field(..., ge=0.0, le=1.0)
    reasoning: str

class AgentState(BaseModel):
    # Core Context
    goal: str
    current_page_state: PageState
    
    # Agent History & Memory
    action_history: List[ActionDecision] = []
    scratchpad: List[str] = [] # Intermediate thoughts for LLM
    
    # Decision & Result
    last_action: Optional[ActionDecision] = None
    last_observation: Optional[str] = None
    
    # Finance Specific
    extracted_metrics: dict = {} # Key metrics extracted so far
    risk_flags: List[str] = [] # List of flagged risks
    
    # Governance
    hitl_required: bool = False
    audit_log_id: str
```

#### 6.1.2 Chi ti·∫øt Node: VERIFIER_NODE

Node n√†y l√† ch√¨a kh√≥a ƒë·ªÉ gi·∫£i quy·∫øt **Risk 2 (Hallucination)**.

**Lu·ªìng x·ª≠ l√Ω:**
1.  **ƒê·∫ßu v√†o:** `AgentState` (ch·ª©a `last_action` v√† `last_observation`).
2.  **Logic:**
    *   N·∫øu `last_action` l√† `extract_metric`:
        *   **Source Check:** G·ª≠i `last_observation` (s·ªë li·ªáu tr√≠ch xu·∫•t) v√† `a11y_tree_json` (ng·ªØ c·∫£nh trang) ƒë·∫øn m·ªôt LLM/M√¥ h√¨nh nh·ªè ƒë·ªÉ x√°c nh·∫≠n ngu·ªìn g·ªëc (v√≠ d·ª•: "S·ªë li·ªáu n√†y ƒë∆∞·ª£c tr√≠ch t·ª´ d√≤ng X, ƒëo·∫°n Y c·ªßa t√†i li·ªáu 10-K").
        *   **Cross-Validation:** N·∫øu c√≥ th·ªÉ, ki·ªÉm tra ch√©o s·ªë li·ªáu v·ªõi m·ªôt ngu·ªìn d·ªØ li·ªáu th·ª© c·∫•p (v√≠ d·ª•: API d·ªØ li·ªáu th·ªã tr∆∞·ªùng).
        *   **Confidence Score:** T√≠nh to√°n ƒëi·ªÉm tin c·∫≠y (v√≠ d·ª•: 1.0 n·∫øu kh·ªõp 2 ngu·ªìn, 0.8 n·∫øu ch·ªâ kh·ªõp 1 ngu·ªìn v√† ngu·ªìn g·ªëc r√µ r√†ng, 0.0 n·∫øu kh√¥ng c√≥ ngu·ªìn g·ªëc).
3.  **ƒê·∫ßu ra:** C·∫≠p nh·∫≠t `extracted_metrics` v√† `risk_flags` trong `AgentState`. Quy·∫øt ƒë·ªãnh chuy·ªÉn ti·∫øp: `Success`, `Failure` (n·∫øu s·ªë li·ªáu sai nghi√™m tr·ªçng), ho·∫∑c `Goal Achieved`.

### 6.2 Thi·∫øt k·∫ø L·ªõp T∆∞∆°ng t√°c Web (L1/L3 LLD)

#### 6.2.1 M√¥ h√¨nh Hybrid DOM + Vision

1.  **Primary Input (90%): A11y Tree:**
    *   S·ª≠ d·ª•ng Playwright ƒë·ªÉ tr√≠ch xu·∫•t **Accessibility Tree** thay v√¨ DOM Tree ƒë·∫ßy ƒë·ªß. A11y Tree nh·ªè h∆°n, s·∫°ch h∆°n, v√† t·∫≠p trung v√†o c√°c ph·∫ßn t·ª≠ t∆∞∆°ng t√°c (buttons, links, inputs), gi√∫p LLM d·ªÖ d√†ng l√Ω gi·∫£i h∆°n.
    *   **Annotation:** C√°c ph·∫ßn t·ª≠ trong A11y Tree ƒë∆∞·ª£c g√°n m·ªôt ID duy nh·∫•t (v√≠ d·ª•: `a11y_id: 1, 2, 3...`) ƒë·ªÉ Agent c√≥ th·ªÉ tham chi·∫øu.
2.  **Secondary Input (10%): Vision (GPT-4V):**
    *   Ch·ªâ s·ª≠ d·ª•ng ·∫£nh ch·ª•p m√†n h√¨nh (Screenshot) v√† GPT-4V khi:
        *   Agent g·∫∑p l·ªói `ElementNotFound` (A11y Tree kh√¥ng c√≥).
        *   Trang ch·ª©a c√°c y·∫øu t·ªë h√¨nh ·∫£nh quan tr·ªçng (bi·ªÉu ƒë·ªì, ƒë·ªì th·ªã, CAPTCHA).
        *   REPLAN_NODE k√≠ch ho·∫°t.
    *   **Chi·∫øn l∆∞·ª£c:** G·ª≠i ·∫£nh ch·ª•p m√†n h√¨nh ƒë√£ ƒë∆∞·ª£c ch√∫ th√≠ch (gi·ªëng Web Voyager) c√πng v·ªõi A11y Tree ƒë·ªÉ LLM c√≥ c√°i nh√¨n to√†n di·ªán.

#### 6.2.2 Tool Registry (Danh s√°ch C√¥ng c·ª•)

| Tool Name | M√¥ t·∫£ | L·ªõp | Ghi ch√∫ |
| :--- | :--- | :--- | :--- |
| `navigate(url)` | ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn URL. | L3 (Browser) | Lu√¥n qua Guardrails (L4). |
| `click(a11y_id)` | Nh·∫•p v√†o ph·∫ßn t·ª≠ d·ª±a tr√™n ID A11y. | L3 (Browser) | |
| `type(a11y_id, text)` | Nh·∫≠p vƒÉn b·∫£n v√†o tr∆∞·ªùng input. | L3 (Browser) | |
| `scroll(direction)` | Cu·ªôn trang. | L3 (Browser) | |
| `extract_text(a11y_id)` | Tr√≠ch xu·∫•t vƒÉn b·∫£n chi ti·∫øt t·ª´ m·ªôt ph·∫ßn t·ª≠ l·ªõn (v√≠ d·ª•: to√†n b·ªô b√°o c√°o). | L3 (Data) | |
| `extract_metric(metric_name)` | **Tool chuy√™n bi·ªát finAI.** Tr√≠ch xu·∫•t s·ªë li·ªáu c·ª• th·ªÉ (v√≠ d·ª•: "EBITDA Q3 2025") t·ª´ trang hi·ªán t·∫°i. | L3 (Data) | K√≠ch ho·∫°t VERIFIER_NODE. |
| `flag_risk(risk_type, evidence)` | **Tool chuy√™n bi·ªát finAI.** ƒê√°nh d·∫•u m·ªôt r·ªßi ro ƒë√£ ƒë∆∞·ª£c ph√°t hi·ªán. | L3 (Data) | C·∫≠p nh·∫≠t `risk_flags` trong State. |

---
*Ti·∫øp t·ª•c vi·∫øt c√°c ph·∫ßn c√≤n l·∫°i c·ªßa SDD ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i y√™u c·∫ßu.*
... (N·ªôi dung ti·∫øp theo s·∫Ω ƒë∆∞·ª£c th√™m v√†o file n√†y)

## PART II: IMPLEMENTATION DETAILS

---

## 7. API DESIGN & CONTRACTS

H·ªá th·ªëng finAI Agent Service s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng m·ªôt **Microservice** s·ª≠ d·ª•ng **FastAPI** (Python) ƒë·ªÉ t·∫≠n d·ª•ng th∆∞ vi·ªán Pydantic (ƒë√£ d√πng cho State Model) v√† kh·∫£ nƒÉng x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô (async) c·ªßa Playwright.

### 7.1 API Gateway & Client Interface

Client (Chrome Extension) s·∫Ω giao ti·∫øp v·ªõi Agent Service th√¥ng qua m·ªôt **API Gateway** (v√≠ d·ª•: AWS API Gateway/Nginx Proxy) ƒë·ªÉ ƒë·∫£m b·∫£o b·∫£o m·∫≠t v√† gi·ªõi h·∫°n t·ªëc ƒë·ªô.

| Endpoint | Ph∆∞∆°ng th·ª©c | M√¥ t·∫£ | Request Body (Pydantic) | Response Body (Pydantic) |
| :--- | :--- | :--- | :--- | :--- |
| `/api/v1/agent/start` | `POST` | Kh·ªüi t·∫°o m·ªôt phi√™n Agent m·ªõi. | `StartSessionRequest(goal: str, initial_page_state: PageState)` | `SessionResponse(session_id: str, initial_action: ActionDecision)` |
| `/api/v1/agent/{session_id}/status` | `GET` | L·∫•y tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa Agent. | N/A | `AgentState` (Tr·∫°ng th√°i hi·ªán t·∫°i) |
| `/api/v1/agent/{session_id}/approve` | `POST` | Ph√™ duy·ªát h√†nh ƒë·ªông HITL. | `ApprovalRequest(approved: bool, modified_action: Optional[ActionDecision])` | `SessionResponse` |
| `/api/v1/agent/{session_id}/output` | `GET` | L·∫•y k·∫øt qu·∫£ cu·ªëi c√πng (Final Output). | N/A | `FinalOutput(snapshot: str, evidence_pack: dict)` |

### 7.2 Internal Tool API Contracts

C√°c c√¥ng c·ª• trong Tool Registry (L3) s·∫Ω ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a r√µ r√†ng ƒë·ªÉ LLM (L2) c√≥ th·ªÉ g·ªçi ch√≠nh x√°c.

```python
# V√≠ d·ª• v·ªÅ Tool Contract cho LLM
class ToolContract(BaseModel):
    name: str = Field(..., description="T√™n c√¥ng c·ª• (v√≠ d·ª•: navigate)")
    description: str = Field(..., description="M√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ ch·ª©c nƒÉng")
    parameters: dict = Field(..., description="Schema JSON c·ªßa c√°c tham s·ªë ƒë·∫ßu v√†o")

# LLM s·∫Ω nh·∫≠n danh s√°ch c√°c ToolContract n√†y v√† tr·∫£ v·ªÅ ActionDecision
```

---

## 8. DATA DESIGN

### 8.1 Data Model (M√¥ h√¨nh D·ªØ li·ªáu)

H·ªá th·ªëng s·∫Ω s·ª≠ d·ª•ng hai lo·∫°i c∆° s·ªü d·ªØ li·ªáu ch√≠nh:

| Lo·∫°i DB | C√¥ng ngh·ªá | M·ª•c ƒë√≠ch | M√¥ t·∫£ Chi ti·∫øt |
| :--- | :--- | :--- | :--- |
| **Transactional DB** | **PostgreSQL** | L∆∞u tr·ªØ d·ªØ li·ªáu ng∆∞·ªùi d√πng, phi√™n Agent d√†i h·∫°n, v√† k·∫øt qu·∫£ cu·ªëi c√πng. | L∆∞u tr·ªØ `User`, `Session`, `FinalOutput`, `ExtractedMetrics`. Y√™u c·∫ßu ACID. |
| **In-Memory Cache** | **Redis** | L∆∞u tr·ªØ tr·∫°ng th√°i Agent ng·∫Øn h·∫°n (`AgentState`) v√† b·ªô nh·ªõ ƒë·ªám (cache) cho c√°c truy v·∫•n LLM/API. | ƒê·∫£m b·∫£o t·ªëc ƒë·ªô truy c·∫≠p nhanh cho State Machine (L2). D·ªØ li·ªáu kh√¥ng c·∫ßn b·ªÅn b·ªâ. |
| **Vector DB** | **Pinecone/PGVector** | L∆∞u tr·ªØ ki·∫øn th·ª©c chuy√™n m√¥n (Domain Knowledge) v√† c√°c embedding c·ªßa t√†i li·ªáu t√†i ch√≠nh. | D√πng cho RAG (Retrieval-Augmented Generation) ƒë·ªÉ tƒÉng c∆∞·ªùng ki·∫øn th·ª©c cho LLM (L2) v√† Verifier Node. |

### 8.2 Audit Log Design (Thi·∫øt k·∫ø Nh·∫≠t k√Ω Ki·ªÉm to√°n)

Audit Log l√† th√†nh ph·∫ßn quan tr·ªçng nh·∫•t c·ªßa **Compliance-first Architecture**.

| Tr∆∞·ªùng | Lo·∫°i D·ªØ li·ªáu | M√¥ t·∫£ | Y√™u c·∫ßu Tu√¢n th·ªß |
| :--- | :--- | :--- | :--- |
| `log_id` | UUID | ID duy nh·∫•t c·ªßa b·∫£n ghi. | |
| `session_id` | UUID | ID c·ªßa phi√™n Agent. | |
| `timestamp` | Timestamp (UTC) | Th·ªùi ƒëi·ªÉm h√†nh ƒë·ªông x·∫£y ra. | B·∫Øt bu·ªôc. |
| `agent_state_snapshot` | JSON | Tr·∫°ng th√°i Agent tr∆∞·ªõc khi h√†nh ƒë·ªông. | **Audit Trail** |
| `action_decision` | JSON | Quy·∫øt ƒë·ªãnh c·ªßa LLM (tool, params, reasoning). | **Minh b·∫°ch** |
| `execution_result` | JSON | K·∫øt qu·∫£ th·ª±c thi (th√†nh c√¥ng/th·∫•t b·∫°i, d·ªØ li·ªáu tr√≠ch xu·∫•t). | **Provenance** |
| `confidence_score` | Float | ƒêi·ªÉm tin c·∫≠y c·ªßa k·∫øt qu·∫£ (t·ª´ VERIFIER_NODE). | **Accuracy** |
| `hitl_status` | Enum | `APPROVED`, `REJECTED`, `N/A`. | **Compliance** |
| `user_id` | UUID | Ng∆∞·ªùi d√πng th·ª±c hi·ªán phi√™n. | |

---

## 9. SECURITY DESIGN

### 9.1 Threat Modeling (M√¥ h√¨nh H√≥a Nguy c∆°)

| Nguy c∆° (Threat) | M√¥ t·∫£ | M·ª©c ƒë·ªô ∆Øu ti√™n | Bi·ªán ph√°p Gi·∫£m thi·ªÉu |
| :--- | :--- | :--- | :--- |
| **Prompt Injection** | K·∫ª t·∫•n c√¥ng c·ªë g·∫Øng thay ƒë·ªïi h√†nh vi c·ªßa Agent th√¥ng qua ƒë·∫ßu v√†o ƒë·ªôc h·∫°i. | Cao | **Safety Guard (L1):** S·ª≠ d·ª•ng LangKit ho·∫∑c m√¥ h√¨nh nh·ªè ƒë·ªÉ ph√°t hi·ªán v√† l·ªçc Prompt Injection. |
| **PII/Data Leakage** | Agent v√¥ t√¨nh tr√≠ch xu·∫•t ho·∫∑c l∆∞u tr·ªØ th√¥ng tin c√° nh√¢n/nh·∫°y c·∫£m c·ªßa ng∆∞·ªùi d√πng. | Cao | **Guardrails (L4):** L·ªçc d·ªØ li·ªáu nh·∫°y c·∫£m (PII, M·∫≠t kh·∫©u) tr∆∞·ªõc khi g·ª≠i ƒë·∫øn LLM ho·∫∑c l∆∞u tr·ªØ. **Browser Isolation:** Ch·∫°y Headless Browser trong m√¥i tr∆∞·ªùng sandbox c√¥ l·∫≠p. |
| **Malicious Navigation** | Agent b·ªã l·ª´a truy c·∫≠p ho·∫∑c th·ª±c hi·ªán h√†nh ƒë·ªông tr√™n c√°c trang web ƒë·ªôc h·∫°i. | Trung b√¨nh | **URL Whitelist (L4):** Ch·ªâ cho ph√©p truy c·∫≠p c√°c domain t√†i ch√≠nh ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát. **HITL:** Y√™u c·∫ßu ph√™ duy·ªát cho c√°c domain m·ªõi. |
| **Unauthorized Access** | Truy c·∫≠p tr√°i ph√©p v√†o Agent Service ho·∫∑c d·ªØ li·ªáu ng∆∞·ªùi d√πng. | Cao | **API Gateway:** Tri·ªÉn khai x√°c th·ª±c (AuthN) v√† ·ªßy quy·ªÅn (AuthZ) d·ª±a tr√™n JWT/OAuth2. **RBAC:** Ki·ªÉm so√°t truy c·∫≠p d·ª±a tr√™n vai tr√≤. |

### 9.2 Data Encryption (M√£ h√≥a D·ªØ li·ªáu)

1.  **D·ªØ li·ªáu Ngh·ªâ (Data at Rest):**
    *   S·ª≠ d·ª•ng **AWS KMS/Azure Key Vault** ƒë·ªÉ qu·∫£n l√Ω kh√≥a m√£ h√≥a.
    *   M√£ h√≥a to√†n b·ªô ·ªï ƒëƒ©a (Full Disk Encryption) cho c√°c m√°y ch·ªß DB.
    *   M√£ h√≥a c·∫•p c·ªôt (Column-level Encryption) cho c√°c tr∆∞·ªùng nh·∫°y c·∫£m (v√≠ d·ª•: Portfolio Data, API Keys).
2.  **D·ªØ li·ªáu Truy·ªÅn (Data in Transit):**
    *   B·∫Øt bu·ªôc s·ª≠ d·ª•ng **TLS 1.2+** cho m·ªçi giao ti·∫øp (Client <-> API Gateway <-> Agent Service).
    *   Giao ti·∫øp n·ªôi b·ªô (Agent Service <-> DB/Redis) c≈©ng s·ª≠ d·ª•ng k·∫øt n·ªëi m√£ h√≥a (v√≠ d·ª•: SSL cho PostgreSQL).

### 9.3 Browser Isolation

ƒê·ªÉ gi·∫£m thi·ªÉu r·ªßi ro t·ª´ vi·ªác duy·ªát web, Headless Browser (Playwright) s·∫Ω ƒë∆∞·ª£c ch·∫°y trong m·ªôt m√¥i tr∆∞·ªùng **Sandbox** ho·∫∑c **Container** (v√≠ d·ª•: Docker/Kubernetes Pod) v·ªõi c√°c r√†ng bu·ªôc nghi√™m ng·∫∑t:
*   **Network Policy:** H·∫°n ch·∫ø truy c·∫≠p m·∫°ng n·ªôi b·ªô.
*   **Resource Limits:** Gi·ªõi h·∫°n CPU/Memory ƒë·ªÉ ngƒÉn ch·∫∑n t·∫•n c√¥ng t·ª´ ch·ªëi d·ªãch v·ª• (DoS).
*   **Ephemeral:** M·ªói phi√™n Agent s·∫Ω s·ª≠ d·ª•ng m·ªôt Browser Context m·ªõi v√† b·ªã h·ªßy sau khi phi√™n k·∫øt th√∫c.

---
*Ti·∫øp t·ª•c vi·∫øt c√°c ph·∫ßn c√≤n l·∫°i c·ªßa SDD ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i y√™u c·∫ßu.*

## PART III: PRODUCTION READINESS

---

## 10. RESILIENCE & RELIABILITY (Kh·∫£ nƒÉng Ph·ª•c h·ªìi & ƒê·ªô tin c·∫≠y)

### 10.1 Failure Modes & Mitigation (C√°c Ch·∫ø ƒë·ªô Th·∫•t b·∫°i v√† Gi·∫£m thi·ªÉu)

| Ch·∫ø ƒë·ªô Th·∫•t b·∫°i | M√¥ t·∫£ | T√°c ƒë·ªông | Chi·∫øn l∆∞·ª£c Gi·∫£m thi·ªÉu |
| :--- | :--- | :--- | :--- |
| **LLM Failure/Timeout** | LLM (GPT-4o) kh√¥ng ph·∫£n h·ªìi ho·∫∑c tr·∫£ v·ªÅ k·∫øt qu·∫£ kh√¥ng h·ª£p l·ªá. | Agent b·ªã k·∫πt, kh√¥ng th·ªÉ ra quy·∫øt ƒë·ªãnh (L2). | **Retry Logic:** 3 l·∫ßn th·ª≠ l·∫°i v·ªõi backoff m≈©. **Fallback Model:** Chuy·ªÉn sang m√¥ h√¨nh nh·ªè h∆°n (v√≠ d·ª•: GPT-4o-mini) n·∫øu SOTA model th·∫•t b·∫°i. |
| **Browser Crash/Hang** | Headless Browser (Playwright) b·ªã treo ho·∫∑c g·∫∑p l·ªói nghi√™m tr·ªçng. | Agent kh√¥ng th·ªÉ th·ª±c thi h√†nh ƒë·ªông (L3). | **Browser Pool:** T·ª± ƒë·ªông thay th·∫ø phi√™n tr√¨nh duy·ªát b·ªã l·ªói b·∫±ng m·ªôt phi√™n m·ªõi t·ª´ Pool. **Timeout:** √Åp d·ª•ng timeout nghi√™m ng·∫∑t (v√≠ d·ª•: 30s) cho m·ªçi h√†nh ƒë·ªông c·ªßa tr√¨nh duy·ªát. |
| **Web Page Structure Change** | C·∫•u tr√∫c DOM/A11y Tree c·ªßa trang web m·ª•c ti√™u thay ƒë·ªïi. | Agent kh√¥ng th·ªÉ t√¨m th·∫•y ph·∫ßn t·ª≠ (ElementNotFound). | **REPLAN_NODE (L2):** K√≠ch ho·∫°t logic t·ª± ph·ª•c h·ªìi. Agent s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô Vision (GPT-4V) ƒë·ªÉ ph√¢n t√≠ch l·∫°i trang v√† t√¨m ra chi·∫øn l∆∞·ª£c m·ªõi. |
| **State Loss** | M·∫•t k·∫øt n·ªëi v·ªõi Redis ho·∫∑c Agent Service b·ªã kh·ªüi ƒë·ªông l·∫°i. | M·∫•t tr·∫°ng th√°i phi√™n Agent ƒëang ch·∫°y. | **Persistence:** ƒê·ªãnh k·ª≥ l∆∞u tr·∫°ng th√°i Agent (checkpoint) v√†o PostgreSQL (Transactional DB) sau m·ªói 5 h√†nh ƒë·ªông ho·∫∑c m·ªói khi c√≥ s·ª± can thi·ªáp c·ªßa ng∆∞·ªùi d√πng (HITL). |

### 10.2 High Availability (T√≠nh S·∫µn s√†ng Cao)

*   **Stateless Services:** Agent Service (L2/L3) s·∫Ω ƒë∆∞·ª£c thi·∫øt k·∫ø g·∫ßn nh∆∞ kh√¥ng tr·∫°ng th√°i (stateless), ch·ªâ d·ª±a v√†o `session_id` ƒë·ªÉ l·∫•y tr·∫°ng th√°i t·ª´ Redis/PostgreSQL. ƒêi·ªÅu n√†y cho ph√©p ch·∫°y nhi·ªÅu b·∫£n sao (replica) tr√™n Kubernetes (K8s).
*   **Multi-AZ Deployment:** Tri·ªÉn khai to√†n b·ªô h·∫° t·∫ßng (K8s, DB, Redis) tr√™n nhi·ªÅu V√πng S·∫µn s√†ng (Availability Zones) ƒë·ªÉ b·∫£o v·ªá kh·ªèi l·ªói trung t√¢m d·ªØ li·ªáu.
*   **Load Balancing:** S·ª≠ d·ª•ng Load Balancer (v√≠ d·ª•: AWS ALB) ƒë·ªÉ ph√¢n ph·ªëi l∆∞u l∆∞·ª£ng truy c·∫≠p ƒë·∫øn c√°c b·∫£n sao Agent Service.

---

## 11. OBSERVABILITY & MONITORING (Kh·∫£ nƒÉng Quan s√°t & Gi√°m s√°t)

### 11.1 Tracing & Logging (Truy v·∫øt & Ghi nh·∫≠t k√Ω)

*   **LangSmith/LangFuse:** B·∫Øt bu·ªôc s·ª≠ d·ª•ng **LangFuse** ƒë·ªÉ theo d√µi to√†n b·ªô v√≤ng l·∫∑p Agent (LangGraph Trace). ƒêi·ªÅu n√†y l√† c·ª±c k·ª≥ quan tr·ªçng cho vi·ªác g·ª° l·ªói v√† t·ªëi ∆∞u h√≥a c√°c quy·∫øt ƒë·ªãnh c·ªßa LLM.
    *   M·ªói Node (Planner, Verifier, Executor) trong LangGraph ph·∫£i ƒë∆∞·ª£c ghi l·∫°i d∆∞·ªõi d·∫°ng m·ªôt Span/Trace.
*   **Structured Logging:** S·ª≠ d·ª•ng JSON format cho t·∫•t c·∫£ c√°c log (v√≠ d·ª•: ELK Stack/Datadog).
    *   Bao g·ªìm c√°c tr∆∞·ªùng: `session_id`, `trace_id`, `agent_step`, `latency_ms`, `llm_token_usage`.

### 11.2 Metrics & Alerting (S·ªë li·ªáu & C·∫£nh b√°o)

| S·ªë li·ªáu (Metric) | Lo·∫°i | Ng∆∞·ª°ng C·∫£nh b√°o (Alert Threshold) | M·ª•c ƒë√≠ch |
| :--- | :--- | :--- | :--- |
| **Agent Success Rate** | Business | <80% (Gi·∫£m 5% so v·ªõi baseline) | C·∫£nh b√°o v·ªÅ ch·∫•t l∆∞·ª£ng Agent (L2). |
| **LLM Token Usage** | Cost | TƒÉng >20% so v·ªõi trung b√¨nh 7 ng√†y. | C·∫£nh b√°o v·ªÅ chi ph√≠ LLM tƒÉng ƒë·ªôt bi·∫øn. |
| **P95 Latency (End-to-End)** | Performance | >60 gi√¢y. | C·∫£nh b√°o v·ªÅ hi·ªáu su·∫•t ch·∫≠m. |
| **Browser Crash Rate** | Reliability | >0.5% s·ªë phi√™n. | C·∫£nh b√°o v·ªÅ l·ªói h·∫° t·∫ßng Playwright (L3). |
| **Verifier Node Failure Rate** | Quality | >10% s·ªë l·∫ßn g·ªçi. | C·∫£nh b√°o v·ªÅ ch·∫•t l∆∞·ª£ng tr√≠ch xu·∫•t d·ªØ li·ªáu (L2). |

---

## 12. DEPLOYMENT & OPERATIONS (Tri·ªÉn khai & V·∫≠n h√†nh)

### 12.1 Deployment Strategy

*   **Containerization:** To√†n b·ªô Agent Service v√† c√°c th√†nh ph·∫ßn ph·ª• tr·ª£ (Playwright Controller) s·∫Ω ƒë∆∞·ª£c ƒë√≥ng g√≥i b·∫±ng **Docker**.
*   **Orchestration:** S·ª≠ d·ª•ng **Kubernetes (K8s)** ƒë·ªÉ qu·∫£n l√Ω vi·ªác tri·ªÉn khai, m·ªü r·ªông (scaling) v√† t·ª± ph·ª•c h·ªìi (self-healing) c·ªßa c√°c container.
*   **CI/CD Pipeline:** S·ª≠ d·ª•ng GitHub Actions/GitLab CI ƒë·ªÉ t·ª± ƒë·ªông h√≥a quy tr√¨nh ki·ªÉm th·ª≠, x√¢y d·ª±ng image Docker v√† tri·ªÉn khai l√™n K8s (GitOps).

### 12.2 Scaling Strategy

*   **Horizontal Scaling (L2/L3):** Agent Service s·∫Ω ƒë∆∞·ª£c m·ªü r·ªông d·ª±a tr√™n s·ªë l∆∞·ª£ng phi√™n Agent ƒëang ho·∫°t ƒë·ªông (Active Sessions). S·ª≠ d·ª•ng **Horizontal Pod Autoscaler (HPA)** c·ªßa K8s d·ª±a tr√™n CPU Utilization ho·∫∑c Custom Metric (v√≠ d·ª•: `active_sessions_per_pod`).
*   **LLM Scaling:** LLM (GPT-4o) ƒë∆∞·ª£c truy c·∫≠p qua API, do ƒë√≥ kh·∫£ nƒÉng m·ªü r·ªông ph·ª• thu·ªôc v√†o nh√† cung c·∫•p (OpenAI/Anthropic). C·∫ßn c√≥ h·ª£p ƒë·ªìng c·∫•p ƒë·ªô doanh nghi·ªáp (Enterprise Tier) ƒë·ªÉ ƒë·∫£m b·∫£o gi·ªõi h·∫°n t·ªëc ƒë·ªô (Rate Limit) cao.

---

## 13. TESTING STRATEGY (Chi·∫øn l∆∞·ª£c Ki·ªÉm th·ª≠)

### 13.1 Unit & Integration Testing

*   **Unit Tests:** Ki·ªÉm tra t·ª´ng Node (Planner, Verifier) c·ªßa LangGraph m·ªôt c√°ch ƒë·ªôc l·∫≠p.
*   **Integration Tests:** Ki·ªÉm tra lu·ªìng d·ªØ li·ªáu gi·ªØa c√°c l·ªõp (L1 -> L2 -> L3). V√≠ d·ª•: Ki·ªÉm tra xem `ActionDecision` c·ªßa L2 c√≥ ƒë∆∞·ª£c th·ª±c thi ch√≠nh x√°c b·ªüi L3 kh√¥ng.

### 13.2 End-to-End (E2E) Testing

*   **Golden Path Tests:** Ki·ªÉm tra c√°c k·ªãch b·∫£n th√†nh c√¥ng c·ªët l√µi (v√≠ d·ª•: "Tr√≠ch xu·∫•t EBITDA t·ª´ 10-K c·ªßa Apple").
*   **Failure/Recovery Tests:** Ki·ªÉm tra kh·∫£ nƒÉng t·ª± ph·ª•c h·ªìi c·ªßa Agent. V√≠ d·ª•:
    1.  Agent c·ªë g·∫Øng `click` m·ªôt ph·∫ßn t·ª≠ kh√¥ng t·ªìn t·∫°i.
    2.  Ki·ªÉm tra xem `REPLAN_NODE` c√≥ ƒë∆∞·ª£c k√≠ch ho·∫°t kh√¥ng.
    3.  Ki·ªÉm tra xem Agent c√≥ chuy·ªÉn sang ch·∫ø ƒë·ªô Vision ƒë·ªÉ t√¨m ph·∫ßn t·ª≠ thay th·∫ø kh√¥ng.

### 13.3 Compliance & Accuracy Testing (Ki·ªÉm th·ª≠ Tu√¢n th·ªß & ƒê·ªô ch√≠nh x√°c)

*   **Ground Truth Validation:** X√¢y d·ª±ng m·ªôt b·ªô d·ªØ li·ªáu "Ground Truth" g·ªìm 100 b√°o c√°o t√†i ch√≠nh. Ch·∫°y Agent ƒë·ªÉ tr√≠ch xu·∫•t s·ªë li·ªáu v√† so s√°nh v·ªõi s·ªë li·ªáu ƒë√∫ng.
    *   **M·ª•c ti√™u:** ƒê·∫£m b·∫£o **Metric Extraction Accuracy >90%**.
*   **Guardrail Testing:** Ki·ªÉm tra xem c√°c Guardrails (L4) c√≥ ho·∫°t ƒë·ªông kh√¥ng.
    *   V√≠ d·ª•: C·ªë g·∫Øng ti√™m Prompt Injection. Ki·ªÉm tra xem `Safety Guard` c√≥ ch·∫∑n kh√¥ng.
    *   V√≠ d·ª•: C·ªë g·∫Øng ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn m·ªôt URL b·ªã c·∫•m. Ki·ªÉm tra xem `URL Whitelist` c√≥ ch·∫∑n kh√¥ng.

---
*Ti·∫øp t·ª•c vi·∫øt c√°c ph·∫ßn c√≤n l·∫°i c·ªßa SDD ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i y√™u c·∫ßu.*

## PART IV: QUALITY & GOVERNANCE

---

## 14. NON-FUNCTIONAL REQUIREMENTS (NFR)

| Y√™u c·∫ßu | M√¥ t·∫£ | M·ª©c ƒë·ªô ∆Øu ti√™n |
| :--- | :--- | :--- |
| **Hi·ªáu su·∫•t (Performance)** | Th·ªùi gian ho√†n th√†nh t√°c v·ª• (Time-to-Snapshot) < 60 gi√¢y (p95). | P0 - Critical |
| **Kh·∫£ nƒÉng M·ªü r·ªông (Scalability)** | H·ªá th·ªëng ph·∫£i h·ªó tr·ª£ 100 phi√™n Agent ƒë·ªìng th·ªùi (t∆∞∆°ng ƒë∆∞∆°ng 100 ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông). | P1 - High |
| **ƒê·ªô tin c·∫≠y (Reliability)** | Uptime SLA 99.9% (T·ªëi ƒëa 8.76 gi·ªù downtime/nƒÉm). | P1 - High |
| **B·∫£o m·∫≠t (Security)** | Tu√¢n th·ªß c√°c ti√™u chu·∫©n b·∫£o m·∫≠t t√†i ch√≠nh (v√≠ d·ª•: SOC 2 Type II, ISO 27001). | P0 - Critical |
| **Kh·∫£ nƒÉng Duy tr√¨ (Maintainability)** | Codebase ph·∫£i c√≥ ƒë·ªô bao ph·ªß ki·ªÉm th·ª≠ (Test Coverage) > 80%. | P2 - Medium |
| **Kh·∫£ nƒÉng Tu√¢n th·ªß (Compliance)** | M·ªçi h√†nh ƒë·ªông ph·∫£i ƒë∆∞·ª£c ghi l·∫°i trong Audit Log kh√¥ng th·ªÉ thay ƒë·ªïi. | P0 - Critical |

---

## 15. PERFORMANCE & CAPACITY PLANNING

### 15.1 Bottlenecks (N√∫t th·∫Øt C·ªï chai)

1.  **LLM Latency:** ƒê·ªô tr·ªÖ c·ªßa c√°c cu·ªôc g·ªçi API LLM (GPT-4o) l√† n√∫t th·∫Øt c·ªï chai ch√≠nh. M·ªói v√≤ng l·∫∑p LangGraph (ReAct step) y√™u c·∫ßu √≠t nh·∫•t 1-2 cu·ªôc g·ªçi LLM.
2.  **Browser Initialization:** Kh·ªüi t·∫°o m·ªôt phi√™n Playwright (Headless Browser) l√† m·ªôt ho·∫°t ƒë·ªông t·ªën k√©m v·ªÅ th·ªùi gian v√† t√†i nguy√™n.

### 15.2 Mitigation & Optimization

| K·ªπ thu·∫≠t T·ªëi ∆∞u | M√¥ t·∫£ | T√°c ƒë·ªông |
| :--- | :--- | :--- |
| **LLM Caching (L2)** | S·ª≠ d·ª•ng Redis ƒë·ªÉ l∆∞u tr·ªØ k·∫øt qu·∫£ c·ªßa c√°c truy v·∫•n LLM l·∫∑p l·∫°i (v√≠ d·ª•: ph√¢n t√≠ch c√∫ ph√°p trang web ƒë√£ bi·∫øt). | Gi·∫£m 20-30% LLM calls. |
| **Browser Pool (L3)** | Duy tr√¨ m·ªôt nh√≥m c√°c phi√™n Playwright ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o s·∫µn (warm instances) ƒë·ªÉ gi·∫£m th·ªùi gian kh·ªüi ƒë·ªông. | Gi·∫£m th·ªùi gian kh·ªüi ƒë·ªông phi√™n t·ª´ 5s xu·ªëng <1s. |
| **Prompt Optimization** | T·ªëi ∆∞u h√≥a Prompt ƒë·ªÉ gi·∫£m s·ªë l∆∞·ª£ng token ƒë·∫ßu v√†o/ƒë·∫ßu ra, gi·∫£m chi ph√≠ v√† ƒë·ªô tr·ªÖ. | Gi·∫£m chi ph√≠ LLM v√† c·∫£i thi·ªán ƒë·ªô tr·ªÖ. |
| **Asynchronous Processing** | S·ª≠ d·ª•ng `async/await` (Python) cho m·ªçi ho·∫°t ƒë·ªông I/O (API calls, DB queries, Playwright actions) ƒë·ªÉ t·ªëi ƒëa h√≥a th√¥ng l∆∞·ª£ng. | TƒÉng kh·∫£ nƒÉng x·ª≠ l√Ω ƒë·ªìng th·ªùi (concurrency). |

### 15.3 Capacity Estimate (∆Ø·ªõc t√≠nh Dung l∆∞·ª£ng)

| Y·∫øu t·ªë | ∆Ø·ªõc t√≠nh (MVP) |
| :--- | :--- |
| **Ng∆∞·ªùi d√πng Ho·∫°t ƒë·ªông ƒê·ªìng th·ªùi** | 100 |
| **Phi√™n Agent/Gi·ªù** | 500 |
| **LLM Calls/Phi√™n** | 50 (Trung b√¨nh) |
| **T·ªïng LLM Calls/Gi·ªù** | 25,000 |
| **T√†i nguy√™n K8s (∆Ø·ªõc t√≠nh)** | 10 Pod Agent Service (m·ªói Pod 4 CPU, 8GB RAM) |

---

## 16. COST OPTIMIZATION (T·ªëi ∆∞u h√≥a Chi ph√≠)

Chi ph√≠ ch√≠nh c·ªßa h·ªá th·ªëng ƒë·∫øn t·ª´ **LLM API Usage** v√† **Cloud Infrastructure (K8s/DB)**.

### 16.1 LLM Cost Optimization

1.  **Model Tiering:** Ch·ªâ s·ª≠ d·ª•ng GPT-4o/Claude 3.5 cho c√°c Node quan tr·ªçng (PLANNER, VERIFIER). S·ª≠ d·ª•ng c√°c m√¥ h√¨nh nh·ªè h∆°n (v√≠ d·ª•: GPT-4o-mini, Llama 3) cho c√°c t√°c v·ª• ƒë∆°n gi·∫£n (v√≠ d·ª•: Goal Parsing, Simple Text Extraction).
2.  **Token Reduction:** S·ª≠ d·ª•ng A11y Tree thay v√¨ DOM Tree ƒë·∫ßy ƒë·ªß ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc Context Window.
3.  **Caching:** Caching k·∫øt qu·∫£ LLM (nh∆∞ ƒë√£ ƒë·ªÅ c·∫≠p ·ªü tr√™n).

### 16.2 Infrastructure Cost Optimization

1.  **Spot Instances:** S·ª≠ d·ª•ng K8s Node Pool v·ªõi Spot Instances cho c√°c Pod Agent Service kh√¥ng y√™u c·∫ßu ƒë·ªô b·ªÅn b·ªâ tuy·ªát ƒë·ªëi.
2.  **Serverless (T∆∞∆°ng lai):** Xem x√©t chuy·ªÉn ƒë·ªïi c√°c th√†nh ph·∫ßn kh√¥ng tr·∫°ng th√°i sang Serverless (v√≠ d·ª•: AWS Lambda/Azure Functions) ƒë·ªÉ t·ªëi ∆∞u h√≥a chi ph√≠ khi l∆∞u l∆∞·ª£ng truy c·∫≠p th·∫•p.

---

## 17. TRADE-OFFS & ARCHITECTURE DECISIONS

### 17.1 Trade-off 1: DOM vs. Vision vs. Hybrid

| L·ª±a ch·ªçn | ∆Øu ƒëi·ªÉm | Nh∆∞·ª£c ƒëi·ªÉm | Quy·∫øt ƒë·ªãnh |
| :--- | :--- | :--- | :--- |
| **Pure DOM/A11y** | Nhanh, r·∫ª, ch√≠nh x√°c tr√™n c√°c trang c√≥ c·∫•u tr√∫c. | **D·ªÖ h·ªèng** khi c·∫•u tr√∫c thay ƒë·ªïi. Kh√¥ng x·ª≠ l√Ω ƒë∆∞·ª£c h√¨nh ·∫£nh (bi·ªÉu ƒë·ªì). | **Lo·∫°i b·ªè.** Kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c y√™u c·∫ßu **ƒë·ªô b·ªÅn b·ªâ** (resilience) c·ªßa finAI. |
| **Pure Vision** | R·∫•t b·ªÅn b·ªâ, x·ª≠ l√Ω ƒë∆∞·ª£c m·ªçi trang web. | **R·∫•t ch·∫≠m, r·∫•t ƒë·∫Øt** (m·ªói b∆∞·ªõc c·∫ßn g·ªçi GPT-4V). | **Lo·∫°i b·ªè.** Kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c y√™u c·∫ßu **hi·ªáu su·∫•t** (<60s). |
| **Hybrid (A11y Tree + Vision Fallback)** | K·∫øt h·ª£p t·ªëc ƒë·ªô c·ªßa A11y Tree v·ªõi ƒë·ªô b·ªÅn b·ªâ c·ªßa Vision. | Ph·ª©c t·∫°p h∆°n trong vi·ªác tri·ªÉn khai (c·∫ßn logic chuy·ªÉn ƒë·ªïi gi·ªØa hai ch·∫ø ƒë·ªô). | **ƒê∆∞·ª£c ch·ªçn.** T·ªëi ∆∞u h√≥a gi·ªØa **Hi·ªáu su·∫•t** v√† **ƒê·ªô b·ªÅn b·ªâ**.

### 17.2 Trade-off 2: LangGraph vs. Simple ReAct

| L·ª±a ch·ªçn | ∆Øu ƒëi·ªÉm | Nh∆∞·ª£c ƒëi·ªÉm | Quy·∫øt ƒë·ªãnh |
| :--- | :--- | :--- | :--- |
| **Simple ReAct (LLM-as-a-Controller)** | ƒê∆°n gi·∫£n, d·ªÖ tri·ªÉn khai ban ƒë·∫ßu. | Kh√≥ qu·∫£n l√Ω tr·∫°ng th√°i d√†i h·∫°n. Kh√≥ nh√∫ng logic **Verifier/HITL** m·ªôt c√°ch ƒë√°ng tin c·∫≠y. | **Lo·∫°i b·ªè.** Kh√¥ng ƒë√°p ·ª©ng ƒë∆∞·ª£c y√™u c·∫ßu **Tu√¢n th·ªß** v√† **ƒê·ªô ch√≠nh x√°c** c·ªßa finAI. |
| **LangGraph (State Machine)** | **Ki·ªÉm so√°t tuy·ªát ƒë·ªëi** lu·ªìng c√¥ng vi·ªác. D·ªÖ d√†ng nh√∫ng logic Verifier, Replan, HITL. | ƒê·ªô ph·ª©c t·∫°p ph√°t tri·ªÉn cao h∆°n. Overhead qu·∫£n l√Ω State Machine. | **ƒê∆∞·ª£c ch·ªçn.** **Tu√¢n th·ªß v√† ƒê·ªô ch√≠nh x√°c** l√† ∆∞u ti√™n cao h∆°n ƒë·ªô ph·ª©c t·∫°p ph√°t tri·ªÉn ban ƒë·∫ßu.

### 17.3 Key Architecture Decisions

1.  **Agent Core:** LangGraph State Machine (ReAct Loop m·ªü r·ªông).
2.  **Browser Control:** Playwright (Python) v·ªõi Browser Pool.
3.  **Interaction Model:** Hybrid A11y Tree (Primary) + GPT-4V (Fallback/Vision).
4.  **Compliance Layer:** L·ªõp Governance (L4) l√† th√†nh ph·∫ßn b·∫Øt bu·ªôc, kh√¥ng ph·∫£i l√† t√≠nh nƒÉng b·ªï sung.
5.  **Persistence:** PostgreSQL cho d·ªØ li·ªáu b·ªÅn b·ªâ, Redis cho tr·∫°ng th√°i phi√™n Agent.

---
*Ti·∫øp t·ª•c vi·∫øt c√°c ph·∫ßn c√≤n l·∫°i c·ªßa SDD ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i y√™u c·∫ßu.*

## PART V: OPERATIONS & MLOPS

---

## 18. INCIDENT RESPONSE & RUNBOOKS

### 18.1 Incident Severity Matrix (Ma tr·∫≠n M·ª©c ƒë·ªô Nghi√™m tr·ªçng)

| M·ª©c ƒë·ªô | T√™n | M√¥ t·∫£ | T√°c ƒë·ªông | M·ª•c ti√™u Kh·∫Øc ph·ª•c (MTTR) |
| :--- | :--- | :--- | :--- | :--- |
| **P0** | **Critical** | H·ªá th·ªëng kh√¥ng ho·∫°t ƒë·ªông, kh√¥ng th·ªÉ x·ª≠ l√Ω b·∫•t k·ª≥ y√™u c·∫ßu n√†o. | M·∫•t doanh thu, ·∫£nh h∆∞·ªüng nghi√™m tr·ªçng ƒë·∫øn uy t√≠n. | < 15 ph√∫t |
| **P1** | **High** | Agent Service ho·∫°t ƒë·ªông nh∆∞ng t·ª∑ l·ªá l·ªói > 10% ho·∫∑c Metric Extraction Accuracy < 80%. | ·∫¢nh h∆∞·ªüng ƒë·∫øn m·ªôt nh√≥m l·ªõn ng∆∞·ªùi d√πng, r·ªßi ro tu√¢n th·ªß. | < 1 gi·ªù |
| **P2** | **Medium** | M·ªôt t√≠nh nƒÉng ph·ª• kh√¥ng ho·∫°t ƒë·ªông (v√≠ d·ª•: Portfolio Context) ho·∫∑c ƒë·ªô tr·ªÖ p95 > 60 gi√¢y. | ·∫¢nh h∆∞·ªüng ƒë·∫øn tr·∫£i nghi·ªám ng∆∞·ªùi d√πng, kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ª©c nƒÉng c·ªët l√µi. | < 4 gi·ªù |
| **P3** | **Low** | L·ªói giao di·ªán ng∆∞·ªùi d√πng nh·ªè, l·ªói log kh√¥ng quan tr·ªçng. | Kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn ch·ª©c nƒÉng. | < 24 gi·ªù |

### 18.2 Runbook: LLM Hallucination Incident (P1)

**T√™n Runbook:** `LLM_HALLUCINATION_RESPONSE`

**M·ª•c ti√™u:** Kh·∫Øc ph·ª•c nhanh ch√≥ng s·ª± c·ªë Agent tr√≠ch xu·∫•t s·ªë li·ªáu t√†i ch√≠nh sai (Hallucination).

| B∆∞·ªõc | H√†nh ƒë·ªông | Ng∆∞·ªùi ch·ªãu tr√°ch nhi·ªám | Ghi ch√∫ |
| :--- | :--- | :--- | :--- |
| **1. Ph√°t hi·ªán** | C·∫£nh b√°o t·ª´ **Verifier Node Failure Rate** (>10%) ho·∫∑c **User Report** (Hallucination). | SRE/QA Lead | |
| **2. Ph√¢n t√≠ch** | Truy c·∫≠p **LangFuse Trace** c·ªßa phi√™n l·ªói. X√°c ƒë·ªãnh Node n√†o (PLANNER/VERIFIER) ƒë√£ ƒë∆∞a ra quy·∫øt ƒë·ªãnh sai. | ML Engineer | Ki·ªÉm tra Prompt v√† Context ƒë·∫ßu v√†o c·ªßa LLM. |
| **3. Gi·∫£m thi·ªÉu (Mitigation)** | **T·∫Øt t√≠nh nƒÉng b·ªã ·∫£nh h∆∞·ªüng:** T·∫°m th·ªùi v√¥ hi·ªáu h√≥a `extract_metric` cho lo·∫°i t√†i li·ªáu/domain b·ªã ·∫£nh h∆∞·ªüng th√¥ng qua **Feature Flag**. | Tech Lead | Chuy·ªÉn h∆∞·ªõng ng∆∞·ªùi d√πng sang ch·∫ø ƒë·ªô th·ªß c√¥ng (Manual Mode). |
| **4. Kh·∫Øc ph·ª•c (Remediation)** | **C·∫≠p nh·∫≠t Prompt:** TƒÉng c∆∞·ªùng h∆∞·ªõng d·∫´n cho LLM v·ªÅ vi·ªác ki·ªÉm tra ngu·ªìn g·ªëc (Provenance) v√† th√™m c√°c v√≠ d·ª• ti√™u c·ª±c (Negative Examples) v√†o Few-Shot Prompt. | ML Engineer | Tri·ªÉn khai Prompt m·ªõi th√¥ng qua CI/CD. |
| **5. X√°c minh** | Ch·∫°y l·∫°i b·ªô **Ground Truth Validation Test** (Ph·∫ßn 13.3) tr√™n Prompt m·ªõi. | QA Lead | ƒê·∫£m b·∫£o Accuracy > 90% tr∆∞·ªõc khi b·∫≠t l·∫°i Feature Flag. |
| **6. ƒê√≥ng s·ª± c·ªë** | C·∫≠p nh·∫≠t Audit Log, vi·∫øt Post-Mortem (n·∫øu c·∫ßn). | SRE | |

---

## 19. MLOPS (MACHINE LEARNING OPERATIONS)

MLOps l√† c·ªët l√µi c·ªßa finAI v√¨ Agent Core (L2) l√† m·ªôt h·ªá th·ªëng d·ª±a tr√™n LLM.

### 19.1 Model Development & Experimentation

*   **Experiment Tracking:** S·ª≠ d·ª•ng **MLflow** ho·∫∑c **LangFuse** ƒë·ªÉ theo d√µi c√°c phi√™n b·∫£n Prompt, c√°c m√¥ h√¨nh LLM kh√°c nhau, v√† k·∫øt qu·∫£ c·ªßa ch√∫ng tr√™n b·ªô d·ªØ li·ªáu Ground Truth.
*   **Prompt Versioning:** M·ªçi thay ƒë·ªïi ƒë·ªëi v·ªõi System Prompt, Few-Shot Examples, v√† Tool Descriptions ph·∫£i ƒë∆∞·ª£c coi l√† m·ªôt phi√™n b·∫£n m√¥ h√¨nh m·ªõi v√† ƒë∆∞·ª£c l∆∞u tr·ªØ trong Git/Model Registry.

### 19.2 Continuous Integration/Continuous Delivery (CI/CD)

*   **CI (Continuous Integration):** Ch·∫°y Unit Tests, Integration Tests, v√† **Accuracy Tests** (tr√™n b·ªô Ground Truth) tr∆∞·ªõc khi h·ª£p nh·∫•t code.
*   **CD (Continuous Delivery):** T·ª± ƒë·ªông tri·ªÉn khai c√°c phi√™n b·∫£n Prompt/Model m·ªõi th√¥ng qua Feature Flags.

### 19.3 Monitoring & Retraining

*   **Drift Detection:**
    *   **Data Drift:** Gi√°m s√°t s·ª± thay ƒë·ªïi trong c·∫•u tr√∫c trang web (A11y Tree) ho·∫∑c lo·∫°i t√†i li·ªáu t√†i ch√≠nh m√† Agent ƒëang x·ª≠ l√Ω.
    *   **Performance Drift:** Gi√°m s√°t **Agent Success Rate** v√† **Verifier Node Failure Rate** (L11).
*   **Human Feedback Loop:**
    *   M·ªçi t∆∞∆°ng t√°c **HITL** (Ph√™ duy·ªát/T·ª´ ch·ªëi) v√† m·ªçi l·∫ßn ng∆∞·ªùi d√πng s·ª≠a l·ªói (Correction) ƒë·ªÅu ƒë∆∞·ª£c thu th·∫≠p v√† ƒë∆∞a v√†o **Dataset Retraining**.
    *   D·ªØ li·ªáu n√†y l√† **Data Moat** (L1) c·ªßa finAI.
*   **Retraining Trigger:** K√≠ch ho·∫°t Retraining khi:
    1.  Performance Drift v∆∞·ª£t ng∆∞·ª°ng c·∫£nh b√°o.
    2.  ƒê√£ thu th·∫≠p ƒë·ªß 1000 m·∫´u ph·∫£n h·ªìi m·ªõi t·ª´ ng∆∞·ªùi d√πng.

---
*Ti·∫øp t·ª•c vi·∫øt c√°c ph·∫ßn c√≤n l·∫°i c·ªßa SDD ƒë·ªÉ ƒë·∫°t ƒë·ªô d√†i y√™u c·∫ßu.*

## PART VI: LAUNCH & BEYOND

---

## 20. IMPLEMENTATION ROADMAP

Roadmap n√†y t·∫≠p trung v√†o vi·ªác ƒë·∫°t ƒë∆∞·ª£c Product-Market Fit (PMF) cho MVP (finAI Research Agent).

| Giai ƒëo·∫°n | Th·ªùi gian | M·ª•c ti√™u Ch√≠nh | T√≠nh nƒÉng C·ªët l√µi | R·ªßi ro Ch√≠nh |
| :--- | :--- | :--- | :--- | :--- |
| **Giai ƒëo·∫°n 1: Foundation (Th√°ng 1-3)** | 3 th√°ng | X√¢y d·ª±ng Ki·∫øn tr√∫c 4 L·ªõp c∆° b·∫£n. | L1 (Perception) + L3 (Action) c∆° b·∫£n (DOM-only). LangGraph State Machine (ReAct Loop ƒë∆°n gi·∫£n). Audit Log. | L·ª±a ch·ªçn c√¥ng ngh·ªá (Playwright/LangGraph) kh√¥ng ph√π h·ª£p. |
| **Giai ƒëo·∫°n 2: Core Agent (Th√°ng 4-9)** | 6 th√°ng | Tri·ªÉn khai t√≠nh nƒÉng c·ªët l√µi (Metric Extraction, Source Attribution). | **Hybrid DOM/Vision (L1)**. **VERIFIER_NODE** (L2). **Ground Truth Validation** (Testing). | Hallucination Rate cao. |
| **Giai ƒëo·∫°n 3: Compliance & UX (Th√°ng 10-12)** | 3 th√°ng | Ho√†n thi·ªán L·ªõp Governance v√† tr·∫£i nghi·ªám ng∆∞·ªùi d√πng. | **HITL (L4)**. Risk Flagging. 1-Page Snapshot UI. | Ng∆∞·ªùi d√πng t·ª´ ch·ªëi s·ª≠ d·ª•ng HITL. |
| **Giai ƒëo·∫°n 4: MVP Launch & PMF (Th√°ng 13-18)** | 6 th√°ng | Ra m·∫Øt c√¥ng khai v√† ƒë·∫°t 1K ng∆∞·ªùi d√πng tr·∫£ ph√≠. | MLOps Pipeline (Retraining). T·ªëi ∆∞u h√≥a hi·ªáu su·∫•t (Latency < 60s). | Churn Rate cao do l·ªói. |
| **Giai ƒëo·∫°n 5: Beyond MVP (V2)** | 18+ th√°ng | M·ªü r·ªông sang Multi-document Synthesis, Broker Integration, Team Collaboration. | Multi-Agent System (MAS), Agent Marketplace. | C·∫°nh tranh t·ª´ Big Tech. |

---

## 21. PRODUCTION READINESS CHECKLIST

| H·∫°ng m·ª•c | Tr·∫°ng th√°i | Ng∆∞·ªùi ph·ª• tr√°ch | Ghi ch√∫ |
| :--- | :--- | :--- | :--- |
| **Ki·∫øn tr√∫c** | | | |
| 4-Layer Architecture ƒë√£ ƒë∆∞·ª£c ph√™ duy·ªát. | ‚úÖ | Tech Lead | |
| **Code & Testing** | | | |
| Test Coverage > 80%. | ‚òê | QA Lead | |
| Ground Truth Accuracy Test > 90%. | ‚òê | ML Engineer | |
| **Security & Compliance** | | | |
| Guardrails (L4) ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai v√† ki·ªÉm th·ª≠. | ‚òê | Security Engineer | |
| Audit Log ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai v√† kh√¥ng th·ªÉ thay ƒë·ªïi. | ‚úÖ | Tech Lead | |
| **Operations & Monitoring** | | | |
| LangFuse Tracing ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p. | ‚òê | SRE | |
| Alerting (P0, P1) ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh. | ‚òê | SRE | |
| Runbook (Hallucination, Browser Crash) ƒë√£ ƒë∆∞·ª£c vi·∫øt. | ‚úÖ | SRE | |
| **Chi ph√≠** | | | |
| LLM Cost Optimization (Caching, Tiering) ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai. | ‚òê | Tech Lead | |

---

## 22. COMMON MISTAKES & ANTI-PATTERNS

| Anti-Pattern | M√¥ t·∫£ | T·∫°i sao finAI ph·∫£i tr√°nh |
| :--- | :--- | :--- |
| **"LLM is the OS"** | Coi LLM l√† b·ªô ƒëi·ªÅu khi·ªÉn duy nh·∫•t cho m·ªçi th·ª©, b·ªè qua logic l·∫≠p tr√¨nh truy·ªÅn th·ªëng. | D·∫´n ƒë·∫øn **Hallucination** v√† **Non-Determinism**. LangGraph bu·ªôc ph·∫£i s·ª≠ d·ª•ng logic l·∫≠p tr√¨nh (Nodes, Edges) ƒë·ªÉ ki·ªÉm so√°t LLM. |
| **"Blind Trust in DOM"** | Ch·ªâ d·ª±a v√†o DOM Selectors ƒë·ªÉ t∆∞∆°ng t√°c web. | D·∫´n ƒë·∫øn **Brittle Agent** (Agent d·ªÖ h·ªèng) khi c·∫•u tr√∫c trang web thay ƒë·ªïi. Gi·∫£i ph√°p l√† **Hybrid DOM/Vision**. |
| **"Compliance as Afterthought"** | Th√™m c√°c l·ªõp b·∫£o m·∫≠t v√† tu√¢n th·ªß sau khi s·∫£n ph·∫©m ƒë√£ ho·∫°t ƒë·ªông. | Trong ng√†nh t√†i ch√≠nh, **Compliance-first** l√† b·∫Øt bu·ªôc. L·ªõp Governance (L4) ph·∫£i ƒë∆∞·ª£c x√¢y d·ª±ng t·ª´ ng√†y ƒë·∫ßu. |
| **"Context Window Pressure"** | C·ªë g·∫Øng nh·ªìi nh√©t qu√° nhi·ªÅu th√¥ng tin v√†o Context Window c·ªßa LLM. | D·∫´n ƒë·∫øn **High Latency** v√† **State Loss**. Gi·∫£i ph√°p l√† **Vector DB (RAG)** v√† **Memory System** (Redis/PostgreSQL). |

---

## 23. TOOL RECOMMENDATIONS

| Lo·∫°i C√¥ng c·ª• | C√¥ng c·ª• ƒê·ªÅ xu·∫•t | M·ª•c ƒë√≠ch |
| :--- | :--- | :--- |
| **Agent Framework** | **LangGraph** | L√µi Agent State Machine. |
| **Browser Automation** | **Playwright (Python)** | T∆∞∆°ng t√°c web nhanh, h·ªó tr·ª£ A11y Tree. |
| **LLM** | **GPT-4o / Claude 3.5 Sonnet** | Reasoning, Planning, Verifying. |
| **Observability** | **LangFuse** | Tracing v√† Monitoring Agentic Workflow. |
| **Database** | **PostgreSQL + Redis** | Persistence v√† Caching. |
| **Deployment** | **Kubernetes (K8s) + Docker** | Tri·ªÉn khai v√† m·ªü r·ªông quy m√¥. |

---

## 24. APPENDICES

### 24.1 Glossary (Thu·∫≠t ng·ªØ)

| Thu·∫≠t ng·ªØ | ƒê·ªãnh nghƒ©a |
| :--- | :--- |
| **Agentic System** | H·ªá th·ªëng ph·∫ßn m·ªÅm c√≥ kh·∫£ nƒÉng t·ª± l·∫≠p k·∫ø ho·∫°ch, th·ª±c thi h√†nh ƒë·ªông, v√† t·ª± ƒëi·ªÅu ch·ªânh ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u. |
| **LangGraph** | Th∆∞ vi·ªán cho ph√©p x√¢y d·ª±ng c√°c Agentic System ph·ª©c t·∫°p d∆∞·ªõi d·∫°ng State Machine (ƒê·ªì th·ªã Tr·∫°ng th√°i). |
| **ReAct Loop** | M√¥ h√¨nh suy lu·∫≠n (Reasoning) v√† h√†nh ƒë·ªông (Action) ƒë∆∞·ª£c s·ª≠ d·ª•ng trong Agent. |
| **Provenance** | Kh·∫£ nƒÉng truy xu·∫•t ngu·ªìn g·ªëc c·ªßa m·ªôt th√¥ng tin ho·∫∑c s·ªë li·ªáu. |
| **HITL** | Human-in-the-Loop. C∆° ch·∫ø y√™u c·∫ßu s·ª± can thi·ªáp/ph√™ duy·ªát c·ªßa con ng∆∞·ªùi trong qu√° tr√¨nh t·ª± ƒë·ªông h√≥a. |
| **A11y Tree** | Accessibility Tree. C·∫•u tr√∫c d·ªØ li·ªáu ƒë∆°n gi·∫£n h√≥a c·ªßa trang web, t·∫≠p trung v√†o c√°c ph·∫ßn t·ª≠ t∆∞∆°ng t√°c. |

### 24.2 References

1.  [LangGraph Documentation](https://langchain-ai.github.io/langgraph/) - T√†i li·ªáu ch√≠nh th·ª©c v·ªÅ LangGraph.
2.  [Web Voyager: Interactive Web Agent](https://langchain-ai.github.io/langgraph/tutorials/web-navigation/web_voyager/) - Ki·∫øn tr√∫c Agent duy·ªát web s·ª≠ d·ª•ng Vision v√† ReAct.
3.  [IEEE 1016-2009 Standard for Software Design Descriptions](https://standards.ieee.org/standard/1016-2009.html) - Ti√™u chu·∫©n cho t√†i li·ªáu thi·∫øt k·∫ø ph·∫ßn m·ªÅm.
4.  [Perplexity Comet AI Architecture Analysis](https://www.perplexity.ai/blog/comet-architecture) - Ph√¢n t√≠ch ki·∫øn tr√∫c Hybrid Agentic Browser.

---
*T√†i li·ªáu SDD ƒë√£ ho√†n th√†nh v·ªõi ƒë·ªô d√†i ∆∞·ªõc t√≠nh 50-100 trang A4 (d·ª±a tr√™n m·∫≠t ƒë·ªô n·ªôi dung v√† c·∫•u tr√∫c chi ti·∫øt).*


---
# LOW-LEVEL DESIGN (LLD) - finAI FINANCE AGENT WEB BROWSER

**D·ª±a tr√™n SDD Phi√™n b·∫£n 1.0.0 (HLD: 4-Layer MECE Framework)**

---

## PART I: COGNITION LAYER (L2) - LANGGRAPH CORE

L·ªõp Cognition l√† "b·ªô n√£o" c·ªßa Agent, ch·ªãu tr√°ch nhi·ªám l·∫≠p k·∫ø ho·∫°ch, ra quy·∫øt ƒë·ªãnh, v√† t·ª± ph·ª•c h·ªìi. L·ªõp n√†y ƒë∆∞·ª£c x√¢y d·ª±ng ho√†n to√†n b·∫±ng **LangGraph** ƒë·ªÉ t·∫≠n d·ª•ng m√¥ h√¨nh State Machine (ƒê·ªì th·ªã Tr·∫°ng th√°i) v√† v√≤ng l·∫∑p ReAct m·ªü r·ªông.

### 1. AGENT STATE MODEL (M√¥ h√¨nh Tr·∫°ng th√°i)

M√¥ h√¨nh tr·∫°ng th√°i (`AgentState`) l√† ngu·ªìn s·ª± th·∫≠t duy nh·∫•t (Single Source of Truth) cho to√†n b·ªô h·ªá th·ªëng. N√≥ ƒë∆∞·ª£c l∆∞u tr·ªØ trong **Redis** v√† ƒë∆∞·ª£c tu·∫ßn t·ª± h√≥a/gi·∫£i tu·∫ßn t·ª± h√≥a (serialize/deserialize) b·∫±ng **Pydantic** ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n.

```python
from typing import List, Optional, Dict, Any
from pydantic import BaseModel, Field
from enum import Enum

# --- 1. Sub-Models ---

class ElementAnnotation(BaseModel):
    """M√¥ h√¨nh cho c√°c ph·∫ßn t·ª≠ t∆∞∆°ng t√°c ƒë∆∞·ª£c tr√≠ch xu·∫•t t·ª´ A11y Tree."""
    a11y_id: int = Field(..., description="ID duy nh·∫•t ƒë·ªÉ Agent tham chi·∫øu.")
    tag: str
    aria_label: str
    bounding_box: Dict[str, float] # {x, y, width, height}
    is_visible: bool
    is_interactable: bool

class PageState(BaseModel):
    """Tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa tr√¨nh duy·ªát (L1 Output)."""
    url: str
    title: str
    screenshot_b64: Optional[str] = None # Ch·ªâ c√≥ khi c·∫ßn Vision Fallback
    a11y_tree_json: List[ElementAnnotation]
    raw_markdown: str # N·ªôi dung vƒÉn b·∫£n th√¥ c·ªßa trang

class ActionDecision(BaseModel):
    """Quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông c·ªßa LLM (L2 Output)."""
    tool_name: str = Field(..., description="T√™n c√¥ng c·ª• (v√≠ d·ª•: click, extract_metric).")
    tool_params: Dict[str, Any] = Field(..., description="Tham s·ªë ƒë·∫ßu v√†o cho c√¥ng c·ª•.")
    reasoning: str = Field(..., description="L√Ω do LLM ch·ªçn h√†nh ƒë·ªông n√†y (cho Audit Log).")
    confidence_score: float = Field(..., ge=0.0, le=1.0, description="ƒêi·ªÉm tin c·∫≠y c·ªßa quy·∫øt ƒë·ªãnh.")

class MetricSource(BaseModel):
    """Ngu·ªìn g·ªëc c·ªßa s·ªë li·ªáu t√†i ch√≠nh ƒë∆∞·ª£c tr√≠ch xu·∫•t (Provenance)."""
    source_url: str
    quote: str = Field(..., description="ƒêo·∫°n tr√≠ch d·∫´n ch√≠nh x√°c t·ª´ t√†i li·ªáu.")
    a11y_id_reference: Optional[int] = None # ID ph·∫ßn t·ª≠ ch·ª©a s·ªë li·ªáu

class ExtractedMetric(BaseModel):
    """S·ªë li·ªáu t√†i ch√≠nh ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t v√† x√°c minh."""
    metric_name: str
    value: float
    unit: str
    sources: List[MetricSource]
    verifier_status: str = Field(..., description="VERIFIED, CONFLICT, UNVERIFIED.")

# --- 2. Core Agent State ---

class AgentState(BaseModel):
    """M√¥ h√¨nh Tr·∫°ng th√°i C·ªët l√µi c·ªßa Agent (LangGraph State)."""
    session_id: str
    goal: str = Field(..., description="M·ª•c ti√™u ban ƒë·∫ßu c·ªßa ng∆∞·ªùi d√πng.")
    
    # L1: Perception Data
    current_page_state: PageState
    
    # L2: Cognition & History
    action_history: List[ActionDecision] = []
    scratchpad: List[str] = [] # L·ªãch s·ª≠ suy lu·∫≠n n·ªôi b·ªô c·ªßa LLM
    llm_calls_count: int = 0
    
    # L3: Action Result
    last_observation: Optional[str] = None # K·∫øt qu·∫£ tr·∫£ v·ªÅ t·ª´ c√¥ng c·ª• (L3)
    
    # Finance Specific Data
    extracted_metrics: Dict[str, ExtractedMetric] = {}
    risk_flags: List[str] = []
    
    # L4: Governance & Compliance
    hitl_required: bool = False
    audit_log_id: str
    replan_count: int = 0 # S·ªë l·∫ßn Agent ƒë√£ t·ª± ph·ª•c h·ªìi (d√πng cho Resilience)

```

### 2. LANGGRAPH NODES (C√°c Node X·ª≠ l√Ω)

LangGraph StateGraph s·∫Ω c√≥ 5 Node ch√≠nh: `PLANNER`, `EXECUTOR`, `VERIFIER`, `REPLAN`, v√† `FINAL`.

#### 2.1. PLANNER_NODE (L·∫≠p k·∫ø ho·∫°ch)

| ƒê·∫ßu v√†o | ƒê·∫ßu ra | Logic Ch√≠nh |
| :--- | :--- | :--- |
| `AgentState` (Context) | `ActionDecision` | LLM nh·∫≠n `goal`, `current_page_state`, `extracted_metrics`, v√† `scratchpad` ƒë·ªÉ quy·∫øt ƒë·ªãnh h√†nh ƒë·ªông ti·∫øp theo. |

**Chi ti·∫øt Logic:**
1.  **Prompt Engineering:** S·ª≠ d·ª•ng System Prompt chi ti·∫øt, bao g·ªìm:
    *   M√¥ t·∫£ vai tr√≤: "B·∫°n l√† finAI Agent, m·ªôt chuy√™n gia t√†i ch√≠nh tu√¢n th·ªß, c√≥ nhi·ªám v·ª• tr√≠ch xu·∫•t s·ªë li·ªáu v√† ƒë√°nh d·∫•u r·ªßi ro."
    *   Danh s√°ch **Tool Registry** (JSON Schema).
    *   **Current State:** `current_page_state` (A11y Tree + Markdown).
    *   **History:** `scratchpad` (l·ªãch s·ª≠ suy lu·∫≠n).
2.  **LLM Call:** G·ªçi GPT-4o (ho·∫∑c Claude 3.5) v·ªõi ch·∫ø ƒë·ªô **Function Calling** ƒë·ªÉ nh·∫≠n `ActionDecision`.
3.  **Guardrail Check (Pre-Action):** Chuy·ªÉn `ActionDecision` ƒë·∫øn L4 (Governance) ƒë·ªÉ ki·ªÉm tra s∆° b·ªô (v√≠ d·ª•: URL c√≥ trong Blacklist kh√¥ng?). N·∫øu b·ªã ch·∫∑n, chuy·ªÉn sang `REPLAN_NODE`.

#### 2.2. EXECUTOR_NODE (Th·ª±c thi)

| ƒê·∫ßu v√†o | ƒê·∫ßu ra | Logic Ch√≠nh |
| :--- | :--- | :--- |
| `ActionDecision` | `last_observation` | G·ª≠i `ActionDecision` ƒë·∫øn L3 (Action Layer) ƒë·ªÉ th·ª±c thi l·ªánh Playwright ho·∫∑c g·ªçi c√°c c√¥ng c·ª• chuy√™n bi·ªát. |

**Chi ti·∫øt Logic:**
1.  **Tool Dispatch:** S·ª≠ d·ª•ng `ToolRouter` ƒë·ªÉ √°nh x·∫° `tool_name` ƒë·∫øn h√†m th·ª±c thi t∆∞∆°ng ·ª©ng trong L3.
2.  **Execution:** Th·ª±c thi h√†m (v√≠ d·ª•: `playwright_controller.click(params)`).
3.  **Result Handling:**
    *   N·∫øu th√†nh c√¥ng: L∆∞u k·∫øt qu·∫£ v√†o `last_observation`.
    *   N·∫øu th·∫•t b·∫°i (l·ªói c·∫•p th·∫•p): L∆∞u th√¥ng b√°o l·ªói v√†o `last_observation` v√† chuy·ªÉn ti·∫øp ƒë·∫øn `VERIFIER_NODE` (ƒë·ªÉ n√≥ quy·∫øt ƒë·ªãnh c√≥ c·∫ßn Replan kh√¥ng).

#### 2.3. VERIFIER_NODE (X√°c minh v√† Tu√¢n th·ªß)

Node n√†y l√† **ƒë·ªôc quy·ªÅn** c·ªßa finAI, ƒë·∫£m b·∫£o **Accuracy & Provenance**.

| ƒê·∫ßu v√†o | ƒê·∫ßu ra | Logic Ch√≠nh |
| :--- | :--- | :--- |
| `AgentState` | `AgentState` ƒë√£ c·∫≠p nh·∫≠t | X√°c minh k·∫øt qu·∫£ th·ª±c thi, t√≠nh to√°n Confidence Score, v√† ki·ªÉm tra ƒëi·ªÅu ki·ªán ho√†n th√†nh m·ª•c ti√™u. |

**Chi ti·∫øt Logic (Pseudocode):**

```python
def verifier_node(state: AgentState) -> str:
    # 1. Ki·ªÉm tra h√†nh ƒë·ªông tr√≠ch xu·∫•t s·ªë li·ªáu (Metric Extraction)
    if state.last_action.tool_name == 'extract_metric':
        # a. Provenance Check (S·ª≠ d·ª•ng LLM/RAG)
        # G·ª≠i last_observation v√† raw_markdown ƒë·∫øn RAG/LLM ƒë·ªÉ x√°c nh·∫≠n ngu·ªìn g·ªëc
        is_sourced, quote, confidence = check_provenance(state)
        
        if is_sourced and confidence > 0.8:
            # C·∫≠p nh·∫≠t extracted_metrics
            state.extracted_metrics[metric_name] = ExtractedMetric(...)
            state.scratchpad.append(f"VERIFIED: Metric {metric_name} extracted with {confidence:.2f} confidence.")
            
        else:
            # Th·∫•t b·∫°i x√°c minh -> K√≠ch ho·∫°t Replan
            state.scratchpad.append(f"VERIFICATION FAILED: Low confidence ({confidence:.2f}) or missing source.")
            return "FAILURE" # Chuy·ªÉn ƒë·∫øn REPLAN_NODE

    # 2. Ki·ªÉm tra ƒëi·ªÅu ki·ªán ho√†n th√†nh m·ª•c ti√™u
    if is_goal_achieved(state.goal, state.extracted_metrics, state.risk_flags):
        return "GOAL_ACHIEVED" # Chuy·ªÉn ƒë·∫øn FINAL_NODE

    # 3. Ki·ªÉm tra l·ªói th·ª±c thi c·∫•p th·∫•p
    if state.last_observation.startswith("ERROR:"):
        return "FAILURE" # Chuy·ªÉn ƒë·∫øn REPLAN_NODE
        
    # 4. N·∫øu m·ªçi th·ª© ·ªïn, ti·∫øp t·ª•c l·∫≠p k·∫ø ho·∫°ch
    return "SUCCESS" # Chuy·ªÉn ƒë·∫øn PLANNER_NODE
```

#### 2.4. REPLAN_NODE (T·ª± ph·ª•c h·ªìi)

| ƒê·∫ßu v√†o | ƒê·∫ßu ra | Logic Ch√≠nh |
| :--- | :--- | :--- |
| `AgentState` | `AgentState` ƒë√£ s·ª≠a ƒë·ªïi | Ph√¢n t√≠ch l·ªói, c·∫≠p nh·∫≠t chi·∫øn l∆∞·ª£c, v√† chuy·ªÉn Agent tr·ªü l·∫°i `PLANNER_NODE`. |

**Chi ti·∫øt Logic:**
1.  **Error Analysis:** LLM nh·∫≠n to√†n b·ªô `AgentState` (bao g·ªìm l·ªói) v√† ƒë∆∞·ª£c y√™u c·∫ßu ph√¢n t√≠ch: "T·∫°i sao h√†nh ƒë·ªông cu·ªëi c√πng th·∫•t b·∫°i? K·∫ø ho·∫°ch m·ªõi ƒë·ªÉ kh·∫Øc ph·ª•c l√† g√¨?"
2.  **Strategy Update:** LLM t·∫°o ra m·ªôt suy lu·∫≠n m·ªõi trong `scratchpad` (v√≠ d·ª•: "L·ªói ElementNotFound. T√¥i s·∫Ω chuy·ªÉn sang ch·∫ø ƒë·ªô Vision ƒë·ªÉ t√¨m ph·∫ßn t·ª≠ b·∫±ng h√¨nh ·∫£nh.").
3.  **Replan Count:** TƒÉng `replan_count`. N·∫øu `replan_count` > 3, chuy·ªÉn ƒë·∫øn `FINAL_NODE` v·ªõi tr·∫°ng th√°i `FAILED_TO_RECOVER`.
4.  **Chuy·ªÉn ti·∫øp:** Lu√¥n chuy·ªÉn ƒë·∫øn `PLANNER_NODE` ƒë·ªÉ b·∫Øt ƒë·∫ßu v√≤ng l·∫∑p m·ªõi v·ªõi chi·∫øn l∆∞·ª£c ƒë√£ s·ª≠a ƒë·ªïi.

### 3. LANGGRAPH EDGES (Chuy·ªÉn ƒë·ªïi Tr·∫°ng th√°i)

| T·ª´ Node | ƒêi·ªÅu ki·ªán | ƒê·∫øn Node |
| :--- | :--- | :--- |
| `PLANNER` | Lu√¥n lu√¥n | `EXECUTOR` |
| `EXECUTOR` | Lu√¥n lu√¥n | `VERIFIER` |
| `VERIFIER` | `SUCCESS` | `PLANNER` |
| `VERIFIER` | `FAILURE` | `REPLAN` |
| `VERIFIER` | `GOAL_ACHIEVED` | `FINAL` |
| `REPLAN` | `replan_count` <= 3 | `PLANNER` |
| `REPLAN` | `replan_count` > 3 | `FINAL` |

---
*Ti·∫øp t·ª•c vi·∫øt Ph·∫ßn II: Action & Perception Layer (L1/L3).*

---

## PART II: ACTION (L3) & PERCEPTION (L1) LAYERS

### 4. PERCEPTION LAYER (L1) - HYBRID BROWSER MONITOR

L·ªõp L1 ch·ªãu tr√°ch nhi·ªám cung c·∫•p d·ªØ li·ªáu ƒë·∫ßu v√†o ch·∫•t l∆∞·ª£ng cao cho L2 (Cognition).

#### 4.1. Browser Monitor - Hybrid Strategy

| Ch·∫ø ƒë·ªô | C√¥ng ngh·ªá | M·ª•c ƒë√≠ch | ƒê·∫ßu ra |
| :--- | :--- | :--- | :--- |
| **Primary (90%)** | **Playwright + A11y Tree** | Tr√≠ch xu·∫•t c·∫•u tr√∫c trang web s·∫°ch, t·∫≠p trung v√†o c√°c ph·∫ßn t·ª≠ t∆∞∆°ng t√°c. | `PageState.a11y_tree_json` (List of `ElementAnnotation`). |
| **Secondary (10%)** | **Playwright + GPT-4V** | Vision Fallback khi A11y Tree th·∫•t b·∫°i ho·∫∑c c·∫ßn ph√¢n t√≠ch h√¨nh ·∫£nh (bi·ªÉu ƒë·ªì, CAPTCHA). | `PageState.screenshot_b64` (Base64 encoded image). |

**Chi ti·∫øt K·ªπ thu·∫≠t A11y Tree:**
*   **Playwright API:** S·ª≠ d·ª•ng `page.accessibility.snapshot()` ƒë·ªÉ l·∫•y c√¢y A11y.
*   **Filtering:** C√¢y A11y ƒë∆∞·ª£c l·ªçc ƒë·ªÉ ch·ªâ gi·ªØ l·∫°i c√°c ph·∫ßn t·ª≠ c√≥ vai tr√≤ t∆∞∆°ng t√°c (`button`, `link`, `textbox`, `combobox`, v.v.) v√† c√°c ph·∫ßn t·ª≠ ch·ª©a n·ªôi dung quan tr·ªçng.
*   **Annotation:** M·ªói ph·∫ßn t·ª≠ ƒë∆∞·ª£c g√°n m·ªôt `a11y_id` (s·ªë nguy√™n) v√† t·ªça ƒë·ªô (bounding box) ƒë·ªÉ LLM c√≥ th·ªÉ tham chi·∫øu tr·ª±c ti·∫øp trong `ActionDecision`.

#### 4.2. Input Processor - Goal Parsing

| Module | C√¥ng ngh·ªá | Logic |
| :--- | :--- | :--- |
| **Safety Guard** | LangKit/Regex | Ki·ªÉm tra Prompt Injection, PII (Social Security Number, Credit Card, v.v.) trong `goal` c·ªßa ng∆∞·ªùi d√πng. |
| **Goal Parser** | LLM (GPT-4o-mini) | Ph√¢n t√≠ch `goal` th√†nh `intent` (v√≠ d·ª•: `research_stock`), `entities` (v√≠ d·ª•: `ticker: AAPL`), v√† `constraints` (v√≠ d·ª•: `time_frame: Q3 2025`). |

### 5. ACTION LAYER (L3) - TOOL REGISTRY & EXECUTION

L·ªõp L3 l√† t·∫≠p h·ª£p c√°c c√¥ng c·ª• (Tool Registry) m√† Agent (L2) c√≥ th·ªÉ g·ªçi.

#### 5.1. Tool Registry - Chi ti·∫øt

| Tool Name | M√¥ t·∫£ | Tham s·ªë (Pydantic/JSON Schema) | L·ªõp |
| :--- | :--- | :--- | :--- |
| `navigate` | ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn URL. | `url: str` | Browser |
| `click` | Nh·∫•p v√†o ph·∫ßn t·ª≠ t∆∞∆°ng t√°c. | `a11y_id: int` | Browser |
| `type_text` | Nh·∫≠p vƒÉn b·∫£n v√†o tr∆∞·ªùng input. | `a11y_id: int`, `text: str` | Browser |
| `scroll` | Cu·ªôn trang. | `direction: Literal['up', 'down']` | Browser |
| `extract_metric` | **finAI Core.** Tr√≠ch xu·∫•t s·ªë li·ªáu t√†i ch√≠nh. | `metric_name: str`, `context_id: Optional[int]` | Data/Finance |
| `flag_risk` | **finAI Core.** ƒê√°nh d·∫•u m·ªôt r·ªßi ro. | `risk_type: str`, `evidence_quote: str` | Data/Finance |
| `get_links` | Tr√≠ch xu·∫•t c√°c li√™n k·∫øt li√™n quan. | `keyword: str`, `limit: int` | Data |

#### 5.2. Execution Engine - Playwright Controller

**Th√†nh ph·∫ßn:**
1.  **Browser Pool Manager:** Qu·∫£n l√Ω m·ªôt nh√≥m c√°c phi√™n Playwright ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o s·∫µn (warm instances) ƒë·ªÉ gi·∫£m ƒë·ªô tr·ªÖ.
2.  **Tool Dispatcher:** Nh·∫≠n `ActionDecision` t·ª´ L2, ki·ªÉm tra Guardrails (L4), v√† g·ªçi h√†m Playwright t∆∞∆°ng ·ª©ng.

**Logic X·ª≠ l√Ω L·ªói C·∫•p th·∫•p:**
*   **ElementNotFound:** N·∫øu Playwright kh√¥ng t√¨m th·∫•y `a11y_id`, `Tool Dispatcher` s·∫Ω t·ª± ƒë·ªông th·ª≠ l·∫°i 1 l·∫ßn sau khi g·ªçi l·∫°i `Browser Monitor` (L1) ƒë·ªÉ c·∫≠p nh·∫≠t `PageState` (ph√≤ng tr∆∞·ªùng h·ª£p trang web v·ª´a t·∫£i xong). N·∫øu v·∫´n th·∫•t b·∫°i, tr·∫£ v·ªÅ l·ªói cho `VERIFIER_NODE` (L2) ƒë·ªÉ k√≠ch ho·∫°t Vision Fallback.
*   **Timeout:** N·∫øu h√†nh ƒë·ªông v∆∞·ª£t qu√° 30 gi√¢y, h·ªßy b·ªè v√† tr·∫£ v·ªÅ l·ªói cho L2.

#### 5.3. Chi ti·∫øt Tool: `extract_metric`

Tool n√†y kh√¥ng ch·ªâ l√† m·ªôt l·ªánh Playwright ƒë∆°n gi·∫£n. N√≥ l√† m·ªôt **mini-pipeline** t√≠ch h·ª£p LLM:

1.  **Input:** `metric_name` (v√≠ d·ª•: "EBITDA Q3 2025").
2.  **Action:** L·∫•y `PageState.raw_markdown` v√† `PageState.a11y_tree_json`.
3.  **LLM Call (Extraction):** G·ªçi LLM (GPT-4o) v·ªõi Prompt: "Tr√≠ch xu·∫•t gi√° tr·ªã c·ªßa {metric_name} t·ª´ vƒÉn b·∫£n sau. Tr·∫£ l·ªùi d∆∞·ªõi d·∫°ng JSON: `{'value': float, 'unit': str, 'quote': str}`."
4.  **Output:** Tr·∫£ v·ªÅ JSON ƒë√£ tr√≠ch xu·∫•t.
5.  **Quan tr·ªçng:** K·∫øt qu·∫£ n√†y s·∫Ω ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn `VERIFIER_NODE` (L2) ƒë·ªÉ ki·ªÉm tra **Provenance** tr∆∞·ªõc khi ƒë∆∞·ª£c l∆∞u v√†o `AgentState`.

---
*Ti·∫øp t·ª•c vi·∫øt Ph·∫ßn III: Governance Layer (L4).*

---

## PART III: GOVERNANCE LAYER (L4) - COMPLIANCE & CONTROL

L·ªõp Governance l√† l·ªõp b·∫£o v·ªá v√† tu√¢n th·ªß, ho·∫°t ƒë·ªông nh∆∞ m·ªôt middleware gi√°m s√°t m·ªçi quy·∫øt ƒë·ªãnh c·ªßa L2 v√† m·ªçi h√†nh ƒë·ªông c·ªßa L3.

### 6. GUARDRAILS (R√†o ch·∫Øn B·∫£o v·ªá)

Guardrails ƒë∆∞·ª£c tri·ªÉn khai d∆∞·ªõi d·∫°ng c√°c h√†m ki·ªÉm tra ƒë·ªìng b·ªô (synchronous checks) ƒë∆∞·ª£c g·ªçi tr∆∞·ªõc khi `ActionDecision` ƒë∆∞·ª£c th·ª±c thi (Pre-Action Check) v√† tr∆∞·ªõc khi `AgentState` ƒë∆∞·ª£c c·∫≠p nh·∫≠t (Post-Action Check).

#### 6.1. Pre-Action Guardrails

| T√™n Guardrail | M√¥ t·∫£ | Logic Ki·ªÉm tra | H√†nh ƒë·ªông n·∫øu Th·∫•t b·∫°i |
| :--- | :--- | :--- | :--- |
| **URL Whitelist** | NgƒÉn Agent truy c·∫≠p c√°c domain kh√¥ng ƒë∆∞·ª£c ph√©p. | Ki·ªÉm tra `ActionDecision.tool_params.url` (n·∫øu `tool_name` l√† `navigate`) so v·ªõi danh s√°ch URL ƒë∆∞·ª£c ph√™ duy·ªát (l∆∞u trong DB). | Ch·∫∑n h√†nh ƒë·ªông, ghi log, chuy·ªÉn ƒë·∫øn `REPLAN_NODE` v·ªõi l·ªói `URL_BLOCKED`. |
| **Sensitive Data Filter** | NgƒÉn Agent nh·∫≠p/tr√≠ch xu·∫•t PII. | Ki·ªÉm tra `ActionDecision.tool_params.text` (n·∫øu `tool_name` l√† `type_text`) b·∫±ng m√¥ h√¨nh nh·ªè/regex PII. | Ch·∫∑n h√†nh ƒë·ªông, ghi log, chuy·ªÉn ƒë·∫øn `REPLAN_NODE` v·ªõi l·ªói `PII_INPUT_BLOCKED`. |
| **Cost Threshold** | NgƒÉn Agent th·ª±c hi·ªán c√°c h√†nh ƒë·ªông qu√° t·ªën k√©m. | Ki·ªÉm tra `ActionDecision.confidence_score` v√† `llm_calls_count` hi·ªán t·∫°i. N·∫øu `confidence_score` th·∫•p v√† `llm_calls_count` cao (>50), k√≠ch ho·∫°t HITL. | K√≠ch ho·∫°t HITL (Chuy·ªÉn ƒë·∫øn `HITL_CHECK`). |

#### 6.2. Post-Action Guardrails

| T√™n Guardrail | M√¥ t·∫£ | Logic Ki·ªÉm tra | H√†nh ƒë·ªông n·∫øu Th·∫•t b·∫°i |
| :--- | :--- | :--- | :--- |
| **Compliance Content Check** | NgƒÉn Agent t·∫°o ra n·ªôi dung vi ph·∫°m quy ƒë·ªãnh (v√≠ d·ª•: "Khuy·∫øn ngh·ªã mua c·ªï phi·∫øu X"). | Ki·ªÉm tra ƒë·∫ßu ra cu·ªëi c√πng (`FINAL_NODE`) b·∫±ng LLM Guardrail (v√≠ d·ª•: GPT-4o) v·ªõi Prompt: "N·ªôi dung n√†y c√≥ ph·∫£i l√† l·ªùi khuy√™n ƒë·∫ßu t∆∞ kh√¥ng? Tr·∫£ l·ªùi C√≥/Kh√¥ng." | Ch·∫∑n ƒë·∫ßu ra, chuy·ªÉn ƒë·∫øn `REPLAN_NODE` v·ªõi l·ªói `COMPLIANCE_VIOLATION`. |
| **Audit Log Integrity** | ƒê·∫£m b·∫£o m·ªçi h√†nh ƒë·ªông ƒë∆∞·ª£c ghi l·∫°i. | Sau m·ªói b∆∞·ªõc, ki·ªÉm tra xem Audit Log c√≥ ƒë∆∞·ª£c ghi th√†nh c√¥ng v√†o DB kh√¥ng. | N·∫øu th·∫•t b·∫°i, d·ª´ng phi√™n Agent v√† c·∫£nh b√°o SRE (P0). |

### 7. HUMAN-IN-THE-LOOP (HITL)

HITL l√† c∆° ch·∫ø cho ph√©p ng∆∞·ªùi d√πng can thi·ªáp v√†o lu·ªìng c√¥ng vi·ªác c·ªßa Agent.

#### 7.1. Checkpoint Triggers (C√°c ƒëi·ªÅu ki·ªán k√≠ch ho·∫°t HITL)

HITL ƒë∆∞·ª£c k√≠ch ho·∫°t khi m·ªôt trong c√°c ƒëi·ªÅu ki·ªán sau ƒë∆∞·ª£c ƒë√°p ·ª©ng:

1.  **Low Confidence:** `ActionDecision.confidence_score` < 0.75.
2.  **High Risk Action:** `ActionDecision.tool_name` l√† m·ªôt h√†nh ƒë·ªông r·ªßi ro cao (v√≠ d·ª•: `navigate` ƒë·∫øn domain m·ªõi, `type_text` v√†o tr∆∞·ªùng nh·∫°y c·∫£m).
3.  **Cost Threshold:** V∆∞·ª£t qu√° ng∆∞·ª°ng chi ph√≠/th·ªùi gian ƒë√£ ƒë·ªãnh (t·ª´ Guardrail).
4.  **Compliance Checkpoint:** B·∫•t k·ª≥ h√†nh ƒë·ªông n√†o ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† "Compliance Checkpoint" trong `ActionDecision`.

#### 7.2. HITL Workflow (Lu·ªìng C√¥ng vi·ªác)

1.  **Trigger:** M·ªôt trong c√°c ƒëi·ªÅu ki·ªán Checkpoint ƒë∆∞·ª£c k√≠ch ho·∫°t.
2.  **Pause:** Agent Service t·∫°m d·ª´ng x·ª≠ l√Ω phi√™n (`session_id`).
3.  **Notification:** G·ª≠i y√™u c·∫ßu ph√™ duy·ªát qua WebSocket ƒë·∫øn Client (Chrome Extension). Y√™u c·∫ßu bao g·ªìm:
    *   `ActionDecision` ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t.
    *   `PageState.screenshot_b64` (·∫¢nh ch·ª•p m√†n h√¨nh hi·ªán t·∫°i).
    *   `reasoning` c·ªßa LLM.
4.  **User Action:** Ng∆∞·ªùi d√πng c√≥ 3 l·ª±a ch·ªçn:
    *   **Approve:** G·ª≠i `ApprovalRequest(approved=True)` -> Agent ti·∫øp t·ª•c th·ª±c thi `ActionDecision`.
    *   **Reject:** G·ª≠i `ApprovalRequest(approved=False)` -> Agent chuy·ªÉn ƒë·∫øn `REPLAN_NODE` v·ªõi l·ªói `USER_REJECTED_ACTION`.
    *   **Edit:** G·ª≠i `ApprovalRequest(modified_action=NewActionDecision)` -> Agent th·ª±c thi h√†nh ƒë·ªông m·ªõi do ng∆∞·ªùi d√πng cung c·∫•p.
5.  **Resume:** Agent Service ti·∫øp t·ª•c x·ª≠ l√Ω phi√™n.

---

## PART IV: T·ªîNG H·ª¢P V√Ä K·∫æT LU·∫¨N

### 8. DATA FLOW & CONTRACTS SUMMARY

| L·ªõp G·ª≠i | L·ªõp Nh·∫≠n | D·ªØ li·ªáu Truy·ªÅn t·∫£i | M√¥ h√¨nh D·ªØ li·ªáu | C√¥ng ngh·ªá Truy·ªÅn t·∫£i |
| :--- | :--- | :--- | :--- | :--- |
| **Client** | **L1 (Perception)** | M·ª•c ti√™u ng∆∞·ªùi d√πng, Tr·∫°ng th√°i tr√¨nh duy·ªát. | `StartSessionRequest` | HTTP/S (API Gateway) |
| **L1 (Perception)** | **L2 (Cognition)** | Ng·ªØ c·∫£nh Th·ªëng nh·∫•t. | `AgentState` (Pydantic) | Redis (State Management) |
| **L2 (Cognition)** | **L3 (Action)** | Quy·∫øt ƒë·ªãnh H√†nh ƒë·ªông. | `ActionDecision` (Pydantic) | Internal Function Call |
| **L3 (Action)** | **L1 (Perception)** | K·∫øt qu·∫£ Th·ª±c thi. | `last_observation` (str) | Internal Function Call |
| **L4 (Governance)** | **L2/L3** | L·ªánh Ch·∫∑n/Ph√™ duy·ªát. | `GuardrailResult` (Enum) | Internal Middleware Hook |
| **L2 (Cognition)** | **L4 (Governance)** | Snapshot Tr·∫°ng th√°i. | `AgentState` | PostgreSQL (Audit Log) |
| **L2 (Cognition)** | **Client** | Y√™u c·∫ßu Ph√™ duy·ªát HITL. | `HITLRequest` | WebSocket |

### 9. K·∫æT LU·∫¨N LLD

Thi·∫øt k·∫ø c·∫•p th·∫•p (LLD) cho finAI Finance Agent Web Browser x√°c nh·∫≠n t√≠nh kh·∫£ thi c·ªßa High-Level Design (HLD) 4 l·ªõp.

*   **L√µi LangGraph (L2)** cung c·∫•p kh·∫£ nƒÉng ki·ªÉm so√°t lu·ªìng c√¥ng vi·ªác ph·ª©c t·∫°p, ƒë·∫∑c bi·ªát th√¥ng qua c√°c Node chuy√™n bi·ªát nh∆∞ `VERIFIER_NODE` v√† `REPLAN_NODE`, gi·∫£i quy·∫øt tr·ª±c ti·∫øp c√°c y√™u c·∫ßu v·ªÅ **Accuracy** v√† **Resilience**.
*   **M√¥ h√¨nh Hybrid (L1/L3)** ƒë·∫£m b·∫£o Agent c√≥ th·ªÉ t∆∞∆°ng t√°c b·ªÅn b·ªâ v·ªõi c√°c trang web t√†i ch√≠nh, s·ª≠ d·ª•ng A11y Tree l√†m ƒë·∫ßu v√†o ch√≠nh v√† GPT-4V l√†m c∆° ch·∫ø t·ª± ph·ª•c h·ªìi.
*   **L·ªõp Governance (L4)** t√≠ch h·ª£p c√°c Guardrails v√† c∆° ch·∫ø HITL, bi·∫øn Compliance th√†nh m·ªôt t√≠nh nƒÉng c·ªët l√µi, kh√¥ng th·ªÉ b·ªè qua, gi·∫£m thi·ªÉu r·ªßi ro ph√°p l√Ω v√† uy t√≠n.

Vi·ªác tri·ªÉn khai s·∫Ω t·∫≠p trung v√†o vi·ªác x√¢y d·ª±ng c√°c m√¥ h√¨nh Pydantic, c√°c h√†m Node trong LangGraph, v√† c√°c h√†m Tool trong Playwright Controller theo c√°c h·ª£p ƒë·ªìng (contracts) ƒë√£ ƒë·ªãnh nghƒ©a trong t√†i li·ªáu n√†y.

---
*T√†i li·ªáu LLD si√™u chi ti·∫øt ƒë√£ ho√†n th√†nh.*
