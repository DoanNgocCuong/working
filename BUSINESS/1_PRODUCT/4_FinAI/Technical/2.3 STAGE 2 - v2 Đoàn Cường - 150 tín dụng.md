# TECHNICAL DEEP-DIVE SPECIFICATION (TDD)

**Version 3.0 - Universal Pro Edition**

---

## üìã **METADATA (Document Header)**

- **Title:** Module 2 - Query Understanding & Task Spec
- **Author:** Manus AI (ƒë√≥ng vai Chief Architect)
- **Reviewers:** Tech Lead, Product Manager, AI/ML Lead
- **Status:** Draft
- **Created:** 2025-12-10
- **Last Updated:** 2025-12-10
- **Version:** 1.0
- **Related Docs:** [STAGE 1 - Input & Ingestion](link-to-stage1-doc), [STAGE 3 - Router & Planner](link-to-stage3-doc)

---

## 1. OVERVIEW & CONTEXT

### 1.1. Executive Summary (TL;DR)

- **Problem Statement:** C√°c module x·ª≠ l√Ω ph√≠a sau (Planner, Agents) kh√¥ng th·ªÉ ho·∫°t ƒë·ªông m·ªôt c√°ch ƒë√°ng tin c·∫≠y v·ªõi input th√¥, kh√¥ng c√≥ c·∫•u tr√∫c t·ª´ ng∆∞·ªùi d√πng. C·∫ßn m·ªôt l·ªõp trung gian ƒë·ªÉ "hi·ªÉu" v√† "chu·∫©n h√≥a" y√™u c·∫ßu.
- **Proposed Solution:** X√¢y d·ª±ng m·ªôt pipeline x·ª≠ l√Ω 2 giai ƒëo·∫°n (`Rule-first, SLM-backup`) ƒë·ªÉ ph√¢n t√≠ch `UnifiedInputCore` t·ª´ Stage 1, t·∫°o ra m·ªôt ƒë·ªëi t∆∞·ª£ng `TaskSpecV1` c√≥ c·∫•u tr√∫c, r√µ r√†ng v·ªÅ √Ω ƒë·ªãnh, ph·∫°m vi, th·ª±c th·ªÉ, v√† c√°c c·ªù ch√≠nh s√°ch.
- **Impact:** TƒÉng ƒë·ªô tin c·∫≠y v√† kh·∫£ nƒÉng d·ª± ƒëo√°n c·ªßa to√†n b·ªô h·ªá th·ªëng. Gi·∫£m ƒë√°ng k·ªÉ ƒë·ªô ph·ª©c t·∫°p cho c√°c module ph√≠a sau. Cho ph√©p ƒë·ªãnh tuy·∫øn v√† th·ª±c thi t√°c v·ª• m·ªôt c√°ch an to√†n v√† hi·ªáu qu·∫£.

### 1.2. Background & Motivation

- **Why now?** ƒê√¢y l√† module n·ªÅn t·∫£ng, tr√°i tim c·ªßa h·ªá th·ªëng agentic. Kh√¥ng c√≥ n√≥, h·ªá th·ªëng ch·ªâ l√† m·ªôt chu·ªói c√°c l·ªùi g·ªçi LLM kh√¥ng th·ªÉ ki·ªÉm so√°t, d·∫´n ƒë·∫øn k·∫øt qu·∫£ kh√¥ng nh·∫•t qu√°n v√† r·ªßi ro cao.
- **Current Pain Points:** N·∫øu kh√¥ng c√≥ Stage 2, Stage 3 (Planner) s·∫Ω ph·∫£i t·ª± m√¨nh ph√¢n t√≠ch vƒÉn b·∫£n th√¥, d·∫´n ƒë·∫øn vi·ªác logic l·∫≠p k·∫ø ho·∫°ch b·ªã tr·ªôn l·∫´n v·ªõi logic hi·ªÉu ng√¥n ng·ªØ, vi ph·∫°m nguy√™n t·∫Øc Single Responsibility.
- **Alternatives Considered:**
    - **Ch·ªâ d√πng LLM:** G·ªçi m·ªôt LLM l·ªõn ƒë·ªÉ chuy·ªÉn ƒë·ªïi tr·ª±c ti·∫øp t·ª´ input th√¥ sang `TaskSpecV1`. **L√Ω do lo·∫°i b·ªè:** Chi ph√≠ cao, ƒë·ªô tr·ªÖ l·ªõn, kh√≥ ki·ªÉm so√°t, kh√≥ debug, v√† kh√¥ng c·∫ßn thi·∫øt cho ph·∫ßn l·ªõn c√°c y√™u c·∫ßu ƒë∆°n gi·∫£n.
    - **Ch·ªâ d√πng Rule Engine:** Ch·ªâ s·ª≠ d·ª•ng c√°c quy t·∫Øc regex/keyword. **L√Ω do lo·∫°i b·ªè:** Kh√¥ng ƒë·ªß linh ho·∫°t ƒë·ªÉ x·ª≠ l√Ω c√°c y√™u c·∫ßu ph·ª©c t·∫°p, m∆° h·ªì ho·∫∑c c√°c th·ª±c th·ªÉ kh√¥ng c√≥ c·∫•u tr√∫c (v√≠ d·ª•: `preferences`).

### 1.3. Success Criteria

- **Accuracy:** >95% ph√¢n lo·∫°i ch√≠nh x√°c `intent`, `scope`, `artifact` tr√™n b·ªô d·ªØ li·ªáu ƒë√°nh gi√°.
- **Latency:** P99 latency cho "Fast Path" (ch·ªâ d√πng Rule Engine) < 50ms. P95 latency cho "Slow Path" (c√≥ g·ªçi SLM) < 500ms.
- **Coverage:** Rule Engine c√≥ th·ªÉ x·ª≠ l√Ω >80% t·ªïng s·ªë request m√† kh√¥ng c·∫ßn g·ªçi SLM (confidence ‚â• 0.85).

---

## 2. GOALS / SCOPE / NON-GOALS / ASSUMPTIONS

### 2.1. Goals

- **Business Goals:** ƒê·∫£m b·∫£o c√°c t√°c v·ª• c·ªßa ng∆∞·ªùi d√πng ƒë∆∞·ª£c hi·ªÉu ƒë√∫ng ngay t·ª´ ƒë·∫ßu, gi·∫£m t·ª∑ l·ªá th·ª±c thi th·∫•t b·∫°i do hi·ªÉu sai y√™u c·∫ßu.
- **Technical Goals:** Cung c·∫•p m·ªôt `TaskSpecV1` ·ªïn ƒë·ªãnh, c√≥ c·∫•u tr√∫c cho c√°c module ph√≠a sau. ƒê·∫°t ƒë∆∞·ª£c c√°c ch·ªâ s·ªë v·ªÅ latency v√† accuracy ƒë√£ ƒë·ªÅ ra.
- **User Experience Goals:** Ph·∫£n h·ªìi nhanh cho c√°c y√™u c·∫ßu ƒë∆°n gi·∫£n, ƒë·∫£m b·∫£o h·ªá th·ªëng kh√¥ng "ƒëo√°n m√≤" m·ªôt c√°ch nguy hi·ªÉm v·ªõi c√°c y√™u c·∫ßu ph·ª©c t·∫°p.

### 2.2. In-Scope

- X√¢y d·ª±ng **Rule Engine** ƒë·ªÉ ph√¢n t√≠ch nhanh `intent`, `scope`, `artifact`, `action_level`, `risk`, v√† c√°c th·ª±c th·ªÉ c·ª©ng.
- T√≠ch h·ª£p m·ªôt **Small Language Model (SLM)** ƒë·ªÉ x·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p m√† Rule Engine kh√¥ng ch·∫Øc ch·∫Øn.
- X√¢y d·ª±ng module **Policy Overrides** ƒë·ªÉ √°p ƒë·∫∑t c√°c quy t·∫Øc an to√†n cu·ªëi c√πng.
- ƒê·ªãnh nghƒ©a v√† sinh ra ƒë·ªëi t∆∞·ª£ng `TaskSpecV1` ho√†n ch·ªânh.

### 2.3. Out-of-Scope / Non-Goals

- **KH√îNG** th·ª±c hi·ªán b·∫•t k·ª≥ h√†nh ƒë·ªông n√†o (web search, API call b√™n ngo√†i, thao t√°c UI).
- **KH√îNG** t∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi ng∆∞·ªùi d√πng ƒë·ªÉ l√†m r√µ y√™u c·∫ßu (ƒë√≥ l√† nhi·ªám v·ª• c·ªßa Stage 5 - Clarification).
- **KH√îNG** gi·ªØ l·∫°i b·∫•t k·ª≥ tr·∫°ng th√°i n√†o gi·ªØa c√°c request.

### 2.4. Assumptions

- `UnifiedInputCore` nh·∫≠n t·ª´ Stage 1 ƒë√£ ƒë∆∞·ª£c chu·∫©n h√≥a v√† ch·ª©a ƒë·∫ßy ƒë·ªß th√¥ng tin c·∫ßn thi·∫øt (vƒÉn b·∫£n ƒë√£ chu·∫©n h√≥a, URL, context trang).
- C√≥ m·ªôt SLM (v√≠ d·ª•: Llama3-8B, Gemma-7B) ƒë√£ ƒë∆∞·ª£c tri·ªÉn khai v√† s·∫µn s√†ng ƒë·ªÉ g·ªçi qua m·ªôt API n·ªôi b·ªô.

### 2.5. Constraints

- **Technical:** Ph·∫£i ƒë∆∞·ª£c vi·∫øt b·∫±ng Python. Ph·∫£i ho·∫°t ƒë·ªông nh∆∞ m·ªôt service stateless.
- **Compliance:** Ph·∫£i c√≥ kh·∫£ nƒÉng ph√°t hi·ªán v√† g·∫Øn c·ªù c√°c r·ªßi ro v·ªÅ PII v√† injection.

### 2.6. Dependencies

- **Upstream:** Ph·ª• thu·ªôc ho√†n to√†n v√†o output `UnifiedInputCore` c·ªßa **Stage 1**.
- **Downstream:** Cung c·∫•p input `TaskSpecV1` cho **Stage 3 (Router/Planner)**.
- **Internal:** Ph·ª• thu·ªôc v√†o m·ªôt service n·ªôi b·ªô ƒë·ªÉ g·ªçi SLM.

---

## 3. USER STORIES / USE CASES

### 3.1. Primary Actors

- **Downstream Services:** Ch·ªß y·∫øu l√† Stage 3 (Router/Planner), nh∆∞ng c≈©ng c√≥ th·ªÉ l√† c√°c h·ªá th·ªëng gi√°m s√°t ho·∫∑c ph√¢n t√≠ch.

### 3.2. User Stories

- **US-01 (Simple Summary):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` v·ªõi `intent: summarize`, `scope: page`, `artifact: brief` **when** the user input is "t√≥m t·∫Øt trang n√†y".
  - **So that** I can route the task to a simple summarization agent.

- **US-02 (Complex Action):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` v·ªõi `intent: act`, `artifact: compare`, v√† `entities` ch·ª©a `budget` v√† `preferences` **when** the user input is "t√¨m cho t√¥i 3 laptop gaming d∆∞·ªõi 40tr, ∆∞u ti√™n m√†n h√¨nh ƒë·∫πp v√† b√†n ph√≠m t·ªët".
  - **So that** I can create a research plan to find and compare laptops based on these constraints.

- **US-03 (Sensitive Action):**
  - **As a** Planner, **I want to** receive a `TaskSpecV1` v·ªõi `action_level: Act-2`, `risk: high`, v√† `policy.requires_confirm: true` **when** the user input is "ƒë·∫∑t v√© m√°y bay ƒëi Singapore v√†o ng√†y mai".
  - **So that** I can ensure the execution plan includes a confirmation step before performing the booking.

### 3.4. Edge Cases & Error Scenarios

- **Input m∆° h·ªì:** "l√†m g√¨ ƒë√≥ v·ªõi c√°i n√†y ƒëi" ‚Üí Rule Engine s·∫Ω c√≥ `confidence` th·∫•p, k√≠ch ho·∫°t SLM ƒë·ªÉ c·ªë g·∫Øng di·ªÖn gi·∫£i. `TaskSpecV1` c√≥ th·ªÉ c√≥ `missing_slots`.
- **Input ch·ª©a PII:** "t√≥m t·∫Øt email c·ªßa t√¥i t·ª´ s·∫øp v·ªÅ d·ª± √°n X" ‚Üí `policy.pii_risk` s·∫Ω ƒë∆∞·ª£c ƒë·∫∑t l√† `likely`.
- **Input c√≥ d·∫•u hi·ªáu injection:** "t√≥m t·∫Øt trang n√†y v√† sau ƒë√≥ `DROP TABLE users;`" ‚Üí `policy.injection_risk` s·∫Ω l√† `true`.

---

## 4. API CONTRACT & INTERFACES

Module n√†y ho·∫°t ƒë·ªông nh∆∞ m·ªôt h√†m x·ª≠ l√Ω n·ªôi b·ªô, kh√¥ng ph·∫£i l√† m·ªôt public API. Giao di·ªán ch√≠nh c·ªßa n√≥ l√† c√°c ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu ƒë·∫ßu v√†o v√† ƒë·∫ßu ra.

### 4.1. Function Signature

```python
async def process_stage2(input_envelope: UnifiedInputCore) -> QUOutputV1:
    # ... implementation ...
```

### 4.3. Data Models (Schemas)

*ƒê√¢y l√† c√°c c·∫•u tr√∫c d·ªØ li·ªáu c·ªët l√µi, ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a b·∫±ng Pydantic ƒë·ªÉ validate.* 

- **Input:** `UnifiedInputCore` (t·ª´ Stage 1)
- **Output:** `QUOutputV1`

```python
from pydantic import BaseModel, Field
from typing import Literal, List, Dict, Any

# (D√°n c√°c class Pydantic t∆∞∆°ng ·ª©ng v·ªõi c√°c type TypeScript trong t√†i li·ªáu Stage 2)
# V√≠ d·ª•:
class TaskSpecV1(BaseModel):
    spec_id: str
    version: Literal["v1"]
    input_id: str
    intent: Literal["summarize", "explain", "act"]
    scope: Literal["page", "multi_page", "web", "personal", "general"]
    artifact: Literal["brief", "answer", "compare", "plan", "extract"]
    action_level: Literal["Act-0", "Act-1", "Act-2"]
    risk: Literal["low", "medium", "high"]
    entities: Dict[str, Any] # EntityBag
    context: Dict[str, Any] # TaskContext
    policy: Dict[str, Any]  # PolicyHints
    _from_slm: bool = False
    _rule_confidence: float = 0.0

class QUOutputV1(BaseModel):
    input: Any # UnifiedInputCore
    task_spec: TaskSpecV1
    telemetry: Dict[str, Any]
```

---

## 6. SYSTEM ARCHITECTURE & FLOW

### 6.1. High-Level Architecture

Stage 2 ƒë∆∞·ª£c thi·∫øt k·∫ø theo pattern:

- **Rule-first** (r·∫ª, nhanh, explainable).
- **SLM-backup** (1 call, joint A+B+C) ch·ªâ khi rule kh√¥ng ch·∫Øc.

C√≥ hai ƒë∆∞·ªùng ch·∫°y:

- **Fast path (Rule-only)**: ƒëa s·ªë request ‚Üí ch·ªâ d√πng Rule Engine.
- **Slow path (Rule + 1 SLM)**: cho c√¢u kh√≥/m∆° h·ªì.

```text
                 +--------------------------------------+
                 |      STAGE 1 ‚Äì UnifiedInputCore      |
                 |   (normalize input: text / URL / ‚Ä¶)  |
                 +-----------------+--------------------+
                                   |
                                   v
                 +--------------------------------------+
                 |      STAGE 2 ‚Äì Query Understanding   |
                 |      (build TaskSpecV1 skeleton)     |
                 +-----------------+--------------------+
                                   |
                                   v
                    +-------------------------------+
                    |  RULE ENGINE (A+B+C+D guess)  |
                    |  - 4.1 Intent (A)             |
                    |  - 4.2 Facets (B)             |
                    |  - 4.3 Entities-hard (C)      |
                    |  - 4.4 Policy-base (D)        |
                    +-----------------+-------------+
                                      |
                           +----------+----------+
                           |  confidence ‚â• 0.85? |
                           +----------+----------+
                                      |
                         yes          |          no
                (FAST PATH)           |    (SLOW PATH ‚Äì SLM)
                                      |
                                      |
             +------------------------+--------------------------+
             |                                                   |
             v                                                   v
+-------------------------------+                 +-------------------------------+
| Build TaskSpec from RULES     |                 | call_QU_SLM (joint A+B+C)     |
| - intent / scope / artifact   |                 | input:                        |
| - action_level / risk         |                 |   - UnifiedInputCore         |
| - entities (hard parsed)      |                 |   - rule_engine suggestions  |
+---------------+---------------+                 | output:                      |
                |                                 |   - intent, facets, entities |
                |                                 +---------------+-------------+
                |                                                 |
                +------------------------+------------------------+
                                         v
                          +----------------------------------+
                          |  POLICY OVERRIDES (Stage D final)|
                          |  - enforce Act-2 ‚áí confirm       |
                          |  - PII / injection checks        |
                          |  - fix requires_confirm, risk    |
                          +-----------------+----------------+
                                            |
                                            v
                                +--------------------------+
                                |   FINAL TaskSpecV1 OUT   |
                                |   (for planner/agents)   |
                                +--------------------------+
```



Ki·∫øn tr√∫c c·ªßa Stage 2 l√† m·ªôt pipeline tu·∫ßn t·ª± v·ªõi m·ªôt ƒëi·ªÉm r·∫Ω nh√°nh.

```mermaid
graph TD
    A[Input: UnifiedInputCore] --> B{Rule Engine};
    B -- Yes (Fast Path) --> C[Build TaskSpec from Rules];
    B -- No (Slow Path) --> D[Call QU_SLM];
    D --> F[Merge SLM results];
    C --> G{Policy Overrides};
    F --> G;
    G --> H[Output: QUOutputV1];
```

### 6.2. Sequence Diagrams

#### Fast Path

```mermaid
sequenceDiagram
    participant Orchestrator
    participant RuleEngine
    participant PolicyModule

    Orchestrator->>RuleEngine: runRuleEngine_ABCD(input)
    RuleEngine-->>Orchestrator: return ruleResult (confidence=0.9)
    Orchestrator->>Orchestrator: buildTaskSpecFromRule(ruleResult)
    Orchestrator->>PolicyModule: runPolicyOverrides(taskSpec)
    PolicyModule-->>Orchestrator: return finalTaskSpec
```

#### Slow Path

```mermaid
sequenceDiagram
    participant Orchestrator
    participant RuleEngine
    participant SLM_Service
    participant PolicyModule

    Orchestrator->>RuleEngine: runRuleEngine_ABCD(input)
    RuleEngine-->>Orchestrator: return ruleResult (confidence=0.6)
    Orchestrator->>SLM_Service: call_QU_SLM(input, ruleResult)
    SLM_Service-->>Orchestrator: return slmResult
    Orchestrator->>Orchestrator: buildTaskSpecFromSLM(slmResult)
    Orchestrator->>PolicyModule: runPolicyOverrides(taskSpec)
    PolicyModule-->>Orchestrator: return finalTaskSpec
```

---

## 7. IMPLEMENTATION DETAILS (Deep-Dive)

### 7.1. Processing Pipeline Overview

1.  **Rule Engine Execution:** Lu√¥n ch·∫°y ƒë·∫ßu ti√™n. Ph√¢n t√≠ch input d·ª±a tr√™n keywords v√† patterns ƒë·ªÉ ƒë∆∞a ra m·ªôt ph·ªèng ƒëo√°n ban ƒë·∫ßu (`RuleEngineResult`) v√† m·ªôt ƒëi·ªÉm `confidence`.
2.  **Path Selection:** D·ª±a v√†o `confidence` score, quy·∫øt ƒë·ªãnh ƒëi theo "Fast Path" (ch·ªâ d√πng k·∫øt qu·∫£ c·ªßa Rule Engine) hay "Slow Path" (g·ªçi th√™m SLM).
3.  **TaskSpec Generation:**
    - **Fast Path:** √Ånh x·∫° tr·ª±c ti·∫øp k·∫øt qu·∫£ t·ª´ Rule Engine v√†o c·∫•u tr√∫c `TaskSpecV1`.
    - **Slow Path:** G·ª≠i input g·ªëc v√† g·ª£i √Ω c·ªßa Rule Engine ƒë·∫øn SLM. Nh·∫≠n k·∫øt qu·∫£ c√≥ c·∫•u tr√∫c t·ª´ SLM v√† x√¢y d·ª±ng `TaskSpecV1`.
4.  **Policy Overrides:** √Åp d·ª•ng m·ªôt l·ªõp quy t·∫Øc an to√†n cu·ªëi c√πng l√™n `TaskSpecV1` ƒë√£ ƒë∆∞·ª£c t·∫°o ƒë·ªÉ ƒë·∫£m b·∫£o c√°c c·ªù ch√≠nh s√°ch quan tr·ªçng (v√≠ d·ª•: `requires_confirm`) ƒë∆∞·ª£c ƒë·∫∑t ƒë√∫ng.

### 7.2. Per-Module Specification

- Stage 1: Rule / lightweight classifier ‚Üí filter, domain detection, obvious intent, PII/injection flag.
    
- Stage 2: LLM/SLM ‚Üí refine, fill slot, generate full task spec, especially with ambiguity.
    
- Stage 3: Policy & guardrail ‚Üí enforce constraint, validate tool calls, downgrade risky h√†nh ƒë·ªông.

#### Module: Rule Engine

- **Responsibility:** Ph√¢n t√≠ch nhanh input, ƒë∆∞a ra ph·ªèng ƒëo√°n ban ƒë·∫ßu v·ªÅ √Ω ƒë·ªãnh v√† c√°c thu·ªôc t√≠nh kh√°c.
- **Input:** `UnifiedInputCore`
- **Output:** `RuleEngineResult` (bao g·ªìm `confidence` score)
- **Algorithm/Pseudocode:**
  ```python
  def run_rule_engine(text: str, context: PageContext) -> RuleEngineResult:
      # 1. Ph√¢n t√≠ch Intent
      intent, intent_score = classify_intent(text)

      # 2. Ph√¢n t√≠ch Facets (Scope, Artifact, ...)
      scope = classify_scope(text, context)
      # ... v√† c√°c facets kh√°c

      # 3. Tr√≠ch xu·∫•t Entities c·ª©ng
      budget = parse_budget(text)
      quantity = parse_quantity(text)

      # 4. T√≠nh to√°n Confidence Score
      # D·ª±a tr√™n ƒë·ªô m·∫°nh c·ªßa c√°c keyword kh·ªõp ƒë∆∞·ª£c
      # V√≠ d·ª•: "t√≥m t·∫Øt" -> score cao, "cho t√¥i bi·∫øt v·ªÅ" -> score th·∫•p
      confidence = calculate_confidence(intent_score, ...)

      return RuleEngineResult(..., confidence=confidence)
  ```

> Ch·∫°y song song 4 nh√≥m n√†y v√† song song v·ªõi SLM 
##### 1. NH√ìM A: PH√ÇN T√çCH √ù ƒê·ªäNH (INTENT CLASSIFIER)
**M·ª•c nhi·ªám v·ª•:** X√°c ƒë·ªãnh tr∆∞·ªùng `intent`.
**Input:** `text_normalized`.
**Output:** Enum `summarize` | `explain` | `act`.

**Logic tr√≠ch xu·∫•t c·∫ßn code:**
B·∫°n c·∫ßn x√¢y d·ª±ng m·ªôt chu·ªói `if-else` ∆∞u ti√™n (Priority Chain) d·ª±a tr√™n Regex:

1.  **Check `summarize` (∆Øu ti√™n 1):**
    * *Pattern:* `t√≥m t·∫Øt`, `summary`, `summarize`, `tl;dr`, `n·ªôi dung ch√≠nh`.
    * *G√°n:* `intent = "summarize"`.
2.  **Check `explain` (∆Øu ti√™n 2):**
    * *Pattern:* `gi·∫£i th√≠ch`, `t·∫°i sao`, `v√¨ sao`, `kh√°c g√¨`, `l√† g√¨`, `why`, `how`, `difference`.
    * *G√°n:* `intent = "explain"`.
3.  **Check `act` (∆Øu ti√™n 3):**
    * *Pattern:* `ch·ªçn`, `so s√°nh`, `l√™n plan`, `ƒë·∫∑t v√©`, `ƒëi·ªÅn form`, `mua`, `book`, `t√¨m gi√∫p`.
    * *G√°n:* `intent = "act"`.
4.  **Fallback (M·∫∑c ƒë·ªãnh):**
    * N·∫øu kh√¥ng kh·ªõp c√°i n√†o $\rightarrow$ `intent = "explain"` (ho·∫∑c `act` t√πy kh·∫©u v·ªã s·∫£n ph·∫©m).

---

##### 2. NH√ìM B: PH√ÇN T√çCH NG·ªÆ C·∫¢NH & ƒê·ªäNH D·∫†NG (CONTEXT & FACETS)
**M·ª•c nhi·ªám v·ª•:** X√°c ƒë·ªãnh `scope`, `artifact`, `action_level`, `risk`.
**Input:** `text_normalized`, `urls_in_text`, `page_context`.

**Logic tr√≠ch xu·∫•t c·∫ßn code:**

* **Tr∆∞·ªùng `scope` (Ph·∫°m vi):**
    * N·∫øu text c√≥ `b√†i n√†y`, `trang n√†y`, `ƒë√¢y` **V√Ä** `page_context.active_url` t·ªìn t·∫°i $\rightarrow$ `page`.
    * N·∫øu text c√≥ `tr√™n m·∫°ng`, `google`, `t√¨m ki·∫øm` $\rightarrow$ `web`.
    * N·∫øu text c√≥ `email`, `drive`, `l·ªãch` $\rightarrow$ `personal`.
    * N·∫øu input c√≥ ch·ª©a nhi·ªÅu link (check m·∫£ng `urls_in_text`) $\rightarrow$ `multi_page`.
    * *M·∫∑c ƒë·ªãnh:* `general`.

* **Tr∆∞·ªùng `artifact` (ƒê·ªãnh d·∫°ng ƒë·∫ßu ra):**
    * N·∫øu `intent` l√† `summarize` $\rightarrow$ auto set `brief`.
    * N·∫øu text c√≥ `so s√°nh`, `top`, `shortlist` $\rightarrow$ `compare`.
    * N·∫øu text c√≥ `l√™n plan`, `l·ªãch tr√¨nh`, `checklist` $\rightarrow$ `plan`.
    * N·∫øu text c√≥ `b·∫£ng`, `tr√≠ch xu·∫•t`, `li·ªát k√™`, `danh s√°ch` $\rightarrow$ `extract`.
    * *M·∫∑c ƒë·ªãnh:* `answer`.

* **Tr∆∞·ªùng `action_level` (M·ª©c ƒë·ªô can thi·ªáp):**
    * *Level 0 (An to√†n):* M·∫∑c ƒë·ªãnh.
    * *Level 1 (So·∫°n th·∫£o):* Text c√≥ `nh√°p`, `draft`, `so·∫°n`.
    * *Level 2 (Th·ª±c thi - Nguy hi·ªÉm):* Text c√≥ `g·ª≠i`, `send`, `thanh to√°n`, `book`, `ƒë·∫∑t ch·ªó`.

---

##### 3. NH√ìM C: TR√çCH XU·∫§T TH·ª∞C TH·ªÇ C·ª®NG (HARD ENTITY EXTRACTION)
**M·ª•c nhi·ªám v·ª•:** ƒêi·ªÅn d·ªØ li·ªáu v√†o `entities_hard` (Struct `EntityBag`). ƒê√¢y l√† ph·∫ßn kh√≥ nh·∫•t c·ªßa Rule Engine, c·∫ßn Regex ch√≠nh x√°c.

**C√°c tr∆∞·ªùng c·∫ßn extract:**

* **1. `budget` (Ng√¢n s√°ch):**
    * *C·∫ßn l·∫•y:* `amount` (s·ªë ti·ªÅn), `currency` (ƒë∆°n v·ªã).
    * *Regex Pattern:* T√¨m chu·ªói s·ªë ƒëi k√®m ƒë∆°n v·ªã ti·ªÅn t·ªá.
        * V√≠ d·ª•: `20tr`, `20 tri·ªáu`, `500k`, `100$`, `500000 VND`.
    * *Logic parse:*
        * `"20tr"` $\rightarrow$ amount: `20,000,000`, currency: `VND`.
        * `"500k"` $\rightarrow$ amount: `500,000`, currency: `VND`.

* **2. `quantity` (S·ªë l∆∞·ª£ng):**
    * *C·∫ßn l·∫•y:* `shortlist` (s·ªë l∆∞·ª£ng c·∫ßn ch·ªçn), `compare_pool` (s·ªë l∆∞·ª£ng ƒë·∫ßu v√†o).
    * *Regex Pattern:* T√¨m s·ªë ƒëi k√®m t·ª´ ch·ªâ l∆∞·ª£ng.
        * `"ch·ªçn 2"` $\rightarrow$ shortlist: 2.
        * `"top 5"`, `"so s√°nh 5"` $\rightarrow$ compare_pool: 5.

* **3. `time` & `travel`:**
    * *L∆∞u √Ω:* Doc ghi l√† "hard parsed" nh∆∞ng ·ªü MVP th∆∞·ªùng ch·ªâ b·∫Øt pattern ng√†y th√°ng c∆° b·∫£n (Regex date `dd/mm`) ho·∫∑c keyword `ng√†y mai`, `tu·∫ßn sau`. N·∫øu ph·ª©c t·∫°p qu√° th√¨ ƒë·ªÉ tr·ªëng ƒë·ªÉ SLM x·ª≠ l√Ω sau.

---

##### 4. NH√ìM D: CH√çNH S√ÅCH & AN TO√ÄN (POLICY CHECK)
**M·ª•c nhi·ªám v·ª•:** G·∫Øn c·ªù c·∫£nh b√°o `policy_base`.

**Logic tr√≠ch xu·∫•t c·∫ßn code:**

* **Tr∆∞·ªùng `pii_risk` (R·ªßi ro l·ªô th√¥ng tin):**
    * Check Regex: `\d{16}` (s·ªë th·∫ª t√≠n d·ª•ng), `09\d{8}` (SƒêT), keyword `m·∫≠t kh·∫©u`, `password`, `otp`.
    * *G√°n:* `likely` ho·∫∑c `possible`.

* **Tr∆∞·ªùng `injection_risk` (T·∫•n c√¥ng Prompt):**
    * Check keyword ƒëen: `ignore previous instructions`, `b·ªè qua h∆∞·ªõng d·∫´n`, `system prompt`.
    * *G√°n:* `true/false`.



#### Module: SLM Caller (`call_QU_SLM`)

- **Responsibility:** Di·ªÖn gi·∫£i c√°c y√™u c·∫ßu ph·ª©c t·∫°p ho·∫∑c m∆° h·ªì m√† Rule Engine kh√¥ng x·ª≠ l√Ω ƒë∆∞·ª£c.
- **Input:** `UnifiedInputCore`, `RuleEngineResult` (d√πng l√†m g·ª£i √Ω)
- **Output:** M·ªôt ƒë·ªëi t∆∞·ª£ng JSON c√≥ c·∫•u tr√∫c g·∫ßn gi·ªëng `TaskSpecV1`.
- **Algorithm/Pseudocode (Prompt Engineering):**
  ```
  SYSTEM_PROMPT = """
  You are an expert system for understanding user requests. Your task is to analyze the user's query and context, and fill in the values for a JSON object representing the task specification. The user's query is in Vietnamese.
  
  You must respond ONLY with a valid JSON object. The JSON object should have the following keys: "intent", "scope", "artifact", "action_level", "risk", and "entities".
  
  Here are the possible values for each key:
  - intent: "summarize", "explain", "act"
  - scope: "page", "multi_page", "web", "personal", "general"
  - ... (li·ªát k√™ t·∫•t c·∫£ c√°c gi√° tr·ªã kh·∫£ dƒ©)
  """
  
  USER_PROMPT_TEMPLATE = """
  Here is the analysis from a preliminary rule-based system (these are suggestions, you can override them):
  {rule_engine_suggestions_json}
  
  Here is the user's full request context:
  User Query: "{user_query_text}"
  Page URL: {page_url}
  Page Title: {page_title}
  
  Now, provide the final JSON object.
  """
  ```

#### Module: Policy Overrides

- **Responsibility:** ƒê·∫£m b·∫£o an to√†n b·∫±ng c√°ch √°p ƒë·∫∑t c√°c quy t·∫Øc kh√¥ng th·ªÉ b·ªã b·ªè qua.
- **Input:** `TaskSpecV1` (t·ª´ Rule Engine ho·∫∑c SLM), `UnifiedInputCore`
- **Output:** `TaskSpecV1` ƒë√£ ƒë∆∞·ª£c ch·ªânh s·ª≠a `policy` v√† `risk`.
- **Algorithm/Pseudocode:**
  ```python
  def run_policy_overrides(task_spec: TaskSpecV1) -> TaskSpecV1:
      # Rule 1: N·∫øu l√† h√†nh ƒë·ªông c·∫•p 2, lu√¥n y√™u c·∫ßu x√°c nh·∫≠n
      if task_spec.action_level == "Act-2":
          task_spec.policy.requires_confirm = True
          task_spec.risk = "high"

      # Rule 2: N·∫øu c√≥ r·ªßi ro PII, n√¢ng m·ª©c ƒë·ªô r·ªßi ro
      if task_spec.policy.pii_risk == "likely":
          if task_spec.risk == "low": task_spec.risk = "medium"

      # Rule 3: N·∫øu c√≥ r·ªßi ro injection, ƒë·∫∑t m·ª©c r·ªßi ro cao nh·∫•t v√† ch·∫∑n h√†nh ƒë·ªông
      if task_spec.policy.injection_risk:
          task_spec.risk = "high"
          task_spec.action_level = "Act-0" # V√¥ hi·ªáu h√≥a h√†nh ƒë·ªông

      return task_spec
  ```

### 3. Rule Engine ‚Äì Tr√°i tim c·ªßa Stage 2

**Rule Engine l√† module b·∫Øt bu·ªôc, ch·∫°y cho *m·ªçi* request.**

Nhi·ªám v·ª•:

- ƒêo√°n nhanh 4 l·ªõp A/B/C/D:
  - A ‚Äì `intent` (kernel)
  - B ‚Äì `scope`, `artifact`, `action_level`, `risk`
  - C ‚Äì `entities_hard`: c√°c entity ‚Äúc·ª©ng‚Äù (budget, time, quantity, travel)
  - D ‚Äì `policy_base`: v√†i flag th√¥ (PII/injection)
- Tr·∫£ ra th√™m `confidence` ƒë·ªÉ quy·∫øt ƒë·ªãnh:
  - `confidence ‚â• 0.85` ‚Üí **Fast path** (ch·ªâ rule)
  - `< 0.85` ‚Üí **Slow path** (g·ªçi SLM)

#### 3.1. Ki·ªÉu d·ªØ li·ªáu `RuleEngineResult`

```ts
type RuleEngineResult = {
  intent: IntentKernel;
  scope: Scope;
  artifact: Artifact;
  action_level: ActionLevel;
  risk: RiskLevel;

  entities_hard: Partial<EntityBag>;
  policy_base: Partial<PolicyHints>;

  confidence: number; // 0‚Äì1
};
```

#### 3.2. Logic ch√≠nh (pseudo-code)

```ts
function runRuleEngine_ABCD(envelope: UnifiedInputCore): RuleEngineResult {
  const text = envelope.query.text_normalized.toLowerCase();
  const urls = envelope.query.urls_in_text || [];
  const pc = envelope.page_context || {};
  const sf = envelope.safety_flags || {};

  // --- A) Intent ---
  let intent: IntentKernel = "explain";
  let intent_score = 0.3;

  if (/t√≥m t·∫Øt|summary|summarize|tl;dr/.test(text)) {
    intent = "summarize"; intent_score = 0.95;
  } else if (/gi·∫£i th√≠ch|t·∫°i sao|v√¨ sao|why|how|kh√°c g√¨|difference/.test(text)) {
    intent = "explain"; intent_score = 0.9;
  } else if (/ch·ªçn|so s√°nh|l√™n plan|ƒë·∫∑t v√©|ƒëi·ªÅn form|mua gi√∫p|ƒë·∫∑t h√†ng|book/.test(text)) {
    intent = "act"; intent_score = 0.9;
  }

  // --- B1) Scope ---
  let scope: Scope = "general";
  if (/b√†i n√†y|trang n√†y|this page|current tab/.test(text) && pc.active_url) {
    scope = "page";
  } else if (urls.length > 1) {
    scope = "multi_page";
  } else if (urls.length === 1 && !pc.active_url) {
    scope = "multi_page";
  } else if (/email|gmail|calendar|l·ªãch|drive|t·ªáp c√° nh√¢n/.test(text)) {
    scope = "personal";
  } else if (/tr√™n m·∫°ng|web|search|t√¨m gi√∫p/.test(text)) {
    scope = "web";
  }

  // --- B2) Artifact ---
  let artifact: Artifact = "answer";
  if (intent === "summarize") {
    artifact = "brief";
  } else if (intent === "explain") {
    artifact = "answer";
  } else if (intent === "act") {
    if (/so s√°nh|shortlist|ch·ªçn/.test(text)) artifact = "compare";
    else if (/l√™n plan|l·ªãch tr√¨nh|itinerary|checklist/.test(text)) artifact = "plan";
    else if (/tr√≠ch|extract|li·ªát k√™|b·∫£ng|table/.test(text)) artifact = "extract";
  }

  // --- B3) Action level ---
  let action_level: ActionLevel = "Act-0";
  if (/so·∫°n nh√°p|draft|nh√°p/.test(text)) action_level = "Act-1";
  if (/g·ª≠i|send|submit|thanh to√°n|ƒë·∫∑t v√©|book|checkout/.test(text)) {
    action_level = "Act-2";
  }

  // --- B4) Risk (th√¥) ---
  let risk: RiskLevel = "low";
  if (scope === "personal" || sf.raw_input_too_long) risk = "medium";
  if (action_level === "Act-2") risk = "high";

  // --- C) Entities-hard ---
  const entities_hard: Partial<EntityBag> = {};
  entities_hard.budget   = parseBudget(text);       // "20tr", "<500k", "18-22tr"
  entities_hard.quantity = parseQuantity(text);     // "ch·ªçn 2", "g·ª£i √Ω 3"
  entities_hard.time     = parseTimeConstraints(text);
  entities_hard.travel   = parseTravel(text);

  // --- D) Policy-base ---
  const policy_base: Partial<PolicyHints> = {};
  if (/\d{16}/.test(text) || /otp|one-time password|m√£ x√°c th·ª±c/.test(text)) {
    policy_base.pii_risk = "likely";
  } else if (/s·ªë t√†i kho·∫£n|s·ªë th·∫ª|m·∫≠t kh·∫©u|password|pin/.test(text)) {
    policy_base.pii_risk = "possible";
  } else {
    policy_base.pii_risk = "none";
  }

  policy_base.injection_risk =
    /ignore previous instructions|b·ªè qua m·ªçi h∆∞·ªõng d·∫´n tr∆∞·ªõc ƒë√≥|b·ªè h·∫øt rule/.test(text) || false;

  // --- Confidence t·ªïng (simple heuristic) ---
  const confidence = Math.min(
    1,
    0.4 * intent_score +
      0.2 * (entities_hard.budget ? 1 : 0.5) +
      0.2 * (entities_hard.time ? 1 : 0.5) +
      0.2 * (scope !== "general" ? 1 : 0.5)
  );

  return {
    intent,
    scope,
    artifact,
    action_level,
    risk,
    entities_hard,
    policy_base,
    confidence
  };
}
```

---

## 4. SLM joint module (Slow path ‚Äì A+B+C)

Khi `ruleResult.confidence < 0.85`, Stage 2 d√πng **1 SLM nh·ªè** ƒë·ªÉ refine:

- `intent`
- `scope`, `artifact`, `action_level`, `risk`
- `entities` ƒë·∫ßy ƒë·ªß (bao g·ªìm preferences, sources, raw_slots‚Ä¶)

```ts
async function call_QU_SLM(
  envelope: UnifiedInputCore,
  ruleResult: RuleEngineResult
): Promise<TaskSpecV1> {
  const prompt = buildPromptFor_QU_SLM(envelope, ruleResult);
  const raw = await callSmallModel(prompt);
  const parsed = safeJsonParse(raw);

  const spec: TaskSpecV1 = {
    spec_id: uuidv4(),
    version: "v1",
    input_id: envelope.input_id,

    intent: parsed.intent,
    scope: parsed.scope,
    artifact: parsed.artifact,
    action_level: parsed.action_level,
    risk: parsed.risk,

    entities: parsed.entities,
    context: {
      language: envelope.query.detected_lang,
      normalized_text: envelope.query.text_normalized,
      urls_in_text: envelope.query.urls_in_text || [],
      page_context: envelope.page_context
    },
    policy: parsed.policy || {
      pii_risk: "none",
      injection_risk: false,
      has_sensitive_action: false,
      requires_confirm: false,
      missing_slots: []
    },

    _from_slm: true,
    _rule_confidence: ruleResult.confidence
  };

  return spec;
}
```

Prompt QU_SLM c√≥ th·ªÉ:

- Nh√©t:
  - `text_normalized`, `detected_lang`, `urls_in_text`, `page_context`
  - `rule_guess` (intent/scope/‚Ä¶/entities_hard)
- Y√™u c·∫ßu output chu·∫©n JSON theo schema `TaskSpecV1` (tr·ª´ `spec_id`, `input_id`).

---

## 5. Policy Overrides (Stage D final ‚Äì Rule-only)

B·∫•t k·ªÉ l√† fast hay slow path, lu√¥n ch·∫°y **policy override** cu·ªëi c√πng:

- Enforce invariant an to√†n.
- B·∫Øt PII/injection r√µ h∆°n.
- ƒêi·ªÅn `missing_slots`.

```ts
function runPolicyOverrides(
  envelope: UnifiedInputCore,
  taskSpec: TaskSpecV1,
  ruleResult?: RuleEngineResult
): PolicyHints {
  const text = envelope.query.text_normalized.toLowerCase();
  const base = taskSpec.policy || {};

  // 1) PII risk (∆∞u ti√™n max)
  let pii_risk: PolicyHints["pii_risk"] = base.pii_risk || "none";
  if (/\d{16}/.test(text) || /otp|one-time password|m√£ x√°c th·ª±c/.test(text)) {
    pii_risk = "likely";
  } else if (/s·ªë t√†i kho·∫£n|s·ªë th·∫ª|m·∫≠t kh·∫©u|password|pin/.test(text)) {
    pii_risk = "possible";
  }

  // 2) Injection risk
  const injection_risk =
    base.injection_risk ||
    /ignore previous instructions|b·ªè qua m·ªçi h∆∞·ªõng d·∫´n tr∆∞·ªõc ƒë√≥|b·ªè h·∫øt rule/.test(text);

  // 3) Sensitive action
  const has_sensitive_action =
    base.has_sensitive_action ||
    taskSpec.action_level === "Act-2" ||
    /thanh to√°n|chuy·ªÉn kho·∫£n|transfer|payment|checkout|ƒë·∫∑t v√©|book/.test(text);

  // 4) Requires confirm
  let requires_confirm =
    base.requires_confirm || has_sensitive_action || pii_risk !== "none";

  // 5) Missing slots
  const missing_slots = base.missing_slots ? [...base.missing_slots] : [];

  if (taskSpec.intent === "act") {
    if (taskSpec.entities.travel && !taskSpec.entities.travel.date) {
      missing_slots.push("travel.date");
    }
    if (!taskSpec.entities.budget &&
        /laptop|ƒëi·ªán tho·∫°i|phone|pc|m√†n h√¨nh/.test(text)) {
      missing_slots.push("budget");
    }
  }

  return {
    pii_risk,
    injection_risk,
    has_sensitive_action,
    requires_confirm,
    missing_slots
  };
}
```

---

## 6. Orchestration ‚Äì `runQueryUnderstanding`

```ts
async function runQueryUnderstanding(
  envelope: UnifiedInputCore
): Promise<QUOutputV1> {
  const t0 = now();
  const modulesLatency: Record<string, number> = {};
  let modelCalls = 0;

  // 1) Rule Engine
  const tRule0 = now();
  const ruleRes = runRuleEngine_ABCD(envelope);
  modulesLatency["ruleEngine"] = now() - tRule0;

  // 2) Fast vs Slow
  let taskSpec: TaskSpecV1;
  if (ruleRes.confidence >= 0.85) {
    const tBuild0 = now();
    taskSpec = buildTaskSpecFromRule(envelope, ruleRes);
    modulesLatency["buildFromRule"] = now() - tBuild0;
  } else {
    const tSLM0 = now();
    taskSpec = await call_QU_SLM(envelope, ruleRes);
    modulesLatency["QU_SLM"] = now() - tSLM0;
    modelCalls += 1;
  }

  // 3) Policy overrides (D final)
  const tPol0 = now();
  const finalPolicy = runPolicyOverrides(envelope, taskSpec, ruleRes);
  taskSpec.policy = finalPolicy;
  modulesLatency["policyOverrides"] = now() - tPol0;

  // 4) Telemetry
  const total = now() - t0;
  const telemetry: Stage2Telemetry = {
    stage2_total_latency_ms: total,
    modules: modulesLatency,
    model_calls: modelCalls
  };

  return { input: envelope, task_spec: taskSpec, telemetry };
}
```

`buildTaskSpecFromRule`:

- Map tr·ª±c ti·∫øp `ruleRes.intent/scope/artifact/action_level/risk` v√†o `TaskSpecV1`.
- `entities = merge(ruleRes.entities_hard, { preferences: [], raw_slots: {} })`.
- `policy = ruleRes.policy_base` (sau ƒë√≥ `runPolicyOverrides` ch·ªânh l·∫°i).
- G√°n `_from_slm = false`, `_rule_confidence = ruleRes.confidence`.

---



---

## 8. SECURITY & COMPLIANCE

- **PII Detection:** Rule Engine s·∫Ω t√¨m ki·∫øm c√°c pattern c·ªßa th√¥ng tin nh·∫°y c·∫£m (email, SƒêT, s·ªë th·∫ª t√≠n d·ª•ng) trong input th√¥ ƒë·ªÉ g·∫Øn c·ªù `pii_risk`.
- **Injection Detection:** Rule Engine s·∫Ω t√¨m ki·∫øm c√°c chu·ªói k√Ω t·ª± ƒë√°ng ng·ªù (SQL keywords, script tags) ƒë·ªÉ g·∫Øn c·ªù `injection_risk`. Module Policy Overrides s·∫Ω v√¥ hi·ªáu h√≥a h√†nh ƒë·ªông n·∫øu c·ªù n√†y ƒë∆∞·ª£c b·∫≠t.
- **Data Handling:** Module n√†y kh√¥ng l∆∞u tr·ªØ b·∫•t k·ª≥ d·ªØ li·ªáu n√†o c·ªßa ng∆∞·ªùi d√πng. M·ªçi th√¥ng tin ch·ªâ ƒë∆∞·ª£c x·ª≠ l√Ω trong b·ªô nh·ªõ v√† truy·ªÅn cho Stage 3.

---

## 9. NON-FUNCTIONAL REQUIREMENTS (NFRs)

- **Latency:** Nh∆∞ ƒë√£ n√™u trong Success Criteria. Fast path ph·∫£i c·ª±c nhanh ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.
- **Scalability:** Service ph·∫£i l√† stateless ƒë·ªÉ c√≥ th·ªÉ scale ngang d·ªÖ d√†ng. V√¨ c√≥ SLM, c·∫ßn c√≥ c∆° ch·∫ø qu·∫£n l√Ω concurrency ƒë·ªÉ kh√¥ng l√†m qu√° t·∫£i SLM service.
- **Accuracy:** C√°c b·ªô quy t·∫Øc trong Rule Engine ph·∫£i ƒë∆∞·ª£c ki·ªÉm th·ª≠ k·ªπ l∆∞·ª°ng v·ªõi m·ªôt b·ªô d·ªØ li·ªáu l·ªõn ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c v√† gi·∫£m thi·ªÉu vi·ªác ph·∫£i g·ªçi SLM m·ªôt c√°ch kh√¥ng c·∫ßn thi·∫øt.

---

## 12. TESTING STRATEGY

- **Unit Testing:**
  - Test t·ª´ng h√†m trong Rule Engine (v√≠ d·ª•: `test_classify_intent`, `test_parse_budget`).
  - Test t·ª´ng quy t·∫Øc trong Policy Overrides.
  - Mock l·ªùi g·ªçi ƒë·∫øn SLM service.
- **Integration Testing:**
  - Test to√†n b·ªô pipeline c·ªßa Stage 2 v·ªõi c√°c input m·∫´u, ki·ªÉm tra `TaskSpecV1` output.
- **Golden File Testing:**
  - Chu·∫©n b·ªã m·ªôt file `test_cases.jsonl` ch·ª©a h√†ng trƒÉm c·∫∑p `input` -> `expected_task_spec`.
  - Ch·∫°y m·ªôt script ƒë·ªÉ so s√°nh output th·ª±c t·∫ø v·ªõi output mong mu·ªën cho m·ªçi test case. Vi·ªác n√†y c·ª±c k·ª≥ quan tr·ªçng ƒë·ªÉ ph√°t hi·ªán regression khi thay ƒë·ªïi logic c·ªßa Rule Engine ho·∫∑c prompt c·ªßa SLM.

---

## 14. TRADE-OFFS & ALTERNATIVES

- **Quy·∫øt ƒë·ªãnh:** S·ª≠ d·ª•ng ki·∫øn tr√∫c `Rule-first, SLM-backup`.
- **B·ªëi c·∫£nh:** C·∫ßn c√¢n b·∫±ng gi·ªØa t·ªëc ƒë·ªô, chi ph√≠, v√† kh·∫£ nƒÉng x·ª≠ l√Ω c√°c y√™u c·∫ßu ph·ª©c t·∫°p.
- **H·ªá qu·∫£:**
  - **T√≠ch c·ª±c:** Ph·∫ßn l·ªõn request ƒë∆∞·ª£c x·ª≠ l√Ω r·∫•t nhanh v√† r·∫ª. H·ªá th·ªëng c√≥ kh·∫£ nƒÉng "graceful degradation" - khi SLM l·ªói, Rule Engine v·∫´n c√≥ th·ªÉ x·ª≠ l√Ω c√°c case ƒë∆°n gi·∫£n.
  - **Ti√™u c·ª±c:** TƒÉng ƒë·ªô ph·ª©c t·∫°p c·ªßa codebase (ph·∫£i duy tr√¨ c·∫£ hai lu·ªìng logic). C·∫ßn m·ªôt b·ªô test t·ªët ƒë·ªÉ ƒë·∫£m b·∫£o s·ª± nh·∫•t qu√°n gi·ªØa hai lu·ªìng.
- **Ph∆∞∆°ng √°n kh√°c ƒë√£ c√¢n nh·∫Øc:**
  - **SLM-only:** Nhanh h∆°n LLM nh∆∞ng v·∫´n ch·∫≠m v√† t·ªën k√©m h∆°n Rule Engine. Kh√≥ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n 100%.
  - **Rule-only:** ƒê∆°n gi·∫£n nh∆∞ng y·∫øu, kh√¥ng th·ªÉ tr·ªü th√†nh m·ªôt s·∫£n ph·∫©m th√¥ng minh th·ª±c s·ª±.
