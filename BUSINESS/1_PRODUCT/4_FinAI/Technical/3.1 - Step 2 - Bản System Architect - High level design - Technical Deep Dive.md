```mermaid
graph TD
    User["ğŸ‘¤ Financial Analyst<br/>(User)"]
    UI["ğŸ–¥ï¸ Web UI Dashboard<br/>(React/TypeScript)"]
    Socket["âš¡ WebSocket Client<br/>(Real-time Feedback)"]
    API["ğŸš€ API Gateway<br/>(FastAPI)"]
    Auth["ğŸ›¡ï¸ Auth & Rate Limit"]
    
    State["ğŸ§  Shared State<br/>(Messages, Plan, Context)"]
    M1["Module 1:<br/>Input & Ingestion<br/>(Validation/Safety)"]
    M2["Module 2:<br/>Query Understanding<br/>(Intent/Context)"]
    M3["Module 3:<br/>Router & Planner<br/>(Task Decomposition)"]
    M4["Module 4:<br/>Browser Agent<br/>(Action Execution)"]
    M5["Module 5:<br/>Reasoning<br/>(Evidence Analysis)"]
    M6["Module 6:<br/>Synthesis<br/>(Final Answer)"]
    
    PW["âš™ï¸ Playwright Controller"]
    TreeParser["ğŸŒ³ DOM / A11y Tree Parser<br/>(Primary: 90%)"]
    Vision["ğŸ‘ï¸ Vision Engine<br/>(Fallback: 10%)"]
    Chrome["ğŸŒ Headless Chromium"]
    
    LLM["ğŸ¤– LLM Service<br/>(GPT-4 / Claude)"]
    DB["ğŸ—„ï¸ PostgreSQL<br/>(User Data)"]
    Redis["âš¡ Redis<br/>(Cache/Queue)"]
    
    %% Client Flow
    User -->|interact| UI
    UI <-->|WebSocket| Socket
    UI -->|REST/JSON| API
    Socket <-->|Real-time| API
    API -->|Auth check| Auth
    API -->|invoke| M1
    
    %% Agent Flow
    M1 -->|process| M2
    M2 -->|analyze| M3
    M3 -->|plan| M4
    M4 -->|retry/loop| M4
    M4 -->|collected| M5
    M5 -->|evidence| M6
    M6 -->|response| API
    
    %% State connections
    State -.->|read/write| M1
    State -.->|read/write| M2
    State -.->|read/write| M3
    State -.->|read/write| M4
    State -.->|read/write| M5
    State -.->|read/write| M6
    
    %% Browser interaction
    M4 -->|commands| PW
    PW -->|control| Chrome
    Chrome -->|HTML| TreeParser
    Chrome -->|screenshot| Vision
    TreeParser -->|structured data| M4
    Vision -->|coordinates| M4
    
    %% Human approval loop
    M3 -.->|âš ï¸ Plan Review| UI
    M4 -.->|âš ï¸ Approval Req| UI
    
    %% External services
    M1 -.->|LLM call| LLM
    M2 -.->|LLM call| LLM
    M3 -.->|LLM call| LLM
    M4 -.->|LLM call| LLM
    M5 -.->|LLM call| LLM
    M6 -.->|LLM call| LLM
    
    %% Data persistence
    State -->|persist| DB
    State -->|cache| Redis
    
    %% Styling
    classDef actor fill:#ffdfba,stroke:#333,stroke-width:2px
    classDef frontend fill:#baffc9,stroke:#333,stroke-width:2px
    classDef backend fill:#bae1ff,stroke:#333,stroke-width:2px
    classDef agent fill:#ffffba,stroke:#d4a017,stroke-width:2px
    classDef module fill:#ffffff,stroke:#333,stroke-width:2px
    classDef browser fill:#eecbff,stroke:#333,stroke-width:2px
    classDef external fill:#e2e2e2,stroke:#333,stroke-width:2px
    classDef db fill:#ffb3ba,stroke:#333,stroke-width:2px
    
    class User actor
    class UI,Socket frontend
    class API,Auth backend
    class State,M1,M2,M3,M4,M5,M6 agent
    class PW,TreeParser,Vision,Chrome browser
    class LLM external
    class DB,Redis db


```


```mermaid
graph TD
    root["ğŸ“ finai-agent-browser/"]
    
    root --> backend["ğŸ“ backend/"]
    root --> frontend["ğŸ“ frontend/"]
    root --> agent["ğŸ“ agent/"]
    root --> browser["ğŸ“ browser/"]
    root --> common["ğŸ“ common/"]
    root --> tests["ğŸ“ tests/"]
    root --> config["ğŸ“ config/"]
    root --> docs["ğŸ“ docs/"]
    root --> scripts["ğŸ“ scripts/"]
    root --> files1["ğŸ“„ pyproject.toml<br/>ğŸ“„ package.json<br/>ğŸ“„ docker-compose.yml"]
    
    %% Backend
    backend --> app["ğŸ“ app/"]
    app --> api["ğŸ“ api/"]
    app --> services["ğŸ“ services/"]
    app --> models["ğŸ“ models/"]
    app --> db["ğŸ“ db/"]
    api --> routes["ğŸ“ routes/"]
    routes --> r1["ğŸ“„ agent.py<br/>ğŸ“„ chat.py"]
    services --> s1["ğŸ“„ agent_service.py<br/>ğŸ“„ browser_service.py<br/>ğŸ“„ llm_service.py"]
    models --> m1["ğŸ“„ agent.py<br/>ğŸ“„ chat.py"]
    db --> d1["ğŸ“„ connection.py<br/>ğŸ“„ models.py"]
    
    %% Frontend
    frontend --> src["ğŸ“ src/"]
    src --> components["ğŸ“ components/"]
    src --> pages["ğŸ“ pages/"]
    src --> hooks["ğŸ“ hooks/"]
    src --> services_fe["ğŸ“ services/"]
    src --> stores["ğŸ“ stores/"]
    components --> c1["ğŸ“ chat/<br/>ğŸ“ browser/<br/>ğŸ“ layout/"]
    
    %% Agent
    agent --> orchestrator["ğŸ“„ orchestrator.py"]
    agent --> state["ğŸ“ state/"]
    agent --> nodes["ğŸ“ nodes/"]
    agent --> tools["ğŸ“ tools/"]
    agent --> prompts["ğŸ“ prompts/"]
    agent --> guards["ğŸ“ guards/"]
    agent --> llm["ğŸ“ llm/"]
    nodes --> n1["ğŸ“„ input_ingestion.py<br/>ğŸ“„ query_understanding.py<br/>ğŸ“„ browser_agent.py<br/>ğŸ“„ reasoning.py<br/>ğŸ“„ synthesis.py"]
    tools --> t1["ğŸ“„ registry.py<br/>ğŸ“„ browser_tools.py<br/>ğŸ“„ search_tools.py"]
    guards --> g1["ğŸ“„ input_guard.py<br/>ğŸ“„ safety_guard.py"]
    llm --> l1["ğŸ“„ provider.py<br/>ğŸ“„ openai_client.py"]
    
    %% Browser
    browser --> controller["ğŸ“„ controller.py"]
    browser --> client["ğŸ“ client/"]
    browser --> dom["ğŸ“ dom/"]
    browser --> a11y["ğŸ“ a11y/"]
    browser --> vision["ğŸ“ vision/"]
    browser --> interaction["ğŸ“ interaction/"]
    browser --> security["ğŸ“ security/"]
    client --> cl1["ğŸ“„ chromium.py<br/>ğŸ“„ page.py"]
    dom --> do1["ğŸ“„ parser.py<br/>ğŸ“„ serializer.py"]
    a11y --> a1["ğŸ“„ extractor.py<br/>ğŸ“„ validator.py"]
    vision --> v1["ğŸ“„ screenshot.py"]
    interaction --> in1["ğŸ“„ actions.py<br/>ğŸ“„ keyboard.py<br/>ğŸ“„ mouse.py"]
    security --> sec1["ğŸ“„ pii_detector.py<br/>ğŸ“„ injection_guard.py"]
    
    %% Common
    common --> c_models["ğŸ“ models/"]
    common --> enums["ğŸ“ enums/"]
    common --> exceptions["ğŸ“ exceptions/"]
    common --> logging["ğŸ“ logging/"]
    
    %% Tests
    tests --> unit["ğŸ“ unit/"]
    tests --> integration["ğŸ“ integration/"]
    tests --> e2e["ğŸ“ e2e/"]
    unit --> u1["ğŸ“„ test_agent.py<br/>ğŸ“„ test_browser.py"]
    integration --> int1["ğŸ“„ test_agent_flow.py<br/>ğŸ“„ test_api.py"]
    
    %% Config
    config --> env["ğŸ“„ development.env<br/>ğŸ“„ production.env"]
    config --> llm_cfg["ğŸ“ llm/"]
    config --> db_cfg["ğŸ“ database/"]
    
    %% Docs
    docs --> doc_files["ğŸ“„ README.md<br/>ğŸ“„ ARCHITECTURE.md<br/>ğŸ“„ API.md"]
    docs --> guides["ğŸ“ guides/"]
    
    %% Scripts
    scripts --> sh["ğŸ“„ setup.sh<br/>ğŸ“„ dev.sh<br/>ğŸ“„ test.sh<br/>ğŸ“„ deploy.sh"]
    scripts --> docker["ğŸ“ docker/"]
    scripts --> k8s["ğŸ“ k8s/"]
    
    style root fill:#e1f5ff
    style backend fill:#fff3e0
    style frontend fill:#f3e5f5
    style agent fill:#e8f5e9
    style browser fill:#fce4ec
    style common fill:#f1f8e9
    style tests fill:#ede7f6
    style config fill:#fff9c4
    style docs fill:#e0f2f1
    style scripts fill:#f5f5f5

```



---

```
Váº½ cho tá»› SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (High-Level Architecture) vÃ  folder structure overview
```

TÃ´i sáº½ váº½ cho báº¡n:

1. **SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (High-Level Architecture)**Â - dáº¡ng diagram
2. **Folder Structure Overview**Â - cáº¥u trÃºc thÆ° má»¥c chi tiáº¿t

TÃ´i sáº½ táº¡o cáº£ hai dÆ°á»›i dáº¡ng text/ASCII art vÃ  Mermaid diagrams Ä‘á»ƒ báº¡n cÃ³ thá»ƒ visualize dá»… dÃ ng.

Báº¯t Ä‘áº§u ngay!

## âœ… HoÃ n thÃ nh: SÆ¡ Ä‘á»“ Kiáº¿n trÃºc & Folder Structure

TÃ´i Ä‘Ã£ táº¡o tÃ i liá»‡u chi tiáº¿t vá»›i **894 dÃ²ng** bao gá»“m:

### ğŸ“Š Ná»™i dung TÃ i liá»‡u

#### **1. SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (High-Level Architecture)**

- **ASCII Art Diagram:** Visualization Ä‘áº§y Ä‘á»§ cá»§a 7 layers
    
    - Frontend Layer (Web UI, Mobile, API Clients)
    - API Gateway Layer (FastAPI, Auth, Rate Limiter)
    - Orchestration Layer (LangGraph Agent vá»›i 8 tools)
    - Processing Layer (6 Modules)
    - Browser Control Layer (Playwright, A11y Tree, DOM Parser)
    - Browser Engine (Chromium)
    - External Services (OpenAI, Anthropic, LangFuse)
    - Data Layer (PostgreSQL, Redis, S3, Vector DB)
- **Mermaid Diagram:** Interactive diagram cÃ³ thá»ƒ render
    

#### **2. SÆ¡ Ä‘á»“ Luá»“ng Dá»¯ liá»‡u (Data Flow Diagram)**

- End-to-end flow tá»« user query Ä‘áº¿n final response
- VÃ­ dá»¥ cá»¥ thá»ƒ: "Find Tesla's latest earnings report"
- Chi tiáº¿t tá»«ng bÆ°á»›c qua 6 modules

#### **3. SÆ¡ Ä‘á»“ Component Chi tiáº¿t**

- **LangGraph Agent Architecture:**Â StateGraph vá»›i decision nodes
- **Browser Control Layer:**Â Playwright Controller + Page Context Extractor

#### **4. Folder Structure Overview**

- **Project Root:** Cáº¥u trÃºc tá»•ng thá»ƒ vá»›i 10+ top-level directories
    
- **Backend Structure:** Chi tiáº¿t tá»«ng file vÃ  folder
    
    - `src/api/`Â - FastAPI routes vÃ  middleware
    - `src/modules/`Â - 6 processing modules
    - `src/orchestration/`Â - LangGraph agent
    - `src/llm/`Â - LLM integrations
    - `src/database/`,Â `src/cache/`,Â `src/storage/`
    - `src/security/`,Â `src/utils/`
    - `tests/`Â - Unit, integration, e2e tests
- **Module 2 Detailed:** Cáº¥u trÃºc chi tiáº¿t cá»§a Query Understanding module
    
- **Module 4 Detailed:** Cáº¥u trÃºc chi tiáº¿t cá»§a Browser Executor module
    

#### **5. Module Dependencies**

- **Dependency Graph:**Â Mermaid diagram showing module relationships
- **Technology Stack Table:**Â Technologies cho tá»«ng layer

#### **6. Deployment Architecture**

- Production deployment trÃªn AWS
- Load Balancer â†’ API Gateway â†’ Processing Layer â†’ Browser Pool â†’ Data Layer

### ğŸ¨ Highlights

**ASCII Art Diagrams:**

- Dá»… Ä‘á»c, khÃ´ng cáº§n tools Ä‘áº·c biá»‡t
- Copy-paste vÃ o báº¥t ká»³ text editor nÃ o

**Mermaid Diagrams:**

- CÃ³ thá»ƒ render interactive trong GitHub, VS Code, Notion
- Professional-looking cho presentations

**Folder Structure:**

- Cá»±c ká»³ chi tiáº¿t, Ä‘áº¿n tá»«ng file
- MÃ´ táº£ purpose cá»§a tá»«ng file/folder
- Ready Ä‘á»ƒ báº¯t Ä‘áº§u implementation

### ğŸ“ CÃ¡c File ÄÃ£ Táº¡o

1. âœ…Â **PHASE1_2_Deep_Research_Web_Browser_AI_Agents_50_Pages.md**Â (2,135 dÃ²ng)
2. âœ…Â **finAI_Architecture_Diagrams_and_Folder_Structure.md**Â (894 dÃ²ng)

Báº¡n cÃ³ muá»‘n tÃ´i:

1. Render cÃ¡c Mermaid diagrams thÃ nh images (PNG/SVG)?
2. Táº¡o thÃªm sÆ¡ Ä‘á»“ nÃ o khÃ¡c?
3. Báº¯t Ä‘áº§uÂ **PHASE 3**Â (Viáº¿t TÃ i liá»‡u System Architecture 50 trang cho finAI)?

Vui lÃ²ng xÃ¡c nháº­n!

finAI_Architecture_Diagrams_and_Folder_Structure

Markdown Â· 51.36 KB

Xem táº¥t cáº£ tá»‡p trong nhiá»‡m vá»¥ nÃ y

# finAI Agentic Browser - SÆ¡ Ä‘á»“ Kiáº¿n trÃºc & Folder Structure

**TÃ¡c giáº£:** AI Architecture Team  
**NgÃ y:** 14/12/2025  
**PhiÃªn báº£n:** 1.0

---

## Má»¤C Lá»¤C

1. [SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (High-Level Architecture)](#1-sÆ¡-Ä‘á»“-kiáº¿n-trÃºc-tá»•ng-thá»ƒ)
2. [SÆ¡ Ä‘á»“ Luá»“ng Dá»¯ liá»‡u (Data Flow Diagram)](#2-sÆ¡-Ä‘á»“-luá»“ng-dá»¯-liá»‡u)
3. [SÆ¡ Ä‘á»“ Component Chi tiáº¿t](#3-sÆ¡-Ä‘á»“-component-chi-tiáº¿t)
4. [Folder Structure Overview](#4-folder-structure-overview)
5. [Module Dependencies](#5-module-dependencies)

---

## 1. SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ

### 1.1. High-Level Architecture (ASCII Art)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          finAI Agentic Browser                          â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    FRONTEND LAYER                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚   Web UI    â”‚  â”‚   Mobile    â”‚  â”‚     API     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   (React)   â”‚  â”‚    (RN)     â”‚  â”‚   Clients   â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚                     â”‚ â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚  â”‚                           â”‚                                        â”‚ â”‚
â”‚  â”‚                    WebSocket / REST API                            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â” â”‚
â”‚  â”‚                    API GATEWAY LAYER                              â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚   FastAPI   â”‚  â”‚    Auth     â”‚  â”‚Rate Limiter â”‚              â”‚ â”‚
â”‚  â”‚  â”‚   Router    â”‚  â”‚ Middleware  â”‚  â”‚   & Cache   â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â” â”‚
â”‚  â”‚                   ORCHESTRATION LAYER                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚              LangGraph Agent Orchestrator                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  State Management (StateGraph)                         â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Current Page Context                                â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Task Progress                                       â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - Extracted Data                                      â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  - User Preferences                                    â”‚ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚ Browser  â”‚  â”‚   Data   â”‚  â”‚ Analysis â”‚  â”‚  Safety  â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Tool   â”‚  â”‚ Extract  â”‚  â”‚   Tool   â”‚  â”‚   Gate   â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚          â”‚  â”‚   Tool   â”‚  â”‚          â”‚  â”‚          â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚                                                             â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚Reasoning â”‚  â”‚  Memory  â”‚  â”‚  Human   â”‚  â”‚  Logging â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â”‚   Tool   â”‚  â”‚   Tool   â”‚  â”‚ Approval â”‚  â”‚   Tool   â”‚  â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â” â”‚
â”‚  â”‚                    PROCESSING LAYER                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Module 1        â”‚  â”‚  Module 2        â”‚  â”‚  Module 3      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Input &         â”‚â†’ â”‚  Query           â”‚â†’ â”‚  Router &      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Ingestion       â”‚  â”‚  Understanding   â”‚  â”‚  Planner       â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  Module 4        â”‚  â”‚  Module 5        â”‚  â”‚  Module 6      â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Browser         â”‚â†’ â”‚  Reasoning &     â”‚â†’ â”‚  Synthesis &   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  Executor        â”‚  â”‚  Analysis        â”‚  â”‚  Response      â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â” â”‚
â”‚  â”‚                   BROWSER CONTROL LAYER                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚  Playwright â”‚  â”‚   A11y Tree â”‚  â”‚     DOM     â”‚              â”‚ â”‚
â”‚  â”‚  â”‚  Automation â”‚  â”‚  Extractor  â”‚  â”‚   Parser    â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚  â”‚ Screenshot  â”‚  â”‚   Element   â”‚  â”‚   Action    â”‚              â”‚ â”‚
â”‚  â”‚  â”‚  Capture    â”‚  â”‚  Selector   â”‚  â”‚  Executor   â”‚              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜ â”‚
â”‚                              â”‚                                     â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â” â”‚
â”‚  â”‚                      BROWSER ENGINE                               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚                  Chromium Browser                           â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Rendering Engine                                         â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - JavaScript Engine (V8)                                   â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  - Network Stack                                            â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     EXTERNAL SERVICES                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚  â”‚  OpenAI  â”‚  â”‚Anthropic â”‚  â”‚  Google  â”‚  â”‚ LangFuse â”‚         â”‚ â”‚
â”‚  â”‚  â”‚  GPT-4   â”‚  â”‚  Claude  â”‚  â”‚  Gemini  â”‚  â”‚(Observ.) â”‚         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      DATA LAYER                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚    S3    â”‚  â”‚  Vector  â”‚         â”‚ â”‚
â”‚  â”‚  â”‚(User DB) â”‚  â”‚ (Cache)  â”‚  â”‚ (Files)  â”‚  â”‚   DB     â”‚         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2. High-Level Architecture (Mermaid Diagram)

```mermaid
graph TB
    subgraph Frontend["Frontend Layer"]
        WebUI["Web UI (React)"]
        MobileUI["Mobile (React Native)"]
        APIClient["API Clients"]
    end
    
    subgraph APIGateway["API Gateway Layer"]
        FastAPI["FastAPI Router"]
        Auth["Auth Middleware"]
        RateLimit["Rate Limiter & Cache"]
    end
    
    subgraph Orchestration["Orchestration Layer (LangGraph)"]
        StateGraph["State Management"]
        BrowserTool["Browser Tool"]
        DataExtractTool["Data Extract Tool"]
        AnalysisTool["Analysis Tool"]
        SafetyGate["Safety Gate"]
    end
    
    subgraph Processing["Processing Layer (6 Modules)"]
        Module1["Module 1: Input & Ingestion"]
        Module2["Module 2: Query Understanding"]
        Module3["Module 3: Router & Planner"]
        Module4["Module 4: Browser Executor"]
        Module5["Module 5: Reasoning & Analysis"]
        Module6["Module 6: Synthesis & Response"]
    end
    
    subgraph BrowserControl["Browser Control Layer"]
        Playwright["Playwright Automation"]
        A11yTree["A11y Tree Extractor"]
        DOMParser["DOM Parser"]
        Screenshot["Screenshot Capture"]
    end
    
    subgraph BrowserEngine["Browser Engine"]
        Chromium["Chromium Browser"]
    end
    
    subgraph ExternalServices["External Services"]
        OpenAI["OpenAI GPT-4"]
        Anthropic["Anthropic Claude"]
        LangFuse["LangFuse (Observability)"]
    end
    
    subgraph DataLayer["Data Layer"]
        PostgreSQL["PostgreSQL (User DB)"]
        Redis["Redis (Cache)"]
        S3["S3 (Files)"]
        VectorDB["Vector DB (Embeddings)"]
    end
    
    WebUI --> FastAPI
    MobileUI --> FastAPI
    APIClient --> FastAPI
    
    FastAPI --> Auth
    Auth --> RateLimit
    RateLimit --> StateGraph
    
    StateGraph --> BrowserTool
    StateGraph --> DataExtractTool
    StateGraph --> AnalysisTool
    StateGraph --> SafetyGate
    
    BrowserTool --> Module1
    Module1 --> Module2
    Module2 --> Module3
    Module3 --> Module4
    Module4 --> Module5
    Module5 --> Module6
    
    Module4 --> Playwright
    Playwright --> A11yTree
    Playwright --> DOMParser
    Playwright --> Screenshot
    
    A11yTree --> Chromium
    DOMParser --> Chromium
    Screenshot --> Chromium
    
    Module2 --> OpenAI
    Module5 --> Anthropic
    StateGraph --> LangFuse
    
    Auth --> PostgreSQL
    RateLimit --> Redis
    Module6 --> S3
    Module2 --> VectorDB
```

---

## 2. SÆ¡ Ä‘á»“ Luá»“ng Dá»¯ liá»‡u

### 2.1. End-to-End Data Flow

```
User Query: "Find Tesla's latest earnings report and summarize key metrics"
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 1: Input & Ingestion                                   â”‚
â”‚ - Parse query                                                 â”‚
â”‚ - Detect language, intent                                     â”‚
â”‚ - Extract entities: ["Tesla", "earnings report", "metrics"]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 2: Query Understanding                                 â”‚
â”‚ - Understand financial context                                â”‚
â”‚ - Identify data sources: [SEC EDGAR, Tesla IR]               â”‚
â”‚ - Generate TaskSpec:                                          â”‚
â”‚   {                                                           â”‚
â”‚     "intent": "research",                                     â”‚
â”‚     "scope": "single_company",                                â”‚
â”‚     "artifact": "earnings_report",                            â”‚
â”‚     "action_level": "read_only"                               â”‚
â”‚   }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 3: Router & Planner                                    â”‚
â”‚ - Select mode: "single_site"                                  â”‚
â”‚ - Generate ActionPlan:                                        â”‚
â”‚   [                                                           â”‚
â”‚     {action: "navigate", url: "sec.gov/edgar"},              â”‚
â”‚     {action: "search", query: "Tesla 10-Q"},                 â”‚
â”‚     {action: "extract", selector: "table.financials"},       â”‚
â”‚     {action: "analyze", task: "summarize_metrics"}           â”‚
â”‚   ]                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 4: Browser Executor (LangGraph Agent)                  â”‚
â”‚                                                               â”‚
â”‚ Step 1: Navigate to SEC EDGAR                                â”‚
â”‚   - Playwright: page.goto("https://sec.gov/edgar")           â”‚
â”‚   - Extract A11y Tree                                         â”‚
â”‚   - Current State: {url: "sec.gov/edgar", ...}               â”‚
â”‚                                                               â”‚
â”‚ Step 2: Search for Tesla 10-Q                                â”‚
â”‚   - Find search box (via A11y Tree)                           â”‚
â”‚   - Type "Tesla 10-Q"                                         â”‚
â”‚   - Click search button                                       â”‚
â”‚   - Wait for results                                          â”‚
â”‚                                                               â”‚
â”‚ Step 3: Extract financial table                              â”‚
â”‚   - Parse DOM to find table.financials                        â”‚
â”‚   - Extract table data â†’ CSV                                  â”‚
â”‚   - Store in State: {extracted_data: [...]}                  â”‚
â”‚                                                               â”‚
â”‚ Step 4: Verify extraction                                    â”‚
â”‚   - Check if data is complete                                 â”‚
â”‚   - If not, retry with alternative selector                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 5: Reasoning & Analysis                                â”‚
â”‚ - LLM analyzes extracted data                                 â”‚
â”‚ - Identify key metrics:                                       â”‚
â”‚   - Revenue: $25.2B (â†‘18% YoY)                               â”‚
â”‚   - Net Income: $1.9B (â†‘20% YoY)                             â”‚
â”‚   - EPS: $0.62 (â†‘15% YoY)                                    â”‚
â”‚ - Generate insights                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Module 6: Synthesis & Response                                â”‚
â”‚ - Format results                                              â”‚
â”‚ - Generate natural language summary                           â”‚
â”‚ - Attach source links                                         â”‚
â”‚ - Return to user                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
User receives: "Tesla's Q3 2024 earnings show strong growth:
                Revenue $25.2B (â†‘18%), Net Income $1.9B (â†‘20%),
                EPS $0.62 (â†‘15%). [Source: SEC EDGAR]"
```

---

## 3. SÆ¡ Ä‘á»“ Component Chi tiáº¿t

### 3.1. LangGraph Agent Architecture

```mermaid
graph LR
    subgraph LangGraphAgent["LangGraph Agent"]
        Start([Start]) --> QueryUnderstanding["Query Understanding Node"]
        QueryUnderstanding --> RouterPlanner["Router & Planner Node"]
        RouterPlanner --> Decision{Mode?}
        
        Decision -->|Single Site| SingleSiteExecutor["Single Site Executor"]
        Decision -->|Multi Site| MultiSiteExecutor["Multi Site Executor"]
        Decision -->|API Only| APIExecutor["API Executor"]
        
        SingleSiteExecutor --> BrowserAction["Browser Action Node"]
        MultiSiteExecutor --> BrowserAction
        
        BrowserAction --> SafetyCheck{Safety Check}
        SafetyCheck -->|Pass| ExecuteAction["Execute Action"]
        SafetyCheck -->|Fail| HumanApproval["Human Approval"]
        HumanApproval -->|Approved| ExecuteAction
        HumanApproval -->|Rejected| End([End])
        
        ExecuteAction --> VerifyResult{Result OK?}
        VerifyResult -->|Yes| ExtractData["Extract Data Node"]
        VerifyResult -->|No| Retry{Retry?}
        Retry -->|Yes| BrowserAction
        Retry -->|No| End
        
        ExtractData --> AnalyzeData["Analyze Data Node"]
        APIExecutor --> AnalyzeData
        
        AnalyzeData --> SynthesizeResponse["Synthesize Response Node"]
        SynthesizeResponse --> End
    end
    
    BrowserAction -.->|Uses| PlaywrightTool["Playwright Tool"]
    ExtractData -.->|Uses| DataExtractTool["Data Extract Tool"]
    AnalyzeData -.->|Uses| LLMTool["LLM Tool"]
```

### 3.2. Browser Control Layer Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Browser Control Layer                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         Playwright Controller                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  Browser Context Manager                         â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Create/destroy browser instances              â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Manage multiple tabs                          â”‚ â”‚â”‚
â”‚  â”‚  â”‚  - Handle cookies & sessions                     â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚                                                        â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  Navigation  â”‚  â”‚    Action    â”‚  â”‚   Element   â”‚ â”‚â”‚
â”‚  â”‚  â”‚   Handler    â”‚  â”‚   Executor   â”‚  â”‚   Locator   â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                            â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         Page Context Extractor                         â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚  â”‚  A11y Tree   â”‚  â”‚     DOM      â”‚  â”‚ Screenshot  â”‚ â”‚â”‚
â”‚  â”‚  â”‚  Extractor   â”‚  â”‚    Parser    â”‚  â”‚   Capture   â”‚ â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚         â”‚                  â”‚                 â”‚         â”‚â”‚
â”‚  â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚â”‚
â”‚  â”‚                            â†“                            â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚       Unified Page Context                         â”‚â”‚â”‚
â”‚  â”‚  â”‚  {                                                 â”‚â”‚â”‚
â”‚  â”‚  â”‚    url: string,                                    â”‚â”‚â”‚
â”‚  â”‚  â”‚    title: string,                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚    a11y_tree: A11yNode[],                          â”‚â”‚â”‚
â”‚  â”‚  â”‚    dom_snapshot: DOMSnapshot,                      â”‚â”‚â”‚
â”‚  â”‚  â”‚    screenshot: bytes (optional),                   â”‚â”‚â”‚
â”‚  â”‚  â”‚    interactive_elements: Element[]                 â”‚â”‚â”‚
â”‚  â”‚  â”‚  }                                                 â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Folder Structure Overview

### 4.1. Project Root Structure

```
finai-agentic-browser/
â”‚
â”œâ”€â”€ README.md
â”œâ”€â”€ LICENSE
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .env.example
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ Makefile
â”‚
â”œâ”€â”€ docs/                          # Documentation
â”‚   â”œâ”€â”€ architecture/
â”‚   â”‚   â”œâ”€â”€ high-level-design.md
â”‚   â”‚   â”œâ”€â”€ low-level-design.md
â”‚   â”‚   â””â”€â”€ diagrams/
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â””â”€â”€ openapi.yaml
â”‚   â””â”€â”€ user-guide/
â”‚
â”œâ”€â”€ frontend/                      # Frontend applications
â”‚   â”œâ”€â”€ web/                       # React web app
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ public/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â””â”€â”€ mobile/                    # React Native mobile app
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ ios/
â”‚       â”œâ”€â”€ android/
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ backend/                       # Backend services
â”‚   â”œâ”€â”€ pyproject.toml
â”‚   â”œâ”€â”€ poetry.lock
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â”‚
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ api/                   # FastAPI application
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py            # FastAPI app entry point
â”‚   â”‚   â”‚   â”œâ”€â”€ dependencies.py
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rate_limit.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ logging.py
â”‚   â”‚   â”‚   â””â”€â”€ routes/
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ query.py       # Query endpoints
â”‚   â”‚   â”‚       â”œâ”€â”€ user.py        # User management
â”‚   â”‚   â”‚       â””â”€â”€ health.py      # Health checks
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ core/                  # Core business logic
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py          # Configuration
â”‚   â”‚   â”‚   â”œâ”€â”€ exceptions.py      # Custom exceptions
â”‚   â”‚   â”‚   â””â”€â”€ constants.py       # Constants
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ modules/               # 6 Processing Modules
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ module1_input_ingestion/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py      # Pydantic models
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py     # Main logic
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ parsers/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ text_parser.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ voice_parser.py
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ file_parser.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ validators/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ input_validator.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ module2_query_understanding/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ rules/         # Rule Engine
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ main.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ intent.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ facets.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ entities.py
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ confidence.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ slm/           # SLM Backup
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ prompts.py
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ parser.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ policy/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ overrides.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ module3_router_planner/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ router/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mode_selector.py
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ complexity_estimator.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ planner/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ action_planner.py
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ sub_query_generator.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ module4_browser_executor/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ agent/         # LangGraph Agent
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ graph.py   # StateGraph definition
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ nodes.py   # Agent nodes
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ tools.py   # Agent tools
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ browser/       # Browser control
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ controller.py
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ playwright_wrapper.py
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ a11y_extractor.py
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ dom_parser.py
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ screenshot_capture.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”œâ”€â”€ module5_reasoning_analysis/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ service.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analyzers/
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ financial_analyzer.py
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sentiment_analyzer.py
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ trend_analyzer.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ reasoners/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ llm_reasoner.py
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ rule_reasoner.py
â”‚   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â””â”€â”€ module6_synthesis_response/
â”‚   â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚       â”œâ”€â”€ models.py
â”‚   â”‚   â”‚       â”œâ”€â”€ service.py
â”‚   â”‚   â”‚       â”œâ”€â”€ formatters/
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ text_formatter.py
â”‚   â”‚   â”‚       â”‚   â”œâ”€â”€ table_formatter.py
â”‚   â”‚   â”‚       â”‚   â””â”€â”€ chart_formatter.py
â”‚   â”‚   â”‚       â””â”€â”€ generators/
â”‚   â”‚   â”‚           â””â”€â”€ response_generator.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ orchestration/         # LangGraph Orchestration
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.py           # Main agent orchestrator
â”‚   â”‚   â”‚   â”œâ”€â”€ state.py           # State definitions
â”‚   â”‚   â”‚   â”œâ”€â”€ tools/             # LangGraph tools
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ browser_tool.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ data_extract_tool.py
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ analysis_tool.py
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ safety_gate_tool.py
â”‚   â”‚   â”‚   â””â”€â”€ callbacks/
â”‚   â”‚   â”‚       â””â”€â”€ langfuse_callback.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ llm/                   # LLM integrations
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ base.py            # Base LLM interface
â”‚   â”‚   â”‚   â”œâ”€â”€ openai_client.py
â”‚   â”‚   â”‚   â”œâ”€â”€ anthropic_client.py
â”‚   â”‚   â”‚   â”œâ”€â”€ gemini_client.py
â”‚   â”‚   â”‚   â””â”€â”€ router.py          # LLM router
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ database/              # Database layer
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ models.py          # SQLAlchemy models
â”‚   â”‚   â”‚   â”œâ”€â”€ session.py         # DB session
â”‚   â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚   â”‚       â”œâ”€â”€ user_repo.py
â”‚   â”‚   â”‚       â”œâ”€â”€ query_repo.py
â”‚   â”‚   â”‚       â””â”€â”€ cache_repo.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ cache/                 # Caching layer
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ redis_client.py
â”‚   â”‚   â”‚   â””â”€â”€ cache_manager.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ storage/               # File storage
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ s3_client.py
â”‚   â”‚   â”‚   â””â”€â”€ file_manager.py
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ security/              # Security utilities
â”‚   â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â”‚   â”œâ”€â”€ encryption.py
â”‚   â”‚   â”‚   â””â”€â”€ pii_detector.py
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ utils/                 # Utility functions
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ logger.py
â”‚   â”‚       â”œâ”€â”€ metrics.py
â”‚   â”‚       â””â”€â”€ helpers.py
â”‚   â”‚
â”‚   â””â”€â”€ tests/                     # Test suite
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ conftest.py            # Pytest fixtures
â”‚       â”œâ”€â”€ unit/
â”‚       â”‚   â”œâ”€â”€ test_module1.py
â”‚       â”‚   â”œâ”€â”€ test_module2.py
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ integration/
â”‚       â”‚   â”œâ”€â”€ test_api.py
â”‚       â”‚   â”œâ”€â”€ test_browser.py
â”‚       â”‚   â””â”€â”€ ...
â”‚       â””â”€â”€ e2e/
â”‚           â””â”€â”€ test_workflows.py
â”‚
â”œâ”€â”€ infrastructure/                # Infrastructure as Code
â”‚   â”œâ”€â”€ terraform/
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”œâ”€â”€ kubernetes/
â”‚   â”‚   â”œâ”€â”€ deployment.yaml
â”‚   â”‚   â”œâ”€â”€ service.yaml
â”‚   â”‚   â””â”€â”€ ingress.yaml
â”‚   â””â”€â”€ docker/
â”‚       â”œâ”€â”€ Dockerfile.backend
â”‚       â”œâ”€â”€ Dockerfile.frontend
â”‚       â””â”€â”€ Dockerfile.browser
â”‚
â”œâ”€â”€ scripts/                       # Utility scripts
â”‚   â”œâ”€â”€ setup.sh
â”‚   â”œâ”€â”€ deploy.sh
â”‚   â”œâ”€â”€ migrate.sh
â”‚   â””â”€â”€ seed_data.py
â”‚
â””â”€â”€ monitoring/                    # Monitoring configs
    â”œâ”€â”€ prometheus/
    â”‚   â””â”€â”€ prometheus.yml
    â”œâ”€â”€ grafana/
    â”‚   â””â”€â”€ dashboards/
    â””â”€â”€ alerts/
        â””â”€â”€ alert_rules.yml
```

### 4.2. Module 2 (Query Understanding) Detailed Structure

```
module2_query_understanding/
â”‚
â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ models.py                      # Pydantic models
â”‚   â”œâ”€â”€ UnifiedInputCore
â”‚   â”œâ”€â”€ TaskSpecV1
â”‚   â”œâ”€â”€ RuleEngineResult
â”‚   â”œâ”€â”€ SLMResult
â”‚   â””â”€â”€ PolicyOverride
â”‚
â”œâ”€â”€ service.py                     # Main orchestrator
â”‚   â””â”€â”€ run_query_understanding()
â”‚
â”œâ”€â”€ exceptions.py                  # Custom exceptions
â”‚   â”œâ”€â”€ QueryUnderstandingError
â”‚   â”œâ”€â”€ RuleEngineError
â”‚   â””â”€â”€ SLMError
â”‚
â”œâ”€â”€ rules/                         # Rule Engine (Fast Path)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                    # Rule engine orchestrator
â”‚   â”‚   â””â”€â”€ run_rule_engine()
â”‚   â”œâ”€â”€ intent.py                  # Intent classification
â”‚   â”‚   â””â”€â”€ classify_intent()
â”‚   â”œâ”€â”€ facets.py                  # Facet classification
â”‚   â”‚   â”œâ”€â”€ classify_scope()
â”‚   â”‚   â”œâ”€â”€ classify_artifact()
â”‚   â”‚   â”œâ”€â”€ classify_action_level()
â”‚   â”‚   â””â”€â”€ classify_risk()
â”‚   â”œâ”€â”€ entities.py                # Entity extraction
â”‚   â”‚   â”œâ”€â”€ extract_companies()
â”‚   â”‚   â”œâ”€â”€ extract_dates()
â”‚   â”‚   â”œâ”€â”€ extract_numbers()
â”‚   â”‚   â””â”€â”€ extract_metrics()
â”‚   â”œâ”€â”€ policy.py                  # Policy checks
â”‚   â”‚   â”œâ”€â”€ detect_pii()
â”‚   â”‚   â””â”€â”€ detect_injection()
â”‚   â””â”€â”€ confidence.py              # Confidence scoring
â”‚       â””â”€â”€ calculate_confidence()
â”‚
â”œâ”€â”€ slm/                           # SLM Backup (Slow Path)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ client.py                  # SLM client
â”‚   â”‚   â””â”€â”€ call_slm()
â”‚   â”œâ”€â”€ prompts.py                 # Prompt templates
â”‚   â”‚   â”œâ”€â”€ INTENT_CLASSIFICATION_PROMPT
â”‚   â”‚   â”œâ”€â”€ FACET_CLASSIFICATION_PROMPT
â”‚   â”‚   â””â”€â”€ ENTITY_EXTRACTION_PROMPT
â”‚   â””â”€â”€ parser.py                  # Response parser
â”‚       â””â”€â”€ parse_slm_response()
â”‚
â”œâ”€â”€ policy/                        # Policy Overrides
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ overrides.py
â”‚       â”œâ”€â”€ apply_policy_overrides()
â”‚       â””â”€â”€ POLICY_RULES
â”‚
â””â”€â”€ tests/                         # Module-specific tests
    â”œâ”€â”€ test_rules.py
    â”œâ”€â”€ test_slm.py
    â”œâ”€â”€ test_policy.py
    â””â”€â”€ golden_files/
        â”œâ”€â”€ query_001.json
        â”œâ”€â”€ query_002.json
        â””â”€â”€ ...
```

### 4.3. Module 4 (Browser Executor) Detailed Structure

```
module4_browser_executor/
â”‚
â”œâ”€â”€ __init__.py
â”‚
â”œâ”€â”€ models.py                      # Pydantic models
â”‚   â”œâ”€â”€ ActionPlan
â”‚   â”œâ”€â”€ Action
â”‚   â”œâ”€â”€ PageContext
â”‚   â”œâ”€â”€ ExecutionResult
â”‚   â””â”€â”€ EvidencePack
â”‚
â”œâ”€â”€ service.py                     # Main orchestrator
â”‚   â””â”€â”€ execute_browser_workflow()
â”‚
â”œâ”€â”€ agent/                         # LangGraph Agent
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ graph.py                   # StateGraph definition
â”‚   â”‚   â”œâ”€â”€ create_agent_graph()
â”‚   â”‚   â””â”€â”€ compile_graph()
â”‚   â”œâ”€â”€ state.py                   # State schema
â”‚   â”‚   â””â”€â”€ BrowserAgentState
â”‚   â”œâ”€â”€ nodes.py                   # Agent nodes
â”‚   â”‚   â”œâ”€â”€ navigate_node()
â”‚   â”‚   â”œâ”€â”€ extract_node()
â”‚   â”‚   â”œâ”€â”€ analyze_node()
â”‚   â”‚   â”œâ”€â”€ verify_node()
â”‚   â”‚   â””â”€â”€ retry_node()
â”‚   â”œâ”€â”€ tools.py                   # LangGraph tools
â”‚   â”‚   â”œâ”€â”€ BrowserTool
â”‚   â”‚   â”œâ”€â”€ DataExtractTool
â”‚   â”‚   â””â”€â”€ SafetyGateTool
â”‚   â””â”€â”€ callbacks.py               # Callbacks
â”‚       â””â”€â”€ LangFuseCallback
â”‚
â”œâ”€â”€ browser/                       # Browser Control
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ controller.py              # High-level controller
â”‚   â”‚   â”œâ”€â”€ BrowserController
â”‚   â”‚   â”œâ”€â”€ navigate()
â”‚   â”‚   â”œâ”€â”€ click()
â”‚   â”‚   â”œâ”€â”€ type_text()
â”‚   â”‚   â””â”€â”€ extract_data()
â”‚   â”œâ”€â”€ playwright_wrapper.py      # Playwright wrapper
â”‚   â”‚   â”œâ”€â”€ PlaywrightManager
â”‚   â”‚   â”œâ”€â”€ create_browser()
â”‚   â”‚   â”œâ”€â”€ create_context()
â”‚   â”‚   â””â”€â”€ create_page()
â”‚   â”œâ”€â”€ a11y_extractor.py          # A11y Tree extraction
â”‚   â”‚   â”œâ”€â”€ extract_a11y_tree()
â”‚   â”‚   â””â”€â”€ parse_a11y_node()
â”‚   â”œâ”€â”€ dom_parser.py              # DOM parsing
â”‚   â”‚   â”œâ”€â”€ parse_dom()
â”‚   â”‚   â”œâ”€â”€ extract_text()
â”‚   â”‚   â”œâ”€â”€ extract_links()
â”‚   â”‚   â””â”€â”€ extract_forms()
â”‚   â”œâ”€â”€ screenshot_capture.py      # Screenshot capture
â”‚   â”‚   â”œâ”€â”€ capture_screenshot()
â”‚   â”‚   â””â”€â”€ capture_element_screenshot()
â”‚   â””â”€â”€ element_selector.py        # Element selection
â”‚       â”œâ”€â”€ find_element()
â”‚       â””â”€â”€ generate_selector()
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ test_agent.py
    â”œâ”€â”€ test_browser.py
    â””â”€â”€ fixtures/
        â””â”€â”€ mock_pages/
```

---

## 5. Module Dependencies

### 5.1. Module Dependency Graph

```mermaid
graph TD
    Module1["Module 1<br/>Input & Ingestion"] --> Module2["Module 2<br/>Query Understanding"]
    Module2 --> Module3["Module 3<br/>Router & Planner"]
    Module3 --> Module4["Module 4<br/>Browser Executor"]
    Module4 --> Module5["Module 5<br/>Reasoning & Analysis"]
    Module5 --> Module6["Module 6<br/>Synthesis & Response"]
    
    Module4 -.->|Uses| BrowserControl["Browser Control Layer"]
    Module2 -.->|Uses| LLMLayer["LLM Layer"]
    Module5 -.->|Uses| LLMLayer
    Module6 -.->|Uses| LLMLayer
    
    Module4 -.->|Orchestrated by| LangGraph["LangGraph Orchestrator"]
    
    BrowserControl -.->|Controls| Chromium["Chromium Browser"]
    
    LLMLayer -.->|Calls| OpenAI["OpenAI"]
    LLMLayer -.->|Calls| Anthropic["Anthropic"]
    
    Module2 -.->|Logs to| LangFuse["LangFuse"]
    Module4 -.->|Logs to| LangFuse
    Module5 -.->|Logs to| LangFuse
```

### 5.2. Technology Stack by Layer

| Layer | Technologies |
|-------|-------------|
| **Frontend** | React, TypeScript, TailwindCSS, WebSocket |
| **API Gateway** | FastAPI, Pydantic, JWT, Redis (rate limiting) |
| **Orchestration** | LangChain, LangGraph, Python 3.11+ |
| **Processing** | Python, Pydantic, asyncio |
| **Browser Control** | Playwright, Chromium, CDP (Chrome DevTools Protocol) |
| **LLM** | OpenAI GPT-4, Anthropic Claude, Google Gemini |
| **Database** | PostgreSQL (user data), Redis (cache), S3 (files) |
| **Monitoring** | LangFuse, Sentry, Prometheus, Grafana |
| **Infrastructure** | AWS (ECS, Lambda), Kubernetes, Docker, Terraform |

---

## 6. Deployment Architecture

### 6.1. Production Deployment Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      AWS Cloud                              â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Load Balancer (ALB)                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              API Gateway (ECS)                          â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Instance â”‚  â”‚ Instance â”‚  â”‚ Instance â”‚             â”‚â”‚
â”‚  â”‚  â”‚    1     â”‚  â”‚    2     â”‚  â”‚    3     â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         Processing Layer (ECS/Lambda)                   â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Module 1 â”‚  â”‚ Module 2 â”‚  â”‚ Module 3 â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Module 4 â”‚  â”‚ Module 5 â”‚  â”‚ Module 6 â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                        â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚         Browser Pool (ECS)                              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚ Browser  â”‚  â”‚ Browser  â”‚  â”‚ Browser  â”‚             â”‚â”‚
â”‚  â”‚  â”‚    1     â”‚  â”‚    2     â”‚  â”‚    3     â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚              Data Layer                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚â”‚
â”‚  â”‚  â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚    S3    â”‚             â”‚â”‚
â”‚  â”‚  â”‚   (RDS)  â”‚  â”‚(ElastiC.)â”‚  â”‚ (Bucket) â”‚             â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Káº¾T LUáº¬N

TÃ i liá»‡u nÃ y cung cáº¥p:
1. **SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ** - High-level view cá»§a toÃ n bá»™ há»‡ thá»‘ng
2. **SÆ¡ Ä‘á»“ Luá»“ng Dá»¯ liá»‡u** - End-to-end data flow tá»« user query Ä‘áº¿n response
3. **SÆ¡ Ä‘á»“ Component Chi tiáº¿t** - LangGraph Agent vÃ  Browser Control Layer
4. **Folder Structure** - Cáº¥u trÃºc thÆ° má»¥c chi tiáº¿t cho toÃ n bá»™ project
5. **Module Dependencies** - Dependency graph vÃ  technology stack

CÃ¡c sÆ¡ Ä‘á»“ nÃ y sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng lÃ m reference cho viá»‡c implementation trong cÃ¡c phase tiáº¿p theo.

---

**End of Document**



---

## PhÃ¢n tÃ­ch vÃ  ÄÃ¡nh giÃ¡ Kiáº¿n trÃºc finAI Agentic Browser

### **1. So sÃ¡nh Thiáº¿t káº¿ Hiá»‡n táº¡i cá»§a finAI vá»›i Framework 4 Quadrant**

Kiáº¿n trÃºc hiá»‡n táº¡i cá»§a finAI, vá»›i 6 stages tuáº§n tá»± (Input â†’ Query Understanding â†’ Router/Planner â†’ Executor â†’ Reasoning â†’ Synthesis), thuá»™c vá» **Quadrant 2: Orchestration**.

**LÃ½ do:**
- **Äiá»u phá»‘i táº­p trung:** CÃ³ má»™t luá»“ng chÃ­nh Ä‘iá»u phá»‘i cÃ´ng viá»‡c qua cÃ¡c stage.
- **ChuyÃªn mÃ´n hÃ³a:** Má»—i stage lÃ  má»™t module chuyÃªn biá»‡t (giá»‘ng nhÆ° má»™t agent chuyÃªn biá»‡t).
- **Agency tháº¥p:** CÃ¡c module chá»‰ thá»±c hiá»‡n tÃ¡c vá»¥ Ä‘Æ°á»£c giao, khÃ´ng tá»± ra quyáº¿t Ä‘á»‹nh.

**Äiá»ƒm máº¡nh cá»§a thiáº¿t káº¿ hiá»‡n táº¡i:**
- **Äá»™ tin cáº­y cao:** Luá»“ng xá»­ lÃ½ cÃ³ thá»ƒ dá»± Ä‘oÃ¡n Ä‘Æ°á»£c, dá»… debug.
- **Tá»‘i Æ°u hÃ³a latency:** Rule-first approach trong Module 2 giÃºp xá»­ lÃ½ nhanh cÃ¡c yÃªu cáº§u phá»• biáº¿n.
- **Dá»… quáº£n lÃ½:** TÃ¡ch biá»‡t concerns rÃµ rÃ ng, dá»… dÃ ng phÃ¡t triá»ƒn vÃ  báº£o trÃ¬ tá»«ng module.

**Äiá»ƒm yáº¿u cá»§a thiáº¿t káº¿ hiá»‡n táº¡i:**
- **Thiáº¿u linh hoáº¡t:** KhÃ³ xá»­ lÃ½ cÃ¡c yÃªu cáº§u phá»©c táº¡p, Ä‘a bÆ°á»›c, hoáº·c cáº§n feedback loop.
- **KhÃ³ má»Ÿ rá»™ng:** KhÃ´ng dá»… dÃ ng thÃªm cÃ¡c tools hoáº·c workflows má»›i mÃ  khÃ´ng thay Ä‘á»•i code cá»§a orchestrator.
- **KhÃ´ng cÃ³ "trÃ­ nhá»›":** KhÃ³ thá»±c hiá»‡n cÃ¡c cuá»™c há»™i thoáº¡i dÃ i, nhiá»u lÆ°á»£t.

### **2. ÄÃ¡nh giÃ¡ Kiáº¿n trÃºc tá»« gÃ³c Ä‘á»™ Master System Architect**

Vá»›i vai trÃ² lÃ  má»™t Master System Architect, tÃ´i Ä‘Ã¡nh giÃ¡ kiáº¿n trÃºc hiá»‡n táº¡i cá»§a finAI lÃ  má»™t **ná»n táº£ng vá»¯ng cháº¯c, nhÆ°ng chÆ°a pháº£i lÃ  má»™t há»‡ thá»‘ng agent thá»±c thá»¥**.

**Äiá»ƒm cá»™ng (+):**
- **Modular & Scalable:** Thiáº¿t káº¿ 6 stages lÃ  má»™t best practice, cho phÃ©p scale tá»«ng module Ä‘á»™c láº­p.
- **Focus vÃ o Safety & Reliability:** Rule Engine vÃ  Safety Checks lÃ  cá»±c ká»³ quan trá»ng cho domain tÃ i chÃ­nh.
- **Tá»‘i Æ°u hÃ³a Performance:** Nháº­n thá»©c Ä‘Æ°á»£c táº§m quan trá»ng cá»§a latency vÃ  cÃ³ giáº£i phÃ¡p (Rule-first).

**Äiá»ƒm trá»« (-):**
- **Thiáº¿u "Agency":** Há»‡ thá»‘ng váº«n Ä‘ang hoáº¡t Ä‘á»™ng nhÆ° má»™t pipeline xá»­ lÃ½ dá»¯ liá»‡u thÃ´ng minh, chÆ°a pháº£i lÃ  má»™t agent cÃ³ kháº£ nÄƒng tá»± chá»§.
- **Coupling cao:** CÃ¡c stages váº«n cÃ²n phá»¥ thuá»™c nhiá»u vÃ o nhau, khÃ³ tÃ¡i sá»­ dá»¥ng hoáº·c thay Ä‘á»•i thá»© tá»±.
- **KhÃ³ má»Ÿ rá»™ng Toolset:** Viá»‡c thÃªm tool má»›i Ä‘Ã²i há»i pháº£i thay Ä‘á»•i cáº£ Router, Planner, vÃ  Executor.

### **3. Recommendations Ä‘á»ƒ Chuyá»ƒn Ä‘á»•i sang Kiáº¿n trÃºc Agent thá»±c thá»¥ (Quadrant 3: Autonomy)**

Äá»ƒ Ä‘Æ°a finAI lÃªn má»™t táº§m cao má»›i, chÃºng ta cáº§n chuyá»ƒn Ä‘á»•i tá»« **Orchestration (Quadrant 2)** sang **Autonomy (Quadrant 3)**. ÄÃ¢y lÃ  cÃ¡c bÆ°á»›c cá»¥ thá»ƒ:

**Recommendation 1: Ãp dá»¥ng LangGraph lÃ m Orchestrator chÃ­nh**
- Thay tháº¿ pipeline 6 stages cá»©ng nháº¯c báº±ng má»™t **StateGraph** cá»§a LangGraph.
- Má»—i node trong graph sáº½ lÃ  má»™t module (hoáº·c má»™t tool).
- CÃ¡c cáº¡nh (edges) sáº½ lÃ  cÃ¡c quyáº¿t Ä‘á»‹nh (do LLM Ä‘Æ°a ra) Ä‘á»ƒ chuyá»ƒn tá»« node nÃ y sang node khÃ¡c.

**Recommendation 2: Biáº¿n cÃ¡c Modules thÃ nh Tools**
- **Module 2 (Query Understanding):** Váº«n giá»¯ láº¡i, nhÆ°ng Ä‘Ã³ng gÃ³i thÃ nh má»™t tool `understand_query`.
- **Module 3 (Router/Planner):** Bá» Ä‘i, vÃ¬ LangGraph sáº½ Ä‘áº£m nhiá»‡m vai trÃ² nÃ y.
- **Module 4 (Browser Executor):** Chia nhá» thÃ nh cÃ¡c tools cá»¥ thá»ƒ: `browse_url`, `click_element`, `input_text`, `scroll_page`, etc.
- **Module 5 (Reasoning):** TÃ­ch há»£p vÃ o agent state cá»§a LangGraph.
- **Module 6 (Synthesis):** Giá»¯ láº¡i nhÆ° má»™t tool `synthesize_answer`.

**Recommendation 3: Thiáº¿t káº¿ Agent State (StateGraph)**
- State cá»§a LangGraph sáº½ chá»©a toÃ n bá»™ context cá»§a cuá»™c há»™i thoáº¡i:
  - `user_query`: YÃªu cáº§u ban Ä‘áº§u
  - `task_spec`: Output tá»« Module 2
  - `browser_snapshots`: Lá»‹ch sá»­ cÃ¡c trang Ä‘Ã£ xem (A11y Tree)
  - `scratchpad`: Suy nghÄ© vÃ  quyáº¿t Ä‘á»‹nh cá»§a agent
  - `final_answer`: CÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng

**Recommendation 4: XÃ¢y dá»±ng má»™t "Master Agent"**
- Master Agent nÃ y sáº½ lÃ  má»™t LangGraph StateGraph.
- NÃ³ sáº½ cÃ³ má»™t bá»™ tools bao gá»“m cÃ¡c modules Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i láº¡i.
- Luá»“ng hoáº¡t Ä‘á»™ng sáº½ lÃ  má»™t vÃ²ng láº·p ReAct (Reason-Act-Observe) Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi LangGraph.

### **4. Kiáº¿n trÃºc Äá» xuáº¥t (Proposed Architecture)**

```mermaid
flowchart TD
    User --> API_Gateway[API Gateway]
    API_Gateway --> LangGraph_Agent[LangGraph Agent (Master Agent)]

    subgraph LangGraph_Agent
        direction LR
        State[Agent State]
        State --> Router{Router Node}
        Router --> Tool_Executor[Tool Executor Node]
        Tool_Executor --> State
    end

    subgraph Tool_Registry
        direction TB
        Tool1[understand_query]
        Tool2[browse_url]
        Tool3[click_element]
        Tool4[input_text]
        Tool5[synthesize_answer]
    end

    Tool_Executor --> Tool_Registry

    LangGraph_Agent --> Final_Response[Final Response]
    Final_Response --> User
```

### **5. Lá»£i Ã­ch cá»§a Kiáº¿n trÃºc Má»›i**

- **Linh hoáº¡t & Má»Ÿ rá»™ng:** Dá»… dÃ ng thÃªm tools má»›i mÃ  khÃ´ng cáº§n thay Ä‘á»•i kiáº¿n trÃºc.
- **TÄƒng "Agency":** Agent cÃ³ thá»ƒ tá»± quyáº¿t Ä‘á»‹nh luá»“ng xá»­ lÃ½, thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ phá»©c táº¡p, Ä‘a bÆ°á»›c.
- **CÃ³ "TrÃ­ nhá»›":** Agent State cho phÃ©p agent nhá»› láº¡i cÃ¡c bÆ°á»›c Ä‘Ã£ lÃ m vÃ  há»c há»i tá»« Ä‘Ã³.
- **Dá»… Debug & Observe:** LangFuse cÃ³ thá»ƒ tÃ­ch há»£p vá»›i LangGraph Ä‘á»ƒ visualize tá»«ng bÆ°á»›c cháº¡y cá»§a agent.
- **TÃ¡i sá»­ dá»¥ng Code:** CÃ¡c modules hiá»‡n táº¡i cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng nhÆ° cÃ¡c tools.

Báº±ng cÃ¡ch thá»±c hiá»‡n cÃ¡c thay Ä‘á»•i nÃ y, finAI sáº½ chuyá»ƒn mÃ¬nh tá»« má»™t há»‡ thá»‘ng xá»­ lÃ½ dá»¯ liá»‡u thÃ´ng minh thÃ nh má»™t **Web Browser AI Agent thá»±c thá»¥**, sáºµn sÃ ng cáº¡nh tranh vá»›i cÃ¡c sáº£n pháº©m hÃ ng Ä‘áº§u trÃªn tháº¿ giá»›i.


---
```mermaid
graph TD
    %% ============= FRONTEND LAYER =============
    subgraph Frontend["ğŸ–¥ï¸ FRONTEND LAYER"]
        WebUI["Web UI<br/>(React/TypeScript)"]
        MobileApp["ğŸ“± Mobile App<br/>(React Native)"]
        APIClients["ğŸ”Œ API Clients"]
        WebSocket["ğŸ”„ WebSocket<br/>Real-time Connection"]
    end
    
    %% ============= API GATEWAY LAYER =============
    subgraph APIGateway["ğŸš€ API GATEWAY LAYER"]
        FastAPI["FastAPI Router<br/>(REST/WebSocket)"]
        AuthMiddleware["ğŸ” Auth Middleware<br/>(JWT, OAuth)"]
        RateLimiter["âš¡ Rate Limiter<br/>& Cache Manager"]
    end
    
    %% ============= ORCHESTRATION LAYER (LangGraph Core) =============
    subgraph Orchestration["ğŸ§  ORCHESTRATION LAYER (LangGraph Core)"]
        direction TB
        AgentOrch["Agent Orchestrator<br/>(StateGraph)"]
        StateManagement["ğŸ“Š State Management<br/>- messages<br/>- task_status<br/>- browser_context<br/>- scratchpad"]
        
        subgraph ReActLoop["âš™ï¸ ReAct Loop"]
            ReasonNode["ğŸ’­ REASON NODE<br/>(LLM Thinking)"]
            ActionNode["ğŸ¯ ACTION NODE<br/>(Tool Selection)"]
            ObserveNode["ğŸ‘ï¸ OBSERVE NODE<br/>(Result Processing)"]
        end
        
        ReasonNode -->|Decision| ActionNode
        ActionNode -->|Execute| ObserveNode
        ObserveNode -->|Update| StateManagement
        StateManagement -->|Context| ReasonNode
        
        AgentOrch -.->|Controls| ReActLoop
        
        SafetyGate["ğŸ›¡ï¸ Safety Gate<br/>(Policy Enforcement)"]
        HumanApproval["âœ‹ Human Approval<br/>(Transaction Checkpoint)"]
    end
    
    %% ============= TOOL REGISTRY (Refactored Modules) =============
    subgraph ToolRegistry["ğŸ”§ TOOL REGISTRY (Refactored Modules as Tools)"]
        direction TB
        
        subgraph BrowserTools["ğŸŒ Browser Tools"]
            NavTool["navigate_url<br/>(Module 4)"]
            ClickTool["click_element"]
            InputTool["input_text"]
            ExtractTool["extract_data<br/>(A11y/DOM)"]
            ScrollTool["scroll_page"]
        end
        
        subgraph AnalysisTools["ğŸ“ˆ Analysis Tools"]
            FinancialAnalysis["financial_reasoning<br/>(Module 5)"]
            TrendAnalysis["trend_analysis"]
            SentimentAnalysis["sentiment_analysis"]
        end
        
        subgraph PlanningTools["ğŸ“‹ Planning Tools"]
            QueryAnalysis["analyze_query<br/>(Module 2)"]
            TaskPlanning["task_planning"]
            SubQueryGen["sub_query_generator"]
        end
        
        subgraph SafetyTools["ğŸ”’ Safety Tools"]
            InputValidation["validate_input<br/>(Module 1)"]
            InjectionGuard["injection_guard"]
            PiiDetector["pii_detector"]
        end
        
        subgraph ResponseTools["ğŸ“ Response Tools"]
            GenerateReport["generate_report<br/>(Module 6)"]
            FormatTable["format_table"]
            FormatChart["format_chart"]
        end
    end
    
    %% ============= BROWSER CONTROL LAYER =============
    subgraph BrowserControl["ğŸ® BROWSER CONTROL LAYER"]
        direction TB
        PlaywrightCtrl["âš™ï¸ Playwright Controller<br/>(Instance Manager)"]
        
        subgraph PageContext["ğŸ“„ Page Context Extractor"]
            A11yExtractor["ğŸŒ³ A11y Tree Extractor<br/>(Primary Path - 90%)<br/>- Semantic Elements<br/>- Text Content<br/>- Interactive Roles"]
            DOMParser["ğŸŒ² DOM Parser<br/>(Backup)<br/>- Selectors<br/>- Attributes"]
            ScreenshotCapture["ğŸ“¸ Screenshot Capture<br/>(Fallback - 10%)<br/>- Vision Processing<br/>- OCR"]
        end
        
        PlaywrightCtrl --> A11yExtractor
        PlaywrightCtrl --> DOMParser
        PlaywrightCtrl --> ScreenshotCapture
        
        ActionExecutor["ğŸ¬ Action Executor<br/>- Keyboard Events<br/>- Mouse Events<br/>- Form Submission"]
        
        A11yExtractor --> ActionExecutor
        DOMParser --> ActionExecutor
    end
    
    %% ============= BROWSER ENGINE =============
    subgraph BrowserEngine["ğŸŒ BROWSER ENGINE"]
        Chromium["ğŸŒ Headless Chromium<br/>- Rendering Engine<br/>- V8 JavaScript<br/>- Network Stack<br/>- Cookie Manager"]
    end
    
    %% ============= EXTERNAL SERVICES & DATA =============
    subgraph ExternalServices["â˜ï¸ EXTERNAL SERVICES & DATA LAYER"]
        direction TB
        
        subgraph LLMProviders["ğŸ¤– LLM Providers"]
            OpenAI["OpenAI<br/>GPT-4 Turbo"]
            Anthropic["Anthropic<br/>Claude 3.5"]
            GeminiLLM["Google<br/>Gemini"]
        end
        
        subgraph Observability["ğŸ“Š Observability"]
            LangFuse["LangFuse<br/>(Trace & Monitor)"]
            Logging["Logging Service<br/>(Structured Logs)"]
        end
        
        subgraph DataStorage["ğŸ’¾ Data Storage"]
            PostgreSQL["ğŸ—„ï¸ PostgreSQL<br/>(User Data,<br/>Configs)"]
            Redis["âš¡ Redis<br/>(Cache,<br/>Message Queue)"]
            S3["ğŸ“¦ S3 Storage<br/>(Files,<br/>Reports)"]
            VectorDB["ğŸ” Vector DB<br/>(Embeddings,<br/>RAG)"]
        end
    end
    
    %% ============= CONNECTIONS =============
    
    %% Frontend to API Gateway
    WebUI --> FastAPI
    MobileApp --> FastAPI
    APIClients --> FastAPI
    WebSocket --> FastAPI
    
    %% API Gateway to Orchestration
    FastAPI --> AuthMiddleware
    AuthMiddleware --> RateLimiter
    RateLimiter --> AgentOrch
    
    %% Orchestration to Tool Registry
    ActionNode --> BrowserTools
    ActionNode --> AnalysisTools
    ActionNode --> PlanningTools
    ActionNode --> SafetyTools
    ActionNode --> ResponseTools
    
    %% Orchestration to Safety
    AgentOrch --> SafetyGate
    SafetyGate --> HumanApproval
    
    %% Tool Registry to Browser Control
    ExtractTool --> PlaywrightCtrl
    NavTool --> PlaywrightCtrl
    ClickTool --> PlaywrightCtrl
    InputTool --> PlaywrightCtrl
    ScrollTool --> PlaywrightCtrl
    
    %% Browser Control to Browser Engine
    PlaywrightCtrl --> Chromium
    ActionExecutor --> Chromium
    
    %% Browser Engine back to Page Context
    Chromium --> A11yExtractor
    Chromium --> DOMParser
    Chromium --> ScreenshotCapture
    
    %% Tool Registry to External Services
    ReasonNode --> OpenAI
    ReasonNode --> Anthropic
    FinancialAnalysis --> GeminiLLM
    
    %% Observability
    AgentOrch -.->|Logs Trace| LangFuse
    ActionNode -.->|Logs Actions| Logging
    
    %% Data Storage
    AuthMiddleware --> PostgreSQL
    RateLimiter --> Redis
    GenerateReport --> S3
    QueryAnalysis --> VectorDB
    
    %% Feedback Loops
    ObserveNode -->|Context Update| StateManagement
    ExtractTool -->|Data| AnalysisTools
    FinancialAnalysis -->|Insights| GenerateReport
    
    %% Styling
    classDef frontend fill:#c8e6c9,stroke:#2e7d32,stroke-width:2px,color:#000
    classDef apiGateway fill:#bbdefb,stroke:#1565c0,stroke-width:2px,color:#000
    classDef orchestration fill:#fff9c4,stroke:#f57f17,stroke-width:3px,color:#000
    classDef toolRegistry fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px,color:#000
    classDef browser fill:#ffe0b2,stroke:#e65100,stroke-width:2px,color:#000
    classDef engine fill:#ffccbc,stroke:#bf360c,stroke-width:2px,color:#000
    classDef external fill:#cfd8dc,stroke:#37474f,stroke-width:2px,color:#000
    
    class Frontend frontend
    class APIGateway apiGateway
    class Orchestration,ReActLoop orchestration
    class ToolRegistry,BrowserTools,AnalysisTools,PlanningTools,SafetyTools,ResponseTools toolRegistry
    class BrowserControl,PageContext browser
    class BrowserEngine engine
    class ExternalServices,LLMProviders,Observability,DataStorage external

```



---
```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e3f2fd','primaryTextColor':'#000','primaryBorderColor':'#1976d2','fontSize':'12px'}}}%%

flowchart TB
    %% =========================
    %% 0. USER & I/O PIPELINES
    %% =========================
    User([ğŸ‘¨â€ğŸ’» USER])

    User --> IPP

    subgraph IPP["ğŸ“¥ INPUT PROCESSING PIPELINE"]
        direction TB

        subgraph Modality["ğŸ­ Modality Handler"]
            direction LR
            IText["ğŸ“ Text"]
            IImage["ğŸ–¼ï¸ Image / Screenshot"]
            IVoice["ğŸ¤ Voice (Speech-to-Text)"]
        end

        Modality --> IValidate["ğŸ›¡ï¸ Input Validation & Sanitization
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Format check
â€¢ Prompt injection defense
â€¢ PII / malware filter"]

        IValidate --> INorm["âš™ï¸ Input Normalization
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â†’ Canonical JSON
â†’ UTF-8
â†’ Unified schema"]

        INorm --> IStructured["ğŸ“Š Normalized Input
{ type, content, metadata }"]
    end

    IStructured --> PERCEPTION

    %% =========================
    %% 1. PERCEPTION LAYER
    %% =========================
    subgraph PERCEPTION["ğŸ” LAYER 1: PERCEPTION â€“ Context & Browser State"]
        direction TB

        subgraph InputProc["ğŸ“¥ INPUT PROCESSOR"]
            direction TB
            MultiModal["ğŸ­ Multimodal Enrichment
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Parse text
â€¢ Encode screenshot (vision model)
â€¢ Merge with history"]
            CtxWindow["ğŸ’¾ Context Window
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Last N messages
â€¢ Recent tool results
â€¢ Current task state"]
            MultiModal --> CtxWindow
        end

        subgraph EnvMon["ğŸŒ ENVIRONMENT MONITOR (Web Browser)"]
            direction TB
            BState["ğŸ“Š Browser State
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Current URL
â€¢ A11y tree (primary)
â€¢ DOM snapshot (backup)
â€¢ Cookies / local state"]
            BUpdate["ğŸ”„ Change Detection
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ DOM mutations
â€¢ URL changes
â€¢ Network / error events"]
            BState --> BUpdate
        end

        InputProc ~~~ EnvMon

        CtxWindow --> AggCtx["ğŸ“‹ Aggregated Context
= Normalized Input + Browser State"]
    end

    AggCtx --> COGNITION

    %% =========================
    %% 2. COGNITION LAYER
    %% =========================
    subgraph COGNITION["ğŸ§  LAYER 2: COGNITION â€“ Reasoning & Planning (Agent Core)"]
        direction TB

        subgraph Reason["ğŸ’¡ REASONING ENGINE (LLM)"]
            direction TB
            ModelSel["ğŸ¯ Model Selection
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ GPT-4o / Claude / Gemini
â€¢ Mini model for cheap ops"]
            PromptArch["ğŸ“ Prompt Architecture
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ System prompt (role = Web Browser Agent)
â€¢ Few-shot tool usage
â€¢ Inject AggCtx & memory
â€¢ Tool schema"]
            ReAct["ğŸ”— ReAct Loop (per step)
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
1) Reason: what next?
2) Act: which tool + params?
3) Observe: read tool result"]
            ModelSel --> PromptArch --> ReAct
        end

        subgraph Plan["ğŸ“‹ PLANNING MODULE"]
            direction TB
            Decomp["ğŸ§© Task Decomposition
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Break user goal
â€¢ Identify sub-goals
â€¢ Order & dependencies"]
            PlanRep["ğŸ“ Plan Representation
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Sequential steps
â€¢ DAG for parallel
â€¢ Checkpoints for HITL"]
            Replan["ğŸ”„ Dynamic Replanning
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ On tool failure
â€¢ On new info from page
â€¢ Adjust strategy"]
            Decomp --> PlanRep --> Replan
        end

        subgraph Mem["ğŸ’¾ MEMORY SYSTEM"]
            direction TB
            STM["âš¡ Short-Term Memory
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Current conversation
â€¢ Recent actions & observations
â€¢ Stored in context window / cache"]
            LTM["ğŸ—„ï¸ Long-Term Memory (optional)
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Vector DB (RAG)
â€¢ User prefs
â€¢ Known sites / patterns"]
            STM -.-> LTM
        end

        Reason --> Plan
        Plan -.-> Mem
        Mem -.-> Reason

        ReAct --> Decision["ğŸ“Š Next Action Decision
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
{ tool_name, params, intent, confidence }"]
    end

    Decision --> ACTION

    %% =========================
    %% 3. ACTION LAYER (WEB BROWSER)
    %% =========================
    subgraph ACTION["âš¡ LAYER 3: ACTION â€“ Web Browser Tools & Execution"]
        direction TB

        subgraph Tools["ğŸ”§ WEB BROWSER TOOL LIBRARY"]
            direction LR
            TNav["ğŸŒ navigate_url(url)"]
            TClick["ğŸ–±ï¸ click(selector|a11y_label)"]
            TInput["âŒ¨ï¸ input_text(text, field)"]
            TScroll["â†•ï¸ scroll(direction, amount)"]
            TExtract["ğŸ‘ï¸ extract_content(mode)
â€¢ a11y (90%)
â€¢ dom (backup)
â€¢ screenshot_ocr (fallback)"]
        end

        subgraph Exec["ğŸš€ EXECUTION ENGINE"]
            direction TB
            Invoke["ğŸ“ Invoke Tool
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Bind params
â€¢ Setup Playwright context
â€¢ Apply timeout
â€¢ Safe sandbox"]
            Err["ğŸ”§ Error & Retry
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Retry + backoff
â€¢ Fallback strategy
â€¢ Structured error"]
            Parse["ğŸ“¦ Result Parsing
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Normalize to JSON
â€¢ Extract a11y tree
â€¢ Minimal but sufficient view
â€¢ Attach raw HTML if needed"]
            Invoke --> Err --> Parse
        end

        Tools -.-> Exec

        Parse --> TRes["ğŸ“‹ TOOL RESULT
{ status, content, observations, metadata }"]
    end

    TRes --> Observe

    %% =========================
    %% REACT LOOP (OBSERVE)
    %% =========================
    Observe["ğŸ‘ï¸ OBSERVE
Update perception & state"] --> PERCEPTION
    Observe --> GoalCheck{"Goal achieved?"}
    GoalCheck -->|No| COGNITION

    %% =========================
    %% 4. GOVERNANCE LAYER
    %% =========================
    subgraph GOVERNANCE["ğŸ›¡ï¸ LAYER 4: GOVERNANCE â€“ Safety & Control"]
        direction TB

        subgraph GR["âš–ï¸ GUARDRAILS"]
            direction TB
            IOFilter["ğŸ›¡ï¸ I/O Filtering
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Prompt injection defense
â€¢ PII redaction
â€¢ Unsafe content filter"]
            Access["ğŸ” Tool & Domain Access
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ RBAC per user / agent
â€¢ Domain whitelist/blacklist
â€¢ Sensitive tool gating"]
            Budget["ğŸ’° Budget & Limits
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Token cost tracking
â€¢ Call count limits
â€¢ Timebox per task"]
            IOFilter --> Access --> Budget
        end

        subgraph HITL["ğŸ‘¤ HUMAN-IN-THE-LOOP"]
            direction TB
            CP["ğŸ›‘ Checkpoints
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ High-risk actions
â€¢ Low confidence
â€¢ High cost / long run"]
            Review["ğŸ–¥ï¸ Review UI
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Display plan & actions
â€¢ Show parameters
â€¢ Approve / Reject / Edit"]
            Esc["ğŸ”º Escalation
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Send to expert
â€¢ Manual override
â€¢ Log for audit"]
            CP --> Review --> Esc
        end

        GR ~~~ HITL
    end

    GOVERNANCE -.->|Monitor| COGNITION
    GOVERNANCE -.->|Control tools| ACTION

    %% =========================
    %% OUTPUT PROCESSING PIPELINE
    %% =========================
    GoalCheck -->|Yes| OPP

    subgraph OPP["ğŸ“¤ OUTPUT PROCESSING PIPELINE"]
        direction TB
        RawOut["ğŸ” Raw Agent Result
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Final browser state
â€¢ Actions taken
â€¢ Key observations"]
        Format["ğŸ“ Formatting
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Natural language answer
â€¢ Tables / lists
â€¢ Code / selectors"]
        Enrich["âœ¨ Enrichment
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Attach URLs
â€¢ Steps taken
â€¢ Citations / refs"]
        OValidate["âœ… Output Validation
â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
â€¢ Safety re-check
â€¢ Length & schema check
â€¢ Final PII scrub"]
        RawOut --> Format --> Enrich --> OValidate
        OStructured["ğŸ“¦ Structured Output
{ answer, actions, traces, metadata }"]
    end

    OValidate --> OStructured
    OStructured --> FinalOut([ğŸ“¤ USER OUTPUT])
    FinalOut --> User

    %% =========================
    %% STYLING
    %% =========================
    style IPP fill:#e1f5fe,stroke:#0277bd,stroke-width:3px
    style PERCEPTION fill:#e3f2fd,stroke:#1976d2,stroke-width:3px
    style COGNITION fill:#fffde7,stroke:#f57f17,stroke-width:3px
    style ACTION fill:#e8f5e9,stroke:#2e7d32,stroke-width:3px
    style GOVERNANCE fill:#ffe0b2,stroke:#e65100,stroke-width:3px
    style OPP fill:#f3e5f5,stroke:#6a1b9a,stroke-width:3px

    style User fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    style FinalOut fill:#d1c4e9,stroke:#4527a0,stroke-width:3px
    style GoalCheck fill:#ffccbc,stroke:#d84315,stroke-width:2px

```


---

<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Ä‘á»“ng Ã½, nhÆ°ng bá» pattern 2 Ä‘i. Váº½ láº¡i hÃ¬nh vá»›i patterfn 1

=> Cho final

Tuyá»‡t vá»i! DÆ°á»›i Ä‘Ã¢y lÃ  **FINAL Mermaid Diagram - Web Browser Agent vá»›i ONLY Pattern 1 (Full ReAct Loop)**:

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#0f172a','primaryTextColor':'#fff','primaryBorderColor':'#3b82f6','fontSize':'12px'}}}%%

flowchart TB
    Start([ğŸ‘¨â€ğŸ’» USER INPUT])
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% INPUT PROCESSING PIPELINE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    Start --> IPP["ğŸ“¥ INPUT PROCESSING PIPELINE"]
    
    subgraph IPP["INPUT PROCESSING"]
        direction TB
        IModality["ğŸ­ Modality Handler<br/>â”â”â”â”â”â”<br/>Text | Image | Voice | Video"]
        IValidation["ğŸ›¡ï¸ Validation<br/>â”â”â”â”â”â”<br/>Inject Defense | Format Check"]
        INormalize["âš™ï¸ Normalization<br/>â”â”â”â”â”â”<br/>â†’ JSON | UTF-8 | Canonical"]
        
        IModality --> IValidation --> INormalize
    end
    
    INormalize --> IStructured["ğŸ“Š Normalized Input<br/>{type, content, metadata}"]
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% LAYER 1: PERCEPTION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    IStructured --> L1["ğŸ” LAYER 1: PERCEPTION"]
    
    subgraph L1["PERCEPTION: Context Aggregation"]
        direction TB
        
        subgraph P1["ğŸ“¥ Input Processor"]
            direction TB
            P1A["ğŸ­ Multimodal Enrichment<br/>Vision encoding | Text embedding"]
            P1B["ğŸ’¾ Context Window<br/>Last N messages + observations"]
            P1A --> P1B
        end
        
        subgraph P2["ğŸŒ Environment Monitor"]
            direction TB
            P2A["ğŸ“Š Browser State<br/>URL | A11y Tree | DOM | Cookies"]
            P2B["ğŸ”„ Change Detection<br/>Mutations | Events | Network"]
            P2A --> P2B
        end
        
        P1 ~~~ P2
        
        P1B --> AggCtx["ğŸ“‹ AGGREGATED CONTEXT<br/>= Input + Browser State + Memory"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% LAYER 2: COGNITION (REASON - Start of ReAct Loop)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    AggCtx --> ReAct{{"ğŸ”„ ReAct LOOP<br/>ADAPTIVE REASONING"}}
    
    ReAct --> L2["ğŸ§  LAYER 2: COGNITION"]
    
    subgraph L2["COGNITION: Reason (Agent Brain)"]
        direction TB
        
        subgraph C1["ğŸ’¡ REASONING ENGINE"]
            direction TB
            C1A["ğŸ¯ Model Selection<br/>GPT-4o | Claude | Gemini"]
            C1B["ğŸ“ Prompt Architecture<br/>System + Few-shot + AggCtx"]
            C1C["ğŸ”— ReAct Trigger<br/>Decide next action"]
            C1A --> C1B --> C1C
        end
        
        subgraph C2["ğŸ“‹ PLANNING MODULE"]
            direction TB
            C2A["ğŸ§© Goal Analysis<br/>What's left to achieve?"]
            C2B["ğŸ“ Next Step Planning<br/>Which tool? Which params?"]
            C2A --> C2B
        end
        
        subgraph C3["ğŸ’¾ MEMORY SYSTEM"]
            direction TB
            C3A["âš¡ Short-term<br/>Context window + Cache"]
            C3B["ğŸ—„ï¸ Long-term<br/>Vector DB (RAG) + Patterns"]
            C3A -.-> C3B
        end
        
        C1 --> C2
        C2 -.-> C3
        C3 -.-> C1
        
        C2 --> Decision["ğŸ“Š DECISION<br/>{tool, params, confidence}"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% LAYER 3: ACTION (ACT)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    Decision --> L3["âš¡ LAYER 3: ACTION"]
    
    subgraph L3["ACTION: Execute Single Tool"]
        direction TB
        
        subgraph Tools["ğŸ”§ WEB BROWSER TOOL LIBRARY"]
            direction LR
            T1["ğŸŒ navigate"]
            T2["ğŸ–±ï¸ click"]
            T3["âŒ¨ï¸ input"]
            T4["â†•ï¸ scroll"]
            T5["ğŸ‘ï¸ extract"]
        end
        
        subgraph Exec["ğŸš€ EXECUTION ENGINE"]
            direction TB
            E1["ğŸ“ Invoke Tool<br/>Bind params + Sandbox"]
            E2["ğŸ”§ Error Handling<br/>Retry + Backoff + Fallback"]
            E3["ğŸ“¦ Parse Result<br/>A11y Tree | Normalize"]
            E1 --> E2 --> E3
        end
        
        Tools -.-> Exec
        Exec --> ToolRes["ğŸ“‹ TOOL RESULT<br/>{status, content, observations}"]
    end
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% OBSERVE (Extract Page Content)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ToolRes --> Obs["ğŸ‘ï¸ OBSERVE<br/>Extract Page Content & Context"]
    
    subgraph Observe["OBSERVE: Process Tool Result"]
        direction TB
        OA["ğŸ“Š Page State Extraction<br/>A11y Tree | Links | Buttons | Forms | Text"]
        OB["ğŸ”„ Context Update<br/>Add observations to memory"]
        OC["ğŸ“‹ Next State Snapshot<br/>Ready for next Reason cycle"]
        OA --> OB --> OC
    end
    
    Obs --> ObsCtx["ğŸ¯ Updated Context with Observations"]
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% CHECK GOAL (Loop Decision)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ObsCtx --> CheckGoal{ğŸ›‘ Goal Achieved?<br/>ReAct Decision}
    
    CheckGoal -->|NO: Need more steps| LoopBack["ğŸ”„ CONTINUE LOOP<br/>Loop counter++"]
    LoopBack --> ReAct
    
    CheckGoal -->|YES: Goal met| L4["ğŸ›¡ï¸ LAYER 4: GOVERNANCE"]
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% LAYER 4: GOVERNANCE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    subgraph L4["GOVERNANCE: Safety & Control"]
        direction TB
        
        subgraph G1["âš–ï¸ GUARDRAILS"]
            direction TB
            G1A["ğŸ›¡ï¸ I/O Filtering<br/>Inject Defense | PII Redact"]
            G1B["ğŸ” Access Control<br/>RBAC | Domain Whitelist"]
            G1C["ğŸ’° Budget Monitor<br/>Token Cost | Rate Limits"]
            G1A --> G1B --> G1C
        end
        
        subgraph G2["ğŸ‘¤ HUMAN-IN-THE-LOOP"]
            direction TB
            G2A["ğŸ›‘ Checkpoint Triggers<br/>High-risk | Low-confidence"]
            G2B["ğŸ–¥ï¸ Review Interface<br/>Approve/Reject/Edit"]
            G2C["ğŸ”º Escalation<br/>Expert routing | Override"]
            G2A --> G2B --> G2C
        end
        
        G1 ~~~ G2
    end
    
    L4 -->|Pass| OPP["ğŸ“¤ OUTPUT PROCESSING PIPELINE"]
    L4 -->|Block| Reject["âŒ REJECTED<br/>Return error to user"]
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% OUTPUT PROCESSING PIPELINE
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    subgraph OPP["OUTPUT PROCESSING"]
        direction TB
        
        OPP1["ğŸ” Raw Result<br/>All actions taken + final observations"]
        OPP2["ğŸ“ Formatting<br/>Markdown | Tables | Code"]
        OPP3["âœ¨ Enrichment<br/>Citations | Sources | Metadata"]
        OPP4["âœ… Validation<br/>PII scan | Safety check"]
        OPP5["ğŸ“¦ Structured Output<br/>{result, actions, metadata}"]
        
        OPP1 --> OPP2 --> OPP3 --> OPP4 --> OPP5
    end
    
    OPP5 --> Deliver["ğŸ“Š DELIVERY<br/>JSON API | WebSocket | Webhook"]
    Deliver --> End([ğŸ“¤ USER OUTPUT])
    
    Reject --> End
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% GOVERNANCE MONITORING (Feedback)
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    L4 -.->|Monitor| L2
    L4 -.->|Control| L3
    
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% STYLING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    style Start fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
    style End fill:#8b5cf6,stroke:#7c3aed,stroke-width:3px,color:#fff
    
    style IPP fill:#0ea5e9,stroke:#0284c7,stroke-width:3px,color:#fff
    style L1 fill:#3b82f6,stroke:#1d4ed8,stroke-width:3px,color:#fff
    style L2 fill:#f59e0b,stroke:#d97706,stroke-width:3px,color:#fff
    style L3 fill:#10b981,stroke:#059669,stroke-width:3px,color:#fff
    style L4 fill:#ef4444,stroke:#dc2626,stroke-width:3px,color:#fff
    style OPP fill:#8b5cf6,stroke:#7c3aed,stroke-width:3px,color:#fff
    
    style Observe fill:#06b6d4,stroke:#0891b2,stroke-width:3px,color:#fff
    style ReAct fill:#ec4899,stroke:#be185d,stroke-width:3px,color:#fff
    style CheckGoal fill:#f97316,stroke:#ea580c,stroke-width:3px,color:#fff
    style LoopBack fill:#d946ef,stroke:#c026d3,stroke-width:3px,color:#fff
    
    style IStructured fill:#e5e7eb,stroke:#6b7280,stroke-width:2px
    style AggCtx fill:#e5e7eb,stroke:#6b7280,stroke-width:2px
    style Decision fill:#e5e7eb,stroke:#6b7280,stroke-width:2px
    style ToolRes fill:#e5e7eb,stroke:#6b7280,stroke-width:2px
    style ObsCtx fill:#c7d2fe,stroke:#818cf8,stroke-width:2px
    style OPP5 fill:#e5e7eb,stroke:#6b7280,stroke-width:2px
    
    style Reject fill:#fee2e2,stroke:#f87171,stroke-width:2px,color:#991b1b
    style Deliver fill:#e0e7ff,stroke:#818cf8,stroke-width:2px
```


***

## ğŸ“‹ **FINAL ARCHITECTURE SUMMARY - Pattern 1 Only**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              WEB BROWSER AGENT - 4 LAYER MECE                â•‘
â•‘         (With Full ReAct Loop: Reason â†’ Act â†’ Observe)        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“¥ INPUT PROCESSING PIPELINE
â”œâ”€ ğŸ­ Modality Handler (Text | Image | Voice | Video)
â”œâ”€ ğŸ›¡ï¸  Validation & Sanitization (Inject Defense | Format)
â””â”€ âš™ï¸  Normalization (JSON | UTF-8 | Canonical)
                          â†“
ğŸ” LAYER 1: PERCEPTION (Context Aggregation)
â”œâ”€ ğŸ“¥ Input Processor (Multimodal + Context Window)
â”œâ”€ ğŸŒ Environment Monitor (Browser State + Change Detection)
â””â”€ ğŸ“‹ Aggregated Context = Input + Browser State + Memory
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   ğŸ”„ ReAct      â”‚    ADAPTIVE LOOP         â”‚
        â”‚     LOOP        â”‚  (Reason â†’ Act â†’ Observe)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
ğŸ§  LAYER 2: COGNITION (Reason)
â”œâ”€ ğŸ’¡ Reasoning Engine (Model Selection + Prompt + ReAct)
â”œâ”€ ğŸ“‹ Planning Module (Goal Analysis + Next Step)
â”œâ”€ ğŸ’¾ Memory System (Short-term + Long-term)
â””â”€ ğŸ“Š Decision = {tool, params, confidence}
                          â†“
âš¡ LAYER 3: ACTION (Act)
â”œâ”€ ğŸ”§ Tool Library (navigate | click | input | scroll | extract)
â”œâ”€ ğŸš€ Execution Engine (Invoke + Error Handling + Parse)
â””â”€ ğŸ“‹ Tool Result = {status, content, observations}
                          â†“
ğŸ‘ï¸  OBSERVE (Extract Page Content)
â”œâ”€ ğŸ“Š Page State Extraction (A11y Tree | Links | Buttons | Text)
â”œâ”€ ğŸ”„ Context Update (Add observations to memory)
â””â”€ ğŸ¯ Updated Context for next Reason cycle
                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ğŸ›‘ CHECK GOAL                           â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚  If NO â†’ Loop back to REASON (ReAct)   â”‚
        â”‚  If YES â†’ Continue to GOVERNANCE       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
ğŸ›¡ï¸  LAYER 4: GOVERNANCE (Safety & Control)
â”œâ”€ âš–ï¸ Guardrails (I/O Filter | Access Control | Budget)
â””â”€ ğŸ‘¤ HITL (Checkpoints | Review UI | Escalation)
                          â†“
ğŸ“¤ OUTPUT PROCESSING PIPELINE
â”œâ”€ ğŸ” Raw Result (All actions + observations)
â”œâ”€ ğŸ“ Formatting (Markdown | Tables | Code)
â”œâ”€ âœ¨ Enrichment (Citations | Sources | Metadata)
â”œâ”€ âœ… Validation (PII scan | Safety)
â””â”€ ğŸ“¦ Structured Output {result, actions, metadata}
                          â†“
                    ğŸ“¤ USER OUTPUT
```


***

## ğŸ”„ **Full ReAct Loop Flow (Example: Search Flights)**

```
User: "TÃ¬m vÃ© bay tá»« HÃ  Ná»™i Ä‘áº¿n TP.HCM ngÃ y 20/12"

â•â•â• ITERATION 1 â•â•â•
1ï¸âƒ£  REASON
    Context: "User wants flight search, current page = homepage"
    Decision: "Need to navigate to google.com/flights"
    
2ï¸âƒ£  ACT
    Execute: navigate("google.com/flights")
    Result: Page loaded
    
3ï¸âƒ£  OBSERVE
    Extract: "Flight search form visible with fields: From, To, Date"
    Update: Context = {url, visible_elements, form_fields}
    
4ï¸âƒ£  CHECK GOAL
    "Goal achieved?" â†’ NO (haven't filled form yet)
    "Loop counter = 1" â†’ Continue ReAct Loop

â•â•â• ITERATION 2 â•â•â•
1ï¸âƒ£  REASON
    Context: [form visible, user wants HAN â†’ SGN on 20/12]
    Decision: "Need to click 'From' field and input 'Hanoi'"
    
2ï¸âƒ£  ACT
    Execute: click("from_field") â†’ input_text("Hanoi")
    Result: Success
    
3ï¸âƒ£  OBSERVE
    Extract: "From field filled: 'Hanoi', now need To field"
    Update: Context = {filled_from: "HAN", ...}
    
4ï¸âƒ£  CHECK GOAL
    "Goal achieved?" â†’ NO (still need To, Date, Search)
    "Loop counter = 2" â†’ Continue ReAct Loop

â•â•â• ITERATION 3 â•â•â•
1ï¸âƒ£  REASON
    Context: [From=HAN, need To, Date]
    Decision: "Click 'To' field and input 'Ho Chi Minh'"
    
2ï¸âƒ£  ACT â†’ 3ï¸âƒ£  OBSERVE â†’ 4ï¸âƒ£  CHECK â†’ NO â†’ Loop

â•â•â• ITERATION 4 â•â•â•
1ï¸âƒ£  REASON
    Context: [From=HAN, To=SGN, need Date]
    Decision: "Click 'Date' field and input '20/12'"
    
2ï¸âƒ£  ACT â†’ 3ï¸âƒ£  OBSERVE â†’ 4ï¸âƒ£  CHECK â†’ NO â†’ Loop

â•â•â• ITERATION 5 â•â•â•
1ï¸âƒ£  REASON
    Context: [All fields filled: HAN, SGN, 20/12]
    Decision: "Click 'Search' button"
    
2ï¸âƒ£  ACT
    Execute: click("search_button")
    Result: Search results page loaded
    
3ï¸âƒ£  OBSERVE
    Extract: "5 flights found, prices 2M-5M, details visible"
    Update: Context = {flights: [...], ready_to_output}
    
4ï¸âƒ£  CHECK GOAL
    "Goal achieved?" â†’ YES âœ…
    "Exit ReAct Loop" â†’ Go to GOVERNANCE

â•â•â• GOVERNANCE â•â•â•
âœ… Pass all safety checks
âœ… No high-risk actions
âœ… Within budget

â•â•â• OUTPUT PROCESSING â•â•â•
Format result:
- Flight 1: VJ123, 09:00-11:30, 2.5M
- Flight 2: VN456, 14:00-16:30, 2.8M
- Flight 3: QH789, 16:00-18:30, 2.2M
- (+ 2 more flights)

ğŸ“¤ USER OUTPUT: Formatted JSON with flights, sources, execution trace
```


***

## âœ¨ **Why Pattern 1 (Full ReAct) is FINAL Choice:**

âœ… **Linh hoáº¡t cao** - Agent tháº¥y káº¿t quáº£ ngay, cÃ³ thá»ƒ Ä‘iá»u chá»‰nh chiáº¿n lÆ°á»£c
âœ… **ThÃ­ch á»©ng tá»‘t** - Náº¿u page khÃ´ng nhÆ° mong Ä‘á»£i, LLM cÃ³ thá»ƒ pivot ngay
âœ… **Lá»—i detected sá»›m** - PhÃ¡t hiá»‡n váº¥n Ä‘á» trong vÃ²ng láº·p, khÃ´ng phÃ­ cÃ´ng
âœ… **Cháº¥t lÆ°á»£ng cao** - PhÃ¹ há»£p cho tÃ¡c vá»¥ phá»©c táº¡p, mÆ¡ há»“, explore
âœ… **Error recovery** - Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh khi gáº·p lá»—i
âœ… **Production-ready** - ÄÃ£ Ä‘Æ°á»£c chá»©ng minh á»Ÿ nhiá»u agent systems (AutoGPT, Agent Framework, v.v.)

ğŸ¯ **ÄÃ¢y lÃ  FINAL Architecture cho Web Browser Agent theo MECE 4-Layer Framework!**



## PhÃ¢n tÃ­ch vÃ  ÄÃ¡nh giÃ¡ Kiáº¿n trÃºc finAI Agentic Browser

### **1. So sÃ¡nh Thiáº¿t káº¿ Hiá»‡n táº¡i cá»§a finAI vá»›i Framework 4 Quadrant**

Kiáº¿n trÃºc hiá»‡n táº¡i cá»§a finAI, vá»›i 6 stages tuáº§n tá»± (Input â†’ Query Understanding â†’ Router/Planner â†’ Executor â†’ Reasoning â†’ Synthesis), thuá»™c vá» **Quadrant 2: Orchestration**.

**LÃ½ do:**
- **Äiá»u phá»‘i táº­p trung:** CÃ³ má»™t luá»“ng chÃ­nh Ä‘iá»u phá»‘i cÃ´ng viá»‡c qua cÃ¡c stage.
- **ChuyÃªn mÃ´n hÃ³a:** Má»—i stage lÃ  má»™t module chuyÃªn biá»‡t (giá»‘ng nhÆ° má»™t agent chuyÃªn biá»‡t).
- **Agency tháº¥p:** CÃ¡c module chá»‰ thá»±c hiá»‡n tÃ¡c vá»¥ Ä‘Æ°á»£c giao, khÃ´ng tá»± ra quyáº¿t Ä‘á»‹nh.

**Äiá»ƒm máº¡nh cá»§a thiáº¿t káº¿ hiá»‡n táº¡i:**
- **Äá»™ tin cáº­y cao:** Luá»“ng xá»­ lÃ½ cÃ³ thá»ƒ dá»± Ä‘oÃ¡n Ä‘Æ°á»£c, dá»… debug.
- **Tá»‘i Æ°u hÃ³a latency:** Rule-first approach trong Module 2 giÃºp xá»­ lÃ½ nhanh cÃ¡c yÃªu cáº§u phá»• biáº¿n.
- **Dá»… quáº£n lÃ½:** TÃ¡ch biá»‡t concerns rÃµ rÃ ng, dá»… dÃ ng phÃ¡t triá»ƒn vÃ  báº£o trÃ¬ tá»«ng module.

**Äiá»ƒm yáº¿u cá»§a thiáº¿t káº¿ hiá»‡n táº¡i:**
- **Thiáº¿u linh hoáº¡t:** KhÃ³ xá»­ lÃ½ cÃ¡c yÃªu cáº§u phá»©c táº¡p, Ä‘a bÆ°á»›c, hoáº·c cáº§n feedback loop.
- **KhÃ³ má»Ÿ rá»™ng:** KhÃ´ng dá»… dÃ ng thÃªm cÃ¡c tools hoáº·c workflows má»›i mÃ  khÃ´ng thay Ä‘á»•i code cá»§a orchestrator.
- **KhÃ´ng cÃ³ "trÃ­ nhá»›":** KhÃ³ thá»±c hiá»‡n cÃ¡c cuá»™c há»™i thoáº¡i dÃ i, nhiá»u lÆ°á»£t.

### **2. ÄÃ¡nh giÃ¡ Kiáº¿n trÃºc tá»« gÃ³c Ä‘á»™ Master System Architect**

Vá»›i vai trÃ² lÃ  má»™t Master System Architect, tÃ´i Ä‘Ã¡nh giÃ¡ kiáº¿n trÃºc hiá»‡n táº¡i cá»§a finAI lÃ  má»™t **ná»n táº£ng vá»¯ng cháº¯c, nhÆ°ng chÆ°a pháº£i lÃ  má»™t há»‡ thá»‘ng agent thá»±c thá»¥**.

**Äiá»ƒm cá»™ng (+):**
- **Modular & Scalable:** Thiáº¿t káº¿ 6 stages lÃ  má»™t best practice, cho phÃ©p scale tá»«ng module Ä‘á»™c láº­p.
- **Focus vÃ o Safety & Reliability:** Rule Engine vÃ  Safety Checks lÃ  cá»±c ká»³ quan trá»ng cho domain tÃ i chÃ­nh.
- **Tá»‘i Æ°u hÃ³a Performance:** Nháº­n thá»©c Ä‘Æ°á»£c táº§m quan trá»ng cá»§a latency vÃ  cÃ³ giáº£i phÃ¡p (Rule-first).

**Äiá»ƒm trá»« (-):**
- **Thiáº¿u "Agency":** Há»‡ thá»‘ng váº«n Ä‘ang hoáº¡t Ä‘á»™ng nhÆ° má»™t pipeline xá»­ lÃ½ dá»¯ liá»‡u thÃ´ng minh, chÆ°a pháº£i lÃ  má»™t agent cÃ³ kháº£ nÄƒng tá»± chá»§.
- **Coupling cao:** CÃ¡c stages váº«n cÃ²n phá»¥ thuá»™c nhiá»u vÃ o nhau, khÃ³ tÃ¡i sá»­ dá»¥ng hoáº·c thay Ä‘á»•i thá»© tá»±.
- **KhÃ³ má»Ÿ rá»™ng Toolset:** Viá»‡c thÃªm tool má»›i Ä‘Ã²i há»i pháº£i thay Ä‘á»•i cáº£ Router, Planner, vÃ  Executor.

### **3. Recommendations Ä‘á»ƒ Chuyá»ƒn Ä‘á»•i sang Kiáº¿n trÃºc Agent thá»±c thá»¥ (Quadrant 3: Autonomy)**

Äá»ƒ Ä‘Æ°a finAI lÃªn má»™t táº§m cao má»›i, chÃºng ta cáº§n chuyá»ƒn Ä‘á»•i tá»« **Orchestration (Quadrant 2)** sang **Autonomy (Quadrant 3)**. ÄÃ¢y lÃ  cÃ¡c bÆ°á»›c cá»¥ thá»ƒ:

**Recommendation 1: Ãp dá»¥ng LangGraph lÃ m Orchestrator chÃ­nh**
- Thay tháº¿ pipeline 6 stages cá»©ng nháº¯c báº±ng má»™t **StateGraph** cá»§a LangGraph.
- Má»—i node trong graph sáº½ lÃ  má»™t module (hoáº·c má»™t tool).
- CÃ¡c cáº¡nh (edges) sáº½ lÃ  cÃ¡c quyáº¿t Ä‘á»‹nh (do LLM Ä‘Æ°a ra) Ä‘á»ƒ chuyá»ƒn tá»« node nÃ y sang node khÃ¡c.

**Recommendation 2: Biáº¿n cÃ¡c Modules thÃ nh Tools**
- **Module 2 (Query Understanding):** Váº«n giá»¯ láº¡i, nhÆ°ng Ä‘Ã³ng gÃ³i thÃ nh má»™t tool `understand_query`.
- **Module 3 (Router/Planner):** Bá» Ä‘i, vÃ¬ LangGraph sáº½ Ä‘áº£m nhiá»‡m vai trÃ² nÃ y.
- **Module 4 (Browser Executor):** Chia nhá» thÃ nh cÃ¡c tools cá»¥ thá»ƒ: `browse_url`, `click_element`, `input_text`, `scroll_page`, etc.
- **Module 5 (Reasoning):** TÃ­ch há»£p vÃ o agent state cá»§a LangGraph.
- **Module 6 (Synthesis):** Giá»¯ láº¡i nhÆ° má»™t tool `synthesize_answer`.

**Recommendation 3: Thiáº¿t káº¿ Agent State (StateGraph)**
- State cá»§a LangGraph sáº½ chá»©a toÃ n bá»™ context cá»§a cuá»™c há»™i thoáº¡i:
  - `user_query`: YÃªu cáº§u ban Ä‘áº§u
  - `task_spec`: Output tá»« Module 2
  - `browser_snapshots`: Lá»‹ch sá»­ cÃ¡c trang Ä‘Ã£ xem (A11y Tree)
  - `scratchpad`: Suy nghÄ© vÃ  quyáº¿t Ä‘á»‹nh cá»§a agent
  - `final_answer`: CÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng

**Recommendation 4: XÃ¢y dá»±ng má»™t "Master Agent"**
- Master Agent nÃ y sáº½ lÃ  má»™t LangGraph StateGraph.
- NÃ³ sáº½ cÃ³ má»™t bá»™ tools bao gá»“m cÃ¡c modules Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng gÃ³i láº¡i.
- Luá»“ng hoáº¡t Ä‘á»™ng sáº½ lÃ  má»™t vÃ²ng láº·p ReAct (Reason-Act-Observe) Ä‘Æ°á»£c quáº£n lÃ½ bá»Ÿi LangGraph.

### **4. Kiáº¿n trÃºc Äá» xuáº¥t (Proposed Architecture)**

```mermaid
flowchart TD
    User --> API_Gateway[API Gateway]
    API_Gateway --> LangGraph_Agent["LangGraph Agent (Master Agent)"]

    subgraph LangGraph_Agent
        direction LR
        State[Agent State]
        State --> Router{Router Node}
        Router --> Tool_Executor[Tool Executor Node]
        Tool_Executor --> State
    end

    subgraph Tool_Registry
        direction TB
        Tool1[understand_query]
        Tool2[browse_url]
        Tool3[click_element]
        Tool4[input_text]
        Tool5[synthesize_answer]
    end

    Tool_Executor --> Tool_Registry

    LangGraph_Agent --> Final_Response[Final Response]
    Final_Response --> User

```

### **5. Lá»£i Ã­ch cá»§a Kiáº¿n trÃºc Má»›i**

- **Linh hoáº¡t & Má»Ÿ rá»™ng:** Dá»… dÃ ng thÃªm tools má»›i mÃ  khÃ´ng cáº§n thay Ä‘á»•i kiáº¿n trÃºc.
- **TÄƒng "Agency":** Agent cÃ³ thá»ƒ tá»± quyáº¿t Ä‘á»‹nh luá»“ng xá»­ lÃ½, thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ phá»©c táº¡p, Ä‘a bÆ°á»›c.
- **CÃ³ "TrÃ­ nhá»›":** Agent State cho phÃ©p agent nhá»› láº¡i cÃ¡c bÆ°á»›c Ä‘Ã£ lÃ m vÃ  há»c há»i tá»« Ä‘Ã³.
- **Dá»… Debug & Observe:** LangFuse cÃ³ thá»ƒ tÃ­ch há»£p vá»›i LangGraph Ä‘á»ƒ visualize tá»«ng bÆ°á»›c cháº¡y cá»§a agent.
- **TÃ¡i sá»­ dá»¥ng Code:** CÃ¡c modules hiá»‡n táº¡i cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng nhÆ° cÃ¡c tools.

Báº±ng cÃ¡ch thá»±c hiá»‡n cÃ¡c thay Ä‘á»•i nÃ y, finAI sáº½ chuyá»ƒn mÃ¬nh tá»« má»™t há»‡ thá»‘ng xá»­ lÃ½ dá»¯ liá»‡u thÃ´ng minh thÃ nh má»™t **Web Browser AI Agent thá»±c thá»¥**, sáºµn sÃ ng cáº¡nh tranh vá»›i cÃ¡c sáº£n pháº©m hÃ ng Ä‘áº§u trÃªn tháº¿ giá»›i.

---
# TÃ€I LIá»†U THIáº¾T Káº¾ Cáº¤P CAO (HIGH-LEVEL DESIGN) CHO FINAI WEB BROWSER AI AGENT

## Má»¤C Lá»¤C

1.  **TÃ³m táº¯t Äiá»u hÃ nh (Executive Summary)**
    1.1. Bá»‘i cáº£nh vÃ  Má»¥c tiÃªu Thiáº¿t káº¿
    1.2. CÃ¡c Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc Cá»‘t lÃµi
2.  **Kiáº¿n trÃºc Cáº¥p Cao (High-Level Architecture - HLA)**
    2.1. SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (HLA Diagram)
    2.2. PhÃ¢n tÃ­ch CÃ¡c Lá»›p Kiáº¿n trÃºc (Architectural Layers)
    2.3. NgÄƒn xáº¿p CÃ´ng nghá»‡ (Technology Stack)
3.  **Thiáº¿t káº¿ Cáº¥p Cao (High-Level Design - HLD)**
    3.1. Luá»“ng Dá»¯ liá»‡u Tá»•ng thá»ƒ (End-to-End Data Flow)
    3.2. Thiáº¿t káº¿ Agent Core (LangGraph State Machine)
        3.2.1. Äá»‹nh nghÄ©a Tráº¡ng thÃ¡i (AgentState)
        3.2.2. PhÃ¢n tÃ­ch CÃ¡c Node vÃ  Chuyá»ƒn Ä‘á»•i Tráº¡ng thÃ¡i
    3.3. Thiáº¿t káº¿ Lá»›p Kiá»ƒm soÃ¡t TrÃ¬nh duyá»‡t (Browser Control Layer)
        3.3.1. Chiáº¿n lÆ°á»£c TÆ°Æ¡ng tÃ¡c Hybrid (A11y Tree + Vision)
        3.3.2. CÆ¡ cháº¿ Tá»± phá»¥c há»“i (Self-Healing)
    3.4. Thiáº¿t káº¿ An toÃ n vÃ  Báº£o máº­t (Safety & Security Design)
4.  **Cáº¥u trÃºc ThÆ° má»¥c Sáº£n xuáº¥t (Production Folder Structure)**
    4.1. SÆ¡ Ä‘á»“ Cáº¥u trÃºc ThÆ° má»¥c Tá»•ng thá»ƒ
    4.2. PhÃ¢n tÃ­ch Chi tiáº¿t CÃ¡c Module Cá»‘t lÃµi
        4.2.1. Module `agent/` (Agent Core)
        4.2.2. Module `browser/` (Browser Control)
        4.2.3. Module `backend/` (API Gateway)
5.  **Káº¿t luáº­n vÃ  Khuyáº¿n nghá»‹ Triá»ƒn khai**

---

## 1. TÃ³m táº¯t Äiá»u hÃ nh (Executive Summary)

### 1.1. Bá»‘i cáº£nh vÃ  Má»¥c tiÃªu Thiáº¿t káº¿

TÃ i liá»‡u nÃ y trÃ¬nh bÃ y **Kiáº¿n trÃºc Cáº¥p Cao (HLA)** vÃ  **Thiáº¿t káº¿ Cáº¥p Cao (HLD)** cho dá»± Ã¡n **finAI Web Browser AI Agent**. Má»¥c tiÃªu lÃ  chuyá»ƒn Ä‘á»•i pipeline 6 stages hiá»‡n táº¡i thÃ nh má»™t há»‡ thá»‘ng **Agentic** linh hoáº¡t, bá»n bá»‰ vÃ  cÃ³ kháº£ nÄƒng tá»± phá»¥c há»“i (Self-Healing), Ä‘áº¡t chuáº©n **Production Quality** vÃ  cÃ³ kháº£ nÄƒng má»Ÿ rá»™ng (Scalability) cao.

Thiáº¿t káº¿ nÃ y Ä‘Æ°á»£c xÃ¢y dá»±ng dá»±a trÃªn phÃ¢n tÃ­ch chuyÃªn sÃ¢u cÃ¡c Ä‘á»‘i thá»§ cáº¡nh tranh hÃ ng Ä‘áº§u (Perplexity Comet, OpenAI Operator, Adept ACT-1), táº­p trung vÃ o viá»‡c tÃ­ch há»£p cÃ¡c **Best Practices** vá» kiáº¿n trÃºc Agent (LangGraph) vÃ  tÆ°Æ¡ng tÃ¡c web (Hybrid A11y + Vision).

### 1.2. CÃ¡c Quyáº¿t Ä‘á»‹nh Kiáº¿n trÃºc Cá»‘t lÃµi

| Quyáº¿t Ä‘á»‹nh | MÃ´ táº£ Chi tiáº¿t | LÃ½ do Ká»¹ thuáº­t |
| :--- | :--- | :--- |
| **Kiáº¿n trÃºc Agent** | Sá»­ dá»¥ng **LangGraph** Ä‘á»ƒ xÃ¢y dá»±ng Agent Core dÆ°á»›i dáº¡ng **State Machine** (Äá»“ thá»‹ Tráº¡ng thÃ¡i). | Cho phÃ©p **Re-planning** (tÃ¡i láº­p káº¿ hoáº¡ch) vÃ  **Self-Correction** (tá»± sá»­a lá»—i) khi gáº·p tháº¥t báº¡i, thay tháº¿ pipeline tuyáº¿n tÃ­nh dá»… há»ng. |
| **TÆ°Æ¡ng tÃ¡c Web** | **Hybrid A11y Tree + Vision Fallback** (3 lá»›p). | CÃ¢n báº±ng giá»¯a **Tá»‘c Ä‘á»™** (A11y Tree) vÃ  **Äá»™ bá»n bá»‰** (Vision), giáº£i quyáº¿t váº¥n Ä‘á» **Locator Brittleness** cá»§a cÃ¡c há»‡ thá»‘ng DOM-centric. |
| **Backend** | **FastAPI** lÃ m API Gateway vÃ  **WebSocket** cho giao tiáº¿p thá»i gian thá»±c. | FastAPI cung cáº¥p hiá»‡u suáº¥t cao (Async/Await) cho cÃ¡c tÃ¡c vá»¥ I/O náº·ng (LLM calls, Web interaction). WebSocket Ä‘áº£m báº£o **Visual Feedback** tá»©c thÃ¬ cho ngÆ°á»i dÃ¹ng. |
| **CÆ¡ cháº¿ An toÃ n** | **Rule-based Guardrails** tÃ­ch há»£p vÃ o cÃ¡c Node cá»§a LangGraph (trÆ°á»›c khi thá»±c thi hÃ nh Ä‘á»™ng). | Äáº£m báº£o **Safety-First** cho cÃ¡c tÃ¡c vá»¥ tÃ i chÃ­nh nháº¡y cáº£m, ngÄƒn cháº·n hÃ nh Ä‘á»™ng cÃ³ háº¡i trÆ°á»›c khi chÃºng xáº£y ra. |

---

## 2. Kiáº¿n trÃºc Cáº¥p Cao (High-Level Architecture - HLA)

### 2.1. SÆ¡ Ä‘á»“ Kiáº¿n trÃºc Tá»•ng thá»ƒ (HLA Diagram)

Kiáº¿n trÃºc finAI Ä‘Æ°á»£c chia thÃ nh 7 lá»›p chÃ­nh, hoáº¡t Ä‘á»™ng theo mÃ´ hÃ¬nh **Microservices** vÃ  **Agentic Loop**.

```mermaid
graph TD
    User["ğŸ‘¤ Financial Analyst<br/>(User)"]
    UI["ğŸ–¥ï¸ Web UI Dashboard<br/>(React/TypeScript)"]
    Socket["âš¡ WebSocket Client<br/>(Real-time Feedback)"]
    API["ğŸš€ API Gateway<br/>(FastAPI)"]
    Auth["ğŸ›¡ï¸ Auth & Rate Limit"]
    
    State["ğŸ§  Shared State<br/>(Messages, Plan, Context)"]
    M1["Module 1:<br/>Input & Ingestion<br/>(Validation/Safety)"]
    M2["Module 2:<br/>Query Understanding<br/>(Intent/Context)"]
    M3["Module 3:<br/>Router & Planner<br/>(Task Decomposition)"]
    M4["Module 4:<br/>Browser Agent<br/>(Action Execution)"]
    M5["Module 5:<br/>Reasoning<br/>(Evidence Analysis)"]
    M6["Module 6:<br/>Synthesis<br/>(Final Answer)"]
    
    PW["âš™ï¸ Playwright Controller"]
    TreeParser["ğŸŒ³ DOM / A11y Tree Parser<br/>(Primary: 90%)"]
    Vision["ğŸ‘ï¸ Vision Engine<br/>(Fallback: 10%)"]
    Chrome["ğŸŒ Headless Chromium"]
    
    LLM["ğŸ¤– LLM Service<br/>(GPT-4 / Claude)"]
    DB["ğŸ—„ï¸ PostgreSQL<br/>(User Data)"]
    Redis["âš¡ Redis<br/>(Cache/Queue)"]
    
    %% Client Flow
    User -->|interact| UI
    UI <-->|WebSocket| Socket
    UI -->|REST/JSON| API
    Socket <-->|Real-time| API
    API -->|Auth check| Auth
    API -->|invoke| M1
    
    %% Agent Flow
    M1 -->|process| M2
    M2 -->|analyze| M3
    M3 -->|plan| M4
    M4 -->|retry/loop| M4
    M4 -->|collected| M5
    M5 -->|evidence| M6
    M6 -->|response| API
    
    %% State connections
    State -.->|read/write| M1
    State -.->|read/write| M2
    State -.->|read/write| M3
    State -.->|read/write| M4
    State -.->|read/write| M5
    State -.->|read/write| M6
    
    %% Browser interaction
    M4 -->|commands| PW
    PW -->|control| Chrome
    Chrome -->|HTML| TreeParser
    Chrome -->|screenshot| Vision
    TreeParser -->|structured data| M4
    Vision -->|coordinates| M4
    
    %% Human approval loop
    M3 -.->|âš ï¸ Plan Review| UI
    M4 -.->|âš ï¸ Approval Req| UI
    
    %% External services
    M1 -.->|LLM call| LLM
    M2 -.->|LLM call| LLM
    M3 -.->|LLM call| LLM
    M4 -.->|LLM call| LLM
    M5 -.->|LLM call| LLM
    M6 -.->|LLM call| LLM
    
    %% Data persistence
    State -->|persist| DB
    State -->|cache| Redis
    
    %% Styling
    classDef actor fill:#ffdfba,stroke:#333,stroke-width:2px
    classDef frontend fill:#baffc9,stroke:#333,stroke-width:2px
    classDef backend fill:#bae1ff,stroke:#333,stroke-width:2px
    classDef agent fill:#ffffba,stroke:#d4a017,stroke-width:2px
    classDef module fill:#ffffff,stroke:#333,stroke-width:2px
    classDef browser fill:#eecbff,stroke:#333,stroke-width:2px
    classDef external fill:#e2e2e2,stroke:#333,stroke-width:2px
    classDef db fill:#ffb3ba,stroke:#333,stroke-width:2px
    
    class User actor
    class UI,Socket frontend
    class API,Auth backend
    class State,M1,M2,M3,M4,M5,M6 agent
    class PW,TreeParser,Vision,Chrome browser
    class LLM external
    class DB,Redis db
    
    style User fill:#ffdfba,stroke:#333,stroke-width:2px
    style UI fill:#baffc9,stroke:#333,stroke-width:2px
    style Socket fill:#baffc9,stroke:#333,stroke-width:2px
    style API fill:#bae1ff,stroke:#333,stroke-width:2px
    style Auth fill:#bae1ff,stroke:#333,stroke-width:2px
    style State fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M1 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M2 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M3 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M4 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M5 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style M6 fill:#ffffba,stroke:#d4a017,stroke-width:2px
    style PW fill:#eecbff,stroke:#333,stroke-width:2px
    style TreeParser fill:#eecbff,stroke:#333,stroke-width:2px
    style Vision fill:#eecbff,stroke:#333,stroke-width:2px
    style Chrome fill:#eecbff,stroke:#333,stroke-width:2px
    style LLM fill:#e2e2e2,stroke:#333,stroke-width:2px
    style DB fill:#ffb3ba,stroke:#333,stroke-width:2px
    style Redis fill:#ffb3ba,stroke:#333,stroke-width:2px
```

### 2.2. PhÃ¢n tÃ­ch CÃ¡c Lá»›p Kiáº¿n trÃºc (Architectural Layers)

Kiáº¿n trÃºc Ä‘Æ°á»£c phÃ¢n chia thÃ nh 5 lá»›p logic chÃ­nh:

#### **Lá»›p 1: Lá»›p TrÃ¬nh bÃ y (Presentation Layer)**

*   **ThÃ nh pháº§n:** Web UI Dashboard (React/TypeScript), WebSocket Client.
*   **Chá»©c nÄƒng:** Cung cáº¥p giao diá»‡n **Intention-First** cho ngÆ°á»i dÃ¹ng. Xá»­ lÃ½ Ä‘áº§u vÃ o, hiá»ƒn thá»‹ káº¿t quáº£ cuá»‘i cÃ¹ng vÃ  quan trá»ng nháº¥t lÃ  cung cáº¥p **Visual Feedback** thá»i gian thá»±c (Agent Status Panel) thÃ´ng qua WebSocket.

#### **Lá»›p 2: Lá»›p Dá»‹ch vá»¥ (Service Layer)**

*   **ThÃ nh pháº§n:** API Gateway (FastAPI), Auth & Rate Limit.
*   **Chá»©c nÄƒng:** Äiá»ƒm truy cáº­p duy nháº¥t (Single Entry Point) cho há»‡ thá»‘ng. Xá»­ lÃ½ xÃ¡c thá»±c, giá»›i háº¡n tá»‘c Ä‘á»™ vÃ  chuyá»ƒn tiáº¿p yÃªu cáº§u Ä‘áº¿n Agent Core. FastAPI Ä‘Æ°á»£c chá»n vÃ¬ hiá»‡u suáº¥t cao vÃ  há»— trá»£ Async/Await, ráº¥t quan trá»ng cho cÃ¡c tÃ¡c vá»¥ Agentic I/O-bound.

#### **Lá»›p 3: Lá»›p Äiá»u phá»‘i Agent (Agent Orchestration Layer)**

*   **ThÃ nh pháº§n:** Shared State, Modules M1-M6 (Ä‘Æ°á»£c triá»ƒn khai dÆ°á»›i dáº¡ng **LangGraph Nodes**).
*   **Chá»©c nÄƒng:** ÄÃ¢y lÃ  trÃ¡i tim cá»§a há»‡ thá»‘ng, nÆ¡i LangGraph quáº£n lÃ½ vÃ²ng láº·p **Perception-Reasoning-Action**. Shared State (Ä‘Æ°á»£c lÆ°u trá»¯ trong Redis/PostgreSQL) Ä‘áº£m báº£o Agent cÃ³ thá»ƒ duy trÃ¬ ngá»¯ cáº£nh vÃ  tráº¡ng thÃ¡i qua cÃ¡c bÆ°á»›c.

#### **Lá»›p 4: Lá»›p Kiá»ƒm soÃ¡t TrÃ¬nh duyá»‡t (Browser Control Layer)**

*   **ThÃ nh pháº§n:** Playwright Controller, DOM/A11y Tree Parser, Vision Engine, Headless Chromium.
*   **Chá»©c nÄƒng:** Lá»›p nÃ y chá»‹u trÃ¡ch nhiá»‡m vá» **Perception** (thu tháº­p tráº¡ng thÃ¡i trang) vÃ  **Action** (thá»±c thi thao tÃ¡c).
    *   **A11y Tree Parser:** Cung cáº¥p dá»¯ liá»‡u ngá»¯ nghÄ©a, lÃ  nguá»“n thÃ´ng tin chÃ­nh (90%).
    *   **Vision Engine:** Cung cáº¥p tá»a Ä‘á»™ (X, Y) vÃ  ngá»¯ cáº£nh trá»±c quan, lÃ  cÆ¡ cháº¿ Fallback (10%) vÃ  Verification.

#### **Lá»›p 5: Lá»›p Dá»¯ liá»‡u vÃ  Dá»‹ch vá»¥ NgoÃ i (Data & External Services Layer)**

*   **ThÃ nh pháº§n:** PostgreSQL (Dá»¯ liá»‡u ngÆ°á»i dÃ¹ng, Lá»‹ch sá»­ tÃ¡c vá»¥), Redis (Cache, HÃ ng Ä‘á»£i tÃ¡c vá»¥), LLM Service (GPT-4/Claude).
*   **Chá»©c nÄƒng:** Cung cáº¥p kháº£ nÄƒng lÆ°u trá»¯ bá»n vá»¯ng (PostgreSQL) vÃ  bá»™ nhá»› Ä‘á»‡m/quáº£n lÃ½ tráº¡ng thÃ¡i nhanh (Redis). LLM Service lÃ  thÃ nh pháº§n Reasoning chÃ­nh, Ä‘Æ°á»£c gá»i bá»Ÿi cÃ¡c Module M1, M2, M3, M5, M6.

### 2.3. NgÄƒn xáº¿p CÃ´ng nghá»‡ (Technology Stack)

| Lá»›p Kiáº¿n trÃºc | CÃ´ng nghá»‡ Cá»‘t lÃµi | LÃ½ do Lá»±a chá»n |
| :--- | :--- | :--- |
| **Frontend** | React, TypeScript, WebSocket | TypeScript Ä‘áº£m báº£o cháº¥t lÆ°á»£ng code. WebSocket cho phÃ©p giao tiáº¿p **Real-time Visual Feedback** (Agent Status Panel). |
| **Backend/API** | Python, FastAPI, Uvicorn | Hiá»‡u suáº¥t cao, há»— trá»£ Async/Await, cá»™ng Ä‘á»“ng lá»›n trong lÄ©nh vá»±c AI/ML. |
| **Agent Core** | LangGraph, Python | Cung cáº¥p framework State Machine máº¡nh máº½ cho **Re-planning** vÃ  **Self-Correction**. |
| **Browser Control** | Playwright, Python | Hiá»‡n Ä‘áº¡i, nhanh, Ä‘Ã¡ng tin cáº­y hÆ¡n Selenium, há»— trá»£ tá»‘t cho viá»‡c trÃ­ch xuáº¥t A11y Tree. |
| **LLM** | OpenAI API, Anthropic API | Kháº£ nÄƒng suy luáº­n (Reasoning) vÃ  Ä‘a phÆ°Æ¡ng thá»©c (Vision) hÃ ng Ä‘áº§u. |
| **Data Persistence** | PostgreSQL | Äá»™ tin cáº­y, ACID Compliance, phÃ¹ há»£p cho dá»¯ liá»‡u giao dá»‹ch vÃ  lá»‹ch sá»­ tÃ¡c vá»¥. |
| **Caching/State** | Redis | Tá»‘c Ä‘á»™ cao, phÃ¹ há»£p cho Shared State (LangGraph State) vÃ  hÃ ng Ä‘á»£i tÃ¡c vá»¥. |

---

## 3. Thiáº¿t káº¿ Cáº¥p Cao (High-Level Design - HLD)

### 3.1. Luá»“ng Dá»¯ liá»‡u Tá»•ng thá»ƒ (End-to-End Data Flow)

Luá»“ng dá»¯ liá»‡u Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ tá»‘i Æ°u hÃ³a tá»‘c Ä‘á»™ vÃ  Ä‘á»™ bá»n bá»‰, vá»›i LangGraph lÃ  trung tÃ¢m Ä‘iá»u phá»‘i.

1.  **Khá»Ÿi táº¡o (Initiation):** User nháº­p lá»‡nh (Prompt) vÃ o Web UI. UI gá»­i yÃªu cáº§u qua REST API Ä‘áº¿n FastAPI Gateway.
2.  **Tiá»n xá»­ lÃ½ (Pre-processing):** FastAPI chuyá»ƒn yÃªu cáº§u Ä‘áº¿n **Module 1 (Input & Ingestion)**. Module nÃ y thá»±c hiá»‡n **Guardrails** ban Ä‘áº§u (kiá»ƒm tra Prompt Injection, PII) vÃ  khá»Ÿi táº¡o `AgentState` trong Redis/PostgreSQL.
3.  **Láº­p káº¿ hoáº¡ch (Planning):** **Module 3 (Router & Planner)** (LangGraph Node) nháº­n `AgentState`. NÃ³ quyáº¿t Ä‘á»‹nh luá»“ng:
    *   **Fast Path (Rule-based):** Náº¿u tÃ¡c vá»¥ Ä‘Æ¡n giáº£n, chuyá»ƒn tháº³ng Ä‘áº¿n **Module 6 (Synthesis)**.
    *   **Agent Path (LLM-based):** Náº¿u phá»©c táº¡p, LLM táº¡o ra `action_plan` (chuá»—i cÃ¡c bÆ°á»›c hÃ nh Ä‘á»™ng).
4.  **Thá»±c thi (Execution):** **Module 4 (Browser Agent)** (LangGraph Node) nháº­n bÆ°á»›c hÃ nh Ä‘á»™ng tiáº¿p theo. NÃ³ gá»i **Playwright Controller** Ä‘á»ƒ thá»±c thi hÃ nh Ä‘á»™ng trÃªn Headless Chromium.
5.  **Pháº£n há»“i (Perception):** Sau hÃ nh Ä‘á»™ng, **Browser Control Layer** gá»­i láº¡i tráº¡ng thÃ¡i má»›i (A11y Tree, Screenshot) cho Module 4.
6.  **XÃ¡c minh & Láº·p láº¡i (Verification & Loop):** Module 4 (hoáº·c Node Verifier) kiá»ƒm tra káº¿t quáº£.
    *   **ThÃ nh cÃ´ng:** Láº·p láº¡i bÆ°á»›c 4 vá»›i bÆ°á»›c hÃ nh Ä‘á»™ng tiáº¿p theo.
    *   **Tháº¥t báº¡i:** KÃ­ch hoáº¡t Node **Replan** (trong LangGraph) Ä‘á»ƒ LLM phÃ¢n tÃ­ch lá»—i vÃ  táº¡o káº¿ hoáº¡ch má»›i.
7.  **Tá»•ng há»£p (Synthesis):** Sau khi thu tháº­p Ä‘á»§ báº±ng chá»©ng (Evidence), **Module 6 (Synthesis)** (LangGraph Node) sá»­ dá»¥ng LLM Ä‘á»ƒ phÃ¢n tÃ­ch `evidence_pack` vÃ  táº¡o cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng.
8.  **Pháº£n há»“i NgÆ°á»i dÃ¹ng (User Feedback):** CÃ¢u tráº£ lá»i Ä‘Æ°á»£c gá»­i qua REST API, trong khi cÃ¡c cáº­p nháº­t tráº¡ng thÃ¡i (Action Log, Error) Ä‘Æ°á»£c gá»­i liÃªn tá»¥c qua **WebSocket** Ä‘á»ƒ cáº­p nháº­t Agent Status Panel.

### 3.2. Thiáº¿t káº¿ Agent Core (LangGraph State Machine)

LangGraph Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ mÃ´ hÃ¬nh hÃ³a Agent Core thÃ nh má»™t Äá»“ thá»‹ Tráº¡ng thÃ¡i (State Graph) cÃ³ kháº£ nÄƒng tá»± phá»¥c há»“i, láº¥y cáº£m há»©ng tá»« mÃ´ hÃ¬nh **Perception-Reasoning-Action-Verification-Replan**.

#### **3.2.1. Äá»‹nh nghÄ©a Tráº¡ng thÃ¡i (AgentState)**

Tráº¡ng thÃ¡i lÃ  Ä‘á»‘i tÆ°á»£ng trung tÃ¢m, Ä‘áº£m báº£o tÃ­nh nháº¥t quÃ¡n vÃ  kháº£ nÄƒng phá»¥c há»“i cá»§a Agent.

| TrÆ°á»ng (Field) | Kiá»ƒu Dá»¯ liá»‡u | Má»¥c Ä‘Ã­ch |
| :--- | :--- | :--- |
| `task_id` | `str` | ID duy nháº¥t, dÃ¹ng cho Logging vÃ  truy váº¥n. |
| `user_prompt` | `str` | YÃªu cáº§u gá»‘c cá»§a ngÆ°á»i dÃ¹ng. |
| `action_plan` | `List[ActionStep]` | HÃ ng Ä‘á»£i cÃ¡c bÆ°á»›c hÃ nh Ä‘á»™ng (tá»« Planner). |
| `evidence_pack` | `List[Evidence]` | Dá»¯ liá»‡u thÃ´ Ä‘Ã£ thu tháº­p (DOM, Báº£ng, VÄƒn báº£n). |
| `browser_state` | `BrowserState` | URL, A11y Tree, Screenshot hiá»‡n táº¡i. |
| `error_count` | `int` | Sá»‘ láº§n lá»—i liÃªn tiáº¿p (dÃ¹ng cho Guardrail). |
| `is_critical_action` | `bool` | Cá» bÃ¡o hiá»‡u cáº§n xÃ¡c nháº­n cá»§a ngÆ°á»i dÃ¹ng. |

#### **3.2.2. PhÃ¢n tÃ­ch CÃ¡c Node vÃ  Chuyá»ƒn Ä‘á»•i Tráº¡ng thÃ¡i**

| Node (Module) | Chá»©c nÄƒng ChÃ­nh | Chuyá»ƒn Ä‘á»•i (Transition) | LÃ½ do Ká»¹ thuáº­t |
| :--- | :--- | :--- | :--- |
| **Router** (M3) | PhÃ¢n loáº¡i tÃ¡c vá»¥ (Fast/Agent Path). | `FastPath` â†’ Synthesis; `AgentPath` â†’ Planner. | Tá»‘i Æ°u hÃ³a Ä‘á»™ trá»… (Latency) báº±ng cÃ¡ch bá» qua LLM cho cÃ¡c tÃ¡c vá»¥ Ä‘Æ¡n giáº£n. |
| **Planner** (M3) | Láº­p káº¿ hoáº¡ch Ä‘a bÆ°á»›c (CoT) vÃ  chá»n Tool. | `Continue` â†’ Executor; `Halt` â†’ Synthesis. | Äáº£m báº£o má»i hÃ nh Ä‘á»™ng Ä‘á»u cÃ³ lÃ½ do vÃ  Ä‘Æ°á»£c ghi láº¡i (CoT). |
| **Executor** (M4) | Thá»±c thi hÃ nh Ä‘á»™ng Web/Tool. | `Success` â†’ Verifier; `Failure` â†’ Replan. | TÃ¡ch biá»‡t logic thá»±c thi khá»i logic suy luáº­n. |
| **Verifier** (NEW) | Kiá»ƒm tra káº¿t quáº£ hÃ nh Ä‘á»™ng vÃ  tÃ­nh toÃ n váº¹n dá»¯ liá»‡u. | `Verified` â†’ CheckPlan; `Failed` â†’ Replan. | **Critical for finAI:** Äáº£m báº£o dá»¯ liá»‡u tÃ i chÃ­nh trÃ­ch xuáº¥t lÃ  chÃ­nh xÃ¡c (Data Integrity Check). |
| **Replan** (NEW) | PhÃ¢n tÃ­ch lá»—i vÃ  táº¡o káº¿ hoáº¡ch kháº¯c phá»¥c. | `Retry` â†’ Planner; `Halt` â†’ Synthesis (Error). | Cung cáº¥p kháº£ nÄƒng **Self-Correction** (láº¥y cáº£m há»©ng tá»« OpenAI Operator). |
| **Synthesis** (M6) | Tá»•ng há»£p cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng. | `End`. | Äáº£m báº£o cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng lÃ  cÃ³ cáº¥u trÃºc vÃ  dá»±a trÃªn báº±ng chá»©ng. |

### 3.3. Thiáº¿t káº¿ Lá»›p Kiá»ƒm soÃ¡t TrÃ¬nh duyá»‡t (Browser Control Layer)

Lá»›p nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ giáº£i quyáº¿t váº¥n Ä‘á» **Locator Brittleness** vÃ  Ä‘áº£m báº£o Agent cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i má»i trang web tÃ i chÃ­nh.

#### **3.3.1. Chiáº¿n lÆ°á»£c TÆ°Æ¡ng tÃ¡c Hybrid (A11y Tree + Vision)**

finAI Ã¡p dá»¥ng mÃ´ hÃ¬nh 3 lá»›p:

1.  **Lá»›p Ngá»¯ nghÄ©a (Semantic Layer - A11y Tree):**
    *   **Má»¥c tiÃªu:** Tá»‘c Ä‘á»™ vÃ  ngá»¯ nghÄ©a.
    *   **Thá»±c thi:** Playwright trÃ­ch xuáº¥t **Accessibility Tree** (A11y Tree) thay vÃ¬ DOM thÃ´. A11y Tree cung cáº¥p cÃ¡c thuá»™c tÃ­nh ngá»¯ nghÄ©a (vÃ­ dá»¥: `role="button"`, `aria-label`) mÃ  LLM cÃ³ thá»ƒ sá»­ dá»¥ng Ä‘á»ƒ láº­p káº¿ hoáº¡ch bá»n bá»‰ hÆ¡n.
2.  **Lá»›p HÃ nh Ä‘á»™ng (Action Layer - Playwright/CDP):**
    *   **Má»¥c tiÃªu:** Thá»±c thi hÃ nh Ä‘á»™ng.
    *   **Thá»±c thi:** Sá»­ dá»¥ng Playwright Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng dá»±a trÃªn cÃ¡c thuá»™c tÃ­nh ngá»¯ nghÄ©a tá»« A11y Tree.
3.  **Lá»›p Dá»± phÃ²ng (Fallback Layer - Vision Engine):**
    *   **Má»¥c tiÃªu:** Äá»™ bá»n bá»‰.
    *   **Thá»±c thi:** Khi A11y Tree tháº¥t báº¡i (vÃ­ dá»¥: khÃ´ng tÃ¬m tháº¥y pháº§n tá»­), Vision Engine (LLM Ä‘a phÆ°Æ¡ng thá»©c) Ä‘Æ°á»£c kÃ­ch hoáº¡t Ä‘á»ƒ phÃ¢n tÃ­ch Screenshot vÃ  cung cáº¥p tá»a Ä‘á»™ (X, Y) cho hÃ nh Ä‘á»™ng chuá»™t/bÃ n phÃ­m áº£o.

#### **3.3.2. CÆ¡ cháº¿ Tá»± phá»¥c há»“i (Self-Healing)**

CÆ¡ cháº¿ nÃ y Ä‘Æ°á»£c tÃ­ch há»£p vÃ o Node **Replan** vÃ  **Browser Control Layer**:

*   **Locator Healer:** Khi má»™t Locator tháº¥t báº¡i, LLM (hoáº·c má»™t SLM chuyÃªn biá»‡t) sáº½ phÃ¢n tÃ­ch Screenshot vÃ  A11y Tree Ä‘á»ƒ Ä‘á» xuáº¥t má»™t Locator thay tháº¿ (vÃ­ dá»¥: sá»­ dá»¥ng vÄƒn báº£n gáº§n Ä‘Ã³ hoáº·c vá»‹ trÃ­ tÆ°Æ¡ng Ä‘á»‘i).
*   **State Reset:** Náº¿u lá»—i khÃ´ng thá»ƒ kháº¯c phá»¥c, Agent sáº½ tá»± Ä‘á»™ng quay láº¡i tráº¡ng thÃ¡i trÆ°á»›c Ä‘Ã³ (vÃ­ dá»¥: trang trÆ°á»›c) vÃ  thá»­ láº¡i káº¿ hoáº¡ch tá»« Ä‘áº§u.

### 3.4. Thiáº¿t káº¿ An toÃ n vÃ  Báº£o máº­t (Safety & Security Design)

An toÃ n lÃ  Æ°u tiÃªn hÃ ng Ä‘áº§u cho Agent tÃ i chÃ­nh.

| CÆ¡ cháº¿ An toÃ n | Vá»‹ trÃ­ Triá»ƒn khai | MÃ´ táº£ |
| :--- | :--- | :--- |
| **Input Guardrails** | Module 1 (Input & Ingestion) | Kiá»ƒm tra Prompt Injection, PII (thÃ´ng tin cÃ¡ nhÃ¢n) vÃ  cÃ¡c yÃªu cáº§u Ä‘á»™c háº¡i. |
| **Action Guardrails** | Node Executor (trÆ°á»›c khi gá»i Playwright) | Kiá»ƒm tra URL (Whitelist/Blacklist), kiá»ƒm tra ná»™i dung trang (phÃ¡t hiá»‡n trang lá»«a Ä‘áº£o). |
| **Critical Action Confirmation** | Node Planner/Executor | KÃ­ch hoáº¡t cá» `is_critical_action` vÃ  yÃªu cáº§u xÃ¡c nháº­n cá»§a ngÆ°á»i dÃ¹ng qua WebSocket trÆ°á»›c khi thá»±c hiá»‡n cÃ¡c hÃ nh Ä‘á»™ng nháº¡y cáº£m (giao dá»‹ch, chuyá»ƒn tiá»n). |
| **Data Masking** | Module 4 (Browser Agent) | Che giáº¥u dá»¯ liá»‡u nháº¡y cáº£m (máº­t kháº©u, sá»‘ tháº») trong Screenshot vÃ  A11y Tree trÆ°á»›c khi gá»­i lÃªn Cloud LLM. |
| **Sandboxing** | Browser Control Layer | Headless Chromium cháº¡y trong mÃ´i trÆ°á»ng **Isolated Sandbox** (vÃ­ dá»¥: Docker/VM) Ä‘á»ƒ ngÄƒn cháº·n mÃ£ Ä‘á»™c tá»« trang web áº£nh hÆ°á»Ÿng Ä‘áº¿n há»‡ thá»‘ng Agent Core. |

---

## 4. Cáº¥u trÃºc ThÆ° má»¥c Sáº£n xuáº¥t (Production Folder Structure)

Cáº¥u trÃºc thÆ° má»¥c Ä‘Æ°á»£c thiáº¿t káº¿ theo nguyÃªn táº¯c **Modularity** (tÃ­nh module hÃ³a) vÃ  **Separation of Concerns** (tÃ¡ch biá»‡t trÃ¡ch nhiá»‡m), giÃºp dá»… dÃ ng báº£o trÃ¬, má»Ÿ rá»™ng vÃ  kiá»ƒm thá»­.

### 4.1. SÆ¡ Ä‘á»“ Cáº¥u trÃºc ThÆ° má»¥c Tá»•ng thá»ƒ

```mermaid
graph TD
    root["ğŸ“ finai-agent-browser/"]
    
    root --> backend["ğŸ“ backend/"]
    root --> frontend["ğŸ“ frontend/"]
    root --> agent["ğŸ“ agent/"]
    root --> browser["ğŸ“ browser/"]
    root --> common["ğŸ“ common/"]
    root --> tests["ğŸ“ tests/"]
    root --> config["ğŸ“ config/"]
    root --> docs["ğŸ“ docs/"]
    root --> scripts["ğŸ“ scripts/"]
    root --> files1["ğŸ“„ pyproject.toml<br/>ğŸ“„ package.json<br/>ğŸ“„ docker-compose.yml"]
    
    %% Backend
    backend --> app["ğŸ“ app/"]
    app --> api["ğŸ“ api/"]
    app --> services["ğŸ“ services/"]
    app --> models["ğŸ“ models/"]
    app --> db["ğŸ“ db/"]
    api --> routes["ğŸ“ routes/"]
    routes --> r1["ğŸ“„ agent.py<br/>ğŸ“„ chat.py"]
    services --> s1["ğŸ“„ agent_service.py<br/>ğŸ“„ browser_service.py<br/>ğŸ“„ llm_service.py"]
    models --> m1["ğŸ“„ agent.py<br/>ğŸ“„ chat.py"]
    db --> d1["ğŸ“„ connection.py<br/>ğŸ“„ models.py"]
    
    %% Frontend
    frontend --> src["ğŸ“ src/"]
    src --> components["ğŸ“ components/"]
    src --> pages["ğŸ“ pages/"]
    src --> hooks["ğŸ“ hooks/"]
    src --> services_fe["ğŸ“ services/"]
    src --> stores["ğŸ“ stores/"]
    components --> c1["ğŸ“ chat/<br/>ğŸ“ browser/<br/>ğŸ“ layout/"]
    
    %% Agent
    agent --> orchestrator["ğŸ“„ orchestrator.py"]
    agent --> state["ğŸ“ state/"]
    agent --> nodes["ğŸ“ nodes/"]
    agent --> tools["ğŸ“ tools/"]
    agent --> prompts["ğŸ“ prompts/"]
    agent --> guards["ğŸ“ guards/"]
    agent --> llm["ğŸ“ llm/"]
    nodes --> n1["ğŸ“„ input_ingestion.py<br/>ğŸ“„ query_understanding.py<br/>ğŸ“„ browser_agent.py<br/>ğŸ“„ reasoning.py<br/>ğŸ“„ synthesis.py"]
    tools --> t1["ğŸ“„ registry.py<br/>ğŸ“„ browser_tools.py<br/>ğŸ“„ search_tools.py"]
    guards --> g1["ğŸ“„ input_guard.py<br/>ğŸ“„ safety_guard.py"]
    llm --> l1["ğŸ“„ provider.py<br/>ğŸ“„ openai_client.py"]
    
    %% Browser
    browser --> controller["ğŸ“„ controller.py"]
    browser --> client["ğŸ“ client/"]
    browser --> dom["ğŸ“ dom/"]
    browser --> a11y["ğŸ“ a11y/"]
    browser --> vision["ğŸ“ vision/"]
    browser --> interaction["ğŸ“ interaction/"]
    browser --> security["ğŸ“ security/"]
    client --> cl1["ğŸ“„ chromium.py<br/>ğŸ“„ page.py"]
    dom --> do1["ğŸ“„ parser.py<br/>ğŸ“„ serializer.py"]
    a11y --> a1["ğŸ“„ extractor.py<br/>ğŸ“„ validator.py"]
    vision --> v1["ğŸ“„ screenshot.py"]
    interaction --> in1["ğŸ“„ actions.py<br/>ğŸ“„ keyboard.py<br/>ğŸ“„ mouse.py"]
    security --> sec1["ğŸ“„ pii_detector.py<br/>ğŸ“„ injection_guard.py"]
    
    %% Common
    common --> c_models["ğŸ“ models/"]
    common --> enums["ğŸ“ enums/"]
    common --> exceptions["ğŸ“ exceptions/"]
    common --> logging["ğŸ“ logging/"]
    
    %% Tests
    tests --> unit["ğŸ“ unit/"]
    tests --> integration["ğŸ“ integration/"]
    tests --> e2e["ğŸ“ e2e/"]
    unit --> u1["ğŸ“„ test_agent.py<br/>ğŸ“„ test_browser.py"]
    integration --> int1["ğŸ“„ test_agent_flow.py<br/>ğŸ“„ test_api.py"]
    
    %% Config
    config --> env["ğŸ“„ development.env<br/>ğŸ“„ production.env"]
    config --> llm_cfg["ğŸ“ llm/"]
    config --> db_cfg["ğŸ“ database/"]
    
    %% Docs
    docs --> doc_files["ğŸ“„ README.md<br/>ğŸ“„ ARCHITECTURE.md<br/>ğŸ“„ API.md"]
    docs --> guides["ğŸ“ guides/"]
    
    %% Scripts
    scripts --> sh["ğŸ“„ setup.sh<br/>ğŸ“„ dev.sh<br/>ğŸ“„ test.sh<br/>ğŸ“„ deploy.sh"]
    scripts --> docker["ğŸ“ docker/"]
    scripts --> k8s["ğŸ“ k8s/"]
    
    style root fill:#e1f5ff
    style backend fill:#fff3e0
    style frontend fill:#f3e5f5
    style agent fill:#e8f5e9
    style browser fill:#fce4ec
    style common fill:#f1f8e9
    style tests fill:#ede7f6
    style config fill:#fff9c4
    style docs fill:#e0f2f1
    style scripts fill:#f5f5f5
```

### 4.2. PhÃ¢n tÃ­ch Chi tiáº¿t CÃ¡c Module Cá»‘t lÃµi

#### **4.2.1. Module `agent/` (Agent Core)**

ÄÃ¢y lÃ  nÆ¡i chá»©a logic cá»§a LangGraph State Machine.

| ThÆ° má»¥c/File | Má»¥c Ä‘Ã­ch | LÃ½ do TÃ¡ch biá»‡t |
| :--- | :--- | :--- |
| `orchestrator.py` | Äá»‹nh nghÄ©a LangGraph State Machine, cÃ¡c Node vÃ  Transitions. | TÃ¡ch biá»‡t logic Ä‘iá»u phá»‘i (Orchestration) khá»i logic nghiá»‡p vá»¥ (Nodes). |
| `state/` | Äá»‹nh nghÄ©a `AgentState` vÃ  cÃ¡c lá»›p dá»¯ liá»‡u liÃªn quan. | Äáº£m báº£o tÃ­nh nháº¥t quÃ¡n cá»§a tráº¡ng thÃ¡i vÃ  dá»… dÃ ng má»Ÿ rá»™ng. |
| `nodes/` | Chá»©a logic nghiá»‡p vá»¥ cá»§a tá»«ng Node (Planner, Executor, Verifier, Replan). | **Modularity:** Má»—i Node lÃ  má»™t hÃ m/lá»›p Ä‘á»™c láº­p, dá»… dÃ ng kiá»ƒm thá»­ Ä‘Æ¡n vá»‹ (Unit Test). |
| `tools/` | Äá»‹nh nghÄ©a cÃ¡c Tool mÃ  Agent cÃ³ thá»ƒ gá»i (Web Fetcher, Financial Calculator). | **Tool Registry:** Quáº£n lÃ½ táº­p trung cÃ¡c kháº£ nÄƒng cá»§a Agent. |
| `guards/` | Chá»©a logic cho cÃ¡c Guardrails (Input Guard, Safety Guard). | **Security:** TÃ¡ch biá»‡t logic báº£o máº­t khá»i logic nghiá»‡p vá»¥ chÃ­nh. |
| `prompts/` | Chá»©a táº¥t cáº£ cÃ¡c System Prompt vÃ  Few-shot Examples. | **Prompt Engineering:** Dá»… dÃ ng quáº£n lÃ½ vÃ  tá»‘i Æ°u hÃ³a cÃ¡c Prompt. |

#### **4.2.2. Module `browser/` (Browser Control)**

Module nÃ y lÃ  lá»›p trá»«u tÆ°á»£ng cho má»i tÆ°Æ¡ng tÃ¡c vá»›i trÃ¬nh duyá»‡t.

| ThÆ° má»¥c/File | Má»¥c Ä‘Ã­ch | LÃ½ do TÃ¡ch biá»‡t |
| :--- | :--- | :--- |
| `controller.py` | Lá»›p giao tiáº¿p chÃ­nh vá»›i Playwright. | Cung cáº¥p API Ä‘Æ¡n giáº£n cho Agent Core, áº©n Ä‘i sá»± phá»©c táº¡p cá»§a Playwright. |
| `client/` | Quáº£n lÃ½ phiÃªn Chromium (khá»Ÿi táº¡o, Ä‘Ã³ng, quáº£n lÃ½ Page Context). | TÃ¡ch biá»‡t logic quáº£n lÃ½ tÃ i nguyÃªn trÃ¬nh duyá»‡t. |
| `a11y/` | Logic trÃ­ch xuáº¥t vÃ  xá»­ lÃ½ A11y Tree. | **Semantic Layer:** Äáº£m báº£o dá»¯ liá»‡u ngá»¯ nghÄ©a Ä‘Æ°á»£c xá»­ lÃ½ chÃ­nh xÃ¡c. |
| `vision/` | Logic chá»¥p Screenshot vÃ  gá»i Vision Engine. | **Fallback Layer:** TÃ¡ch biá»‡t logic Vision tá»‘n kÃ©m. |
| `security/` | Logic Data Masking vÃ  PII Detection trÃªn dá»¯ liá»‡u trÃ¬nh duyá»‡t. | **Safety:** Äáº£m báº£o dá»¯ liá»‡u nháº¡y cáº£m khÃ´ng bá»‹ rÃ² rá»‰. |

#### **4.2.3. Module `backend/` (API Gateway)**

Module nÃ y xá»­ lÃ½ giao tiáº¿p vá»›i tháº¿ giá»›i bÃªn ngoÃ i.

| ThÆ° má»¥c/File | Má»¥c Ä‘Ã­ch | LÃ½ do TÃ¡ch biá»‡t |
| :--- | :--- | :--- |
| `api/routes/` | Äá»‹nh nghÄ©a cÃ¡c endpoint REST vÃ  WebSocket (agent.py, chat.py). | **Routing:** Quáº£n lÃ½ táº­p trung cÃ¡c Ä‘Æ°á»ng dáº«n API. |
| `services/` | Chá»©a cÃ¡c lá»›p dá»‹ch vá»¥ (AgentService, LLMService) Ä‘á»ƒ giao tiáº¿p vá»›i cÃ¡c module khÃ¡c. | **Dependency Injection:** Giáº£m sá»± phá»¥ thuá»™c trá»±c tiáº¿p giá»¯a cÃ¡c module. |
| `db/` | Quáº£n lÃ½ káº¿t ná»‘i PostgreSQL vÃ  Ä‘á»‹nh nghÄ©a cÃ¡c ORM Models. | **Data Persistence:** TÃ¡ch biá»‡t logic truy cáº­p dá»¯ liá»‡u. |

---

## 5. Káº¿t luáº­n vÃ  Khuyáº¿n nghá»‹ Triá»ƒn khai

Thiáº¿t káº¿ cáº¥p cao nÃ y cung cáº¥p má»™t khuÃ´n khá»• vá»¯ng cháº¯c cho viá»‡c xÃ¢y dá»±ng **finAI Web Browser AI Agent** vá»›i kháº£ nÄƒng **tá»± phá»¥c há»“i** vÃ  **an toÃ n** cáº§n thiáº¿t cho cÃ¡c tÃ¡c vá»¥ tÃ i chÃ­nh.

**Khuyáº¿n nghá»‹ Triá»ƒn khai:**

1.  **Æ¯u tiÃªn LangGraph:** Báº¯t Ä‘áº§u báº±ng viá»‡c triá»ƒn khai `AgentState` vÃ  cÃ¡c Node `Planner`, `Executor`, `Verifier` Ä‘á»ƒ thiáº¿t láº­p vÃ²ng láº·p Agentic cá»‘t lÃµi.
2.  **XÃ¢y dá»±ng Lá»›p TÆ°Æ¡ng tÃ¡c Web:** Táº­p trung vÃ o viá»‡c hoÃ n thiá»‡n `a11y/extractor.py` Ä‘á»ƒ Ä‘áº£m báº£o A11y Tree lÃ  nguá»“n dá»¯ liá»‡u chÃ­nh xÃ¡c vÃ  Ä‘Ã¡ng tin cáº­y.
3.  **Kiá»ƒm thá»­ An toÃ n:** Thiáº¿t láº­p cÃ¡c bÃ i kiá»ƒm thá»­ tÃ­ch há»£p (Integration Tests) cho cÃ¡c Guardrails vÃ  Critical Action Confirmation trÆ°á»›c khi triá»ƒn khai báº¥t ká»³ tÃ­nh nÄƒng nÃ o khÃ¡c.

TÃ i liá»‡u nÃ y Ä‘Ã³ng vai trÃ² lÃ  báº£n thiáº¿t káº¿ chÃ­nh thá»©c cho giai Ä‘oáº¡n phÃ¡t triá»ƒn tiáº¿p theo.

---
*(TÃ i liá»‡u nÃ y Ä‘Æ°á»£c biÃªn soáº¡n vá»›i Ä‘á»™ chi tiáº¿t cao, tÆ°Æ¡ng Ä‘Æ°Æ¡ng 50 trang, táº­p trung vÃ o giáº£i thÃ­ch chuyÃªn sÃ¢u vá» kiáº¿n trÃºc, thiáº¿t káº¿ vÃ  cáº¥u trÃºc thÆ° má»¥c.)*


------------------------
## PHáº¦N I: Ná»€N Táº¢NG Cá»¦A Há»† THá»NG AGENT

### ChÆ°Æ¡ng 1: Giá»›i thiá»‡u vá» TÆ° duy Agentic (Agentic Thinking)

#### 1.1. Agentic AI lÃ  gÃ¬?

Äá»ƒ hiá»ƒu vá» Agentic AI, chÃºng ta cáº§n phÃ¢n biá»‡t nÃ³ vá»›i hai lÃ n sÃ³ng AI trÆ°á»›c Ä‘Ã³:

| Loáº¡i AI | MÃ´ táº£ | VÃ­ dá»¥ | Vai trÃ² |
| :--- | :--- | :--- | :--- |
| **AI PhÃ¢n tÃ­ch (Analytical AI)** | Há»c cÃ¡c máº«u tá»« dá»¯ liá»‡u lá»‹ch sá»­ Ä‘á»ƒ Ä‘Æ°a ra dá»± Ä‘oÃ¡n vá» tÆ°Æ¡ng lai. | MÃ´ hÃ¬nh dá»± Ä‘oÃ¡n giÃ¡ cá»• phiáº¿u, há»‡ thá»‘ng gá»£i Ã½ sáº£n pháº©m. | **NhÃ  phÃ¢n tÃ­ch dá»¯ liá»‡u.** |
| **AI Táº¡o sinh (Generative AI)** | Táº¡o ra ná»™i dung má»›i (vÄƒn báº£n, hÃ¬nh áº£nh, Ã¢m thanh) dá»±a trÃªn cÃ¡c máº«u Ä‘Ã£ há»c. | ChatGPT, Midjourney, Sora. | **NgÆ°á»i sÃ¡ng táº¡o ná»™i dung.** |
| **AI Agentic (Agentic AI)** | Tá»± chá»§ hÃ nh Ä‘á»™ng trong má»™t mÃ´i trÆ°á»ng Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu. NÃ³ sá»­ dá»¥ng AI táº¡o sinh Ä‘á»ƒ suy luáº­n vÃ  láº­p káº¿ hoáº¡ch. | Agent tá»± Ä‘á»™ng Ä‘áº·t vÃ© mÃ¡y bay, agent quáº£n lÃ½ chuá»—i cung á»©ng. | **NgÆ°á»i thá»±c thi cÃ´ng viá»‡c.** |

**Agentic AI** lÃ  má»™t há»‡ thá»‘ng pháº§n má»m cÃ³ kháº£ nÄƒng **nháº­n thá»©c (perceive)** mÃ´i trÆ°á»ng cá»§a nÃ³, **láº­p káº¿ hoáº¡ch (plan)** má»™t chuá»—i cÃ¡c hÃ nh Ä‘á»™ng Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»™t má»¥c tiÃªu cá»¥ thá»ƒ, vÃ  **thá»±c thi (execute)** nhá»¯ng hÃ nh Ä‘á»™ng Ä‘Ã³ báº±ng cÃ¡ch sá»­ dá»¥ng má»™t táº­p há»£p cÃ¡c cÃ´ng cá»¥ (tools). NÃ³ lÃ  sá»± káº¿t há»£p giá»¯a kháº£ nÄƒng suy luáº­n cá»§a AI táº¡o sinh vÃ  kháº£ nÄƒng tÆ°Æ¡ng tÃ¡c vá»›i tháº¿ giá»›i thá»±c (hoáº·c tháº¿ giá»›i sá»‘) thÃ´ng qua cÃ¡c API vÃ  hÃ nh Ä‘á»™ng.

Sá»± thay Ä‘á»•i cá»‘t lÃµi tá»« Generative AI sang Agentic AI lÃ  sá»± chuyá»ƒn Ä‘á»•i tá»« **pháº£n há»“i (response)** sang **hÃ nh Ä‘á»™ng (action)**. Má»™t mÃ´ hÃ¬nh ngÃ´n ngá»¯ lá»›n (LLM) chá»‰ cÃ³ thá»ƒ cung cáº¥p cho báº¡n má»™t cÃ¢u tráº£ lá»i, nhÆ°ng má»™t agent cÃ³ thá»ƒ láº¥y cÃ¢u tráº£ lá»i Ä‘Ã³ vÃ  thá»±c hiá»‡n má»™t Ä‘iá»u gÃ¬ Ä‘Ã³ vá»›i nÃ³.

#### 1.2. Táº¡i sao 2025 lÃ  nÄƒm cá»§a Agent?

Sá»± há»™i tá»¥ cá»§a ba yáº¿u tá»‘ chÃ­nh Ä‘Ã£ táº¡o nÃªn má»™t "cÆ¡n bÃ£o hoÃ n háº£o" cho sá»± bÃ¹ng ná»• cá»§a agent:

1.  **Sá»± trÆ°á»Ÿng thÃ nh cá»§a LLM:** CÃ¡c mÃ´ hÃ¬nh nhÆ° GPT-4, Claude 3, vÃ  Gemini Ä‘Ã£ Ä‘áº¡t Ä‘áº¿n má»™t ngÆ°á»¡ng Ä‘á»§ máº¡nh máº½ Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ suy luáº­n vÃ  láº­p káº¿ hoáº¡ch phá»©c táº¡p, vá»‘n lÃ  "bá»™ nÃ£o" cá»§a agent.
2.  **Sá»± phá»• biáº¿n cá»§a API:** Háº§u háº¿t má»i dá»‹ch vá»¥ ká»¹ thuáº­t sá»‘ ngÃ y nay Ä‘á»u cung cáº¥p API, táº¡o ra má»™t "sÃ¢n chÆ¡i" rá»™ng lá»›n Ä‘á»ƒ cÃ¡c agent cÃ³ thá»ƒ tÆ°Æ¡ng tÃ¡c vÃ  hÃ nh Ä‘á»™ng.
3.  **Sá»± phÃ¡t triá»ƒn cá»§a cÃ¡c Framework Agentic:** CÃ¡c cÃ´ng cá»¥ mÃ£ nguá»“n má»Ÿ nhÆ° LangChain, LangGraph, vÃ  CrewAI Ä‘Ã£ trá»«u tÆ°á»£ng hÃ³a pháº§n lá»›n sá»± phá»©c táº¡p trong viá»‡c xÃ¢y dá»±ng agent, cho phÃ©p cÃ¡c nhÃ  phÃ¡t triá»ƒn táº­p trung vÃ o logic nghiá»‡p vá»¥ thay vÃ¬ cÃ¡c chi tiáº¿t ká»¹ thuáº­t cáº¥p tháº¥p.

TÃ¡c Ä‘á»™ng cá»§a xu hÆ°á»›ng nÃ y Ä‘á»‘i vá»›i ngÃ nh cÃ´ng nghiá»‡p pháº§n má»m lÃ  vÃ´ cÃ¹ng to lá»›n. NÃ³ bÃ¡o trÆ°á»›c má»™t sá»± thay Ä‘á»•i tá»« viá»‡c xÃ¢y dá»±ng cÃ¡c á»©ng dá»¥ng cÃ³ giao diá»‡n ngÆ°á»i dÃ¹ng Ä‘á»“ há»a (GUI) sang viá»‡c xÃ¢y dá»±ng cÃ¡c "giao diá»‡n ngÆ°á»i dÃ¹ng ngÃ´n ngá»¯" (LUI - Language User Interfaces), nÆ¡i ngÆ°á»i dÃ¹ng chá»‰ cáº§n nÃªu ra má»¥c tiÃªu cá»§a há» báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn, vÃ  má»™t Ä‘á»™i quÃ¢n cÃ¡c agent sáº½ lÃ m pháº§n cÃ²n láº¡i.

#### 1.3. Cáº¥u trÃºc tÃ i liá»‡u vÃ  Lá»™ trÃ¬nh há»c táº­p

TÃ i liá»‡u nÃ y Ä‘Æ°á»£c cáº¥u trÃºc thÃ nh bá»‘n pháº§n chÃ­nh, táº¡o thÃ nh má»™t lá»™ trÃ¬nh há»c táº­p lÅ©y tiáº¿n:

*   **Pháº§n I: Ná»n táº£ng cá»§a Há»‡ thá»‘ng Agent:** ChÃºng ta sáº½ báº¯t Ä‘áº§u báº±ng cÃ¡ch phÃ¢n tÃ­ch cáº¥u trÃºc cÆ¡ báº£n cá»§a má»™t agent, xÃ¡c Ä‘á»‹nh cÃ¡c thÃ nh pháº§n cá»‘t lÃµi theo nguyÃªn táº¯c MECE.
*   **Pháº§n II: PhÃ¢n loáº¡i cÃ¡c Kiáº¿n trÃºc vÃ  á»¨ng dá»¥ng:** ChÃºng ta sáº½ khÃ¡m phÃ¡ cÃ¡c loáº¡i kiáº¿n trÃºc agent khÃ¡c nhau, tá»« Ä‘Æ¡n giáº£n Ä‘áº¿n phá»©c táº¡p, vÃ  cÃ¡c trÆ°á»ng há»£p sá»­ dá»¥ng thá»±c táº¿ cá»§a chÃºng.
*   **Pháº§n III: Lá»™ trÃ¬nh LÃ m chá»§ Thiáº¿t káº¿ Há»‡ thá»‘ng Agent:** ÄÃ¢y lÃ  pháº§n cá»‘t lÃµi cá»§a tÃ i liá»‡u, cung cáº¥p má»™t lá»™ trÃ¬nh 5 cáº¥p Ä‘á»™ chi tiáº¿t, kÃ¨m theo cÃ¡c dá»± Ã¡n thá»±c hÃ nh cÃ³ code máº«u Ä‘á»ƒ báº¡n cÃ³ thá»ƒ xÃ¢y dá»±ng vÃ  há»c há»i.
*   **Pháº§n IV: ChuyÃªn sÃ¢u vÃ  TÆ°Æ¡ng lai:** ChÃºng ta sáº½ tháº£o luáº­n vá» cÃ¡c chá»§ Ä‘á» nÃ¢ng cao vÃ  nhÃ¬n vá» tÆ°Æ¡ng lai cá»§a lÄ©nh vá»±c agentic AI.

Báº±ng cÃ¡ch Ä‘i theo lá»™ trÃ¬nh nÃ y, báº¡n sáº½ xÃ¢y dá»±ng Ä‘Æ°á»£c má»™t ná»n táº£ng kiáº¿n thá»©c vá»¯ng cháº¯c vÃ  cÃ³ há»‡ thá»‘ng, sáºµn sÃ ng Ä‘á»ƒ chinh phá»¥c nhá»¯ng thÃ¡ch thá»©c phá»©c táº¡p nháº¥t trong lÄ©nh vá»±c thiáº¿t káº¿ há»‡ thá»‘ng agent.


### ChÆ°Æ¡ng 2: PhÃ¢n tÃ­ch MECE cÃ¡c ThÃ nh pháº§n cá»§a má»™t Agent

Äá»ƒ xÃ¢y dá»±ng má»™t há»‡ thá»‘ng agent máº¡nh máº½ vÃ  cÃ³ thá»ƒ báº£o trÃ¬, chÃºng ta khÃ´ng thá»ƒ xem nÃ³ nhÆ° má»™t "há»™p Ä‘en" bÃ­ áº©n. Thay vÃ o Ä‘Ã³, chÃºng ta pháº£i Ã¡p dá»¥ng tÆ° duy ká»¹ thuáº­t há»‡ thá»‘ng, phÃ¢n rÃ£ nÃ³ thÃ nh cÃ¡c thÃ nh pháº§n chá»©c nÄƒng riÃªng biá»‡t, khÃ´ng chá»“ng chÃ©o. Khung MECE dÆ°á»›i Ä‘Ã¢y cung cáº¥p má»™t "báº£n thiáº¿t káº¿" tiÃªu chuáº©n cho má»i agent, báº¥t ká»ƒ má»©c Ä‘á»™ phá»©c táº¡p.

Má»™t agent cÃ³ thá»ƒ Ä‘Æ°á»£c chia thÃ nh bá»‘n lá»›p (Layer) chÃ­nh, má»—i lá»›p chá»©a cÃ¡c thÃ nh pháº§n (Component) cá»¥ thá»ƒ. Bá»‘n lá»›p nÃ y Ä‘áº¡i diá»‡n cho chu trÃ¬nh xá»­ lÃ½ hoÃ n chá»‰nh cá»§a má»™t agent: tá»« viá»‡c nháº­n thÃ´ng tin Ä‘áº¿n viá»‡c thá»±c hiá»‡n hÃ nh Ä‘á»™ng.

**SÆ¡ Ä‘á»“ tá»•ng quan cÃ¡c lá»›p MECE cá»§a má»™t Agent:**

```mermaid
graph LR
    subgraph Perception
        InputProcessor
        EnvironmentMonitor
    end
    subgraph Cognition
        ReasoningEngine
        PlanningModule
        MemorySystem
    end
    subgraph Action
        ToolLibrary
        ExecutionEngine
    end
    subgraph Governance
        Guardrails
        HITL
    end

    Perception --> Cognition;
    Cognition --> Action;
    Action --> Perception;
    Governance -- Monitors & Controls --> Cognition;
    Governance -- Monitors & Controls --> Action;
```

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e3f2fd','primaryTextColor':'#000','primaryBorderColor':'#1976d2','lineColor':'#546e7a','secondaryColor':'#fff9c4','tertiaryColor':'#c8e6c9','fontSize':'14px'}}}%%
flowchart TB
    %% External entities
    User(["ğŸ‘¨â€ğŸ’» USER INPUT<br/>Text | Voice | Image | Video"])
    
    %% ========== PERCEPTION LAYER ==========
    subgraph PERCEPTION["ğŸ” PERCEPTION LAYER - Thu tháº­p & Chuáº©n hÃ³a Context"]
        direction TB
        
        subgraph IP["ğŸ“¥ INPUT PROCESSOR"]
            direction TB
            IP1["ğŸ­ Modality Handler<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Speech-to-Text<br/>â€¢ Vision Model<br/>â€¢ File Parser"]
            IP2["ğŸ›¡ï¸ Validation & Sanitization<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Format Check<br/>â€¢ Prompt Injection Defense<br/>â€¢ Malicious Code Filter"]
            IP3["âš™ï¸ Normalization<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Unified Format<br/>â€¢ ISO Standards<br/>â€¢ JSON Structure"]
            IP1 --> IP2 --> IP3
        end
        
        subgraph EM["ğŸŒ ENVIRONMENT MONITOR"]
            direction TB
            EM1["ğŸ“Š State Tracking<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Time & Location<br/>â€¢ Order Status<br/>â€¢ API States"]
            EM2["ğŸ”„ Update Mechanism<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Real-time (WebSocket)<br/>â€¢ Periodic (Polling)<br/>â€¢ Event-driven"]
            EM3["ğŸš¨ Event Detection<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Change Detection<br/>â€¢ Trigger System<br/>â€¢ Alert Generation"]
            EM1 --> EM2 --> EM3
        end
        
        IP ~~~ EM
    end
    
    %% ========== COGNITION LAYER ==========
    subgraph COGNITION["ğŸ§  COGNITION LAYER - Suy luáº­n, Láº­p káº¿ hoáº¡ch & Ghi nhá»›"]
        direction TB
        
        subgraph RE["ğŸ’¡ REASONING ENGINE"]
            direction TB
            RE1["ğŸ¯ Model Selection<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ GPT-4o (Complex)<br/>â€¢ GPT-4o-mini (Simple)<br/>â€¢ Fine-tuned Models"]
            RE2["ğŸ“ Prompt Architecture<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ System Prompt<br/>â€¢ Few-Shot Examples<br/>â€¢ Context Injection"]
            RE3["ğŸ”— Reasoning Patterns<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Chain-of-Thought<br/>â€¢ ReAct (Reason+Act)<br/>â€¢ Tree of Thoughts"]
            RE1 --> RE2 --> RE3
        end
        
        subgraph PM["ğŸ“‹ PLANNING MODULE"]
            direction TB
            PM1["ğŸ§© Task Decomposition<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Break into Subtasks<br/>â€¢ Define Dependencies<br/>â€¢ Set Priorities"]
            PM2["ğŸ“ Plan Representation<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Sequential List<br/>â€¢ DAG (Parallel)<br/>â€¢ State Machine"]
            PM3["ğŸ”„ Dynamic Replanning<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Failure Detection<br/>â€¢ Alternative Routes<br/>â€¢ Adaptive Strategy"]
            PM1 --> PM2 --> PM3
        end
        
        subgraph MS["ğŸ’¾ MEMORY SYSTEM"]
            direction TB
            MS1["âš¡ Short-Term Memory<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Context Window<br/>â€¢ Current Session<br/>â€¢ Redis Cache"]
            MS2["ğŸ—„ï¸ Long-Term Memory<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Vector DB (RAG)<br/>â€¢ User Preferences<br/>â€¢ Knowledge Base"]
            MS1 -.->|Session Data| MS2
        end
        
        RE --> PM
        PM -.->|Query| MS
        MS -.->|Context| RE
    end
    
    %% ========== ACTION LAYER ==========
    subgraph ACTION["âš¡ ACTION LAYER - Thá»±c thi & Quan sÃ¡t"]
        direction TB
        
        subgraph TL["ğŸ”§ TOOL & FUNCTION LIBRARY"]
            direction TB
            TL1["ğŸ“š Tool Definition<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Function Name<br/>â€¢ Docstring<br/>â€¢ Pydantic Schema"]
            TL2["ğŸ”¨ Tool Types<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Python Functions<br/>â€¢ External APIs<br/>â€¢ Sub-Agents"]
            TL3["ğŸ“¦ Versioning & Management<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Version Control<br/>â€¢ API Compatibility<br/>â€¢ Registry System"]
            TL1 --> TL2 --> TL3
        end
        
        subgraph EE["ğŸš€ EXECUTION ENGINE"]
            direction TB
            EE1["ğŸ“ Tool Invocation<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Function Calls<br/>â€¢ API Requests<br/>â€¢ Parameter Binding"]
            EE2["ğŸ”§ Error Handling<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Try-Catch Logic<br/>â€¢ Exponential Backoff<br/>â€¢ Circuit Breaker"]
            EE3["âš™ï¸ Advanced Features<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Timeout Control<br/>â€¢ Concurrent Execution<br/>â€¢ Result Parsing"]
            EE1 --> EE2 --> EE3
        end
        
        TL -.->|Provide Tools| EE
    end
    
    %% ========== GOVERNANCE LAYER ==========
    subgraph GOVERNANCE["ğŸ›¡ï¸ GOVERNANCE LAYER - GiÃ¡m sÃ¡t, Kiá»ƒm soÃ¡t & An toÃ n"]
        direction TB
        
        subgraph GR["âš–ï¸ GUARDRAILS & SAFETY"]
            direction TB
            GR1["ğŸ›¡ï¸ Input/Output Filtering<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Prompt Injection Defense<br/>â€¢ PII Protection<br/>â€¢ Content Moderation"]
            GR2["ğŸ” Access Control<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ RBAC (Role-Based)<br/>â€¢ Tool Permissions<br/>â€¢ Privilege Management"]
            GR3["ğŸ’° Resource Monitoring<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Token Budget<br/>â€¢ API Rate Limits<br/>â€¢ Cost Tracking"]
            GR1 --> GR2 --> GR3
        end
        
        subgraph HITL["ğŸ‘¤ HUMAN-IN-THE-LOOP"]
            direction TB
            HITL1["ğŸ›‘ Checkpoint Definition<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Critical Actions<br/>â€¢ Low Confidence<br/>â€¢ High Cost"]
            HITL2["ğŸ–¥ï¸ Review Interface<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Approve/Reject UI<br/>â€¢ Plan Visualization<br/>â€¢ Edit Parameters"]
            HITL3["ğŸ”º Escalation Paths<br/>â”€â”€â”€â”€â”€â”€â”€â”€<br/>â€¢ Expert Routing<br/>â€¢ Failure Handling<br/>â€¢ Manual Override"]
            HITL1 --> HITL2 --> HITL3
        end
        
        GR ~~~ HITL
    end
    
    %% Final output
    Output(["ğŸ“¤ FINAL OUTPUT<br/>Action Results | Response"])
    
    %% ========== MAIN FLOW ==========
    User -->|Raw Input| PERCEPTION
    PERCEPTION -->|Normalized Context<br/>+ Environment State| COGNITION
    COGNITION -->|Action Plan<br/>+ Tool Selection| ACTION
    ACTION -->|Execution Results<br/>+ Observations| PERCEPTION
    ACTION -->|Preliminary Output| GOVERNANCE
    GOVERNANCE -->|Validated Output| Output
    
    %% ========== GOVERNANCE MONITORING ==========
    GOVERNANCE -.->|Monitor Reasoning<br/>& Planning| COGNITION
    GOVERNANCE -.->|Control Execution<br/>& Tool Access| ACTION
    HITL -.->|Human Approval<br/>for Critical Actions| Output
    
    %% ========== STYLING ==========
    
    %% Layer styling
    style PERCEPTION fill:#e3f2fd,stroke:#1976d2,stroke-width:4px,color:#000
    style COGNITION fill:#fff9c4,stroke:#f57f00,stroke-width:4px,color:#000
    style ACTION fill:#c8e6c9,stroke:#388e3c,stroke-width:4px,color:#000
    style GOVERNANCE fill:#ffccbc,stroke:#d84315,stroke-width:4px,color:#000
    
    %% Perception components
    style IP fill:#bbdefb,stroke:#1565c0,stroke-width:3px,color:#000
    style EM fill:#bbdefb,stroke:#1565c0,stroke-width:3px,color:#000
    style IP1 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style IP2 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style IP3 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style EM1 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style EM2 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style EM3 fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    
    %% Cognition components
    style RE fill:#fff59d,stroke:#f57c00,stroke-width:3px,color:#000
    style PM fill:#fff59d,stroke:#f57c00,stroke-width:3px,color:#000
    style MS fill:#fff59d,stroke:#f57c00,stroke-width:3px,color:#000
    style RE1 fill:#fff176,stroke:#e65100,stroke-width:2px
    style RE2 fill:#fff176,stroke:#e65100,stroke-width:2px
    style RE3 fill:#fff176,stroke:#e65100,stroke-width:2px
    style PM1 fill:#fff176,stroke:#e65100,stroke-width:2px
    style PM2 fill:#fff176,stroke:#e65100,stroke-width:2px
    style PM3 fill:#fff176,stroke:#e65100,stroke-width:2px
    style MS1 fill:#fff176,stroke:#e65100,stroke-width:2px
    style MS2 fill:#fff176,stroke:#e65100,stroke-width:2px
    
    %% Action components
    style TL fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px,color:#000
    style EE fill:#a5d6a7,stroke:#2e7d32,stroke-width:3px,color:#000
    style TL1 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style TL2 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style TL3 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style EE1 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style EE2 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style EE3 fill:#81c784,stroke:#1b5e20,stroke-width:2px
    
    %% Governance components
    style GR fill:#ffab91,stroke:#bf360c,stroke-width:3px,color:#000
    style HITL fill:#ffab91,stroke:#bf360c,stroke-width:3px,color:#000
    style GR1 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style GR2 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style GR3 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style HITL1 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style HITL2 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style HITL3 fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    
    %% External entities
    style User fill:#e1bee7,stroke:#6a1b9a,stroke-width:3px,color:#000
    style Output fill:#aed581,stroke:#33691e,stroke-width:3px,color:#000
```

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e3f2fd','fontSize':'15px'}}}%%
flowchart TB
    User(["ğŸ‘¨â€ğŸ’» USER<br/>Input"])
    
    subgraph P1["ğŸ” PERCEPTION LAYER"]
        direction LR
        P1A["ğŸ“¥ Input Processor<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ­ Modality Handler<br/>ğŸ›¡ï¸ Validation<br/>âš™ï¸ Normalization"]
        P1B["ğŸŒ Environment Monitor<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ“Š State Tracking<br/>ğŸ”„ Updates<br/>ğŸš¨ Events"]
        P1A ~~~ P1B
    end
    
    subgraph P2["ğŸ§  COGNITION LAYER"]
        direction LR
        P2A["ğŸ’¡ Reasoning Engine<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ¯ Model Selection<br/>ğŸ“ Prompt Design<br/>ğŸ”— CoT/ReAct"]
        P2B["ğŸ“‹ Planning Module<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ§© Decomposition<br/>ğŸ“ DAG/Sequential<br/>ğŸ”„ Replanning"]
        P2C["ğŸ’¾ Memory<br/>â”â”â”â”â”â”â”â”â”<br/>âš¡ Short-term<br/>ğŸ—„ï¸ Long-term"]
        P2A --> P2B
        P2B -.-> P2C
        P2C -.-> P2A
    end
    
    subgraph P3["âš¡ ACTION LAYER"]
        direction LR
        P3A["ğŸ”§ Tool Library<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ“š Definitions<br/>ğŸ”¨ Functions/APIs<br/>ğŸ“¦ Versioning"]
        P3B["ğŸš€ Execution Engine<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ“ Invocation<br/>ğŸ”§ Error Handling<br/>âš™ï¸ Concurrency"]
        P3A -.-> P3B
    end
    
    subgraph P4["ğŸ›¡ï¸ GOVERNANCE LAYER"]
        direction LR
        P4A["âš–ï¸ Guardrails<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ›¡ï¸ I/O Filter<br/>ğŸ” RBAC<br/>ğŸ’° Budget"]
        P4B["ğŸ‘¤ HITL<br/>â”â”â”â”â”â”â”â”â”<br/>ğŸ›‘ Checkpoints<br/>ğŸ–¥ï¸ Review UI<br/>ğŸ”º Escalation"]
        P4A ~~~ P4B
    end
    
    Output(["ğŸ“¤ OUTPUT"])
    
    User --> P1
    P1 -->|Context| P2
    P2 -->|Plan| P3
    P3 -->|Results| P1
    P3 --> P4
    P4 --> Output
    
    P4 -.->|Monitor| P2
    P4 -.->|Control| P3
    
    style P1 fill:#e3f2fd,stroke:#1976d2,stroke-width:4px
    style P2 fill:#fff9c4,stroke:#f57f00,stroke-width:4px
    style P3 fill:#c8e6c9,stroke:#388e3c,stroke-width:4px
    style P4 fill:#ffccbc,stroke:#d84315,stroke-width:4px
    
    style P1A fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style P1B fill:#90caf9,stroke:#0d47a1,stroke-width:2px
    style P2A fill:#fff176,stroke:#e65100,stroke-width:2px
    style P2B fill:#fff176,stroke:#e65100,stroke-width:2px
    style P2C fill:#fff176,stroke:#e65100,stroke-width:2px
    style P3A fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style P3B fill:#81c784,stroke:#1b5e20,stroke-width:2px
    style P4A fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    style P4B fill:#ff8a65,stroke:#bf360c,stroke-width:2px
    
    style User fill:#e1bee7,stroke:#6a1b9a,stroke-width:3px
    style Output fill:#aed581,stroke:#33691e,stroke-width:3px
```

BÃ¢y giá», chÃºng ta sáº½ Ä‘i sÃ¢u vÃ o tá»«ng thÃ nh pháº§n trong má»—i lá»›p.

#### 2.1. Lá»›p 1: Nháº­n thá»©c (Perception Layer)

ÄÃ¢y lÃ  lá»›p chá»‹u trÃ¡ch nhiá»‡m thu tháº­p thÃ´ng tin tá»« tháº¿ giá»›i bÃªn ngoÃ i vÃ  chuyá»ƒn Ä‘á»•i nÃ³ thÃ nh má»™t Ä‘á»‹nh dáº¡ng mÃ  "bá»™ nÃ£o" cá»§a agent cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c. Náº¿u khÃ´ng cÃ³ lá»›p nháº­n thá»©c hiá»‡u quáº£, agent sáº½ bá»‹ "mÃ¹" vÃ  "Ä‘iáº¿c".

**2.1.1. ThÃ nh pháº§n: Bá»™ xá»­ lÃ½ Ä‘áº§u vÃ o (Input Processor)**

*   **Chá»©c nÄƒng:** LÃ  cá»­a ngÃµ Ä‘áº§u tiÃªn cá»§a agent, chá»‹u trÃ¡ch nhiá»‡m tiáº¿p nháº­n, lÃ m sáº¡ch vÃ  chuáº©n hÃ³a táº¥t cáº£ cÃ¡c loáº¡i dá»¯ liá»‡u Ä‘áº§u vÃ o.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Xá»­ lÃ½ Ä‘a phÆ°Æ¡ng thá»©c (Modality Handling):** Agent khÃ´ng chá»‰ nháº­n vÄƒn báº£n. NÃ³ cÃ³ thá»ƒ nháº­n hÃ¬nh áº£nh (tá»« file upload), giá»ng nÃ³i (tá»« microphone), video, hoáº·c dá»¯ liá»‡u cÃ³ cáº¥u trÃºc (tá»« má»™t API call). Input Processor pháº£i xÃ¡c Ä‘á»‹nh loáº¡i dá»¯ liá»‡u vÃ  sá»­ dá»¥ng cÃ¡c mÃ´ hÃ¬nh chuyÃªn biá»‡t (vÃ­ dá»¥: mÃ´ hÃ¬nh Speech-to-Text nhÆ° Whisper cho Ã¢m thanh, mÃ´ hÃ¬nh Vision cho hÃ¬nh áº£nh) Ä‘á»ƒ chuyá»ƒn Ä‘á»•i táº¥t cáº£ vá» má»™t Ä‘á»‹nh dáº¡ng chung, thÆ°á»ng lÃ  vÄƒn báº£n hoáº·c JSON.
    *   **XÃ¡c thá»±c vÃ  lÃ m sáº¡ch (Validation & Sanitization):** Dá»¯ liá»‡u Ä‘áº§u vÃ o tá»« ngÆ°á»i dÃ¹ng hoáº·c há»‡ thá»‘ng bÃªn ngoÃ i khÃ´ng bao giá» Ä‘Ã¡ng tin cáº­y 100%. ThÃ nh pháº§n nÃ y pháº£i kiá»ƒm tra xem dá»¯ liá»‡u cÃ³ há»£p lá»‡ khÃ´ng (vÃ­ dá»¥: má»™t Ä‘á»‹a chá»‰ email cÃ³ Ä‘Ãºng Ä‘á»‹nh dáº¡ng khÃ´ng?), vÃ  quan trá»ng hÆ¡n, loáº¡i bá» cÃ¡c mÃ£ Ä‘á»™c háº¡i hoáº·c cÃ¡c ká»¹ thuáº­t táº¥n cÃ´ng nhÆ° **Prompt Injection**.
    *   **Chuáº©n hÃ³a (Normalization):** Dá»¯ liá»‡u tá»« cÃ¡c nguá»“n khÃ¡c nhau cÃ³ thá»ƒ cÃ³ Ä‘á»‹nh dáº¡ng khÃ¡c nhau. VÃ­ dá»¥, ngÃ y thÃ¡ng cÃ³ thá»ƒ lÃ  `DD/MM/YYYY` hoáº·c `MM-DD-YY`. Input Processor sáº½ chuyá»ƒn Ä‘á»•i táº¥t cáº£ vá» má»™t Ä‘á»‹nh dáº¡ng thá»‘ng nháº¥t (vÃ­ dá»¥: ISO 8601) Ä‘á»ƒ cÃ¡c lá»›p sau cÃ³ thá»ƒ xá»­ lÃ½ má»™t cÃ¡ch nháº¥t quÃ¡n.
*   **Táº§m quan trá»ng:** Má»™t Input Processor yáº¿u kÃ©m sáº½ dáº«n Ä‘áº¿n viá»‡c agent hiá»ƒu sai yÃªu cáº§u, dá»… bá»‹ táº¥n cÃ´ng, hoáº·c khÃ´ng thá»ƒ xá»­ lÃ½ cÃ¡c loáº¡i thÃ´ng tin Ä‘a dáº¡ng, lÃ m giáº£m Ä‘Ã¡ng ká»ƒ tÃ­nh há»¯u dá»¥ng cá»§a nÃ³.

**2.1.2. ThÃ nh pháº§n: Bá»™ giÃ¡m sÃ¡t mÃ´i trÆ°á»ng (Environment Monitor)**

*   **Chá»©c nÄƒng:** Duy trÃ¬ má»™t mÃ´ hÃ¬nh ná»™i táº¡i (internal model) vá» tráº¡ng thÃ¡i cá»§a tháº¿ giá»›i bÃªn ngoÃ i mÃ  agent cáº§n quan tÃ¢m. NÃ³ tráº£ lá»i cÃ¢u há»i: "Chuyá»‡n gÃ¬ Ä‘ang xáº£y ra xung quanh tÃ´i?"
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Theo dÃµi tráº¡ng thÃ¡i (State Tracking):** ThÃ nh pháº§n nÃ y cÃ³ thá»ƒ theo dÃµi cÃ¡c thÃ´ng tin nhÆ°: thá»i gian hiá»‡n táº¡i, vá»‹ trÃ­ cá»§a ngÆ°á»i dÃ¹ng, tráº¡ng thÃ¡i cá»§a má»™t Ä‘Æ¡n hÃ ng, giÃ¡ cá»• phiáº¿u hiá»‡n táº¡i, hoáº·c ná»™i dung cá»§a má»™t trang web. NÃ³ khÃ´ng chá»‰ lÃ  dá»¯ liá»‡u tÄ©nh mÃ  lÃ  má»™t bá»©c tranh Ä‘á»™ng vá» mÃ´i trÆ°á»ng.
    *   **Cáº­p nháº­t theo thá»i gian thá»±c hoáº·c Ä‘á»‹nh ká»³ (Real-time vs. Periodic Updates):** TÃ¹y thuá»™c vÃ o yÃªu cáº§u, viá»‡c cáº­p nháº­t cÃ³ thá»ƒ diá»…n ra liÃªn tá»¥c (vÃ­ dá»¥: qua WebSockets Ä‘á»ƒ theo dÃµi giÃ¡ tiá»n Ä‘iá»‡n tá»­) hoáº·c theo chu ká»³ (vÃ­ dá»¥: kiá»ƒm tra email má»›i má»—i 5 phÃºt).
    *   **PhÃ¡t hiá»‡n sá»± kiá»‡n (Event Detection):** ÄÃ¢y lÃ  má»™t chá»©c nÄƒng quan trá»ng. Thay vÃ¬ chá»‰ Ä‘á»c tráº¡ng thÃ¡i, Environment Monitor cÃ³ thá»ƒ phÃ¡t hiá»‡n nhá»¯ng *thay Ä‘á»•i* quan trá»ng vÃ  kÃ­ch hoáº¡t agent hÃ nh Ä‘á»™ng. VÃ­ dá»¥: "Khi tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng chuyá»ƒn tá»« 'Äang giao' sang 'ÄÃ£ giao', hÃ£y kÃ­ch hoáº¡t agent gá»­i email cáº£m Æ¡n cho khÃ¡ch hÃ ng."
*   **Táº§m quan trá»ng:** Náº¿u khÃ´ng cÃ³ Environment Monitor, agent chá»‰ cÃ³ thá»ƒ pháº£n á»©ng vá»›i cÃ¡c yÃªu cáº§u trá»±c tiáº¿p cá»§a ngÆ°á»i dÃ¹ng. Vá»›i nÃ³, agent cÃ³ thá»ƒ trá»Ÿ nÃªn **chá»§ Ä‘á»™ng (proactive)**, tá»± Ä‘á»™ng hÃ nh Ä‘á»™ng khi cÃ³ sá»± thay Ä‘á»•i trong mÃ´i trÆ°á»ng, má»Ÿ ra vÃ´ sá»‘ á»©ng dá»¥ng tá»± Ä‘á»™ng hÃ³a thÃ´ng minh.

#### 2.2. Lá»›p 2: Nháº­n thá»©c (Cognition Layer)

ÄÃ¢y lÃ  "bá»™ nÃ£o" cá»§a agent, nÆ¡i diá»…n ra cÃ¡c quÃ¡ trÃ¬nh suy luáº­n, láº­p káº¿ hoáº¡ch vÃ  ghi nhá»›. Cháº¥t lÆ°á»£ng cá»§a lá»›p nÃ y quyáº¿t Ä‘á»‹nh má»©c Ä‘á»™ "thÃ´ng minh" cá»§a agent.

**2.2.1. ThÃ nh pháº§n: Äá»™ng cÆ¡ suy luáº­n (Reasoning Engine)**

*   **Chá»©c nÄƒng:** LÃ  háº¡t nhÃ¢n cá»§a lá»›p nháº­n thá»©c, thÆ°á»ng lÃ  má»™t MÃ´ hÃ¬nh NgÃ´n ngá»¯ Lá»›n (LLM), chá»‹u trÃ¡ch nhiá»‡m hiá»ƒu yÃªu cáº§u, suy luáº­n logic, vÃ  Ä‘Æ°a ra cÃ¡c quyáº¿t Ä‘á»‹nh cáº¥p cao.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Lá»±a chá»n MÃ´ hÃ¬nh (Model Selection):** KhÃ´ng pháº£i lÃºc nÃ o cÅ©ng cáº§n mÃ´ hÃ¬nh máº¡nh nháº¥t (vÃ  Ä‘áº¯t nháº¥t). Má»™t quyáº¿t Ä‘á»‹nh kiáº¿n trÃºc quan trá»ng lÃ  chá»n Ä‘Ãºng LLM cho Ä‘Ãºng cÃ´ng viá»‡c. VÃ­ dá»¥: dÃ¹ng GPT-4o cho cÃ¡c tÃ¡c vá»¥ láº­p káº¿ hoáº¡ch phá»©c táº¡p, nhÆ°ng dÃ¹ng GPT-4o-mini hoáº·c má»™t mÃ´ hÃ¬nh Ä‘Æ°á»£c fine-tune cho cÃ¡c tÃ¡c vá»¥ phÃ¢n loáº¡i Ä‘Æ¡n giáº£n Ä‘á»ƒ tiáº¿t kiá»‡m chi phÃ­ vÃ  giáº£m Ä‘á»™ trá»….
    *   **Kiáº¿n trÃºc Prompt (Prompt Architecture):** ÄÃ¢y lÃ  nghá»‡ thuáº­t vÃ  khoa há»c cá»§a viá»‡c "láº­p trÃ¬nh" LLM. Má»™t prompt tá»‘t khÃ´ng chá»‰ lÃ  má»™t cÃ¢u há»i. NÃ³ bao gá»“m:
        *   **System Prompt:** Äá»‹nh nghÄ©a vai trÃ², tÃ­nh cÃ¡ch, vÃ  cÃ¡c quy táº¯c báº¥t biáº¿n cá»§a agent (vÃ­ dá»¥: "Báº¡n lÃ  má»™t trá»£ lÃ½ du lá»‹ch chuyÃªn nghiá»‡p, luÃ´n tráº£ lá»i má»™t cÃ¡ch lá»‹ch sá»± vÃ  chi tiáº¿t.").
        *   **Few-Shot Examples:** Cung cáº¥p má»™t vÃ i vÃ­ dá»¥ vá» Ä‘áº§u vÃ o vÃ  Ä‘áº§u ra mong muá»‘n Ä‘á»ƒ hÆ°á»›ng dáº«n LLM hoáº¡t Ä‘á»™ng Ä‘Ãºng cÃ¡ch.
        *   **Context:** Cung cáº¥p thÃ´ng tin liÃªn quan tá»« Bá»™ nhá»› (Memory System) Ä‘á»ƒ agent cÃ³ thá»ƒ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh dá»±a trÃªn ngá»¯ cáº£nh.
    *   **CÃ¡c Máº«u Suy luáº­n (Reasoning Patterns):** Äá»ƒ giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» phá»©c táº¡p, agent cáº§n cÃ¡c ká»¹ thuáº­t suy luáº­n cÃ³ cáº¥u trÃºc. CÃ¡c máº«u phá»• biáº¿n bao gá»“m:
        *   **Chain-of-Thought (CoT):** HÆ°á»›ng dáº«n LLM "suy nghÄ© tá»«ng bÆ°á»›c" trÆ°á»›c khi Ä‘Æ°a ra cÃ¢u tráº£ lá»i cuá»‘i cÃ¹ng, giÃºp cáº£i thiá»‡n Ä‘á»™ chÃ­nh xÃ¡c cá»§a cÃ¡c bÃ i toÃ¡n logic.
        *   **ReAct (Reason + Act):** Má»™t máº«u cá»±c ká»³ quan trá»ng cho agent. LLM sáº½ láº·p Ä‘i láº·p láº¡i chu trÃ¬nh: **Suy luáº­n (Reason)** vá» bÆ°á»›c tiáº¿p theo cáº§n lÃ m -> **HÃ nh Ä‘á»™ng (Act)** báº±ng cÃ¡ch gá»i má»™t cÃ´ng cá»¥ -> **Quan sÃ¡t (Observe)** káº¿t quáº£ cá»§a cÃ´ng cá»¥ Ä‘Ã³. Chu trÃ¬nh nÃ y cho phÃ©p agent tÆ°Æ¡ng tÃ¡c vá»›i mÃ´i trÆ°á»ng vÃ  Ä‘iá»u chá»‰nh káº¿ hoáº¡ch cá»§a mÃ¬nh.
*   **Táº§m quan trá»ng:** ÄÃ¢y lÃ  thÃ nh pháº§n quyáº¿t Ä‘á»‹nh kháº£ nÄƒng giáº£i quyáº¿t váº¥n Ä‘á» cá»§a agent. Má»™t Reasoning Engine máº¡nh máº½ cÃ³ thá»ƒ hiá»ƒu Ä‘Æ°á»£c cÃ¡c yÃªu cáº§u mÆ¡ há»“, phÃ¡ vá»¡ cÃ¡c váº¥n Ä‘á» phá»©c táº¡p, vÃ  Ä‘Æ°a ra cÃ¡c quyáº¿t Ä‘á»‹nh thÃ´ng minh.

**2.2.2. ThÃ nh pháº§n: Module láº­p káº¿ hoáº¡ch (Planning Module)**

*   **Chá»©c nÄƒng:** Chuyá»ƒn Ä‘á»•i má»™t má»¥c tiÃªu cáº¥p cao, thÆ°á»ng mÆ¡ há»“ cá»§a ngÆ°á»i dÃ¹ng (vÃ­ dá»¥: "lÃªn káº¿ hoáº¡ch cho má»™t chuyáº¿n Ä‘i") thÃ nh má»™t chuá»—i cÃ¡c bÆ°á»›c cá»¥ thá»ƒ, cÃ³ thá»ƒ thá»±c thi Ä‘Æ°á»£c.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **PhÃ¢n rÃ£ nhiá»‡m vá»¥ (Task Decomposition):** ÄÃ¢y lÃ  chá»©c nÄƒng cá»‘t lÃµi. Module nÃ y sáº½ chia má»™t nhiá»‡m vá»¥ lá»›n thÃ nh cÃ¡c nhiá»‡m vá»¥ con nhá» hÆ¡n. VÃ­ dá»¥, "lÃªn káº¿ hoáº¡ch chuyáº¿n Ä‘i" Ä‘Æ°á»£c chia thÃ nh: (1) TÃ¬m vÃ© mÃ¡y bay, (2) TÃ¬m khÃ¡ch sáº¡n, (3) TÃ¬m cÃ¡c Ä‘á»‹a Ä‘iá»ƒm tham quan, (4) Láº­p lá»‹ch trÃ¬nh chi tiáº¿t.
    *   **Biá»ƒu diá»…n Káº¿ hoáº¡ch (Plan Representation):** Káº¿ hoáº¡ch cÃ³ thá»ƒ Ä‘Æ°á»£c biá»ƒu diá»…n dÆ°á»›i dáº¡ng má»™t danh sÃ¡ch cÃ¡c bÆ°á»›c tuáº§n tá»±, hoáº·c phá»©c táº¡p hÆ¡n, lÃ  má»™t **Äá»“ thá»‹ cÃ³ hÆ°á»›ng khÃ´ng chu trÃ¬nh (DAG - Directed Acyclic Graph)**, cho phÃ©p thá»±c hiá»‡n cÃ¡c bÆ°á»›c song song.
    *   **TÃ¡i láº­p káº¿ hoáº¡ch Ä‘á»™ng (Dynamic Replanning):** Tháº¿ giá»›i thá»±c khÃ´ng thá»ƒ Ä‘oÃ¡n trÆ°á»›c. Má»™t cÃ´ng cá»¥ cÃ³ thá»ƒ tháº¥t báº¡i, má»™t API cÃ³ thá»ƒ khÃ´ng tráº£ vá» dá»¯ liá»‡u. Planning Module pháº£i cÃ³ kháº£ nÄƒng nháº­n biáº¿t tháº¥t báº¡i tá»« Lá»›p HÃ nh Ä‘á»™ng (Action Layer) vÃ  tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh káº¿ hoáº¡ch. VÃ­ dá»¥: "KhÃ´ng tÃ¬m tháº¥y chuyáº¿n bay vÃ o ngÃ y X, thá»­ tÃ¬m vÃ o ngÃ y Y."
    *   **CÃ¡c ká»¹ thuáº­t nÃ¢ng cao:** CÃ¡c há»‡ thá»‘ng phá»©c táº¡p cÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡c ká»¹ thuáº­t nhÆ° **Tree of Thoughts (ToT)**, nÆ¡i agent khÃ¡m phÃ¡ nhiá»u nhÃ¡nh káº¿ hoáº¡ch khÃ¡c nhau vÃ  Ä‘Ã¡nh giÃ¡ chÃºng trÆ°á»›c khi chá»n ra nhÃ¡nh tá»‘t nháº¥t.
*   **Táº§m quan trá»ng:** Náº¿u Reasoning Engine lÃ  bá»™ nÃ£o chiáº¿n lÆ°á»£c, thÃ¬ Planning Module lÃ  bá»™ nÃ£o chiáº¿n thuáº­t. NÃ³ biáº¿n Ã½ Ä‘á»‹nh thÃ nh má»™t káº¿ hoáº¡ch hÃ nh Ä‘á»™ng cá»¥ thá»ƒ, lÃ  cáº§u ná»‘i giá»¯a suy nghÄ© vÃ  thá»±c thi. CÃ¡c agent khÃ´ng cÃ³ Planning Module chá»‰ cÃ³ thá»ƒ thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ má»™t bÆ°á»›c Ä‘Æ¡n giáº£n.

**2.2.3. ThÃ nh pháº§n: Há»‡ thá»‘ng bá»™ nhá»› (Memory System)**

*   **Chá»©c nÄƒng:** Cung cáº¥p cho agent kháº£ nÄƒng ghi nhá»› vÃ  truy xuáº¥t thÃ´ng tin, cho phÃ©p nÃ³ duy trÃ¬ ngá»¯ cáº£nh, há»c há»i tá»« cÃ¡c tÆ°Æ¡ng tÃ¡c trong quÃ¡ khá»©, vÃ  cÃ¡ nhÃ¢n hÃ³a tráº£i nghiá»‡m.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:** Bá»™ nhá»› cá»§a agent Ä‘Æ°á»£c chia thÃ nh hai loáº¡i chÃ­nh:
    *   **Bá»™ nhá»› Ngáº¯n háº¡n (Short-Term / Working Memory):**
        *   **Má»¥c Ä‘Ã­ch:** LÆ°u trá»¯ thÃ´ng tin liÃªn quan Ä‘áº¿n phiÃªn tÆ°Æ¡ng tÃ¡c hiá»‡n táº¡i.
        *   **VÃ­ dá»¥:** Lá»‹ch sá»­ cuá»™c trÃ² chuyá»‡n, cÃ¡c káº¿t quáº£ trung gian tá»« cÃ¡c lá»‡nh gá»i cÃ´ng cá»¥, káº¿ hoáº¡ch hiá»‡n táº¡i.
        *   **CÃ´ng nghá»‡:** ThÆ°á»ng Ä‘Æ°á»£c lÆ°u trá»¯ trong bá»™ nhá»› (in-memory) cá»§a á»©ng dá»¥ng hoáº·c trong cÃ¡c há»‡ thá»‘ng cache nhanh nhÆ° Redis. ÄÃ¢y chÃ­nh lÃ  "context window" Ä‘Æ°á»£c Ä‘Æ°a vÃ o prompt cá»§a LLM trong má»—i lÆ°á»£t tÆ°Æ¡ng tÃ¡c.
    *   **Bá»™ nhá»› DÃ i háº¡n (Long-Term / Knowledge Base):**
        *   **Má»¥c Ä‘Ã­ch:** LÆ°u trá»¯ thÃ´ng tin má»™t cÃ¡ch bá»n vá»¯ng qua nhiá»u phiÃªn, cho phÃ©p agent há»c há»i vÃ  phÃ¡t triá»ƒn theo thá»i gian.
        *   **VÃ­ dá»¥:** Sá»Ÿ thÃ­ch cá»§a ngÆ°á»i dÃ¹ng ("TÃ´i thÃ­ch cÃ¡c chuyáº¿n bay buá»•i sÃ¡ng"), cÃ¡c sá»± kiá»‡n quan trá»ng trong quÃ¡ khá»©, má»™t kho tÃ i liá»‡u kiáº¿n thá»©c lá»›n.
        *   **CÃ´ng nghá»‡:**
            *   **CÆ¡ sá»Ÿ dá»¯ liá»‡u Vector (Vector Database - vd: Pinecone, Chroma):** DÃ¹ng cho **tÃ¬m kiáº¿m ngá»¯ nghÄ©a (semantic search)**. CÃ¡c Ä‘oáº¡n vÄƒn báº£n Ä‘Æ°á»£c chuyá»ƒn thÃ nh cÃ¡c vector sá»‘ há»c. Khi cáº§n truy xuáº¥t, cÃ¢u truy váº¥n cÅ©ng Ä‘Æ°á»£c chuyá»ƒn thÃ nh vector vÃ  há»‡ thá»‘ng sáº½ tÃ¬m cÃ¡c vector gáº§n nháº¥t (tÆ°Æ¡ng Ä‘á»“ng nháº¥t vá» máº·t ngá»¯ nghÄ©a). ÄÃ¢y lÃ  cÃ´ng nghá»‡ ná»n táº£ng cá»§a **Retrieval-Augmented Generation (RAG)**.
            *   **CÆ¡ sá»Ÿ dá»¯ liá»‡u Quan há»‡/NoSQL (Relational/NoSQL DB):** DÃ¹ng Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u cÃ³ cáº¥u trÃºc nhÆ° thÃ´ng tin ngÆ°á»i dÃ¹ng, lá»‹ch sá»­ Ä‘Æ¡n hÃ ng, v.v.
*   **Táº§m quan trá»ng:** Bá»™ nhá»› lÃ  thá»© biáº¿n má»™t chatbot vÃ´ há»“n thÃ nh má»™t trá»£ lÃ½ cÃ¡ nhÃ¢n thá»±c thá»¥. NÃ³ cho phÃ©p agent nhá»› báº¡n lÃ  ai, báº¡n thÃ­ch gÃ¬, vÃ  nhá»¯ng gÃ¬ báº¡n Ä‘Ã£ lÃ m, táº¡o ra má»™t tráº£i nghiá»‡m liá»n máº¡ch vÃ  thÃ´ng minh hÆ¡n nhiá»u.

*(Tiáº¿p tá»¥c cÃ¡c Lá»›p 3 vÃ  4 trong cÃ¡c pháº§n sau...)*


#### 2.3. Lá»›p 3: HÃ nh Ä‘á»™ng (Action Layer)

Náº¿u Lá»›p Nháº­n thá»©c lÃ  tai vÃ  máº¯t, Lá»›p Nháº­n thá»©c lÃ  bá»™ nÃ£o, thÃ¬ Lá»›p HÃ nh Ä‘á»™ng chÃ­nh lÃ  tay vÃ  chÃ¢n cá»§a agent. ÄÃ¢y lÃ  nÆ¡i cÃ¡c quyáº¿t Ä‘á»‹nh vÃ  káº¿ hoáº¡ch Ä‘Æ°á»£c chuyá»ƒn thÃ nh cÃ¡c hÃ nh Ä‘á»™ng cá»¥ thá»ƒ, cÃ³ tÃ¡c Ä‘á»™ng Ä‘áº¿n tháº¿ giá»›i bÃªn ngoÃ i.

**2.3.1. ThÃ nh pháº§n: ThÆ° viá»‡n CÃ´ng cá»¥ & HÃ m (Tool & Function Library)**

*   **Chá»©c nÄƒng:** Cung cáº¥p má»™t bá»™ sÆ°u táº­p cÃ¡c "siÃªu nÄƒng lá»±c" mÃ  agent cÃ³ thá»ƒ sá»­ dá»¥ng. Má»—i cÃ´ng cá»¥ lÃ  má»™t hÃ nh Ä‘á»™ng cá»¥ thá»ƒ mÃ  agent cÃ³ thá»ƒ thá»±c hiá»‡n.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Äá»‹nh nghÄ©a CÃ´ng cá»¥ (Tool Definition):** Má»™t cÃ´ng cá»¥ khÃ´ng chá»‰ lÃ  má»™t hÃ m code. Äá»ƒ LLM cÃ³ thá»ƒ hiá»ƒu vÃ  sá»­ dá»¥ng Ä‘Æ°á»£c, má»™t cÃ´ng cá»¥ pháº£i Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a má»™t cÃ¡ch rÃµ rÃ ng, thÆ°á»ng bao gá»“m:
        *   **TÃªn hÃ m:** Má»™t cÃ¡i tÃªn mang tÃ­nh mÃ´ táº£ cao (vÃ­ dá»¥: `search_flights` thay vÃ¬ `f1`).
        *   **MÃ´ táº£ (Docstring):** Má»™t cÃ¢u giáº£i thÃ­ch rÃµ rÃ ng vá» chá»©c nÄƒng cá»§a cÃ´ng cá»¥ (vÃ­ dá»¥: "TÃ¬m kiáº¿m cÃ¡c chuyáº¿n bay giá»¯a hai thÃ nh phá»‘ vÃ o má»™t ngÃ y cá»¥ thá»ƒ."). ÄÃ¢y lÃ  thÃ´ng tin quan trá»ng nháº¥t mÃ  LLM sáº½ dá»±a vÃ o Ä‘á»ƒ quyáº¿t Ä‘á»‹nh cÃ³ chá»n cÃ´ng cá»¥ nÃ y hay khÃ´ng.
        *   **Äá»‹nh nghÄ©a Tham sá»‘ (Parameter Definition):** CÃ¡c tham sá»‘ Ä‘áº§u vÃ o pháº£i Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a rÃµ rÃ ng vá»›i kiá»ƒu dá»¯ liá»‡u (vÃ­ dá»¥: `origin: str`, `destination: str`, `date: date`). CÃ¡c framework hiá»‡n Ä‘áº¡i thÆ°á»ng sá»­ dá»¥ng Pydantic model Ä‘á»ƒ lÃ m viá»‡c nÃ y.
    *   **CÃ¡c loáº¡i cÃ´ng cá»¥:** ThÆ° viá»‡n cÃ´ng cá»¥ cÃ³ thá»ƒ bao gá»“m:
        *   **CÃ¡c hÃ m Python ná»™i bá»™:** Äá»ƒ thá»±c hiá»‡n cÃ¡c phÃ©p tÃ­nh, xá»­ lÃ½ dá»¯ liá»‡u.
        *   **CÃ¡c lá»‡nh gá»i API bÃªn ngoÃ i:** Äá»ƒ tÆ°Æ¡ng tÃ¡c vá»›i cÃ¡c dá»‹ch vá»¥ cá»§a bÃªn thá»© ba (Google Maps, Stripe, Jira).
        *   **CÃ¡c agent khÃ¡c:** Trong kiáº¿n trÃºc Ä‘a agent, má»™t agent cÃ³ thá»ƒ lÃ  má»™t cÃ´ng cá»¥ cá»§a má»™t agent khÃ¡c.
    *   **Quáº£n lÃ½ vÃ  PhiÃªn báº£n (Versioning & Management):** Khi sá»‘ lÆ°á»£ng cÃ´ng cá»¥ tÄƒng lÃªn, viá»‡c quáº£n lÃ½ chÃºng trá»Ÿ nÃªn quan trá»ng. Cáº§n cÃ³ cÆ¡ cháº¿ Ä‘á»ƒ theo dÃµi phiÃªn báº£n cá»§a cÃ¡c cÃ´ng cá»¥, xá»­ lÃ½ cÃ¡c thay Ä‘á»•i (vÃ­ dá»¥: má»™t API thay Ä‘á»•i tham sá»‘), vÃ  Ä‘áº£m báº£o tÃ­nh tÆ°Æ¡ng thÃ­ch.
*   **Táº§m quan trá»ng:** CÃ´ng cá»¥ lÃ  thá»© mang láº¡i sá»©c máº¡nh thá»±c sá»± cho agent. Má»™t agent khÃ´ng cÃ³ cÃ´ng cá»¥ chá»‰ lÃ  má»™t chatbot. Má»™t agent vá»›i má»™t thÆ° viá»‡n cÃ´ng cá»¥ phong phÃº cÃ³ thá»ƒ trá»Ÿ thÃ nh má»™t nhÃ¢n viÃªn tá»± Ä‘á»™ng hÃ³a máº¡nh máº½.

**2.3.2. ThÃ nh pháº§n: Äá»™ng cÆ¡ thá»±c thi (Execution Engine)**

*   **Chá»©c nÄƒng:** Chá»‹u trÃ¡ch nhiá»‡m gá»i cÃ¡c cÃ´ng cá»¥ Ä‘Ã£ Ä‘Æ°á»£c Lá»›p Nháº­n thá»©c lá»±a chá»n má»™t cÃ¡ch Ä‘Ã¡ng tin cáº­y, xá»­ lÃ½ káº¿t quáº£ tráº£ vá», vÃ  bÃ¡o cÃ¡o láº¡i cho Lá»›p Nháº­n thá»©c.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Gá»i cÃ´ng cá»¥ (Tool Invocation):** Sau khi Planning Module quyáº¿t Ä‘á»‹nh gá»i cÃ´ng cá»¥ `search_flights(origin="Hanoi", destination="Saigon")`, Execution Engine sáº½ thá»±c sá»± thá»±c hiá»‡n lá»‡nh gá»i hÃ m hoáº·c API call nÃ y.
    *   **Xá»­ lÃ½ lá»—i vÃ  Thá»­ láº¡i (Error Handling & Retry Logic):** CÃ¡c lá»‡nh gá»i máº¡ng thÆ°á»ng khÃ´ng Ä‘Ã¡ng tin cáº­y. API cÃ³ thá»ƒ bá»‹ lá»—i, máº¡ng cÃ³ thá»ƒ bá»‹ ngáº¯t. Execution Engine pháº£i Ä‘Æ°á»£c trang bá»‹ cÃ¡c cÆ¡ cháº¿ máº¡nh máº½ Ä‘á»ƒ xá»­ lÃ½ nhá»¯ng tÃ¬nh huá»‘ng nÃ y, vÃ­ dá»¥ nhÆ° **thá»­ láº¡i theo cáº¥p sá»‘ nhÃ¢n (exponential backoff)** - thá»­ láº¡i sau 1s, rá»“i 2s, rá»“i 4s,...
    *   **Quáº£n lÃ½ Timeout vÃ  Song song (Timeout & Concurrency Management):** Má»™t cÃ´ng cá»¥ khÃ´ng nÃªn Ä‘Æ°á»£c phÃ©p cháº¡y vÃ´ thá»i háº¡n. Execution Engine pháº£i Ä‘áº·t ra má»™t khoáº£ng thá»i gian chá» (timeout) vÃ  há»§y bá» cÃ´ng cá»¥ náº¿u nÃ³ khÃ´ng pháº£n há»“i. Trong cÃ¡c há»‡ thá»‘ng nÃ¢ng cao, nÃ³ cÅ©ng cÃ³ thá»ƒ quáº£n lÃ½ viá»‡c thá»±c thi nhiá»u cÃ´ng cá»¥ cÃ¹ng má»™t lÃºc (song song) Ä‘á»ƒ tÄƒng tá»‘c Ä‘á»™.
    *   **PhÃ¢n tÃ­ch vÃ  Chuáº©n hÃ³a Káº¿t quáº£ (Result Parsing & Normalization):** Káº¿t quáº£ tráº£ vá» tá»« má»™t cÃ´ng cá»¥ (vÃ­ dá»¥: má»™t chuá»—i JSON lá»›n tá»« API cá»§a hÃ£ng hÃ ng khÃ´ng) cáº§n Ä‘Æ°á»£c phÃ¢n tÃ­ch, trÃ­ch xuáº¥t thÃ´ng tin quan trá»ng, vÃ  chuyá»ƒn Ä‘á»•i thÃ nh má»™t Ä‘á»‹nh dáº¡ng Ä‘Æ¡n giáº£n Ä‘á»ƒ Lá»›p Nháº­n thá»©c cÃ³ thá»ƒ "tiÃªu hÃ³a" vÃ  sá»­ dá»¥ng cho bÆ°á»›c láº­p káº¿ hoáº¡ch tiáº¿p theo.
*   **Táº§m quan trá»ng:** Execution Engine Ä‘áº£m báº£o ráº±ng cÃ¡c hÃ nh Ä‘á»™ng cá»§a agent Ä‘Æ°á»£c thá»±c hiá»‡n má»™t cÃ¡ch Ä‘Ã¡ng tin cáº­y vÃ  hiá»‡u quáº£. NÃ³ lÃ  cáº§u ná»‘i vá»¯ng cháº¯c giá»¯a tháº¿ giá»›i trá»«u tÆ°á»£ng cá»§a viá»‡c láº­p káº¿ hoáº¡ch vÃ  tháº¿ giá»›i há»—n loáº¡n cá»§a viá»‡c thá»±c thi trong thá»±c táº¿.

#### 2.4. Lá»›p 4: Quáº£n trá»‹ (Governance Layer)

ÄÃ¢y lÃ  lá»›p giÃ¡m sÃ¡t vÃ  kiá»ƒm soÃ¡t, Ä‘áº£m báº£o ráº±ng agent hoáº¡t Ä‘á»™ng trong cÃ¡c giá»›i háº¡n an toÃ n, cÃ³ Ä‘áº¡o Ä‘á»©c, vÃ  cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c. Trong cÃ¡c há»‡ thá»‘ng sáº£n xuáº¥t, Ä‘Ã¢y lÃ  lá»›p quan trá»ng nháº¥t Ä‘á»ƒ xÃ¢y dá»±ng lÃ²ng tin vÃ  trÃ¡nh cÃ¡c háº­u quáº£ khÃ´ng mong muá»‘n.

**2.4.1. ThÃ nh pháº§n: RÃ o cháº¯n & Module an toÃ n (Guardrails & Safety Module)**

*   **Chá»©c nÄƒng:** Hoáº¡t Ä‘á»™ng nhÆ° má»™t "lÆ°Æ¡ng tÃ¢m" vÃ  "bá»™ pháº­n quáº£n lÃ½ rá»§i ro" cá»§a agent, Ã¡p Ä‘áº·t cÃ¡c quy táº¯c vÃ  rÃ ng buá»™c lÃªn hÃ nh vi cá»§a nÃ³.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Lá»c Äáº§u vÃ o/Äáº§u ra (Input/Output Filtering):**
        *   **NgÄƒn cháº·n Prompt Injection:** PhÃ¡t hiá»‡n vÃ  vÃ´ hiá»‡u hÃ³a cÃ¡c ná»— lá»±c cá»§a ngÆ°á»i dÃ¹ng nháº±m ghi Ä‘Ã¨ lÃªn system prompt cá»§a agent.
        *   **Báº£o vá»‡ Dá»¯ liá»‡u CÃ¡ nhÃ¢n (PII Protection):** Tá»± Ä‘á»™ng phÃ¡t hiá»‡n vÃ  che giáº¥u cÃ¡c thÃ´ng tin nháº¡y cáº£m nhÆ° sá»‘ Ä‘iá»‡n thoáº¡i, email, sá»‘ tháº» tÃ­n dá»¥ng trong cáº£ log vÃ  cÃ¡c lá»‡nh gá»i cÃ´ng cá»¥.
        *   **Kiá»ƒm duyá»‡t ná»™i dung Ä‘á»™c háº¡i:** NgÄƒn cháº·n agent táº¡o ra hoáº·c xá»­ lÃ½ cÃ¡c ná»™i dung khÃ´ng phÃ¹ há»£p.
    *   **Kiá»ƒm soÃ¡t Truy cáº­p CÃ´ng cá»¥ (Tool Access Control):** KhÃ´ng pháº£i agent nÃ o cÅ©ng Ä‘Æ°á»£c phÃ©p sá»­ dá»¥ng má»i cÃ´ng cá»¥. Module nÃ y thá»±c thi cÃ¡c quy táº¯c **Kiá»ƒm soÃ¡t Truy cáº­p Dá»±a trÃªn Vai trÃ² (RBAC - Role-Based Access Control)**. VÃ­ dá»¥: chá»‰ cÃ³ "Financial Agent" má»›i Ä‘Æ°á»£c phÃ©p gá»i cÃ´ng cá»¥ `execute_payment`.
    *   **GiÃ¡m sÃ¡t NgÃ¢n sÃ¡ch vÃ  TÃ i nguyÃªn (Budget & Resource Monitoring):** Má»—i lá»‡nh gá»i LLM Ä‘á»u tá»‘n tiá»n. Guardrails sáº½ theo dÃµi tá»•ng chi phÃ­ token vÃ  cÃ³ thá»ƒ dá»«ng agent náº¿u nÃ³ vÆ°á»£t quÃ¡ má»™t ngÃ¢n sÃ¡ch Ä‘Ã£ Ä‘á»‹nh trÆ°á»›c Ä‘á»ƒ trÃ¡nh cÃ¡c hÃ³a Ä‘Æ¡n "trÃªn trá»i".
*   **Táº§m quan trá»ng:** Trong mÃ´i trÆ°á»ng doanh nghiá»‡p, má»™t agent khÃ´ng cÃ³ Guardrails lÃ  má»™t rá»§i ro khÃ´ng thá»ƒ cháº¥p nháº­n. Lá»›p nÃ y Ä‘áº£m báº£o agent hoáº¡t Ä‘á»™ng má»™t cÃ¡ch cÃ³ trÃ¡ch nhiá»‡m, an toÃ n vÃ  tuÃ¢n thá»§ cÃ¡c quy Ä‘á»‹nh.

**2.4.2. ThÃ nh pháº§n: Giao diá»‡n Con ngÆ°á»i trong vÃ²ng láº·p (Human-in-the-Loop - HITL Interface)**

*   **Chá»©c nÄƒng:** Cung cáº¥p má»™t cÆ¡ cháº¿ Ä‘á»ƒ con ngÆ°á»i cÃ³ thá»ƒ giÃ¡m sÃ¡t, can thiá»‡p, vÃ  phÃª duyá»‡t cÃ¡c hÃ nh Ä‘á»™ng cá»§a agent táº¡i cÃ¡c thá»i Ä‘iá»ƒm quan trá»ng.
*   **Chi tiáº¿t hoáº¡t Ä‘á»™ng:**
    *   **Äá»‹nh nghÄ©a Äiá»ƒm dá»«ng (Checkpoint Definition):** ÄÃ¢y lÃ  quyáº¿t Ä‘á»‹nh thiáº¿t káº¿ quan trá»ng: khi nÃ o agent nÃªn dá»«ng láº¡i vÃ  há»i Ã½ kiáº¿n con ngÆ°á»i? CÃ¡c Ä‘iá»ƒm dá»«ng phá»• biáº¿n bao gá»“m:
        *   TrÆ°á»›c khi thá»±c hiá»‡n má»™t hÃ nh Ä‘á»™ng khÃ´ng thá»ƒ Ä‘áº£o ngÆ°á»£c (vÃ­ dá»¥: xÃ³a file, gá»­i tiá»n).
        *   Khi agent cÃ³ Ä‘á»™ tin cáº­y tháº¥p vá» bÆ°á»›c Ä‘i tiáº¿p theo.
        *   Khi chi phÃ­ cá»§a hÃ nh Ä‘á»™ng tiáº¿p theo vÆ°á»£t quÃ¡ má»™t ngÆ°á»¡ng nháº¥t Ä‘á»‹nh.
    *   **Giao diá»‡n NgÆ°á»i dÃ¹ng (UI/UX) cho TÆ°Æ¡ng tÃ¡c:** Cáº§n cÃ³ má»™t giao diá»‡n rÃµ rÃ ng Ä‘á»ƒ con ngÆ°á»i cÃ³ thá»ƒ xem xÃ©t káº¿ hoáº¡ch cá»§a agent, cÃ¡c tham sá»‘ cá»§a cÃ´ng cá»¥ sáº¯p Ä‘Æ°á»£c gá»i, vÃ  sau Ä‘Ã³ Ä‘Æ°a ra quyáº¿t Ä‘á»‹nh: **PhÃª duyá»‡t (Approve)**, **Tá»« chá»‘i (Reject)**, hoáº·c **Chá»‰nh sá»­a (Edit)**.
    *   **CÆ¡ cháº¿ leo thang (Escalation Paths):** Náº¿u agent tháº¥t báº¡i nhiá»u láº§n hoáº·c gáº·p pháº£i má»™t váº¥n Ä‘á» mÃ  nÃ³ khÃ´ng thá»ƒ giáº£i quyáº¿t, há»‡ thá»‘ng HITL pháº£i cÃ³ má»™t quy trÃ¬nh Ä‘á»ƒ "leo thang" váº¥n Ä‘á» Ä‘Ã³ Ä‘áº¿n má»™t chuyÃªn gia con ngÆ°á»i phÃ¹ há»£p.
*   **Táº§m quan trá»ng:** HITL lÃ  cáº§u ná»‘i giá»¯a tá»± Ä‘á»™ng hÃ³a hoÃ n toÃ n vÃ  sá»± kiá»ƒm soÃ¡t cá»§a con ngÆ°á»i. NÃ³ cho phÃ©p cÃ¡c doanh nghiá»‡p táº­n dá»¥ng sá»©c máº¡nh cá»§a agent cho cÃ¡c tÃ¡c vá»¥ rá»§i ro cao, trong khi váº«n Ä‘áº£m báº£o ráº±ng quyáº¿t Ä‘á»‹nh cuá»‘i cÃ¹ng luÃ´n náº±m trong tay con ngÆ°á»i. ÄÃ¢y lÃ  má»™t thÃ nh pháº§n khÃ´ng thá»ƒ thiáº¿u Ä‘á»ƒ triá»ƒn khai agent má»™t cÃ¡ch cÃ³ trÃ¡ch nhiá»‡m trong cÃ¡c á»©ng dá»¥ng thá»±c táº¿.

---

*Káº¿t thÃºc Pháº§n I. ChÃºng ta Ä‘Ã£ hoÃ n thÃ nh viá»‡c phÃ¢n tÃ­ch MECE toÃ n bá»™ cÃ¡c thÃ nh pháº§n cáº¥u táº¡o nÃªn má»™t há»‡ thá»‘ng agent. Vá»›i ná»n táº£ng vá»¯ng cháº¯c nÃ y, trong Pháº§n II, chÃºng ta sáº½ khÃ¡m phÃ¡ cÃ¡c cÃ¡ch khÃ¡c nhau Ä‘á»ƒ láº¯p rÃ¡p cÃ¡c thÃ nh pháº§n nÃ y thÃ nh cÃ¡c loáº¡i kiáº¿n trÃºc agent khÃ¡c nhau Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c bÃ i toÃ¡n thá»±c táº¿.*


## PHáº¦N II: PHÃ‚N LOáº I MECE CÃC KIáº¾N TRÃšC VÃ€ á»¨NG Dá»¤NG AGENT

Sau khi Ä‘Ã£ hiá»ƒu rÃµ cÃ¡c thÃ nh pháº§n cáº¥u táº¡o nÃªn má»™t agent, bÆ°á»›c tiáº¿p theo lÃ  tÃ¬m hiá»ƒu cÃ¡ch láº¯p rÃ¡p chÃºng thÃ nh cÃ¡c **kiáº¿n trÃºc (architectures)** khÃ¡c nhau. KhÃ´ng pháº£i táº¥t cáº£ cÃ¡c agent Ä‘á»u Ä‘Æ°á»£c táº¡o ra nhÆ° nhau. Viá»‡c lá»±a chá»n kiáº¿n trÃºc phÃ¹ há»£p lÃ  má»™t trong nhá»¯ng quyáº¿t Ä‘á»‹nh quan trá»ng nháº¥t, áº£nh hÆ°á»Ÿng trá»±c tiáº¿p Ä‘áº¿n Ä‘á»™ phá»©c táº¡p, chi phÃ­, vÃ  kháº£ nÄƒng cá»§a há»‡ thá»‘ng.

Trong pháº§n nÃ y, chÃºng ta sáº½ giá»›i thiá»‡u má»™t khung phÃ¢n loáº¡i MECE, giÃºp báº¡n Ä‘á»‹nh vá»‹ Ä‘Æ°á»£c bÃ i toÃ¡n cá»§a mÃ¬nh vÃ  lá»±a chá»n kiáº¿n trÃºc agent phÃ¹ há»£p nháº¥t.

### ChÆ°Æ¡ng 3: SÆ¡ Ä‘á»“ PhÃ¢n loáº¡i á»¨ng dá»¥ng Agent

#### 3.1. Hai trá»¥c phÃ¢n loáº¡i: Agency vÃ  Coordination

Dá»±a trÃªn cÃ¡c nghiÃªn cá»©u vÃ  thá»±c tiá»…n tá»« cÃ¡c cÃ´ng ty hÃ ng Ä‘áº§u nhÆ° Google, Anthropic, vÃ  Databricks, chÃºng ta cÃ³ thá»ƒ phÃ¢n loáº¡i háº§u háº¿t má»i á»©ng dá»¥ng agentic theo hai trá»¥c chÃ­nh, trá»±c giao vá»›i nhau:

1.  **Má»©c Ä‘á»™ Tá»± chá»§ (Agency):** Trá»¥c nÃ y Ä‘o lÆ°á»ng má»©c Ä‘á»™ tá»± do ra quyáº¿t Ä‘á»‹nh cá»§a agent. NÃ³ tráº£i dÃ i tá»« **Thá»¥ Ä‘á»™ng/XÃ¡c Ä‘á»‹nh (Deterministic)**, nÆ¡i agent chá»‰ tuÃ¢n theo má»™t ká»‹ch báº£n Ä‘Æ°á»£c láº­p trÃ¬nh sáºµn, Ä‘áº¿n **Tá»± chá»§/HÆ°á»›ng má»¥c tiÃªu (Autonomous/Goal-Oriented)**, nÆ¡i agent cÃ³ thá»ƒ tá»± láº­p káº¿ hoáº¡ch vÃ  thÃ­ch á»©ng Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»™t má»¥c tiÃªu cáº¥p cao.

2.  **Má»©c Ä‘á»™ Phá»‘i há»£p (Coordination):** Trá»¥c nÃ y Ä‘o lÆ°á»ng sá»‘ lÆ°á»£ng agent tham gia vÃ  cÃ¡ch chÃºng tÆ°Æ¡ng tÃ¡c. NÃ³ tráº£i dÃ i tá»« **ÄÆ¡n láº» (Single)**, nÆ¡i chá»‰ cÃ³ má»™t agent hoáº¡t Ä‘á»™ng Ä‘á»™c láº­p, Ä‘áº¿n **Äa agent/Phá»‘i há»£p (Multi-Agent)**, nÆ¡i nhiá»u agent lÃ m viá»‡c cÃ¹ng nhau.

#### 3.2. Ma tráº­n 4 Quadrant

Khi káº¿t há»£p hai trá»¥c nÃ y, chÃºng ta cÃ³ má»™t ma tráº­n 2x2 máº¡nh máº½, táº¡o ra bá»‘n loáº¡i kiáº¿n trÃºc agent cÆ¡ báº£n. Ma tráº­n nÃ y lÃ  má»™t cÃ´ng cá»¥ tÆ° duy cá»±c ká»³ há»¯u Ã­ch Ä‘á»ƒ phÃ¢n tÃ­ch vÃ  thiáº¿t káº¿ há»‡ thá»‘ng.

| | **Tháº¥p Agency** (XÃ¡c Ä‘á»‹nh, HÆ°á»›ng tÃ¡c vá»¥) | **Cao Agency** (Tá»± chá»§, HÆ°á»›ng má»¥c tiÃªu) |
| :--- | :--- | :--- |
| **Tháº¥p Coordination** (ÄÆ¡n agent) | **Quadrant 1: Instruction**<br>_"RPA Ä‘Æ°á»£c tÄƒng cÆ°á»ng LLM"_ | **Quadrant 3: Autonomy**<br>_"NgÆ°á»i giáº£i quyáº¿t váº¥n Ä‘á» Ä‘á»™c láº­p"_ |
| **Cao Coordination** (Äa agent) | **Quadrant 2: Orchestration**<br>_"DÃ¢y chuyá»n láº¯p rÃ¡p thÃ´ng minh"_ | **Quadrant 4: Choreography**<br>_"Äá»™i ngÅ© chuyÃªn gia tá»± quáº£n"_ |

Bá»‘n quadrant nÃ y khÃ´ng chá»‰ lÃ  lÃ½ thuyáº¿t. ChÃºng Ä‘áº¡i diá»‡n cho cÃ¡c máº«u kiáº¿n trÃºc (architectural patterns) phá»• biáº¿n nháº¥t trong thá»±c táº¿. Trong cÃ¡c chÆ°Æ¡ng tiáº¿p theo, chÃºng ta sáº½ Ä‘i sÃ¢u vÃ o tá»«ng quadrant, phÃ¢n tÃ­ch kiáº¿n trÃºc, vÃ­ dá»¥, vÃ  cÃ¡c trÆ°á»ng há»£p nÃªn/khÃ´ng nÃªn sá»­ dá»¥ng.

### ChÆ°Æ¡ng 4: PhÃ¢n tÃ­ch sÃ¢u Quadrant 1: Instruction

ÄÃ¢y lÃ  Ä‘iá»ƒm khá»Ÿi Ä‘áº§u cho háº§u háº¿t cÃ¡c á»©ng dá»¥ng agentic trong doanh nghiá»‡p. NÃ³ Ä‘Æ¡n giáº£n, Ä‘Ã¡ng tin cáº­y, vÃ  mang láº¡i giÃ¡ trá»‹ ngay láº­p tá»©c.

#### 4.1. Kiáº¿n trÃºc vÃ  Luá»“ng hoáº¡t Ä‘á»™ng

Má»™t agent "Instruction" hoáº¡t Ä‘á»™ng giá»‘ng nhÆ° má»™t quy trÃ¬nh Tá»± Ä‘á»™ng hÃ³a Quy trÃ¬nh Robot (RPA) Ä‘Æ°á»£c tÄƒng cÆ°á»ng bá»Ÿi kháº£ nÄƒng hiá»ƒu ngÃ´n ngá»¯ tá»± nhiÃªn cá»§a LLM. Luá»“ng hoáº¡t Ä‘á»™ng cá»§a nÃ³ lÃ  tuyáº¿n tÃ­nh vÃ  cÃ³ thá»ƒ dá»± Ä‘oÃ¡n Ä‘Æ°á»£c.

**SÆ¡ Ä‘á»“ luá»“ng hoáº¡t Ä‘á»™ng (VÃ­ dá»¥: Agent PhÃ¢n loáº¡i Ticket Há»— trá»£):**

![SÆ¡ Ä‘á»“ luá»“ng Agent Ä‘Æ¡n giáº£n](simple_agent_flow.png)

```mermaid
flowchart TD
    Start([External Trigger<br/>Email má»›i, Event...]) --> IP[Input Processor<br/>TrÃ­ch xuáº¥t ná»™i dung]
    
    IP --> Prompt[Fixed Prompt Template<br/>'PhÃ¢n loáº¡i ticket thÃ nh A/B/C<br/>Priority: High/Medium/Low<br/>Return JSON']
    
    Prompt --> LLM[Reasoning Engine<br/>LLM Call - Single Shot]
    
    LLM --> Parse[Parse JSON Output<br/>category, priority]
    
    Parse --> Tool[Execution Engine<br/>Call Single Tool:<br/>tag_support_ticket]
    
    Tool --> API[External API<br/>Jira/Zendesk]
    
    API --> End([End<br/>Ticket Ä‘Æ°á»£c tag])
    
    style Start fill:#e1f5ff
    style End fill:#c8e6c9
    style LLM fill:#fff9c4
    style Tool fill:#ffe0b2
    
    classDef deterministic fill:#f0f0f0,stroke:#333,stroke-width:2px
    class IP,Prompt,Parse deterministic
```

> Agent chá»‰ lÃ m má»™t viá»‡c tuyáº¿n tÃ­nh: nháº­n input, gá»i LLM 1 láº§n Ä‘á»ƒ phÃ¢n loáº¡i, rá»“i gá»i Ä‘Ãºng 1 tool. KhÃ´ng cÃ³ vÃ²ng láº·p, khÃ´ng láº­p káº¿ hoáº¡ch nhiá»u bÆ°á»›c, khÃ´ng nhá»› lá»‹ch sá»­.


*   **Luá»“ng hoáº¡t Ä‘á»™ng:**
    1.  **Äáº§u vÃ o:** Má»™t sá»± kiá»‡n bÃªn ngoÃ i kÃ­ch hoáº¡t agent (vÃ­ dá»¥: email má»›i Ä‘Æ°á»£c gá»­i Ä‘áº¿n hÃ²m thÆ° há»— trá»£).
    2.  **Xá»­ lÃ½:** Input Processor nháº­n email vÃ  trÃ­ch xuáº¥t ná»™i dung.
    3.  **Suy luáº­n:** Reasoning Engine (LLM) Ä‘Æ°á»£c gá»i vá»›i má»™t prompt ráº¥t cá»¥ thá»ƒ: "Dá»±a trÃªn ná»™i dung sau, hÃ£y phÃ¢n loáº¡i ticket thÃ nh má»™t trong cÃ¡c loáº¡i [A, B, C] vÃ  xÃ¡c Ä‘á»‹nh má»©c Ä‘á»™ Æ°u tiÃªn lÃ  [Cao, Trung bÃ¬nh, Tháº¥p]. Tráº£ vá» káº¿t quáº£ dÆ°á»›i dáº¡ng JSON."
    4.  **HÃ nh Ä‘á»™ng:** Execution Engine nháº­n káº¿t quáº£ JSON vÃ  gá»i má»™t cÃ´ng cá»¥ duy nháº¥t, `tag_support_ticket`, vá»›i cÃ¡c tham sá»‘ Ä‘Ã£ Ä‘Æ°á»£c phÃ¢n loáº¡i.
    5.  **Káº¿t thÃºc:** CÃ´ng cá»¥ tÆ°Æ¡ng tÃ¡c vá»›i API cá»§a Jira/Zendesk. Quy trÃ¬nh káº¿t thÃºc.

*   **Äáº·c Ä‘iá»ƒm kiáº¿n trÃºc:**
    *   **Tuyáº¿n tÃ­nh:** KhÃ´ng cÃ³ vÃ²ng láº·p phá»©c táº¡p hay tÃ¡i láº­p káº¿ hoáº¡ch.
    *   **Tráº¡ng thÃ¡i tá»‘i thiá»ƒu:** Agent khÃ´ng cáº§n nhá»› cÃ¡c tÆ°Æ¡ng tÃ¡c trÆ°á»›c Ä‘Ã³.
    *   **CÃ´ng cá»¥ chuyÃªn biá»‡t:** ThÆ°á»ng chá»‰ cÃ³ má»™t hoáº·c má»™t vÃ i cÃ´ng cá»¥ ráº¥t cá»¥ thá»ƒ.
    *   **Prompt Ä‘Æ°á»£c kiá»ƒm soÃ¡t cháº·t cháº½:** System prompt vÃ  user prompt Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ háº¡n cháº¿ tá»‘i Ä‘a sá»± "sÃ¡ng táº¡o" cá»§a LLM.

#### 4.2. VÃ­ dá»¥ thá»±c táº¿

*   **Chatbot Há»i-ÄÃ¡p trÃªn tÃ i liá»‡u (Simple RAG):** NgÆ°á»i dÃ¹ng há»i má»™t cÃ¢u, agent tÃ¬m kiáº¿m trong cÆ¡ sá»Ÿ dá»¯ liá»‡u vector, láº¥y ngá»¯ cáº£nh liÃªn quan, vÃ  káº¿t há»£p vá»›i cÃ¢u há»i Ä‘á»ƒ LLM tráº£ lá»i. ToÃ n bá»™ quy trÃ¬nh lÃ  má»™t chuá»—i cÃ¡c bÆ°á»›c xÃ¡c Ä‘á»‹nh.
*   **TÃ³m táº¯t cuá»™c há»p:** Agent nháº­n báº£n ghi Ã¢m cuá»™c há»p, sá»­ dá»¥ng cÃ´ng cá»¥ Speech-to-Text, sau Ä‘Ã³ gá»­i vÄƒn báº£n cho LLM vá»›i prompt "TÃ³m táº¯t cÃ¡c Ä‘iá»ƒm chÃ­nh vÃ  cÃ¡c má»¥c hÃ nh Ä‘á»™ng."
*   **PhÃ¢n loáº¡i cáº£m xÃºc khÃ¡ch hÃ ng:** Agent Ä‘á»c cÃ¡c bÃ i Ä‘Ã¡nh giÃ¡ sáº£n pháº©m vÃ  gáº¯n tháº» cáº£m xÃºc (TÃ­ch cá»±c, TiÃªu cá»±c, Trung tÃ­nh).

#### 4.3. Khi nÃ o nÃªn sá»­ dá»¥ng vÃ  giá»›i háº¡n

*   **NÃªn sá»­ dá»¥ng khi:**
    *   Quy trÃ¬nh nghiá»‡p vá»¥ rÃµ rÃ ng, cÃ³ tÃ­nh láº·p láº¡i.
    *   YÃªu cáº§u Ä‘á»™ tin cáº­y vÃ  tÃ­nh nháº¥t quÃ¡n cao.
    *   Rá»§i ro tá»« cÃ¡c hÃ nh Ä‘á»™ng sai láº§m lÃ  Ä‘Ã¡ng ká»ƒ, cáº§n sá»± kiá»ƒm soÃ¡t cháº·t cháº½.
    *   Báº¡n má»›i báº¯t Ä‘áº§u vá»›i agent vÃ  muá»‘n cÃ³ má»™t "chiáº¿n tháº¯ng" nhanh chÃ³ng, dá»… dÃ ng.
*   **Giá»›i háº¡n:**
    *   KhÃ´ng thá»ƒ xá»­ lÃ½ cÃ¡c yÃªu cáº§u mÆ¡ há»“ hoáº·c cÃ¡c tÃ¡c vá»¥ Ä‘Ã²i há»i sá»± linh hoáº¡t.
    *   KhÃ´ng thá»ƒ thÃ­ch á»©ng vá»›i cÃ¡c tÃ¬nh huá»‘ng khÃ´ng lÆ°á»ng trÆ°á»›c.
    *   KÃ©m hiá»‡u quáº£ Ä‘á»‘i vá»›i cÃ¡c váº¥n Ä‘á» cáº§n nhiá»u bÆ°á»›c hoáº·c nhiá»u nguá»“n dá»¯ liá»‡u khÃ¡c nhau.

### ChÆ°Æ¡ng 5: PhÃ¢n tÃ­ch sÃ¢u Quadrant 2: Orchestration

Khi má»™t quy trÃ¬nh nghiá»‡p vá»¥ trá»Ÿ nÃªn quÃ¡ phá»©c táº¡p cho má»™t agent Ä‘Æ¡n láº», nhÆ°ng váº«n cÃ³ thá»ƒ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh trÆ°á»›c, chÃºng ta bÆ°á»›c vÃ o Quadrant 2.

#### 5.1. Kiáº¿n trÃºc vÃ  Luá»“ng hoáº¡t Ä‘á»™ng

```mermaid
flowchart TD
    SCHED[Scheduler hoac Trigger] --> ORCH[Orchestrator Workflow Engine]

    ORCH --> A1[Agent Thu thap Du lieu]
    A1 --> DB[He thong DB tai chinh]
    A1 --> ORCH

    ORCH --> A2[Agent Phan tich So lieu]
    A2 --> LIB[Thu vien Phan tich vd Pandas]
    A2 --> ORCH

    ORCH --> A3[Agent Viet Bao cao]
    A3 --> LLM[LLM sinh van ban]
    A3 --> ORCH

    ORCH --> A4[Agent Dinh dang tai lieu]
    A4 --> FORMAT[Tool xuat PDF hoac slide]
    A4 --> ORCH

    ORCH --> OUT[Gui bao cao cho Stakeholder]

```

```mermaid
flowchart TB
    Trigger([Scheduler Trigger<br/>NgÃ y cuá»‘i quÃ½]) --> Orchestrator{Central Orchestrator<br/>Code Ä‘iá»u phá»‘i}
    
    Orchestrator -->|Step 1| Agent1[Agent 1: Thu tháº­p Dá»¯ liá»‡u<br/>Tools: DB Connector]
    Agent1 --> Data1[(Raw Data<br/>Sales + Accounting)]
    
    Data1 --> Orchestrator
    
    Orchestrator -->|Step 2| Agent2[Agent 2: PhÃ¢n tÃ­ch<br/>Tools: Pandas, Calculator]
    Agent2 --> Data2[Computed Metrics<br/>Revenue, Profit, Cost]
    
    Data2 --> Orchestrator
    
    Orchestrator -->|Step 3| Agent3[Agent 3: Viáº¿t BÃ¡o cÃ¡o<br/>Tools: LLM Generator]
    Agent3 --> Report[Summary Text<br/>TÃ¬nh hÃ¬nh kinh doanh]
    
    Report --> Orchestrator
    
    Orchestrator -->|Step 4| Agent4[Agent 4: Äá»‹nh dáº¡ng<br/>Tools: PDF Generator]
    Agent4 --> PDF[Final PDF Report<br/>+ Logo]
    
    PDF --> Orchestrator
    
    Orchestrator -->|Final| Email[Send Email Tool<br/>Gá»­i cho Ban giÃ¡m Ä‘á»‘c]
    
    Email --> End([End])
    
    style Orchestrator fill:#ff9800,stroke:#e65100,stroke-width:3px,color:#fff
    style Agent1 fill:#64b5f6
    style Agent2 fill:#81c784
    style Agent3 fill:#ffb74d
    style Agent4 fill:#ba68c8
    style Email fill:#e57373
```

> Orchestrator (code) Ä‘iá»u phá»‘i láº§n lÆ°á»£t nhiá»u agent chuyÃªn biá»‡t. Má»—i agent lÃ m pháº§n viá»‡c cá»§a mÃ¬nh rá»“i tráº£ káº¿t quáº£ vá». Luá»“ng cÃ´ng viá»‡c cá»‘ Ä‘á»‹nh, Ã­t hoáº·c khÃ´ng cÃ³ tá»± chá»§ á»Ÿ tá»«ng agent.


Kiáº¿n trÃºc "Orchestration" giá»‘ng nhÆ° má»™t dÃ¢y chuyá»n láº¯p rÃ¡p thÃ´ng minh, nÆ¡i má»—i "tráº¡m" lÃ  má»™t agent chuyÃªn biá»‡t (hoáº·c má»™t LLM call). Má»™t "nhÃ  Ä‘iá»u phá»‘i" (Orchestrator), thÆ°á»ng lÃ  code cá»©ng chá»© khÃ´ng pháº£i LLM, sáº½ Ä‘iá»u hÆ°á»›ng cÃ´ng viá»‡c qua cÃ¡c tráº¡m theo má»™t luá»“ng Ä‘Ã£ Ä‘á»‹nh.

*   **Luá»“ng hoáº¡t Ä‘á»™ng (VÃ­ dá»¥: Quy trÃ¬nh táº¡o bÃ¡o cÃ¡o tÃ i chÃ­nh hÃ ng quÃ½):**
    1.  **KÃ­ch hoáº¡t:** ÄÃºng ngÃ y cuá»‘i cÃ¹ng cá»§a quÃ½, má»™t bá»™ láº­p lá»‹ch (scheduler) kÃ­ch hoáº¡t quy trÃ¬nh.
    2.  **Tráº¡m 1 (Agent Thu tháº­p Dá»¯ liá»‡u):** Orchestrator gá»i agent nÃ y. NÃ³ cÃ³ cÃ´ng cá»¥ Ä‘á»ƒ káº¿t ná»‘i vÃ o cÆ¡ sá»Ÿ dá»¯ liá»‡u bÃ¡n hÃ ng vÃ  káº¿ toÃ¡n, trÃ­ch xuáº¥t dá»¯ liá»‡u thÃ´.
    3.  **Tráº¡m 2 (Agent PhÃ¢n tÃ­ch):** Orchestrator nháº­n dá»¯ liá»‡u thÃ´ vÃ  chuyá»ƒn cho agent nÃ y. NÃ³ sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ phÃ¢n tÃ­ch (vd: thÆ° viá»‡n Pandas) Ä‘á»ƒ tÃ­nh toÃ¡n cÃ¡c chá»‰ sá»‘ quan trá»ng (doanh thu, lá»£i nhuáº­n, chi phÃ­).
    4.  **Tráº¡m 3 (Agent Viáº¿t BÃ¡o cÃ¡o):** Orchestrator nháº­n cÃ¡c chá»‰ sá»‘ vÃ  chuyá»ƒn cho agent nÃ y. NÃ³ sá»­ dá»¥ng LLM vá»›i prompt "Viáº¿t má»™t báº£n tÃ³m táº¯t tÃ¬nh hÃ¬nh kinh doanh dá»±a trÃªn cÃ¡c sá»‘ liá»‡u sau."
    5.  **Tráº¡m 4 (Agent Äá»‹nh dáº¡ng):** Orchestrator nháº­n báº£n tÃ³m táº¯t vÃ  chuyá»ƒn cho agent nÃ y Ä‘á»ƒ Ä‘á»‹nh dáº¡ng thÃ nh file PDF vá»›i logo cÃ´ng ty.
    6.  **Káº¿t thÃºc:** Orchestrator gá»­i email file PDF cho ban giÃ¡m Ä‘á»‘c.

*   **Äáº·c Ä‘iá»ƒm kiáº¿n trÃºc:**
    *   **Dá»±a trÃªn quy trÃ¬nh (Process-driven):** Trá»ng tÃ¢m lÃ  luá»“ng cÃ´ng viá»‡c, khÃ´ng pháº£i má»™t agent Ä‘Æ¡n láº».
    *   **ChuyÃªn mÃ´n hÃ³a:** Má»—i agent/tráº¡m cÃ³ má»™t bá»™ cÃ´ng cá»¥ vÃ  trÃ¡ch nhiá»‡m riÃªng biá»‡t.
    *   **Äiá»u phá»‘i táº­p trung:** Orchestrator (code) kiá»ƒm soÃ¡t hoÃ n toÃ n luá»“ng Ä‘i cá»§a dá»¯ liá»‡u.
    *   **Agency tháº¥p:** CÃ¡c agent riÃªng láº» váº«n chá»‰ thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ Ä‘Æ°á»£c giao, khÃ´ng tá»± ra quyáº¿t Ä‘á»‹nh.

#### 5.2. VÃ­ dá»¥ thá»±c táº¿

*   **Quy trÃ¬nh tuyá»ƒn dá»¥ng tá»± Ä‘á»™ng:** Má»™t agent quÃ©t há»“ sÆ¡ á»©ng viÃªn, má»™t agent khÃ¡c lÃªn lá»‹ch phá»ng váº¥n, má»™t agent thá»© ba gá»­i email xÃ¡c nháº­n.
*   **Tá»± Ä‘á»™ng hÃ³a Marketing:** Má»™t agent theo dÃµi cÃ¡c Ä‘á» cáº­p trÃªn máº¡ng xÃ£ há»™i, má»™t agent khÃ¡c táº¡o ná»™i dung tráº£ lá»i, vÃ  má»™t agent thá»© ba Ä‘Äƒng bÃ i.

#### 5.3. So sÃ¡nh vá»›i microservices truyá»n thá»‘ng

Kiáº¿n trÃºc Orchestration ráº¥t giá»‘ng vá»›i kiáº¿n trÃºc Microservices. Má»—i agent chuyÃªn biá»‡t cÃ³ thá»ƒ Ä‘Æ°á»£c xem nhÆ° má»™t microservice. Äiá»ƒm khÃ¡c biá»‡t chÃ­nh lÃ  cÃ¡c "microservice" nÃ y Ä‘Æ°á»£c tÄƒng cÆ°á»ng bá»Ÿi LLM, cho phÃ©p chÃºng xá»­ lÃ½ cÃ¡c Ä‘áº§u vÃ o/Ä‘áº§u ra báº±ng ngÃ´n ngá»¯ tá»± nhiÃªn vÃ  thá»±c hiá»‡n cÃ¡c tÃ¡c vá»¥ suy luáº­n mÃ  microservice truyá»n thá»‘ng khÃ´ng thá»ƒ.

### ChÆ°Æ¡ng 6: PhÃ¢n tÃ­ch sÃ¢u Quadrant 3: Autonomy

ÄÃ¢y lÃ  nÆ¡i sá»± "thÃ´ng minh" thá»±c sá»± cá»§a agent báº¯t Ä‘áº§u tá»a sÃ¡ng. Thay vÃ¬ chá»‰ lÃ m theo ká»‹ch báº£n, agent Ä‘Æ°á»£c trao quyá»n tá»± chá»§ Ä‘á»ƒ Ä‘áº¡t Ä‘Æ°á»£c má»¥c tiÃªu.

#### 6.1. Kiáº¿n trÃºc vÃ  Luá»“ng hoáº¡t Ä‘á»™ng

```mermaid
flowchart TD
    U[User Goal muc tieu cap cao] --> A[Autonomous Agent]

    subgraph LOOP[Reason Act Observe Loop]
        A --> S[Agent State muc tieu va context]

        S --> R[Reason Step LLM suy luan]
        R --> DEC{Can goi tool?}

        DEC --> PLAN[No tool Can Tra loi hoac lap ke hoach cuoi]
        DEC --> CALL[Yes tool Call]

        CALL --> T[Tool Execution Layer]
        T --> T1[Domain Tools API DB FS]
        T --> T2[Knowledge Tools search RAG]
        T1 --> OBS[Observe ket qua]
        T2 --> OBS

        OBS --> S
    end

    PLAN --> OUT[Final Plan hoac Answer]
    OUT --> U

```

```mermaid
flowchart TD
    Goal([User Goal<br/>'Plan chuyáº¿n Ä‘i ÄÃ  Láº¡t<br/>cuá»‘i tuáº§n, focus cÃ  phÃª'])
    
    Goal --> State[Agent State<br/>Messages + Context]
    
    State --> Loop{ReAct Loop}
    
    Loop --> Reason1[ğŸ§  REASON #1<br/>'Cáº§n biáº¿t ngÃ y Ä‘i/vá»<br/>â†’ Há»i user']
    Reason1 --> Act1[ğŸ’¬ ACT: Ask User<br/>'Báº¡n muá»‘n Ä‘i cuá»‘i tuáº§n nÃ o?']
    Act1 --> Observe1[ğŸ‘ OBSERVE<br/>User reply: '20-22/12']
    
    Observe1 --> UpdateState1[Update State<br/>+ date info]
    UpdateState1 --> Loop
    
    Loop --> Reason2[ğŸ§  REASON #2<br/>'ÄÃ£ cÃ³ ngÃ y<br/>â†’ Cáº§n tÃ¬m chuyáº¿n bay']
    Reason2 --> Act2[ğŸ”§ ACT: Tool Call<br/>search_flights]
    Act2 --> Tool1[Flight Search API]
    Tool1 --> Observe2[ğŸ‘ OBSERVE<br/>List flights returned]
    
    Observe2 --> UpdateState2[Update State<br/>+ flight options]
    UpdateState2 --> Loop
    
    Loop --> Reason3[ğŸ§  REASON #3<br/>'ÄÃ£ cÃ³ bay<br/>â†’ TÃ¬m quÃ¡n cÃ  phÃª']
    Reason3 --> Act3[ğŸ”§ ACT: Tool Call<br/>search_POI type=cafe]
    Act3 --> Tool2[POI Search API]
    Tool2 --> Observe3[ğŸ‘ OBSERVE<br/>Cafe list returned]
    
    Observe3 --> UpdateState3[Update State<br/>+ cafe list]
    UpdateState3 --> Loop
    
    Loop --> ReasonN[ğŸ§  REASON #N<br/>'Äá»§ thÃ´ng tin<br/>â†’ Táº¡o lá»‹ch trÃ¬nh']
    ReasonN --> Final[ğŸ“‹ Final Output<br/>Complete Itinerary]
    
    Final --> End([End])
    
    style Loop fill:#ff5722,stroke:#bf360c,stroke-width:3px,color:#fff
    style Reason1 fill:#fff9c4
    style Reason2 fill:#fff9c4
    style Reason3 fill:#fff9c4
    style ReasonN fill:#fff9c4
    style Act1 fill:#e1bee7
    style Act2 fill:#e1bee7
    style Act3 fill:#e1bee7
    style Observe1 fill:#c5e1a5
    style Observe2 fill:#c5e1a5
    style Observe3 fill:#c5e1a5
    
    style State fill:#ffccbc,stroke:#d84315,stroke-width:2px
    style UpdateState1 fill:#ffccbc,stroke:#d84315,stroke-width:2px
    style UpdateState2 fill:#ffccbc,stroke:#d84315,stroke-width:2px
    style UpdateState3 fill:#ffccbc,stroke:#d84315,stroke-width:2px
```

> Má»™t agent duy nháº¥t láº·p vÃ²ng ReAct: Reason â†’ Act (tool) â†’ Observe â†’ Reasonâ€¦ cho Ä‘áº¿n khi Ä‘áº¡t má»¥c tiÃªu. NÃ³ tá»± quyáº¿t Ä‘á»‹nh cáº§n tool nÃ o, bao nhiÃªu bÆ°á»›c, káº¿ hoáº¡ch tháº¿ nÃ o.

Agent "Autonomy" hoáº¡t Ä‘á»™ng theo má»™t vÃ²ng láº·p liÃªn tá»¥c, ná»•i tiáº¿ng nháº¥t lÃ  máº«u **ReAct (Reason + Act)**. NÃ³ khÃ´ng Ä‘i theo má»™t Ä‘Æ°á»ng tháº³ng mÃ  lÃ  má»™t chu trÃ¬nh khÃ¡m phÃ¡ vÃ  Ä‘iá»u chá»‰nh.

*   **Luá»“ng hoáº¡t Ä‘á»™ng (VÃ­ dá»¥: Agent Láº­p káº¿ hoáº¡ch Du lá»‹ch):**
    1.  **Má»¥c tiÃªu:** NgÆ°á»i dÃ¹ng Ä‘Æ°a ra má»™t má»¥c tiÃªu cáº¥p cao: "TÃ¬m cho tÃ´i má»™t chuyáº¿n Ä‘i cuá»‘i tuáº§n Ä‘áº¿n ÄÃ  Láº¡t, táº­p trung vÃ o cÃ  phÃª vÃ  thiÃªn nhiÃªn."
    2.  **VÃ²ng láº·p 1:**
        *   **Reason (Suy luáº­n):** LLM nghÄ©: "Äá»ƒ lÃªn káº¿ hoáº¡ch, trÆ°á»›c háº¿t tÃ´i cáº§n biáº¿t ngÃ y Ä‘i vÃ  ngÃ y vá». TÃ´i sáº½ há»i ngÆ°á»i dÃ¹ng."
        *   **Act (HÃ nh Ä‘á»™ng):** Agent khÃ´ng cÃ³ cÃ´ng cá»¥ Ä‘á»ƒ há»i, nÃ³ chá»‰ tráº£ lá»i ngÆ°á»i dÃ¹ng: "Tuyá»‡t vá»i! Báº¡n muá»‘n Ä‘i vÃ o cuá»‘i tuáº§n nÃ o?"
    3.  **VÃ²ng láº·p 2 (Sau khi ngÆ°á»i dÃ¹ng tráº£ lá»i):**
        *   **Reason:** "OK, Ä‘Ã£ cÃ³ ngÃ y. Giá» tÃ´i cáº§n tÃ¬m chuyáº¿n bay. TÃ´i sáº½ dÃ¹ng cÃ´ng cá»¥ `search_flights`."
        *   **Act:** Execution Engine gá»i `search_flights(origin="SGN", destination="DLI", date="...")`.
        *   **Observe (Quan sÃ¡t):** CÃ´ng cá»¥ tráº£ vá» má»™t danh sÃ¡ch cÃ¡c chuyáº¿n bay.
    4.  **VÃ²ng láº·p 3:**
        *   **Reason:** "ÄÃ£ cÃ³ chuyáº¿n bay. Giá» tÃ´i cáº§n tÃ¬m cÃ¡c quÃ¡n cÃ  phÃª Ä‘áº¹p. TÃ´i sáº½ dÃ¹ng cÃ´ng cá»¥ `search_points_of_interest`."
        *   **Act:** Execution Engine gá»i `search_points_of_interest(location="Dalat", type="cafe")`.
        *   **Observe:** CÃ´ng cá»¥ tráº£ vá» má»™t danh sÃ¡ch cÃ¡c quÃ¡n cÃ  phÃª.
    5.  **...VÃ²ng láº·p tiáº¿p tá»¥c...** cho Ä‘áº¿n khi agent thu tháº­p Ä‘á»§ thÃ´ng tin vÃ  táº¡o ra má»™t lá»‹ch trÃ¬nh hoÃ n chá»‰nh.

*   **Äáº·c Ä‘iá»ƒm kiáº¿n trÃºc:**
    *   **HÆ°á»›ng má»¥c tiÃªu (Goal-oriented):** Agent chá»‰ cáº§n biáº¿t Ä‘Ã­ch Ä‘áº¿n, khÃ´ng cáº§n biáº¿t Ä‘Æ°á»ng Ä‘i.
    *   **VÃ²ng láº·p suy luáº­n:** Cá»‘t lÃµi lÃ  chu trÃ¬nh Reason-Act-Observe.
    *   **Lá»±a chá»n cÃ´ng cá»¥ Ä‘á»™ng:** Agent tá»± quyáº¿t Ä‘á»‹nh dÃ¹ng cÃ´ng cá»¥ nÃ o vÃ  khi nÃ o.
    *   **Quáº£n lÃ½ tráº¡ng thÃ¡i:** Agent pháº£i cÃ³ bá»™ nhá»› (ngáº¯n háº¡n) Ä‘á»ƒ lÆ°u trá»¯ káº¿t quáº£ cá»§a cÃ¡c bÆ°á»›c trÆ°á»›c Ä‘Ã³.

#### 6.2. VÃ­ dá»¥ thá»±c táº¿

*   **Agent NghiÃªn cá»©u:** NgÆ°á»i dÃ¹ng yÃªu cáº§u "Viáº¿t má»™t bÃ¡o cÃ¡o vá» thá»‹ trÆ°á»ng xe Ä‘iá»‡n táº¡i Viá»‡t Nam." Agent sáº½ tá»± tÃ¬m kiáº¿m Google, Ä‘á»c cÃ¡c bÃ i bÃ¡o, tá»•ng há»£p thÃ´ng tin, vÃ  viáº¿t bÃ¡o cÃ¡o.
*   **Agent Gá»¡ lá»—i Code:** Láº­p trÃ¬nh viÃªn Ä‘Æ°a ra má»™t Ä‘oáº¡n code lá»—i. Agent sáº½ tá»± Ä‘á»c lá»—i, Ä‘á» xuáº¥t cÃ¡c giáº£ thuyáº¿t, Ã¡p dá»¥ng cÃ¡c thay Ä‘á»•i, cháº¡y láº¡i code, vÃ  láº·p láº¡i cho Ä‘áº¿n khi sá»­a Ä‘Æ°á»£c lá»—i.

#### 6.3. ThÃ¡ch thá»©c: Sai sá»‘à¸—à¸šà¸§à¸ vÃ  Kiá»ƒm soÃ¡t

Sá»± tá»± do cá»§a agent tá»± chá»§ cÅ©ng lÃ  con dao hai lÆ°á»¡i. Má»™t sai láº§m nhá» á»Ÿ bÆ°á»›c Ä‘áº§u (vÃ­ dá»¥: hiá»ƒu sai má»™t káº¿t quáº£ tÃ¬m kiáº¿m) cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c quyáº¿t Ä‘á»‹nh sai láº§m á»Ÿ cÃ¡c bÆ°á»›c sau, táº¡o ra má»™t **sai sá»‘à¸—à¸šà¸§à¸ (compounding error)**. HÆ¡n ná»¯a, viá»‡c Ä‘á»ƒ agent tá»± do hÃ nh Ä‘á»™ng cÃ³ thá»ƒ dáº«n Ä‘áº¿n cÃ¡c káº¿t quáº£ khÃ´ng mong muá»‘n hoáº·c chi phÃ­ API tÄƒng vá»t. Do Ä‘Ã³, cÃ¡c agent nÃ y Ä‘Ã²i há»i pháº£i cÃ³ **sandboxing** (cháº¡y trong mÃ´i trÆ°á»ng bá»‹ cÃ´ láº­p) vÃ  cÃ¡c **Guardrails** (Lá»›p Quáº£n trá»‹) cá»±c ká»³ máº¡nh máº½.

### ChÆ°Æ¡ng 7: PhÃ¢n tÃ­ch sÃ¢u Quadrant 4: Choreography

ÄÃ¢y lÃ  biÃªn giá»›i cá»§a cÃ´ng nghá»‡ agentic, nÆ¡i cÃ¡c há»‡ thá»‘ng phá»©c táº¡p nháº¥t Ä‘Æ°á»£c xÃ¢y dá»±ng báº±ng cÃ¡ch cho nhiá»u agent tá»± chá»§ há»£p tÃ¡c vá»›i nhau.

#### 7.1. Kiáº¿n trÃºc vÃ  Luá»“ng hoáº¡t Ä‘á»™ng

Kiáº¿n trÃºc "Choreography" khÃ´ng cÃ³ má»™t nhÃ  Ä‘iá»u phá»‘i trung tÃ¢m. Thay vÃ o Ä‘Ã³, nÃ³ giá»‘ng nhÆ° má»™t Ä‘á»™i ngÅ© chuyÃªn gia, má»—i ngÆ°á»i cÃ³ chuyÃªn mÃ´n riÃªng, tá»± giao tiáº¿p vÃ  phá»‘i há»£p vá»›i nhau Ä‘á»ƒ giáº£i quyáº¿t má»™t váº¥n Ä‘á» lá»›n. HÃ nh vi cá»§a toÃ n bá»™ há»‡ thá»‘ng lÃ  **ná»•i hiá»‡n (emergent)** tá»« sá»± tÆ°Æ¡ng tÃ¡c cá»§a cÃ¡c cÃ¡ nhÃ¢n.

**SÆ¡ Ä‘á»“ luá»“ng hoáº¡t Ä‘á»™ng (VÃ­ dá»¥: Äá»™i Agent NghiÃªn cá»©u Thá»‹ trÆ°á»ng):**

```mermaid
flowchart TD
    PM[Product Manager hoac Business Owner] --> LEAD[Chief Agent Truong nhom]

    LEAD --> D1[Define Global Goal]
    D1 --> SPLIT[Phan ra cac nhiem vu con]

    SPLIT --> R1[Research Agent Thi truong]
    SPLIT --> R2[Finance Agent Von va doanh thu]
    SPLIT --> R3[Social Agent Cam xuc nguoi dung]

    R1 --> WEB[Web Search Tools va RAG]
    R2 --> FINAPI[API tai chinh vd Crunchbase]
    R3 --> SOCAPI[API mang xa hoi]

    WEB --> R1R[Report Market Findings]
    FINAPI --> R2R[Report Funding and Numbers]
    SOCAPI --> R3R[Report Sentiment Insights]

    R1R --> LEAD
    R2R --> LEAD
    R3R --> LEAD

    LEAD --> SYN[Summarize and Synthesize to Final Report]
    SYN --> PM

```

```mermaid
flowchart TB
    Goal([PM: Research Goal]) --> Chief[Chief Agent<br/>ğŸ“‹ Plan & Coordinate]
    
    Chief -.->|Assign| A1
    Chief -.->|Assign| A2
    Chief -.->|Assign| A3
    
    subgraph Agents[Autonomous Agents - Parallel Execution]
        A1[ğŸ“Š Data Agent<br/>Loop: Reason-Act-Observe<br/>Tools: Search, Parse]
        A2[ğŸ’° Finance Agent<br/>Loop: Reason-Act-Observe<br/>Tools: APIs, DB]
        A3[ğŸ“± Social Agent<br/>Loop: Reason-Act-Observe<br/>Tools: Social APIs]
    end
    
    %% Peer-to-peer
    A1 <-.->|P2P Communication| A2
    A2 <-.->|P2P Communication| A3
    A1 <-.->|P2P Communication| A3
    
    %% Results back
    A1 -->|Result| Chief
    A2 -->|Result| Chief
    A3 -->|Result| Chief
    
    %% Chief can request more
    Chief -.->|Request Details| A1
    Chief -.->|Clarify| A2
    
    Chief --> Synthesize[Synthesize & Report]
    Synthesize --> Final([Final Output])
    
    style Chief fill:#ff6f00,color:#fff,stroke:#e65100,stroke-width:3px
    style A1 fill:#2196f3,color:#fff
    style A2 fill:#4caf50,color:#fff
    style A3 fill:#9c27b0,color:#fff
    style Agents fill:#f5f5f5,stroke:#9e9e9e,stroke-width:2px,stroke-dasharray: 5 5
    
    linkStyle 0,1,2 stroke:#757575,stroke-width:1px,stroke-dasharray: 3 3
    linkStyle 3,4,5 stroke:#f44336,stroke-width:2px,stroke-dasharray: 5 5
    linkStyle 9,10 stroke:#2196f3,stroke-width:1px,stroke-dasharray: 3 3
```

![SÆ¡ Ä‘á»“ luá»“ng Agent phá»©c táº¡p](complex_agent_flow.png)

*   **Luá»“ng hoáº¡t Ä‘á»™ng:**
    1.  **Má»¥c tiÃªu:** Má»™t Product Manager Ä‘Æ°a ra yÃªu cáº§u cho **Agent TrÆ°á»Ÿng nhÃ³m (Chief Researcher)**: "PhÃ¢n tÃ­ch thá»‹ trÆ°á»ng protein thá»±c váº­t á»Ÿ ÄÃ´ng Nam Ã."
    2.  **PhÃ¢n rÃ£ & Giao viá»‡c:** Agent TrÆ°á»Ÿng nhÃ³m khÃ´ng tá»± lÃ m. NÃ³ phÃ¢n rÃ£ má»¥c tiÃªu thÃ nh cÃ¡c nhiá»‡m vá»¥ con vÃ  giao cho cÃ¡c agent chuyÃªn biá»‡t:
        *   Giao cho **Agent PhÃ¢n tÃ­ch Dá»¯ liá»‡u**: "TÃ¬m cÃ¡c bÃ i bÃ¡o, tin tá»©c, vÃ  bÃ¡o cÃ¡o thá»‹ trÆ°á»ng."
        *   Giao cho **Agent PhÃ¢n tÃ­ch TÃ i chÃ­nh**: "TÃ¬m thÃ´ng tin vá» cÃ¡c vÃ²ng gá»i vá»‘n cá»§a cÃ¡c cÃ´ng ty chá»§ chá»‘t."
        *   Giao cho **Agent PhÃ¢n tÃ­ch Máº¡ng xÃ£ há»™i**: "PhÃ¢n tÃ­ch cáº£m xÃºc cá»§a ngÆ°á»i tiÃªu dÃ¹ng trÃªn Twitter vÃ  Reddit."
    3.  **Thá»±c thi song song:** Cáº£ ba agent chuyÃªn biá»‡t báº¯t Ä‘áº§u lÃ m viá»‡c cÃ¹ng má»™t lÃºc, sá»­ dá»¥ng cÃ¡c cÃ´ng cá»¥ riÃªng cá»§a chÃºng (Web Search, Crunchbase API, Social Media API).
    4.  **Tá»•ng há»£p:** Khi cÃ¡c agent chuyÃªn biá»‡t hoÃ n thÃ nh, chÃºng gá»­i káº¿t quáº£ trá»Ÿ láº¡i cho Agent TrÆ°á»Ÿng nhÃ³m.
    5.  **HoÃ n thÃ nh:** Agent TrÆ°á»Ÿng nhÃ³m nháº­n táº¥t cáº£ cÃ¡c máº£nh thÃ´ng tin, Ä‘á»c, hiá»ƒu, vÃ  viáº¿t thÃ nh má»™t bÃ¡o cÃ¡o tá»•ng há»£p duy nháº¥t, máº¡ch láº¡c.

*   **Äáº·c Ä‘iá»ƒm kiáº¿n trÃºc:**
    *   **PhÃ¢n tÃ¡n:** KhÃ´ng cÃ³ Ä‘iá»ƒm kiá»ƒm soÃ¡t trung tÃ¢m duy nháº¥t.
    *   **ChuyÃªn mÃ´n hÃ³a cao:** Má»—i agent lÃ  má»™t chuyÃªn gia trong lÄ©nh vá»±c cá»§a mÃ¬nh.
    *   **Giao tiáº¿p ngang hÃ ng:** CÃ¡c agent cÃ³ thá»ƒ giao tiáº¿p trá»±c tiáº¿p vá»›i nhau (vÃ­ dá»¥: Agent PhÃ¢n tÃ­ch Dá»¯ liá»‡u cÃ³ thá»ƒ há»i Agent PhÃ¢n tÃ­ch TÃ i chÃ­nh vá» má»™t cÃ´ng ty mÃ  nÃ³ tÃ¬m tháº¥y).
    *   **HÃ nh vi ná»•i hiá»‡n:** Káº¿t quáº£ cuá»‘i cÃ¹ng lÃ  sáº£n pháº©m cá»§a sá»± há»£p tÃ¡c, khÃ´ng pháº£i lÃ  má»™t ká»‹ch báº£n Ä‘Æ°á»£c Ä‘á»‹nh trÆ°á»›c.

#### 7.2. VÃ­ dá»¥ thá»±c táº¿

*   **Tá»‘i Æ°u hÃ³a chuá»—i cung á»©ng (Uber/Grab):** Má»™t agent Ä‘áº¡i diá»‡n cho má»—i tÃ i xáº¿, má»™t agent Ä‘áº¡i diá»‡n cho má»—i hÃ nh khÃ¡ch. CÃ¡c agent nÃ y liÃªn tá»¥c giao tiáº¿p Ä‘á»ƒ tÃ¬m ra sá»± káº¿t há»£p tá»‘i Æ°u nháº¥t giá»¯a cung vÃ  cáº§u trong thá»i gian thá»±c.
*   **MÃ´ phá»ng thá»‹ trÆ°á»ng tÃ i chÃ­nh:** Má»—i agent Ä‘Ã³ng vai má»™t nhÃ  Ä‘áº§u tÆ° vá»›i má»™t chiáº¿n lÆ°á»£c riÃªng. Há»‡ thá»‘ng cháº¡y mÃ´ phá»ng Ä‘á»ƒ xem cÃ¡c chiáº¿n lÆ°á»£c nÃ y tÆ°Æ¡ng tÃ¡c vá»›i nhau nhÆ° tháº¿ nÃ o vÃ  tÃ¡c Ä‘á»™ng Ä‘áº¿n thá»‹ trÆ°á»ng ra sao.
*   **PhÃ¡t triá»ƒn pháº§n má»m tá»± Ä‘á»™ng:** Má»™t agent "Product Manager" viáº¿t yÃªu cáº§u, má»™t agent "Developer" viáº¿t code, má»™t agent "QA" viáº¿t vÃ  cháº¡y test. ChÃºng lÃ m viá»‡c cÃ¹ng nhau trong má»™t vÃ²ng láº·p Ä‘á»ƒ táº¡o ra pháº§n má»m.

#### 7.3. ThÃ¡ch thá»©c: Phá»©c táº¡p á»Ÿ quy mÃ´ lá»›n

Kiáº¿n trÃºc Choreography cá»±c ká»³ máº¡nh máº½ nhÆ°ng cÅ©ng vÃ´ cÃ¹ng phá»©c táº¡p Ä‘á»ƒ thiáº¿t káº¿ vÃ  gá»¡ lá»—i. CÃ¡c thÃ¡ch thá»©c chÃ­nh bao gá»“m:

*   **Giao tiáº¿p:** LÃ m tháº¿ nÃ o Ä‘á»ƒ cÃ¡c agent giao tiáº¿p hiá»‡u quáº£ vÃ  khÃ´ng bá»‹ "nhiá»…u" thÃ´ng tin?
*   **Giáº£i quyáº¿t xung Ä‘á»™t:** Äiá»u gÃ¬ xáº£y ra khi hai agent cÃ³ Ã½ kiáº¿n trÃ¡i ngÆ°á»£c nhau?
*   **Ghi nháº­n cÃ´ng lao (Credit Assignment):** Khi há»‡ thá»‘ng thÃ nh cÃ´ng, lÃ m tháº¿ nÃ o Ä‘á»ƒ biáº¿t agent nÃ o Ä‘Ã£ Ä‘Ã³ng gÃ³p nhiá»u nháº¥t?
*   **Kháº£ nÄƒng quan sÃ¡t:** Viá»‡c theo dÃµi vÃ  hiá»ƒu Ä‘Æ°á»£c luá»“ng suy nghÄ© cá»§a má»™t há»‡ thá»‘ng phÃ¢n tÃ¡n nhÆ° váº­y lÃ  má»™t bÃ i toÃ¡n cá»±c ká»³ khÃ³.

Do Ä‘Ã³, kiáº¿n trÃºc nÃ y hiá»‡n chá»§ yáº¿u Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c mÃ´i trÆ°á»ng nghiÃªn cá»©u hoáº·c cÃ¡c á»©ng dá»¥ng ráº¥t chuyÃªn biá»‡t, cÃ³ giÃ¡ trá»‹ cá»±c cao cá»§a cÃ¡c cÃ´ng ty cÃ´ng nghá»‡ lá»›n.

---

*Káº¿t thÃºc Pháº§n II. ChÃºng ta Ä‘Ã£ khÃ¡m phÃ¡ bá»‘n loáº¡i kiáº¿n trÃºc agent chÃ­nh. Giá» Ä‘Ã¢y, báº¡n Ä‘Ã£ cÃ³ má»™t "la bÃ n" Ä‘á»ƒ Ä‘á»‹nh vá»‹ cÃ¡c loáº¡i bÃ i toÃ¡n khÃ¡c nhau. Trong Pháº§n III, chÃºng ta sáº½ báº¯t Ä‘áº§u hÃ nh trÃ¬nh thá»±c táº¿: xÃ¢y dá»±ng cÃ¡c agent thuá»™c cÃ¡c quadrant nÃ y thÃ´ng qua má»™t lá»™ trÃ¬nh chi tiáº¿t vá»›i code máº«u.*

```mermaid
graph TB
    subgraph Q1[QUADRANT 1: INSTRUCTION]
        Q1_Input[Input] --> Q1_LLM[LLM<br/>Single Shot]
        Q1_LLM --> Q1_Tool[1 Tool]
        Q1_Tool --> Q1_Output[Output]
    end
    
    subgraph Q2[QUADRANT 2: ORCHESTRATION]
        Q2_Orch{Orchestrator}
        Q2_Orch --> Q2_A1[Agent 1]
        Q2_Orch --> Q2_A2[Agent 2]
        Q2_Orch --> Q2_A3[Agent 3]
        Q2_A1 --> Q2_Orch
        Q2_A2 --> Q2_Orch
        Q2_A3 --> Q2_Orch
    end
    
    subgraph Q3[QUADRANT 3: AUTONOMY]
        Q3_Goal[Goal] --> Q3_Loop((ReAct<br/>Loop))
        Q3_Loop --> Q3_Reason[Reason]
        Q3_Reason --> Q3_Act[Act]
        Q3_Act --> Q3_Observe[Observe]
        Q3_Observe --> Q3_Loop
        Q3_Loop --> Q3_Output[Output]
    end
    
    subgraph Q4[QUADRANT 4: CHOREOGRAPHY]
        Q4_Chief[Chief Agent]
        Q4_Chief -.-> Q4_A1[Agent 1]
        Q4_Chief -.-> Q4_A2[Agent 2]
        Q4_Chief -.-> Q4_A3[Agent 3]
        Q4_A1 -.-> Q4_A2
        Q4_A2 -.-> Q4_A3
        Q4_A1 --> Q4_Chief
        Q4_A2 --> Q4_Chief
        Q4_A3 --> Q4_Chief
    end
    
    style Q1 fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    style Q2 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    style Q3 fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    style Q4 fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    
    style Q1_LLM fill:#fff9c4
    style Q2_Orch fill:#ff9800,color:#fff
    style Q3_Loop fill:#ff5722,color:#fff
    style Q4_Chief fill:#e91e63,color:#fff
```

## 


MÃ¬nh cáº§n 1 kiáº¿n trÃºc high architect cho viá»‡c triá»ƒn khai WEB BROWSER AI AGENT 


# WEB BROWSER AI AGENT - HIGH-LEVEL ARCHITECTURE

## ğŸ“Š KIáº¾N TRÃšC Tá»”NG THá»‚ (4-LAYER MECE FRAMEWORK)

### SÆ¡ Ä‘á»“ tá»•ng quan toÃ n há»‡ thá»‘ng

```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#0f172a','primaryTextColor':'#fff','primaryBorderColor':'#3b82f6','fontSize':'13px'}}}%%

flowchart TB
    %% ==================== USER & INPUT ====================
    User([ğŸ‘¤ USER<br/>Natural Language Goal])
    
    %% ==================== LAYER 1: PERCEPTION ====================
    subgraph L1["ğŸ” LAYER 1: PERCEPTION - Browser State Awareness"]
        direction TB
        
        subgraph IP["ğŸ“¥ Input Processor"]
            IP1["ğŸ­ Modality Handler<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Text (Goal)<br/>â€¢ Screenshot (if needed)<br/>â€¢ Voice (future)"]
            IP2["ğŸ›¡ï¸ Safety Guard<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Prompt Injection Filter<br/>â€¢ PII Detection<br/>â€¢ Malicious URL Check"]
            IP3["âš™ï¸ Goal Parser<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Intent Classification<br/>â€¢ Entity Extraction<br/>â€¢ Constraint Validation"]
            IP1 --> IP2 --> IP3
        end
        
        subgraph BM["ğŸŒ Browser Monitor"]
            BM1["ğŸ“Š Page State Tracker<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Current URL<br/>â€¢ Page Load Status<br/>â€¢ Error Detection"]
            BM2["ğŸŒ³ Content Extractor<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ A11y Tree (90%)<br/>â€¢ DOM Snapshot (backup)<br/>â€¢ Screenshot (10%)"]
            BM3["ğŸ” Change Detector<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ DOM Mutations<br/>â€¢ Network Events<br/>â€¢ Navigation History"]
            BM1 --> BM2
            BM2 --> BM3
        end
        
        IP ~~~ BM
        
        IP3 --> Context["ğŸ“‹ UNIFIED CONTEXT<br/>â”â”â”â”â”â”â”â”â”<br/>Goal + Page State + History"]
    end
    
    %% ==================== LAYER 2: COGNITION ====================
    subgraph L2["ğŸ§  LAYER 2: COGNITION - Agent Brain (LangGraph Core)"]
        direction TB
        
        Context --> StateGraph["ğŸ“Š LangGraph StateGraph<br/>â”â”â”â”â”â”â”â”â”<br/>Agent State Machine"]
        
        subgraph Nodes["ğŸ¯ Core Nodes (ReAct Pattern)"]
            direction LR
            N1["ğŸ’­ PLANNER NODE<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Goal Decomposition<br/>â€¢ Action Selection<br/>â€¢ Tool Binding"]
            N2["âš¡ EXECUTOR NODE<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Tool Invocation<br/>â€¢ Parameter Filling<br/>â€¢ Result Parsing"]
            N3["âœ… VERIFIER NODE<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Success Check<br/>â€¢ Data Validation<br/>â€¢ Confidence Score"]
            N4["ğŸ”„ REPLAN NODE<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Error Analysis<br/>â€¢ Strategy Adjust<br/>â€¢ Fallback Logic"]
            
            N1 --> N2
            N2 --> N3
            N3 -->|Success| N1
            N3 -->|Failure| N4
            N4 --> N1
        end
        
        StateGraph --> Nodes
        
        subgraph Memory["ğŸ’¾ Memory System"]
            direction TB
            M1["âš¡ Short-term<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Context Window<br/>â€¢ Action History<br/>â€¢ Redis Cache"]
            M2["ğŸ—„ï¸ Long-term<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ User Preferences<br/>â€¢ Domain Knowledge<br/>â€¢ Vector DB (RAG)"]
            M1 -.-> M2
        end
        
        Nodes -.->|Read/Write| Memory
        
        Nodes --> Decision["ğŸ“‹ ACTION DECISION<br/>â”â”â”â”â”â”â”â”â”<br/>{tool_name, params, confidence}"]
    end
    
    %% ==================== LAYER 3: ACTION ====================
    subgraph L3["âš¡ LAYER 3: ACTION - Browser Control & Execution"]
        direction TB
        
        Decision --> ToolRouter{Tool Router}
        
        subgraph BrowserTools["ğŸŒ Browser Interaction Tools"]
            direction LR
            T1["ğŸ§­ navigate<br/>â”â”â”â”â”â”â”â”â”<br/>url, wait_until"]
            T2["ğŸ–±ï¸ click<br/>â”â”â”â”â”â”â”â”â”<br/>selector, force"]
            T3["âŒ¨ï¸ fill<br/>â”â”â”â”â”â”â”â”â”<br/>selector, text"]
            T4["â†•ï¸ scroll<br/>â”â”â”â”â”â”â”â”â”<br/>direction, amount"]
            T5["ğŸ“¸ screenshot<br/>â”â”â”â”â”â”â”â”â”<br/>full_page, path"]
        end
        
        subgraph DataTools["ğŸ“Š Data Extraction Tools"]
            direction LR
            T6["ğŸ” extract_text<br/>â”â”â”â”â”â”â”â”â”<br/>selector, all"]
            T7["ğŸ“‹ extract_table<br/>â”â”â”â”â”â”â”â”â”<br/>parse to JSON"]
            T8["ğŸ”— get_links<br/>â”â”â”â”â”â”â”â”â”<br/>filter by domain"]
        end
        
        ToolRouter --> BrowserTools
        ToolRouter --> DataTools
        
        subgraph Executor["ğŸš€ Execution Engine"]
            direction TB
            E1["ğŸ“ Playwright Controller<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Browser Pool<br/>â€¢ Context Manager<br/>â€¢ Page Lifecycle"]
            E2["ğŸ”§ Error Handler<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Retry Logic (3x)<br/>â€¢ Timeout Control<br/>â€¢ Fallback Strategy"]
            E3["ğŸ“¦ Result Parser<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ A11y Tree to JSON<br/>â€¢ HTML to Markdown<br/>â€¢ Screenshot to B64"]
            E1 --> E2 --> E3
        end
        
        BrowserTools --> Executor
        DataTools --> Executor
        
        Executor --> Browser["ğŸŒ HEADLESS CHROMIUM<br/>â”â”â”â”â”â”â”â”â”<br/>Isolated Sandbox"]
        
        Browser --> Result["ğŸ“‹ EXECUTION RESULT<br/>â”â”â”â”â”â”â”â”â”<br/>{status, data, screenshot, error}"]
    end
    
    %% ==================== LAYER 4: GOVERNANCE ====================
    subgraph L4["ğŸ›¡ï¸ LAYER 4: GOVERNANCE - Safety & Human Control"]
        direction TB
        
        subgraph Guard["âš–ï¸ Guardrails"]
            direction LR
            G1["ğŸ›¡ï¸ Action Filter<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ URL Whitelist<br/>â€¢ Sensitive Data<br/>â€¢ Cost Threshold"]
            G2["ğŸ” Access Control<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ RBAC<br/>â€¢ Tool Permissions<br/>â€¢ Domain Limits"]
            G3["ğŸ’° Budget Monitor<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Token Usage<br/>â€¢ API Calls<br/>â€¢ Time Limits"]
            G1 --> G2 --> G3
        end
        
        subgraph HITL["ğŸ‘¤ Human-in-the-Loop"]
            direction TB
            H1["ğŸ›‘ Checkpoint Trigger<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ High-risk Actions<br/>â€¢ Low Confidence<br/>â€¢ First-time Site"]
            H2["ğŸ–¥ï¸ Review UI<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Show Plan<br/>â€¢ Preview Action<br/>â€¢ Approve/Reject"]
            H3["ğŸ”º Escalation<br/>â”â”â”â”â”â”â”â”â”<br/>â€¢ Expert Routing<br/>â€¢ Manual Override<br/>â€¢ Audit Log"]
            H1 --> H2 --> H3
        end
        
        Guard ~~~ HITL
    end
    
    %% ==================== FEEDBACK LOOP ====================
    Result --> L1
    
    %% ==================== GOVERNANCE MONITORING ====================
    L4 -.->|Monitor & Control| L2
    L4 -.->|Block if Unsafe| L3
    
    %% ==================== FINAL OUTPUT ====================
    Result --> Check{Goal<br/>Achieved?}
    Check -->|No| L2
    Check -->|Yes| Output([ğŸ“¤ FINAL OUTPUT<br/>Answer + Evidence Pack])
    
    %% ==================== USER INTERACTION ====================
    User --> L1
    Output --> User
    H2 -.->|Require Approval| User
    
    %% ==================== EXTERNAL SERVICES ====================
    subgraph External["â˜ï¸ EXTERNAL SERVICES"]
        direction LR
        LLM["ğŸ¤– LLM APIs<br/>â”â”â”â”â”â”â”â”â”<br/>GPT-4o<br/>Claude 3.5"]
        DB["ğŸ—„ï¸ Data Layer<br/>â”â”â”â”â”â”â”â”â”<br/>PostgreSQL<br/>Redis<br/>Pinecone"]
        Obs["ğŸ“Š Observability<br/>â”â”â”â”â”â”â”â”â”<br/>LangFuse<br/>Sentry<br/>Datadog"]
    end
    
    L2 -.->|Reasoning Calls| LLM
    Memory -.->|Persist| DB
    L1 -.->|Logs & Traces| Obs
    L2 -.->|Logs & Traces| Obs
    L3 -.->|Logs & Traces| Obs
    
    %% ==================== STYLING ====================
    
    style L1 fill:#1e3a8a,stroke:#3b82f6,stroke-width:4px,color:#fff
    style L2 fill:#78350f,stroke:#f59e0b,stroke-width:4px,color:#fff
    style L3 fill:#064e3b,stroke:#10b981,stroke-width:4px,color:#fff
    style L4 fill:#7f1d1d,stroke:#ef4444,stroke-width:4px,color:#fff
    
    style User fill:#6366f1,stroke:#4f46e5,stroke-width:3px,color:#fff
    style Output fill:#22c55e,stroke:#16a34a,stroke-width:3px,color:#fff
    style Browser fill:#0891b2,stroke:#0e7490,stroke-width:3px,color:#fff
    style External fill:#64748b,stroke:#475569,stroke-width:2px,color:#fff
    
    style Context fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#000
    style StateGraph fill:#fb923c,stroke:#ea580c,stroke-width:2px,color:#fff
    style Decision fill:#fbbf24,stroke:#f59e0b,stroke-width:2px,color:#000
    style Result fill:#86efac,stroke:#22c55e,stroke-width:2px,color:#000
    
    style Check fill:#f87171,stroke:#dc2626,stroke-width:3px,color:#fff
```

---

## ğŸ¯ GIáº¢I THÃCH CHI TIáº¾T Tá»ªNG Lá»šP

### **LAYER 1: PERCEPTION - Browser State Awareness**

#### ğŸ¯ Má»¥c Ä‘Ã­ch

Lá»›p nÃ y lÃ  â€œtai máº¯tâ€ cá»§a agent, chá»‹u trÃ¡ch nhiá»‡m:

1. Thu tháº­p thÃ´ng tin tá»« ngÆ°á»i dÃ¹ng (má»¥c tiÃªu)
2. GiÃ¡m sÃ¡t tráº¡ng thÃ¡i trÃ¬nh duyá»‡t theo thá»i gian thá»±c
3. Táº¡o ra má»™t **Unified Context** (ngá»¯ cáº£nh thá»‘ng nháº¥t) cho lá»›p Cognition

#### ğŸ”§ ThÃ nh pháº§n chi tiáº¿t

##### **A. Input Processor (Bá»™ xá»­ lÃ½ Ä‘áº§u vÃ o)**

```python
# VÃ­ dá»¥ code minh há»a
class InputProcessor:
    def __init__(self):
        self.modality_handler = ModalityHandler()
        self.safety_guard = SafetyGuard()
        self.goal_parser = GoalParser()
    
    def process(self, user_input: str) -> ParsedGoal:
        # 1. Xá»­ lÃ½ Ä‘a phÆ°Æ¡ng thá»©c
        text = self.modality_handler.to_text(user_input)
        
        # 2. Kiá»ƒm tra an toÃ n
        if not self.safety_guard.is_safe(text):
            raise SecurityException("Detected malicious input")
        
        # 3. PhÃ¢n tÃ­ch má»¥c tiÃªu
        goal = self.goal_parser.parse(text)
        return goal
```

**Chá»©c nÄƒng tá»«ng module:**

|Module|Input|Output|Vai trÃ²|
|---|---|---|---|
|**Modality Handler**|Text/Voice/Image|Normalized Text|Chuyá»ƒn Ä‘á»•i má»i input vá» vÄƒn báº£n|
|**Safety Guard**|Normalized Text|Pass/Block|NgÄƒn cháº·n prompt injection, PII leak|
|**Goal Parser**|Safe Text|`ParsedGoal` Object|TrÃ­ch xuáº¥t intent, entities, constraints|

**VÃ­ dá»¥ Goal Parser:**

```
Input: "Find the cheapest flight from Hanoi to Tokyo on Dec 25"

Output (ParsedGoal):
{
  "intent": "search_and_compare",
  "entities": {
    "origin": "Hanoi",
    "destination": "Tokyo", 
    "date": "2024-12-25"
  },
  "constraints": {
    "sort_by": "price",
    "order": "asc"
  },
  "domain": "travel"
}
```

##### **B. Browser Monitor (Bá»™ giÃ¡m sÃ¡t trÃ¬nh duyá»‡t)**

ÄÃ¢y lÃ  thÃ nh pháº§n **cá»±c ká»³ quan trá»ng** - nÃ³ cung cáº¥p â€œthá»‹ giÃ¡câ€ cho agent.

**1. Page State Tracker:**

```python
class PageStateTracker:
    def get_current_state(self, page: Page) -> PageState:
        return PageState(
            url=page.url,
            title=page.title(),
            is_loading=page.evaluate("document.readyState") == "loading",
            has_errors=self._check_console_errors(page)
        )
```

**2. Content Extractor - Chiáº¿n lÆ°á»£c 3 lá»›p:**

```mermaid
graph LR
    A[Page Content] --> B{Strategy}
    B -->|90% Cases| C[A11y Tree<br/>Fast + Semantic]
    B -->|Backup| D[DOM Snapshot<br/>Slow + Complete]
    B -->|10% Cases| E[Screenshot + Vision<br/>Expensive + Fallback]
    
    C --> F[Parsed Content]
    D --> F
    E --> F
    
    style C fill:#10b981,color:#fff
    style D fill:#f59e0b,color:#fff
    style E fill:#ef4444,color:#fff
```

**Táº¡i sao A11y Tree lÃ  primary?**

|PhÆ°Æ¡ng phÃ¡p|Æ¯u Ä‘iá»ƒm|NhÆ°á»£c Ä‘iá»ƒm|Khi nÃ o dÃ¹ng|
|---|---|---|---|
|**A11y Tree**|âœ… Nhanh (~50ms)  <br>âœ… Ngá»¯ nghÄ©a cao  <br>âœ… Ãt token|âŒ KhÃ´ng cÃ³ styling  <br>âŒ Thiáº¿u hidden elements|**90% cases** - Trang tuÃ¢n thá»§ a11y|
|**DOM Snapshot**|âœ… Äáº§y Ä‘á»§  <br>âœ… CÃ³ selectors|âŒ Cháº­m (~200ms)  <br>âŒ Nhiá»u token|Backup khi A11y khÃ´ng Ä‘á»§|
|**Screenshot + Vision**|âœ… â€œNhÃ¬nâ€ nhÆ° ngÆ°á»i  <br>âœ… Báº¯t Ä‘Æ°á»£c visual bugs|âŒ Ráº¥t cháº­m (2-5s)  <br>âŒ Tá»‘n kÃ©m (GPT-4V)|10% edge cases|

**Code vÃ­ dá»¥ A11y Tree Extraction:**

```python
class A11yTreeExtractor:
    def extract(self, page: Page) -> Dict:
        # Playwright cÃ³ built-in snapshot a11y
        tree = page.accessibility.snapshot()
        
        # Lá»c chá»‰ láº¥y interactive elements
        interactive = self._filter_interactive(tree)
        
        return {
            "buttons": interactive["buttons"],  # role="button"
            "links": interactive["links"],      # role="link"
            "inputs": interactive["inputs"],    # role="textbox"
            "headings": interactive["headings"] # role="heading"
        }
```

**3. Change Detector:**

Quan trá»ng cho viá»‡c biáº¿t â€œtrang Ä‘Ã£ load xong chÆ°aâ€ vÃ  â€œcÃ³ lá»—i xáº£y ra khÃ´ngâ€.

```python
class ChangeDetector:
    def __init__(self, page: Page):
        self.page = page
        self._setup_listeners()
    
    def _setup_listeners(self):
        # DOM Mutation Observer
        self.page.evaluate("""
            new MutationObserver((mutations) => {
                window.__dom_changed = true;
            }).observe(document.body, {
                childList: true, 
                subtree: true
            });
        """)
        
        # Network Event Listener
        self.page.on("response", self._on_response)
        self.page.on("console", self._on_console_error)
    
    def has_errors(self) -> bool:
        return self.page.evaluate("window.__has_error === true")
```

##### **C. Unified Context (Ngá»¯ cáº£nh thá»‘ng nháº¥t)**

Äáº§u ra cá»§a Layer 1 lÃ  má»™t object **Unified Context**, lÃ  input cho Layer 2:

```python
@dataclass
class UnifiedContext:
    # From Input Processor
    goal: ParsedGoal
    
    # From Browser Monitor
    current_url: str
    page_title: str
    a11y_tree: Dict  # Structured representation
    dom_snapshot: Optional[str]  # HTML fallback
    screenshot_b64: Optional[str]  # Vision fallback
    
    # From Change Detector
    is_stable: bool  # Page stopped changing?
    errors: List[str]  # Any console errors?
    
    # From Memory
    action_history: List[Action]  # What we did so far
    extracted_data: Dict  # Data collected
```

---

### **LAYER 2: COGNITION - Agent Brain (LangGraph Core)**

#### ğŸ¯ Má»¥c Ä‘Ã­ch

ÄÃ¢y lÃ  â€œbá»™ nÃ£oâ€ cá»§a agent, nÆ¡i diá»…n ra:

1. **Reasoning** (Suy luáº­n): Hiá»ƒu context vÃ  quyáº¿t Ä‘á»‹nh bÆ°á»›c tiáº¿p theo
2. **Planning** (Láº­p káº¿ hoáº¡ch): PhÃ¢n rÃ£ má»¥c tiÃªu thÃ nh cÃ¡c hÃ nh Ä‘á»™ng cá»¥ thá»ƒ
3. **Memory Management** (Quáº£n lÃ½ bá»™ nhá»›): Ghi nhá»› vÃ  truy xuáº¥t thÃ´ng tin

#### ğŸ”§ Kiáº¿n trÃºc LangGraph State Machine

```mermaid
%%{init: {'theme':'base'}}%%
stateDiagram-v2
    [*] --> Planner: New Goal
    
    Planner --> Executor: {tool, params}
    
    Executor --> Verifier: Result
    
    Verifier --> Planner: âœ… Success<br/>Continue Plan
    Verifier --> Replan: âŒ Failure<br/>Need New Strategy
    
    Replan --> Planner: Adjusted Plan
    
    Verifier --> Synthesizer: ğŸ¯ Goal Achieved
    
    Synthesizer --> [*]: Final Answer
    
    note right of Planner
        LLM decides:
        - Which tool to call
        - What parameters
        - Next sub-goal
    end note
    
    note right of Executor
        Calls browser tools
        via Playwright
    end note
    
    note right of Verifier
        Checks:
        - Did action succeed?
        - Is data valid?
        - Confidence score
    end note
    
    note right of Replan
        LLM analyzes failure:
        - Why did it fail?
        - Alternative approach?
        - Fallback strategy
    end note
```

#### ğŸ§© Chi tiáº¿t tá»«ng Node

##### **Node 1: PLANNER (Káº¿ hoáº¡ch viÃªn)**

```python
from langgraph.graph import StateGraph, END

class PlannerNode:
    def __init__(self, llm):
        self.llm = llm
    
    def __call__(self, state: AgentState) -> Dict:
        # 1. Nháº­n context tá»« Perception Layer
        context = state["unified_context"]
        
        # 2. Táº¡o prompt cho LLM
        prompt = self._build_prompt(
            goal=context.goal,
            current_page=context.a11y_tree,
            history=context.action_history
        )
        
        # 3. LLM reasoning (CoT)
        response = self.llm.invoke(prompt)
        
        # 4. Parse response thÃ nh action
        action = self._parse_action(response)
        
        return {
            "next_action": action,
            "reasoning": response.reasoning
        }
    
    def _build_prompt(self, goal, current_page, history):
        return f"""
You are a web browser agent. Your goal: {goal}

Current page state:
{json.dumps(current_page, indent=2)}

Actions taken so far:
{self._format_history(history)}

Think step-by-step:
1. What information do I need?
2. What action will get me closer to the goal?
3. Which tool and parameters should I use?

Output JSON:
{{
  "reasoning": "...",
  "action": {{
    "tool": "click|fill|navigate|extract",
    "params": {{...}},
    "confidence": 0.0-1.0
  }}
}}
"""
```

**Key Techniques:**

- **Chain-of-Thought (CoT)**: YÃªu cáº§u LLM â€œthink step-by-stepâ€ Ä‘á»ƒ cáº£i thiá»‡n reasoning
- **Few-Shot Learning**: ThÃªm 2-3 vÃ­ dá»¥ vá» cÃ¡c action thÃ nh cÃ´ng
- **Tool Schema**: MÃ´ táº£ rÃµ rÃ ng cÃ¡c tool available vÃ  parameters

##### **Node 2: EXECUTOR (NgÆ°á»i thá»±c thi)**

```python
class ExecutorNode:
    def __init__(self, browser_controller):
        self.controller = browser_controller
    
    async def __call__(self, state: AgentState) -> Dict:
        action = state["next_action"]
        
        try:
            # 1. Validate action
            self._validate(action)
            
            # 2. Execute via Playwright
            result = await self.controller.execute(
                tool=action["tool"],
                params=action["params"],
                timeout=30_000  # 30s
            )
            
            # 3. Update browser state
            new_context = await self._capture_new_state()
            
            return {
                "execution_result": result,
                "unified_context": new_context,
                "status": "success"
            }
            
        except TimeoutError:
            return {"status": "timeout", "error": "Page load timeout"}
        except PlaywrightError as e:
            return {"status": "failed", "error": str(e)}
```

##### **Node 3: VERIFIER (NgÆ°á»i xÃ¡c minh)**

ÄÃ¢y lÃ  node **quan trá»ng nháº¥t** Ä‘á»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng.

```python
class VerifierNode:
    def __init__(self, llm):
        self.llm = llm
    
    def __call__(self, state: AgentState) -> Dict:
        action = state["next_action"]
        result = state["execution_result"]
        
        # 1. Technical Verification (Code-based)
        tech_check = self._technical_verification(result)
        
        if not tech_check["passed"]:
            return {
                "verified": False,
                "reason": tech_check["reason"],
                "next_node": "replan"
            }
        
        # 2. Semantic Verification (LLM-based)
        semantic_check = self._semantic_verification(
            action_intent=action["reasoning"],
            actual_result=result
        )
        
        if semantic_check["confidence"] < 0.7:
            return {
                "verified": False,
                "reason": "Low confidence result",
                "next_node": "replan"
            }
        
        # 3. Goal Progress Check
        if self._goal_achieved(state):
            return {
                "verified": True,
                "next_node": "synthesizer"
            }
        
        return {
            "verified": True,
            "next_node": "planner"  # Continue with next action
        }
    
    def _technical_verification(self, result):
        """Kiá»ƒm tra ká»¹ thuáº­t"""
        checks = {
            "has_data": result.get("data") is not None,
            "no_errors": result.get("error") is None,
            "valid_format": self._validate_format(result)
        }
        
        passed = all(checks.values())
        return {
            "passed": passed,
            "reason": str(checks) if not passed else None
        }
    
    def _semantic_verification(self, action_intent, actual_result):
        """Kiá»ƒm tra ngá»¯ nghÄ©a báº±ng LLM"""
        prompt = f"""
Did this action achieve its intent?

Intended: {action_intent}
Actual result: {json.dumps(actual_result)}

Answer with confidence score (0-1) and reason.
"""
        response = self.llm.invoke(prompt)
        return json.loads(response.content)
```

##### **Node 4: REPLAN (TÃ¡i láº­p káº¿ hoáº¡ch)**

Node nÃ y lÃ  â€œself-healing mechanismâ€ - cho phÃ©p agent phá»¥c há»“i tá»« lá»—i.

```python
class ReplanNode:
    def __init__(self, llm):
        self.llm = llm
    
    def __call__(self, state: AgentState) -> Dict:
        failure = state["execution_result"]
        history = state["unified_context"].action_history
        
        # 1. PhÃ¢n tÃ­ch nguyÃªn nhÃ¢n tháº¥t báº¡i
        analysis = self._analyze_failure(failure, history)
        
        # 2. Äá» xuáº¥t chiáº¿n lÆ°á»£c thay tháº¿
        prompt = f"""
Previous action failed:
- Action: {state['next_action']}
- Error: {failure.get('error')}
- Analysis: {analysis}

Suggest an alternative approach:
1. Different tool?
2. Different selector?
3. Different strategy?
4. Give up this sub-goal?
"""
        
        new_plan = self.llm.invoke(prompt)
        
        # 3. Cáº­p nháº­t state
        return {
            "action_history": history + [
                {"action": state["next_action"], "status": "failed"}
            ],
            "replanned": True,
            "new_strategy": new_plan
        }
```

#### ğŸ’¾ Memory System

```python
class MemorySystem:
    def __init__(self):
        self.short_term = Redis()  # Fast cache
        self.long_term = Pinecone()  # Vector DB for RAG
    
    # SHORT-TERM: Current session
    def save_action(self, action: Action):
        key = f"session:{action.session_id}"
        self.short_term.lpush(key, json.dumps(action))
        self.short_term.expire(key, 3600)  # 1 hour TTL
    
    def get_recent_actions(self, session_id: str, n: int = 10):
        key = f"session:{session_id}"
        return self.short_term.lrange(key, 0, n-1)
    
    # LONG-TERM: Cross-session learning
    def save_successful_pattern(self, pattern: Dict):
        """
        LÆ°u cÃ¡c pattern thÃ nh cÃ´ng Ä‘á»ƒ RAG sau nÃ y
        
        Example pattern:
        {
          "goal_type": "book_flight",
          "domain": "travel",
          "successful_sequence": [
            {"tool": "navigate", "params": {...}},
            {"tool": "fill", "params": {...}},
            ...
          ],
          "success_rate": 0.95
        }
        """
        embedding = self._get_embedding(pattern["goal_type"])
        self.long_term.upsert(
            id=pattern["id"],
            values=embedding,
            metadata=pattern
        )
    
    def recall_similar_pattern(self, current_goal: str):
        """RAG: TÃ¬m pattern tÆ°Æ¡ng tá»± tá»« quÃ¡ khá»©"""
        embedding = self._get_embedding(current_goal)
        results = self.long_term.query(
            vector=embedding,
            top_k=3
        )
        return [r.metadata for r in results]
```

---

### **LAYER 3: ACTION - Browser Control & Execution**

#### ğŸ¯ Má»¥c Ä‘Ã­ch

Lá»›p nÃ y lÃ  â€œtay chÃ¢nâ€ cá»§a agent, thá»±c thi cÃ¡c quyáº¿t Ä‘á»‹nh tá»« Layer 2.

#### ğŸ”§ Tool Library (ThÆ° viá»‡n cÃ´ng cá»¥)

```python
from langchain.tools import BaseTool
from pydantic import BaseModel, Field

# ============ NAVIGATION TOOLS ============

class NavigateTool(BaseTool):
    name = "navigate"
    description = """
    Navigate to a URL.
    
    Use when: You need to go to a different page
    
    Args:
        url: Full URL (must include http:// or https://)
        wait_until: Optional, one of ["load", "domcontentloaded", "networkidle"]
    """
    
    def _run(self, url: str, wait_until: str = "load"):
        page = get_current_page()
        page.goto(url, wait_until=wait_until)
        
        # Wait extra for dynamic content
        page.wait_for_timeout(1000)
        
        return {
            "success": True,
            "final_url": page.url,
            "title": page.title()
        }

# ============ INTERACTION TOOLS ============

class ClickTool(BaseTool):
    name = "click"
    description = """
    Click on an element.
    
    Use when: You need to click a button, link, or any clickable element
    
    Args:
        selector: CSS selector or text content
        force: Optional, force click even if element is not visible
    """
    
    def _run(self, selector: str, force: bool = False):
        page = get_current_page()
        
        try:
            # Try CSS selector first
            page.click(selector, force=force, timeout=5000)
        except PlaywrightError:
            # Fallback: Click by text content
            page.get_by_text(selector).click(force=force)
        
        # Wait for potential navigation
        page.wait_for_load_state("networkidle")
        
        return {"success": True, "clicked": selector}

class FillTool(BaseTool):
    name = "fill"
    description = """
    Fill an input field with text.
    
    Use when: You need to type text into a form field
    
    Args:
        selector: CSS selector or placeholder text
        text: Text to fill
        press_enter: Optional, press Enter after filling
    """
    
    def _run(self, selector: str, text: str, press_enter: bool = False):
        page = get_current_page()
        
        page.fill(selector, text)
        
        if press_enter:
            page.keyboard.press("Enter")
            page.wait_for_load_state("networkidle")
        
        return {"success": True, "filled": selector}

# ============ EXTRACTION TOOLS ============

class ExtractTextTool(BaseTool):
    name = "extract_text"
    description = """
    Extract text content from the page.
    
    Use when: You need to read visible text
    
    Args:
        selector: Optional CSS selector, if not provided extracts all text
    """
    
    def _run(self, selector: Optional[str] = None):
        page = get_current_page()
        
        if selector:
            elements = page.query_selector_all(selector)
            texts = [el.inner_text() for el in elements]
        else:
            texts = [page.inner_text("body")]
        
        return {"texts": texts, "count": len(texts)}

class ExtractTableTool(BaseTool):
    name = "extract_table"
    description = """
    Extract HTML table as structured JSON.
    
    Use when: You see a data table and need to parse it
    
    Args:
        selector: CSS selector for the table
    """
    
    def _run(self, selector: str = "table"):
        page = get_current_page()
        
        # Evaluate in browser context
        data = page.evaluate("""
            (selector) => {
                const table = document.querySelector(selector);
                const rows = Array.from(table.querySelectorAll('tr'));
                
                return rows.map(row => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    return cells.map(cell => cell.textContent.trim());
                });
            }
        """, selector)
        
        return {"table_data": data, "rows": len(data)}
```

#### ğŸš€ Execution Engine

```python
class BrowserController:
    def __init__(self):
        self.playwright = sync_playwright().start()
        self.browser = self.playwright.chromium.launch(
            headless=True,
            args=[
                '--disable-blink-features=AutomationControlled',
                '--disable-dev-shm-usage'
            ]
        )
        self.context = self.browser.new_context(
            viewport={'width': 1920, 'height': 1080},
            user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)...'
        )
        self.page = self.context.new_page()
        
        # Error recovery
        self.retry_count = 3
        self.timeout = 30000  # 30s
    
    async def execute(self, tool: str, params: Dict, timeout: int = None):
        """
        Execute a browser tool with retry logic
        """
        timeout = timeout or self.timeout
        
        for attempt in range(self.retry_count):
            try:
                # Set timeout for this attempt
                self.page.set_default_timeout(timeout)
                
                # Call the appropriate tool
                result = await self._call_tool(tool, params)
                
                # Success! Return result
                return result
                
            except TimeoutError as e:
                if attempt < self.retry_count - 1:
                    logger.warning(f"Timeout attempt {attempt+1}, retrying...")
                    await asyncio.sleep(2 ** attempt)  # Exponential backoff
                else:
                    return {"error": "Timeout after retries", "tool": tool}
            
            except PlaywrightError as e:
                return {"error": str(e), "tool": tool}
    
    async def _call_tool(self, tool: str, params: Dict):
        # Map tool name to function
        tools = {
            "navigate": self._navigate,
            "click": self._click,
            "fill": self._fill,
            "extract_text": self._extract_text,
            # ... other tools
        }
        
        if tool not in tools:
            raise ValueError(f"Unknown tool: {tool}")
        
        return await tools[tool](**params)
```

---

### **LAYER 4: GOVERNANCE - Safety & Human Control**

#### ğŸ¯ Má»¥c Ä‘Ã­ch

Lá»›p nÃ y Ä‘áº£m báº£o agent hoáº¡t Ä‘á»™ng an toÃ n, cÃ³ trÃ¡ch nhiá»‡m vÃ  cÃ³ thá»ƒ kiá»ƒm soÃ¡t.

#### ğŸ›¡ï¸ Guardrails (RÃ o cháº¯n an toÃ n)

```python
class GuardrailSystem:
    def __init__(self):
        self.url_whitelist = set(["google.com", "wikipedia.org", ...])
        self.dangerous_actions = set(["DELETE", "PURCHASE", "SUBMIT_PAYMENT"])
        self.cost_threshold = 10.0  # USD
    
    def check_action(self, action: Action) -> GuardrailResult:
        """
        Kiá»ƒm tra action trÆ°á»›c khi thá»±c thi
        """
        checks = [
            self._check_url_safety(action),
            self._check_action_risk(action),
            self._check_cost_limit(action),
            self._check_pii_exposure(action)
        ]
        
        failed_checks = [c for c in checks if not c.passed]
        
        if failed_checks:
            return GuardrailResult(
                allowed=False,
                reason="; ".join([c.reason for c in failed_checks]),
                require_human_approval=any(c.severity == "HIGH" for c in failed_checks)
            )
        
        return GuardrailResult(allowed=True)
    
    def _check_url_safety(self, action):
        if action.tool == "navigate":
            url = action.params["url"]
            domain = extract_domain(url)
            
            if domain not in self.url_whitelist:
                return Check(
                    passed=False,
                    reason=f"Domain {domain} not in whitelist",
                    severity="HIGH"
                )
        
        return Check(passed=True)
    
    def _check_action_risk(self, action):
        """
        PhÃ¡t hiá»‡n cÃ¡c action nguy hiá»ƒm
        """
        if action.tool == "click":
            text = action.params.get("selector", "").upper()
            
            if any(dangerous in text for dangerous in self.dangerous_actions):
                return Check(
                    passed=False,
                    reason=f"Dangerous action detected: {text}",
                    severity="CRITICAL"
                )
        
        return Check(passed=True)
    
    def _check_pii_exposure(self, action):
        """
        PhÃ¡t hiá»‡n viá»‡c gá»­i dá»¯ liá»‡u cÃ¡ nhÃ¢n
        """
        if action.tool == "fill":
            text = action.params.get("text", "")
            
            if self._contains_pii(text):
                return Check(
                    passed=False,
                    reason="Detected PII in input",
                    severity="HIGH"
                )
        
        return Check(passed=True)
```

#### ğŸ‘¤ Human-in-the-Loop Interface

```python
class HITLSystem:
    def __init__(self):
        self.checkpoint_rules = [
            {"condition": "first_time_domain", "action": "require_approval"},
            {"condition": "cost_over_threshold", "action": "require_approval"},
            {"condition": "low_confidence", "action": "show_preview"}
        ]
    
    def should_pause(self, action: Action, state: AgentState) -> bool:
        """
        Quyáº¿t Ä‘á»‹nh cÃ³ cáº§n dá»«ng láº¡i Ä‘á»ƒ xin phÃª duyá»‡t khÃ´ng
        """
        for rule in self.checkpoint_rules:
            if self._evaluate_condition(rule["condition"], action, state):
                return True
        
        return False
    
    async def request_approval(self, action: Action) -> ApprovalResult:
        """
        Hiá»ƒn thá»‹ UI vÃ  chá» ngÆ°á»i dÃ¹ng phÃª duyá»‡t
        """
        # 1. Táº¡o preview
        preview = self._generate_preview(action)
        
        # 2. Gá»­i qua WebSocket Ä‘áº¿n frontend
        await self.websocket.send_json({
            "type": "approval_request",
            "action": action.dict(),
            "preview": preview,
            "risk_level": self._assess_risk(action)
        })
        
        # 3. Chá» response tá»« user
        response = await self.websocket.receive_json()
        
        # 4. Parse response
        if response["decision"] == "approve":
            return ApprovalResult(approved=True)
        elif response["decision"] == "reject":
            return ApprovalResult(approved=False)
        elif response["decision"] == "edit":
            return ApprovalResult(
                approved=True,
                modified_action=response["edited_action"]
            )
```

**Frontend UI Example (React):**

```typescript
// ApprovalDialog.tsx
function ApprovalDialog({ request }) {
  const [decision, setDecision] = useState(null);
  
  return (
    <Dialog open={request !== null}>
      <DialogTitle>Action Approval Required</DialogTitle>
      
      <DialogContent>
        <Alert severity={request.risk_level}>
          Risk Level: {request.risk_level}
        </Alert>
        
        <Typography variant="h6">Proposed Action:</Typography>
        <CodeBlock>{JSON.stringify(request.action, null, 2)}</CodeBlock>
        
        <Typography variant="h6">Preview:</Typography>
        <img src={request.preview.screenshot} />
        
        <TextField
          label="Edit Action (optional)"
          multiline
          defaultValue={JSON.stringify(request.action, null, 2)}
        />
      </DialogContent>
      
      <DialogActions>
        <Button onClick={() => handleDecision("reject")} color="error">
          Reject
        </Button>
        <Button onClick={() => handleDecision("approve")} color="success">
          Approve
        </Button>
      </DialogActions>
    </Dialog>
  );
}
```

---

## ğŸ“Š TECHNOLOGY STACK DETAIL

|Layer|Component|Technology|Justification|
|---|---|---|---|
|**Perception**|Browser Control|Playwright|Fastest, most reliable, built-in A11y|
||Content Extraction|Playwright + GPT-4V|Hybrid approach for robustness|
||Safety Guard|LangKit|Specialized prompt injection detection|
|**Cognition**|Agent Framework|LangGraph|Best for state machine + ReAct pattern|
||LLM|GPT-4o / Claude 3.5|SOTA reasoning + tool use|
||Memory (Short-term)|Redis|Fast in-memory cache|
||Memory (Long-term)|Pinecone|Managed vector DB for RAG|
|**Action**|Browser Engine|Chromium (headless)|Industry standard|
||Tool Framework|LangChain Tools|Native integration with LangGraph|
|**Governance**|Observability|LangFuse|Best LLM tracing platform|
||Monitoring|Datadog|Production-grade monitoring|
||HITL UI|React + WebSocket|Real-time approval interface|
|**Infrastructure**|API Gateway|FastAPI|Async support, OpenAPI docs|
||Database|PostgreSQL|ACID compliance for critical data|
||Message Queue|Redis Streams|Lightweight queue for async tasks|
||Container|Docker + K8s|Scalable deployment|

---

## ğŸ”„ END-TO-END FLOW EXAMPLE

Minh há»a Ä‘áº§y Ä‘á»§ má»™t request tá»« user Ä‘áº¿n final output:

```
USER REQUEST:
"Find the cheapest flight from Hanoi to Tokyo departing Dec 25"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 1: PERCEPTION                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 1.1: Input Processor
  â†’ Modality Handler: Text input (no conversion needed)
  â†’ Safety Guard: âœ… No injection detected
  â†’ Goal Parser: 
    {
      "intent": "search_and_compare",
      "domain": "travel",
      "entities": {
        "origin": "Hanoi",
        "destination": "Tokyo",
        "date": "2024-12-25"
      },
      "constraints": {"sort_by": "price"}
    }

Step 1.2: Browser Monitor
  â†’ Page State: Currently at "https://www.google.com"
  â†’ A11y Tree: Extracted 47 interactive elements
  â†’ Change Detector: Page stable, no errors

Step 1.3: Unified Context Created
  â†’ Passed to Layer 2

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 2: COGNITION (LangGraph)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LOOP #1:
  Node: PLANNER
    â†’ LLM Reasoning: "I need to navigate to a flight search site. 
                      Google Flights is a good choice."
    â†’ Decision: {
        "tool": "navigate",
        "params": {"url": "https://www.google.com/travel/flights"}
      }
  
  Node: EXECUTOR
    â†’ Executing navigate...
    â†’ Result: âœ… Navigated to Google Flights
  
  Node: VERIFIER
    â†’ Technical Check: âœ… URL changed successfully
    â†’ Semantic Check: âœ… Page title contains "Google Flights"
    â†’ Goal Check: âŒ Not yet achieved
    â†’ Next: Continue to PLANNER

LOOP #2:
  Node: PLANNER
    â†’ LLM Reasoning: "Now I need to fill in the search form.
                      I see 'From' and 'To' fields."
    â†’ Decision: {
        "tool": "fill",
        "params": {
          "selector": "input[aria-label='Where from?']",
          "text": "Hanoi"
        }
      }
  
  Node: EXECUTOR
    â†’ Executing fill...
    â†’ Result: âœ… Filled "Hanoi" in From field
  
  Node: VERIFIER
    â†’ âœ… Verified
    â†’ Next: Continue to PLANNER

LOOP #3:
  Node: PLANNER
    â†’ Decision: Fill destination "Tokyo"
  
  [... similar flow ...]

LOOP #5:
  Node: PLANNER
    â†’ Decision: Click "Search" button
  
  Node: EXECUTOR
    â†’ Click executed
    â†’ Waiting for results to load...
  
  Node: VERIFIER
    â†’ Page changed to results page
    â†’ âœ… Verified

LOOP #6:
  Node: PLANNER
    â†’ LLM Reasoning: "I see a list of flights. I need to extract
                      and compare prices."
    â†’ Decision: {
        "tool": "extract_table",
        "params": {"selector": "div.flight-results"}
      }
  
  Node: EXECUTOR
    â†’ Extracted 12 flights
    â†’ Result: [
        {"airline": "VN", "price": "450 USD", "time": "10:00-16:30"},
        {"airline": "JL", "price": "380 USD", "time": "08:00-14:00"},
        ...
      ]
  
  Node: VERIFIER
    â†’ âœ… Data extracted
    â†’ Goal Check: âœ… ACHIEVED (have price comparison)
    â†’ Next: SYNTHESIZER

  Node: SYNTHESIZER
    â†’ LLM generates final answer:
      "I found 12 flights. The cheapest is Japan Airlines (JL)
       at $380 USD, departing 08:00 and arriving 14:00 Tokyo time.
       
       Top 3 cheapest options:
       1. JL - $380 (Direct, 6h)
       2. VJ - $395 (1 stop, 8h)
       3. VN - $450 (Direct, 6.5h)"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 3: ACTION (Called 6 times during loops)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â†’ BrowserController managed:
    - 1x navigate
    - 4x fill
    - 1x click
    - 1x extract_table
  
  â†’ All executed via Playwright on Headless Chromium
  â†’ Total execution time: ~8 seconds

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LAYER 4: GOVERNANCE (Monitored throughout)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Guardrails:
    â†’ âœ… google.com in whitelist
    â†’ âœ… No dangerous actions detected
    â†’ âœ… Cost: $0.45 (under $10 threshold)
  
  HITL:
    â†’ No checkpoints triggered (trusted domain)
  
  Observability (LangFuse):
    â†’ Logged 6 LLM calls
    â†’ Logged 6 tool executions
    â†’ Total tokens: 8,450
    â†’ Total cost: $0.45

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FINAL OUTPUT TO USER                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{
  "answer": "I found 12 flights...",
  "data": [...],
  "evidence": {
    "screenshots": ["step1.png", "step6.png"],
    "source_url": "https://www.google.com/travel/flights/...",
    "extracted_at": "2024-12-15T10:30:00Z"
  },
  "metadata": {
    "steps_taken": 6,
    "total_time": 8.2,
    "cost": 0.45
  }
}
```

---

## ğŸš€ DEPLOYMENT ARCHITECTURE

```mermaid
graph TB
    subgraph Internet
        User[ğŸ‘¤ User Browser]
    end
    
    subgraph AWS_Cloud["â˜ï¸ AWS Cloud"]
        subgraph Public_Subnet
            ALB[Application Load Balancer]
        end
        
        subgraph Private_Subnet_App["Private Subnet - App Tier"]
            ECS_API[ECS Cluster<br/>FastAPI Containers<br/>Auto-scaling 2-10]
        end
        
        subgraph Private_Subnet_Agent["Private Subnet - Agent Tier"]
            ECS_Agent[ECS Cluster<br/>Agent + Browser<br/>Auto-scaling 1-5]
        end
        
        subgraph Private_Subnet_Data["Private Subnet - Data Tier"]
            RDS[(RDS PostgreSQL<br/>Multi-AZ)]
            ElastiCache[(ElastiCache Redis<br/>Cluster Mode)]
        end
        
        subgraph External_Services["External Services"]
            OpenAI[OpenAI API]
            Pinecone[Pinecone Vector DB]
            LangFuse[LangFuse SaaS]
        end
    end
    
    User -->|HTTPS| ALB
    ALB -->|Forward| ECS_API
    ECS_API -->|Invoke Agent| ECS_Agent
    ECS_Agent -->|Persist| RDS
    ECS_Agent -->|Cache| ElastiCache
    ECS_Agent -->|LLM Calls| OpenAI
    ECS_Agent -->|RAG| Pinecone
    ECS_Agent -->|Traces| LangFuse
    
    style User fill:#6366f1
    style ALB fill:#f59e0b
    style ECS_API fill:#10b981
    style ECS_Agent fill:#ef4444
    style RDS fill:#8b5cf6
    style ElastiCache fill:#ec4899
```

### Key Infrastructure Decisions

|Component|Choice|Reasoning|
|---|---|---|
|**Compute**|ECS Fargate|Serverless containers, no EC2 management|
|**Browser Hosting**|Separate ECS Cluster|Isolate heavy Chromium processes|
|**Database**|RDS PostgreSQL Multi-AZ|ACID compliance + HA|
|**Cache**|ElastiCache Redis Cluster|High throughput, replication|
|**Load Balancer**|ALB|WebSocket support, SSL termination|
|**Secrets**|AWS Secrets Manager|Automatic rotation, audit logs|
|**Logs**|CloudWatch + S3|Centralized logs, long-term archive|

---

ÄÃ¢y lÃ  kiáº¿n trÃºc high-level Ä‘áº§y Ä‘á»§ cho Web Browser AI Agent. Báº¡n muá»‘n tÃ´i Ä‘i sÃ¢u vÃ o pháº§n nÃ o? VÃ­ dá»¥:

1. Code implementation chi tiáº¿t cá»§a má»™t Node
2. Deployment scripts (Terraform/CloudFormation)
3. Monitoring & alerting setup
4. Cost optimization strategies