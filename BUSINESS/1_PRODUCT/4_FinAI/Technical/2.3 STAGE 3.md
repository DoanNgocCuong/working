## 1. Explain pipeline – Tổng quan Stage 3

**Stage 3 = “Planning & Plan Packaging”**  

- Nhận đầu vào: **ContextPackV1 + TaskSpecV1** (từ Stage 1–2).
- Trả ra: **PlanBundleV1** với `plan_mode`, `plan_status`, `execution_plan` (nếu có), `gates`, `budget`, `lint`, `capability`, `prompt_pack_ref`…
- Không tự gọi web/tool, không click gì. Chỉ **lập kế hoạch + kiểm tra + đóng gói** cho Stage 4 thi công.

---

### 1.1. Stage 3 nhận gì và trả gì?

**Input**

- `ContextPackV1`
  - Context của tab: URL, title, selection, snapshot DOM, attach file…
  - Runtime: browser_id, locale, device, user_prefs…
- `TaskSpecV1`
  - `user_query`: câu hỏi gốc
  - `intent`: research / action / research_then_action / action_then_research / unknown
  - `entities`: vendor, ticker, time_range…
  - `constraints`: no_submit, max_items, time_window…
  - `domain_hint`, `risk_flags`, `tool_hints`, `permission_hints`

**Output**

- `PlanBundleV1`
  - `plan_status`: READY / NEEDS_CLARIFICATION / BLOCKED_POLICY / INFEASIBLE
  - `plan_mode`: RESEARCH / ACTION / HYBRID / CLARIFY
  - `execution_plan`: `ExecutionPlanV1` gồm list `PlanStepV1` (nếu đã lập được plan)
  - `clarification`: nếu cần hỏi lại user
  - `gates`: các gate policy (CONFIRMATION / PAYMENT / LOGIN…)
  - `budget`: dự trù thời gian, tool_calls, tokens
  - `capability`, `lint`, `prompt_pack_ref`, `snapshot_ref`, `idempotency_key`…

---

### 1.2. Bảng tóm tắt module → vai trò

| Module                      | Vai trò ngắn gọn                                                                 |
|----------------------------|----------------------------------------------------------------------------------|
| `S3TraceContextBuilder`    | Tạo `trace_id`, `plan_id`, `request_id` gắn vào log + output.                    |
| `S3IntentRouter`           | Đọc `TaskSpecV1.intent` + flags → quyết `plan_mode` + có cần clarify không.     |
| `S3ClarificationBuilder`   | Sinh `ClarificationRequestV1` (1–3 câu hỏi) nếu task còn mơ hồ.                 |
| `S3StepTypeRegistry`       | Định nghĩa các `StepTypeV1`: RETRIEVE / FETCH_DATA / COMPUTE / ACT.             |
| `S3PlanSynthesizer`        | Dựa vào intent + context → sinh `ExecutionPlanV1` (kế hoạch nhiều bước).       |
| `S3DependencyGraphBuilder` | Build DAG từ `depends_on`, tính thứ tự chạy, detect cycle.                      |
| `S3PlanNormalizer`         | Chuẩn hóa plan: reorder, dedupe step, làm plan ổn định để test.                |
| `S3PlanLintEngine`         | Static check: thiếu deps, step type không hợp lệ, thiếu expected_outputs…      |
| `S3ToolCapabilityResolver` | Check plan có khả thi với runtime + permission + tool availability không.       |
| `S3SensitiveDataScanner`   | Scan PII/credential/payment trong plan + context để gắn tag rủi ro.             |
| `S3RiskPolicyTagger`       | Dựa trên scan → thêm `GateRequirementV1` + có thể block plan.                   |
| `S3BudgetForecaster`       | Ước lượng `est_time_ms`, `est_tool_calls`, `est_tokens`.                        |
| `S3PromptPackBuilder`      | Chọn/generate `PromptPackRefV1` (pack_id, version, hash) cho Stage 4.           |
| `S3PlanSnapshotWriter`     | Lưu snapshot `PlanBundleV1` và trả `snapshot_ref`.                              |

---

### 1.3. Bảng mode thực thi A/B/C/D (PlanModeV1)

Stage 3 dùng **PlanModeV1** để quyết kiểu plan phải sinh (không phải ExecMode của Stage 4).

| Ký hiệu | `plan_mode`   | Ý nghĩa trong Stage 3 (Planning)                                                                 |
|--------|---------------|--------------------------------------------------------------------------------------------------|
| A      | `RESEARCH`    | Chỉ lập plan đọc + tóm tắt, step chủ yếu là `RETRIEVE` / `FETCH_DATA` / `COMPUTE`, **không** có `ACT`. |
| B      | `ACTION`      | Lập plan thiên về thao tác (form-fill, click…), có step `ACT`, nhưng vẫn có thể có vài step `RETRIEVE`. |
| C      | `HYBRID`      | Lập plan gồm cả phần research **và** phần action, có thứ tự rõ (research_before_action / action_then_research). |
| D      | `CLARIFY`     | Không sinh plan; chỉ sinh `ClarificationRequestV1` để hỏi lại user, `plan_status = NEEDS_CLARIFICATION`. |

---

### 1.4. Các kiểu kết thúc (PlanBundle.plan_status)

| `plan_status`            | Khi nào xảy ra?                                                                                               | Stage 4 nhận được gì?                                   |
|--------------------------|---------------------------------------------------------------------------------------------------------------|---------------------------------------------------------|
| `READY`                  | Lint OK, capability feasible, không bị policy chặn. Plan hoàn chỉnh.                                         | Có `execution_plan`, `gates`, `budget`, `prompt_pack`.  |
| `NEEDS_CLARIFICATION`    | Intent/TaskSpec mơ hồ, router yêu cầu clarify.                                                               | Không có `execution_plan`, chỉ có `clarification`.      |
| `BLOCKED_POLICY`         | Policy tagger quyết định hành vi quá rủi ro (vd: delete/transfer/payment…) nên block.                        | Có plan + gates + budget, nhưng Stage 4 không được thi công (hoặc chỉ để explain lỗi). |
| `INFEASIBLE`             | Lint ERROR (plan lỗi logic) **hoặc** capability.feasible = False (thiếu scope/tool).                         | Có `execution_plan` (để debug) + `lint`/`capability` giải thích. |

---

### 1.5. Pipeline Stage 3 (theo từng bước + module)

1. **Bước 0 – Trace / Idempotency**  
   - Module: `S3TraceContextBuilder`, helper tạo `plan_id`, `idempotency_key`…  
   - Việc: tạo trace context, gắn ID cho toàn bộ request.

2. **Bước 1 – Route mode hoặc Clarify**  
   - Module: `S3IntentRouter`, `S3ClarificationBuilder`, `S3PromptPackBuilder`.  
   - Nếu task quá mơ hồ → sinh `clarification` + prompt pack cho UI hỏi lại, trả luôn `PlanBundle` với `plan_status = NEEDS_CLARIFICATION`.

3. **Bước 2 – Build plan (PLAN branch)**  
   - Module: `S3StepTypeRegistry`, `S3PlanSynthesizer`.  
   - Dựa vào `plan_mode` + TaskSpec + ContextPack → sinh `ExecutionPlanV1` gồm list `PlanStepV1` (RETRIEVE / FETCH_DATA / COMPUTE / ACT).

4. **Bước 3 – Build DAG + Normalize**  
   - Module: `S3DependencyGraphBuilder`, `S3PlanNormalizer`.  
   - Build DAG từ `depends_on`, tính thứ tự chạy hợp lệ, reorder & dedupe step để plan sạch và ổn định.

5. **Bước 4 – Lint**  
   - Module: `S3PlanLintEngine`.  
   - Nếu có lỗi nghiêm trọng (thiếu deps, cycle, step type không hợp lệ…) → trả `PlanBundle` với `plan_status = INFEASIBLE` + kèm báo cáo lint.

6. **Bước 5 – Capability feasibility**  
   - Module: `S3ToolCapabilityResolver`.  
   - Check tool/scopes cần cho plan có tồn tại trong runtime hiện tại không. Nếu `feasible = False` → `plan_status = INFEASIBLE` (thiếu scope/tool).

7. **Bước 6 – Sensitive scan + Policy gates**  
   - Module: `S3SensitiveDataScanner`, `S3RiskPolicyTagger`.  
   - Scan dữ liệu nhạy cảm, gắn risk tags, tạo `gates` (CONFIRMATION, LOGIN, PAYMENT…). Có thể quyết định block luôn plan (`BLOCKED_POLICY`).

8. **Bước 7 – Budget + PromptPack**  
   - Module: `S3BudgetForecaster`, `S3PromptPackBuilder`.  
   - Ước lượng chi phí (time/tool_calls/tokens) và chọn `PromptPackRefV1` cho Stage 4.

9. **Bước 8 – Package + Persist**  
   - Module: build `PlanBundleV1` + `S3PlanSnapshotWriter`.  
   - Tạo PlanBundle đầy đủ (`plan_status = READY`) + lưu snapshot (phục vụ audit, replay, regression test).

---

### 1.6. Ví dụ ngắn (mode HYBRID)

**User** (đang mở trang Vietstock Datafeed) hỏi:

> “Giúp mình **nghiên cứu gói datafeed Vietstock phù hợp cho FinAI** và **điền sẵn form đăng ký (đừng submit)**.”

Giả sử Stage 2 đã trả về `TaskSpecV1` với:

- `intent = "research_then_action"`
- `entities.vendor = "Vietstock"`
- `constraints.no_submit = true`
- `risk_flags = ["external_side_effect"]`
- `permission_hints.scopes = ["search.hybrid", "browser.act"]`

Stage 3 sẽ:

1. **IntentRouter** → map sang `plan_mode = HYBRID`, không cần clarify.
2. **PlanSynthesizer** → sinh plan:
   - `s1` (RETRIEVE): đọc mô tả các gói datafeed Vietstock.
   - `s2` (FETCH_DATA): parse bảng giá/gói trên trang hiện tại.
   - `s3` (COMPUTE): so sánh gói theo nhu cầu FinAI → chọn gói chính + backup.
   - `s4` (ACT): điền sẵn form đăng ký (tôn trọng `no_submit = true`).
3. **DAG + Lint** → thứ tự `s1 → s2 → s3 → s4`, không lỗi.
4. **Capability** → scopes & tool đủ, `feasible = true`.
5. **Sensitive + Policy** → gắn gate CONFIRMATION cho step `s4`, block hành vi submit.
6. **Budget + Pack** → ước lượng chi phí + chọn PromptPack cho plan.
7. **Package** → trả `PlanBundleV1` với `plan_status = READY`, `plan_mode = HYBRID`, `execution_plan` 4 step + `gates`, `budget`, `prompt_pack_ref`…

Stage 4 sau đó chỉ việc thi công theo plan này, đi qua các gate cần thiết.

---

### 1.7. Sequence diagram (dạng ASCII/markdown)

```text
User            Stage 2              Stage 3 (run_stage3)                    Stage 4 (Executor)
 |                |                            |                                     |
 | -- query ----> |                            |                                     |
 |                | -- ContextPack+TaskSpec -->|                                     |
 |                |                            |                                     |
 |                |                            |-- S3TraceContextBuilder ---------->|
 |                |                            |   (trace_id, plan_id, idem_key)    |
 |                |                            |                                     |
 |                |                            |-- S3IntentRouter ------------------|
 |                |                            |   (decide plan_mode)               |
 |                |                            |                                     |
 |                |                            |--(if CLARIFY) S3ClarificationBuilder
 |                |                            |        |                            |
 |                |                            |<-- PlanBundle(NEEDS_CLARIFICATION) |
 |                |                            |                                     |
 |                |                            |--(else PLAN branch)----------------|
 |                |                            |   S3StepTypeRegistry               |
 |                |                            |   S3PlanSynthesizer                |
 |                |                            |   -> ExecutionPlanV1               |
 |                |                            |                                     |
 |                |                            |-- S3DependencyGraphBuilder         |
 |                |                            |-- S3PlanNormalizer                 |
 |                |                            |-- S3PlanLintEngine                 |
 |                |                            |   (lint ok?)                       |
 |                |                            |                                     |
 |                |                            |-- S3ToolCapabilityResolver         |
 |                |                            |   (feasible?)                      |
 |                |                            |                                     |
 |                |                            |-- S3SensitiveDataScanner           |
 |                |                            |-- S3RiskPolicyTagger               |
 |                |                            |   (gates / blocked?)               |
 |                |                            |                                     |
 |                |                            |-- S3BudgetForecaster               |
 |                |                            |-- S3PromptPackBuilder              |
 |                |                            |                                     |
 |                |                            |-- S3PlanSnapshotWriter             |
 |                |                            |   -> snapshot_ref                  |
 |                |                            |                                     |
 |                |                            |--> PlanBundleV1(READY / BLOCKED / INFEASIBLE)
 |                |                            |                                     |
 |                |                            |-------------------------------> Stage 4 dùng `execution_plan`
```

# STAGE 3 — Planning & Plan Packaging (Comet-like Agentic Browser)  
**Role:** Staff/Principal Software Architect + Tech Lead  
**Scope:** Stage 3 only (nhận `ContextPackV1` + `TaskSpecV1` → trả `PlanBundleV1`).  
**Hard rule:** Stage 3 **KHÔNG** thực thi tool thật (no web search thật / no automation thật). Chỉ **plan + validate + package**.

---

## 1) Diagram ASCII pipeline Stage 3

```text
                         +------------------------------------+
                         |  INPUT: ContextPackV1 + TaskSpecV1 |
                         +------------------+-----------------+
                                            |
                                            v
+-----------------------------------+   +------------------------------+
| S3TraceContextBuilder             |-->| trace_id/span_id/request_id  |
| - build trace context             |   | attach to all outputs        |
+-----------------------------------+   +------------------------------+
                                            |
                                            v
+-----------------------------------+
| S3IntentRouter                    |
| - decide plan_mode:               |
|   RESEARCH | ACTION | HYBRID |    |
|   CLARIFY                         |
+------------------+----------------+
                   |
      +------------+------------+
      |                         |
      v                         v
+--------------------+   +------------------------------------+
| CLARIFY branch      |   | PLAN branch                        |
| S3Clarification...  |   | S3StepTypeRegistry                 |
| -> ClarificationReq |   | S3PlanSynthesizer -> ExecutionPlan |
+----------+---------+   +------------------+------------------+
           |                                |
           v                                v
+--------------------------+      +-----------------------------+
| PlanBundleV1             |      | S3DependencyGraphBuilder    |
| plan_status=NEEDS_...    |      | - build DAG, detect cycles  |
+--------------------------+      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3PlanNormalizer            |
                                      | - dedupe/reorder/ids/deps   |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3PlanLintEngine            |
                                      | - static checks             |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3ToolCapabilityResolver    |
                                      | - feasible vs env/perms     |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3SensitiveDataScanner      |
                                      | - detect/tag PII/creds/...  |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3RiskPolicyTagger          |
                                      | - risk tags + gates/block   |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3BudgetForecaster          |
                                      | - estimate time/tokens/calls|
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3PromptPackBuilder         |
                                      | - versioned prompt refs     |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | S3PlanSnapshotWriter        |
                                      | - persist + idempotency key |
                                      +--------------+--------------+
                                                 |
                                                 v
                                      +-----------------------------+
                                      | OUTPUT: PlanBundleV1        |
                                      | READY/BLOCKED/INFEASIBLE... |
                                      +-----------------------------+
```

---

## 2) Contracts (pydantic pseudo-code)

> Ghi chú: Đây là “pydantic-style” gần code thật. Ở MVP có thể dùng `pydantic.BaseModel` hoặc `dataclasses + jsonschema` miễn hợp đồng dữ liệu tương đương.  
> **Naming rule:** Class bắt đầu bằng `S3*` cho module; contracts có hậu tố `V1` và **bắt buộc** `schema_version`.

### 2.1 Core input contracts (tối thiểu để Stage 3 chạy)

```python
# stages/stage3/contracts/stage3_inputs.py

from typing import Any, Dict, List, Literal, Optional
from pydantic import BaseModel, Field

class ContextPackV1(BaseModel):
    schema_version: str = Field(default="ContextPackV1@1")
    context_id: str
    user_session_id: Optional[str] = None

    # tab context (MVP)
    active_tab_url: Optional[str] = None
    active_tab_title: Optional[str] = None
    selection_text: Optional[str] = None
    dom_snapshot_ref: Optional[str] = None  # reference only, not raw DOM

    # attachments (refs only)
    attachment_refs: List[str] = Field(default_factory=list)

    # runtime env + prefs
    runtime: Dict[str, Any] = Field(default_factory=dict)  # browser_id, locale, device...
    user_prefs: Dict[str, Any] = Field(default_factory=dict)  # e.g., language, style


class TaskSpecV1(BaseModel):
    schema_version: str = Field(default="TaskSpecV1@1")
    task_id: str
    user_query: str

    # high-level intent from Stage 2
    intent: Literal[
        "research", "action", "research_then_action", "action_then_research", "unknown"
    ] = "unknown"

    # entities/constraints from Stage 2
    entities: Dict[str, Any] = Field(default_factory=dict)      # e.g., {"vendor":"Vietstock"}
    constraints: Dict[str, Any] = Field(default_factory=dict)   # e.g., {"no_submit": True}
    domain_hint: Optional[str] = None                           # e.g., "finance"
    risk_flags: List[str] = Field(default_factory=list)         # e.g., ["payment", "pii"]

    # tool/permission hints from Stage 2
    tool_hints: Dict[str, Any] = Field(default_factory=dict)    # e.g., {"prefer_web_automation": True}
    permission_hints: Dict[str, Any] = Field(default_factory=dict)  # e.g., {"scopes":["browser.act"]}
```

### 2.2 Stage 3 output contracts

```python
# stages/stage3/contracts/stage3_outputs.py

from typing import Any, Dict, List, Literal, Optional
from pydantic import BaseModel, Field, conint

PlanModeV1 = Literal["RESEARCH", "ACTION", "HYBRID", "CLARIFY"]
PlanStatusV1 = Literal["READY", "NEEDS_CLARIFICATION", "BLOCKED_POLICY", "INFEASIBLE"]

StepTypeV1 = Literal["RETRIEVE", "FETCH_DATA", "COMPUTE", "ACT"]  # aligns with Stage 4 bricks

class BudgetSpecV1(BaseModel):
    schema_version: str = Field(default="BudgetSpecV1@1")
    max_time_ms: conint(ge=1000) = 60000
    max_tool_calls: conint(ge=0) = 20
    max_tokens_est: conint(ge=0) = 12000
    est_time_ms: int = 0
    est_tool_calls: int = 0
    est_tokens: int = 0
    notes: List[str] = Field(default_factory=list)

class GateRequirementV1(BaseModel):
    schema_version: str = Field(default="GateRequirementV1@1")
    gate_id: str
    gate_type: Literal["CONFIRMATION", "RESTRICTED_ACTION", "PII_HANDLING", "PAYMENT", "LOGIN"]

    # what triggers this gate
    reason: str
    step_id: Optional[str] = None
    required_user_action: Optional[Literal["CONFIRM", "PROVIDE_CREDENTIALS", "APPROVE_PAYMENT"]] = None

    # enforcement knobs
    blocked_actions: List[Literal["submit", "purchase", "delete", "send_email", "share_data"]] = Field(default_factory=list)
    requires_user_confirm: bool = False
    severity: Literal["LOW", "MEDIUM", "HIGH", "CRITICAL"] = "MEDIUM"

class ClarificationQuestionV1(BaseModel):
    schema_version: str = Field(default="ClarificationQuestionV1@1")
    qid: str
    question: str
    expected_answer_schema: Dict[str, Any] = Field(default_factory=dict)  # JSON schema fragment
    merge_hint: str = ""  # how to merge back into TaskSpecV1

class ClarificationRequestV1(BaseModel):
    schema_version: str = Field(default="ClarificationRequestV1@1")
    clarification_id: str
    questions: List[ClarificationQuestionV1]
    rationale: str
    blocking_fields: List[str] = Field(default_factory=list)

class CapabilityToolV1(BaseModel):
    schema_version: str = Field(default="CapabilityToolV1@1")
    tool_name: str                       # e.g., "search.hybrid", "browser.act"
    available: bool
    missing_scopes: List[str] = Field(default_factory=list)
    rate_limit_profile: Optional[str] = None  # e.g., "low/med/high"
    notes: List[str] = Field(default_factory=list)

class CapabilityReportV1(BaseModel):
    schema_version: str = Field(default="CapabilityReportV1@1")
    feasible: bool = True
    tools: List[CapabilityToolV1] = Field(default_factory=list)
    missing_capabilities: List[str] = Field(default_factory=list)
    reasons: List[str] = Field(default_factory=list)

class PlanLintIssueV1(BaseModel):
    schema_version: str = Field(default="PlanLintIssueV1@1")
    code: str                    # e.g., "S3LINT.CYCLE", "S3LINT.MISSING_OUTPUTS"
    severity: Literal["INFO", "WARN", "ERROR"]
    message: str
    step_id: Optional[str] = None
    details: Dict[str, Any] = Field(default_factory=dict)

class PlanLintReportV1(BaseModel):
    schema_version: str = Field(default="PlanLintReportV1@1")
    ok: bool = True
    issues: List[PlanLintIssueV1] = Field(default_factory=list)
    summary: Dict[str, int] = Field(default_factory=dict)  # counts by severity

class PromptPackRefV1(BaseModel):
    schema_version: str = Field(default="PromptPackRefV1@1")
    pack_id: str
    version: str  # e.g., "2025-12-10.1"
    templates: Dict[str, str] = Field(default_factory=dict)  # key -> template_ref or inline id
    hash: str = ""  # to ensure immutability

class PlanStepV1(BaseModel):
    schema_version: str = Field(default="PlanStepV1@1")
    step_id: str
    step_type: StepTypeV1
    name: str

    # planned IO (not executed)
    inputs: Dict[str, Any] = Field(default_factory=dict)
    expected_outputs: Dict[str, Any] = Field(default_factory=dict)  # schema-ish: keys + types + constraints

    depends_on: List[str] = Field(default_factory=list)
    tool_hints: Dict[str, Any] = Field(default_factory=dict)

    # policy & risk tags (assigned in Stage 3)
    risk_tags: List[str] = Field(default_factory=list)
    gate_ids: List[str] = Field(default_factory=list)  # gate(s) required before executing this step

class ExecutionPlanV1(BaseModel):
    schema_version: str = Field(default="ExecutionPlanV1@1")
    plan_id: str
    plan_mode: PlanModeV1

    steps: List[PlanStepV1]
    topological_order_hint: List[str] = Field(default_factory=list)  # computed by DAG builder

    # explainability for dev & QA
    reason_codes: List[str] = Field(default_factory=list)

class PlanBundleV1(BaseModel):
    schema_version: str = Field(default="PlanBundleV1@1")
    trace_id: str
    span_id: str
    request_id: str
    plan_id: str

    plan_status: PlanStatusV1
    plan_mode: PlanModeV1

    execution_plan: Optional[ExecutionPlanV1] = None
    clarification: Optional[ClarificationRequestV1] = None

    gates: List[GateRequirementV1] = Field(default_factory=list)
    budget: BudgetSpecV1
    capability: CapabilityReportV1
    lint: PlanLintReportV1
    prompt_pack_ref: PromptPackRefV1

    # persistence / idempotency
    idempotency_key: str = ""
    snapshot_ref: Optional[str] = None

    # telemetry-friendly
    tags: Dict[str, str] = Field(default_factory=dict)
```

### 2.3 Lint + Capability + PromptPack versioning rules (MVP)
- `PromptPackRefV1.hash` = SHA256 của toàn bộ template refs (hoặc payload template) + version.  
- `PlanBundleV1.idempotency_key` = hash(`context_id` + `task_id` + `task_spec.user_query` + stable fields).  
- `PlanLintReportV1.ok = False` nếu có bất kỳ issue severity=ERROR.

---

## 3) Folder structure Stage 3 (bắt buộc)

```text
backend/
  stages/
    stage3/
      stage3_entrypoint.py              # run_stage3() entrypoint (orchestrator)
      README.md                         # how to run/test Stage 3
      contracts/
        stage3_inputs.py                # ContextPackV1, TaskSpecV1 (thin)
        stage3_outputs.py               # ExecutionPlanV1, PlanBundleV1, ...
        stage3_errors.py                # S3*Error taxonomy
      core/
        stage3_types.py                 # enums/constants shared
        stage3_utils.py                 # hashing, id generation, helpers
      observability/
        stage3_trace.py                 # S3TraceContextBuilder + log helpers
      modules/
        stage3_intent_router.py         # S3IntentRouter
        stage3_clarification_builder.py # S3ClarificationBuilder
        stage3_step_registry.py         # S3StepTypeRegistry
        stage3_plan_synthesizer.py      # S3PlanSynthesizer
        stage3_dependency_graph.py      # S3DependencyGraphBuilder
        stage3_plan_normalizer.py       # S3PlanNormalizer
        stage3_plan_lint_engine.py      # S3PlanLintEngine
        stage3_tool_capability.py       # S3ToolCapabilityResolver
        stage3_sensitive_scanner.py     # S3SensitiveDataScanner
        stage3_risk_policy_tagger.py    # S3RiskPolicyTagger
        stage3_budget_forecaster.py     # S3BudgetForecaster
        stage3_prompt_pack_builder.py   # S3PromptPackBuilder
        stage3_plan_snapshot_writer.py  # S3PlanSnapshotWriter
        stage3_plan_variant_selector.py # (Optional P1) S3PlanVariantSelector
      stores/
        stage3_plan_store.py            # persistence interface (DB/file/redis)
      fixtures/
        input_context_task__happy.json
        input_context_task__ambiguous.json
        golden_planbundle__ready.json
        golden_planbundle__clarify.json
      tests/
        test_stage3_entrypoint.py
        test_stage3_intent_router.py
        test_stage3_plan_synthesizer.py
        test_stage3_dependency_graph.py
        test_stage3_plan_lint_engine.py
        test_stage3_tool_capability.py
        test_stage3_risk_policy_tagger.py
        test_stage3_budget_forecaster.py
        test_stage3_golden_outputs.py
```

**Mô tả ngắn**
- `contracts/`: chuẩn hoá dữ liệu vào/ra. QA & integration dựa vào đây.  
- `modules/`: mỗi module Stage 3 = 1 file/class riêng, naming `S3*`.  
- `observability/`: trace/log helpers, thống nhất field.  
- `stores/`: persistence abstraction cho snapshot/idempotency.  
- `fixtures/`: input mẫu + golden output (regression).  
- `tests/`: unit/integration/golden tests.

---

## 4) Pseudo-code orchestrator `run_stage3`

```python
# stages/stage3/stage3_entrypoint.py

from typing import Tuple
from stages.stage3.contracts.stage3_inputs import ContextPackV1, TaskSpecV1
from stages.stage3.contracts.stage3_outputs import (
    PlanBundleV1, ExecutionPlanV1, PlanLintReportV1, CapabilityReportV1, BudgetSpecV1,
    PromptPackRefV1, ClarificationRequestV1
)
from stages.stage3.contracts.stage3_errors import (
    S3UserError, S3PolicyError, S3CapabilityError, S3DataError
)

from stages.stage3.observability.stage3_trace import S3TraceContextBuilder
from stages.stage3.modules.stage3_intent_router import S3IntentRouter
from stages.stage3.modules.stage3_clarification_builder import S3ClarificationBuilder
from stages.stage3.modules.stage3_step_registry import S3StepTypeRegistry
from stages.stage3.modules.stage3_plan_synthesizer import S3PlanSynthesizer
from stages.stage3.modules.stage3_dependency_graph import S3DependencyGraphBuilder
from stages.stage3.modules.stage3_plan_normalizer import S3PlanNormalizer
from stages.stage3.modules.stage3_plan_lint_engine import S3PlanLintEngine
from stages.stage3.modules.stage3_tool_capability import S3ToolCapabilityResolver
from stages.stage3.modules.stage3_sensitive_scanner import S3SensitiveDataScanner
from stages.stage3.modules.stage3_risk_policy_tagger import S3RiskPolicyTagger
from stages.stage3.modules.stage3_budget_forecaster import S3BudgetForecaster
from stages.stage3.modules.stage3_prompt_pack_builder import S3PromptPackBuilder
from stages.stage3.modules.stage3_plan_snapshot_writer import S3PlanSnapshotWriter

from stages.stage3.core.stage3_utils import s3_hash_idempotency_key, s3_new_plan_id

def run_stage3(context_pack: ContextPackV1, task_spec: TaskSpecV1) -> PlanBundleV1:
    # -------------------------
    # 0) Observability context
    # -------------------------
    trace_ctx = S3TraceContextBuilder().build(context_pack=context_pack, task_spec=task_spec)
    # trace_ctx: {trace_id, span_id, request_id, user_session_id,...}

    plan_id = s3_new_plan_id(trace_ctx=trace_ctx, task_spec=task_spec)
    idem_key = s3_hash_idempotency_key(context_pack=context_pack, task_spec=task_spec)

    # baseline reports (filled later)
    lint = PlanLintReportV1(ok=True, issues=[], summary={})
    capability = CapabilityReportV1(feasible=True, tools=[], missing_capabilities=[], reasons=[])
    budget = BudgetSpecV1(est_time_ms=0, est_tool_calls=0, est_tokens=0, notes=[])
    prompt_ref = PromptPackRefV1(pack_id="s3.default", version="unset", templates={}, hash="")

    # -------------------------
    # 1) Route mode or clarify
    # -------------------------
    router = S3IntentRouter()
    route = router.route(context_pack=context_pack, task_spec=task_spec, trace_ctx=trace_ctx)
    # route: {plan_mode, reason_codes, requires_clarification, clarify_signals}

    if route.plan_mode == "CLARIFY" or route.requires_clarification:
        clarification = S3ClarificationBuilder().build(
            context_pack=context_pack,
            task_spec=task_spec,
            route=route,
            trace_ctx=trace_ctx
        )
        prompt_ref = S3PromptPackBuilder().build_for_clarify(trace_ctx=trace_ctx)

        bundle = PlanBundleV1(
            trace_id=trace_ctx.trace_id,
            span_id=trace_ctx.span_id,
            request_id=trace_ctx.request_id,
            plan_id=plan_id,
            plan_status="NEEDS_CLARIFICATION",
            plan_mode="CLARIFY",
            execution_plan=None,
            clarification=clarification,
            gates=[],
            budget=budget,
            capability=capability,
            lint=lint,
            prompt_pack_ref=prompt_ref,
            idempotency_key=idem_key,
            tags={"module":"stage3", "event":"plan_built", "status":"NEEDS_CLARIFICATION"}
        )
        # Persist snapshot (optional but recommended for replan loop)
        bundle.snapshot_ref = S3PlanSnapshotWriter().write(bundle=bundle, trace_ctx=trace_ctx)
        return bundle

    # -------------------------
    # 2) Build plan (no execution)
    # -------------------------
    registry = S3StepTypeRegistry().default_registry()
    synthesizer = S3PlanSynthesizer(step_registry=registry)

    plan: ExecutionPlanV1 = synthesizer.synthesize(
        plan_id=plan_id,
        plan_mode=route.plan_mode,      # RESEARCH/ACTION/HYBRID
        context_pack=context_pack,
        task_spec=task_spec,
        route=route,
        trace_ctx=trace_ctx
    )

    # -------------------------
    # 3) Build DAG + normalize
    # -------------------------
    dag = S3DependencyGraphBuilder().build(plan=plan, trace_ctx=trace_ctx)
    plan.topological_order_hint = dag.topological_order

    plan = S3PlanNormalizer().normalize(plan=plan, dag=dag, trace_ctx=trace_ctx)

    # -------------------------
    # 4) Lint (static correctness)
    # -------------------------
    lint = S3PlanLintEngine(step_registry=registry).lint(plan=plan, dag=dag, trace_ctx=trace_ctx)

    # If lint has ERROR-level issues → treat as INFEASIBLE (unless clarified fallback)
    if not lint.ok:
        prompt_ref = S3PromptPackBuilder().build_for_error(trace_ctx=trace_ctx)
        bundle = PlanBundleV1(
            trace_id=trace_ctx.trace_id,
            span_id=trace_ctx.span_id,
            request_id=trace_ctx.request_id,
            plan_id=plan_id,
            plan_status="INFEASIBLE",
            plan_mode=route.plan_mode,
            execution_plan=plan,
            clarification=None,
            gates=[],
            budget=budget,
            capability=capability,
            lint=lint,
            prompt_pack_ref=prompt_ref,
            idempotency_key=idem_key,
            tags={"module":"stage3", "event":"plan_lint_failed", "status":"INFEASIBLE"}
        )
        bundle.snapshot_ref = S3PlanSnapshotWriter().write(bundle=bundle, trace_ctx=trace_ctx)
        return bundle

    # -------------------------
    # 5) Capability feasibility
    # -------------------------
    capability = S3ToolCapabilityResolver().resolve(plan=plan, context_pack=context_pack, task_spec=task_spec, trace_ctx=trace_ctx)
    if not capability.feasible:
        prompt_ref = S3PromptPackBuilder().build_for_infeasible(trace_ctx=trace_ctx)
        bundle = PlanBundleV1(
            trace_id=trace_ctx.trace_id,
            span_id=trace_ctx.span_id,
            request_id=trace_ctx.request_id,
            plan_id=plan_id,
            plan_status="INFEASIBLE",
            plan_mode=route.plan_mode,
            execution_plan=plan,
            clarification=None,
            gates=[],
            budget=budget,
            capability=capability,
            lint=lint,
            prompt_pack_ref=prompt_ref,
            idempotency_key=idem_key,
            tags={"module":"stage3", "event":"capability_infeasible", "status":"INFEASIBLE"}
        )
        bundle.snapshot_ref = S3PlanSnapshotWriter().write(bundle=bundle, trace_ctx=trace_ctx)
        return bundle

    # -------------------------
    # 6) Sensitive scan + policy gates
    # -------------------------
    scan = S3SensitiveDataScanner().scan(context_pack=context_pack, task_spec=task_spec, plan=plan, trace_ctx=trace_ctx)
    # scan: {tags, findings}

    policy = S3RiskPolicyTagger().tag_and_gate(plan=plan, scan=scan, context_pack=context_pack, task_spec=task_spec, trace_ctx=trace_ctx)
    # policy: {updated_plan, gates, blocked}
    plan = policy.updated_plan
    gates = policy.gates

    if policy.blocked:
        prompt_ref = S3PromptPackBuilder().build_for_policy_block(trace_ctx=trace_ctx)
        budget = S3BudgetForecaster().forecast(plan=plan, trace_ctx=trace_ctx)  # still useful
        bundle = PlanBundleV1(
            trace_id=trace_ctx.trace_id,
            span_id=trace_ctx.span_id,
            request_id=trace_ctx.request_id,
            plan_id=plan_id,
            plan_status="BLOCKED_POLICY",
            plan_mode=route.plan_mode,
            execution_plan=plan,
            clarification=None,
            gates=gates,
            budget=budget,
            capability=capability,
            lint=lint,
            prompt_pack_ref=prompt_ref,
            idempotency_key=idem_key,
            tags={"module":"stage3", "event":"policy_blocked", "status":"BLOCKED_POLICY"}
        )
        bundle.snapshot_ref = S3PlanSnapshotWriter().write(bundle=bundle, trace_ctx=trace_ctx)
        return bundle

    # -------------------------
    # 7) Budget + prompt pack
    # -------------------------
    budget = S3BudgetForecaster().forecast(plan=plan, trace_ctx=trace_ctx)
    prompt_ref = S3PromptPackBuilder().build_for_plan(plan=plan, trace_ctx=trace_ctx)

    # -------------------------
    # 8) Package + persist
    # -------------------------
    bundle = PlanBundleV1(
        trace_id=trace_ctx.trace_id,
        span_id=trace_ctx.span_id,
        request_id=trace_ctx.request_id,
        plan_id=plan_id,
        plan_status="READY",
        plan_mode=route.plan_mode,
        execution_plan=plan,
        clarification=None,
        gates=gates,
        budget=budget,
        capability=capability,
        lint=lint,
        prompt_pack_ref=prompt_ref,
        idempotency_key=idem_key,
        tags={"module":"stage3", "event":"plan_ready", "status":"READY"}
    )
    bundle.snapshot_ref = S3PlanSnapshotWriter().write(bundle=bundle, trace_ctx=trace_ctx)
    return bundle
```

**Bảo đảm “Stage 3 không thực thi tool thật” (P0)**
- `run_stage3()` **không import** tool adapters của Stage 4.  
- `S3ToolCapabilityResolver` chỉ đọc **metadata** runtime/perms, không gọi tool.  
- Có unit test “no network / no automation calls” (xem mục test).

---

## 5) Module-by-module breakdown (Goal / Why / I/O / Failure / Telemetry)

> Logging fields chuẩn (bắt buộc trong mọi module):  
`trace_id`, `span_id`, `plan_id`, `step_id` (nếu có), `module`, `event`.

### 5.1 Observability / Context

#### `S3TraceContextBuilder` (file: `stage3_trace.py`)
- **Goal:** tạo & propagate `trace_id`, `span_id`, `request_id`, `user_session_id`.  
- **Why:** debug “tại sao plan này sinh ra như vậy” + correlate logs across services.  
- **I/O:**
  - In: `ContextPackV1`, `TaskSpecV1`
  - Out: `trace_ctx` object `{trace_id, span_id, request_id, user_session_id}`
- **Failure modes:**
  - Missing context_id/task_id → tạo fallback ids, log WARN.
- **Telemetry (min):**
  - event=`trace_context_built`, fields: trace_id/span_id/request_id/user_session_id/context_id/task_id.

---

### 5.2 Routing / Clarify

#### `S3IntentRouter` (file: `stage3_intent_router.py`)
- **Goal:** quyết định `plan_mode`: `RESEARCH | ACTION | HYBRID | CLARIFY`.  
- **Why:** Stage 4 executor chỉ chạy theo plan; nếu route sai → tốn cost hoặc làm sai.  
- **I/O:**
  - In: `ContextPackV1`, `TaskSpecV1`, `trace_ctx`
  - Out: `S3RouteDecision` (internal): `{plan_mode, reason_codes, requires_clarification, clarify_signals}`
- **Failure modes & handling:**
  - Intent “unknown” + thiếu entities/constraints → route `CLARIFY`.
  - Conflicting constraints (e.g., “submit” + “no_submit”) → route `CLARIFY`.
- **Telemetry:**
  - event=`intent_routed`, fields: plan_mode, reason_codes, risk_flags_count, has_action_verbs, has_research_verbs.

#### `S3ClarificationBuilder` (file: `stage3_clarification_builder.py`)
- **Goal:** tạo `ClarificationRequestV1` (câu hỏi làm rõ + expected answer schema + merge hint).  
- **Why:** thay vì đoán bừa, hỏi đúng “1–3 câu” để unblock.  
- **I/O:**
  - In: `ContextPackV1`, `TaskSpecV1`, `route`, `trace_ctx`
  - Out: `ClarificationRequestV1`
- **Failure modes:**
  - Quá nhiều câu hỏi → giới hạn `max_questions=3`, ưu tiên blocking fields.
- **Telemetry:**
  - event=`clarification_built`, fields: clarification_id, num_questions, blocking_fields.

---

### 5.3 Plan synthesis & typing

#### `S3StepTypeRegistry` (file: `stage3_step_registry.py`)
- **Goal:** registry cho `step_type` + schema IO + allowed tools per type.  
- **Why:** chống “step type tự phát” và đảm bảo plan có kiểu dữ liệu rõ ràng.  
- **I/O:**
  - In: none (build registry) / validate step
  - Out: registry object + method `validate_step_io(step)`
- **Failure modes:**
  - Unknown step_type → raise `S3DataError(code="S3REG.UNKNOWN_STEP_TYPE")`.
- **Telemetry:**
  - event=`step_registry_loaded`, fields: step_types=[...], registry_version.

#### `S3PlanSynthesizer` (file: `stage3_plan_synthesizer.py`)
- **Goal:** sinh `ExecutionPlanV1` + `PlanStepV1[]` theo mode.  
- **Why:** “đề bài” → “kịch bản chạy” có cấu trúc, deterministic & testable.  
- **I/O:**
  - In: `ContextPackV1`, `TaskSpecV1`, `route`, `step_registry`
  - Out: `ExecutionPlanV1`
- **Failure modes:**
  - Thiếu URL nhưng cần ACT navigate → hoặc add clarification signal, hoặc degrade to RESEARCH.
  - Missing required outputs per downstream dep → registry validation fails → lint catches.
- **Telemetry:**
  - event=`plan_synthesized`, fields: plan_id, mode, num_steps, reason_codes.

---

### 5.4 Graph / Normalize / Lint

#### `S3DependencyGraphBuilder` (file: `stage3_dependency_graph.py`)
- **Goal:** build DAG từ `depends_on`, detect cycles, compute topo order hint.  
- **Why:** Stage 4 executor cần thứ tự hợp lệ; cycle = plan không chạy được.  
- **I/O:**
  - In: `ExecutionPlanV1`
  - Out: `S3DAG` (internal): `{topological_order, has_cycle, cycle_path}`
- **Failure modes:**
  - Cycle detected → add lint issue `S3LINT.CYCLE` severity=ERROR.
- **Telemetry:**
  - event=`dag_built`, fields: num_nodes, num_edges, has_cycle.

#### `S3PlanNormalizer` (file: `stage3_plan_normalizer.py`)
- **Goal:** chuẩn hóa plan: ids, dedupe, reorder, add missing deps “hợp lý”.  
- **Why:** giúp plan ổn định (golden tests) và tránh step thừa.  
- **I/O:**
  - In: `ExecutionPlanV1`, `S3DAG`
  - Out: normalized `ExecutionPlanV1`
- **Failure modes:**
  - Over-merge làm mất semantics → chỉ merge khi same step_type + same inputs hash.
- **Telemetry:**
  - event=`plan_normalized`, fields: steps_before, steps_after, merges, reorder_applied.

#### `S3PlanLintEngine` (file: `stage3_plan_lint_engine.py`)
- **Goal:** static checks: missing deps, cycle double-check, ambiguous inputs, forbidden types, missing outputs.  
- **Why:** catch lỗi sớm trước Stage 4 (giảm bug & risk).  
- **I/O:**
  - In: `ExecutionPlanV1`, `S3DAG`, `S3StepTypeRegistry`
  - Out: `PlanLintReportV1`
- **Failure modes:**
  - Lint engine crash → mark `ok=False`, add issue `S3LINT.INTERNAL_ERROR`.
- **Telemetry:**
  - event=`plan_linted`, fields: ok, issue_counts_by_severity.

---

### 5.5 Feasibility / Risk / Policy

#### `S3ToolCapabilityResolver` (file: `stage3_tool_capability.py`)
- **Goal:** check plan khả thi theo runtime env + permissions + tool availability + rate limits.  
- **Why:** plan đẹp nhưng tool không có thì Stage 4 fail.  
- **I/O:**
  - In: `ExecutionPlanV1`, `ContextPackV1`, `TaskSpecV1`
  - Out: `CapabilityReportV1`
- **Failure modes:**
  - Missing scope cho ACT → `feasible=False`, reasons add “missing browser.act scope”.
- **Telemetry:**
  - event=`capability_resolved`, fields: feasible, missing_capabilities, missing_scopes_count.

#### `S3SensitiveDataScanner` (file: `stage3_sensitive_scanner.py`)
- **Goal:** detect/tag PII/credentials/payment/critical actions trong yêu cầu & step inputs.  
- **Why:** risk/policy gating cần “nhãn” trước khi executor làm gì.  
- **I/O:**
  - In: `ContextPackV1`, `TaskSpecV1`, `ExecutionPlanV1`
  - Out: internal scan report `{tags, findings}`
- **Failure modes:**
  - False positives → severity thấp, chỉ tag, không redact.
- **Telemetry:**
  - event=`sensitive_scan_done`, fields: tags, findings_count.

#### `S3RiskPolicyTagger` (file: `stage3_risk_policy_tagger.py`)
- **Goal:** gắn risk tags + tạo `GateRequirementV1` + (optional) block plan.  
- **Why:** đảm bảo không “click bừa” vào login/payment/submit.  
- **I/O:**
  - In: `ExecutionPlanV1`, scan report, `ContextPackV1`, `TaskSpecV1`
  - Out: `{updated_plan, gates, blocked}`
- **Failure modes:**
  - Policy config missing → default conservative: add confirmation gate for ACT.
- **Telemetry:**
  - event=`policy_tagged`, fields: num_gates, blocked, highest_severity.

---

### 5.6 Budget / Prompts / Persist

#### `S3BudgetForecaster` (file: `stage3_budget_forecaster.py`)
- **Goal:** ước lượng tokens/time/tool_calls theo step + mode.  
- **Why:** tránh “đào vô tận”; giúp UI hiển thị dự trù.  
- **I/O:**
  - In: `ExecutionPlanV1`
  - Out: `BudgetSpecV1`
- **Failure modes:**
  - Unknown cost model → fallback heuristics, notes append.
- **Telemetry:**
  - event=`budget_forecasted`, fields: est_time_ms, est_tool_calls, est_tokens.

#### `S3PromptPackBuilder` (file: `stage3_prompt_pack_builder.py`)
- **Goal:** tạo prompt templates/packs versioned, attach ref vào PlanBundle.  
- **Why:** reproducibility (plan build = deterministic given prompt pack).  
- **I/O:**
  - In: `trace_ctx` (+ optional plan)
  - Out: `PromptPackRefV1`
- **Failure modes:**
  - Missing template → fallback pack “s3.default”.
- **Telemetry:**
  - event=`prompt_pack_built`, fields: pack_id, version, hash.

#### `S3PlanSnapshotWriter` (file: `stage3_plan_snapshot_writer.py`)
- **Goal:** persist PlanBundle + trace context + hashes/idempotency key.  
- **Why:** audit + replan loop + debug/regression.  
- **I/O:**
  - In: `PlanBundleV1`, `trace_ctx`
  - Out: `snapshot_ref` string
- **Failure modes:**
  - Store unavailable → log ERROR, nhưng vẫn return bundle (snapshot_ref=None) cho MVP.
- **Telemetry:**
  - event=`plan_snapshot_written`, fields: snapshot_ref, idempotency_key.

---

### 5.7 Optional (P1) — `S3PlanVariantSelector`
- **Goal:** generate N plan variants + score (cost/risk/coverage) → chọn best.  
- **Why:** giúp tối ưu tradeoff (nhưng MVP có thể bỏ).  
- **MVP stance:** **P1 optional**. Nếu chưa làm: nêu rõ “not implemented” và route luôn 1 plan.

---

## 6) Ví dụ input/output JSON (2 case)

### 6.1 Example input (ContextPackV1 + TaskSpecV1) — ngắn gọn nhưng thực tế

```json
{
  "context_pack": {
    "schema_version": "ContextPackV1@1",
    "context_id": "ctx_001",
    "user_session_id": "sess_abc",
    "active_tab_url": "https://dichvu.vietstock.vn/du-lieu-tai-chinh/datafeed---du-lieu-tai-chinh-tich-hop-chuyen-nghiep",
    "active_tab_title": "Vietstock Datafeed",
    "selection_text": "",
    "dom_snapshot_ref": "domref_9f1d",
    "attachment_refs": [],
    "runtime": {"browser_id": "brw_01", "locale": "vi-VN"},
    "user_prefs": {"language": "vi"}
  },
  "task_spec": {
    "schema_version": "TaskSpecV1@1",
    "task_id": "tsk_001",
    "user_query": "Nghiên cứu gói datafeed Vietstock phù hợp cho FinAI và điền sẵn form đăng ký (đừng submit).",
    "intent": "research_then_action",
    "entities": {"vendor": "Vietstock"},
    "constraints": {"must_have_citations": true, "no_submit": true},
    "domain_hint": "finance",
    "risk_flags": ["external_side_effect"],
    "tool_hints": {"prefer_web_automation": true},
    "permission_hints": {"scopes": ["search.hybrid", "browser.act"]}
  }
}
```

---

### 6.2 Output Case A — đủ dữ liệu → `plan_status="READY"` + có execution_plan

```json
{
  "schema_version": "PlanBundleV1@1",
  "trace_id": "tr_9c2a",
  "span_id": "sp_01",
  "request_id": "rq_77",
  "plan_id": "plan_001",
  "plan_status": "READY",
  "plan_mode": "HYBRID",
  "execution_plan": {
    "schema_version": "ExecutionPlanV1@1",
    "plan_id": "plan_001",
    "plan_mode": "HYBRID",
    "steps": [
      {
        "schema_version": "PlanStepV1@1",
        "step_id": "s1",
        "step_type": "RETRIEVE",
        "name": "Retrieve licensing/pricing evidence",
        "inputs": {"query_roles": ["official", "data"], "top_k": 8},
        "expected_outputs": {"evidence_items": {"type": "array", "min_items": 3}},
        "depends_on": [],
        "tool_hints": {"search_mode": "hybrid"},
        "risk_tags": [],
        "gate_ids": []
      },
      {
        "schema_version": "PlanStepV1@1",
        "step_id": "s2",
        "step_type": "FETCH_DATA",
        "name": "Parse packages table",
        "inputs": {"source": "active_tab", "table_target": "pricing"},
        "expected_outputs": {"packages_table": {"type": "table", "min_rows": 1}},
        "depends_on": ["s1"],
        "tool_hints": {"parser": "html_table"},
        "risk_tags": [],
        "gate_ids": []
      },
      {
        "schema_version": "PlanStepV1@1",
        "step_id": "s3",
        "step_type": "COMPUTE",
        "name": "Score & recommend package",
        "inputs": {"criteria": ["legal", "coverage", "cost"], "no_submit": true},
        "expected_outputs": {"recommendation": {"type": "object", "required": ["primary", "backup"]}},
        "depends_on": ["s1", "s2"],
        "tool_hints": {"engine": "rule_based_v1"},
        "risk_tags": [],
        "gate_ids": []
      },
      {
        "schema_version": "PlanStepV1@1",
        "step_id": "s4",
        "step_type": "ACT",
        "name": "Prefill signup form (no submit)",
        "inputs": {"target_url": "https://dichvu.vietstock.vn/...", "stop_before": "submit"},
        "expected_outputs": {"receipt": {"type": "object", "required": ["actions", "final_state"]}},
        "depends_on": ["s3"],
        "tool_hints": {"automation": "browser"},
        "risk_tags": ["external_side_effect"],
        "gate_ids": ["gate_confirm_prefill"]
      }
    ],
    "topological_order_hint": ["s1", "s2", "s3", "s4"],
    "reason_codes": ["INTENT:research_then_action", "MODE:HYBRID", "CONSTRAINT:no_submit"]
  },
  "clarification": null,
  "gates": [
    {
      "schema_version": "GateRequirementV1@1",
      "gate_id": "gate_confirm_prefill",
      "gate_type": "CONFIRMATION",
      "reason": "Sắp thao tác điền form trên web (không submit). Cần user confirm trước khi Act.",
      "step_id": "s4",
      "required_user_action": "CONFIRM",
      "blocked_actions": ["submit", "purchase", "delete"],
      "requires_user_confirm": true,
      "severity": "MEDIUM"
    }
  ],
  "budget": {
    "schema_version": "BudgetSpecV1@1",
    "max_time_ms": 60000,
    "max_tool_calls": 20,
    "max_tokens_est": 12000,
    "est_time_ms": 42000,
    "est_tool_calls": 12,
    "est_tokens": 7800,
    "notes": ["HYBRID plan: retrieve+parse+compute+act (no_submit)"]
  },
  "capability": {
    "schema_version": "CapabilityReportV1@1",
    "feasible": true,
    "tools": [
      {"schema_version":"CapabilityToolV1@1","tool_name":"search.hybrid","available":true,"missing_scopes":[],"rate_limit_profile":"med","notes":[]},
      {"schema_version":"CapabilityToolV1@1","tool_name":"browser.act","available":true,"missing_scopes":[],"rate_limit_profile":"low","notes":["requires user confirmation gate"]}
    ],
    "missing_capabilities": [],
    "reasons": []
  },
  "lint": {
    "schema_version": "PlanLintReportV1@1",
    "ok": true,
    "issues": [],
    "summary": {"INFO": 0, "WARN": 0, "ERROR": 0}
  },
  "prompt_pack_ref": {
    "schema_version": "PromptPackRefV1@1",
    "pack_id": "s3.planpack.default",
    "version": "2025-12-10.1",
    "templates": {"planner": "tmpl://stage3/planner@v1", "step_retrieve": "tmpl://stage3/retrieve@v1"},
    "hash": "sha256:..."
  },
  "idempotency_key": "sha256:...",
  "snapshot_ref": "planstore://snapshots/plan_001.json",
  "tags": {"module": "stage3", "event": "plan_ready", "status": "READY"}
}
```

---

### 6.3 Output Case B — thiếu dữ liệu/ambiguous → `plan_status="NEEDS_CLARIFICATION"` + có clarification

Ví dụ user nói: “Điền form đăng ký datafeed cho công ty tớ” nhưng **không có vendor/URL** và thiếu field bắt buộc (company_name/email).

```json
{
  "schema_version": "PlanBundleV1@1",
  "trace_id": "tr_51aa",
  "span_id": "sp_01",
  "request_id": "rq_88",
  "plan_id": "plan_002",
  "plan_status": "NEEDS_CLARIFICATION",
  "plan_mode": "CLARIFY",
  "execution_plan": null,
  "clarification": {
    "schema_version": "ClarificationRequestV1@1",
    "clarification_id": "clarify_002",
    "rationale": "Yêu cầu có hành động (điền form) nhưng thiếu vendor/URL và thiếu dữ liệu để điền.",
    "blocking_fields": ["entities.vendor_or_url", "entities.company_profile"],
    "questions": [
      {
        "schema_version": "ClarificationQuestionV1@1",
        "qid": "q1",
        "question": "Bạn muốn đăng ký datafeed của nền tảng nào (ví dụ: Vietstock) hoặc gửi link trang đăng ký?",
        "expected_answer_schema": {
          "type": "object",
          "properties": {"vendor": {"type": "string"}, "url": {"type": "string"}},
          "required": []
        },
        "merge_hint": "merge into task_spec.entities.vendor and/or context_pack.active_tab_url"
      },
      {
        "schema_version": "ClarificationQuestionV1@1",
        "qid": "q2",
        "question": "Cho mình thông tin để điền form (tên công ty, email liên hệ). Bạn có muốn dừng trước Submit không?",
        "expected_answer_schema": {
          "type": "object",
          "properties": {
            "company_name": {"type": "string"},
            "contact_email": {"type": "string"},
            "no_submit": {"type": "boolean"}
          },
          "required": ["company_name", "contact_email"]
        },
        "merge_hint": "merge into task_spec.entities.company_profile and task_spec.constraints.no_submit"
      }
    ]
  },
  "gates": [],
  "budget": {
    "schema_version": "BudgetSpecV1@1",
    "max_time_ms": 60000,
    "max_tool_calls": 20,
    "max_tokens_est": 12000,
    "est_time_ms": 2000,
    "est_tool_calls": 0,
    "est_tokens": 300,
    "notes": ["Clarify first, then replan loop"]
  },
  "capability": {
    "schema_version": "CapabilityReportV1@1",
    "feasible": true,
    "tools": [],
    "missing_capabilities": [],
    "reasons": []
  },
  "lint": {
    "schema_version": "PlanLintReportV1@1",
    "ok": true,
    "issues": [],
    "summary": {"INFO": 0, "WARN": 0, "ERROR": 0}
  },
  "prompt_pack_ref": {
    "schema_version": "PromptPackRefV1@1",
    "pack_id": "s3.clarify.default",
    "version": "2025-12-10.1",
    "templates": {"clarifier": "tmpl://stage3/clarify@v1"},
    "hash": "sha256:..."
  },
  "idempotency_key": "sha256:...",
  "snapshot_ref": "planstore://snapshots/plan_002.json",
  "tags": {"module": "stage3", "event": "plan_built", "status": "NEEDS_CLARIFICATION"}
}
```

---

## 7) Dev-friendly extras

### 7.1 Logging/tracing fields chuẩn (bắt buộc)
Mọi log event trong Stage 3 **phải** có:
- `trace_id`, `span_id`, `plan_id`
- `module` (vd: `stage3_intent_router`)
- `event` (vd: `intent_routed`)
- `step_id` (nếu log liên quan step)

### 7.2 Error taxonomy Stage 3 (bắt buộc)

```python
# stages/stage3/contracts/stage3_errors.py

class S3Error(Exception):
    code: str = "S3.ERROR"
    retryable: bool = False

class S3UserError(S3Error):
    code = "S3.USER_ERROR"          # e.g., missing required info
    retryable = False

class S3PolicyError(S3Error):
    code = "S3.POLICY_ERROR"        # blocked by policy
    retryable = False

class S3CapabilityError(S3Error):
    code = "S3.CAPABILITY_ERROR"    # missing tool/scopes/env
    retryable = False

class S3DataError(S3Error):
    code = "S3.DATA_ERROR"          # schema/registry/lint internal
    retryable = False
```

### 7.3 Test plan (bắt buộc)

**Unit tests (mỗi module)**
- `test_stage3_intent_router.py`
  - route đúng cho intent: research/action/hybrid/unknown.
  - conflict constraints → CLARIFY.
- `test_stage3_plan_synthesizer.py`
  - mode → step template đúng (RESEARCH/ACTION/HYBRID).
  - step ids deterministic.
- `test_stage3_dependency_graph.py`
  - detect cycle, topo order.
- `test_stage3_plan_lint_engine.py`
  - missing deps, unknown step type, missing expected_outputs.
- `test_stage3_tool_capability.py`
  - missing scope for ACT → feasible=False.
- `test_stage3_risk_policy_tagger.py`
  - act step → requires confirmation gate; submit → blocked_actions include submit.
- `test_stage3_budget_forecaster.py`
  - budget estimates increase with steps count.

**Integration test**
- `test_stage3_entrypoint.py`
  - run_stage3 happy path returns READY + snapshot_ref.
  - ambiguous returns NEEDS_CLARIFICATION.
  - ensure **no tool execution**: mock/spy that tool adapters are never imported/called.

**Golden tests**
- `test_stage3_golden_outputs.py`
  - load fixtures input → compare output JSON with `golden_planbundle__*.json` (stable ordering + stable ids).

### 7.4 Acceptance criteria checklist (P0/P1)

**P0 (must)**
1) `run_stage3()` **không gọi tool thật** (no network, no automation).  
2) Output luôn là `PlanBundleV1` hợp schema + có `schema_version` ở mọi model.  
3) Có `trace_id/span_id/request_id/plan_id` trong mọi output + log.  
4) Nếu `plan_status=READY` thì phải có `execution_plan` và `lint.ok=true` và `capability.feasible=true`.  
5) Nếu có step `ACT` thì phải có gate confirmation (ít nhất 1 gate gắn vào step).  
6) Cycle deps → `lint.ok=false` → `plan_status=INFEASIBLE`.  
7) Missing capability/scope → `plan_status=INFEASIBLE`.  
8) `idempotency_key` được set và stable cho cùng input.  
9) Snapshot writer được gọi (nếu store fail thì degrade nhưng log ERROR).

**P1 (should)**
1) `S3PlanVariantSelector` sinh 2–3 variants và chọn best theo cost/risk.  
2) `S3PlanNormalizer` merge/dedupe steps hiệu quả (giảm tool_calls).  
3) Clarification builder giới hạn 1–3 câu hỏi, ưu tiên “blocking fields”.

---

## README skeleton (Stage 3)

```md
# Stage 3 — Planning & Plan Packaging

## What it does
- Input: ContextPackV1 + TaskSpecV1
- Output: PlanBundleV1 (READY / NEEDS_CLARIFICATION / BLOCKED_POLICY / INFEASIBLE)
- No side-effects: Stage 3 does NOT execute tools

## How to run (dev)
- python -m stages.stage3.stage3_entrypoint (or via API service wrapper)

## Contracts
- See stages/stage3/contracts/

## Testing
- Unit: pytest stages/stage3/tests/test_stage3_*.py
- Golden: pytest -k golden

## Common failure patterns
- Ambiguous user request -> NEEDS_CLARIFICATION
- Missing scope -> INFEASIBLE
- Policy gate triggered -> BLOCKED_POLICY or READY with gates (depending on enforcement)
```
