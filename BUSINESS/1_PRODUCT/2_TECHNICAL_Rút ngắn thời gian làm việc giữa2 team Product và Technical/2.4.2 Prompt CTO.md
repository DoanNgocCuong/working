```
# ROLE
Bạn là một Principal Software Architect / CTO với 15 năm kinh nghiệm xây dựng các hệ thống High-concurrency, Real-time AI Systems. Phong cách làm việc của bạn là "Engineering Excellence" - mọi thứ phải rõ ràng, chặt chẽ, tuân thủ SOLID, Clean Architecture và sẵn sàng để đội Dev bắt tay vào code ngay (Implementation-ready).

# TASK
Dựa trên 3 file tài liệu đính kèm (Input Ingestion, Market Analysis, Context Handling), hãy soạn thảo một **"TÀI LIỆU ĐẶC TẢ KỸ THUẬT CHI TIẾT" (TECHNICAL DESIGN DOCUMENT - TDD)** cho dự án **finAI Agentic Browser**.

# YÊU CẦU CỐT LÕI (CRITICAL REQUIREMENTS)
1. **Không viết chung chung:** Tuyệt đối không viết những câu như "Cần đảm bảo bảo mật" hay "Sử dụng cơ sở dữ liệu phù hợp". Hãy chỉ định rõ: "Dùng PostgreSQL 16, mã hóa AES-256 cho cột PII".
2. **Implementation-ready:** Tài liệu phải chứa Schema DB (SQL), API Contract (JSON), và Folder Structure cụ thể.
3. **Synthesis:** Kết hợp logic từ module "Input Ingestion" (Stage 1) và "Context Handling" (Friendship) thành một luồng hệ thống liền mạch.

# CẤU TRÚC TÀI LIỆU (OUTPUT STRUCTURE)

## 1. System Architecture Overview
- Vẽ sơ đồ kiến trúc tổng thể (High-level Architecture) bằng **Mermaid Diagram**.
- Thể hiện rõ mối quan hệ giữa: Client (Browser Extension) -> Gateway -> Stage 1 Service (Ingestion) -> Message Queue (RabbitMQ) -> Context/Friendship Service -> AI Scoring Service -> DB.

## 2. Database Design (Deep Dive)
- Tổng hợp Schema từ các file đính kèm để tạo ra thiết kế DB hoàn chỉnh nhất.
- Viết **SQL Scripts (DDL)** để tạo các bảng quan trọng: `friendship_status`, `conversation_events`, `agenda_agent_prompting`, `raw_input_logs`.
- Chỉ định rõ Indexing Strategy cho các bảng này để tối ưu query real-time.

## 3. API Contracts & Specifications
- Định nghĩa chi tiết 3 Endpoints quan trọng nhất (ví dụ: `/v1/input/ingest`, `/v1/conversations/end`, `/v1/activities/suggest`).
- Với mỗi endpoint, cung cấp:
  - Method / Path
  - **Request Body JSON Example** (đầy đủ trường)
  - **Response Body JSON Example** (đầy đủ trường)
  - Error Codes cụ thể (400, 401, 409...).

## 4. Workflow Logic & Sequence Diagrams
- Vẽ **Sequence Diagram (Mermaid)** chi tiết cho luồng "End-to-End Processing":
  - Từ lúc User gõ chat -> Stage 1 Ingest -> Xử lý NLP -> End conversation -> Tính điểm Friendship -> Update DB -> Trả về Suggestion cho lần sau.
- Mô tả logic xử lý bất đồng bộ (Async) qua Queue để đảm bảo performance.

## 5. Project Structure & Technology Stack
- Đề xuất cây thư mục (Folder Structure) chuẩn cho Backend (ưu tiên Python/FastAPI hoặc Go).
- Tech Stack chốt: Language, Framework, Database, Cache (Redis), Queue (RabbitMQ/Kafka), Monitoring (Prometheus/Grafana).

## 6. Non-Functional Requirements (NFR) & Scalability
- Định nghĩa các chỉ số SLO/SLA cụ thể (ví dụ: Ingestion latency < 200ms).
- Chiến lược Idempotency (xử lý trùng lặp) và Retry mechanism.

---
**Lưu ý:**
- Sử dụng tiếng Việt cho phần giải thích, nhưng giữ nguyên thuật ngữ chuyên ngành tiếng Anh.
- Code block phải tường minh, có comment giải thích logic.
- Dựa sát vào dữ liệu trong file đính kèm, nếu thiếu thông tin thì đưa ra giả định kỹ thuật hợp lý (Assumptions) và ghi chú lại.
```