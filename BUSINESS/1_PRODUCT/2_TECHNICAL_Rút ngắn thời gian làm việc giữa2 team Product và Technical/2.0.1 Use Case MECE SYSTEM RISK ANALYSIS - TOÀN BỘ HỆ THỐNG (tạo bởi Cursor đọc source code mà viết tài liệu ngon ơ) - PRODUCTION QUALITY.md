Prompt a C∆∞·ªùng guide: 

```prompt
C·∫ßn MECE to√†n b·ªô c√°c ph·∫ßn module input, output, x·ª≠ l√Ω b√™n trong, b·∫Øn giao ti·∫øp ra b√™n ngo√†i, ...
MECE to√†n b·ªô t·∫•t c·∫£ m·ªçi th·ª©
C·∫ßn timeout < 10 s, c√≥ c∆° ch·∫ø fallback v√† b·∫Øn alert ra b√™n ngo√†i.
(ch∆∞a c·∫ßn code v·ªôi, l√™n MECE overview to√†n b·ªô c√°c r·ªßi ro chung ƒë√£).
```


Ph√¢n t√≠ch MECE to√†n b·ªô h·ªá th·ªëng: r·ªßi ro, input/output, x·ª≠ l√Ω, giao ti·∫øp, timeout, fallback, alert. ƒêang nghi√™n c·ª©u s√¢u h∆°n v·ªÅ ki·∫øn tr√∫c.


[6 tools called]


ƒêang ƒë·ªçc th√™m c√°c routes v√† services ƒë·ªÉ hi·ªÉu ƒë·∫ßy ƒë·ªß h·ªá th·ªëng:


[5 tools called]


T·∫°o MECE framework to√†n b·ªô h·ªá th·ªëng, bao g·ªìm r·ªßi ro, timeout, fallback v√† alert.


[1 tool called]


ƒê√£ t·∫°o **MECE framework** ph√¢n t√≠ch to√†n b·ªô h·ªá th·ªëng. T√≥m t·∫Øt:

# T·ªïng quan MECE framework

Ph√¢n t√≠ch h·ªá th·ªëng theo 5 layers (Mutually Exclusive, Collectively Exhaustive):

### 1. INPUT LAYER (4 nh√≥m)
- HTTP API Endpoints: Robot V2, Agent, Workflow, Database APIs
- RabbitMQ Consumers: Message queue processing
- Background Tasks: Async tasks
- T·ªïng c·ªông: ~15 input points

### 2. PROCESSING LAYER (5 nh√≥m)
- Robot V2 Processing: Webhook flow (7 steps)
- Conversation Workflow: 6-step processing
- Agent Execution: Agent factory + execution
- Workflow Execution: Node execution + state machine
- LLM Processing: OpenAI/Gemini/Groq v·ªõi fallback

### 3. OUTPUT LAYER (5 nh√≥m)
- HTTP Responses: JSON serialization
- Database Writes: PostgreSQL INSERT/UPDATE
- Cache Writes: Redis SET operations
- Message Queue: Kafka producer
- External APIs: Profile API, Fact API, Webhooks

### 4. EXTERNAL DEPENDENCIES (6 nh√≥m)
- PostgreSQL: Connection pool, queries
- Redis: Cache operations
- Kafka: Message producer
- RabbitMQ: Message consumer
- LLM Providers: OpenAI, Gemini, Groq
- External Services: Profile API, Fact API, Langfuse

### 5. INFRASTRUCTURE
- File System: Config files, log files

---

## Risk matrix

| Risk Category | Count | Critical | High | Medium | Low |
|---------------|-------|----------|------|--------|-----|
| **Input Layer** | 15 | 0 | 2 | 5 | 8 |
| **Processing Layer** | 20 | 3 | 5 | 8 | 4 |
| **Output Layer** | 12 | 2 | 4 | 4 | 2 |
| **Dependencies** | 15 | 5 | 5 | 4 | 1 |
| **TOTAL** | **62** | **10** | **16** | **21** | **15** |

---

## Timeout strategy (<10s)

```
Request Flow:
‚îú‚îÄ Validate (0.1s)
‚îú‚îÄ Load Conversation - Redis (2s)
‚îú‚îÄ Process AI (6s)
‚îÇ  ‚îú‚îÄ Main LLM (5s)
‚îÇ  ‚îî‚îÄ Fallback LLM if needed (4s)
‚îú‚îÄ Save Conversation - Redis (1.5s)
‚îî‚îÄ Return Response (0.4s)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
TOTAL: ~10s
```

---

## Fallback strategy

### LLM Fallback Chain:
```
OpenAI (5s) ‚Üí Fail ‚Üí Groq Fallback (4s) ‚Üí Fail ‚Üí INTENT_FALLBACK
```

### Cache Fallback:
```
Redis ‚Üí Fail ‚Üí PostgreSQL ‚Üí Fail ‚Üí Default Value
```

### Database Fallback:
```
PostgreSQL ‚Üí Retry (3x) ‚Üí Fail ‚Üí Log Error ‚Üí Graceful Degradation
```

---

## Alert strategy

- CRITICAL (10 risks): Immediate alert - PostgreSQL/Redis down, LLM both failed
- HIGH (16 risks): < 1 minute - LLM timeout, Workflow failure
- MEDIUM (21 risks): < 5 minutes - External API timeout, Rate limiting
- LOW (15 risks): Summary - Log errors, JSON parsing

---

## Document structure

File `MECE_SYSTEM_RISK_ANALYSIS.md` bao g·ªìm:
1. Input Points Analysis: 15+ input points v·ªõi r·ªßi ro chi ti·∫øt
2. Processing Layers: 5 processing layers v·ªõi step-by-step risks
3. Output Points: 5 output types v·ªõi failure scenarios
4. External Dependencies: 6 dependency types v·ªõi fallback strategies
5. Risk Matrix: 62 risks ƒë∆∞·ª£c categorize
6. Timeout Requirements: T·∫•t c·∫£ timeouts < 10s
7. Fallback Strategies: Fallback cho m·ªçi critical operation
8. Alert Strategy: Alert levels v√† triggers

---

## Next steps

1. Review document: Xem chi ti·∫øt t·ª´ng risk
2. Prioritize: Ch·ªçn risks c·∫ßn implement tr∆∞·ªõc
3. Design solution: Thi·∫øt k·∫ø timeout/fallback/alert cho t·ª´ng risk
4. Implement: Code theo phases (Critical ‚Üí High ‚Üí Medium ‚Üí Low)

B·∫°n mu·ªën:
1. ƒêi s√¢u v√†o ph·∫ßn n√†o (v√≠ d·ª•: LLM fallback, Redis fallback)?
2. B·∫Øt ƒë·∫ßu implement code cho critical risks?
3. T·∫°o detailed design cho m·ªôt component c·ª• th·ªÉ?

---
# MECE SYSTEM RISK ANALYSIS - TO√ÄN B·ªò H·ªÜ TH·ªêNG

## üìã M·ª§C L·ª§C

1. [Framework MECE](#1-framework-mece)
2. [INPUT POINTS - ƒêi·ªÉm Nh·∫≠n D·ªØ Li·ªáu](#2-input-points---ƒëi·ªÉm-nh·∫≠n-d·ªØ-li·ªáu)
3. [PROCESSING LAYERS - T·∫ßng X·ª≠ L√Ω](#3-processing-layers---t·∫ßng-x·ª≠-l√Ω)
4. [OUTPUT POINTS - ƒêi·ªÉm Tr·∫£ D·ªØ Li·ªáu](#4-output-points---ƒëi·ªÉm-tr·∫£-d·ªØ-li·ªáu)
5. [EXTERNAL DEPENDENCIES - Ph·ª• Thu·ªôc B√™n Ngo√†i](#5-external-dependencies---ph·ª•-thu·ªôc-b√™n-ngo√†i)
6. [RISK MATRIX - Ma Tr·∫≠n R·ªßi Ro](#6-risk-matrix---ma-tr·∫≠n-r·ªßi-ro)
7. [TIMEOUT &amp; FALLBACK STRATEGY](#7-timeout--fallback-strategy)
8. [ALERT STRATEGY](#8-alert-strategy)

---

## 1. FRAMEWORK MECE

**MECE = Mutually Exclusive, Collectively Exhaustive**

Ph√¢n lo·∫°i h·ªá th·ªëng theo 5 layers ch√≠nh:

1. **INPUT LAYER** - Nh·∫≠n d·ªØ li·ªáu v√†o
2. **PROCESSING LAYER** - X·ª≠ l√Ω d·ªØ li·ªáu
3. **OUTPUT LAYER** - Tr·∫£ d·ªØ li·ªáu ra
4. **DEPENDENCY LAYER** - Ph·ª• thu·ªôc b√™n ngo√†i
5. **INFRASTRUCTURE LAYER** - H·∫° t·∫ßng c∆° s·ªü

M·ªói layer ƒë∆∞·ª£c ph√¢n t√≠ch:

- ‚úÖ **R·ªßi ro (Risks)**
- ‚è±Ô∏è **Timeout requirements (<10s)**
- üîÑ **Fallback mechanisms**
- üö® **Alert triggers**

---

## 2. INPUT POINTS - ƒêi·ªÉm Nh·∫≠n D·ªØ Li·ªáu

### 2.1. HTTP API Endpoints

#### 2.1.1. Robot V2 API (`/api/v1/bot/*`)

| Endpoint                     | Method | Function                              | Risks                                 | Timeout | Fallback                 | Alert    |
| ---------------------------- | ------ | ------------------------------------- | ------------------------------------- | ------- | ------------------------ | -------- |
| `/initConversation`        | POST   | Kh·ªüi t·∫°o conversation               | Invalid payload, Redis fail, DB fail  | 5s      | Return error, log        | HIGH     |
| `/webhook`                 | POST   | X·ª≠ l√Ω webhook message               | Invalid payload, Redis fail, LLM fail | 10s     | Return default response  | CRITICAL |
| `/runExtractAndGeneration` | POST   | Extract v√† generate sau conversation | DB fail, Redis fail                   | 10s     | Log error, return status | MEDIUM   |
| `/health`                  | GET    | Health check                          | Service down                          | 1s      | Return unhealthy         | LOW      |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Invalid Payload**: Missing `conversation_id`, invalid format
- ‚ùå **Authentication Failure**: AuthDep validation fail
- ‚ùå **Rate Limiting**: Too many requests
- ‚ùå **Payload Too Large**: Request body > limit
- ‚ùå **Malformed JSON**: JSON parsing error

---

#### 2.1.2. Agent API (`/api/v1/agents/*`)

| Endpoint                         | Method | Function                        | Risks                          | Timeout       | Fallback         | Alert  |
| -------------------------------- | ------ | ------------------------------- | ------------------------------ | ------------- | ---------------- | ------ |
| `/agents/runs`                 | POST   | Ch·∫°y agent background          | Agent not found, Invalid input | 2s (response) | Return error     | MEDIUM |
| `/agents/runs/wait`            | POST   | Ch·∫°y agent v√† ƒë·ª£i k·∫øt qu·∫£ | Agent timeout, Agent error     | 30s           | Return error     | HIGH   |
| `/agents/runs/{run_id}`        | GET    | L·∫•y status agent run           | Run ID not found               | 2s            | Return not found | LOW    |
| `/agents/runs/{run_id}/cancel` | POST   | Cancel agent run                | Run already completed          | 2s            | Return status    | LOW    |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Agent Not Found**: Agent ID kh√¥ng t·ªìn t·∫°i
- ‚ùå **Agent Execution Timeout**: Agent ch·∫°y qu√° l√¢u
- ‚ùå **Agent Error**: Agent throw exception
- ‚ùå **Invalid Agent Input**: Input kh√¥ng h·ª£p l·ªá

---

#### 2.1.3. Workflow API (`/api/v1/workflows/*`)

| Endpoint                     | Method | Function                  | Risks                             | Timeout       | Fallback         | Alert  |
| ---------------------------- | ------ | ------------------------- | --------------------------------- | ------------- | ---------------- | ------ |
| `/workflows/runs`          | POST   | Ch·∫°y workflow background | Workflow not found, Invalid input | 2s (response) | Return error     | MEDIUM |
| `/workflows/runs/wait`     | POST   | Ch·∫°y workflow v√† ƒë·ª£i  | Workflow timeout, Error           | 60s           | Return error     | HIGH   |
| `/workflows/runs/{run_id}` | GET    | L·∫•y status workflow      | Run ID not found                  | 2s            | Return not found | LOW    |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Workflow Not Found**: Workflow ID kh√¥ng t·ªìn t·∫°i
- ‚ùå **Workflow Timeout**: Workflow ch·∫°y qu√° l√¢u
- ‚ùå **Workflow Execution Error**: Node trong workflow fail
- ‚ùå **Invalid Workflow Input**: Input kh√¥ng h·ª£p l·ªá

---

#### 2.1.4. Database API (`/robot-ai-workflow/api/v1/*`)

| Endpoint                          | Method | Function                  | Risks                             | Timeout | Fallback          | Alert  |
| --------------------------------- | ------ | ------------------------- | --------------------------------- | ------- | ----------------- | ------ |
| `/listBot`                      | GET    | List t·∫•t c·∫£ bots        | DB connection fail, Query timeout | 5s      | Return empty list | MEDIUM |
| `/insertBot`                    | POST   | T·∫°o bot m·ªõi             | DB fail, Validation error         | 5s      | Return error      | HIGH   |
| `/updateBot`                    | POST   | Update bot                | DB fail, Bot not found            | 5s      | Return error      | HIGH   |
| `/getDataBot`                   | GET    | L·∫•y bot data             | DB fail, Bot not found            | 5s      | Return error      | MEDIUM |
| `/getHistoryFromConversationId` | GET    | L·∫•y conversation history | DB fail, Query timeout            | 5s      | Return empty      | MEDIUM |
| `/getGifs`                      | GET    | L·∫•y gifs                 | DB fail                           | 3s      | Return empty      | LOW    |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Database Connection Failure**: PostgreSQL kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
- ‚ùå **Query Timeout**: Query qu√° l√¢u (>5s)
- ‚ùå **Database Pool Exhausted**: H·∫øt connection pool
- ‚ùå **Transaction Fail**: Rollback failed
- ‚ùå **Data Validation Error**: Invalid data format

---

### 2.2. Message Queue Consumers

#### 2.2.1. RabbitMQ Consumer

| Component                   | Function                    | Risks                                    | Timeout          | Fallback            | Alert  |
| --------------------------- | --------------------------- | ---------------------------------------- | ---------------- | ------------------- | ------ |
| `RabbitMQConsumer`        | Consume messages t·ª´ queue  | Connection lost, Message processing fail | Per message: 10s | NACK message, retry | HIGH   |
| `async_init_conversation` | Init conversation t·ª´ queue | Redis fail, DB fail                      | 10s              | Return False, NACK  | HIGH   |
| `async_webhook`           | Process webhook t·ª´ queue   | Webhook API timeout, Invalid response    | 5s               | Return None, NACK   | MEDIUM |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **RabbitMQ Connection Lost**: M·∫•t k·∫øt n·ªëi broker
- ‚ùå **Message Processing Timeout**: X·ª≠ l√Ω message qu√° l√¢u
- ‚ùå **Message Deserialization Error**: JSON parse fail
- ‚ùå **Queue Full**: Queue ƒë·∫ßy, kh√¥ng consume ƒë∆∞·ª£c
- ‚ùå **Consumer Crash**: Process crash trong khi consume

---

### 2.3. Background Tasks

| Component                     | Function        | Risks                   | Timeout                       | Fallback  | Alert  |
| ----------------------------- | --------------- | ----------------------- | ----------------------------- | --------- | ------ |
| `BackgroundTasks` (FastAPI) | Ch·∫°y task n·ªÅn | Task fail, Task timeout | No timeout (run until finish) | Log error | MEDIUM |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Task Execution Error**: Exception trong task
- ‚ùå **Task Hang**: Task ch·∫°y m√£i kh√¥ng k·∫øt th√∫c
- ‚ùå **Resource Exhaustion**: Qu√° nhi·ªÅu background tasks

---

## 3. PROCESSING LAYERS - T·∫ßng X·ª≠ L√Ω

### 3.1. Robot V2 Processing

#### 3.1.1. Webhook Processing Flow

```
Input ‚Üí Validate ‚Üí Load Conversation ‚Üí Process AI ‚Üí Update State ‚Üí Save ‚Üí Return
```

| Step                 | Component                          | Risks                   | Timeout | Fallback                  | Alert    |
| -------------------- | ---------------------------------- | ----------------------- | ------- | ------------------------- | -------- |
| 1. Validate          | `payload.get("conversation_id")` | Missing ID              | 0.1s    | Return error response     | LOW      |
| 2. Load Conversation | `_load_conversation()`           | Redis fail, Not found   | 2s      | Return not found response | HIGH     |
| 3. Process AI        | `_process_with_ai()`             | LLM fail, Workflow fail | 8s      | Return default answer     | CRITICAL |
| 4. Update State      | State update logic                 | Logic error             | 1s      | Log error, continue       | MEDIUM   |
| 5. Save              | `set_session()`                  | Redis fail              | 2s      | Retry, log error          | HIGH     |
| 6. Return            | Response formatting                | Serialization error     | 0.5s    | Return error response     | LOW      |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Step 2: Redis GET fail**: Connection timeout, Redis down
- ‚ùå **Step 3: LLM Timeout**: LLM API kh√¥ng ph·∫£n h·ªìi trong 8s
- ‚ùå **Step 3: LLM Rate Limit**: B·ªã rate limit t·ª´ provider
- ‚ùå **Step 3: LLM Both Failed**: Main v√† fallback ƒë·ªÅu fail
- ‚ùå **Step 5: Redis SET fail**: Connection timeout, Redis down

---

#### 3.1.2. Conversation Workflow Processing

```
Prepare ‚Üí Classify Intent ‚Üí Transition ‚Üí Generate Answer ‚Üí Update Record ‚Üí Process Tools
```

| Step            | Component                 | Risks                    | Timeout | Fallback              | Alert  |
| --------------- | ------------------------- | ------------------------ | ------- | --------------------- | ------ |
| Prepare         | Load scenario, bot config | DB fail, Config error    | 2s      | Use cached config     | MEDIUM |
| Classify Intent | LLM classify              | LLM timeout, Parse error | 5s      | Use fallback intent   | HIGH   |
| Transition      | State machine logic       | Invalid state            | 1s      | Default to CHAT       | MEDIUM |
| Generate Answer | LLM generate              | LLM timeout, Parse error | 5s      | Return default answer | HIGH   |
| Update Record   | Record update             | Logic error              | 1s      | Log error, continue   | LOW    |
| Process Tools   | Tool execution            | Tool timeout, Tool error | 3s      | Skip tool, continue   | MEDIUM |

---

### 3.2. Agent Processing

#### 3.2.1. Agent Execution

| Component       | Risks                      | Timeout | Fallback           | Alert  |
| --------------- | -------------------------- | ------- | ------------------ | ------ |
| Agent Factory   | Agent not found, Init fail | 5s      | Return error       | MEDIUM |
| Agent Execution | Agent logic error, Timeout | 30s     | Return error state | HIGH   |
| Agent Output    | Serialization error        | 1s      | Return error       | LOW    |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Agent Initialization Fail**: Kh√¥ng t·∫°o ƒë∆∞·ª£c agent instance
- ‚ùå **Agent Execution Timeout**: Agent ch·∫°y qu√° 30s
- ‚ùå **Agent Exception**: Unhandled exception trong agent
- ‚ùå **Agent Output Invalid**: Output kh√¥ng ƒë√∫ng format

---

### 3.3. Workflow Processing

#### 3.3.1. Workflow Execution

| Component        | Risks                    | Timeout      | Fallback            | Alert  |
| ---------------- | ------------------------ | ------------ | ------------------- | ------ |
| Workflow Factory | Workflow not found       | 2s           | Return error        | MEDIUM |
| Node Execution   | Node error, Node timeout | 10s per node | Skip node, continue | HIGH   |
| State Transition | Invalid transition       | 1s           | Default transition  | MEDIUM |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Node Execution Fail**: M·ªôt node trong workflow fail
- ‚ùå **Node Timeout**: Node ch·∫°y qu√° 10s
- ‚ùå **State Machine Error**: Invalid state transition
- ‚ùå **Workflow Hang**: Workflow kh√¥ng k·∫øt th√∫c

---

### 3.4. LLM Processing

#### 3.4.1. LLM API Calls

| Provider | Function      | Risks                                     | Timeout              | Fallback           | Alert |
| -------- | ------------- | ----------------------------------------- | -------------------- | ------------------ | ----- |
| OpenAI   | `predict()` | API timeout, Rate limit, Invalid response | 5s main, 4s fallback | Use fallback model | HIGH  |
| Gemini   | `predict()` | API timeout, Rate limit                   | 5s main, 4s fallback | Use fallback model | HIGH  |
| Groq     | `predict()` | API timeout, Rate limit                   | 5s main, 4s fallback | Use fallback model | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **API Timeout**: Provider kh√¥ng ph·∫£n h·ªìi trong timeout
- ‚ùå **Rate Limit**: B·ªã rate limit t·ª´ provider
- ‚ùå **Invalid Response**: Response kh√¥ng parse ƒë∆∞·ª£c JSON
- ‚ùå **Both Models Failed**: Main v√† fallback ƒë·ªÅu fail
- ‚ùå **API Key Invalid**: API key h·∫øt h·∫°n ho·∫∑c sai
- ‚ùå **Network Error**: M·∫•t k·∫øt n·ªëi m·∫°ng

**Fallback Strategy:**

```
Main Model (5s timeout) ‚Üí Fail ‚Üí Fallback Model (4s timeout) ‚Üí Fail ‚Üí INTENT_FALLBACK
```

---

### 3.5. Data Processing

#### 3.5.1. JSON Parsing

| Component  | Risks                        | Timeout | Fallback               | Alert |
| ---------- | ---------------------------- | ------- | ---------------------- | ----- |
| JSON Parse | Invalid JSON, Malformed data | 0.5s    | Return None, log error | LOW   |

#### 3.5.2. Scenario Processing

| Component           | Risks                       | Timeout | Fallback             | Alert  |
| ------------------- | --------------------------- | ------- | -------------------- | ------ |
| ScenarioExcel       | File not found, Parse error | 2s      | Use default scenario | MEDIUM |
| Scenario Conversion | Conversion error            | 3s      | Return error         | MEDIUM |

---

## 4. OUTPUT POINTS - ƒêi·ªÉm Tr·∫£ D·ªØ Li·ªáu

### 4.1. HTTP Response

| Output Type      | Risks                 | Timeout | Fallback              | Alert |
| ---------------- | --------------------- | ------- | --------------------- | ----- |
| JSON Response    | Serialization error   | 0.5s    | Return error response | LOW   |
| Response Headers | Header encoding error | 0.1s    | Default headers       | LOW   |
| Status Code      | Invalid status code   | 0.1s    | 500 Internal Error    | LOW   |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Response Serialization Fail**: Kh√¥ng serialize ƒë∆∞·ª£c response
- ‚ùå **Response Too Large**: Response body > limit
- ‚ùå **Encoding Error**: Unicode encoding error

---

### 4.2. Database Writes

#### 4.2.1. PostgreSQL Writes

| Operation          | Risks                                 | Timeout | Fallback            | Alert |
| ------------------ | ------------------------------------- | ------- | ------------------- | ----- |
| INSERT             | Connection fail, Constraint violation | 5s      | Retry, log error    | HIGH  |
| UPDATE             | Connection fail, Row not found        | 5s      | Retry, log error    | HIGH  |
| Transaction Commit | Transaction fail                      | 5s      | Rollback, log error | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Connection Failure**: PostgreSQL kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
- ‚ùå **Query Timeout**: Query qu√° l√¢u (>5s)
- ‚ùå **Transaction Fail**: Commit fail, rollback fail
- ‚ùå **Constraint Violation**: Unique constraint, foreign key violation
- ‚ùå **Deadlock**: Database deadlock

---

### 4.3. Cache Writes (Redis)

#### 4.3.1. Redis Operations

| Operation    | Risks                          | Timeout | Fallback         | Alert |
| ------------ | ------------------------------ | ------- | ---------------- | ----- |
| SET          | Connection fail, Memory full   | 2s      | Retry, log error | HIGH  |
| GET          | Connection fail, Key not found | 2s      | Return None      | HIGH  |
| Session Save | Connection fail                | 2s      | Retry, log error | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Connection Failure**: Redis kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c
- ‚ùå **Operation Timeout**: Operation qu√° l√¢u (>2s)
- ‚ùå **Memory Full**: Redis h·∫øt memory
- ‚ùå **Key Expiration**: Key b·ªã expire trong khi ƒëang d√πng

---

### 4.4. Message Queue Writes

#### 4.4.1. Kafka Producer

| Operation    | Risks                            | Timeout | Fallback         | Alert |
| ------------ | -------------------------------- | ------- | ---------------- | ----- |
| Send Message | Connection fail, Topic not found | 3s      | Retry, log error | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Kafka Connection Lost**: M·∫•t k·∫øt n·ªëi broker
- ‚ùå **Topic Not Found**: Topic kh√¥ng t·ªìn t·∫°i
- ‚ùå **Producer Timeout**: Send timeout
- ‚ùå **Serialization Error**: Message serialize fail

---

### 4.5. External API Calls

#### 4.5.1. Profile API

| API                              | Function          | Risks                  | Timeout | Fallback                | Alert  |
| -------------------------------- | ----------------- | ---------------------- | ------- | ----------------------- | ------ |
| `call_api_get_user_profile`    | L·∫•y user profile | API timeout, API error | 5s      | Return None             | MEDIUM |
| `call_api_update_user_profile` | Update profile    | API timeout, API error | 5s      | Log error, return False | MEDIUM |

#### 4.5.2. Fact API

| API                   | Function               | Risks                  | Timeout | Fallback    | Alert  |
| --------------------- | ---------------------- | ---------------------- | ------- | ----------- | ------ |
| `generate_response` | Generate fact response | API timeout, API error | 5s      | Return None | MEDIUM |

#### 4.5.3. Workflow/Agent Webhook

| API               | Function     | Risks                     | Timeout | Fallback    | Alert  |
| ----------------- | ------------ | ------------------------- | ------- | ----------- | ------ |
| `async_webhook` | Call webhook | Timeout, Invalid response | 5s      | Return None | MEDIUM |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **HTTP Timeout**: API kh√¥ng ph·∫£n h·ªìi trong timeout
- ‚ùå **HTTP Error**: 4xx, 5xx status codes
- ‚ùå **Network Error**: Connection reset, DNS fail
- ‚ùå **Response Parse Error**: Invalid JSON response

---

## 5. EXTERNAL DEPENDENCIES - Ph·ª• Thu·ªôc B√™n Ngo√†i

### 5.1. Database

#### 5.1.1. PostgreSQL

| Dependency      | Purpose              | Risks                           | Timeout | Fallback            | Alert    |
| --------------- | -------------------- | ------------------------------- | ------- | ------------------- | -------- |
| Connection Pool | Database connections | Pool exhausted, Connection fail | 5s      | Retry, log error    | CRITICAL |
| Queries         | Data operations      | Query timeout, Transaction fail | 5s      | Retry, return error | HIGH     |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Connection Pool Exhausted**: H·∫øt connection trong pool
- ‚ùå **Database Down**: PostgreSQL service down
- ‚ùå **Network Partition**: M·∫•t k·∫øt n·ªëi m·∫°ng ƒë·∫øn DB
- ‚ùå **Query Performance**: Slow queries (>5s)
- ‚ùå **Transaction Deadlock**: Deadlock gi·ªØa transactions

**Fallback Strategy:**

- Retry v·ªõi exponential backoff (max 3 retries)
- Cache frequently accessed data
- Read-only mode n·∫øu write fail

---

### 5.2. Cache

#### 5.2.1. Redis

| Dependency | Purpose          | Risks             | Timeout | Fallback               | Alert    |
| ---------- | ---------------- | ----------------- | ------- | ---------------------- | -------- |
| Connection | Cache operations | Connection fail   | 2s      | Retry, use DB fallback | CRITICAL |
| GET/SET    | Cache read/write | Operation timeout | 2s      | Use DB directly        | HIGH     |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Redis Down**: Redis service down
- ‚ùå **Connection Lost**: M·∫•t k·∫øt n·ªëi
- ‚ùå **Memory Full**: Redis h·∫øt memory
- ‚ùå **Key Eviction**: Key b·ªã evict do memory pressure

**Fallback Strategy:**

- Fallback to PostgreSQL n·∫øu Redis fail
- Retry v·ªõi exponential backoff
- Graceful degradation: Continue without cache

---

### 5.3. Message Queues

#### 5.3.1. Kafka

| Dependency | Purpose       | Risks                            | Timeout | Fallback           | Alert |
| ---------- | ------------- | -------------------------------- | ------- | ------------------ | ----- |
| Producer   | Send messages | Connection fail, Topic not found | 3s      | Retry, log to file | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Kafka Broker Down**: Broker kh√¥ng available
- ‚ùå **Topic Not Found**: Topic ch∆∞a ƒë∆∞·ª£c t·∫°o
- ‚ùå **Network Partition**: M·∫•t k·∫øt n·ªëi ƒë·∫øn broker

**Fallback Strategy:**

- Retry v·ªõi exponential backoff
- Log to file n·∫øu Kafka fail ho√†n to√†n
- Use RabbitMQ backup n·∫øu c√≥

---

#### 5.3.2. RabbitMQ

| Dependency | Purpose          | Risks                       | Timeout         | Fallback        | Alert |
| ---------- | ---------------- | --------------------------- | --------------- | --------------- | ----- |
| Consumer   | Consume messages | Connection lost, Queue full | 10s per message | Reconnect, NACK | HIGH  |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **RabbitMQ Broker Down**: Broker kh√¥ng available
- ‚ùå **Queue Full**: Queue ƒë·∫ßy, kh√¥ng consume ƒë∆∞·ª£c
- ‚ùå **Consumer Crash**: Process crash

**Fallback Strategy:**

- Auto-reconnect v·ªõi exponential backoff
- NACK message ƒë·ªÉ retry sau
- Dead letter queue cho messages fail nhi·ªÅu l·∫ßn

---

### 5.4. LLM Providers

#### 5.4.1. OpenAI

| Dependency | Purpose       | Risks                         | Timeout              | Fallback           | Alert    |
| ---------- | ------------- | ----------------------------- | -------------------- | ------------------ | -------- |
| API        | LLM inference | Timeout, Rate limit, API down | 5s main, 4s fallback | Use fallback model | CRITICAL |

#### 5.4.2. Google Gemini

| Dependency | Purpose       | Risks                         | Timeout              | Fallback           | Alert    |
| ---------- | ------------- | ----------------------------- | -------------------- | ------------------ | -------- |
| API        | LLM inference | Timeout, Rate limit, API down | 5s main, 4s fallback | Use fallback model | CRITICAL |

#### 5.4.3. Groq

| Dependency | Purpose       | Risks                         | Timeout              | Fallback           | Alert    |
| ---------- | ------------- | ----------------------------- | -------------------- | ------------------ | -------- |
| API        | LLM inference | Timeout, Rate limit, API down | 5s main, 4s fallback | Use fallback model | CRITICAL |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **API Timeout**: Provider kh√¥ng ph·∫£n h·ªìi
- ‚ùå **Rate Limit**: B·ªã rate limit
- ‚ùå **API Key Invalid**: Key h·∫øt h·∫°n ho·∫∑c sai
- ‚ùå **Service Down**: Provider service down
- ‚ùå **Quota Exceeded**: H·∫øt quota

**Fallback Strategy:**

```
Main Provider ‚Üí Timeout/Fail ‚Üí Fallback Provider ‚Üí Timeout/Fail ‚Üí INTENT_FALLBACK
```

---

### 5.5. External Services

#### 5.5.1. Profile Service

| Service          | Purpose            | Risks                     | Timeout | Fallback              | Alert  |
| ---------------- | ------------------ | ------------------------- | ------- | --------------------- | ------ |
| User Profile API | Get/Update profile | API timeout, Service down | 5s      | Return None, continue | MEDIUM |

#### 5.5.2. Fact Service

| Service               | Purpose       | Risks                     | Timeout | Fallback          | Alert  |
| --------------------- | ------------- | ------------------------- | ------- | ----------------- | ------ |
| Generate Response API | Generate fact | API timeout, Service down | 5s      | Return None, skip | MEDIUM |

#### 5.5.3. Langfuse

| Service | Purpose     | Risks                     | Timeout | Fallback               | Alert |
| ------- | ----------- | ------------------------- | ------- | ---------------------- | ----- |
| Tracing | LLM tracing | API timeout, Service down | 2s      | Skip tracing, continue | LOW   |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **Service Down**: External service kh√¥ng available
- ‚ùå **API Timeout**: Kh√¥ng ph·∫£n h·ªìi trong timeout
- ‚ùå **Network Error**: Connection fail

**Fallback Strategy:**

- Continue without external service
- Log error, kh√¥ng block main flow
- Retry cho critical operations

---

### 5.6. File System

#### 5.6.1. Config Files

| Operation       | Risks                       | Timeout | Fallback           | Alert  |
| --------------- | --------------------------- | ------- | ------------------ | ------ |
| Read config.yml | File not found, Parse error | 1s      | Use default config | MEDIUM |

#### 5.6.2. Log Files

| Operation | Risks                       | Timeout | Fallback      | Alert |
| --------- | --------------------------- | ------- | ------------- | ----- |
| Write log | Disk full, Permission error | 0.5s    | Log to stdout | LOW   |

**R·ªßi ro chi ti·∫øt:**

- ‚ùå **File Not Found**: Config file kh√¥ng t·ªìn t·∫°i
- ‚ùå **Permission Error**: Kh√¥ng c√≥ quy·ªÅn ƒë·ªçc/ghi
- ‚ùå **Disk Full**: Disk h·∫øt ch·ªó
- ‚ùå **File Lock**: File ƒëang b·ªã lock

---

## 6. RISK MATRIX - Ma Tr·∫≠n R·ªßi Ro

### 6.1. Risk Severity Matrix

| Risk                  | Impact   | Probability | Severity | Timeout Req          | Fallback                    | Alert Level |
| --------------------- | -------- | ----------- | -------- | -------------------- | --------------------------- | ----------- |
| **INPUT LAYER**       |          |             |          |                      |                             |             |
| Invalid Payload       | Medium   | High        | Medium   | 0.1s                 | Return error                | LOW         |
| Auth Failure          | High     | Low         | Medium   | 0.1s                 | Return 401                  | MEDIUM      |
| Rate Limiting         | High     | Medium      | High     | 0.5s                 | Return 429                  | MEDIUM      |
| **PROCESSING LAYER**  |          |             |          |                      |                             |             |
| LLM Timeout           | Critical | Medium      | Critical | 5s main, 4s fallback | Fallback model              | CRITICAL    |
| LLM Rate Limit        | Critical | Medium      | Critical | 5s                   | Fallback model              | CRITICAL    |
| LLM Both Failed       | Critical | Low         | Critical | 9s total             | INTENT_FALLBACK             | CRITICAL    |
| Workflow Timeout      | High     | Low         | High     | 60s                  | Return error                | HIGH        |
| Agent Error           | High     | Medium      | High     | 30s                  | Return error                | HIGH        |
| **OUTPUT LAYER**      |          |             |          |                      |                             |             |
| Redis SET Fail        | Critical | Medium      | Critical | 2s                   | Retry, fallback to DB       | CRITICAL    |
| Redis GET Fail        | High     | Medium      | High     | 2s                   | Fallback to DB              | HIGH        |
| PostgreSQL Write Fail | Critical | Low         | Critical | 5s                   | Retry, log error            | CRITICAL    |
| Kafka Send Fail       | Medium   | Low         | Medium   | 3s                   | Retry, log to file          | HIGH        |
| **DEPENDENCY LAYER**  |          |             |          |                      |                             |             |
| PostgreSQL Down       | Critical | Low         | Critical | 5s                   | Retry, graceful degradation | CRITICAL    |
| Redis Down            | Critical | Low         | Critical | 2s                   | Fallback to DB              | CRITICAL    |
| Kafka Down            | Medium   | Low         | Medium   | 3s                   | Log to file                 | HIGH        |
| RabbitMQ Down         | High     | Low         | High     | 10s                  | Reconnect, NACK             | HIGH        |
| LLM Provider Down     | Critical | Low         | Critical | 5s                   | Fallback provider           | CRITICAL    |
| External API Timeout  | Medium   | Medium      | Medium   | 5s                   | Continue without            | MEDIUM      |

### 6.2. Risk Categories

#### 6.2.1. **CRITICAL Risks** (Impact: System Down / Data Loss)

1. ‚úÖ PostgreSQL connection failure
2. ‚úÖ Redis connection failure
3. ‚úÖ LLM provider completely down
4. ‚úÖ Both main and fallback LLM failed
5. ‚úÖ Application crash

#### 6.2.2. **HIGH Risks** (Impact: Service Degradation)

1. ‚úÖ LLM timeout (single provider)
2. ‚úÖ Workflow execution failure
3. ‚úÖ Agent execution failure
4. ‚úÖ RabbitMQ consumer failure
5. ‚úÖ Redis operation timeout

#### 6.2.3. **MEDIUM Risks** (Impact: Feature Degradation)

1. ‚úÖ External API timeout
2. ‚úÖ Kafka send failure
3. ‚úÖ Database query timeout
4. ‚úÖ Rate limiting

#### 6.2.4. **LOW Risks** (Impact: Minor Issues)

1. ‚úÖ Log file write failure
2. ‚úÖ JSON parsing error
3. ‚úÖ Response serialization error

---

## 7. TIMEOUT & FALLBACK STRATEGY

### 7.1. Timeout Requirements (<10s)

**Principle: Total request processing time < 10s**

#### 7.1.1. Timeout Allocation

| Layer                | Component                       | Timeout | Total         |
| -------------------- | ------------------------------- | ------- | ------------- |
| **Input**      | Request validation              | 0.1s    | 0.1s          |
| **Processing** | Load conversation (Redis)       | 2s      | 2.1s          |
|                      | Process AI (LLM + Workflow)     | 6s      | 8.1s          |
|                      | - Main LLM call                 | 5s      |               |
|                      | - Fallback LLM call (if needed) | 4s      |               |
|                      | - Workflow processing           | 1s      |               |
| **Output**     | Save conversation (Redis)       | 1.5s    | 9.6s          |
|                      | Response formatting             | 0.4s    | **10s** |

#### 7.1.2. Timeout Configuration

```python
TIMEOUTS = {
    # Input layer
    "request_validation": 0.1,
    "auth_check": 0.1,
  
    # Processing layer
    "redis_get": 2.0,
    "redis_set": 2.0,
    "postgres_query": 5.0,
    "llm_main": 5.0,
    "llm_fallback": 4.0,
    "workflow_execution": 10.0,  # Per workflow (not per request)
    "agent_execution": 30.0,  # Per agent (not per request)
  
    # Output layer
    "external_api": 5.0,
    "kafka_send": 3.0,
    "response_format": 0.5,
  
    # Total request timeout
    "total_request": 10.0
}
```

---

### 7.2. Fallback Strategy

#### 7.2.1. Fallback Hierarchy

```
PRIMARY ‚Üí FALLBACK 1 ‚Üí FALLBACK 2 ‚Üí DEFAULT/DEGRADE
```

#### 7.2.2. Component-Specific Fallbacks

##### 7.2.2.1. LLM Fallback

```
OpenAI (5s) ‚Üí Fail ‚Üí Groq Fallback (4s) ‚Üí Fail ‚Üí INTENT_FALLBACK
```

##### 7.2.2.2. Cache Fallback

```
Redis GET ‚Üí Fail ‚Üí PostgreSQL ‚Üí Fail ‚Üí Default Value
Redis SET ‚Üí Fail ‚Üí Retry (3x) ‚Üí Fail ‚Üí Log error, continue
```

##### 7.2.2.3. Database Fallback

```
PostgreSQL Write ‚Üí Fail ‚Üí Retry (3x with backoff) ‚Üí Fail ‚Üí Log error, return error
PostgreSQL Read ‚Üí Fail ‚Üí Retry (3x) ‚Üí Fail ‚Üí Return empty/default
```

##### 7.2.2.4. External API Fallback

```
External API ‚Üí Timeout/Fail ‚Üí Return None ‚Üí Continue without
```

##### 7.2.2.5. Message Queue Fallback

```
Kafka Send ‚Üí Fail ‚Üí Retry (3x) ‚Üí Fail ‚Üí Log to file ‚Üí Process later
RabbitMQ Consume ‚Üí Fail ‚Üí Reconnect (exponential backoff) ‚Üí NACK message
```

---

### 7.3. Circuit Breaker Pattern

**Implement circuit breaker cho external dependencies:**

```python
CIRCUIT_BREAKER = {
    "postgresql": {
        "failure_threshold": 5,  # Open after 5 failures
        "timeout": 60,  # Wait 60s before half-open
        "success_threshold": 2  # Close after 2 successes
    },
    "redis": {
        "failure_threshold": 5,
        "timeout": 30,
        "success_threshold": 2
    },
    "llm_provider": {
        "failure_threshold": 3,
        "timeout": 60,
        "success_threshold": 1
    },
    "external_api": {
        "failure_threshold": 5,
        "timeout": 30,
        "success_threshold": 2
    }
}
```

---

## 8. ALERT STRATEGY

### 8.1. Alert Levels

| Level              | Description            | Response Time | Notification              |
| ------------------ | ---------------------- | ------------- | ------------------------- |
| **CRITICAL** | System down, data loss | Immediate     | Google Chat + Email + SMS |
| **HIGH**     | Service degradation    | < 1 minute    | Google Chat + Email       |
| **MEDIUM**   | Feature degradation    | < 5 minutes   | Google Chat               |
| **LOW**      | Minor issues           | < 15 minutes  | Google Chat (summary)     |

---

### 8.2. Alert Triggers

#### 8.2.1. CRITICAL Alerts

1. **PostgreSQL Connection Failure**

   - Trigger: Cannot connect to PostgreSQL
   - Timeout: 5s
   - Fallback: Retry, graceful degradation
   - Alert: Immediate
2. **Redis Connection Failure**

   - Trigger: Cannot connect to Redis
   - Timeout: 2s
   - Fallback: Fallback to PostgreSQL
   - Alert: Immediate
3. **LLM Both Providers Failed**

   - Trigger: Main and fallback LLM both timeout/fail
   - Timeout: 9s total
   - Fallback: INTENT_FALLBACK
   - Alert: Immediate
4. **Application Crash**

   - Trigger: Unhandled exception, process exit
   - Timeout: N/A
   - Fallback: Process restart
   - Alert: Immediate

---

#### 8.2.2. HIGH Alerts

1. **LLM Single Provider Timeout**

   - Trigger: Main LLM timeout (fallback works)
   - Timeout: 5s
   - Fallback: Use fallback model
   - Alert: < 1 minute
2. **Redis Operation Timeout**

   - Trigger: Redis GET/SET timeout
   - Timeout: 2s
   - Fallback: Fallback to PostgreSQL
   - Alert: < 1 minute
3. **Workflow Execution Failure**

   - Trigger: Workflow node fails
   - Timeout: 10s per node
   - Fallback: Skip node, continue
   - Alert: < 1 minute
4. **Agent Execution Failure**

   - Trigger: Agent throws exception
   - Timeout: 30s
   - Fallback: Return error state
   - Alert: < 1 minute
5. **RabbitMQ Consumer Error**

   - Trigger: Message processing fails multiple times
   - Timeout: 10s per message
   - Fallback: NACK, retry later
   - Alert: < 1 minute

---

#### 8.2.3. MEDIUM Alerts

1. **Database Query Timeout**

   - Trigger: Query > 5s
   - Timeout: 5s
   - Fallback: Retry, return error
   - Alert: < 5 minutes
2. **External API Timeout**

   - Trigger: External API timeout
   - Timeout: 5s
   - Fallback: Continue without
   - Alert: < 5 minutes
3. **Kafka Send Failure**

   - Trigger: Kafka producer fails
   - Timeout: 3s
   - Fallback: Log to file
   - Alert: < 5 minutes
4. **Rate Limiting**

   - Trigger: Too many requests
   - Timeout: 0.5s
   - Fallback: Return 429
   - Alert: < 5 minutes

---

#### 8.2.4. LOW Alerts

1. **Log File Write Failure**

   - Trigger: Cannot write to log file
   - Timeout: 0.5s
   - Fallback: Log to stdout
   - Alert: Summary (daily)
2. **JSON Parsing Error**

   - Trigger: Invalid JSON in request/response
   - Timeout: 0.5s
   - Fallback: Return error
   - Alert: Summary (hourly)

---

### 8.3. Alert Deduplication

**Strategy: Group similar alerts within time window**

```python
ALERT_DEDUPLICATION = {
    "time_window": 300,  # 5 minutes
    "max_alerts_per_window": 5,
    "group_similar": True  # Group by alert type
}
```

**Example:**

- N·∫øu c√≥ 10 LLM timeout trong 5 ph√∫t ‚Üí ch·ªâ b·∫Øn 1 alert: "LLM timeout occurred 10 times in last 5 minutes"

---

### 8.4. Alert Message Format

**Google Chat Card Format:**

```json
{
  "cards": [{
    "header": {
      "title": "üö® [LEVEL] Alert Title",
      "subtitle": "2025-01-15 14:30:25"
    },
    "sections": [{
      "widgets": [{
        "textParagraph": {
          "text": "<b>Service:</b> RobotV2Service<br><b>Error:</b> Description<br><b>Timeout:</b> 5s exceeded<br><b>Fallback:</b> Using fallback model"
        }
      }]
    }]
  }]
}
```

---

## 9. IMPLEMENTATION PRIORITY

### 9.1. Phase 1: Critical Infrastructure (Week 1)

1. ‚úÖ PostgreSQL connection monitoring + alert
2. ‚úÖ Redis connection monitoring + alert
3. ‚úÖ LLM timeout + fallback + alert
4. ‚úÖ Application crash handler + alert

### 9.2. Phase 2: High Priority (Week 2)

1. ‚úÖ Workflow execution monitoring + alert
2. ‚úÖ Agent execution monitoring + alert
3. ‚úÖ RabbitMQ consumer monitoring + alert
4. ‚úÖ Redis operation timeout + fallback

### 9.3. Phase 3: Medium Priority (Week 3)

1. ‚úÖ External API timeout + fallback + alert
2. ‚úÖ Kafka send failure + fallback + alert
3. ‚úÖ Database query timeout + alert
4. ‚úÖ Rate limiting + alert

### 9.4. Phase 4: Low Priority (Week 4)

1. ‚úÖ Log file monitoring
2. ‚úÖ JSON parsing error handling
3. ‚úÖ Performance metrics collection

---

## 10. SUMMARY

### 10.1. Key Principles

1. **Timeout < 10s**: T·∫•t c·∫£ request ph·∫£i complete trong 10s
2. **Fallback Always**: M·ªói critical operation ph·∫£i c√≥ fallback
3. **Alert Early**: Alert ngay khi c√≥ v·∫•n ƒë·ªÅ, kh√¥ng ƒë·ª£i
4. **Graceful Degradation**: System v·∫´n ch·∫°y ƒë∆∞·ª£c d√π m·ªôt s·ªë components fail
5. **Circuit Breaker**: Tr√°nh cascade failures

### 10.2. Critical Paths

```
Request ‚Üí Validate (0.1s) ‚Üí Load Conversation (2s) ‚Üí Process AI (6s) ‚Üí Save (1.5s) ‚Üí Return (0.4s) = 10s TOTAL
```

**M·ªói step ph·∫£i c√≥:**

- ‚úÖ Timeout protection
- ‚úÖ Fallback mechanism
- ‚úÖ Error handling
- ‚úÖ Alert trigger (if critical)

---

**END OF DOCUMENT**


