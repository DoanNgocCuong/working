# Luồng dữ liệu: robot-v2.webhook-service

**Mục đích:** Mô tả luồng đi của data qua `robot-v2.webhook-service`: các service/hệ thống được gọi và các thao tác thực hiện.

**Entry point:** `POST /robot-ai-workflow/api/v1/bot/webhook`
**Trace name (Langfuse):** `robot-v2.webhook-service`

---

## 1. Tổng quan luồng (high-level)

```
+----------+     +------------------+     +------------------------+     +----------+
| Client   | --> | FastAPI Route     | --> | RobotV2Service.webhook | --> | Response |
| (FE/App)|     | robot_v2_routes   |     | (robot_v2_services)    |     | (JSON)   |
+----------+     +------------------+     +------------------------+     +----------+
                        |                            |
                        v                            v
                 Langfuse metadata            Redis, LLM, Workflow,
                 (conversation_id,            RabbitMQ, Postgres, ...
                  user_id)
```

---

## 2. Các bước trong webhook (theo thứ tự thực thi)

| Bước | Tên (log)                    | Service / Thành phần                                          | Thao tác chính                                                                                                                                                           |
| ------ | ----------------------------- | --------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0      | (trước webhook)             | **API Route**                                             | Nhận body (conversation_id, message, history, audio_url); cập nhật Langfuse trace metadata; gọi `service.webhook(payload)`.                                          |
| 1      | Load Conversation from Redis  | **Redis** (REDIS_CLIENT)                                  | `REDIS_CLIENT.get(conversation_id)` → parse JSON session (orjson). Trả về `conversation` (bot_config, record, history, input_slots, ...) hoặc None.                |
| 1.5a   | (nhánh) Reopening message    | **In-memory**                                             | Nếu `conversation.reopening_message` có giá trị: normalize placeholders, set `IMAGE_LISTENING=""`, lưu lại session qua Redis, **return** (không gọi AI). |
| 1.5b   | (nhánh) Welcome-back message | **In-memory**                                             | Nếu `conversation.welcome_back_message` có giá trị: dọn state, ghép title_blocks, normalize placeholders, lưu session Redis, **return** (không gọi AI).   |
| 2      | Process with AI               | **PoliciesWorkflow.process** (xem §3)                    | Gọi workflow với scenario, message, record, input_slots, llm_base, system_prompt, history, ...; timeout 8s. Trả về `(status, answer, record_new, timing_dict)`.      |
| 3      | Update Conversation State     | **In-memory + ScenarioExcel**                             | Cập nhật ANSWER_MODE, tool recording;`conversation["record"] = record_new`; append user + assistant message vào `conversation["history"]`.                          |
| 4      | Handle END Status             | **Redis (v2_session_store)** + **PoliciesWorkflow** | Nếu status == "END": lấy message profile (`get_message_of_profile`); nếu có → `set_profile_flag_processing(self.redis, conversation_id)`. (TODO: RabbitMQ task.)  |
| 5      | Save to Redis                 | **Redis** (REDIS_CLIENT)                                  | `_normalize_keys_for_orjson(conversation)` → `REDIS_CLIENT.set(conversation_id, orjson.dumps(...))`.                                                                  |
| 5.5    | Normalize placeholders        | **In-memory**                                             | `_normalize_user_placeholders_in_response(answer, input_slots)` ({{name}}, [[name]], ...).                                                                               |
| 6      | Return Response               | **API**                                                   | Trả JSON: status, text (answer), conversation_id, msg, record. Log client response + execution tree.                                                                      |

---

## 3. Chi tiết “Process with AI” (Step 2) — PoliciesWorkflow.process

Luồng bên trong **conversation_workflow_orchestrator.process()** (16 bước + nhánh tool/game):

| Bước | Tên (log)                          | Service / Thành phần              | Thao tác                                                                                                                                                              |
| ------ | ----------------------------------- | ----------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1      | prepare.scenario_flow               | **ScenarioExcel** (in-memory) | Chuẩn bị scenario flow từ config.                                                                                                                                   |
| 2      | prepare.clone_record                | **In-memory**                 | Clone record hiện tại → record_new.                                                                                                                                 |
| 3      | tool-chat.handle                    | **In-memory / logic**         | `handle_tool_chat_if_needed`: nếu là tool chat → early return (status, answer, record_new).                                                                       |
| 4      | intent.preprocess                   | **llm_prompt_preprocessor**   | `build_and_preprocess_intent_messages`: build messages + variables cho intent.                                                                                       |
| 5      | queue.push                          | **Redis + RabbitMQ**          | `push_background_tasks`: với từng TOOL trong state → Redis delete task_id, RabbitMQ send_task (conversation_id, tool, message, audio_url, task_id).               |
| 6      | intent.pipeline                     | **LLM (BaseLLM)**             | `classify_intent`: gọi LLM để phân loại intent (messages, record, scenario, llm_base, params).                                                                  |
| 7      | workflow.transition                 | **In-memory (state machine)** | `run_workflow_transition`: scenario, intent_llm, record_new → (state, cur_action, cur_intent).                                                                      |
| 8      | tools.process-tool-mode             | **Pronunciation / Tool**      | `process_pronunciation_checker_tool_mode`: xử lý tool mode phát âm (có thể gọi LLM/tool).                                                                     |
| 9      | status.resolve                      | **In-memory**                 | `resolve_status(state, cur_action)` → status, next_action.                                                                                                          |
| 10     | answer.llm                          | **LLM (BaseLLM)**             | `generate_llm_answer_if_needed`: sinh câu trả lời từ LLM theo cur_action.                                                                                        |
| 11     | answer.fact                         | **Memory / API (optional)**   | `handle_fact_trigger_if_any`: nếu user gõ [FACT] → có thể gọi API/user_id/history; merge fact vào answer.                                                     |
| 12     | record.update                       | **In-memory**                 | `update_record_after_workflow`: cập nhật record_new (NEXT_ACTION, LOOP_COUNT, ...). Build GAME_SCORE_INFO; `process_game_branching` (nhánh game).               |
| 13     | variables.merge + answer.fill-slots | **ScenarioExcel + In-memory** | `merge_variables_with_record`; `fill_slots(answer, cur_action, variables, scenario_flow)`.                                                                         |
| 14     | answer.memory                       | **Redis / API (optional)**    | `enrich_answer_with_memory_if_needed`: có thể đọc Redis/API theo bot_id, user_id.                                                                                |
| 15     | history.update                      | **In-memory**                 | `update_history_question(record_new, record, next_action, message, answer)`.                                                                                         |
| 16     | tools.process-tool-if-any           | **Tool Interface (HTTP)**     | `process_tools_if_any`: nếu có tool (is_tool, cur_action.TOOL) → có thể gọi **TOOL_EXECUTOR_URL** (execute), polling Redis task_id, hoặc async_webhook. |

**Các service bên ngoài được gọi trong Process with AI:**

- **LLM (OpenAI / Groq / Gemini, …):** classify intent (bước 6), generate answer (bước 10), và có thể trong pronunciation/tool mode (bước 8).
- **Redis (workflow):** push_background_tasks dùng RedisClient (delete task_id); một số module tạo RedisClient riêng (queue, scoring).
- **RabbitMQ:** push_background_tasks gửi task (tool, message, audio_url, …) vào queue để worker xử lý (log, tool execution, …).
- **TOOL_EXECUTOR_URL:** ToolInterface gọi `/execute` (và có thể `/profileMatching`) khi chạy tool (bước 16 hoặc trong tool mode).
- **Langfuse (optional):** trace/observe các span (nếu bật).

---

## 4. Các service / hệ thống mà webhook phụ thuộc

| Service / Hệ thống                   | Vai trò trong webhook                                                                                                                                                  | File / Component chính                                                                                  |
| -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| **Redis**                        | Lưu/đọc session (conversation): load conversation (Step 1), save sau khi xử lý (Step 5); workflow dùng Redis cho task_id, queue push.                             | REDIS_CLIENT (robot_v2_services), RedisClient (workflow), AsyncRedisAdapter (v2_session_store)           |
| **LLM (OpenAI/Groq/Gemini, …)** | Phân loại intent, sinh câu trả lời; có thể qua OpenRouter/prompt_manager.                                                                                        | llm_manager (RobotV2Service), BaseLLM, get_llm_answering, classify_intent, generate_llm_answer_if_needed |
| **RabbitMQ**                     | Đẩy task background (tool, log, audio) để worker xử lý.                                                                                                           | rabbitmq_task_queue_manager.push_background_tasks, RabbitMQClient                                        |
| **PostgreSQL**                   | **Không gọi trực tiếp trong webhook.** Chỉ dùng trong init_conversation (get_bot_from_id). Bot config đã nằm trong session (Redis) khi webhook chạy.    | LLMBot (channel/postgres_bot) — dùng trong init                                                        |
| **TOOL_EXECUTOR_URL**            | Gọi khi workflow cần thực thi tool (execute, profileMatching).                                                                                                       | ToolInterface (tool_interface.py), scenario (profileMatching)                                            |
| **Langfuse**                     | Tracing (observe): cập nhật metadata ở route; span `robot-v2.webhook-service`, `robot-v2.load-conversation-from-redis`, `robot-v2.save-conversation-to-redis`. | langfuse_client, @observe trong robot_v2_services, routes                                                |
| **Alert system**                 | Gửi alert khi Redis timeout/fail, workflow timeout/fail, webhook exception.                                                                                            | send_alert_safe, AlertType, AlertLevel                                                                   |

---

## 5. Sơ đồ luồng (ASCII)

```
                    CLIENT (POST /webhook)
                              |
                              v
                    +-------------------+
                    | robot_v2_routes   |
                    | webhook()         |
                    +-------------------+
                              |
                              v
                    +------------------------------------------+
                    | RobotV2Service.webhook()                  |
                    | @observe("robot-v2.webhook-service")     |
                    +------------------------------------------+
                              |
        +---------------------+---------------------+
        v                     v                     v
  [Step 1]             [Step 1.5]             [Step 2]
  Redis GET             Reopen/WelcomeBack    _process_with_ai
  (REDIS_CLIENT)        (early return)        (PoliciesWorkflow)
        |                     |                     |
        v                     v                     v
  conversation          return response       +------------------+
  (dict)                (no AI)               | Orchestrator      |
        |                                     | - Redis (queue)   |
        +---------------------+----------------| - RabbitMQ (push) |
                              |                | - LLM (intent,   |
                              v                |   answer)        |
                    [Step 3] Update State      | - Tool (HTTP)    |
                    [Step 4] Handle END       +------------------+
                    [Step 5] Redis SET                |
                    [Step 6] Return                   v
                                              status, answer,
                                              record_new
                                                      |
                                                      v
                                            [Step 3–6] Update, Save,
                                            Normalize, Return
```

---

## 6. Input / Output của webhook

**Input (payload):**

- `conversation_id` (bắt buộc)
- `message` (optional): tin nhắn user
- `history` (optional): lịch sử chat (cho LLM)
- `audio_url` (optional)
- `question_idx` (optional)

**Output (response):**

- `status`: "CHAT" | "END" | "ERROR" | -1
- `text`: list câu trả lời (block mood/text/audio/image/...)
- `conversation_id`
- `msg`: "success" | thông báo lỗi
- `record`: trạng thái record mới nhất

---

## 7. Tài liệu tham chiếu trong code

| Nội dung               | File / Vị trí                                                                                                                                                                             |
| ---------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Route webhook          | `app/api/routes/robot_v2_routes.py` — POST /webhook                                                                                                                                       |
| Service webhook        | `app/api/services/robot_v2_services.py` — `webhook()`, `_load_conversation`, `_process_with_ai`, `_update_conversation_state`, `_handle_end_status`, `_set_session_conversation_to_redis` |
| Workflow process       | `app/module/workflows/v2_robot_workflow/chatbot/policies/conversation_workflow_orchestrator.py` — `process()`                                                                             |
| PoliciesWorkflow       | `app/module/workflows/v2_robot_workflow/chatbot/policies/__init__.py` — `PoliciesWorkflow.process`                                                                                        |
| Redis session          | `app/common/redis/v2_session_store.py` — set_session, get_session, set_profile_flag_processing                                                                                            |
| Redis client (webhook) | `app/api/services/robot_v2_services.py` — REDIS_CLIENT (RedisClient từ channel)                                                                                                           |
| Tool executor          | `app/module/workflows/v2_robot_workflow/tools/tool_interface.py` — TOOL_EXECUTOR_URL                                                                                                      |
| RabbitMQ push          | `app/module/workflows/v2_robot_workflow/chatbot/policies/rabbitmq_task_queue_manager.py` — push_task_to_queue                                                                             |