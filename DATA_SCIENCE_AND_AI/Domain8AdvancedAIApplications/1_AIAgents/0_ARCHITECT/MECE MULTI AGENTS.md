# Kiến trúc Multi-Agent Mở Rộng - Chi tiết

## 1. Tổng quan kiến trúc đầy đủ

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                    │
│                                    EXTERNAL LAYER                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                   API GATEWAY                                                │  │
│  │   [REST/GraphQL]              [WebSocket]              [gRPC]                               │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              ORCHESTRATION LAYER                                             │  │
│  │                                                                                              │  │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐           │  │
│  │   │   Chief     │      │   Chief     │      │   Chief     │      │  Chief      │           │  │
│  │   │  Agent #1   │      │  Agent #2   │      │  Agent #3   │      │ Agent #N    │           │  │
│  │   │  (Active)   │      │ (Standby)   │      │ (Standby)   │      │ (Standby)   │           │  │
│  │   └──────┬──────┘      └─────────────┘      └─────────────┘      └─────────────┘           │  │
│  │          │                    ▲                    ▲                    ▲                   │  │
│  │          │                    │                    │                    │                   │  │
│  │          │         ┌─────────┴────────────────────┴────────────────────┴──────────┐        │  │
│  │          │         │                    LEADER ELECTION (Redis/etcd)              │        │  │
│  │          │         └──────────────────────────────────────────────────────────────┘        │  │
│  │          │                                                                                  │  │
│  └──────────┼──────────────────────────────────────────────────────────────────────────────────┘  │
│             │                                                                                      │
│             ▼                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                MESSAGE BUS (Redis PubSub)                                    │  │
│  │                                                                                              │  │
│  │   Channels:                                                                                  │  │
│  │   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │  │
│  │   │task_available│ │ plan_ready   │ │ aggregation_ │ │ final_report │ │ agent_health │     │  │
│  │   │              │ │              │ │    ready     │ │              │ │              │     │  │
│  │   └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘     │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                 PLANNING LAYER                                               │  │
│  │                                                                                              │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                              PLANNER CLUSTER                                         │   │  │
│  │   │                                                                                      │   │  │
│  │   │    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                        │   │  │
│  │   │    │  Planner #1  │    │  Planner #2  │    │  Planner #3  │                        │   │  │
│  │   │    │              │    │              │    │              │                        │   │  │
│  │   │    │ ┌──────────┐ │    │ ┌──────────┐ │    │ ┌──────────┐ │                        │   │  │
│  │   │    │ │ LLM Call │ │    │ │ LLM Call │ │    │ │ LLM Call │ │                        │   │  │
│  │   │    │ │ (GPT-4)  │ │    │ │ (Claude) │ │    │ │ (Gemini) │ │   ◄── Multi-LLM       │   │  │
│  │   │    │ └──────────┘ │    │ └──────────┘ │    │ └──────────┘ │       Support          │   │  │
│  │   │    └──────────────┘    └──────────────┘    └──────────────┘                        │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
└─────────────────────────────────────────┼──────────────────────────────────────────────────────────┘
                                          │
                                          ▼
```

---

## 2. Router & Registry Layer (Chi tiết)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ROUTING LAYER                                                   │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              INTELLIGENT ROUTER                                              │  │
│  │                                                                                              │  │
│  │   Input: Plan with subtasks                                                                  │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │  {                                                                                   │   │  │
│  │   │    "plan_id": "abc123",                                                              │   │  │
│  │   │    "subtasks": [                                                                     │   │  │
│  │   │      {"id": "t1", "type": "math", "action": "sum", "args": [1,2,3]},                │   │  │
│  │   │      {"id": "t2", "type": "date", "action": "today"},                                │   │  │
│  │   │      {"id": "t3", "type": "web", "action": "navigate", "url": "..."},               │   │  │
│  │   │      {"id": "t4", "type": "math", "action": "multiply", "args": [5,6]}              │   │  │
│  │   │    ]                                                                                 │   │  │
│  │   │  }                                                                                   │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                         │                                                    │  │
│  │                                         ▼                                                    │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                         CAPABILITY REGISTRY (Redis Hash)                             │   │  │
│  │   │                                                                                      │   │  │
│  │   │   KEY: "agent:capabilities"                                                          │   │  │
│  │   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │  │
│  │   │   │  "math"  : ["sum", "subtract", "multiply", "divide", "average"]             │   │   │  │
│  │   │   │  "date"  : ["today", "format", "diff", "add_days", "timezone"]              │   │   │  │
│  │   │   │  "web"   : ["navigate", "click", "extract", "screenshot", "scroll"]         │   │   │  │
│  │   │   │  "email" : ["send", "read", "search", "draft"]                              │   │   │  │
│  │   │   │  "file"  : ["read", "write", "delete", "list", "compress"]                  │   │   │  │
│  │   │   │  "db"    : ["query", "insert", "update", "delete"]                          │   │   │  │
│  │   │   └─────────────────────────────────────────────────────────────────────────────┘   │   │  │
│  │   │                                                                                      │   │  │
│  │   │   KEY: "agent:pool:status"                                                           │   │  │
│  │   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │  │
│  │   │   │  "math"  : {"workers": 3, "healthy": 3, "queue_depth": 5}                   │   │   │  │
│  │   │   │  "date"  : {"workers": 1, "healthy": 1, "queue_depth": 0}                   │   │   │  │
│  │   │   │  "web"   : {"workers": 5, "healthy": 4, "queue_depth": 12}                  │   │   │  │
│  │   │   └─────────────────────────────────────────────────────────────────────────────┘   │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                         │                                                    │  │
│  │                                         ▼                                                    │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                         ROUTING DECISION ENGINE                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   │   Strategies:                                                                        │   │  │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │   │  │
│  │   │   │Round Robin  │  │Least Queue  │  │ Capability  │  │  Priority   │               │   │  │
│  │   │   │             │  │   Depth     │  │   Match     │  │   Based     │               │   │  │
│  │   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘               │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                    ┌────────────────────┼────────────────────┬─────────────────────┐              │
│                    │                    │                    │                     │              │
│                    ▼                    ▼                    ▼                     ▼              │
│              ┌──────────┐        ┌──────────┐        ┌──────────┐          ┌──────────┐          │
│              │  QUEUE   │        │  QUEUE   │        │  QUEUE   │          │  QUEUE   │          │
│              │  math    │        │  date    │        │   web    │    ...   │   new    │          │
│              │          │        │          │        │          │          │          │          │
│              │ depth: 5 │        │ depth: 0 │        │ depth: 12│          │ depth: 0 │          │
│              └──────────┘        └──────────┘        └──────────┘          └──────────┘          │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Pool Layer (Chi tiết với Auto-scaling)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      EXECUTION LAYER                                               │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                              │  │
│  │     POOL: MATH                          POOL: WEB                        POOL: DATE         │  │
│  │     ════════════                        ═════════                        ══════════         │  │
│  │                                                                                              │  │
│  │     ┌─────────────┐                     ┌─────────────┐                  ┌─────────────┐    │  │
│  │     │ TASK QUEUE  │                     │ TASK QUEUE  │                  │ TASK QUEUE  │    │  │
│  │     │   (math)    │                     │   (web)     │                  │   (date)    │    │  │
│  │     │             │                     │             │                  │             │    │  │
│  │     │ ┌─┐┌─┐┌─┐┌─┐│                     │ ┌─┐┌─┐┌─┐┌─┐│                  │ ┌─┐         │    │  │
│  │     │ │1││2││3││4││                     │ │1││2││3││4││                  │ │1│         │    │  │
│  │     │ └─┘└─┘└─┘└─┘│                     │ └─┘└─┘└─┘└─┘│                  │ └─┘         │    │  │
│  │     └──────┬──────┘                     └──────┬──────┘                  └──────┬──────┘    │  │
│  │            │                                   │                                │          │  │
│  │            │ competing                         │ competing                      │          │  │
│  │            │ consumers                         │ consumers                      │          │  │
│  │            ▼                                   ▼                                ▼          │  │
│  │     ┌─────────────────────┐             ┌─────────────────────┐          ┌───────────┐    │  │
│  │     │                     │             │                     │          │           │    │  │
│  │     │  ┌───┐ ┌───┐ ┌───┐  │             │  ┌───┐ ┌───┐ ┌───┐  │          │   ┌───┐   │    │  │
│  │     │  │ W1│ │ W2│ │ W3│  │             │  │ W1│ │ W2│ │ W3│  │          │   │ W1│   │    │  │
│  │     │  │   │ │   │ │   │  │             │  │   │ │   │ │   │  │          │   │   │   │    │  │
│  │     │  │ ██│ │ ░░│ │ ██│  │             │  │ ██│ │ ██│ │ ░░│  │          │   │ ██│   │    │  │
│  │     │  └───┘ └───┘ └───┘  │             │  └───┘ └───┘ └───┘  │          │   └───┘   │    │  │
│  │     │   busy  idle  busy  │             │   ┌───┐ ┌───┐       │          │           │    │  │
│  │     │                     │             │   │ W4│ │ W5│       │          │           │    │  │
│  │     │                     │             │   │   │ │   │       │          │           │    │  │
│  │     │                     │             │   │ ██│ │ ░░│       │          │           │    │  │
│  │     │                     │             │   └───┘ └───┘       │          │           │    │  │
│  │     └─────────────────────┘             └─────────────────────┘          └───────────┘    │  │
│  │                                                                                              │  │
│  │     Workers: 3                          Workers: 5                       Workers: 1         │  │
│  │     Busy: 2                             Busy: 3                          Busy: 1            │  │
│  │     Queue: 4                            Queue: 4                         Queue: 0           │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    AUTO-SCALER                                               │  │
│  │                                                                                              │  │
│  │   Rules:                                                                                     │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF queue_depth > 10 AND workers < max_workers:                                    │   │  │
│  │   │       → SCALE UP (+1 worker)                                                        │   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF queue_depth < 2 AND workers > min_workers AND idle_time > 5min:                │   │  │
│  │   │       → SCALE DOWN (-1 worker)                                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF all_workers_busy AND queue_depth > 20:                                         │   │  │
│  │   │       → ALERT: Pool overloaded                                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  │   Current State:                                                                             │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │  Pool     │ Min │ Max │ Current │ Queue │ Action                                    │   │  │
│  │   │───────────┼─────┼─────┼─────────┼───────┼────────────────────────────────────────── │   │  │
│  │   │  math     │  1  │  10 │    3    │   4   │ STABLE                                    │   │  │
│  │   │  web      │  2  │  20 │    5    │   12  │ SCALING UP → 6                            │   │  │
│  │   │  date     │  1  │  3  │    1    │   0   │ STABLE                                    │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Aggregation & Result Flow

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AGGREGATION LAYER                                               │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              RESULT STORE (Redis)                                            │  │
│  │                                                                                              │  │
│  │   KEY: "results:{plan_id}"                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   plan_id: "abc123"                                                                  │   │  │
│  │   │   total_tasks: 4                                                                     │   │  │
│  │   │   completed: 3                                                                       │   │  │
│  │   │   failed: 0                                                                          │   │  │
│  │   │   pending: 1                                                                         │   │  │
│  │   │                                                                                      │   │  │
│  │   │   results: {                                                                         │   │  │
│  │   │     "t1": {"status": "success", "output": 6, "duration_ms": 50},                    │   │  │
│  │   │     "t2": {"status": "success", "output": "2024-01-15", "duration_ms": 10},         │   │  │
│  │   │     "t3": {"status": "success", "output": {...html...}, "duration_ms": 3500},       │   │  │
│  │   │     "t4": {"status": "pending"}                                                      │   │  │
│  │   │   }                                                                                  │   │  │
│  │   │                                                                                      │   │  │
│  │   │   TTL: 3600 seconds                                                                  │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              AGGREGATOR SERVICE                                              │  │
│  │                                                                                              │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   Monitoring Loop:                                                                   │   │  │
│  │   │                                                                                      │   │  │
│  │   │   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                     │   │  │
│  │   │   │  Poll Result │ ───▶ │  Check if    │ ───▶ │  All Done?   │                     │   │  │
│  │   │   │    Store     │      │  Completed   │      │              │                     │   │  │
│  │   │   └──────────────┘      └──────────────┘      └───────┬──────┘                     │   │  │
│  │   │                                                        │                            │   │  │
│  │   │                              ┌─────────────────────────┼─────────────────────────┐  │   │  │
│  │   │                              │                         │                         │  │   │  │
│  │   │                              ▼                         ▼                         │  │   │  │
│  │   │                         ┌─────────┐              ┌─────────┐                     │  │   │  │
│  │   │                         │   NO    │              │   YES   │                     │  │   │  │
│  │   │                         │         │              │         │                     │  │   │  │
│  │   │                         │ Wait &  │              │ Publish │                     │  │   │  │
│  │   │                         │ Retry   │              │ Event   │                     │  │   │  │
│  │   │                         └─────────┘              └────┬────┘                     │  │   │  │
│  │   │                                                       │                          │  │   │  │
│  │   │                                                       ▼                          │  │   │  │
│  │   │                                              "aggregation_ready"                 │  │   │  │
│  │   │                                                       │                          │  │   │  │
│  │   │                                                       │ MESSAGE BUS              │  │   │  │
│  │   │                                                       ▼                          │  │   │  │
│  │   │                                              ┌──────────────┐                    │  │   │  │
│  │   │                                              │   SUMMARY    │                    │  │   │  │
│  │   │                                              │    AGENT     │                    │  │   │  │
│  │   │                                              └──────────────┘                    │  │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Thêm Pool mới (Quy trình mở rộng)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              ADDING NEW CAPABILITY: "EMAIL"                                        │
│                                                                                                    │
│                                                                                                    │
│   STEP 1: Register Capability                                                                      │
│   ═══════════════════════════                                                                      │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │   REGISTRY.set("email", ["send", "read", "search", "draft", "reply"])                       │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 2: Create Task Queue                                                                        │
│   ═════════════════════════                                                                        │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   BEFORE:                                    AFTER:                                          │ │
│   │   ┌────────┐ ┌────────┐ ┌────────┐          ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │ │
│   │   │ math_q │ │ date_q │ │ web_q  │    →     │ math_q │ │ date_q │ │ web_q  │ │email_q │   │ │
│   │   └────────┘ └────────┘ └────────┘          └────────┘ └────────┘ └────────┘ └────────┘   │ │
│   │                                                                        ▲                    │ │
│   │                                                                        │                    │ │
│   │                                                                       NEW                   │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 3: Deploy Pool Workers                                                                      │
│   ═══════════════════════════                                                                      │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │ │
│   │   │                           POOL: EMAIL (NEW)                                          │   │ │
│   │   │                                                                                      │   │ │
│   │   │     ┌─────────────┐                                                                  │   │ │
│   │   │     │ TASK QUEUE  │                                                                  │   │ │
│   │   │     │  (email)    │                                                                  │   │ │
│   │   │     └──────┬──────┘                                                                  │   │ │
│   │   │            │                                                                          │   │ │
│   │   │            ▼                                                                          │   │ │
│   │   │     ┌───────────────────┐                                                            │   │ │
│   │   │     │   ┌───┐   ┌───┐   │                                                            │   │ │
│   │   │     │   │ W1│   │ W2│   │    ◄── Initial: 2 workers                                 │   │ │
│   │   │     │   │   │   │   │   │        Auto-scale: 1-5                                     │   │ │
│   │   │     │   │ ░░│   │ ░░│   │                                                            │   │ │
│   │   │     │   └───┘   └───┘   │                                                            │   │ │
│   │   │     └───────────────────┘                                                            │   │ │
│   │   │                                                                                      │   │ │
│   │   └─────────────────────────────────────────────────────────────────────────────────────┘   │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 4: Router Auto-Discovery                                                                    │
│   ═════════════════════════════                                                                    │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   Router checks Registry → Finds "email" capability → Routes email tasks automatically      │ │
│   │                                                                                              │ │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │ │
│   │   │   Input Task: {"type": "email", "action": "send", "to": "...", "body": "..."}    │     │ │
│   │   │                                           │                                       │     │ │
│   │   │                                           ▼                                       │     │ │
│   │   │   Router: registry.get("email") → ["send", "read", ...]  ✓ EXISTS                │     │ │
│   │   │                                           │                                       │     │ │
│   │   │                                           ▼                                       │     │ │
│   │   │   Router: queue("email").push(task)                                               │     │ │
│   │   └───────────────────────────────────────────────────────────────────────────────────┘     │ │
│   │                                                                                              │ │
│   │   ✅ NO CODE CHANGE IN ROUTER REQUIRED                                                      │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Failure Handling & Recovery

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    FAILURE SCENARIOS                                               │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 1: Worker Crash                                                                          │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   BEFORE:                                          AFTER:                                          │
│   ┌───────────────────┐                           ┌───────────────────┐                           │
│   │   ┌───┐   ┌───┐   │                           │   ┌───┐   ┌───┐   │                           │
│   │   │ W1│   │ W2│   │                           │   │ W1│   │ W2│   │                           │
│   │   │ ██│   │ ██│   │         W2 crash          │   │ ██│   │ ☠ │   │                           │
│   │   └───┘   └───┘   │         ───────▶          │   └───┘   └───┘   │                           │
│   │   ┌───┐           │                           │   ┌───┐   ┌───┐   │                           │
│   │   │ W3│           │                           │   │ W3│   │ W4│   │  ◄── Auto-scale          │
│   │   │ ░░│           │                           │   │ ░░│   │ ░░│   │      replacement          │
│   │   └───┘           │                           │   └───┘   └───┘   │                           │
│   └───────────────────┘                           └───────────────────┘                           │
│                                                                                                    │
│   Recovery:                                                                                        │
│   1. Health monitor detects W2 heartbeat timeout (5s)                                             │
│   2. Task W2 was processing → returned to queue (visibility timeout)                              │
│   3. Auto-scaler spawns W4                                                                        │
│   4. W4 picks up the task                                                                          │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 2: Pool Overload                                                                         │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   ┌───────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                            │   │
│   │   Queue Depth: ████████████████████████████████████████  (150 tasks)                      │   │
│   │   Workers:     ███████████████████████████████████████   (20/20 - MAX)                    │   │
│   │   All Busy:    ████████████████████████████████████████  (100%)                           │   │
│   │                                                                                            │   │
│   │   Actions:                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │  1. ALERT: Pool "web" overloaded (Slack/PagerDuty)                                 │  │   │
│   │   │  2. BACKPRESSURE: Router slows down accepting new tasks                            │  │   │
│   │   │  3. PRIORITY QUEUE: High priority tasks processed first                            │  │   │
│   │   │  4. SPILLOVER: Route to backup pool if configured                                  │  │   │
│   │   └────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                            │   │
│   └───────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 3: Chief Agent Crash (Leader Election)                                                   │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   BEFORE:                               AFTER (automatic):                                   │ │
│   │                                                                                              │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #1  │                        │  Chief #1  │                                      │ │
│   │   │  (Active)  │   #1 crash             │    (☠)     │                                      │ │
│   │   │     ★      │   ───────▶             │            │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #2  │                        │  Chief #2  │                                      │ │
│   │   │ (Standby)  │                        │  (Active)  │  ◄── Promoted by Redis Lock         │ │
│   │   │            │                        │     ★      │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #3  │                        │  Chief #3  │                                      │ │
│   │   │ (Standby)  │                        │ (Standby)  │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │                                                                                              │ │
│   │   Recovery:                                                                                  │ │
│   │   1. Redis lock expires (TTL 10s)                                                           │ │
│   │   2. Chief #2 acquires lock → becomes Active                                                │ │
│   │   3. Reads pending state from Result Store                                                  │ │
│   │   4. Continues workflow                                                                      │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Complete Data Flow Sequence

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    COMPLETE FLOW SEQUENCE                                          │
│                                                                                                    │
│   User        API      Chief    Planner    Router     Pools      Aggregator  Summary              │
│    │           │         │         │          │          │            │          │                 │
│    │  Request  │         │         │          │          │            │          │                 │
│    │─────────▶│         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │ task_   │         │          │          │            │          │                 │
│    │           │available│         │          │          │            │          │                 │
│    │           │────────▶│         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │ create  │          │          │            │          │                 │
│    │           │         │  plan   │          │          │            │          │                 │
│    │           │         │────────▶│          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │plan_ready│          │            │          │                 │
│    │           │         │         │─────────▶│          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │ dispatch │            │          │                 │
│    │           │         │         │          │ to queues│            │          │                 │
│    │           │         │         │          │─────────▶│            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │  execute   │          │                 │
│    │           │         │         │          │          │  tasks     │          │                 │
│    │           │         │         │          │          │───────────▶│          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │  results   │          │                 │
│    │           │         │         │          │          │───────────▶│          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │ check    │                 │
│    │           │         │         │          │          │            │ complete │                 │
│    │           │         │         │          │          │            │─────────▶│                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │aggregation                 │
│    │           │         │         │          │          │            │  ready   │                 │
│    │           │         │         │          │          │            │─────────▶│                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │ generate       │
│    │           │         │         │          │          │            │          │ report         │
│    │           │         │         │          │          │            │          │────────┐       │
│    │           │         │         │          │          │            │          │        │       │
│    │           │         │final_   │          │          │            │          │        │       │
│    │           │         │report   │          │          │            │          │◀───────┘       │
│    │           │         │◀────────────────────────────────────────────────────────              │
│    │           │         │         │          │          │            │          │                 │
│    │           │◀────────│         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │◀──────────│         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │  Response │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│                                                                                                    │
│   Legend:                                                                                          │
│   ────────▶  Message Bus (PubSub)                                                                 │
│   ─────────▶ Task Queue (Push/Pull)                                                               │
│   ───────┐   Direct call / Internal                                                               │
│          │                                                                                         │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Technology Stack Recommendation

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                 RECOMMENDED TECHNOLOGY STACK                                       │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                              │  │
│  │   COMPONENT              │  TECHNOLOGY           │  WHY                                     │  │
│  │  ────────────────────────┼───────────────────────┼──────────────────────────────────────── │  │
│  │                          │                       │                                          │  │
│  │   Message Bus            │  Redis PubSub         │  Already using, lightweight, fast       │  │
│  │                          │                       │                                          │  │
│  │   Task Queues            │  Redis Streams        │  Persistent, consumer groups,           │  │
│  │                          │  (hoặc BullMQ)        │  acknowledgment, dead letter            │  │
│  │                          │                       │                                          │  │
│  │   Capability Registry    │  Redis Hash           │  Fast lookup, atomic updates            │  │
│  │                          │                       │                                          │  │
│  │   Result Store           │  Redis Hash + TTL     │  Correlation tracking, auto-expire      │  │
│  │                          │                       │                                          │  │
│  │   Leader Election        │  Redis Lock (Redlock) │  Simple, reliable                       │  │
│  │                          │  hoặc etcd            │                                          │  │
│  │                          │                       │                                          │  │
│  │   Pool Workers           │  Kubernetes Deployment│  Auto-scaling, health checks            │  │
│  │                          │  + HPA                │                                          │  │
│  │                          │                       │                                          │  │
│  │   Monitoring             │  Prometheus + Grafana │  Metrics, alerts, dashboards            │  │
│  │                          │                       │                                          │  │
│  │   Tracing                │  LangFuse             │  Already integrated                     │  │
│  │                          │                       │                                          │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              INFRASTRUCTURE DIAGRAM                                          │  │
│  │                                                                                              │  │
│  │                    ┌───────────────────────────────────────────┐                            │  │
│  │                    │            KUBERNETES CLUSTER              │                            │  │
│  │                    │                                            │                            │  │
│  │   ┌────────────────┼────────────────────────────────────────────┼────────────────────┐      │  │
│  │   │                │                                            │                    │      │  │
│  │   │   ┌────────┐   │   ┌────────┐   ┌────────┐   ┌────────┐   │   ┌────────┐       │      │  │
│  │   │   │ Chief  │   │   │Planner │   │ Router │   │Summary │   │   │Aggreg- │       │      │  │
│  │   │   │  Pod   │   │   │  Pod   │   │  Pod   │   │  Pod   │   │   │ ator   │       │      │  │
│  │   │   │ (x2)   │   │   │ (x2)   │   │ (x2)   │   │ (x2)   │   │   │  Pod   │       │      │  │
│  │   │   └────────┘   │   └────────┘   └────────┘   └────────┘   │   └────────┘       │      │  │
│  │   │                │                                            │                    │      │  │
│  │   │   ┌────────────┴────────────────────────────────────────────┴────────────┐     │      │  │
│  │   │   │                         WORKER POOLS                                  │     │      │  │
│  │   │   │                                                                       │     │      │  │
│  │   │   │   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐         │     │      │  │
│  │   │   │   │   Math   │   │   Web    │   │   Date   │   │  Email   │         │     │      │  │
│  │   │   │   │ Workers  │   │ Workers  │   │ Workers  │   │ Workers  │   ...   │     │      │  │
│  │   │   │   │  (HPA)   │   │  (HPA)   │   │  (HPA)   │   │  (HPA)   │         │     │      │  │
│  │   │   │   │  1-10    │   │  2-20    │   │  1-3     │   │  1-5     │         │     │      │  │
│  │   │   │   └──────────┘   └──────────┘   └──────────┘   └──────────┘         │     │      │  │
│  │   │   │                                                                       │     │      │  │
│  │   │   └───────────────────────────────────────────────────────────────────────┘     │      │  │
│  │   │                                                                                  │      │  │
│  │   └──────────────────────────────────────────────────────────────────────────────────┘      │  │
│  │                                         │                                                    │  │
│  │                                         │                                                    │  │
│  │                    ┌────────────────────┴────────────────────┐                              │  │
│  │                    │                                         │                              │  │
│  │                    ▼                                         ▼                              │  │
│  │            ┌──────────────┐                         ┌──────────────┐                        │  │
│  │            │    REDIS     │                         │  POSTGRESQL  │                        │  │
│  │            │   Cluster    │                         │   (State)    │                        │  │
│  │            │              │                         │              │                        │  │
│  │            │ • PubSub     │                         │ • Tasks      │                        │  │
│  │            │ • Streams    │                         │ • Results    │                        │  │
│  │            │ • Registry   │                         │ • Audit Log  │                        │  │
│  │            │ • Locks      │                         │              │                        │  │
│  │            └──────────────┘                         └──────────────┘                        │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Tóm tắt

Kiến trúc này cho phép:

| Capability       | Hỗ trợ                                 |
| ---------------- | -------------------------------------- |
| Thêm Pool mới    | ✅ Chỉ cần register + deploy            |
| Scale từng Pool  | ✅ Kubernetes HPA                       |
| Fault tolerance  | ✅ Leader election, task retry          |
| MessageBus       | ✅ Vẫn dùng cho coordination            |
| Task parallelism | ✅ Queue per pool + competing consumers |
| Observability    | ✅ LangFuse + Prometheus                |

Dưới đây là 2 block markdown đầy đủ, bạn chỉ cần copy vào file `.md`:

