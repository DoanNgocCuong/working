# Kiến trúc Multi-Agent Mở Rộng - Chi tiết

## 1. Tổng quan kiến trúc đầy đủ

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                    │
│                                    EXTERNAL LAYER                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                   API GATEWAY                                                │  │
│  │   [REST/GraphQL]              [WebSocket]              [gRPC]                               │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              ORCHESTRATION LAYER                                             │  │
│  │                                                                                              │  │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐      ┌─────────────┐           │  │
│  │   │   Chief     │      │   Chief     │      │   Chief     │      │  Chief      │           │  │
│  │   │  Agent #1   │      │  Agent #2   │      │  Agent #3   │      │ Agent #N    │           │  │
│  │   │  (Active)   │      │ (Standby)   │      │ (Standby)   │      │ (Standby)   │           │  │
│  │   └──────┬──────┘      └─────────────┘      └─────────────┘      └─────────────┘           │  │
│  │          │                    ▲                    ▲                    ▲                   │  │
│  │          │                    │                    │                    │                   │  │
│  │          │         ┌─────────┴────────────────────┴────────────────────┴──────────┐        │  │
│  │          │         │                    LEADER ELECTION (Redis/etcd)              │        │  │
│  │          │         └──────────────────────────────────────────────────────────────┘        │  │
│  │          │                                                                                  │  │
│  └──────────┼──────────────────────────────────────────────────────────────────────────────────┘  │
│             │                                                                                      │
│             ▼                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                MESSAGE BUS (Redis PubSub)                                    │  │
│  │                                                                                              │  │
│  │   Channels:                                                                                  │  │
│  │   ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │  │
│  │   │task_available│ │ plan_ready   │ │ aggregation_ │ │ final_report │ │ agent_health │     │  │
│  │   │              │ │              │ │    ready     │ │              │ │              │     │  │
│  │   └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘     │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                 PLANNING LAYER                                               │  │
│  │                                                                                              │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                              PLANNER CLUSTER                                         │   │  │
│  │   │                                                                                      │   │  │
│  │   │    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                        │   │  │
│  │   │    │  Planner #1  │    │  Planner #2  │    │  Planner #3  │                        │   │  │
│  │   │    │              │    │              │    │              │                        │   │  │
│  │   │    │ ┌──────────┐ │    │ ┌──────────┐ │    │ ┌──────────┐ │                        │   │  │
│  │   │    │ │ LLM Call │ │    │ │ LLM Call │ │    │ │ LLM Call │ │                        │   │  │
│  │   │    │ │ (GPT-4)  │ │    │ │ (Claude) │ │    │ │ (Gemini) │ │   ◄── Multi-LLM       │   │  │
│  │   │    │ └──────────┘ │    │ └──────────┘ │    │ └──────────┘ │       Support          │   │  │
│  │   │    └──────────────┘    └──────────────┘    └──────────────┘                        │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
└─────────────────────────────────────────┼──────────────────────────────────────────────────────────┘
                                          │
                                          ▼
```

---

## 2. Router & Registry Layer (Chi tiết)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ROUTING LAYER                                                   │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              INTELLIGENT ROUTER                                              │  │
│  │                                                                                              │  │
│  │   Input: Plan with subtasks                                                                  │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │  {                                                                                   │   │  │
│  │   │    "plan_id": "abc123",                                                              │   │  │
│  │   │    "subtasks": [                                                                     │   │  │
│  │   │      {"id": "t1", "type": "math", "action": "sum", "args": [1,2,3]},                │   │  │
│  │   │      {"id": "t2", "type": "date", "action": "today"},                                │   │  │
│  │   │      {"id": "t3", "type": "web", "action": "navigate", "url": "..."},               │   │  │
│  │   │      {"id": "t4", "type": "math", "action": "multiply", "args": [5,6]}              │   │  │
│  │   │    ]                                                                                 │   │  │
│  │   │  }                                                                                   │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                         │                                                    │  │
│  │                                         ▼                                                    │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                         CAPABILITY REGISTRY (Redis Hash)                             │   │  │
│  │   │                                                                                      │   │  │
│  │   │   KEY: "agent:capabilities"                                                          │   │  │
│  │   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │  │
│  │   │   │  "math"  : ["sum", "subtract", "multiply", "divide", "average"]             │   │   │  │
│  │   │   │  "date"  : ["today", "format", "diff", "add_days", "timezone"]              │   │   │  │
│  │   │   │  "web"   : ["navigate", "click", "extract", "screenshot", "scroll"]         │   │   │  │
│  │   │   │  "email" : ["send", "read", "search", "draft"]                              │   │   │  │
│  │   │   │  "file"  : ["read", "write", "delete", "list", "compress"]                  │   │   │  │
│  │   │   │  "db"    : ["query", "insert", "update", "delete"]                          │   │   │  │
│  │   │   └─────────────────────────────────────────────────────────────────────────────┘   │   │  │
│  │   │                                                                                      │   │  │
│  │   │   KEY: "agent:pool:status"                                                           │   │  │
│  │   │   ┌─────────────────────────────────────────────────────────────────────────────┐   │   │  │
│  │   │   │  "math"  : {"workers": 3, "healthy": 3, "queue_depth": 5}                   │   │   │  │
│  │   │   │  "date"  : {"workers": 1, "healthy": 1, "queue_depth": 0}                   │   │   │  │
│  │   │   │  "web"   : {"workers": 5, "healthy": 4, "queue_depth": 12}                  │   │   │  │
│  │   │   └─────────────────────────────────────────────────────────────────────────────┘   │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                         │                                                    │  │
│  │                                         ▼                                                    │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                         ROUTING DECISION ENGINE                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   │   Strategies:                                                                        │   │  │
│  │   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │   │  │
│  │   │   │Round Robin  │  │Least Queue  │  │ Capability  │  │  Priority   │               │   │  │
│  │   │   │             │  │   Depth     │  │   Match     │  │   Based     │               │   │  │
│  │   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘               │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                    ┌────────────────────┼────────────────────┬─────────────────────┐              │
│                    │                    │                    │                     │              │
│                    ▼                    ▼                    ▼                     ▼              │
│              ┌──────────┐        ┌──────────┐        ┌──────────┐          ┌──────────┐          │
│              │  QUEUE   │        │  QUEUE   │        │  QUEUE   │          │  QUEUE   │          │
│              │  math    │        │  date    │        │   web    │    ...   │   new    │          │
│              │          │        │          │        │          │          │          │          │
│              │ depth: 5 │        │ depth: 0 │        │ depth: 12│          │ depth: 0 │          │
│              └──────────┘        └──────────┘        └──────────┘          └──────────┘          │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Pool Layer (Chi tiết với Auto-scaling)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                      EXECUTION LAYER                                               │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                              │  │
│  │     POOL: MATH                          POOL: WEB                        POOL: DATE         │  │
│  │     ════════════                        ═════════                        ══════════         │  │
│  │                                                                                              │  │
│  │     ┌─────────────┐                     ┌─────────────┐                  ┌─────────────┐    │  │
│  │     │ TASK QUEUE  │                     │ TASK QUEUE  │                  │ TASK QUEUE  │    │  │
│  │     │   (math)    │                     │   (web)     │                  │   (date)    │    │  │
│  │     │             │                     │             │                  │             │    │  │
│  │     │ ┌─┐┌─┐┌─┐┌─┐│                     │ ┌─┐┌─┐┌─┐┌─┐│                  │ ┌─┐         │    │  │
│  │     │ │1││2││3││4││                     │ │1││2││3││4││                  │ │1│         │    │  │
│  │     │ └─┘└─┘└─┘└─┘│                     │ └─┘└─┘└─┘└─┘│                  │ └─┘         │    │  │
│  │     └──────┬──────┘                     └──────┬──────┘                  └──────┬──────┘    │  │
│  │            │                                   │                                │          │  │
│  │            │ competing                         │ competing                      │          │  │
│  │            │ consumers                         │ consumers                      │          │  │
│  │            ▼                                   ▼                                ▼          │  │
│  │     ┌─────────────────────┐             ┌─────────────────────┐          ┌───────────┐    │  │
│  │     │                     │             │                     │          │           │    │  │
│  │     │  ┌───┐ ┌───┐ ┌───┐  │             │  ┌───┐ ┌───┐ ┌───┐  │          │   ┌───┐   │    │  │
│  │     │  │ W1│ │ W2│ │ W3│  │             │  │ W1│ │ W2│ │ W3│  │          │   │ W1│   │    │  │
│  │     │  │   │ │   │ │   │  │             │  │   │ │   │ │   │  │          │   │   │   │    │  │
│  │     │  │ ██│ │ ░░│ │ ██│  │             │  │ ██│ │ ██│ │ ░░│  │          │   │ ██│   │    │  │
│  │     │  └───┘ └───┘ └───┘  │             │  └───┘ └───┘ └───┘  │          │   └───┘   │    │  │
│  │     │   busy  idle  busy  │             │   ┌───┐ ┌───┐       │          │           │    │  │
│  │     │                     │             │   │ W4│ │ W5│       │          │           │    │  │
│  │     │                     │             │   │   │ │   │       │          │           │    │  │
│  │     │                     │             │   │ ██│ │ ░░│       │          │           │    │  │
│  │     │                     │             │   └───┘ └───┘       │          │           │    │  │
│  │     └─────────────────────┘             └─────────────────────┘          └───────────┘    │  │
│  │                                                                                              │  │
│  │     Workers: 3                          Workers: 5                       Workers: 1         │  │
│  │     Busy: 2                             Busy: 3                          Busy: 1            │  │
│  │     Queue: 4                            Queue: 4                         Queue: 0           │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                    AUTO-SCALER                                               │  │
│  │                                                                                              │  │
│  │   Rules:                                                                                     │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF queue_depth > 10 AND workers < max_workers:                                    │   │  │
│  │   │       → SCALE UP (+1 worker)                                                        │   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF queue_depth < 2 AND workers > min_workers AND idle_time > 5min:                │   │  │
│  │   │       → SCALE DOWN (-1 worker)                                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   │   IF all_workers_busy AND queue_depth > 20:                                         │   │  │
│  │   │       → ALERT: Pool overloaded                                                      │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  │   Current State:                                                                             │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │  Pool     │ Min │ Max │ Current │ Queue │ Action                                    │   │  │
│  │   │───────────┼─────┼─────┼─────────┼───────┼────────────────────────────────────────── │   │  │
│  │   │  math     │  1  │  10 │    3    │   4   │ STABLE                                    │   │  │
│  │   │  web      │  2  │  20 │    5    │   12  │ SCALING UP → 6                            │   │  │
│  │   │  date     │  1  │  3  │    1    │   0   │ STABLE                                    │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Aggregation & Result Flow

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AGGREGATION LAYER                                               │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              RESULT STORE (Redis)                                            │  │
│  │                                                                                              │  │
│  │   KEY: "results:{plan_id}"                                                                   │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   plan_id: "abc123"                                                                  │   │  │
│  │   │   total_tasks: 4                                                                     │   │  │
│  │   │   completed: 3                                                                       │   │  │
│  │   │   failed: 0                                                                          │   │  │
│  │   │   pending: 1                                                                         │   │  │
│  │   │                                                                                      │   │  │
│  │   │   results: {                                                                         │   │  │
│  │   │     "t1": {"status": "success", "output": 6, "duration_ms": 50},                    │   │  │
│  │   │     "t2": {"status": "success", "output": "2024-01-15", "duration_ms": 10},         │   │  │
│  │   │     "t3": {"status": "success", "output": {...html...}, "duration_ms": 3500},       │   │  │
│  │   │     "t4": {"status": "pending"}                                                      │   │  │
│  │   │   }                                                                                  │   │  │
│  │   │                                                                                      │   │  │
│  │   │   TTL: 3600 seconds                                                                  │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └──────────────────────────────────────┬──────────────────────────────────────────────────────┘  │
│                                         │                                                          │
│                                         ▼                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              AGGREGATOR SERVICE                                              │  │
│  │                                                                                              │  │
│  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │  │
│  │   │                                                                                      │   │  │
│  │   │   Monitoring Loop:                                                                   │   │  │
│  │   │                                                                                      │   │  │
│  │   │   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐                     │   │  │
│  │   │   │  Poll Result │ ───▶ │  Check if    │ ───▶ │  All Done?   │                     │   │  │
│  │   │   │    Store     │      │  Completed   │      │              │                     │   │  │
│  │   │   └──────────────┘      └──────────────┘      └───────┬──────┘                     │   │  │
│  │   │                                                        │                            │   │  │
│  │   │                              ┌─────────────────────────┼─────────────────────────┐  │   │  │
│  │   │                              │                         │                         │  │   │  │
│  │   │                              ▼                         ▼                         │  │   │  │
│  │   │                         ┌─────────┐              ┌─────────┐                     │  │   │  │
│  │   │                         │   NO    │              │   YES   │                     │  │   │  │
│  │   │                         │         │              │         │                     │  │   │  │
│  │   │                         │ Wait &  │              │ Publish │                     │  │   │  │
│  │   │                         │ Retry   │              │ Event   │                     │  │   │  │
│  │   │                         └─────────┘              └────┬────┘                     │  │   │  │
│  │   │                                                       │                          │  │   │  │
│  │   │                                                       ▼                          │  │   │  │
│  │   │                                              "aggregation_ready"                 │  │   │  │
│  │   │                                                       │                          │  │   │  │
│  │   │                                                       │ MESSAGE BUS              │  │   │  │
│  │   │                                                       ▼                          │  │   │  │
│  │   │                                              ┌──────────────┐                    │  │   │  │
│  │   │                                              │   SUMMARY    │                    │  │   │  │
│  │   │                                              │    AGENT     │                    │  │   │  │
│  │   │                                              └──────────────┘                    │  │   │  │
│  │   │                                                                                      │   │  │
│  │   └─────────────────────────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Thêm Pool mới (Quy trình mở rộng)

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              ADDING NEW CAPABILITY: "EMAIL"                                        │
│                                                                                                    │
│                                                                                                    │
│   STEP 1: Register Capability                                                                      │
│   ═══════════════════════════                                                                      │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │   REGISTRY.set("email", ["send", "read", "search", "draft", "reply"])                       │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 2: Create Task Queue                                                                        │
│   ═════════════════════════                                                                        │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   BEFORE:                                    AFTER:                                          │ │
│   │   ┌────────┐ ┌────────┐ ┌────────┐          ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐   │ │
│   │   │ math_q │ │ date_q │ │ web_q  │    →     │ math_q │ │ date_q │ │ web_q  │ │email_q │   │ │
│   │   └────────┘ └────────┘ └────────┘          └────────┘ └────────┘ └────────┘ └────────┘   │ │
│   │                                                                        ▲                    │ │
│   │                                                                        │                    │ │
│   │                                                                       NEW                   │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 3: Deploy Pool Workers                                                                      │
│   ═══════════════════════════                                                                      │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────┐   │ │
│   │   │                           POOL: EMAIL (NEW)                                          │   │ │
│   │   │                                                                                      │   │ │
│   │   │     ┌─────────────┐                                                                  │   │ │
│   │   │     │ TASK QUEUE  │                                                                  │   │ │
│   │   │     │  (email)    │                                                                  │   │ │
│   │   │     └──────┬──────┘                                                                  │   │ │
│   │   │            │                                                                          │   │ │
│   │   │            ▼                                                                          │   │ │
│   │   │     ┌───────────────────┐                                                            │   │ │
│   │   │     │   ┌───┐   ┌───┐   │                                                            │   │ │
│   │   │     │   │ W1│   │ W2│   │    ◄── Initial: 2 workers                                 │   │ │
│   │   │     │   │   │   │   │   │        Auto-scale: 1-5                                     │   │ │
│   │   │     │   │ ░░│   │ ░░│   │                                                            │   │ │
│   │   │     │   └───┘   └───┘   │                                                            │   │ │
│   │   │     └───────────────────┘                                                            │   │ │
│   │   │                                                                                      │   │ │
│   │   └─────────────────────────────────────────────────────────────────────────────────────┘   │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                                          │
│                                         ▼                                                          │
│   STEP 4: Router Auto-Discovery                                                                    │
│   ═════════════════════════════                                                                    │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   Router checks Registry → Finds "email" capability → Routes email tasks automatically      │ │
│   │                                                                                              │ │
│   │   ┌───────────────────────────────────────────────────────────────────────────────────┐     │ │
│   │   │   Input Task: {"type": "email", "action": "send", "to": "...", "body": "..."}    │     │ │
│   │   │                                           │                                       │     │ │
│   │   │                                           ▼                                       │     │ │
│   │   │   Router: registry.get("email") → ["send", "read", ...]  ✓ EXISTS                │     │ │
│   │   │                                           │                                       │     │ │
│   │   │                                           ▼                                       │     │ │
│   │   │   Router: queue("email").push(task)                                               │     │ │
│   │   └───────────────────────────────────────────────────────────────────────────────────┘     │ │
│   │                                                                                              │ │
│   │   ✅ NO CODE CHANGE IN ROUTER REQUIRED                                                      │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Failure Handling & Recovery

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    FAILURE SCENARIOS                                               │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 1: Worker Crash                                                                          │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   BEFORE:                                          AFTER:                                          │
│   ┌───────────────────┐                           ┌───────────────────┐                           │
│   │   ┌───┐   ┌───┐   │                           │   ┌───┐   ┌───┐   │                           │
│   │   │ W1│   │ W2│   │                           │   │ W1│   │ W2│   │                           │
│   │   │ ██│   │ ██│   │         W2 crash          │   │ ██│   │ ☠ │   │                           │
│   │   └───┘   └───┘   │         ───────▶          │   └───┘   └───┘   │                           │
│   │   ┌───┐           │                           │   ┌───┐   ┌───┐   │                           │
│   │   │ W3│           │                           │   │ W3│   │ W4│   │  ◄── Auto-scale          │
│   │   │ ░░│           │                           │   │ ░░│   │ ░░│   │      replacement          │
│   │   └───┘           │                           │   └───┘   └───┘   │                           │
│   └───────────────────┘                           └───────────────────┘                           │
│                                                                                                    │
│   Recovery:                                                                                        │
│   1. Health monitor detects W2 heartbeat timeout (5s)                                             │
│   2. Task W2 was processing → returned to queue (visibility timeout)                              │
│   3. Auto-scaler spawns W4                                                                        │
│   4. W4 picks up the task                                                                          │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 2: Pool Overload                                                                         │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   ┌───────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                            │   │
│   │   Queue Depth: ████████████████████████████████████████  (150 tasks)                      │   │
│   │   Workers:     ███████████████████████████████████████   (20/20 - MAX)                    │   │
│   │   All Busy:    ████████████████████████████████████████  (100%)                           │   │
│   │                                                                                            │   │
│   │   Actions:                                                                                 │   │
│   │   ┌────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │  1. ALERT: Pool "web" overloaded (Slack/PagerDuty)                                 │  │   │
│   │   │  2. BACKPRESSURE: Router slows down accepting new tasks                            │  │   │
│   │   │  3. PRIORITY QUEUE: High priority tasks processed first                            │  │   │
│   │   │  4. SPILLOVER: Route to backup pool if configured                                  │  │   │
│   │   └────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                            │   │
│   └───────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                    │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│  SCENARIO 3: Chief Agent Crash (Leader Election)                                                   │
│  ═══════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ │
│   │                                                                                              │ │
│   │   BEFORE:                               AFTER (automatic):                                   │ │
│   │                                                                                              │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #1  │                        │  Chief #1  │                                      │ │
│   │   │  (Active)  │   #1 crash             │    (☠)     │                                      │ │
│   │   │     ★      │   ───────▶             │            │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #2  │                        │  Chief #2  │                                      │ │
│   │   │ (Standby)  │                        │  (Active)  │  ◄── Promoted by Redis Lock         │ │
│   │   │            │                        │     ★      │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │   ┌────────────┐                        ┌────────────┐                                      │ │
│   │   │  Chief #3  │                        │  Chief #3  │                                      │ │
│   │   │ (Standby)  │                        │ (Standby)  │                                      │ │
│   │   └────────────┘                        └────────────┘                                      │ │
│   │                                                                                              │ │
│   │   Recovery:                                                                                  │ │
│   │   1. Redis lock expires (TTL 10s)                                                           │ │
│   │   2. Chief #2 acquires lock → becomes Active                                                │ │
│   │   3. Reads pending state from Result Store                                                  │ │
│   │   4. Continues workflow                                                                      │ │
│   │                                                                                              │ │
│   └─────────────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Complete Data Flow Sequence

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    COMPLETE FLOW SEQUENCE                                          │
│                                                                                                    │
│   User        API      Chief    Planner    Router     Pools      Aggregator  Summary              │
│    │           │         │         │          │          │            │          │                 │
│    │  Request  │         │         │          │          │            │          │                 │
│    │─────────▶│         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │ task_   │         │          │          │            │          │                 │
│    │           │available│         │          │          │            │          │                 │
│    │           │────────▶│         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │ create  │          │          │            │          │                 │
│    │           │         │  plan   │          │          │            │          │                 │
│    │           │         │────────▶│          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │plan_ready│          │            │          │                 │
│    │           │         │         │─────────▶│          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │ dispatch │            │          │                 │
│    │           │         │         │          │ to queues│            │          │                 │
│    │           │         │         │          │─────────▶│            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │  execute   │          │                 │
│    │           │         │         │          │          │  tasks     │          │                 │
│    │           │         │         │          │          │───────────▶│          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │  results   │          │                 │
│    │           │         │         │          │          │───────────▶│          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │ check    │                 │
│    │           │         │         │          │          │            │ complete │                 │
│    │           │         │         │          │          │            │─────────▶│                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │aggregation                 │
│    │           │         │         │          │          │            │  ready   │                 │
│    │           │         │         │          │          │            │─────────▶│                 │
│    │           │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │ generate       │
│    │           │         │         │          │          │            │          │ report         │
│    │           │         │         │          │          │            │          │────────┐       │
│    │           │         │         │          │          │            │          │        │       │
│    │           │         │final_   │          │          │            │          │        │       │
│    │           │         │report   │          │          │            │          │◀───────┘       │
│    │           │         │◀────────────────────────────────────────────────────────              │
│    │           │         │         │          │          │            │          │                 │
│    │           │◀────────│         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │◀──────────│         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│    │  Response │         │         │          │          │            │          │                 │
│    │           │         │         │          │          │            │          │                 │
│                                                                                                    │
│   Legend:                                                                                          │
│   ────────▶  Message Bus (PubSub)                                                                 │
│   ─────────▶ Task Queue (Push/Pull)                                                               │
│   ───────┐   Direct call / Internal                                                               │
│          │                                                                                         │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Technology Stack Recommendation

```
┌────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                 RECOMMENDED TECHNOLOGY STACK                                       │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                                                                                              │  │
│  │   COMPONENT              │  TECHNOLOGY           │  WHY                                     │  │
│  │  ────────────────────────┼───────────────────────┼──────────────────────────────────────── │  │
│  │                          │                       │                                          │  │
│  │   Message Bus            │  Redis PubSub         │  Already using, lightweight, fast       │  │
│  │                          │                       │                                          │  │
│  │   Task Queues            │  Redis Streams        │  Persistent, consumer groups,           │  │
│  │                          │  (hoặc BullMQ)        │  acknowledgment, dead letter            │  │
│  │                          │                       │                                          │  │
│  │   Capability Registry    │  Redis Hash           │  Fast lookup, atomic updates            │  │
│  │                          │                       │                                          │  │
│  │   Result Store           │  Redis Hash + TTL     │  Correlation tracking, auto-expire      │  │
│  │                          │                       │                                          │  │
│  │   Leader Election        │  Redis Lock (Redlock) │  Simple, reliable                       │  │
│  │                          │  hoặc etcd            │                                          │  │
│  │                          │                       │                                          │  │
│  │   Pool Workers           │  Kubernetes Deployment│  Auto-scaling, health checks            │  │
│  │                          │  + HPA                │                                          │  │
│  │                          │                       │                                          │  │
│  │   Monitoring             │  Prometheus + Grafana │  Metrics, alerts, dashboards            │  │
│  │                          │                       │                                          │  │
│  │   Tracing                │  LangFuse             │  Already integrated                     │  │
│  │                          │                       │                                          │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐  │
│  │                              INFRASTRUCTURE DIAGRAM                                          │  │
│  │                                                                                              │  │
│  │                    ┌───────────────────────────────────────────┐                            │  │
│  │                    │            KUBERNETES CLUSTER              │                            │  │
│  │                    │                                            │                            │  │
│  │   ┌────────────────┼────────────────────────────────────────────┼────────────────────┐      │  │
│  │   │                │                                            │                    │      │  │
│  │   │   ┌────────┐   │   ┌────────┐   ┌────────┐   ┌────────┐   │   ┌────────┐       │      │  │
│  │   │   │ Chief  │   │   │Planner │   │ Router │   │Summary │   │   │Aggreg- │       │      │  │
│  │   │   │  Pod   │   │   │  Pod   │   │  Pod   │   │  Pod   │   │   │ ator   │       │      │  │
│  │   │   │ (x2)   │   │   │ (x2)   │   │ (x2)   │   │ (x2)   │   │   │  Pod   │       │      │  │
│  │   │   └────────┘   │   └────────┘   └────────┘   └────────┘   │   └────────┘       │      │  │
│  │   │                │                                            │                    │      │  │
│  │   │   ┌────────────┴────────────────────────────────────────────┴────────────┐     │      │  │
│  │   │   │                         WORKER POOLS                                  │     │      │  │
│  │   │   │                                                                       │     │      │  │
│  │   │   │   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐         │     │      │  │
│  │   │   │   │   Math   │   │   Web    │   │   Date   │   │  Email   │         │     │      │  │
│  │   │   │   │ Workers  │   │ Workers  │   │ Workers  │   │ Workers  │   ...   │     │      │  │
│  │   │   │   │  (HPA)   │   │  (HPA)   │   │  (HPA)   │   │  (HPA)   │         │     │      │  │
│  │   │   │   │  1-10    │   │  2-20    │   │  1-3     │   │  1-5     │         │     │      │  │
│  │   │   │   └──────────┘   └──────────┘   └──────────┘   └──────────┘         │     │      │  │
│  │   │   │                                                                       │     │      │  │
│  │   │   └───────────────────────────────────────────────────────────────────────┘     │      │  │
│  │   │                                                                                  │      │  │
│  │   └──────────────────────────────────────────────────────────────────────────────────┘      │  │
│  │                                         │                                                    │  │
│  │                                         │                                                    │  │
│  │                    ┌────────────────────┴────────────────────┐                              │  │
│  │                    │                                         │                              │  │
│  │                    ▼                                         ▼                              │  │
│  │            ┌──────────────┐                         ┌──────────────┐                        │  │
│  │            │    REDIS     │                         │  POSTGRESQL  │                        │  │
│  │            │   Cluster    │                         │   (State)    │                        │  │
│  │            │              │                         │              │                        │  │
│  │            │ • PubSub     │                         │ • Tasks      │                        │  │
│  │            │ • Streams    │                         │ • Results    │                        │  │
│  │            │ • Registry   │                         │ • Audit Log  │                        │  │
│  │            │ • Locks      │                         │              │                        │  │
│  │            └──────────────┘                         └──────────────┘                        │  │
│  │                                                                                              │  │
│  └─────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Tóm tắt

Kiến trúc này cho phép:

| Capability       | Hỗ trợ                                 |
| ---------------- | -------------------------------------- |
| Thêm Pool mới    | ✅ Chỉ cần register + deploy            |
| Scale từng Pool  | ✅ Kubernetes HPA                       |
| Fault tolerance  | ✅ Leader election, task retry          |
| MessageBus       | ✅ Vẫn dùng cho coordination            |
| Task parallelism | ✅ Queue per pool + competing consumers |
| Observability    | ✅ LangFuse + Prometheus                |

Dưới đây là 2 block markdown đầy đủ, bạn chỉ cần copy vào file `.md`:





---

  
ChatCode

Chat

Code

### SpecialProd_Agent_FinAIWebBrowser_T12_2025-.zip

zip

# PHẦN A: DEMO CURSOR <img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/> ## Mô tả Dự án: Cursor-style Coding Agent Demo (Q4 - Choreography) #### 1. Tổng quan dự án (Q4 Version) **Tên dự án:** Multi-Agent Coding System với Hierarchi

pasted

Your task: Lên 1 file SDD siêu chi tiết 50 - 100 trang cho toàn bộ dự án. Sao cho.  Instruction:  1. Đọc kỹ hiểu Thông tin dự án: Base on dự án đang thực hiện (Phần A: Demo Cursor siêu đơn giản)

1. Đọc Kiến trúc dự kiến + (Phần B: bắt đầu bằng: Kiến trúc dự kiến ) - brainstorm để lên kiến trúc phù hợp core LangGraph , Agent core Xem kỹ code base hiện tại (code ở file zip)
2. Output buộc phải Buộc phải Base on template SDD (Phần C template: SOFTWARE DESIGN DOCUMENT (SDD) - ULTIMATE TEMPLATE)
    
    Bắt buộc: Output tiếng việt, markdown 30 trang. Base on Product Design, Kiến trúc dự án dự kiến (bạn phải brainstorm MECE TOÀN BỘ CÁC KIẾN TRÚC KHÁC NHAU, để chọn ra kiến trúc tốt nhất), output bắt buộc phải theo template ở phần C.
    

Demo Cursor đơn giản nhé

Show more

Dec 17

Thinking about designing a comprehensive 30-page SDD document in Vietnamese for a LangGraph-based Agent project, synthesizing project requirements, architectural options, and template standards.

Tôi sẽ bắt đầu bằng việc xem code base hiện tại trong file zip để hiểu rõ cấu trúc dự án.

18 steps

Xem HLD document

Show working file

Orchestrated comprehensive SDD architecture for multi-agent coding system.

Tôi đã xem xét code base hiện tại. Bây giờ tôi sẽ tạo SDD chi tiết theo template. Để tạo một tài liệu hoàn chỉnh, tôi cần xem thêm skill hướng dẫn tạo docx.

Xem skill tạo docx

Orchestrated comprehensive SDD document creation using markdown template.

Bây giờ tôi sẽ tạo SDD chi tiết cho dự án Multi-Agent Coding System (Cursor Demo).

4 steps

Presented file

Hoàn thành tài liệu SDD chi tiết, sẵn sàng tóm tắt kết quả.

Đã hoàn thành **Software Design Document (SDD)** chi tiết cho dự án **Multi-Agent Coding System - Cursor Demo**. Tài liệu bao gồm khoảng **30+ trang** với các nội dung chính:

## 📋 Tóm Tắt Nội Dung SDD

### Phần I: Nền Tảng & Kiến Trúc

- **Executive Summary**: Tổng quan hệ thống Multi-Agent với Q4 Hierarchical Choreography
- **Architecture**: 4-Layer Architecture (Governance → Perception → Cognition → Action)
- **Agent Design**: 4 agents chuyên biệt (Chief, Coder, Tester, Reviewer) + Message Bus

### Phần II: Chi Tiết Triển Khai

- **LLD chi tiết**: Code mẫu cho từng component
    - `message_bus.py` - Redis PubSub wrapper
    - `base_agent.py` - Base class cho P2P agents
    - `chief.py`, `coder.py`, `tester.py`, `reviewer.py` - Implementation agents
    - `file_tools.py`, `execution_tools.py` - Action layer tools
- **API Design**: OpenAPI spec cho REST endpoints
- **Data Design**: Redis data structures cho state management

### Phần III: Production Readiness

- **Resilience**: Retry strategy, Circuit breaker, Health checks
- **Observability**: Prometheus metrics, Structured logging, LangFuse tracing
- **Deployment**: Docker, Kubernetes configs

### Phần IV: Phân Tích Kiến Trúc

- **MECE Brainstorm**: So sánh 4 quadrants (Q1-Q4)
- **ADRs**: Architecture Decision Records cho các lựa chọn quan trọng
- **Trade-offs**: Phân tích đánh đổi giữa các options

### Phần V: Roadmap

- **4 Sprints** trong 4 tuần
- **Production Checklist** đầy đủ

## 🔑 Highlights

- **Kiến trúc Q4** được chọn vì: Parallel execution, Fault isolation, Scalability
- **P2P Communication** qua Redis PubSub cho low latency
- **4 Agents** với roles rõ ràng và topics subscribe/publish được định nghĩa
- **Code mẫu** chi tiết có thể implement ngay

Sdd multiagent codingsystem v1.0

Document · MD 

# PHẦN A: Mô tả Dự án: Travel Planning Agent (Q3 - Autonomy) #### 1. Tổng quan dự án **Tên dự án:** AI Travel Planner - Autonomous Agent với 4-Layer Architecture **Mục tiêu:** Xây dựng một **single autonomous agent** tự động lên kế hoạch du lịch chi tiết, chạy trên kiến trúc **4-layer (0–3)** với

pasted

Hoàn toàn tương tự viết SDD cho demo này cũng trong kiến trúc zip code đó luôn

Dec 17

Reviewed previous SDD format để tạo tương tự cho Travel Planning Agent.

Tôi sẽ viết SDD cho Travel Planning Agent theo format tương tự SDD Multi-Agent Coding System. Trước tiên, để tôi xem lại transcript để đảm bảo format nhất quán.

8 steps

Xem thêm phần cấu trúc SDD

Show working file

Orchestrated SDD creation for Travel Planning Agent architecture.

Tôi đã nắm được format. Bây giờ tôi sẽ tạo SDD chi tiết cho Travel Planning Agent với Q3 Architecture.

Tạo SDD cho Travel Planning Agent với Q3 Architecture

SDD_TravelPlanningAgent_v1.0.md

Continue

Dec 17

2 steps

The file was too long and may have been truncated.

Check what files exist

# SOFTWARE DESIGN DOCUMENT (SDD) ## Multi-Agent Coding System - Cursor Demo **Version 1.0 | Production Quality Standard** --- ## DOCUMENT METADATA ```yaml Title: "Multi-Agent Coding System - Cursor Demo" Document_ID: "SDD-FINAI-CURSOR-DEMO-v1.0" # Ownership Author: "AI Architecture Team" Co_Au

pasted

Với dự án FinAI này của chúng tôi, thì có cần update gì SDD này để mapping với source code chung này không ???

Nếu có thì viết cho tớ 1 file update.md nhá

Dec 17

Assessed FinAI codebase structure to align Travel Agent SDD specifications.

Để tôi xem lại cấu trúc source code FinAI hiện tại để xác định những gì cần update trong SDD.

12 steps

Xem Redis graph_pub_sub implementation

Show working file

Phân tích cấu trúc FinAI và agent base hiện tại.

20s

Để tôi phân tích kỹ hơn source code hiện tại để so sánh với SDD.

12 steps

Xem BaseState model

Show working file

Gathered information and prepared detailed documentation file.

Bây giờ tôi đã hiểu rõ cấu trúc source code hiện tại. Tôi sẽ tạo file UPDATE.md chi tiết các điểm cần cập nhật trong SDD.

2 steps

Presented file

Assessed SDD updates needed for FinAI source code mapping.

Đã tạo file **SDD_MULTI_AGENT_UPDATE.md** với **10 điểm chính** cần cập nhật để SDD mapping đúng với source code FinAI hiện tại.

## 📋 Tóm Tắt Các Thay Đổi Chính

|#|Vấn Đề|SDD Hiện Tại|Cần Update|
|---|---|---|---|
|**1**|File Structure|`app/module/finai_agent/`|`app/module/agent/multi_agent_coding/`|
|**2**|Base Class|Custom `P2PAgent`|`P2PMixin + BaseAgent`|
|**3**|Registration|Không có|Dùng `@agent` decorator|
|**4**|Dependencies|Manual|`DependencyResolver` + `dependency_specs`|
|**5**|State Model|Custom|Extend `BaseState`|
|**6**|Kafka|Không có|Kế thừa từ `BaseAgent.send_kafka_one()`|
|**7**|LangFuse|Custom setup|Đã có sẵn `@observe`|
|**8**|Auto-discovery|Không đề cập|`AgentFactory` auto-discover từ `agent.py`|
|**9**|Message Bus|In-memory only|Tích hợp Redis PubSub pattern|
|**10**|API|Custom|Dùng `AgentFactory.get_agent()`|

## 🔑 Điểm Quan Trọng Nhất

1. **File `agent.py` là BẮT BUỘC** - `AgentFactory` auto-discover agents từ file này
2. **Dùng `@agent` decorator** thay vì manual class definition
3. **Extend `BaseAgent`** để kế thừa Kafka, LangFuse, LangGraph integration
4. **Sub-agents (Coder, Tester, Reviewer)** không cần `@agent` decorator - chỉ orchestrator chính cần

Sdd multi agent update

Document · MD 

# SOFTWARE DESIGN DOCUMENT (SDD) # finAI Finance Agent Web Browser **Production Quality Standard | Version 1.0** > 🎯 **Tài liệu này kết hợp 100% best practices từ:** > > - IEEE 1016-2009 Standard > - Google Design Docs & SRE Book > - AWS Well-Architected Framework > - Netflix/Stripe/Meta Produc

pasted

Với dự án FinAI này của chúng tôi, thì có cần update gì SDD này để mapping với source code chung này không ??? Nếu có thì viết cho tớ 1 file update.md nhá

Dec 17

Assessed SDD alignment needs and planned comprehensive documentation update.

Tôi sẽ xem lại transcript trước đó để hiểu context và so sánh SDD mới với codebase hiện có của FinAI.

4 steps

Xem cấu trúc app/common/agent để hiểu base framework

Phân tích khoảng cách SDD và codebase, chuẩn bị tài liệu cập nhật.

Tôi sẽ review transcript để xem chi tiết gap analysis đã thực hiện, sau đó tạo file update.md cho bạn.

5 steps

Now I have a clear picture of the existing structure.

Check base agent implementation pattern

Show working file

continue

Dec 17

3 steps

Check existing Redis PubSub implementation

Show working file

Assembled comprehensive documentation for agent specification.

Bây giờ tôi sẽ tạo file UPDATE.md chi tiết cho SDD FinAI Browser Agent:

2 steps

Presented file

Finalized file creation and user delivery.

Đã tạo file **SDD_BROWSER_AGENT_UPDATE.md** với 14 sections chi tiết:

**Những điểm update quan trọng nhất:**

1. **File Structure**: Đặt tại `app/module/agent/finai_browser_agent/` thay vì `app/module/finai_agent/` để AgentFactory auto-discover
2. **Base Class**: Extend `BaseAgent[BrowserState]` + tạo `P2PMixin` cho P2P capabilities thay vì tạo class riêng từ đầu
3. **Registration**: Bắt buộc dùng `@agent` decorator với đầy đủ params (`agent_id`, `input_model`, `state_model`, `input_to_state`, `dependency_specs`)
4. **State Models**: Extend từ `BaseState` (có field `status` required bởi infrastructure)
5. **Message Bus**: Tích hợp với Redis PubSub pattern có sẵn trong `graph_pub_sub.py` thay vì implement từ đầu
6. **LangGraph**: Function `create_browser_graph()` phải return `CompiledStateGraph` để tương thích với `BaseAgent.run_async()`
7. **Kafka/LangFuse**: Đã có sẵn trong BaseAgent, chỉ cần đăng ký dependencies

File cũng bao gồm **Migration Checklist** với 6 phases để triển khai từng bước.

Sdd browser agent update

Document · MD 

### SpecialProd_Agent_FinAIWebBrowser_T12_2025-.zip

zip

Đánh giá source code hiện tại về cách triển khai multi agent

Dec 23

23 steps

View Planner agent - navigation planning

Show working file

Orchestrated comprehensive evaluation framework for multi-agent architecture assessment.

Tôi đã phân tích toàn bộ source code. Bây giờ tôi sẽ tạo báo cáo đánh giá chi tiết:

2 steps

Presented file

Chuẩn bị đánh giá triển khai multi agent.

## Tóm tắt đánh giá Multi-Agent Implementation

### Điểm số tổng thể: **7/10**

### Điểm mạnh ✅

1. **Architecture 4-layer rõ ràng**: Governance → Perception → Cognition → Action
2. **P2P Agent Pattern tốt**: Base class với inbox queue, topic subscription, graceful shutdown
3. **MessageBus chất lượng**: Redis PubSub + in-memory fallback, message deduplication O(1), auto-cleanup TTL
4. **MCP Integration**: Dual mode (MCP + legacy Playwright fallback)
5. **Observability**: LangFuse tracing + action logs cho UI

### Điểm yếu cần sửa ⚠️

1. **🚨 CRITICAL - Debug code với Windows path** trong `action_executor.py` (lines 113-126) - sẽ crash trên Linux/Container
2. **Không tích hợp với `app/common/agent/`**:
    - P2PAgent là custom class, không dùng BaseAgent
    - Thiếu `@agent` decorator, DependencyResolver, Kafka integration
    - Duplicate LangFuse tracing code
3. **MessageBus Singleton không thread-safe** - có race condition
4. **Error handling chưa đầy đủ** - khi 1 agent crash, các agents khác không biết
5. **Hard-coded URLs trong Planner** - chỉ hỗ trợ Yahoo Finance

### Khuyến nghị ưu tiên

|Priority|Task|Effort|
|---|---|---|
|P0|Remove debug code Windows path|5 min|
|P1|Fix MessageBus thread-safety|30 min|
|P2|Add error broadcasting|1 hour|
|P3|Create P2PMixin tích hợp BaseAgent|2-3 days|
|P4|Strategy pattern cho sources|1 day|

Multi agent evaluation report

Document · MD 

Recommend cho mình cách thiết kế agent

Dec 23

Synthesized design patterns từ multiple codebases cho agent architecture.

Create comprehensive Agent Design Recommendation document

flowchart TD Chief[ChiefAgent] --> Planner[PlannerAgent] Planner -->|plan_ready| AgentRouter[AgentRouter] subgraph mathPool[KhoAgentMath] MathSum[MathAgentSum] MathSub[MathAgentSub] end subgraph datePool[KhoAgentDate] DateToday[DateAgentToday] end subgraph webPool[KhoAgentWeb] WebNav[WebAgentNavigate] end AgentRouter -->|task: sum/sub| mathPool AgentRouter -->|task: today_date| datePool AgentRouter -->|task: web_action| webPool mathPool --> AgentRouter datePool --> AgentRouter webPool --> AgentRouter AgentRouter --> Summary[SummaryAgent]

1. Với kiểu triển khai agent như này có dùng được Message Bus nữa không ???
2. với cách như này và mở rộng về sau ko giới hạn thì đâu là thiết kế multi agent hiệu quả??? DEEP RESEARCH ĐỂ CHO TỚ BEST PRACTICES - gồm report chi tiết toàn bộ MECE các kiểu các cách thiết kế của Multi Agent - chi tiết markdown tiếng việt dài 1000 từ - mỗi kiến trúc đều có phân tích, sơ đồ hình vẽ mermaid, hoặc ASCII để minh hoạ

TUYỆT ĐỐI KO CODE, đánh giá giúp tớ về architect thôi

Show more

Dec 23

3 steps

Presented file

Orchestrated comprehensive multi-agent architecture analysis with Vietnamese documentation.

## Tóm tắt trả lời cho bạn

### 1. MessageBus có dùng được không?

**CÓ**, nhưng cần phân tách vai trò:

|Layer|Technology|Mục đích|
|---|---|---|
|**Coordination**|MessageBus (Redis PubSub)|Chief ↔ Planner ↔ Summary|
|**Execution**|Task Queue (Redis Stream/RabbitMQ)|Router → Pool agents|

MessageBus phù hợp cho **broadcast/subscribe** (ai đang làm gì, workflow state). Nhưng Pool agents cần **Task Queue** riêng để **competing consumers** có thể parallel processing.

---

### 2. Kiến trúc đề xuất: Hybrid Router-Pool

```
                    ┌──────────┐
                    │  Chief   │◄─────────────────────┐
                    └────┬─────┘                      │
                         │ MESSAGE BUS                │
                    ┌────▼─────┐                      │
                    │ Planner  │                      │
                    └────┬─────┘                      │
                         │                            │
                    ┌────▼─────┐                      │
                    │  Router  │                      │
                    │+Registry │                      │
                    └────┬─────┘                      │
           ┌─────────────┼─────────────┐              │
           ▼             ▼             ▼              │
      ┌─────────┐   ┌─────────┐   ┌─────────┐        │
      │ Queue A │   │ Queue B │   │ Queue C │ TASK   │
      └────┬────┘   └────┬────┘   └────┬────┘ QUEUES │
           ▼             ▼             ▼              │
      ┌─────────┐   ┌─────────┐   ┌─────────┐        │
      │ Pool A  │   │ Pool B  │   │ Pool C  │ POOLS  │
      │ ██ ██   │   │ ██      │   │ ██ ██   │        │
      └────┬────┘   └────┬────┘   └────┬────┘        │
           └─────────────┼─────────────┘              │
                         ▼                            │
                    ┌──────────┐                      │
                    │Aggregator│                      │
                    └────┬─────┘                      │
                         │ MESSAGE BUS                │
                    ┌────▼─────┐                      │
                    │ Summary  │──────────────────────┘
                    └──────────┘
```

---

### 3. Tại sao pattern này tốt cho mở rộng?

|Yêu cầu|Giải pháp|
|---|---|
|Thêm capability mới|Đăng ký vào Registry + tạo Queue + Pool|
|Scale pool|Thêm agents consume từ cùng queue|
|Fault tolerance|1 agent chết → pool vẫn chạy|
|Load balancing|Tự nhiên qua competing consumers|

### 4. 6 Pattern đã phân tích MECE

1. **Sequential Chain** - Pipeline đơn giản
2. **Hierarchical** - Task decomposition (bạn đang dùng)
3. **Flat P2P** - Collaborative, no leader
4. **Blackboard** - Shared state reasoning
5. **Event Saga** - Microservices style
6. **Hybrid Router-Pool** ⭐ - **Đề xuất cho bạn**

Chi tiết có trong document với sơ đồ ASCII cho từng pattern.

Multi agent architecture best practices

Document · MD 

```
┌──────────┐
                    │  Chief   │◄─────────────────────┐
                    └────┬─────┘                      │
                         │ MESSAGE BUS                │
                    ┌────▼─────┐                      │
                    │ Planner  │                      │
                    └────┬─────┘                      │
                         │                            │
                    ┌────▼─────┐                      │
                    │  Router  │                      │
                    │+Registry │                      │
                    └────┬─────┘                      │
           ┌─────────────┼─────────────┐              │
           ▼             ▼             ▼              │
      ┌─────────┐   ┌─────────┐   ┌─────────┐        │
      │ Queue A │   │ Queue B │   │ Queue C │ TASK   │
      └────┬────┘   └────┬────┘   └────┬────┘ QUEUES │
           ▼             ▼             ▼              │
      ┌─────────┐   ┌─────────┐   ┌─────────┐        │
      │ Pool A  │   │ Pool B  │   │ Pool C  │ POOLS  │
      │ ██ ██   │   │ ██      │   │ ██ ██   │        │
      └────┬────┘   └────┬────┘   └────┬────┘        │
           └─────────────┼─────────────┘              │
                         ▼                            │
                    ┌──────────┐                      │
                    │Aggregator│                      │
                    └────┬─────┘                      │
                         │ MESSAGE BUS                │
                    ┌────▼─────┐                      │
                    │ Summary  │──────────────────────┘
                    └──────────┘
```

vẽ kiến trúc mở rộng đi (ko code)

Show more

Dec 23

3 steps

Presented file

Orchestrated comprehensive distributed system architecture with detailed diagrams.

Đã vẽ xong kiến trúc mở rộng chi tiết! Document bao gồm:

## Tổng quan các diagram đã vẽ

|#|Diagram|Mô tả|
|---|---|---|
|1|**Full Architecture**|4 layers: External → Orchestration → Planning → Routing|
|2|**Router & Registry**|Chi tiết Capability Registry + Routing Decision Engine|
|3|**Pool Layer**|Task Queues + Workers + Auto-scaler rules|
|4|**Aggregation Flow**|Result Store + Aggregator monitoring loop|
|5|**Add New Pool**|4 bước mở rộng không cần sửa code Router|
|6|**Failure Handling**|3 scenarios: Worker crash, Overload, Leader crash|
|7|**Sequence Diagram**|Complete flow từ User → Response|
|8|**Infrastructure**|Kubernetes + Redis + PostgreSQL|

## Điểm mấu chốt của kiến trúc

```
┌──────────────────────────────────────────────────────────────────┐
│                                                                  │
│   ┌─────────────┐                                                │
│   │   Chief     │  ◄─── Leader Election (Redis Lock)            │
│   │  (Active)   │                                                │
│   └──────┬──────┘                                                │
│          │ MESSAGE BUS (Coordination)                            │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │  Planner    │  ◄─── Multi-LLM support                       │
│   └──────┬──────┘                                                │
│          │                                                       │
│          ▼                                                       │
│   ┌─────────────┐     ┌─────────────────┐                       │
│   │   Router    │────▶│ REGISTRY        │  ◄─── Auto-discovery  │
│   │             │     │ math: [sum,sub] │                       │
│   └──────┬──────┘     │ web: [navigate] │                       │
│          │            │ email: [send]   │  ◄─── Thêm mới ở đây  │
│          │            └─────────────────┘                       │
│    ┌─────┼─────┐                                                │
│    ▼     ▼     ▼                                                │
│ ┌─────┐┌─────┐┌─────┐                                           │
│ │Queue││Queue││Queue│  ◄─── TASK QUEUES (Redis Streams)        │
│ └──┬──┘└──┬──┘└──┬──┘                                           │
│    ▼     ▼     ▼                                                │
│ ┌─────┐┌─────┐┌─────┐                                           │
│ │Pool ││Pool ││Pool │  ◄─── Kubernetes HPA Auto-scale          │
│ │ A   ││ B   ││ C   │                                           │
│ └──┬──┘└──┬──┘└──┬──┘                                           │
│    └─────┼─────┘                                                │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │ Aggregator  │  ◄─── Correlation-based result collection     │
│   └──────┬──────┘                                                │
│          │ MESSAGE BUS                                           │
│          ▼                                                       │
│   ┌─────────────┐                                                │
│   │  Summary    │                                                │
│   └─────────────┘                                                │
│                                                                  │
└──────────────────────────────────────────────────────────────────┘
```

**Lợi ích chính:**

- ✅ **Mở rộng không giới hạn**: Chỉ cần register capability + deploy pool
- ✅ **MessageBus vẫn dùng**: Cho coordination (task_available, final_report)
- ✅ **Task Queue riêng**: Cho parallel processing trong pools
- ✅ **Auto-scaling**: Kubernetes HPA dựa trên queue depth
- ✅ **Fault tolerant**: Leader election, task retry, worker replacement

Multi agent architecture expanded

Document · MD 

```
flowchart TD
  Chief[ChiefAgent] --> Planner[PlannerAgent]
  Planner -->|"plan_ready (via MessageBus)"| AgentRouter[AgentRouter]

  subgraph capabilityRegistry["Capability Registry (MessageBus metadata)"]
    CR_math["math: sum, sub, mul"]
    CR_date["date: today, format"]
    CR_web["web: navigate, extract"]
  end
  AgentRouter --- capabilityRegistry

  %% TASK QUEUE = topic trên MessageBus
  subgraph mathQueue["TASK QUEUE math (topic: math_task)"]
  end
  subgraph dateQueue["TASK QUEUE date (topic: date_task)"]
  end
  subgraph webQueue["TASK QUEUE web (topic: web_task)"]
  end

  AgentRouter --> mathQueue
  AgentRouter --> dateQueue
  AgentRouter --> webQueue

  %% POOL AGENT = nhiều agent subscribe cùng một topic
  subgraph mathPool["POOL A - Math Agents (subscribe: math_task)"]
    A1[MathAgentSum]
    A2[MathAgentSub]
  end

  subgraph datePool["POOL B - Date Agents (subscribe: date_task)"]
    B1[DateAgentToday]
  end

  subgraph webPool["POOL C - Web Agents (subscribe: web_task/plan_ready)"]
    C1[WebAgentNavigate]
    C2[WebAgentExtract]
  end

  mathQueue --> mathPool
  dateQueue --> datePool
  webQueue --> webPool

  %% RESULT AGGREGATOR = agent subscribe math_result/date_result/web_result
  subgraph aggregator["RESULT AGGREGATOR (MessageBus listener)"]
  end

  mathPool --> aggregator
  datePool --> aggregator
  webPool --> aggregator

  aggregator --> Summary[SummaryAgent]
```

update luồng này đẻ biểu thị rõ hơn là message bus

Show more

Dec 23

3 steps

Presented file

Orchestrated comprehensive documentation with diagrams and message flow details.

Đã update! Document bao gồm các diagram thể hiện rõ **MessageBus là trung tâm**:

## Tóm tắt nhanh

### Topic Subscription Matrix

|Topic|Chief|Planner|Router|Pools|Aggregator|Summary|
|---|---|---|---|---|---|---|
|task_available|**PUB**|SUB|-|-|-|-|
|plan_ready|-|**PUB**|SUB|-|-|-|
|math_task|-|-|**PUB**|SUB|-|-|
|date_task|-|-|**PUB**|SUB|-|-|
|web_task|-|-|**PUB**|SUB|-|-|
|*_result|-|-|-|**PUB**|SUB|-|
|aggregation_ready|-|-|-|-|**PUB**|SUB|
|final_report|SUB|-|-|-|-|**PUB**|

### Key Points

```
╔═════════════════════════════════════════════════════════════════╗
║                      MESSAGE BUS                                 ║
║                                                                  ║
║   [task_available] [plan_ready] [math_task] [date_task]         ║
║   [web_task] [math_result] [date_result] [web_result]           ║
║   [aggregation_ready] [final_report]                            ║
║                                                                  ║
║   + CAPABILITY REGISTRY                                          ║
║                                                                  ║
╚═══════════════════════════════╤══════════════════════════════════╝
                                │
       ┌────────────────────────┼────────────────────────┐
       │                        │                        │
       ▼                        ▼                        ▼
    Agents                   Pools                  Aggregator
  (pub/sub)              (pub/sub)                 (pub/sub)
```

**Nguyên tắc:**

- ✅ TẤT CẢ communication đều qua MESSAGE BUS
- ✅ Agents KHÔNG gọi trực tiếp nhau
- ✅ Pool agents subscribe CÙNG topic → competing consumers
- ✅ Correlation ID để track request xuyên suốt flow

Messagebus centric architecture

Document · MD 

INFO: 127.0.0.1:52107 - "POST /api/v1/finai/chat/stream HTTP/1.1" 200 OK 2025-12-23 23:00:16 - [INFO] - [FinancialInputGate] Validating prompt: Analyze financial metrics ['current_price', 'market_cap', 'pe_ratio'] for company in period current... Context error: No active span in current conte

pasted

Bug gì đây

Dec 23

Catalogued six distinct bugs spanning tracing, async, and logic layers.

Tôi thấy **5 bugs chính** trong log này:

---

## 1. 🔴 CRITICAL: Infinite Loop giữa ActionExecutor và Planner

```
ActionExecutor: renavigate_request → Planner
Planner: plan_ready → ActionExecutor
ActionExecutor: renavigate_request → Planner
... (lặp vô hạn)
```

**Nguyên nhân:** Planner đã stop sau 3 retries NHƯNG ActionExecutor vẫn tiếp tục gửi `renavigate_request` vì nó đang xử lý các plan cũ trong queue.

**Vấn đề:**

- Planner stop nhưng không broadcast "I'm stopping"
- ActionExecutor không biết Planner đã stop
- Messages cũ vẫn còn trong inbox của ActionExecutor

---

## 2. 🔴 CRITICAL: Message Duplicate

```
2025-12-23 23:00:21 - [FinAI_Chief] 📬 Received: plan_ready ... message_id: a9ae4147
2025-12-23 23:00:21 - [FinAI_ActionExecutor] 📬 Received: plan_ready ... message_id: a9ae4147
2025-12-23 23:00:21 - [FinAI_Chief] 📬 Received: plan_ready ... message_id: a9ae4147  ← DUPLICATE!
2025-12-23 23:00:21 - [FinAI_ActionExecutor] 📬 Received: plan_ready ... message_id: a9ae4147  ← DUPLICATE!
```

**Nguyên nhân:** MessageBus deduplication không hoạt động đúng, hoặc message được publish 2 lần.

---

## 3. 🟡 WARNING: Playwright NotImplementedError trên Windows

```
raise NotImplementedError
NotImplementedError
[WARNING] - [PlaywrightController] ⚠️ Trying thread-based Playwright initialization
```

**Nguyên nhân:** Windows asyncio không support `subprocess_exec` trong event loop mặc định. Cần dùng `ProactorEventLoop` hoặc `nest_asyncio`.

---

## 4. 🟡 WARNING: OpenTelemetry Span Context Errors

```
Context error: No active span in current context. Operations that depend on an active span will be skipped.
Setting attribute on ended span.
```

**Nguyên nhân:**

- Span được tạo bằng `start_as_current_span()` nhưng code chạy ngoài context
- Hoặc span đã end nhưng code vẫn cố set attribute

---

## 5. 🟡 WARNING: LangFuse Authentication Failed

```
Failed to export span batch code: 401, reason: {"message":"Invalid credentials..."}
```

**Nguyên nhân:** `LANGFUSE_SECRET_KEY` hoặc `LANGFUSE_PUBLIC_KEY` sai.

---

## Root Cause Analysis

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BUG FLOW DIAGRAM                                  │
│                                                                             │
│   ┌──────────────┐     plan_ready      ┌──────────────────┐                │
│   │   Planner    │────────────────────▶│  ActionExecutor  │                │
│   │              │                      │                  │                │
│   │  retry: 3/3  │◀────────────────────│  confidence: 0   │                │
│   │              │   renavigate_request │                  │                │
│   └──────┬───────┘                      └────────┬─────────┘                │
│          │                                       │                          │
│          │ STOP (max retries)                    │ Vẫn nhận plan_ready cũ  │
│          ▼                                       │ từ inbox queue          │
│   ┌──────────────┐                               │                          │
│   │   STOPPED    │                               │                          │
│   │              │                               ▼                          │
│   │  Không nhận  │                        ┌──────────────────┐              │
│   │  message nữa │                        │  Tiếp tục gửi    │              │
│   │              │                        │  renavigate_req  │              │
│   └──────────────┘                        │  → Không ai xử lý│              │
│                                           └──────────────────┘              │
│                                                                             │
│   ════════════════════════════════════════════════════════════════════     │
│   VẤN ĐỀ CHÍNH:                                                            │
│   1. Không có "graceful shutdown" protocol                                  │
│   2. Message duplicate do dedup không work                                  │
│   3. ActionExecutor xử lý nhiều plan_ready cùng lúc (race condition)       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Giải pháp đề xuất

### Fix 1: Thêm Shutdown Protocol

```
Planner (trước khi stop):
  → publish "planner_shutdown" hoặc "navigation_failed"
  → payload: {reason: "max_retries", final: true}

ActionExecutor (subscribe "planner_shutdown"):
  → Dừng xử lý plan_ready
  → Gửi verification_done với data hiện có (dù incomplete)
```

### Fix 2: Process Lock cho ActionExecutor

```
ActionExecutor:
  - Chỉ xử lý 1 plan_ready tại 1 thời điểm
  - Ignore plan_ready mới nếu đang processing
  - Hoặc cancel current task và xử lý plan mới
```

### Fix 3: Correlation ID Tracking

```
Mỗi workflow có 1 correlation_id duy nhất
Khi Planner stop → mark correlation_id as "failed"
ActionExecutor check correlation_id trước khi xử lý
```

### Fix 4: MessageBus Deduplication Fix

```
Kiểm tra lại logic dedup:
- Có thể message_id được generate sau khi check
- Hoặc publish được gọi 2 lần do race condition
```

---

## Tóm tắt

|Bug|Severity|Fix Priority|
|---|---|---|
|Infinite loop|🔴 Critical|P0 - Ngay lập tức|
|Message duplicate|🔴 Critical|P0 - Ngay lập tức|
|Playwright Windows|🟡 Warning|P1 - Fallback đang work|
|Span context errors|🟡 Warning|P2 - Không ảnh hưởng logic|
|LangFuse 401|🟡 Warning|P2 - Chỉ ảnh hưởng monitoring|

**Bug chính cần fix ngay:** Infinite loop do thiếu shutdown protocol giữa Planner và ActionExecutor.

--- name: refactor-finai-agent-pools overview: Thiết kế lại kiến trúc FinAI Agent để thay thế một Action Executor duy nhất bằng nhiều "kho agent" (math, ngày, web, ...) được Planner điều phối bằng LLM và tool catalog. todos: - id: design-plan-schema content: Thiết kế schema PlanStep mới (

pasted

Đánh giá kiến trúc hiện tại có risk gì ko khi mà nhiều agents như này ???

7:52 PM

Phân tích rủi ro kiến trúc multi-agent theo năm hạng mục chính.

## Đánh giá Risks của kiến trúc Multi-Agent hiện tại

---

## 1. Risk Matrix tổng quan

|Risk|Severity|Likelihood|Impact|Priority|
|---|---|---|---|---|
|Infinite Loop / Deadlock|🔴 Critical|Cao|System hang|P0|
|Message Storm|🔴 Critical|Trung bình|CPU/Memory spike|P0|
|Race Condition|🔴 Critical|Cao|Data inconsistent|P0|
|Orphan Tasks|🟠 High|Cao|Task không complete|P1|
|Debugging Nightmare|🟠 High|Rất cao|Dev productivity|P1|
|Resource Exhaustion|🟡 Medium|Trung bình|OOM/Timeout|P2|
|State Inconsistency|🟡 Medium|Trung bình|Wrong results|P2|

## 2. Chi tiết từng Risk

### 🔴 RISK 1: Infinite Loop / Circular Dependencies

**Đã xảy ra trong log của bạn!**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CIRCULAR DEPENDENCY                              │
│                                                                      │
│   Planner ──── plan_ready ────▶ ActionExecutor                      │
│      ▲                              │                                │
│      │                              │ (confidence < 0.5)             │
│      │                              ▼                                │
│      └──── renavigate_request ─────┘                                │
│                                                                      │
│   Planner stop sau 3 retries NHƯNG:                                 │
│   - ActionExecutor vẫn có plan cũ trong queue                       │
│   - Vẫn tiếp tục gửi renavigate_request                             │
│   - → INFINITE LOOP                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**Với kiến trúc mới, risk này TĂNG:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                  THÊM NHIỀU CIRCULAR PATHS                           │
│                                                                      │
│                        ┌──────────┐                                  │
│                        │  Planner │                                  │
│                        └────┬─────┘                                  │
│                             │                                        │
│              ┌──────────────┴──────────────┐                        │
│              ▼                             ▼                        │
│        ┌──────────┐                 ┌──────────┐                    │
│        │  Router  │                 │ActionExec│                    │
│        └────┬─────┘                 └────┬─────┘                    │
│             │                            │                          │
│    ┌────────┼────────┐                   │                          │
│    ▼        ▼        ▼                   │                          │
│ ┌─────┐ ┌─────┐ ┌─────┐                  │                          │
│ │Math │ │Date │ │ Web │◀─────────────────┘                          │
│ └──┬──┘ └──┬──┘ └──┬──┘                                             │
│    │       │       │                                                │
│    └───────┴───────┘                                                │
│            │                                                        │
│            ▼                                                        │
│     ┌────────────┐                                                  │
│     │ Aggregator │                                                  │
│     └──────┬─────┘                                                  │
│            │                                                        │
│            │  Nếu data không đủ → retry?                            │
│            │  Gửi lại cho Planner? Router? Pool?                    │
│            │  → NHIỀU PATHS CÓ THỂ LOOP                             │
│            ▼                                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 🔴 RISK 2: Message Storm / Broadcast Amplification

**Vấn đề:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     MESSAGE AMPLIFICATION                            │
│                                                                      │
│   1 plan_ready broadcast                                            │
│        │                                                            │
│        ├──▶ RouterAgent nhận                                        │
│        ├──▶ ActionExecutor nhận                                     │
│        ├──▶ Chief nhận (để log)                                     │
│        └──▶ Có thể có agent khác cũng subscribe                     │
│                                                                      │
│   RouterAgent dispatch 3 tasks:                                     │
│        │                                                            │
│        ├──▶ math_task → MathSum nhận + MathSub nhận (2 agents)      │
│        ├──▶ date_task → DateToday nhận                              │
│        └──▶ web_task → WebNavigate + WebExtract nhận (2 agents)     │
│                                                                      │
│   Kết quả: 1 request → 10+ messages qua bus                         │
│                                                                      │
│   Nếu có retry logic: 1 request → 50-100+ messages!                 │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

**Impact:**

- Redis PubSub overload
- CPU spike do callback processing
- Memory spike do message queue buildup

---

### 🔴 RISK 3: Race Condition (Đã thấy trong log)

```
2025-12-23 23:00:21 - [FinAI_Chief] 📬 Received: plan_ready ... message_id: a9ae4147
2025-12-23 23:00:21 - [FinAI_ActionExecutor] 📬 Received: plan_ready ... message_id: a9ae4147
2025-12-23 23:00:21 - [FinAI_Chief] 📬 Received: plan_ready ... message_id: a9ae4147  ← DUPLICATE!
```

**Nguyên nhân có thể:**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     RACE CONDITION SCENARIOS                         │
│                                                                      │
│   Scenario A: Duplicate Publish                                      │
│   ───────────────────────────────────────────────────────────────   │
│   Planner._llm_plan() timeout → fallback _heuristic_plan()          │
│   Cả hai đều publish plan_ready trước khi check đã publish chưa     │
│                                                                      │
│   Scenario B: Dedup Race                                             │
│   ───────────────────────────────────────────────────────────────   │
│   Thread 1: check message_id not in seen_ids                        │
│   Thread 2: check message_id not in seen_ids  (cùng lúc)            │
│   Thread 1: add to seen_ids, deliver                                │
│   Thread 2: add to seen_ids, deliver  → DUPLICATE                   │
│                                                                      │
│   Scenario C: Multiple Subscribers Processing Same Message          │
│   ───────────────────────────────────────────────────────────────   │
│   MathSum và MathSub cùng subscribe math_task                       │
│   Cả hai đều nhận và xử lý cùng 1 task                              │
│   → Task được execute 2 lần!                                        │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 🟠 RISK 4: Orphan Tasks / Lost Messages

```
┌─────────────────────────────────────────────────────────────────────┐
│                     ORPHAN TASK SCENARIOS                            │
│                                                                      │
│   Scenario A: Agent Crash Mid-Processing                            │
│   ───────────────────────────────────────────────────────────────   │
│                                                                      │
│   Router ──── math_task ────▶ MathSum                               │
│                                   │                                  │
│                                   │ Processing...                    │
│                                   │ CRASH!                           │
│                                   ▼                                  │
│                              (no result)                             │
│                                                                      │
│   Aggregator chờ math_result mãi → TIMEOUT                          │
│                                                                      │
│   ───────────────────────────────────────────────────────────────   │
│   Scenario B: No Subscriber                                         │
│   ───────────────────────────────────────────────────────────────   │
│                                                                      │
│   Router publish "email_task" nhưng                                  │
│   Chưa có EmailAgent nào subscribe                                   │
│   → Message mất, không ai xử lý                                      │
│                                                                      │
│   ───────────────────────────────────────────────────────────────   │
│   Scenario C: Timing Issue                                          │
│   ───────────────────────────────────────────────────────────────   │
│                                                                      │
│   Agent subscribe SAU KHI message đã được publish                    │
│   (PubSub không có persistence)                                      │
│   → Message bị miss                                                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 🟠 RISK 5: Debugging Nightmare

```
┌─────────────────────────────────────────────────────────────────────┐
│                     DEBUGGING COMPLEXITY                             │
│                                                                      │
│   Với N agents, có N² possible interaction paths                    │
│                                                                      │
│   Hiện tại bạn có:                                                  │
│   - Chief, Planner, Router, ActionExecutor, Synthesizer             │
│   - MathSum, MathSub, DateToday, WebNavigate, WebExtract            │
│   - Aggregator (planned)                                            │
│                                                                      │
│   = 11 agents → 121 possible paths!                                 │
│                                                                      │
│   Khi bug xảy ra:                                                   │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  Q: Task không complete, tại sao?                           │   │
│   │                                                              │   │
│   │  A: Có thể là:                                               │   │
│   │     - Planner không nhận task_available?                     │   │
│   │     - Router không route đúng pool?                          │   │
│   │     - MathSum crash?                                         │   │
│   │     - Aggregator không nhận math_result?                     │   │
│   │     - Message bị duplicate nên state sai?                    │   │
│   │     - Correlation ID mismatch?                               │   │
│   │     - Race condition?                                        │   │
│   │     - ...                                                    │   │
│   │                                                              │   │
│   │  → Phải trace qua 11 agents, 20+ topics để tìm root cause   │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

### 🟡 RISK 6: Resource Exhaustion

```
┌─────────────────────────────────────────────────────────────────────┐
│                     RESOURCE RISKS                                   │
│                                                                      │
│   Memory:                                                           │
│   ─────────────────────────────────────────────────────────────    │
│   - Mỗi agent có inbox queue (asyncio.Queue)                        │
│   - Message history được giữ (5 phút TTL)                           │
│   - 11 agents × 1000 messages × 1KB = 11MB minimum                 │
│   - Với retry storm: có thể spike lên 100MB+                        │
│                                                                      │
│   CPU:                                                              │
│   ─────────────────────────────────────────────────────────────    │
│   - 11 agent run_loop() chạy concurrent                             │
│   - Mỗi message trigger multiple callbacks                          │
│   - LLM calls trong Planner/Synthesizer block event loop            │
│                                                                      │
│   Connections:                                                      │
│   ─────────────────────────────────────────────────────────────    │
│   - Redis PubSub connections                                        │
│   - LLM API connections (GPT, Claude)                               │
│   - Browser/Playwright connections                                   │
│   - Potential connection pool exhaustion                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. Mitigation Strategies

### Strategy 1: Circuit Breaker Pattern

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CIRCUIT BREAKER                                  │
│                                                                      │
│   CLOSED ──────────────────▶ OPEN ──────────────────▶ HALF-OPEN    │
│     │         (failure       │         (timeout        │            │
│     │          threshold)    │          expires)       │            │
│     │                        │                         │            │
│     │                        │   ┌─────────────────────┤            │
│     │                        │   │ success             │            │
│     │                        │   ▼                     │ failure    │
│     │                      CLOSED                      │            │
│     │                                                  │            │
│     └──────────────────────────────────────────────────┘            │
│                                                                      │
│   Implement cho:                                                    │
│   - Planner retry logic (max 3 → stop, không gửi thêm)              │
│   - ActionExecutor renavigate (track circuit state)                 │
│   - LLM calls (fallback to heuristic)                               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Strategy 2: Saga Pattern với Compensation

```
┌─────────────────────────────────────────────────────────────────────┐
│                     SAGA PATTERN                                     │
│                                                                      │
│   Workflow:                                                         │
│   ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐             │
│   │ Step 1 │───▶│ Step 2 │───▶│ Step 3 │───▶│ Step 4 │             │
│   │  Math  │    │  Date  │    │  Web   │    │Summary │             │
│   └────────┘    └────────┘    └───┬────┘    └────────┘             │
│                                   │                                 │
│                                   │ FAIL!                           │
│                                   ▼                                 │
│   Compensation:                                                     │
│   ┌────────┐    ┌────────┐    ┌────────┐                           │
│   │Rollback│◀───│Rollback│◀───│Rollback│                           │
│   │ Step 1 │    │ Step 2 │    │ Step 3 │                           │
│   └────────┘    └────────┘    └────────┘                           │
│                                                                      │
│   Mỗi step phải có:                                                 │
│   - execute() method                                                │
│   - compensate() method                                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Strategy 3: Correlation ID + Timeout Manager

```
┌─────────────────────────────────────────────────────────────────────┐
│                     CORRELATION TRACKING                             │
│                                                                      │
│   WorkflowManager:                                                  │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  correlation_id: "req_abc123"                               │   │
│   │  created_at: 2024-01-15T10:00:00Z                           │   │
│   │  timeout: 300s                                               │   │
│   │  status: "in_progress"                                       │   │
│   │                                                              │   │
│   │  steps: [                                                    │   │
│   │    {id: "t1", pool: "math", status: "completed", result: 6}  │   │
│   │    {id: "t2", pool: "date", status: "completed", result: ..} │   │
│   │    {id: "t3", pool: "web", status: "pending"}                │   │
│   │  ]                                                           │   │
│   │                                                              │   │
│   │  Nếu timeout → cancel tất cả pending steps                   │   │
│   │  Nếu critical step fail → compensation                       │   │
│   │                                                              │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### Strategy 4: Dead Letter Queue

```
┌─────────────────────────────────────────────────────────────────────┐
│                     DEAD LETTER QUEUE                                │
│                                                                      │
│   Normal Flow:                                                      │
│   ┌────────┐    ┌────────┐    ┌────────┐                           │
│   │ Router │───▶│ Queue  │───▶│ Pool   │                           │
│   └────────┘    └────────┘    └───┬────┘                           │
│                                   │                                 │
│                                   │ Process fail 3 times            │
│                                   ▼                                 │
│                            ┌────────────┐                           │
│                            │ Dead Letter│                           │
│                            │   Queue    │                           │
│                            └──────┬─────┘                           │
│                                   │                                 │
│                                   │ Manual review / Alert           │
│                                   ▼                                 │
│                            ┌────────────┐                           │
│                            │  Alerting  │                           │
│                            │  System    │                           │
│                            └────────────┘                           │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. Recommendation: Giảm số lượng Agents

```
┌─────────────────────────────────────────────────────────────────────┐
│                     SIMPLIFIED ARCHITECTURE                          │
│                                                                      │
│   HIỆN TẠI (11 agents):                        ĐỀ XUẤT (5 agents): │
│   ─────────────────────                        ────────────────────  │
│                                                                      │
│   Chief                                        Chief                 │
│   Planner                                      Planner               │
│   Router                                       ┌─────────────────┐  │
│   ActionExecutor                               │  Executor       │  │
│   Synthesizer                                  │  (unified)      │  │
│   MathSum              ────────────▶           │  - math tools   │  │
│   MathSub                                      │  - date tools   │  │
│   DateToday                                    │  - web tools    │  │
│   WebNavigate                                  │  via MCP        │  │
│   WebExtract                                   └─────────────────┘  │
│   Aggregator                                   Synthesizer          │
│                                                                      │
│   Lợi ích:                                                          │
│   - Ít agents = ít paths = dễ debug                                 │
│   - Executor gọi MCP tools trực tiếp, không cần agent riêng        │
│   - Vẫn extensible qua MCP tool registry                           │
│   - Complexity giảm từ O(n²) xuống O(n)                             │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 5. Tóm tắt

|Aspect|Current Risk|After Mitigation|
|---|---|---|
|Infinite Loop|🔴 Critical|🟢 Low (Circuit Breaker)|
|Message Storm|🔴 Critical|🟡 Medium (Rate Limiting)|
|Race Condition|🔴 Critical|🟢 Low (Proper Locking)|
|Orphan Tasks|🟠 High|🟢 Low (DLQ + Timeout)|
|Debugging|🟠 High|🟡 Medium (Tracing)|
|Resources|🟡 Medium|🟢 Low (Pooling)|

**Khuyến nghị chính:**

1. **Ngắn hạn:** Fix infinite loop bằng shutdown protocol
2. **Trung hạn:** Thêm Circuit Breaker + Correlation Tracking
3. **Dài hạn:** Cân nhắc giảm số agents, dùng MCP tools trực tiếp thay vì agent-per-tool

Đề xuất kiến trúc multi agent có thể mở rộng và dễ quản lý

8:23 PM

Architected scalable multi-agent system addressing key operational risks.

## Đề xuất kiến trúc Multi-Agent có thể mở rộng và dễ quản lý

---

## 1. Nguyên tắc thiết kế

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    DESIGN PRINCIPLES                                                     │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   1. FEWER AGENTS, MORE TOOLS                                                                   │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │      Agent = Coordinator/Decision maker                                                         │   │
│   │      Tool  = Executor (MCP, API, DB, etc.)                                                      │   │
│   │                                                                                                  │   │
│   │      ❌ 1 Agent per function (MathSum, MathSub, DateToday...)                                   │   │
│   │      ✅ 1 Agent per responsibility + nhiều tools                                                │   │
│   │                                                                                                  │   │
│   │   2. SINGLE SOURCE OF TRUTH                                                                     │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │      WorkflowManager giữ state của toàn bộ workflow                                             │   │
│   │      Agents là stateless, chỉ xử lý và trả kết quả                                              │   │
│   │                                                                                                  │   │
│   │   3. EXPLICIT OVER IMPLICIT                                                                     │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │      Mọi transition đều explicit (không có hidden retry loops)                                  │   │
│   │      Failure phải được handle và report rõ ràng                                                 │   │
│   │                                                                                                  │   │
│   │   4. TOOLS ARE EXTENSIBLE, NOT AGENTS                                                           │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │      Thêm capability mới = thêm MCP Tool                                                        │   │
│   │      Không cần thêm Agent mới                                                                   │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Kiến trúc đề xuất: Lean Multi-Agent

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                                    LEAN MULTI-AGENT ARCHITECTURE                                         │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                      API LAYER                                                   │   │
│   │                                                                                                  │   │
│   │                                 ┌────────────────┐                                               │   │
│   │                                 │   API Gateway  │                                               │   │
│   │                                 │  (FastAPI)     │                                               │   │
│   │                                 └───────┬────────┘                                               │   │
│   │                                         │                                                        │   │
│   └─────────────────────────────────────────┼────────────────────────────────────────────────────────┘   │
│                                             │                                                            │
│                                             ▼                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              ORCHESTRATION LAYER (3 Agents)                                      │   │
│   │                                                                                                  │   │
│   │                         ┌─────────────────────────────────────┐                                  │   │
│   │                         │        WORKFLOW MANAGER             │                                  │   │
│   │                         │   ┌───────────────────────────┐     │                                  │   │
│   │                         │   │ • Workflow State Store    │     │                                  │   │
│   │                         │   │ • Correlation Tracking    │     │                                  │   │
│   │                         │   │ • Timeout Management      │     │                                  │   │
│   │                         │   │ • Circuit Breaker         │     │                                  │   │
│   │                         │   └───────────────────────────┘     │                                  │   │
│   │                         └──────────────┬──────────────────────┘                                  │   │
│   │                                        │                                                         │   │
│   │              ┌─────────────────────────┼─────────────────────────┐                               │   │
│   │              │                         │                         │                               │   │
│   │              ▼                         ▼                         ▼                               │   │
│   │     ┌────────────────┐       ┌────────────────┐       ┌────────────────┐                        │   │
│   │     │                │       │                │       │                │                        │   │
│   │     │   PLANNER      │       │   EXECUTOR     │       │   REPORTER     │                        │   │
│   │     │   AGENT        │       │   AGENT        │       │   AGENT        │                        │   │
│   │     │                │       │                │       │                │                        │   │
│   │     │ • Parse query  │       │ • Execute plan │       │ • Synthesize   │                        │   │
│   │     │ • Create plan  │       │ • Call tools   │       │ • Format output│                        │   │
│   │     │ • Validate     │       │ • Aggregate    │       │ • Validate     │                        │   │
│   │     │                │       │                │       │                │                        │   │
│   │     └───────┬────────┘       └───────┬────────┘       └───────┬────────┘                        │   │
│   │             │                        │                        │                                  │   │
│   └─────────────┼────────────────────────┼────────────────────────┼──────────────────────────────────┘   │
│                 │                        │                        │                                      │
│                 │                        ▼                        │                                      │
│   ┌─────────────┼───────────────────────────────────────────────────────────────────────────────────┐   │
│   │             │                 TOOL LAYER (MCP)                │                                  │   │
│   │             │                                                 │                                  │   │
│   │             │    ┌────────────────────────────────────────────┼──────────────────────────────┐  │   │
│   │             │    │                TOOL REGISTRY               │                              │  │   │
│   │             │    │                                            │                              │  │   │
│   │             │    │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐       │  │   │
│   │             │    │  │   Math   │ │   Date   │ │  Browser │ │   API    │ │    DB    │  ...  │  │   │
│   │             │    │  │   MCP    │ │   MCP    │ │   MCP    │ │   MCP    │ │   MCP    │       │  │   │
│   │             │    │  │          │ │          │ │          │ │          │ │          │       │  │   │
│   │             │    │  │ • sum    │ │ • today  │ │ •navigate│ │ • fetch  │ │ • query  │       │  │   │
│   │             │    │  │ • sub    │ │ • format │ │ • click  │ │ • post   │ │ • insert │       │  │   │
│   │             │    │  │ • mul    │ │ • diff   │ │ • extract│ │          │ │          │       │  │   │
│   │             │    │  │ • div    │ │ • parse  │ │ • scroll │ │          │ │          │       │  │   │
│   │             │    │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘       │  │   │
│   │             │    │                                                                         │  │   │
│   │             │    └─────────────────────────────────────────────────────────────────────────┘  │   │
│   │             │                                                                                 │   │
│   └─────────────┼─────────────────────────────────────────────────────────────────────────────────┘   │
│                 │                                                                                      │
│                 ▼                                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐  │
│   │                                    INFRASTRUCTURE                                                │  │
│   │                                                                                                  │  │
│   │    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                 │  │
│   │    │    Redis     │    │  PostgreSQL  │    │   LangFuse   │    │   Datadog    │                 │  │
│   │    │              │    │              │    │              │    │              │                 │  │
│   │    │ • State      │    │ • Workflow   │    │ • LLM Trace  │    │ • Metrics    │                 │  │
│   │    │ • PubSub     │    │ • History    │    │ • Cost       │    │ • APM        │                 │  │
│   │    │ • Cache      │    │ • Results    │    │              │    │ • Logs       │                 │  │
│   │    └──────────────┘    └──────────────┘    └──────────────┘    └──────────────┘                 │  │
│   │                                                                                                  │  │
│   └──────────────────────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. So sánh: Hiện tại vs Đề xuất

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   HIỆN TẠI (11 Agents)                              ĐỀ XUẤT (3 Agents + Tools)                          │
│   ════════════════════                              ═══════════════════════════                          │
│                                                                                                          │
│   ┌─────────────────────────┐                       ┌─────────────────────────┐                         │
│   │ ChiefAgent              │                       │                         │                         │
│   │ PlannerAgent            │                       │   WorkflowManager       │                         │
│   │ RouterAgent             │                       │   (không phải agent)    │                         │
│   │ ActionExecutorAgent     │                       │                         │                         │
│   │ SynthesizerAgent        │       ──────▶         └────────────┬────────────┘                         │
│   │ MathAgentSum            │                                    │                                      │
│   │ MathAgentSubtract       │                       ┌────────────┼────────────┐                         │
│   │ DateAgentToday          │                       │            │            │                         │
│   │ WebAgentNavigate        │                       ▼            ▼            ▼                         │
│   │ WebAgentExtract         │                   ┌───────┐   ┌────────┐   ┌────────┐                    │
│   │ AggregatorAgent         │                   │Planner│   │Executor│   │Reporter│                    │
│   └─────────────────────────┘                   │ Agent │   │ Agent  │   │ Agent  │                    │
│                                                 └───┬───┘   └───┬────┘   └───┬────┘                    │
│   Problems:                                         │           │            │                          │
│   ─────────────────────────                         │           ▼            │                          │
│   • 121 possible paths                              │    ┌─────────────┐     │                          │
│   • Hard to debug                                   │    │ Tool        │     │                          │
│   • Race conditions                                 │    │ Registry    │     │                          │
│   • Infinite loops                                  │    │ (MCP)       │     │                          │
│   • Message storms                                  │    └─────────────┘     │                          │
│                                                     │           │            │                          │
│                                                     │    ┌──────┴──────┐     │                          │
│                                                     │    │ │ │ │ │ │ │ │     │                          │
│                                                     │    ▼ ▼ ▼ ▼ ▼ ▼ ▼ ▼     │                          │
│                                                     │   Math Date Web API    │                          │
│                                                     │   (Tools, not agents)  │                          │
│                                                     │                        │                          │
│                                                     Benefits:                │                          │
│                                                     ─────────────────────────                           │
│                                                     • 9 paths only (3×3)                                │
│                                                     • Easy to debug                                     │
│                                                     • No race conditions                                │
│                                                     • Controlled flow                                   │
│                                                     • Extensible via tools                              │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Component Details

### 4.1 WorkflowManager (Core Controller)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    WORKFLOW MANAGER                                                      │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   RESPONSIBILITIES:                                                                             │   │
│   │   ─────────────────────────────────────────────────────────────────────────────────────────────│   │
│   │                                                                                                  │   │
│   │   1. Workflow State Management                                                                   │   │
│   │      ┌─────────────────────────────────────────────────────────────────────────────────────┐    │   │
│   │      │  workflow_id: "wf_abc123"                                                           │    │   │
│   │      │  correlation_id: "req_xyz789"                                                       │    │   │
│   │      │  status: "executing"  // pending | planning | executing | reporting | done | failed │    │   │
│   │      │  created_at: "2024-01-15T10:00:00Z"                                                 │    │   │
│   │      │  timeout_at: "2024-01-15T10:05:00Z"                                                 │    │   │
│   │      │                                                                                      │    │   │
│   │      │  current_phase: "execute"                                                            │    │   │
│   │      │  plan: [{step_id, tool, args, status, result}, ...]                                 │    │   │
│   │      │  results: {step_1: {...}, step_2: {...}}                                            │    │   │
│   │      │  errors: []                                                                          │    │   │
│   │      └─────────────────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                                  │   │
│   │   2. Phase Transitions (Explicit State Machine)                                                  │   │
│   │      ┌─────────────────────────────────────────────────────────────────────────────────────┐    │   │
│   │      │                                                                                      │    │   │
│   │      │   PENDING ───▶ PLANNING ───▶ EXECUTING ───▶ REPORTING ───▶ DONE                     │    │   │
│   │      │      │             │              │              │            │                      │    │   │
│   │      │      │             │              │              │            │                      │    │   │
│   │      │      └─────────────┴──────────────┴──────────────┴────────────┘                      │    │   │
│   │      │                                   │                                                  │    │   │
│   │      │                                   ▼                                                  │    │   │
│   │      │                                FAILED                                                │    │   │
│   │      │                                                                                      │    │   │
│   │      └─────────────────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                                  │   │
│   │   3. Circuit Breaker                                                                            │   │
│   │      ┌─────────────────────────────────────────────────────────────────────────────────────┐    │   │
│   │      │                                                                                      │    │   │
│   │      │   Per-tool circuit breaker:                                                          │    │   │
│   │      │   ┌────────────┬──────────┬───────────┬──────────────┐                              │    │   │
│   │      │   │ Tool       │ State    │ Failures  │ Last Failure │                              │    │   │
│   │      │   ├────────────┼──────────┼───────────┼──────────────┤                              │    │   │
│   │      │   │ browser    │ CLOSED   │ 0         │ -            │                              │    │   │
│   │      │   │ math       │ CLOSED   │ 0         │ -            │                              │    │   │
│   │      │   │ yahoo_api  │ OPEN     │ 5         │ 10:02:00     │  ← Skip này, dùng fallback   │    │   │
│   │      │   └────────────┴──────────┴───────────┴──────────────┘                              │    │   │
│   │      │                                                                                      │    │   │
│   │      └─────────────────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                                  │   │
│   │   4. Timeout Management                                                                          │   │
│   │      ┌─────────────────────────────────────────────────────────────────────────────────────┐    │   │
│   │      │                                                                                      │    │   │
│   │      │   workflow_timeout: 300s (total)                                                     │    │   │
│   │      │   step_timeout: 30s (per step)                                                       │    │   │
│   │      │   llm_timeout: 60s (for LLM calls)                                                   │    │   │
│   │      │                                                                                      │    │   │
│   │      │   On timeout:                                                                        │    │   │
│   │      │   - Cancel current operation                                                         │    │   │
│   │      │   - Mark step as TIMEOUT                                                             │    │   │
│   │      │   - Continue with available results OR fail workflow                                 │    │   │
│   │      │                                                                                      │    │   │
│   │      └─────────────────────────────────────────────────────────────────────────────────────┘    │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Agent Responsibilities

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    AGENT RESPONSIBILITIES                                                │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PLANNER AGENT                                                                                  │   │
│   │   ═══════════════                                                                                │   │
│   │                                                                                                  │   │
│   │   Input:  { query, context, available_tools }                                                    │   │
│   │   Output: { plan: [steps], validation_result }                                                   │   │
│   │                                                                                                  │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                                                          │   │   │
│   │   │   1. Parse query → identify intent                                                       │   │   │
│   │   │   2. Check available tools from registry                                                 │   │   │
│   │   │   3. Create plan (LLM or heuristic)                                                      │   │   │
│   │   │   4. Validate plan (all tools exist, args valid)                                         │   │   │
│   │   │   5. Return plan                                                                         │   │   │
│   │   │                                                                                          │   │   │
│   │   │   NO retry logic inside - just create plan once                                          │   │   │
│   │   │   NO communication with other agents - stateless                                         │   │   │
│   │   │                                                                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                  │   │
│   │   EXECUTOR AGENT                                                                                 │   │
│   │   ══════════════                                                                                 │   │
│   │                                                                                                  │   │
│   │   Input:  { plan, context, tool_registry }                                                       │   │
│   │   Output: { results: {step_id: result}, errors: [] }                                             │   │
│   │                                                                                                  │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                                                          │   │   │
│   │   │   For each step in plan:                                                                 │   │   │
│   │   │     1. Check circuit breaker for tool                                                    │   │   │
│   │   │     2. Execute tool via MCP                                                              │   │   │
│   │   │     3. Store result                                                                      │   │   │
│   │   │     4. If failed → record error, continue (không retry, không loop)                     │   │   │
│   │   │                                                                                          │   │   │
│   │   │   Return all results (success + failures)                                                │   │   │
│   │   │                                                                                          │   │   │
│   │   │   KHÔNG có:                                                                              │   │   │
│   │   │   - Retry logic (WorkflowManager quyết định)                                             │   │   │
│   │   │   - Communication với Planner (không biết Planner tồn tại)                               │   │   │
│   │   │   - Renavigate request (không có concept này)                                            │   │   │
│   │   │                                                                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                  │   │
│   │   REPORTER AGENT                                                                                 │   │
│   │   ══════════════                                                                                 │   │
│   │                                                                                                  │   │
│   │   Input:  { query, results, context }                                                            │   │
│   │   Output: { report, metadata, confidence }                                                       │   │
│   │                                                                                                  │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                                                          │   │   │
│   │   │   1. Aggregate results from all steps                                                    │   │   │
│   │   │   2. Calculate confidence score                                                          │   │   │
│   │   │   3. Generate report (LLM or template)                                                   │   │   │
│   │   │   4. Add metadata (sources, timestamps)                                                  │   │   │
│   │   │   5. Return formatted response                                                           │   │   │
│   │   │                                                                                          │   │   │
│   │   │   NO decision making about retry                                                         │   │   │
│   │   │   Just format whatever results are available                                             │   │   │
│   │   │                                                                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Data Flow (Simplified)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   ┌─────────┐                                                                                           │
│   │  User   │                                                                                           │
│   └────┬────┘                                                                                           │
│        │ Request: "Tính 1+2+3 và cho biết giá AAPL"                                                     │
│        ▼                                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                              WORKFLOW MANAGER                                                    │   │
│   │                                                                                                  │   │
│   │   1. Create workflow_id, set status = PLANNING                                                   │   │
│   │                                                                                                  │   │
│   │   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │  2. Call Planner.plan(query, tools)                                                      │  │   │
│   │   │                                                                                           │  │   │
│   │   │     ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │   │
│   │   │     │  PLANNER AGENT (sync call, not message)                                         │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  Input: query + tool_registry                                                    │  │  │   │
│   │   │     │  Process: LLM / Heuristic                                                        │  │  │   │
│   │   │     │  Output: [                                                                       │  │  │   │
│   │   │     │    {step_id: "s1", tool: "math.sum", args: {numbers: [1,2,3]}},                  │  │  │   │
│   │   │     │    {step_id: "s2", tool: "browser.navigate", args: {url: "yahoo/AAPL"}},        │  │  │   │
│   │   │     │    {step_id: "s3", tool: "browser.extract", args: {selectors: [...]}}           │  │  │   │
│   │   │     │  ]                                                                               │  │  │   │
│   │   │     └─────────────────────────────────────────────────────────────────────────────────┘  │  │   │
│   │   │                                                                                           │  │   │
│   │   └──────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                  │   │
│   │   3. Set status = EXECUTING                                                                      │   │
│   │                                                                                                  │   │
│   │   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │  4. Call Executor.execute(plan, tools)                                                   │  │   │
│   │   │                                                                                           │  │   │
│   │   │     ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │   │
│   │   │     │  EXECUTOR AGENT (sync call)                                                     │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  For step s1:                                                                    │  │  │   │
│   │   │     │    → tool_registry.execute("math.sum", {numbers: [1,2,3]})                       │  │  │   │
│   │   │     │    → result: 6 ✓                                                                 │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  For step s2:                                                                    │  │  │   │
│   │   │     │    → tool_registry.execute("browser.navigate", {...})                            │  │  │   │
│   │   │     │    → result: html_content ✓                                                      │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  For step s3:                                                                    │  │  │   │
│   │   │     │    → tool_registry.execute("browser.extract", {...})                             │  │  │   │
│   │   │     │    → result: {price: 185.50, ...} ✓                                              │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  Output: {s1: 6, s2: html, s3: {price: 185.50}}                                  │  │  │   │
│   │   │     └─────────────────────────────────────────────────────────────────────────────────┘  │  │   │
│   │   │                                                                                           │  │   │
│   │   └──────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                  │   │
│   │   5. Check results - đủ data? confidence > threshold?                                            │   │
│   │      ├── YES → status = REPORTING                                                                │   │
│   │      └── NO  → (option) retry với different plan HOẶC proceed với partial data                   │   │
│   │                                                                                                  │   │
│   │   ┌──────────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │   │  6. Call Reporter.report(query, results)                                                 │  │   │
│   │   │                                                                                           │  │   │
│   │   │     ┌─────────────────────────────────────────────────────────────────────────────────┐  │  │   │
│   │   │     │  REPORTER AGENT (sync call)                                                     │  │  │   │
│   │   │     │                                                                                  │  │  │   │
│   │   │     │  Input: query + all results                                                      │  │  │   │
│   │   │     │  Process: LLM synthesis                                                          │  │  │   │
│   │   │     │  Output: {                                                                       │  │  │   │
│   │   │     │    report: "1+2+3 = 6. Giá AAPL hiện tại: $185.50...",                          │  │  │   │
│   │   │     │    confidence: 0.95,                                                             │  │  │   │
│   │   │     │    sources: ["math.sum", "yahoo.com/AAPL"]                                       │  │  │   │
│   │   │     │  }                                                                               │  │  │   │
│   │   │     └─────────────────────────────────────────────────────────────────────────────────┘  │  │   │
│   │   │                                                                                           │  │   │
│   │   └──────────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                  │   │
│   │   7. Set status = DONE, return response                                                          │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│        │                                                                                                │
│        ▼                                                                                                │
│   ┌─────────┐                                                                                           │
│   │  User   │  ◀── "1+2+3 = 6. Giá AAPL hiện tại: $185.50..."                                          │
│   └─────────┘                                                                                           │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    ERROR HANDLING                                                        │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   SCENARIO 1: Tool Execution Fails                                                               │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   WorkflowManager                                                                                │   │
│   │        │                                                                                         │   │
│   │        ├── Executor.execute(plan)                                                                │   │
│   │        │        │                                                                                │   │
│   │        │        ├── step s1: math.sum → ✓ success                                                │   │
│   │        │        ├── step s2: browser.navigate → ✗ TIMEOUT                                        │   │
│   │        │        └── step s3: browser.extract → SKIPPED (depends on s2)                           │   │
│   │        │        │                                                                                │   │
│   │        │        └── Return: {s1: 6, s2: ERROR, s3: SKIPPED}                                      │   │
│   │        │                                                                                         │   │
│   │        ├── Check results:                                                                        │   │
│   │        │        │                                                                                │   │
│   │        │        ├── Critical step failed? (s2 is critical for financial data)                    │   │
│   │        │        │        │                                                                       │   │
│   │        │        │        ├── YES → Check circuit breaker                                         │   │
│   │        │        │        │           │                                                           │   │
│   │        │        │        │           ├── OPEN → Use fallback OR partial response                 │   │
│   │        │        │        │           └── CLOSED → Retry once with exponential backoff            │   │
│   │        │        │        │                                                                       │   │
│   │        │        │        └── NO → Proceed with partial data                                      │   │
│   │        │        │                                                                                │   │
│   │        │        └── Max retries reached? → Proceed with whatever we have                         │   │
│   │        │                                                                                         │   │
│   │        └── Reporter.report(query, partial_results)                                               │   │
│   │                  │                                                                               │   │
│   │                  └── "1+2+3 = 6. Không thể lấy giá AAPL do lỗi kết nối."                         │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   SCENARIO 2: Planning Fails                                                                     │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   WorkflowManager                                                                                │   │
│   │        │                                                                                         │   │
│   │        ├── Planner.plan(query)                                                                   │   │
│   │        │        │                                                                                │   │
│   │        │        ├── LLM call timeout                                                             │   │
│   │        │        └── Return: ERROR                                                                │   │
│   │        │                                                                                         │   │
│   │        ├── Fallback: Planner.plan(query, use_heuristic=True)                                     │   │
│   │        │        │                                                                                │   │
│   │        │        └── Return: basic_plan                                                           │   │
│   │        │                                                                                         │   │
│   │        └── Continue with basic_plan                                                              │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   RETRY POLICY (Controlled by WorkflowManager, NOT by Agents)                                    │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   ┌─────────────────────────────────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                                                          │   │   │
│   │   │   max_retries: 2 (total, not per step)                                                   │   │   │
│   │   │   backoff: exponential (1s, 2s, 4s)                                                      │   │   │
│   │   │                                                                                          │   │   │
│   │   │   Retry khi:                                                                             │   │   │
│   │   │   - Transient errors (timeout, connection reset)                                         │   │   │
│   │   │   - Circuit breaker is HALF-OPEN                                                         │   │   │
│   │   │                                                                                          │   │   │
│   │   │   KHÔNG retry khi:                                                                       │   │   │
│   │   │   - Validation errors (bad input)                                                        │   │   │
│   │   │   - Circuit breaker is OPEN                                                              │   │   │
│   │   │   - Max retries reached                                                                  │   │   │
│   │   │   - Timeout exceeded                                                                     │   │   │
│   │   │                                                                                          │   │   │
│   │   └─────────────────────────────────────────────────────────────────────────────────────────┘   │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Tool Registry (Extensibility Point)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    TOOL REGISTRY                                                         │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   THÊM CAPABILITY MỚI = THÊM TOOL, KHÔNG THÊM AGENT                                             │   │
│   │   ════════════════════════════════════════════════════════════════════════════════════════════  │   │
│   │                                                                                                  │   │
│   │   Hiện tại:                                          Thêm mới:                                   │   │
│   │   ──────────                                         ──────────                                  │   │
│   │                                                                                                  │   │
│   │   ┌──────────────┐                                   ┌──────────────┐                           │   │
│   │   │ math         │                                   │ email        │  ← Chỉ cần thêm MCP      │   │
│   │   │ ├── sum      │                                   │ ├── send     │                           │   │
│   │   │ ├── subtract │                                   │ ├── read     │                           │   │
│   │   │ ├── multiply │                                   │ └── search   │                           │   │
│   │   │ └── divide   │                                   └──────────────┘                           │   │
│   │   └──────────────┘                                                                               │   │
│   │                                                      ┌──────────────┐                           │   │
│   │   ┌──────────────┐                                   │ slack        │  ← Chỉ cần thêm MCP      │   │
│   │   │ date         │                                   │ ├── post     │                           │   │
│   │   │ ├── today    │                                   │ ├── read     │                           │   │
│   │   │ ├── format   │                                   │ └── search   │                           │   │
│   │   │ └── diff     │                                   └──────────────┘                           │   │
│   │   └──────────────┘                                                                               │   │
│   │                                                      ┌──────────────┐                           │   │
│   │   ┌──────────────┐                                   │ database     │  ← Chỉ cần thêm MCP      │   │
│   │   │ browser      │                                   │ ├── query    │                           │   │
│   │   │ ├── navigate │                                   │ ├── insert   │                           │   │
│   │   │ ├── click    │                                   │ └── update   │                           │   │
│   │   │ ├── extract  │                                   └──────────────┘                           │   │
│   │   │ └── scroll   │                                                                               │   │
│   │   └──────────────┘                                                                               │   │
│   │                                                                                                  │   │
│   │                                                                                                  │   │
│   │   PLANNER TỰ ĐỘNG BIẾT CÓ TOOLS MỚI:                                                            │   │
│   │   ─────────────────────────────────────────────────────────────────────────────────────────────│   │
│   │                                                                                                  │   │
│   │   planner.plan(query, tools=tool_registry.list_all())                                            │   │
│   │                                                                                                  │   │
│   │   → LLM nhận context: "Available tools: math.*, date.*, browser.*, email.*, slack.*, db.*"       │   │
│   │   → LLM tự quyết định dùng tool nào                                                              │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Observability

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    OBSERVABILITY                                                         │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   STRUCTURED LOGGING (mỗi operation có workflow_id)                                              │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   {                                                                                              │   │
│   │     "timestamp": "2024-01-15T10:00:01Z",                                                         │   │
│   │     "level": "INFO",                                                                             │   │
│   │     "workflow_id": "wf_abc123",                                                                  │   │
│   │     "phase": "execute",                                                                          │   │
│   │     "step_id": "s2",                                                                             │   │
│   │     "tool": "browser.navigate",                                                                  │   │
│   │     "duration_ms": 1500,                                                                         │   │
│   │     "status": "success"                                                                          │   │
│   │   }                                                                                              │   │
│   │                                                                                                  │   │
│   │   → Filter by workflow_id để xem toàn bộ flow                                                    │   │
│   │   → Không cần trace qua 11 agents như trước                                                      │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   METRICS (Prometheus/Datadog)                                                                   │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   workflow_duration_seconds{status="success|failed"}                                             │   │
│   │   workflow_phase_duration_seconds{phase="plan|execute|report"}                                   │   │
│   │   tool_execution_duration_seconds{tool="math.sum|browser.navigate|..."}                          │   │
│   │   tool_execution_errors_total{tool="...", error_type="timeout|validation|..."}                   │   │
│   │   circuit_breaker_state{tool="..."} → 0=closed, 1=open, 2=half-open                              │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   TRACING (LangFuse / OpenTelemetry)                                                             │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   workflow_abc123                                                                                │   │
│   │   │                                                                                              │   │
│   │   ├── phase: planning (200ms)                                                                    │   │
│   │   │   └── llm_call: gpt-4 (180ms)                                                                │   │
│   │   │                                                                                              │   │
│   │   ├── phase: executing (3500ms)                                                                  │   │
│   │   │   ├── tool: math.sum (50ms) ✓                                                                │   │
│   │   │   ├── tool: browser.navigate (1500ms) ✓                                                      │   │
│   │   │   └── tool: browser.extract (1800ms) ✓                                                       │   │
│   │   │                                                                                              │   │
│   │   └── phase: reporting (500ms)                                                                   │   │
│   │       └── llm_call: gpt-4 (450ms)                                                                │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. Migration Path

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    MIGRATION PATH                                                        │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 1: Introduce WorkflowManager (1-2 days)                                                  │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   - Tạo WorkflowManager class                                                                    │   │
│   │   - Wrap existing multi_agent_orchestrator                                                       │   │
│   │   - Thêm workflow_id, correlation tracking                                                       │   │
│   │   - Thêm basic timeout management                                                                │   │
│   │   - KHÔNG thay đổi agents                                                                        │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 2: Consolidate Executor (2-3 days)                                                       │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   - Merge MathAgentSum, MathAgentSub, DateAgentToday vào Executor                                │   │
│   │   - Executor gọi tool_registry.execute() trực tiếp                                               │   │
│   │   - Remove các agent pools                                                                       │   │
│   │   - Remove RouterAgent                                                                           │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 3: Remove Message Bus for Core Flow (1 day)                                              │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   - WorkflowManager gọi agents trực tiếp (sync/await)                                            │   │
│   │   - Không dùng MessageBus cho core workflow                                                      │   │
│   │   - Giữ MessageBus cho:                                                                          │   │
│   │     - Event notifications (optional)                                                             │   │
│   │     - UI updates (streaming)                                                                     │   │
│   │     - Audit logging                                                                              │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 4: Add Circuit Breaker & Retry Policy (1 day)                                            │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   - Implement CircuitBreaker class                                                               │   │
│   │   - Add retry policy to WorkflowManager                                                          │   │
│   │   - Test failure scenarios                                                                       │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 5: Cleanup & Documentation (1 day)                                                       │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   - Remove unused code (ChiefAgent, RouterAgent, pool agents)                                    │   │
│   │   - Update documentation                                                                         │   │
│   │   - Add integration tests                                                                        │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   TIMELINE: ~7-10 days total                                                                            │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Tóm tắt

|Aspect|Hiện tại|Đề xuất|
|---|---|---|
|**Số Agents**|11|3|
|**Communication**|MessageBus (async, pub/sub)|Direct calls (sync, await)|
|**State Management**|Distributed (mỗi agent giữ state)|Centralized (WorkflowManager)|
|**Retry Logic**|Trong agents (uncontrolled)|Trong WorkflowManager (controlled)|
|**Extensibility**|Thêm agent mới|Thêm tool mới (MCP)|
|**Debugging**|121 paths|9 paths|
|**Failure Handling**|Implicit (message timeout)|Explicit (circuit breaker)|

**Key Benefits:**

```
✅ Ít agents = Ít complexity = Dễ maintain
✅ Centralized control = Dễ debug + trace
✅ Tools extensible = Thêm capability không thêm agent
✅ Explicit error handling = Không có infinite loops
✅ Sync flow = Dễ reason about
```

Thế còn gọi gì là multi agents?

8:42 PM

Phân tích định nghĩa multi-agent và khi nào cần nhiều agents.

Câu hỏi rất hay! Đây là điểm cần làm rõ về **định nghĩa Multi-Agent**.

---

## Multi-Agent là gì?

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                              MULTI-AGENT ≠ NHIỀU AGENTS                                                  │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   Multi-Agent System (MAS) là về:                                                                │   │
│   │                                                                                                  │   │
│   │   ✅ AUTONOMOUS DECISION MAKING                                                                  │   │
│   │      Mỗi agent tự quyết định dựa trên input, không chỉ execute lệnh                             │   │
│   │                                                                                                  │   │
│   │   ✅ SPECIALIZED ROLES                                                                           │   │
│   │      Mỗi agent có expertise riêng, không thể thay thế bằng agent khác                           │   │
│   │                                                                                                  │   │
│   │   ✅ COORDINATION                                                                                │   │
│   │      Các agents phối hợp để hoàn thành task phức tạp                                            │   │
│   │                                                                                                  │   │
│   │   ❌ KHÔNG PHẢI về số lượng agents                                                               │   │
│   │   ❌ KHÔNG PHẢI mỗi function = 1 agent                                                           │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Phân biệt các Pattern

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PATTERN 1: Tool-Augmented LLM (Single Agent)                                                   │   │
│   │   ══════════════════════════════════════════════════════════════════════════════════════════    │   │
│   │                                                                                                  │   │
│   │                        ┌─────────────────────────────────┐                                       │   │
│   │                        │           LLM                    │                                       │   │
│   │                        │    (1 agent làm tất cả)         │                                       │   │
│   │                        │                                  │                                       │   │
│   │                        │  • Understand query              │                                       │   │
│   │                        │  • Decide which tool             │                                       │   │
│   │                        │  • Call tool                     │                                       │   │
│   │                        │  • Synthesize result             │                                       │   │
│   │                        │                                  │                                       │   │
│   │                        └───────────────┬──────────────────┘                                       │   │
│   │                                        │                                                          │   │
│   │                              ┌─────────┴─────────┐                                                │   │
│   │                              ▼         ▼         ▼                                                │   │
│   │                           [Tool A] [Tool B] [Tool C]                                              │   │
│   │                                                                                                  │   │
│   │   Use when: Simple tasks, single domain, no complex reasoning                                    │   │
│   │   Example: ChatGPT with plugins, Claude with tools                                               │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PATTERN 2: Agentic Workflow (Pseudo Multi-Agent)                                               │   │
│   │   ══════════════════════════════════════════════════════════════════════════════════════════    │   │
│   │                                                                                                  │   │
│   │              ┌──────────┐     ┌──────────┐     ┌──────────┐                                      │   │
│   │              │  Step 1  │────▶│  Step 2  │────▶│  Step 3  │                                      │   │
│   │              │  (LLM)   │     │  (LLM)   │     │  (LLM)   │                                      │   │
│   │              └──────────┘     └──────────┘     └──────────┘                                      │   │
│   │                                                                                                  │   │
│   │   Các "agents" thực ra là các LLM calls với prompts khác nhau                                    │   │
│   │   Không có autonomous decision - chỉ là pipeline                                                 │   │
│   │                                                                                                  │   │
│   │   Use when: Multi-step reasoning, prompt chaining                                                │   │
│   │   Example: LangChain chains, most "agent frameworks"                                             │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PATTERN 3: TRUE Multi-Agent System                                                             │   │
│   │   ══════════════════════════════════════════════════════════════════════════════════════════    │   │
│   │                                                                                                  │   │
│   │              ┌──────────────┐                                                                    │   │
│   │              │   Agent A    │◀───────────────────────┐                                           │   │
│   │              │  (Planner)   │                        │                                           │   │
│   │              │              │     Có thể hỏi lại,    │                                           │   │
│   │              │  Tự quyết    │     negotiate,         │                                           │   │
│   │              │  định plan   │     thay đổi plan      │                                           │   │
│   │              └──────┬───────┘                        │                                           │   │
│   │                     │                                │                                           │   │
│   │         ┌───────────┴───────────┐                    │                                           │   │
│   │         ▼                       ▼                    │                                           │   │
│   │   ┌──────────────┐       ┌──────────────┐           │                                           │   │
│   │   │   Agent B    │       │   Agent C    │           │                                           │   │
│   │   │  (Research)  │       │   (Analyst)  │           │                                           │   │
│   │   │              │       │              │           │                                           │   │
│   │   │  Tự quyết    │       │  Tự quyết    │───────────┘                                           │   │
│   │   │  cách search │       │  interpretation          │                                           │   │
│   │   └──────────────┘       └──────────────┘                                                        │   │
│   │                                                                                                  │   │
│   │   Đặc điểm:                                                                                      │   │
│   │   • Mỗi agent có "brain" riêng (LLM instance với persona)                                        │   │
│   │   • Agents có thể disagree và negotiate                                                          │   │
│   │   • Có feedback loops và iterations                                                              │   │
│   │   • Emergent behavior từ interaction                                                             │   │
│   │                                                                                                  │   │
│   │   Use when: Complex reasoning, multiple perspectives, debate needed                              │   │
│   │   Example: AutoGen, CrewAI, research collaboration                                               │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Vậy dự án của bạn thuộc loại nào?

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   HIỆN TẠI: Agent-per-Function (Anti-pattern)                                                           │
│   ══════════════════════════════════════════════════════════════════════════════════════════════════   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   MathAgentSum, MathAgentSub, DateAgentToday, WebAgentNavigate...                                │   │
│   │                                                                                                  │   │
│   │   ❌ Không có autonomous decision                                                                │   │
│   │   ❌ Chỉ wrap 1 function call                                                                    │   │
│   │   ❌ Không có "brain" (LLM) riêng                                                                │   │
│   │   ❌ Chỉ nhận lệnh và execute                                                                    │   │
│   │                                                                                                  │   │
│   │   → Đây là TOOLS giả danh AGENTS                                                                 │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ĐỀ XUẤT TRƯỚC: Lean Architecture (Agentic Workflow)                                                   │
│   ══════════════════════════════════════════════════════════════════════════════════════════════════   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   3 agents: Planner → Executor → Reporter                                                        │   │
│   │                                                                                                  │   │
│   │   ✅ Có roles khác nhau                                                                          │   │
│   │   ⚠️ Nhưng flow là linear, deterministic                                                         │   │
│   │   ⚠️ Không có negotiation/debate                                                                 │   │
│   │                                                                                                  │   │
│   │   → Đây là Agentic Workflow, không phải true Multi-Agent                                         │   │
│   │   → Nhưng OKAY cho use case đơn giản!                                                            │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Khi nào cần TRUE Multi-Agent?

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   CẦN TRUE MULTI-AGENT KHI:                                                                             │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   1. CẦN MULTIPLE PERSPECTIVES / DEBATE                                                          │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │                                                                                                  │   │
│   │      ┌───────────────┐         ┌───────────────┐                                                │   │
│   │      │  Bull Agent   │◀───────▶│  Bear Agent   │                                                │   │
│   │      │               │ debate  │               │                                                │   │
│   │      │ "AAPL sẽ lên  │         │ "AAPL sẽ xuống│                                                │   │
│   │      │  vì X, Y, Z"  │         │  vì A, B, C"  │                                                │   │
│   │      └───────────────┘         └───────────────┘                                                │   │
│   │                     │                   │                                                        │   │
│   │                     └─────────┬─────────┘                                                        │   │
│   │                               ▼                                                                  │   │
│   │                       ┌───────────────┐                                                          │   │
│   │                       │ Arbiter Agent │                                                          │   │
│   │                       │               │                                                          │   │
│   │                       │ "Cân nhắc cả  │                                                          │   │
│   │                       │  2 bên..."    │                                                          │   │
│   │                       └───────────────┘                                                          │   │
│   │                                                                                                  │   │
│   │   2. CẦN AUTONOMOUS RESEARCH                                                                     │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │                                                                                                  │   │
│   │      ┌───────────────────────────────────────────────────────────────────────────────────────┐  │   │
│   │      │                                                                                        │  │   │
│   │      │   Research Agent:                                                                      │  │   │
│   │      │                                                                                        │  │   │
│   │      │   "Tôi cần tìm hiểu về AAPL. Để tôi:                                                   │  │   │
│   │      │    1. Search Google về 'AAPL earnings 2024'                                            │  │   │
│   │      │    2. Hmm, kết quả không đủ, thử 'Apple Q4 2024 revenue'                               │  │   │
│   │      │    3. Tìm thêm từ SEC filings...                                                       │  │   │
│   │      │    4. So sánh với analyst reports...                                                   │  │   │
│   │      │    5. Phát hiện contradiction, cần verify thêm..."                                     │  │   │
│   │      │                                                                                        │  │   │
│   │      │   → Agent TỰ QUYẾT ĐỊNH next steps, không theo script                                  │  │   │
│   │      │                                                                                        │  │   │
│   │      └───────────────────────────────────────────────────────────────────────────────────────┘  │   │
│   │                                                                                                  │   │
│   │   3. CẦN SPECIALIZATION + COLLABORATION                                                          │   │
│   │      ─────────────────────────────────────────────────────────────────────────────────────────  │   │
│   │                                                                                                  │   │
│   │      ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                                      │   │
│   │      │  Financial  │    │  Technical  │    │    Risk     │                                      │   │
│   │      │   Analyst   │    │   Analyst   │    │   Analyst   │                                      │   │
│   │      │             │    │             │    │             │                                      │   │
│   │      │ Expertise:  │    │ Expertise:  │    │ Expertise:  │                                      │   │
│   │      │ - P/E ratio │    │ - Charts    │    │ - Volatility│                                      │   │
│   │      │ - Revenue   │    │ - Trends    │    │ - VaR       │                                      │   │
│   │      │ - Margins   │    │ - Support   │    │ - Scenarios │                                      │   │
│   │      └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                                      │   │
│   │             │                  │                  │                                              │   │
│   │             └──────────────────┼──────────────────┘                                              │   │
│   │                                ▼                                                                 │   │
│   │                     ┌───────────────────┐                                                        │   │
│   │                     │   Portfolio Mgr   │                                                        │   │
│   │                     │                   │                                                        │   │
│   │                     │ "Based on inputs  │                                                        │   │
│   │                     │  from all analysts│                                                        │   │
│   │                     │  I recommend..."  │                                                        │   │
│   │                     └───────────────────┘                                                        │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Đề xuất mới: TRUE Multi-Agent cho FinAI

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                              TRUE MULTI-AGENT ARCHITECTURE                                               │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │                                 ┌───────────────────┐                                            │   │
│   │                                 │   ORCHESTRATOR    │                                            │   │
│   │                                 │   (Coordinator)   │                                            │   │
│   │                                 │                   │                                            │   │
│   │                                 │ • Assign tasks    │                                            │   │
│   │                                 │ • Collect results │                                            │   │
│   │                                 │ • Manage timeout  │                                            │   │
│   │                                 │ • NO LLM brain    │                                            │   │
│   │                                 └─────────┬─────────┘                                            │   │
│   │                                           │                                                      │   │
│   │              ┌────────────────────────────┼────────────────────────────┐                        │   │
│   │              │                            │                            │                        │   │
│   │              ▼                            ▼                            ▼                        │   │
│   │   ┌───────────────────┐       ┌───────────────────┐       ┌───────────────────┐                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   │   PLANNER AGENT   │       │  RESEARCH AGENT   │       │  ANALYST AGENT    │                │   │
│   │   │   ═══════════════ │       │  ════════════════ │       │  ═══════════════  │                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   │   🧠 LLM Brain    │       │   🧠 LLM Brain    │       │   🧠 LLM Brain    │                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   │   Role:           │       │   Role:           │       │   Role:           │                │   │
│   │   │   Understand user │       │   Gather data     │       │   Analyze data    │                │   │
│   │   │   intent và tạo   │       │   from multiple   │       │   và đưa ra       │                │   │
│   │   │   high-level plan │       │   sources         │       │   insights        │                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   │   Autonomous:     │       │   Autonomous:     │       │   Autonomous:     │                │   │
│   │   │   ✅ Decide steps │       │   ✅ Decide what  │       │   ✅ Decide how   │                │   │
│   │   │   ✅ Can ask for  │       │      to search    │       │      to interpret │                │   │
│   │   │      clarification│       │   ✅ Follow leads │       │   ✅ Can request  │                │   │
│   │   │                   │       │   ✅ Verify facts │       │      more data    │                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   │   Tools:          │       │   Tools:          │       │   Tools:          │                │   │
│   │   │   (none, pure     │       │   • browser.*     │       │   • math.*        │                │   │
│   │   │    reasoning)     │       │   • search.*      │       │   • chart.*       │                │   │
│   │   │                   │       │   • api.*         │       │   • calculator.*  │                │   │
│   │   │                   │       │                   │       │                   │                │   │
│   │   └─────────┬─────────┘       └─────────┬─────────┘       └─────────┬─────────┘                │   │
│   │             │                           │                           │                          │   │
│   │             │         ┌─────────────────┴─────────────────┐         │                          │   │
│   │             │         │                                   │         │                          │   │
│   │             │         ▼                                   ▼         │                          │   │
│   │             │   ┌───────────┐                       ┌───────────┐   │                          │   │
│   │             │   │ Có thể    │                       │ Có thể    │   │                          │   │
│   │             │   │ yêu cầu   │◀──────────────────────│ yêu cầu   │   │                          │   │
│   │             │   │ thêm data │                       │ clarify   │   │                          │   │
│   │             │   └───────────┘                       └───────────┘   │                          │   │
│   │             │                                                       │                          │   │
│   │             └───────────────────────────┬───────────────────────────┘                          │   │
│   │                                         │                                                      │   │
│   │                                         ▼                                                      │   │
│   │                              ┌───────────────────┐                                             │   │
│   │                              │                   │                                             │   │
│   │                              │  REPORTER AGENT   │                                             │   │
│   │                              │  ════════════════ │                                             │   │
│   │                              │                   │                                             │   │
│   │                              │   🧠 LLM Brain    │                                             │   │
│   │                              │                   │                                             │   │
│   │                              │   Role:           │                                             │   │
│   │                              │   Synthesize và   │                                             │   │
│   │                              │   present findings│                                             │   │
│   │                              │                   │                                             │   │
│   │                              │   Autonomous:     │                                             │   │
│   │                              │   ✅ Decide format│                                             │   │
│   │                              │   ✅ Highlight key│                                             │   │
│   │                              │      insights     │                                             │   │
│   │                              │   ✅ Can ask for  │                                             │   │
│   │                              │      more analysis│                                             │   │
│   │                              │                   │                                             │   │
│   │                              └───────────────────┘                                             │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Sự khác biệt chính

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   ┌──────────────────────────────────────┬──────────────────────────────────────┐                       │
│   │      AGENT-PER-FUNCTION              │       TRUE MULTI-AGENT               │                       │
│   │      (Hiện tại của bạn)              │       (Đề xuất)                      │                       │
│   ├──────────────────────────────────────┼──────────────────────────────────────┤                       │
│   │                                      │                                      │                       │
│   │  MathAgentSum:                       │  Research Agent:                     │                       │
│   │  ┌────────────────────────────────┐  │  ┌────────────────────────────────┐  │                       │
│   │  │                                │  │  │                                │  │                       │
│   │  │  def execute(a, b):            │  │  │  🧠 LLM với persona:            │  │                       │
│   │  │      return a + b              │  │  │                                │  │                       │
│   │  │                                │  │  │  "Tôi là Research Agent.       │  │                       │
│   │  │  # Không có brain              │  │  │   Tôi sẽ tìm kiếm thông tin    │  │                       │
│   │  │  # Không có decision           │  │  │   từ nhiều nguồn và verify.    │  │                       │
│   │  │  # Chỉ execute lệnh            │  │  │                                │  │                       │
│   │  │                                │  │  │   Given task: 'Find AAPL info' │  │                       │
│   │  └────────────────────────────────┘  │  │                                │  │                       │
│   │                                      │  │   Tôi quyết định:              │  │                       │
│   │  → Đây là FUNCTION, không phải AGENT │  │   1. Search Yahoo Finance      │  │                       │
│   │                                      │  │   2. Search SEC filings        │  │                       │
│   │                                      │  │   3. Compare với Reuters       │  │                       │
│   │                                      │  │   4. Verify discrepancies      │  │                       │
│   │                                      │  │                                │  │                       │
│   │                                      │  │   Hmm, data không khớp...      │  │                       │
│   │                                      │  │   Tôi cần search thêm..."      │  │                       │
│   │                                      │  │                                │  │                       │
│   │                                      │  └────────────────────────────────┘  │                       │
│   │                                      │                                      │                       │
│   │                                      │  → Đây là TRUE AGENT                 │                       │
│   │                                      │    với autonomous decision           │                       │
│   │                                      │                                      │                       │
│   └──────────────────────────────────────┴──────────────────────────────────────┘                       │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Khi nào dùng gì?

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   USE CASE                                          │  RECOMMENDED PATTERN                      │   │
│   │   ══════════════════════════════════════════════════│═══════════════════════════════════════   │   │
│   │                                                     │                                           │   │
│   │   "Tính 1+2+3"                                      │  Single LLM + Tool                       │   │
│   │   Simple, deterministic                             │  (Không cần agent)                       │   │
│   │                                                     │                                           │   │
│   │   ──────────────────────────────────────────────────│───────────────────────────────────────   │   │
│   │                                                     │                                           │   │
│   │   "Lấy giá AAPL và tính P/E ratio"                  │  Agentic Workflow                        │   │
│   │   Multi-step, deterministic                         │  (Planner → Executor → Reporter)         │   │
│   │                                                     │                                           │   │
│   │   ──────────────────────────────────────────────────│───────────────────────────────────────   │   │
│   │                                                     │                                           │   │
│   │   "Phân tích AAPL có nên mua không?"                │  TRUE Multi-Agent                        │   │
│   │   Requires research, multiple perspectives,         │  (Research + Analyst + Reporter)         │   │
│   │   autonomous exploration                            │                                           │   │
│   │                                                     │                                           │   │
│   │   ──────────────────────────────────────────────────│───────────────────────────────────────   │   │
│   │                                                     │                                           │   │
│   │   "So sánh investment strategies và recommend"      │  Multi-Agent with Debate                 │   │
│   │   Requires debate, weighing pros/cons               │  (Bull vs Bear + Arbiter)                │   │
│   │                                                     │                                           │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Recommendation cho FinAI

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   PHASED APPROACH:                                                                                       │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 1: Fix current issues (Agentic Workflow)                                                 │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   • Giữ 3 agents: Planner, Executor, Reporter                                                    │   │
│   │   • Remove agent-per-function (MathSum, DateToday, etc.)                                         │   │
│   │   • Fix infinite loop, race conditions                                                           │   │
│   │   • Đây KHÔNG PHẢI true multi-agent, nhưng OK cho MVP                                            │   │
│   │                                                                                                  │   │
│   │   Timeline: 1-2 weeks                                                                            │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 2: Add Research Agent (True Multi-Agent)                                                 │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   • Add Research Agent với LLM brain                                                             │   │
│   │   • Research Agent tự quyết định search strategy                                                 │   │
│   │   • Có thể request more data từ Planner                                                          │   │
│   │   • Bắt đầu có autonomous behavior                                                               │   │
│   │                                                                                                  │   │
│   │   Timeline: 2-3 weeks                                                                            │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   PHASE 3: Add Analyst Agent (Specialization)                                                    │   │
│   │   ═══════════════════════════════════════════════════════════════════════════════════════════   │   │
│   │                                                                                                  │   │
│   │   • Analyst Agent với financial expertise                                                        │   │
│   │   • Can debate with Research Agent                                                               │   │
│   │   • Can request specific data points                                                             │   │
│   │   • True collaboration                                                                           │   │
│   │                                                                                                  │   │
│   │   Timeline: 3-4 weeks                                                                            │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Tóm tắt

|Khái niệm|Hiện tại|Sau Phase 1|Sau Phase 3|
|---|---|---|---|
|**Pattern**|Agent-per-function|Agentic Workflow|True Multi-Agent|
|**Số "agents"**|11|3|4-5|
|**True agents**|0|0|3-4|
|**LLM brains**|1 (shared)|1-2|3-4 (per agent)|
|**Autonomous**|❌|❌|✅|
|**Debate/Negotiate**|❌|❌|✅|
|**Complexity**|High (wrong kind)|Low|Medium (right kind)|

**Key insight:** Nhiều agents ≠ Multi-Agent. True Multi-Agent là về **autonomous decision making** và **collaboration**, không phải số lượng.

graph TD A[User Query: tinh 2+4 = ??] --> Chief[MultiAgents_Chief]

Chief -->|publish| MB[MessageBus<br/>Redis PubSub] MB -->|subscribe: task_available| Planner[MultiAgents_Planner]

Planner -->|publish plan_ready| MB MB -->|subscribe: plan_ready| Chief2[Chief<br/>monitoring] MB -->|subscribe: plan_ready| Router[MultiAgents_RouterAgent]

Router -->|publish math_task| MB MB -->|subscribe: math_task| MathSum[MultiAgents_MathAgentSum] MB -->|subscribe: math_task| MathSub[MultiAgents_MathAgentSubtract<br/>skip]

MathSum -->|publish tool_request| MB MB -.->|no subscribers| ToolReq[⚠️ tool_request]

MathSum -->|execute MCP| MCP[MCPToolAdapter] MCP -->|call_tool| MathServer[Math MCP Server<br/>mcp_sum 2+4=6.0]

MCP -->|publish tool_response| MB MB -.->|no subscribers| ToolResp[⚠️ tool_response]

MathSum -->|publish math_result| MB MB -->|subscribe: math_result| Synthesizer[MultiAgents_Synthesizer]

Synthesizer -->|publish final_report| MB MB -->|subscribe: final_report| Chief3[Chief<br/>return to user]

Chief3 --> I[Return to User<br/>## Math Results: - sum: 6.0]

style A fill:`#e1f5ff` style MB fill:`#ff9800`,color:#fff style I fill:`#c8e6c9` style MathSum fill:`#fff9c4` style Synthesizer fill:`#f3e5f5` style ToolReq fill:`#ffebee` style ToolResp fill:`#ffebee` style MathSub fill:`#e0e0e0`

Đánh giá sao về thiết kế này Đây là thiết kế để về sau có thể mở rộng nó áp dụng với multi agents thì bạn thấy sao

Show more

10:04 PM

Phân tích kiến trúc multi-agent, phát hiện race conditions và lỗi thiết kế.

13s

## Đánh giá thiết kế Multi-Agent hiện tại

---

## 1. Điểm số tổng quan

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                                    SCORECARD: 6/10                                                       │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   CRITERIA                              │ SCORE │ NOTES                                         │   │
│   │   ══════════════════════════════════════│═══════│═════════════════════════════════════════════  │   │
│   │   Extensibility (mở rộng)               │  8/10 │ ✅ Dễ thêm agent mới via subscribe            │   │
│   │   Decoupling (tách rời)                 │  7/10 │ ✅ MessageBus tách agents                     │   │
│   │   Correctness (đúng đắn)                │  4/10 │ ⚠️ Race condition, orphan messages            │   │
│   │   Simplicity (đơn giản)                 │  3/10 │ ❌ Quá nhiều hops cho task đơn giản           │   │
│   │   Debuggability (debug)                 │  5/10 │ ⚠️ Khó trace, nhiều paths                    │   │
│   │   Scalability (scale)                   │  7/10 │ ✅ Có thể scale từng pool                     │   │
│   │   Fault Tolerance (chịu lỗi)            │  5/10 │ ⚠️ Orphan messages, no DLQ                   │   │
│   │                                                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Phân tích chi tiết

### 🔴 VẤN ĐỀ 1: Orphan Messages (tool_request, tool_response)

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   DIAGRAM CỦA BẠN:                                                                                       │
│                                                                                                          │
│   MathSum ──── publish tool_request ────▶ MessageBus ──── ⚠️ no subscribers                             │
│                                                                                                          │
│   MCP ──── publish tool_response ────▶ MessageBus ──── ⚠️ no subscribers                                │
│                                                                                                          │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   VẤN ĐỀ:                                                                                                │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   1. Nếu không ai subscribe, tại sao lại publish?                                                        │
│      → Đây là design smell: publish mà không có consumer                                                 │
│                                                                                                          │
│   2. Nếu sau này có subscriber, liệu có race condition?                                                  │
│      → Ai sẽ subscribe? Monitoring? Logging? Retry?                                                      │
│                                                                                                          │
│   3. Message bị mất = không thể debug/audit                                                              │
│      → Nếu MCP fail, làm sao biết tool_request là gì?                                                    │
│                                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│   GIẢI PHÁP:                                                                                             │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   Option A: Remove những publish không cần thiết                                                         │
│             MathSum gọi MCP trực tiếp, không qua MessageBus                                              │
│                                                                                                          │
│   Option B: Thêm Audit/Monitoring Agent subscribe tất cả                                                 │
│             Để log và debug                                                                              │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 🔴 VẤN ĐỀ 2: Race Condition giữa MathSum và MathSub

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   DIAGRAM CỦA BẠN:                                                                                       │
│                                                                                                          │
│   MessageBus ──── subscribe: math_task ────▶ MathSum ✅                                                  │
│              └─── subscribe: math_task ────▶ MathSub (skip)                                             │
│                                                                                                          │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   VẤN ĐỀ:                                                                                                │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   1. CẢ HAI đều nhận message (PubSub broadcast to all subscribers)                                       │
│                                                                                                          │
│   2. MathSub "skip" như thế nào?                                                                         │
│      → Check agent_type trong message?                                                                   │
│      → Vẫn phải process message để quyết định skip                                                       │
│      → Tốn CPU/memory                                                                                    │
│                                                                                                          │
│   3. Nếu message là "subtract", MathSum sẽ skip và MathSub sẽ process                                    │
│      → OK, nhưng cả 2 vẫn nhận message                                                                   │
│                                                                                                          │
│   4. Nếu scale lên 10 Math agents?                                                                       │
│      → 1 message → 10 agents nhận → 9 skip → waste                                                       │
│                                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│   GIẢI PHÁP:                                                                                             │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   Option A: Topic per operation                                                                          │
│             math_sum_task, math_sub_task thay vì math_task                                               │
│             → MathSum chỉ subscribe math_sum_task                                                        │
│                                                                                                          │
│   Option B: Single MathAgent với internal dispatch                                                       │
│             1 agent xử lý tất cả math operations                                                         │
│             → Đơn giản hơn nhiều                                                                         │
│                                                                                                          │
│   Option C: Queue với Competing Consumers (Redis Streams)                                                │
│             Thay vì PubSub, dùng Stream                                                                  │
│             → Chỉ 1 agent nhận mỗi message                                                               │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 🟡 VẤN ĐỀ 3: Quá nhiều Hops cho Task đơn giản

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   TASK: "tính 2+4 = ??"                                                                                  │
│                                                                                                          │
│   CURRENT FLOW (8 hops qua MessageBus):                                                                  │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   User → Chief ─┬─▶ MB ──▶ Planner ──▶ MB ──▶ Router ──▶ MB ──▶ MathSum ──▶ MCP                        │
│                 │                                                    │                                   │
│                 │         ┌──────────────────────────────────────────┘                                   │
│                 │         ▼                                                                              │
│                 │         MB ──▶ Synthesizer ──▶ MB ──▶ Chief ──▶ User                                  │
│                 │                                                                                        │
│                 └─▶ MB ──▶ Chief (monitoring x2)                                                        │
│                                                                                                          │
│   Count: 8 MessageBus hops + 2 monitoring hops = 10 hops                                                │
│                                                                                                          │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   IDEAL FLOW cho simple task:                                                                            │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   User → Executor ──▶ MCP(math.sum) ──▶ User                                                            │
│                                                                                                          │
│   Count: 2 hops                                                                                          │
│                                                                                                          │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   TRADE-OFF:                                                                                             │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   Nhiều hops = Flexibility + Extensibility                                                               │
│   Ít hops = Performance + Simplicity                                                                     │
│                                                                                                          │
│   Nhưng "2+4" không cần flexibility!                                                                     │
│   → Over-engineering cho simple case                                                                     │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

### 🟡 VẤN ĐỀ 4: Chief xuất hiện 3 lần - Confusing

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│   DIAGRAM CỦA BẠN:                                                                                       │
│                                                                                                          │
│   Chief ────▶ MB                         (publish)                                                       │
│   Chief2 ◀──── MB (subscribe plan_ready) (monitoring)                                                   │
│   Chief3 ◀──── MB (subscribe final_report) (return to user)                                             │
│                                                                                                          │
│   ════════════════════════════════════════════════════════════════════════════════════════════════════  │
│                                                                                                          │
│   CÂU HỎI:                                                                                               │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   1. Đây là 1 agent hay 3 agents?                                                                        │
│      → Nếu 1 agent, tại sao vẽ 3 boxes?                                                                  │
│      → Nếu 3 agents, trách nhiệm phân chia như nào?                                                      │
│                                                                                                          │
│   2. Chief subscribe plan_ready để làm gì?                                                               │
│      → Monitoring? Nhưng đã có Router xử lý rồi                                                          │
│      → Duplicate processing?                                                                             │
│                                                                                                          │
│   3. Nếu Chief2 và Chief3 cùng là 1 agent:                                                               │
│      → Agent này có 2 subscription loops chạy concurrent                                                 │
│      → Có thể gây race condition nội bộ                                                                  │
│                                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│   GIẢI PHÁP:                                                                                             │
│   ─────────────────────────────────────────────────────────────────────────────────────────────────────  │
│                                                                                                          │
│   Làm rõ Chief chỉ có 1 trách nhiệm:                                                                     │
│   • Nhận request từ user                                                                                 │
│   • Kick off workflow                                                                                    │
│   • CHỜ final_report                                                                                     │
│   • Return to user                                                                                       │
│                                                                                                          │
│   KHÔNG cần subscribe plan_ready (let Router handle)                                                     │
│                                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Đánh giá về khả năng mở rộng thành True Multi-Agent

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                                          │
│                         KHẢ NĂNG MỞ RỘNG: 7/10 (với điều kiện)                                           │
│                                                                                                          │
│   ┌─────────────────────────────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                                                  │   │
│   │   ✅ ĐIỂM MẠNH CHO MỞ RỘNG:                                                                      │   │
│   │   ════════════════════════════════════════════════════════════════════════════════════════════  │   │
│   │                                                                                                  │   │
│   │   1. MessageBus pattern đúng hướng                                                               │   │
│   │      → Thêm agent mới = thêm subscriber                                                          │   │
│   │      → Không cần sửa agents hiện tại                                                             │   │
│   │                                                                                                  │   │
│   │   2. Topic-based routing linh hoạt                                                               │   │
│   │      → Có thể thêm topic mới cho capability mới                                                  │   │
│   │      → Ví dụ: research_task, analysis_task, debate_request
```

  

[Claude is AI and can make mistakes. Please double-check responses.](https://support.anthropic.com/en/articles/8525154-claude-is-providing-incorrect-or-misleading-responses-what-s-going-on)

Claude