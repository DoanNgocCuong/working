

## BÃ i toÃ¡n 

![](image/Pasted%20image%2020251218173551.png)

![](image/Pasted%20image%2020251218180801.png)

![](image/Pasted%20image%2020251218180832.png)

![](image/Pasted%20image%2020251219141837.png)


```bash
vv API Phoneme giáº£m tá»« 2000ms -> 50ms. (em vá»«a giáº£m time cho tool nÃ y anh â€‹@Äinh HÃ¹ngâ€‹ áº¡ ) ğŸ¤£  
  
+, Ban Ä‘áº§u: 2 text bá»‹ call Ä‘á»‘ng thá»i => call song song giáº£m xuá»‘ng 1000ms  
+, Ban Ä‘áº§u : await session.post(...) Â # háº¿t block => session.close()  
Sau Ä‘Ã³: async with session.post(...) as resp: Â # chá»‰ scope request, khÃ´ng Ä‘Ã³ng session => call giáº£m xuá»‘ng 350ms  
+, Chuyá»ƒn tá»« viá»‡c dÃ¹ng API ngoÃ i -> sang dÃ¹ng tá»± code báº±ng thÆ° viá»‡n: gruut  
vÃ  Chuyá»ƒn tá»« khÃ´ng cache -> sang cache theo cÃ¢u -> sang cache theo tá»« => giáº£m xuá»‘ng 50ms  
  
https://stepup-english.atlassian.net/wiki/x/BAA0YQ
```

### HÃ¬nh dung chung khi cháº¡y báº±ng `docker-compose`

Giáº£ sá»­ báº¡n cÃ³ stack kiá»ƒu:

- `app` (LLM / service chÃ­nh) â†’ gá»i sang  
- `robot-ai-tool` (container hiá»‡n táº¡i, cÃ³ `ToolPhoneme`) â†’ gá»i sang  
- `phoneme-service` (container khÃ¡c, cÃ³ API `PHONEME_URL`)

Container `robot-ai-tool` sáº½ cháº¡y lÃ¢u dÃ i (longâ€‘running process), bÃªn trong cÃ³ nhiá»u láº§n gá»i `phoneme_similarity()`.

---

### 1. CÃ¡ch CÅ¨ (má»—i láº§n gá»i táº¡o má»›i `ClientSession`)

Trong container `robot-ai-tool`, vá»›i **má»—i láº§n** báº¡n gá»i `phoneme_similarity(text_1, text_2)`:

1. `phoneme_similarity` gá»i:
   ```python
   asyncio.gather(
       self.process(text_1),
       self.process(text_2),
   )
   ```
2. Má»—i `process(...)` láº¡i:
   ```python
   async with aiohttp.ClientSession() as session:
       await session.post(self.url, ...)
       # xong lÃ  session bá»‹ close
   ```

Vá»›i `docker-compose`:

- Container `robot-ai-tool` **sá»‘ng lÃ¢u**, nhÆ°ng **má»—i request** tá»« `app` vÃ o láº¡i:
  - Táº¡o má»›i 2 `ClientSession` (1 cho `text_1`, 1 cho `text_2`)
  - Má»—i session láº¡i má»Ÿ káº¿t ná»‘i TCP má»›i tá»›i container `phoneme-service`, TLS handshake, sau Ä‘Ã³ Ä‘Ã³ng luÃ´n.
- Náº¿u báº¡n so sÃ¡nh N cáº·p cÃ¢u:
  - **2N láº§n táº¡o/Ä‘Ã³ng session**, ráº¥t phÃ­:
    - Nhiá»u socket connect/disconnect
    - TLS handshake láº·p láº¡i
    - TÄƒng CPU cáº£ 2 container (client + server)

---

### 2. CÃ¡ch Má»šI (dÃ¹ng láº¡i `ClientSession` trong cÃ¹ng container)

Trong container `robot-ai-tool`:

- Khi khá»Ÿi táº¡o `ToolPhoneme`:
  - `self._session = None`
- Láº§n Äáº¦U gá»i `process()` (dÃ¹ tá»« `phoneme_similarity` hay chá»— khÃ¡c):
  - `_get_session()` tháº¥y `self._session` lÃ  `None` â†’ táº¡o **1 `ClientSession`**:
    ```python
    self._session = aiohttp.ClientSession(timeout=...)
    ```
- CÃ¡c láº§n SAU trong cÃ¹ng process/container:
  - `_get_session()` tháº¥y `self._session` **Ä‘Ã£ tá»“n táº¡i vÃ  chÆ°a closed** â†’ **dÃ¹ng láº¡i**.
- `phoneme_similarity()` gá»i:
  ```python
  asyncio.gather(
      self._get_phoneme_response(text_1),
      self._get_phoneme_response(text_2),
  )
  ```
  â†’ cáº£ 2 `process()` bÃªn dÆ°á»›i Ä‘á»u dÃ¹ng **cÃ¹ng má»™t session**.

Trong bá»‘i cáº£nh `docker-compose`:

- Container `robot-ai-tool` cháº¡y lÃ¢u:
  - ThÆ°á»ng chá»‰ cÃ³ **1 session duy nháº¥t** (hoáº·c ráº¥t Ã­t, náº¿u báº¡n chá»§ Ä‘á»™ng `close()`).
  - Má»i request tá»« `app` vÃ o Ä‘á»u **reuse session** nÃ y, tÃ¡i sá»­ dá»¥ng:
    - TCP connection pool
    - TLS handshake
- Náº¿u báº¡n so sÃ¡nh N cáº·p cÃ¢u:
  - Váº«n lÃ  **2N request HTTP**, nhÆ°ng:
    - **1 session** (thay vÃ¬ 2N session),
    - Nhiá»u request sáº½ reuse **cÃ¹ng káº¿t ná»‘i TCP** â†’ giáº£m latency, giáº£m CPU.

---

### 3. TÃ¡c Ä‘á»™ng thá»±c táº¿ khi cháº¡y báº±ng `docker-compose`

- **TrÆ°á»›c tá»‘i Æ°u:**
  - Má»—i API call tá»« `app` â†’ `robot-ai-tool`:
    - Container `robot-ai-tool` táº¡o/Ä‘Ã³ng 2 session.
    - Container `phoneme-service` nháº­n nhiá»u káº¿t ná»‘i chá»›p nhoÃ¡ng, chi phÃ­ handshakes cao.
  - Khi load cao (nhiá»u user, nhiá»u cÃ¢u), response time **tÄƒng nhanh**, CPU server tÄƒng.

- **Sau tá»‘i Æ°u:**
  - Container `robot-ai-tool` giá»¯ 1 `ClientSession` lÃ¢u dÃ i:
    - Reuse socket, Ã­t handshake.
  - Vá»›i cÃ¹ng sá»‘ lÆ°á»£ng user:
    - Thá»i gian xá»­ lÃ½ má»—i request ngáº¯n hÆ¡n (Ã­t overhead káº¿t ná»‘i),
    - Táº£i trÃªn `phoneme-service` Ä‘á»u hÆ¡n, Ã­t tá»‘n CPU cho káº¿t ná»‘i láº¡i.

---

Náº¿u báº¡n mÃ´ táº£ cá»¥ thá»ƒ hÆ¡n flow trong `docker-compose` (vÃ­ dá»¥: service nÃ o gá»i `ToolPhoneme`, khá»Ÿi táº¡o `ToolPhoneme` 1 láº§n hay nhiá»u láº§n), mÃ¬nh cÃ³ thá»ƒ gá»£i Ã½ thÃªm: nÃªn khá»Ÿi táº¡o `ToolPhoneme` á»Ÿ level nÃ o (singleton, per-request, per-session) Ä‘á»ƒ táº­n dá»¥ng tá»‘i Ä‘a viá»‡c reuse `ClientSession`.



---

# CÃ¢u há»i: 1. CÆ¡ cháº¿ nÃ o Ä‘á»ƒ báº¡n giá»¯ káº¿t ná»‘i khi khá»Ÿi táº¡o Ä‘oáº¡n Ä‘áº¥y mÃ  khÃ´ng bá»‹ Ä‘Ã³ng + 2. CÆ¡ cháº¿ nÃ o Ä‘á»ƒ báº¡n cache Ä‘Æ°á»£c káº¿t quáº£ trÆ°á»›c, vÃ  khi nÃ³ phÃ¬ng to ra thÃ¬ sao ?

Tráº£ lá»i láº§n lÆ°á»£t, nÃ³i theo Ä‘Ãºng báº£n cháº¥t cÆ¡ cháº¿ nhÃ©.

---

### 1. CÆ¡ cháº¿ giá»¯ káº¿t ná»‘i (giá»¯ `ClientSession` khÃ´ng bá»‹ Ä‘Ã³ng)

**Ã chÃ­nh:**  
- `ClientSession` **chá»‰ bá»‹ Ä‘Ã³ng khi báº¡n gá»i `close()` hoáº·c nÃ³ bá»‹ GC (máº¥t háº¿t reference)**.  
- Náº¿u báº¡n:
  - Táº¡o `self._session` trong `__init__` (hoáº·c láº§n Ä‘áº§u `_get_session()`),
  - **KhÃ´ng** dÃ¹ng `async with aiohttp.ClientSession() as session:` quanh nÃ³,
  - VÃ  giá»¯ `ToolPhoneme` sá»‘ng suá»‘t vÃ²ng Ä‘á»i service,  
  â†’ thÃ¬ `session` sáº½ **sá»‘ng theo luÃ´n** (giá»‘ng 1 singleton trong RAM container).

Cá»¥ thá»ƒ:

- CÃ¡ch *khÃ´ng giá»¯ Ä‘Æ°á»£c* (cÅ©):

```python
async def process(...):
    async with aiohttp.ClientSession() as session:
        await session.post(...)  # háº¿t block => session.close()
```

- CÃ¡ch *giá»¯ Ä‘Æ°á»£c*:

```python
class ToolPhoneme:
    def __init__(...):
        self._session = None

    async def _get_session(self):
        if self._session is None or self._session.closed:
            self._session = aiohttp.ClientSession(...)
        return self._session

    async def process(...):
        session = await self._get_session()
        async with session.post(...) as resp:  # chá»‰ scope request, khÃ´ng Ä‘Ã³ng session
            ...
```

- á» Ä‘Ã¢y:
  - `async with session.post(...)` chá»‰ Ä‘Ã³ng **request**, khÃ´ng Ä‘Ã³ng `session`.
  - `self._session` lÃ  field cá»§a object `ToolPhoneme`.  
    Miá»…n lÃ  object nÃ y cÃ²n sá»‘ng (Ä‘Æ°á»£c service giá»¯ reference, vÃ­ dá»¥ biáº¿n global, singleton, DI container giá»¯),  
    thÃ¬ GC sáº½ **khÃ´ng dá»n**, `ClientSession` khÃ´ng bá»‹ Ä‘Ã³ng.

---

### 2. CÆ¡ cháº¿ cache káº¿t quáº£ + chuyá»‡n â€œphÃ¬nh toâ€

**CÆ¡ cháº¿ cache Ä‘Æ¡n giáº£n:**

- DÃ¹ng **dict trong RAM**:

```python
self._phoneme_cache = {}  # trong __init__

async def _get_phoneme_response(self, text, lang="en-US", mode=True):
    key = (text, lang, mode)
    if key in self._phoneme_cache:
        return self._phoneme_cache[key]

    resp = await self.process(text=text, lang=lang, mode=mode)
    self._phoneme_cache[key] = resp
    return resp
```

- CÃ¡ch hoáº¡t Ä‘á»™ng:
  - Láº§n Ä‘áº§u gáº·p `(text, lang, mode)` â†’ gá»i API tháº­t, lÆ°u vÃ o dict.
  - Láº§n sau gáº·p láº¡i Ä‘Ãºng key Ä‘Ã³ â†’ tráº£ luÃ´n tá»« dict, **0 network**.

**Váº¥n Ä‘á» â€œphÃ¬nh toâ€:**

- Dict nÃ y **náº±m trong memory cá»§a process/container**:
  - Náº¿u user / cÃ¢u text ráº¥t Ä‘a dáº¡ng (má»—i request Ä‘á»u text má»›i),  
    â†’ sá»‘ key tÄƒng dáº§n, RAM tÄƒng dáº§n.
  - Náº¿u service cháº¡y lÃ¢u, khÃ´ng xÃ³a â†’ cÃ³ nguy cÆ¡ **leak bá»™ nhá»›** (thá»±c ra lÃ  unbounded cache).

**CÃ¡ch xá»­ lÃ½ khi muá»‘n cache â€œan toÃ nâ€:**

1. **Giá»›i háº¡n sá»‘ lÆ°á»£ng entry (size-bounded cache)**  
   - DÃ¹ng LRU (Least Recently Used): khi full, xÃ³a bá»›t cÃ¡i Ã­t dÃ¹ng gáº§n Ä‘Ã¢y.
   - Python cÃ³ thá»ƒ dÃ¹ng:
     - `functools.lru_cache` cho hÃ m sync (á»Ÿ Ä‘Ã¢y mÃ¬nh Ä‘ang async, pháº£i wrap),
     - Hoáº·c tá»± implement LRU báº±ng `collections.OrderedDict`
     - Hoáº·c dÃ¹ng lib nhÆ° `cachetools`.

2. **Thá»i gian sá»‘ng (TTL cache)**  
   - Má»—i record lÆ°u thÃªm `timestamp`, sau X giÃ¢y/phÃºt thÃ¬ coi lÃ  háº¿t háº¡n, xÃ³a/ghi Ä‘Ã¨:
   ```python
   self._phoneme_cache = {}  # key -> (created_at, data)
   ```

3. **XÃ³a Ä‘á»‹nh ká»³ (scheduled cleanup)**  
   - VÃ­ dá»¥ má»—i N request / má»—i N giÃ¢y, cháº¡y 1 hÃ m:
     - QuÃ©t cache, xÃ³a entry quÃ¡ cÅ© / quÃ¡ nhiá»u.

4. **Táº¯t cache vá»›i case khÃ´ng cáº§n**  
   - Náº¿u text luÃ´n khÃ¡c nhau (khÃ´ng bao giá» láº·p), cache khÃ´ng cÃ³ lá»£i â†’ cÃ³ thá»ƒ táº¯t háº³n.

---

### Gá»£i Ã½ thá»±c táº¿ cho project cá»§a báº¡n

- Náº¿u use case lÃ :  
  â€œSo sÃ¡nh **má»™t cÃ¢u chuáº©n** vá»›i **ráº¥t nhiá»u cÃ¢u há»c viÃªn**â€  
  â†’ cache **theo text chuáº©n** lÃ  cá»±c ká»³ hiá»‡u quáº£, vÃ  sá»‘ lÆ°á»£ng key Ã­t â†’ khÃ´ng lo phÃ¬nh.
- Náº¿u use case lÃ :  
  â€œMá»—i láº§n lÃ  cáº·p cÃ¢u má»›i hoÃ n toÃ nâ€  
  â†’ cache gáº§n nhÆ° khÃ´ng giÃºp gÃ¬, chá»‰ tá»‘n RAM â†’ cÃ¢n nháº¯c:
  - Hoáº·c khÃ´ng cache,
  - Hoáº·c cache size ráº¥t nhá» (LRU 100â€“500 entry) Ä‘á»ƒ an toÃ n.

Náº¿u báº¡n cho mÃ¬nh biáº¿t pattern gá»i thá»±c táº¿ (1 cÃ¢u chuáº©n + N cÃ¢u há»c viÃªn, hay 1000 cáº·p random?), mÃ¬nh cÃ³ thá»ƒ Ä‘á» xuáº¥t luÃ´n cáº¥u hÃ¬nh cache: cÃ³ nÃªn dÃ¹ng, size bao nhiÃªu, TTL bao nhiÃªu lÃ  há»£p lÃ½.



---

```
Viáº¿t cho tá»› 1 report vá»

DÃ¹ng asyncio.gather Ä‘á»ƒ song song 2 request.

DÃ¹ng ClientSession reuse + cache â†’ loáº¡i overhead connect + TLS trong láº§n sau.

  

SiÃªu chi tiáº¿t dÃ i 1000 tá»« vá» cÃ¡i nÃ y cho ngÆ°á»i tá»« Fresher Ä‘áº¿n táº§ng C Level Ä‘á»u Ä‘á»c vÃ  tháº¥y siÃªu hay vÃ¬ nÃ³ Ráº¤T SÃ‚U Vá»€ KIáº¾N TRÃšC CODE VÃ€ Tá»I Æ¯U Cá»¦A CÃC HÃ€M NÃ€Y
```


# BÃ¡o cÃ¡o kiáº¿n trÃºc & tá»‘i Æ°u cho `phonemeSimilarity`  
**Chá»§ Ä‘á»:** `asyncio.gather` song song 2 request + `ClientSession` reuse + cache  
**Äá»‘i tÆ°á»£ng:** tá»« Fresher â†’ Senior â†’ C-Level Ä‘á»u hiá»ƒu vÃ  tháº¥y giÃ¡ trá»‹

---

## 1. Bá»©c tranh tá»•ng thá»ƒ: ta Ä‘ang tá»‘i Æ°u cÃ¡i gÃ¬?

BÃ i toÃ¡n cá»§a báº¡n:

- HÃ m `phoneme_similarity(text_1, text_2)` pháº£i:
  - Gá»i API phoneme 2 láº§n Ä‘á»ƒ láº¥y IPA cho `text_1` vÃ  `text_2`.
  - TÃ­nh Ä‘á»™ giá»‘ng nhau (Levenshtein).
  - Tráº£ vá» káº¿t quáº£ nhanh vÃ  á»•n Ä‘á»‹nh.

Thá»±c táº¿ Ä‘o Ä‘Æ°á»£c:

- **Má»™t láº§n gá»i API phoneme máº¥t ~900â€“950 ms** (vÃ¬ lÃ  dá»‹ch vá»¥ bÃªn ngoÃ i, cÃ³ thá»ƒ qua internet).
- Pháº§n code Python ná»™i bá»™ (Levenshtein, xá»­ lÃ½ chuá»—i) chá»‰ máº¥t **vÃ i ms**.

VÃ¬ váº­y, **95â€“99% thá»i gian náº±m á»Ÿ I/O network**, khÃ´ng náº±m á»Ÿ CPU Python.  
Tá»‘i Æ°u hiá»‡u quáº£ nháº¥t sáº½ táº­p trung vÃ o:

1. **CÃ¡ch ta gá»i 2 request** (`asyncio.gather`).
2. **CÃ¡ch ta quáº£n lÃ½ káº¿t ná»‘i HTTP** (`ClientSession` reuse).
3. **CÃ¡ch ta trÃ¡nh gá»i láº¡i nhá»¯ng thá»© Ä‘Ã£ gá»i rá»“i** (cache).

---

## 2. `asyncio.gather`: tá»« tuáº§n tá»± â†’ song song (I/O-bound)

### 2.1. CÃ¡ch cháº¡y tuáº§n tá»± (kÃ©m tá»‘i Æ°u)

Náº¿u viáº¿t kiá»ƒu Ä‘á»“ng bá»™:

```python
tokens1 = await self.process(text_1)  # call API 1
tokens2 = await self.process(text_2)  # call API 2
```

- Timeline:
  - `Request 1` â†’ chá» ~900 ms â†’ xong.
  - `Request 2` â†’ chá» ~900 ms â†’ xong.
- Tá»•ng thá»i gian ~ `900 + 900 = 1800 ms`.

Vá»›i user, 1.8s lÃ  khÃ¡ cháº­m, Ä‘áº·c biá»‡t náº¿u báº¡n cÃ²n nhiá»u tool khÃ¡c.

### 2.2. CÃ¡ch cháº¡y song song vá»›i `asyncio.gather`

Code hiá»‡n táº¡i:

```python
tokens1, tokens2 = await asyncio.gather(
    self._get_phoneme_response(text_1),
    self._get_phoneme_response(text_2),
)
```

á» Ä‘Ã¢y:

- `asyncio.gather` **khá»Ÿi cháº¡y 2 coroutine cÃ¹ng lÃºc**.
- VÃ¬ Ä‘Ã¢y lÃ  I/O network, khi request 1 chá» thÃ¬ loop cÃ³ thá»ƒ xá»­ lÃ½ request 2, khÃ´ng pháº£i chá» â€œcháº¿tâ€.

Timeline:

- Gá»­i `Request 1` + `Request 2` gáº§n nhÆ° **cÃ¹ng lÃºc**.
- Cáº£ 2 Ä‘á»u máº¥t ~900 ms nhÆ°ng **cháº¡y song song**:
  - Tá»•ng thá»i gian â‰ˆ max(900, 900) = ~900 ms (chÃªnh thÃªm vÃ i ms overhead).

**Ã nghÄ©a cho Fresher:**

- â€œSong songâ€ á»Ÿ Ä‘Ã¢y khÃ´ng pháº£i lÃ  2 thread, mÃ  lÃ  **I/O async**:
  - Khi request 1 Ä‘ang chá» server tráº£ lá»i, Python khÃ´ng lÃ m gÃ¬ â†’ ta táº­n dá»¥ng khoáº£ng thá»i gian Ä‘Ã³ Ä‘á»ƒ chá» thÃªm request 2.
  - ÄÃ¢y lÃ  lá»£i tháº¿ lá»›n trong cÃ¡c app I/O-bound (gá»i API, Ä‘á»c file, DB, v.v.).

**Ã nghÄ©a cho Senior / Architect:**

- DÃ¹ng `asyncio.gather` trÃªn coroutine **idempotent** hoáº·c khÃ´ng phá»¥ thuá»™c nhau lÃ  chuáº©n:
  - CÃ¡c request Ä‘á»™c láº­p (IPA text_1, IPA text_2).
  - KhÃ´ng cÃ³ thá»© tá»± rÃ ng buá»™c â†’ Ä‘á»§ Ä‘iá»u kiá»‡n cháº¡y song song.
- Náº¿u mai nÃ y báº¡n cÃ³:
  - So sÃ¡nh 1 cÃ¢u chuáº©n vá»›i **10 cÃ¢u há»c viÃªn cÃ¹ng lÃºc**, cÃ³ thá»ƒ extend:
    ```python
    await asyncio.gather(*(self._get_phoneme_response(t) for t in texts))
    ```
  - Váº«n giá»¯ kiáº¿n trÃºc async, má»Ÿ rá»™ng scale tá»‘t.

---

## 3. `ClientSession` reuse: bá» thÃ³i quen â€œdÃ¹ng xong vá»©t luÃ´nâ€

### 3.1. Váº¥n Ä‘á» khi táº¡o `ClientSession` má»—i láº§n

CÃ¡ch cÅ©:

```python
async def process(...):
    async with aiohttp.ClientSession() as session:
        async with session.post(self.url, ...) as resp:
            ...
```

Má»—i láº§n gá»i:

1. Táº¡o má»›i 1 `ClientSession`.
2. Thiáº¿t láº­p:
   - Connection pool,
   - DNS resolve,
   - TLS handshake (náº¿u HTTPS).
3. Gá»­i request, nháº­n response.
4. ÄÃ³ng session ngay sau khi thoÃ¡t khá»i `async with`.

**Há»‡ quáº£:**

- Vá»›i 1 user: má»—i láº§n gá»i tool â†’ 2 session má»›i â†’ connect/disconnect liÃªn tá»¥c.
- Vá»›i nhiá»u user Ä‘á»“ng thá»i:
  - Tá»‘n ráº¥t nhiá»u **socket**, TLS handshake, CPU.
  - PhÃ­a server phoneme cÅ©ng stres hÆ¡n vÃ¬ nhiá»u káº¿t ná»‘i ngáº¯n, bÃ¹ng ná»•.

DÃ¹ báº¡n dÃ¹ng `asyncio.gather`, nhÆ°ng **bÃªn dÆ°á»›i váº«n lÃ  2 session bá»‹ táº¡o & há»§y má»—i láº§n** â†’ overhead thá»«a.

### 3.2. CÃ¡ch Ä‘Ãºng: 1 `ClientSession` cho cáº£ vÃ²ng Ä‘á»i service

Code hiá»‡n táº¡i:

```python
class ToolPhoneme:
    def __init__(...):
        self._session = None

    async def _get_session(self):
        if self._session is None or self._session.closed:
            timeout = aiohttp.ClientTimeout(total=self.timeout)
            self._session = aiohttp.ClientSession(timeout=timeout)
        return self._session
```

Trong `process(...)`:

```python
session = await self._get_session()
async with session.post(self.url, json=payload, headers=headers) as response:
    ...
```

**Äiá»ƒm máº¥u chá»‘t:**

- `ClientSession` lÃ  **HTTP client â€œnáº·ngâ€**:
  - NÃ³ giá»¯ pool káº¿t ná»‘i,
  - Quáº£n lÃ½ keep-alive,
  - Reuse socket cho nhiá»u request Ä‘áº¿n cÃ¹ng domain.
- Báº±ng cÃ¡ch giá»¯ `self._session`:
  - Session chá»‰ táº¡o **láº§n Ä‘áº§u** hoáº·c khi bá»‹ Ä‘Ã³ng.
  - Má»i request sau sá»­ dá»¥ng **cÃ¹ng má»™t session**, reuse connection, TLS.

**Ã nghÄ©a thá»±c táº¿:**

- Vá»›i má»™t service cháº¡y trong Docker (Uvicorn/FastAPI cháº³ng háº¡n):
  - `ToolPhoneme` sá»‘ng theo vÃ²ng Ä‘á»i process.
  - `_session` sá»‘ng theo `ToolPhoneme`.
  - Káº¿t ná»‘i TCP tá»›i `api2.unalengua.com` Ä‘Æ°á»£c **reuse tá»‘i Ä‘a**.
- Thá»i gian ~900ms pháº§n lá»›n váº«n lÃ  **server xá»­ lÃ½ phoneme**, nhÆ°ng:
  - Báº¡n trÃ¡nh Ä‘Æ°á»£c thÃªm overhead káº¿t ná»‘i má»—i láº§n.
  - Khi traffic tÄƒng, system váº«n á»•n Ä‘á»‹nh, Ã­t â€œgiáº­tâ€.

**Äá»‘i vá»›i C-Level:**

- ÄÃ¢y lÃ  tá»‘i Æ°u **chi phÃ­ & Ä‘á»™ á»•n Ä‘á»‹nh**:
  - Ãt káº¿t ná»‘i táº¡o/há»§y liÃªn tá»¥c â†’ tiáº¿t kiá»‡m CPU & tÃ i nguyÃªn network.
  - Cáº£i thiá»‡n throughput, giáº£m nguy cÆ¡ â€œngháº½n cá»• chaiâ€ á»Ÿ service phoneme.

---

## 4. Cache: Ä‘Ã¡nh tháº³ng vÃ o tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng

### 4.1. Thá»±c táº¿ log báº¡n tháº¥y

- Láº§n gá»i Ä‘áº§u cho cáº·p `(text_1, text_2)`:
  - `[PHONEME][REQUEST]` xuáº¥t hiá»‡n 2 láº§n.
  - Má»—i láº§n ~900 ms.
  - `[PHONEME_SIM][END] ... elapsed_ms ~= 900â€“950 ms`.

- CÃ¡c láº§n sau vá»›i **cÃ¹ng cáº·p text**:
  - KhÃ´ng cÃ²n `[PHONEME][REQUEST]/[RESPONSE]`.
  - `[PHONEME_SIM][END] ... elapsed_ms ~= 5â€“10 ms`.

â†’ Cache Ä‘ang giÃºp biáº¿n **tráº£i nghiá»‡m tá»« ~1 giÃ¢y â†’ vÃ i mili-giÃ¢y** vá»›i cÃ¡c input láº·p láº¡i.

### 4.2. Cáº¥u trÃºc cache trong code

- Trong `__init__`:

```python
self._phoneme_cache = {}  # key: (text, lang, mode) -> response_json
```

- HÃ m láº¥y phoneme cÃ³ cache:

```python
async def _get_phoneme_response(self, text, lang="en-US", mode=True):
    key = (text, lang, mode)
    if key in self._phoneme_cache:
        return self._phoneme_cache[key]

    response = await self.process(text=text, lang=lang, mode=mode)
    self._phoneme_cache[key] = response
    return response
```

- `phoneme_similarity` gá»i:

```python
tokens1, tokens2 = await asyncio.gather(
    self._get_phoneme_response(text_1),
    self._get_phoneme_response(text_2),
)
```

### 4.3. Ã nghÄ©a kiáº¿n trÃºc

- **Pattern chuáº©n**:
  - `process` = low-level client gá»i API (khÃ´ng cache, chá»‰ lo gá»­i/nháº­n).
  - `_get_phoneme_response` = logic â€œbusinessâ€ thÃªm cache, dá»±a trÃªn `process`.
  - `phoneme_similarity` = orchestrator, wrap toÃ n bá»™ flow (song song, cache, tÃ­nh similarity).

â†’ Ráº¥t há»£p vá»›i **S** trong SOLID (Single Responsibility):

- `process`: 1 trÃ¡ch nhiá»‡m â€“ nÃ³i chuyá»‡n vá»›i service phoneme.
- `_get_phoneme_response`: 1 trÃ¡ch nhiá»‡m â€“ thÃªm caching cho káº¿t quáº£ phoneme.
- `phoneme_similarity`: 1 trÃ¡ch nhiá»‡m â€“ orchestrate flow tá»« text â†’ IPA â†’ similarity.

**Äá»‘i vá»›i C-Level / Architect:**

- ÄÃ¢y lÃ  **layered design**:
  - Network layer (client) tÃ¡ch khá»i caching layer vÃ  business layer.
  - Sau nÃ y muá»‘n:
    - Äá»•i service phoneme (URL khÃ¡c),
    - Äá»•i cÆ¡ cháº¿ cache (LRU, Redis),
    - Äá»•i thuáº­t toÃ¡n similarity,  
    â†’ chá»‰ cáº§n sá»­a tá»«ng lá»›p, khÃ´ng phÃ¡ cáº£ há»‡ thá»‘ng.

---

## 5. Rá»§i ro & hÆ°á»›ng má»Ÿ rá»™ng

### 5.1. Rá»§i ro cache

- Náº¿u text luÃ´n má»›i (user nÃ³i cÃ¢u má»›i má»—i láº§n), cache sáº½:
  - Ãt hit,
  - RAM tÄƒng dáº§n náº¿u khÃ´ng giá»›i háº¡n.
- Giáº£i phÃ¡p:
  - ThÃªm LRU (giá»›i háº¡n sá»‘ item, xÃ³a cÃ¡i cÅ©),
  - Hoáº·c TTL (háº¿t háº¡n sau X phÃºt),
  - Hoáº·c táº¯t cache náº¿u thá»‘ng kÃª cho tháº¥y tá»‰ lá»‡ hit quÃ¡ tháº¥p.

### 5.2. HÆ°á»›ng má»Ÿ rá»™ng kiáº¿n trÃºc

- **Batching**:
  - Náº¿u service phoneme support: gá»­i nhiá»u cÃ¢u trong 1 request â†’ táº­n dá»¥ng hÆ¡n ná»¯a.
- **Precompute**:
  - Vá»›i cÃ¢u chuáº©n (vÃ­ dá»¥ cÃ¢u target trong bÃ i há»c), cÃ³ thá»ƒ:
    - Precompute IPA trÆ°á»›c, lÆ°u DB/cache,
    - Khi há»c viÃªn gá»­i cÃ¢u, chá»‰ cáº§n gá»i service cho cÃ¢u há»c viÃªn.
- **TÃ¡ch module**:
  - `ToolPhoneme` cÃ³ thá»ƒ tÃ¡ch thÃ nh cÃ¡c class nhá»:
    - `PhonemeClient` (gá»i API, reuse session),
    - `PhonemeCache` (chiáº¿n lÆ°á»£c cache),
    - `PhonemeSimilarityService` (logic similarity).
  - Äáº¡t chuáº©n SOLID cao hÆ¡n, dá»… unit test tá»«ng pháº§n.

---

## 6. Tá»•ng káº¿t giÃ¡ trá»‹

- **Cho Fresher:**
  - Há»c Ä‘Æ°á»£c:
    - VÃ¬ sao dÃ¹ng `asyncio.gather` láº¡i nhanh hÆ¡n cháº¡y tuáº§n tá»±.
    - VÃ¬ sao khÃ´ng nÃªn táº¡o `ClientSession` má»›i má»—i láº§n.
    - Cache Ä‘Æ¡n giáº£n báº±ng dict giÃºp giáº£m thá»i gian ráº¥t máº¡nh cho input láº·p láº¡i.

- **Cho Mid/Senior:**
  - Tháº¥y rÃµ pattern:
    - I/O-bound async,
    - Session pooling,
    - Caching layer tÃ¡ch khá»i network layer.
  - Dá»… nhÃ¢n rá»™ng pattern nÃ y sang cÃ¡c tool khÃ¡c (TTS, STT, LLM call, v.v.).

- **Cho C-Level / Architect:**
  - ÄÃ¢y lÃ  má»™t vÃ­ dá»¥ nhá» nhÆ°ng rÃµ rÃ ng vá»:
    - **Tá»‘i Æ°u latency end-to-end** mÃ  khÃ´ng cáº§n â€œÄ‘áº­p Ä‘i xÃ¢y láº¡iâ€.
    - **Giáº£m chi phÃ­ há»‡ thá»‘ng** báº±ng reuse tÃ i nguyÃªn (káº¿t ná»‘i, cache).
    - **Thiáº¿t káº¿ phÃ¢n lá»›p Ä‘Ãºng chuáº©n**, dá»… báº£o trÃ¬, dá»… scale.

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ tiáº¿p tá»¥c viáº¿t thÃªm má»™t section trong `docs/docs1.1_PythonOpt.md` Ä‘á»ƒ team dev cá»§a báº¡n dÃ¹ng luÃ´n nhÆ° â€œBest Practice cho service async I/O-boundâ€ trong dá»± Ã¡n.


---

<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# server 1/localhost -> call Ä‘áº¿n server 2 (data sáº½ Ä‘i tá»›i server 2, sau Ä‘Ã³ call tá»›i external API vÃ  quay láº¡i) thÃ¬ láº¡i háº¿t 1s

trong khi server 1/localhost call tá»›i external API háº¿t cÃ³ 300ms

ÄÃ¢y lÃ  hiá»‡n tÆ°á»£ng **proxy/intermediary overhead** ráº¥t Ä‘iá»ƒn hÃ¬nh! Äá»ƒ hiá»ƒu rÃµ táº¡i sao server 2 lÃ m proxy láº¡i tÄƒng latency tá»« 300ms lÃªn 1000ms, ta cáº§n phÃ¢n tÃ­ch chi tiáº¿t tá»«ng thÃ nh pháº§n.

## PhÃ¢n tÃ­ch latency theo cÃ´ng thá»©c

**CÃ´ng thá»©c latency trong multi-hop network**:[^1]

```
LatencyTwoWay = 2 Ã— (TxTime + AckTime + (NumberOfHops - 1) Ã— 
                (RoutingProcessingTime + TxTime + AckTime)) + ServerResponseTime
```


### Case 1: Server 1/localhost â†’ External API trá»±c tiáº¿p (300ms)

**Path Ä‘Æ¡n giáº£n**: Client â†’ External API

```
1. Client â†’ External API:
   - DNS resolution: 10ms
   - TCP handshake: 50ms (3-way)
   - TLS handshake: 100ms
   - Request transmission: 20ms
   - External API processing: 100ms
   - Response transmission: 20ms

Tá»•ng: ~300ms
```


### Case 2: Server 1/localhost â†’ Server 2 â†’ External API (1000ms)

**Path phá»©c táº¡p**: Client â†’ Server 2 (proxy) â†’ External API

```
Leg 1: Client â†’ Server 2
â”œâ”€ DNS resolution: 10ms
â”œâ”€ TCP handshake (client-server2): 50ms
â”œâ”€ TLS handshake (client-server2): 100ms
â”œâ”€ Request transmission: 20ms
â””â”€ Subtotal: 180ms

Leg 2: Server 2 processing
â”œâ”€ Receive & parse request: 10-20ms
â”œâ”€ Request validation: 5-10ms
â”œâ”€ Logging/middleware: 10-30ms
â”œâ”€ Prepare outbound request: 5-10ms
â””â”€ Subtotal: 30-70ms

Leg 3: Server 2 â†’ External API
â”œâ”€ DNS resolution (náº¿u chÆ°a cache): 10-20ms
â”œâ”€ TCP handshake (server2-api): 50-80ms
â”œâ”€ TLS handshake (server2-api): 100-150ms
â”œâ”€ Request transmission: 20-30ms
â”œâ”€ External API processing: 100ms
â””â”€ Subtotal: 280-380ms

Leg 4: External API â†’ Server 2 (response)
â”œâ”€ Response transmission: 20-30ms
â””â”€ Subtotal: 20-30ms

Leg 5: Server 2 processing response
â”œâ”€ Parse response: 10-20ms
â”œâ”€ Response transformation: 10-30ms
â”œâ”€ Logging/monitoring: 10-30ms
â””â”€ Subtotal: 30-80ms

Leg 6: Server 2 â†’ Client (response)
â”œâ”€ Response transmission: 20-30ms
â””â”€ Subtotal: 20-30ms

Tá»”NG: 560-850ms (Ä‘iá»u kiá»‡n tá»‘t)
      900-1200ms (Ä‘iá»u kiá»‡n thá»±c táº¿)
```


## CÃ¡c nguá»“n gá»‘c overhead khi qua Server 2

### 1. **Double Network Round Trips**[^2][^3]

Thay vÃ¬ 1 RTT (client â†” external API), giá» cÃ³ **2 RTT tuáº§n tá»±**:

- RTT1: Client â†” Server 2
- RTT2: Server 2 â†” External API

Náº¿u má»—i RTT ~150ms â†’ Ä‘Ã£ máº¥t thÃªm 150ms ngay.[^3]

### 2. **Multiple TLS Handshakes**[^2]

**Case trá»±c tiáº¿p**: 1 TLS handshake (~100ms)

**Case qua Server 2**: 2 TLS handshakes tuáº§n tá»±[^2]

- Client â†’ Server 2: 100-150ms
- Server 2 â†’ External API: 100-150ms
- **Overhead: +100-150ms**

ÄÃ¢y lÃ  nguá»“n gá»‘c chÃ­nh lÃ m tÄƒng 200-300ms.[^4][^2]

### 3. **Request/Response Processing Latency**[^5][^6]

Server 2 pháº£i xá»­ lÃ½ 2 chiá»u:

**Request Processing**:[^5]

- Receive incoming request
- Parse headers \& body
- Authentication/authorization check
- Rate limiting check
- Request logging
- Transform/enrich request (náº¿u cÃ³)
- Forward to external API
- **Typical: 20-100ms**[^6][^5]

**Response Processing**:[^5]

- Receive from external API
- Parse response
- Response transformation
- Response logging
- Error handling/retry logic
- Send back to client
- **Typical: 20-80ms**[^6][^5]

**Total overhead: 40-180ms** tá»« viá»‡c xá»­ lÃ½ thuáº§n tÃºy.[^5]

### 4. **Protocol Overhead**[^2]

**HTTP header processing**:

- Parse incoming HTTP request: 5-15ms
- Construct new HTTP request to external API: 5-10ms
- Parse external API response: 5-15ms
- Construct response to client: 5-10ms
- **Total: 20-50ms**

Náº¿u dÃ¹ng HTTP/1.1 thÃ¬ overhead nhiá»u hÆ¡n HTTP/2.[^2]

### 5. **Connection Management**[^3][^2]

Náº¿u Server 2 **khÃ´ng reuse connection** Ä‘áº¿n external API:

```python
# CÃ¡ch SAI (má»—i láº§n táº¡o má»›i)
async def proxy_request(data):
    async with aiohttp.ClientSession() as session:  # Táº¡o má»›i má»—i láº§n!
        async with session.post(external_api_url, json=data) as resp:
            return await resp.json()
```

â†’ Má»—i request pháº£i:

- Táº¡o má»›i TCP socket: 10-30ms
- TCP handshake: 50ms
- TLS handshake: 100ms
- **Overhead: +160-180ms**

**CÃ¡ch ÄÃšNG** (reuse nhÆ° code cá»§a báº¡n):

```python
# Global session
self._session = aiohttp.ClientSession()

async def proxy_request(data):
    async with self._session.post(external_api_url, json=data) as resp:
        return await resp.json()
```

â†’ Chá»‰ handshake láº§n Ä‘áº§u, cÃ¡c láº§n sau reuse connection.[^7][^8]

### 6. **Server Load \& Queuing**[^9][^2]

Náº¿u Server 2 Ä‘ang xá»­ lÃ½ nhiá»u request Ä‘á»“ng thá»i:

- Request pháº£i chá» trong queue
- CPU/Memory contention
- Thread pool exhaustion (náº¿u dÃ¹ng sync framework)
- **CÃ³ thá»ƒ thÃªm: 50-500ms** tÃ¹y load[^9][^2]


### 7. **Encryption/Decryption Overhead**[^2]

Náº¿u Server 2 pháº£i:

- Decrypt request tá»« client: 5-20ms
- Encrypt request Ä‘áº¿n external API: 5-20ms
- Decrypt response tá»« external API: 5-20ms
- Encrypt response Ä‘áº¿n client: 5-20ms
- **Total: 20-80ms**


### 8. **Middleware Stack**[^3]

Náº¿u Server 2 cÃ³ middleware layers:

```
Request â†’ CORS â†’ Auth â†’ Rate Limit â†’ Logging â†’ Transform â†’ Proxy
```

Má»—i middleware thÃªm **5-30ms**:[^3]

- 6 middleware Ã— 15ms = 90ms overhead


## Báº£ng so sÃ¡nh chi tiáº¿t

| Component | Direct (300ms) | Via Server 2 (1000ms) | Added Overhead |
| :-- | :-- | :-- | :-- |
| DNS Resolution | 10ms | 20ms (2Ã—) | +10ms |
| TCP Handshakes | 50ms | 100ms (2Ã—) | +50ms |
| TLS Handshakes | 100ms | 200-250ms (2Ã—) | +100-150ms |
| Network RTT | 150ms | 300ms (2Ã—) | +150ms |
| Request Processing | 0ms | 40-100ms | +40-100ms |
| Response Processing | 0ms | 30-80ms | +30-80ms |
| Middleware | 0ms | 30-90ms | +30-90ms |
| External API | 100ms | 100ms | 0ms |
| **TOTAL** | **~300ms** | **~850-1150ms** | **+550-850ms** |


<div align="center">â‚</div>

[^1]: https://radiocrafts.com/docs/riim/riim_user_manual/riim/network_performance.html

[^2]: https://sites.google.com/view/understanding-proxy-latency-ov/home

[^3]: https://odown.com/blog/api-latency/

[^4]: https://stackoverflow.com/questions/41052158/is-significant-latency-introduced-by-api-gateway

[^5]: https://docs.apigee.com/api-platform/analytics/latency-analysis-dashboard

[^6]: https://docs.cloud.google.com/apigee/docs/api-platform/analytics/latency-analysis-dashboard

[^7]: https://last9.io/blog/api-latency/

[^8]: https://dev.to/rabindratamang/how-to-reduce-api-latency-and-improve-performance-in-high-traffic-applications-222c

[^9]: https://discuss.google.dev/t/apigee-proxy-latency-or-overhead/105267

[^10]: https://huhshal.substack.com/p/why-your-api-is-fast-on-localhost

[^11]: https://blog.dreamfactory.com/ultimate-guide-to-api-latency-and-throughput

[^12]: https://api7.ai/blog/what-is-an-api-proxy

[^13]: https://dev.to/apisix/will-slow-requests-in-api-gateway-affect-other-requests-13kb

[^14]: https://stackoverflow.com/questions/7237601/computing-network-distance-between-two-hosts




---

# ğŸ“Š Technical Report: IPA Phoneme API Optimization

  

## Executive Summary

  

BÃ¡o cÃ¡o nÃ y trÃ¬nh bÃ y quÃ¡ trÃ¬nh phÃ¢n tÃ­ch vÃ  tá»‘i Æ°u hÃ³a API chuyá»ƒn Ä‘á»•i vÄƒn báº£n sang IPA (International Phonetic Alphabet) cho dá»± Ã¡n PIKA Robot. Káº¿t quáº£ Ä‘áº¡t Ä‘Æ°á»£c lÃ  giáº£m response time tá»« **~1000ms xuá»‘ng cÃ²n <50ms** (cáº£i thiá»‡n Â **20x** ), Ä‘á»“ng thá»i loáº¡i bá» hoÃ n toÃ n sá»± phá»¥ thuá»™c vÃ o API bÃªn ngoÃ i.

  

---

  

## 1. PhÃ¢n TÃ­ch Kiáº¿n TrÃºc CÅ© (External API)

  

### 1.1 Architecture Overview

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Client Â  Â â”‚â”€â”€â”€â”€â–¶â”‚ PIKA Server â”‚â”€â”€â”€â”€â–¶â”‚ External API Â  Â  Â  Â â”‚

â”‚ Â (Robot) Â  Â â”‚ Â  Â  â”‚ Â (Python) Â  â”‚ Â  Â  â”‚ api2.unalengua.com Â â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

Â  Â  Â  â”‚ Â  Â ~50ms Â  Â  Â  Â  Â  â”‚ Â  Â  Â ~300ms Â  Â  Â  Â  Â â”‚

Â  Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Total: ~350-400ms per request

```

  

### 1.2 Code Analysis (`ckp.py`)

  

```python

class ToolPhoneme:

Â  Â  def __init__(self, **kwargs):

Â  Â  Â  Â  self.url = os.getenv("PHONEME_URL") Â # External API endpoint

Â  Â  Â  Â  self.timeout = 5

Â  Â  Â  Â  self._phoneme_cache = {} Â # Sentence-level cache

Â  Â  Â  Â  self.cache_ttl_seconds = 7 * 24 * 60 * 60 Â # 7 days

Â  Â  Â  Â  self._session = None

  

Â  Â  async def process(self, text, lang="en-US", mode=True):

Â  Â  Â  Â  session = await self._get_session()

Â  Â  Â  Â  payload = {"text": text, "lang": lang, "mode": mode}

Â  Â  Â  Â  async with session.post(self.url, json=payload) as response:

Â  Â  Â  Â  Â  Â  return await response.json()

```

  

### 1.3 Performance Issues Identified

  

| Issue Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  | Impact Â  Â  Â  Â  Â  Â  Â  Â  Â  Â | Root Cause Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |

| ------------------------------- | ------------------------- | ----------------------------------------------- |

| **Network Latency** Â  Â  Â  | ~300ms/request Â  Â  Â  Â  Â  Â | External API call qua internet Â  Â  Â  Â  Â  Â  Â  Â  Â |

| **Connection Overhead** Â  | ~50ms/request Â  Â  Â  Â  Â  Â  | TLS handshake, TCP setup Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |

| **No Word-level Cache** Â  | Duplicate processing Â  Â  Â | Cache theo sentence, khÃ´ng theo word Â  Â  Â  Â  Â  |

| **Sequential Dependency** | 2x latency cho similarity | Pháº£i chá» API response trÆ°á»›c khi tÃ­nh toÃ¡n |

  

### 1.4 Real-world Performance Measurement

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â LATENCY BREAKDOWN Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â phoneme_similarity("hello", "helo") Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”œâ”€ Request 1: "hello" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 300-350ms Â  Â â”‚

â”‚ Â â”‚ Â  â””â”€ Network: 280ms + API processing: 20-70ms Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ Request 2: "helo" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ 300-350ms Â  Â â”‚

â”‚ Â â”‚ Â  â””â”€ Network: 280ms + API processing: 20-70ms Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ Levenshtein calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ <1ms Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â””â”€ TOTAL (parallel) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ~400-500ms Â  â”‚

â”‚ Â  Â  TOTAL (sequential) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ ~700-1000ms Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

**Observed in Production:**

  

* Average response time: **800-1200ms**

* P95 response time: **1500ms+**

* Timeout rate: **2-5%** (khi API bÃªn ngoÃ i cháº­m hoáº·c down)

  

---

  

## 2. Benchmark: So SÃ¡nh CÃ¡c ThÆ° Viá»‡n G2P

  

### 2.1 Test Environment

  

```yaml

Environment:

Â  OS: Ubuntu 24.04 LTS

Â  Python: 3.11

Â  CPU: 2 vCPU

Â  Memory: 4GB RAM

Libraries Tested:

Â  - phonemizer (espeak-ng backend): v3.3.0

Â  - gruut: v2.4.0

Â  - g2p_en: v2.1.0 (khÃ´ng kháº£ dá»¥ng do NLTK dependency)

```

  

### 2.2 Benchmark Results

  

#### 2.2.1 Raw Backend Performance (No Cache)

  

| Backend Â  Â  Â  Â  Â  Â  | Min Â  Â | Avg Â  Â | Max Â  | Std Dev | Notes Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â |

| ------------------- | ------ | ------ | ----- | ------- | -------------------------- |

| **espeak-ng** | 205ms Â | 228ms Â | 305ms | 25ms Â  Â | Subprocess spawn má»—i call |

| **gruut** Â  Â  | 0.35ms | 1.06ms | 2.5ms | 0.42ms Â | In-process, pre-loaded Â  Â  |

  

**Speedup: gruut nhanh hÆ¡n espeak ~215x**

  

#### 2.2.2 Detailed Benchmark by Input Length

  

```

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

â•‘ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â BENCHMARK RESULTS BY INPUT Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ Input Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ espeak Â  Â â”‚ gruut Â  Â  â”‚ Speedup Â  â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ "hello" (1 word) Â  Â  Â  Â  Â  Â  Â  â”‚ 231.80ms Â â”‚ 0.44ms Â  Â â”‚ 527x Â  Â  Â â•‘

â•‘ "it is are you cuong" (5 word) â”‚ 219.47ms Â â”‚ 0.84ms Â  Â â”‚ 261x Â  Â  Â â•‘

â•‘ "The quick brown fox..." (9w) Â â”‚ 214.02ms Â â”‚ 1.33ms Â  Â â”‚ 161x Â  Â  Â â•‘

â•‘ Long paragraph (55 words) Â  Â  Â â”‚ 227.34ms Â â”‚ 1.64ms Â  Â â”‚ 139x Â  Â  Â â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ AVERAGE Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ 228.66ms Â â”‚ 1.06ms Â  Â â”‚ 215x Â  Â  Â â•‘

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```

  

#### 2.2.3 Cache Effectiveness Test

  

```

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

â•‘ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â CACHE EFFECTIVENESS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ Scenario Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚ Cold Â  Â  Â â”‚ Warm (Cached)â”‚ Speedupâ•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ espeak (no cache) Â  Â  Â  Â  Â  Â  Â â”‚ 236.85ms Â â”‚ 227.02ms Â  Â â”‚ 1.0x Â  â•‘

â•‘ espeak + word cache Â  Â  Â  Â  Â  Â â”‚ 1993.17ms â”‚ 0.00ms Â  Â  Â â”‚ âˆ Â  Â  Â â•‘

â•‘ espeak + sentence cache Â  Â  Â  Â â”‚ 203.50ms Â â”‚ 0.00ms Â  Â  Â â”‚ âˆ Â  Â  Â â•‘

â•‘ gruut + word cache Â  Â  Â  Â  Â  Â  â”‚ 17.45ms Â  â”‚ 0.00ms Â  Â  Â â”‚ âˆ Â  Â  Â â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ RECOMMENDATION: gruut + word-level cache Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â•‘

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```

  

### 2.3 Why espeak-ng is Slow

  

```

espeak-ng via phonemizer Flow:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â Python Process Â  Â  Â  Â  Â  Â  Â  Â  Â  Â espeak-ng subprocess Â  Â  Â  Â  â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  Â  Â  Â  Â  Â  Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ phonemize() â”‚â”€â”€fork()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ espeak-ng Â  Â  Â  â”‚ Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚ process Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  â”‚â—€â”€â”€pipeâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (loads libs) Â  Â â”‚ Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â  stdout Â  Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  Â  Â  Â  Â  Â  Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  Â  Â  Â â”‚ ~200ms overhead Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  Â  Â  Â â”‚ (subprocess spawn + load) Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  Â  Â  Â â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  [Parse output] Â  Â  Â  Â  Â  Â  Â  Â  Â  Â [Exit process] Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  

gruut Flow:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â Python Process (single) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ gruut_sentences() Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â â””â”€ Pre-loaded lexicon (memory) Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â â””â”€ Pre-loaded rules (memory) Â  Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”‚ Â â””â”€ Direct function call (~1ms) Â  Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

---

  

## 3. Kiáº¿n TrÃºc Má»›i (Local Processing)

  

### 3.1 Architecture Overview

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Client Â  Â â”‚â”€â”€â”€â”€â–¶â”‚ Â  Â  Â  Â  Â  Â  Â PIKA Server Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â (Robot) Â  Â â”‚ Â  Â  â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  â”‚ Â â”‚ Â  Â  Â  Â  Â  ToolPhoneme Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ Â â”‚ PhonemeCache â”‚ Â â”‚ GruutBackend Â  Â â”‚ Â â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ Â â”‚ (word-level) â”‚ Â â”‚ (in-process) Â  Â â”‚ Â â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ Â â”‚ Â  50K words Â â”‚ Â â”‚ Â  Â  Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â â”‚ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

Â  Â  Â  â”‚ Â  Â  Â  Â  <50ms total Â  Â  Â  Â  Â â”‚

Â  Â  Â  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

### 3.2 SOLID Design Principles Applied

  

```python

# tool_phoneme.py - Main Orchestrator (SRP: Single Responsibility)

  

class ToolPhoneme:

Â  Â  """

Â  Â  SOLID Principles Applied:

Â  Â  - SRP: Orchestrator only, delegates to specialized classes

Â  Â  - OCP: Easy to extend with new backends via BackendFactory

Â  Â  - LSP: Backend implementations are interchangeable

Â  Â  - ISP: Focused interfaces for each component

Â  Â  - DIP: Depends on abstractions, not concrete implementations

Â  Â  """

Â  Â  def __init__(self, backend="auto", cache_ttl_seconds=7*24*60*60, prewarm=True):

Â  Â  Â  Â  # DIP: Dependency on factory, not concrete backend

Â  Â  Â  Â  self.backend: PhonemeBackend = BackendFactory.create_backend(backend)

Â  Â  Â  Â  # DIP: Dependency on cache abstraction

Â  Â  Â  Â  self.cache = PhonemeCache(ttl_seconds=cache_ttl_seconds)

Â  Â  Â  Â  # DIP: Dependency on text processor abstraction

Â  Â  Â  Â  self.text_processor = PhonemeTextProcessor()

```

  

### 3.3 Component Architecture

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ToolPhoneme Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (Orchestrator) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

Â  Â  Â  Â  Â  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

Â  Â  Â  Â  Â  â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â  â–¼ Â  Â  Â  Â  Â  Â  Â  Â  Â  â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ BackendFactory Â â”‚ â”‚ Â PhonemeCache Â  â”‚ â”‚ PhonemeTextProcessor Â  Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  â”‚ â”‚ Â  Â  Â  Â  Â  Â  Â  Â  â”‚ â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ - create_backendâ”‚ â”‚ - get(word,lang)â”‚ â”‚ - split_words(text) Â  Â  â”‚

â”‚ - auto-select Â  â”‚ â”‚ - set(word,ipa) â”‚ â”‚ - tokenize_ipa(ipa) Â  Â  â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  â”‚ â”‚ - prewarm() Â  Â  â”‚ â”‚ - levenshtein_similarityâ”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Â  Â  Â  Â  Â â”‚

Â  Â  Â  Â  Â â–¼

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â PhonemeBackend (ABC) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  GruutBackend Â  Â  Â â”‚ Â  Â â”‚ Â  EspeakBackend Â  Â  â”‚ Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  (Primary) Â  Â  Â  Â  â”‚ Â  Â â”‚ Â  (Fallback) Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  ~1-5ms Â  Â  Â  Â  Â  Â â”‚ Â  Â â”‚ Â  ~230ms Â  Â  Â  Â  Â  Â â”‚ Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

### 3.4 Word-level Caching Strategy

  

```python

# utils_phoneme_cache.py

  

class PhonemeCache:

Â  Â  """

Â  Â  Word-level cache thay vÃ¬ sentence-level:

Â  Â  - Cache hit rate cao hÆ¡n (words Ä‘Æ°á»£c reuse nhiá»u)

Â  Â  - Memory efficient hÆ¡n

Â  Â  - Pre-warm Ä‘Æ°á»£c vá»›i common words

Â  Â  """

Â  Â  def __init__(self, ttl_seconds=7*24*60*60):

Â  Â  Â  Â  # Key: (word, lang) -> Value: (timestamp, ipa)

Â  Â  Â  Â  self._cache: Dict[Tuple[str, str], Tuple[float, str]] = {}

Â  Â  Â  Â  self.ttl_seconds = ttl_seconds

Â  Â  def prewarm(self, words: list, lang: str, converter_func):

Â  Â  Â  Â  """Pre-warm cache vá»›i common words khi startup"""

Â  Â  Â  Â  for word in words:

Â  Â  Â  Â  Â  Â  if self.get(word, lang) is None:

Â  Â  Â  Â  Â  Â  Â  Â  ipa = converter_func(word, lang)

Â  Â  Â  Â  Â  Â  Â  Â  self.set(word, lang, ipa)

```

  

**Cache Hit Rate Analysis:**

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  CACHE HIT RATE COMPARISON Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â Sentence-level cache (old): Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ "Hello, how are you?" â†’ MISS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ "Hello, how are you doing?" â†’ MISS (different sentence) Â  Â  â”‚

â”‚ Â â”œâ”€ "How are you?" â†’ MISS (different sentence) Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â””â”€ Hit rate: ~5-10% (chá»‰ exact match) Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â Word-level cache (new): Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ "Hello, how are you?" â†’ MISS (first time) Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  â””â”€ Cache: {hello, how, are, you} Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”œâ”€ "Hello, how are you doing?" â†’ 4 HITS + 1 MISS Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â”‚ Â  â””â”€ Cache: {hello, how, are, you, doing} Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Â â”œâ”€ "How are you?" â†’ 3 HITS Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â â””â”€ Hit rate: ~60-95% (vá»›i pre-warmed common words) Â  Â  Â  Â  Â  Â  â”‚

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

  

---

  

## 4. Production Performance Results

  

### 4.1 API Response Time Comparison

  

```

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—

â•‘ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â PERFORMANCE COMPARISON Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ Metric Â  Â  Â  Â  Â  Â  Â â”‚ Old (External) Â â”‚ New (Local) Â â”‚ Improvementâ•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ Avg Response Time Â  â”‚ 800-1200ms Â  Â  Â â”‚ <50ms Â  Â  Â  Â â”‚ 20-25x Â  Â  â•‘

â•‘ P95 Response Time Â  â”‚ 1500ms+ Â  Â  Â  Â  â”‚ <100ms Â  Â  Â  â”‚ 15x+ Â  Â  Â  â•‘

â•‘ P99 Response Time Â  â”‚ 3000ms+ Â  Â  Â  Â  â”‚ <150ms Â  Â  Â  â”‚ 20x+ Â  Â  Â  â•‘

â•‘ Timeout Rate Â  Â  Â  Â â”‚ 2-5% Â  Â  Â  Â  Â  Â â”‚ ~0% Â  Â  Â  Â  Â â”‚ âˆ Â  Â  Â  Â  Â â•‘

â•‘ Cache Hit (warm) Â  Â â”‚ N/A Â  Â  Â  Â  Â  Â  â”‚ 0.01-0.05ms Â â”‚ - Â  Â  Â  Â  Â â•‘

â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£

â•‘ phoneme_similarity()â”‚ ~1000ms Â  Â  Â  Â  â”‚ <100ms Â  Â  Â  â”‚ 10x+ Â  Â  Â  â•‘

â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

```

  

### 4.2 Actual Test Results

  

```bash

# Test 1: Common words (pre-warmed cache)

POST /ipav3 {"text": "hello how are you today"}

Response: {

Â  Â  "ipa": "hÉ›lËˆoÊŠ hËˆaÊŠ ËˆÉ‘É¹ jËˆu tÉ™dËˆeÉª",

Â  Â  "processing_time_ms": 27.56, Â  Â  # âœ… <50ms

Â  Â  "cache_info": {"hits": 4, "misses": 1}

}

  

# Test 2: Same sentence again (fully cached)

POST /ipav3 {"text": "hello how are you today"}

Response: {

Â  Â  "ipa": "hÉ›lËˆoÊŠ hËˆaÊŠ ËˆÉ‘É¹ jËˆu tÉ™dËˆeÉª",

Â  Â  "processing_time_ms": 0.024, Â  Â  # âœ… <1ms!

Â  Â  "cache_info": {"hits": 5, "misses": 0}

}

  

# Test 3: New sentence (mostly cached words)

POST /ipav3 {"text": "I want to learn English with the robot"}

Response: {

Â  Â  "ipa": "ËˆaÉª wËˆÉ”nt tÉ™ lËˆÉœËn ËˆÉªÅ‹É¡lÉªÊƒ wËˆÉªÎ¸ Ã°É™ É¹ËˆoÊŠbËŒÉ‘t",

Â  Â  "processing_time_ms": 49.82, Â  Â  # âœ… <50ms

Â  Â  "cache_info": {"hits": 12, "misses": 2}

}

  

# Test 4: Batch transcription (20 texts)

POST /ipav3/batch

Response: {

Â  Â  "count": 20,

Â  Â  "total_time_ms": 190.32,

Â  Â  "avg_time_ms": 9.52 Â  Â  Â  Â  Â  Â  Â # âœ… ~10ms per text

}

```

  

### 4.3 Memory Usage

  

```

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”

â”‚ Â  Â  Â  Â  Â  Â  Â  Â  Â  Â MEMORY FOOTPRINT Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ Component Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ Memory Usage Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ gruut models (pre-loaded) Â  Â  Â  Â â”‚ ~50-80MB Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ Word cache (10,000 words) Â  Â  Â  Â â”‚ ~5-10MB Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â”‚

â”‚ Word cache (50,000 words) Â  Â  Â  Â â”‚ ~25-50MB Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤

â”‚ TOTAL (typical) Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚ ~100MB Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â”‚ TOTAL (max cache) Â  Â  Â  Â  Â  Â  Â  Â â”‚ ~150MB Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â â”‚

â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  

Note: Vá»›i PIKA Robot vocabulary (~500-2000 unique words),

memory overhead chá»‰ ~60-100MB

```

  

---

  

## 5. Deployment Recommendations

  

### 5.1 Kubernetes Configuration

  

```yaml

# deployment.yaml

apiVersion: apps/v1

kind: Deployment

metadata:

Â  name: pika-phoneme-service

spec:

Â  replicas: 2

Â  template:

Â  Â  spec:

Â  Â  Â  containers:

Â  Â  Â  - name: phoneme

Â  Â  Â  Â  image: pika/phoneme-service:v3.0

Â  Â  Â  Â  resources:

Â  Â  Â  Â  Â  requests:

Â  Â  Â  Â  Â  Â  memory: "128Mi"

Â  Â  Â  Â  Â  Â  cpu: "100m"

Â  Â  Â  Â  Â  limits:

Â  Â  Â  Â  Â  Â  memory: "256Mi"

Â  Â  Â  Â  Â  Â  cpu: "500m"

Â  Â  Â  Â  readinessProbe:

Â  Â  Â  Â  Â  httpGet:

Â  Â  Â  Â  Â  Â  path: /health

Â  Â  Â  Â  Â  Â  port: 8000

Â  Â  Â  Â  Â  initialDelaySeconds: 10 Â # Allow cache warm-up

Â  Â  Â  Â  Â  periodSeconds: 5

Â  Â  Â  Â  startupProbe:

Â  Â  Â  Â  Â  httpGet:

Â  Â  Â  Â  Â  Â  path: /health

Â  Â  Â  Â  Â  Â  port: 8000

Â  Â  Â  Â  Â  initialDelaySeconds: 5

Â  Â  Â  Â  Â  periodSeconds: 2

Â  Â  Â  Â  Â  failureThreshold: 30 Â  Â  # 60s max for startup

```

  

### 5.2 Pre-warming Strategy

  

```python

# Recommended pre-warm vocabulary for PIKA Robot

  

PREWARM_WORDS = [

Â  Â  # Top 100 English words

Â  Â  "the", "be", "to", "of", "and", "a", "in", "that", "have", "i", ...

Â  Â  # Educational vocabulary

Â  Â  "hello", "goodbye", "please", "thank", "sorry", "yes", "no",

Â  Â  "robot", "learn", "english", "speak", "listen", "word", "letter",

Â  Â  # Numbers

Â  Â  "one", "two", "three", ... "ten", "hundred",

Â  Â  # Colors

Â  Â  "red", "blue", "green", "yellow", ...

Â  Â  # Animals

Â  Â  "cat", "dog", "bird", "fish", ...

Â  Â  # Lesson-specific vocabulary (load tá»« database)

]

```

  

### 5.3 Monitoring Metrics

  

```python

# Recommended Datadog metrics

  

# Response time histogram

@datadog.histogram('phoneme.response_time_ms')

  

# Cache metrics

@datadog.gauge('phoneme.cache_size')

@datadog.gauge('phoneme.cache_hit_rate')

  

# Error tracking

@datadog.increment('phoneme.errors', tags=['type:timeout'])

@datadog.increment('phoneme.errors', tags=['type:backend_error'])

```

  

---

  

## 6. Conclusion

  

### 6.1 Key Achievements

  

| Metric Â  Â  Â  Â  Â  Â  Â  Â | Before Â  | After Â  Â  | Improvement Â  Â  Â  Â  Â  Â  Â  Â  Â  |

| --------------------- | -------- | --------- | ----------------------------- |

| Response Time Â  Â  Â  Â  | ~1000ms Â | <50ms Â  Â  | **20x faster** Â  Â  Â  Â  Â |

| External Dependencies | 1 (API) Â | 0 Â  Â  Â  Â  | **100% self-contained** |

| Timeout Risk Â  Â  Â  Â  Â | 2-5% Â  Â  | ~0% Â  Â  Â  | **Eliminated** Â  Â  Â  Â  Â |

| Cache Efficiency Â  Â  Â | ~10% hit | ~80%+ hit | **8x better** Â  Â  Â  Â  Â  |

  

### 6.2 Architecture Benefits

  

1. **No External Dependencies** : KhÃ´ng cÃ²n phá»¥ thuá»™c vÃ o API bÃªn ngoÃ i

2. **Predictable Latency** : Response time á»•n Ä‘á»‹nh, khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi network

3. **High Cache Hit Rate** : Word-level caching cho hit rate cao hÆ¡n nhiá»u

4. **SOLID Design** : Dá»… maintain, extend, vÃ  test

5. **Production Ready** : Pre-warming, health checks, monitoring support

  

### 6.3 Files Structure

  

```

tools/

â”œâ”€â”€ tool_phoneme.py Â  Â  Â  Â  Â  # Main orchestrator

â”œâ”€â”€ utils_phoneme_backend.py Â # Backend interface + implementations

â”œâ”€â”€ utils_phoneme_cache.py Â  Â # Word-level cache manager

â””â”€â”€ utils_phoneme_text.py Â  Â  # Text processing utilities

```

  

---

  

Â **Author** : Claude AI Assistant

  

Â **Date** : December 2024

  

Â **Version** : 1.0

  

Â **Project** : PIKA Robot - English Learning Platform