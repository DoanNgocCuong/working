# Server Operations

## Chạy Server ở Background với nohup

### Cú pháp cơ bản

```bash
nohup python3 script.py > output.log 2>&1 &
```

### Giải thích từng phần:

- `nohup` = "no hang up" - Giữ cho tiến trình chạy ngay cả khi bạn đóng terminal
- `python3 script.py` = Chạy script Python
- `>` = Chuyển hướng output (stdout)
- `output.log` = File để lưu output
- `2>&1` = Chuyển hướng stderr (lỗi) vào cùng file với stdout
- `&` = Chạy ở background (không block terminal)

### Ví dụ thực tế

```bash
# Chạy với output và error riêng biệt
nohup python main.py --start_situation 10001 --end_situation 11000000956 --input_file "31082025_HocThu_Work.xlsx" --max_workers 20 --batch_size 1 > hocthu_work.log 2> err_hocthu_nonwork.log &

# Chạy với output và error gộp chung
nohup python main.py --start_situation 1 --end_situation 111000000956 --input_file "31082025_HocThu_Work.xlsx" --max_workers 20 --batch_size 1 > hocthu_work.log 2>&1 &
```

---

## Kiểm tra Port đang được sử dụng

### 1. Kiểm tra process đang dùng port

```bash
# Kiểm tra port (cần sudo nếu không có quyền)
sudo lsof -i :9403

# Lấy PID từ kết quả, sau đó kiểm tra thư mục làm việc
sudo ls -l /proc/<PID>/cwd
```

### 2. Tìm file docker-compose chứa port

```bash
find /path/to/project -name "docker-compose*.yml" -o -name "docker-compose*.yaml" -exec grep -l "9403" {} \;
```

### 3. Kiểm tra container Docker đang dùng port

```bash
# Liệt kê container đang chạy
docker ps

# Liệt kê tất cả container (kể cả đã stop)
docker ps -a

# Kiểm tra port của container cụ thể
docker inspect <container_id_or_name>
```

### 4. Tìm file chứa container name

```bash
# Tìm các file chứa tên container
grep -r "studio-ai-platform-lesson-server-master" /home/ubuntu/GenAIProject

# Xem logs của container
docker logs -f --tail 100 studio-ai-platform-lesson-server-master
```

---

## Serve Folder với Python HTTP Server

### Dùng Python tích hợp sẵn (cực nhanh, không cần cài gì thêm)

Nếu dùng Python 3.x, chỉ cần vào thư mục bạn muốn serve và chạy:

```bash
python3 -m http.server 8000
```

### Chạy ở background

```bash
nohup python3 -m http.server 30005 2>&1 &
```

---

## Gunicorn và Uvicorn

### 1. Cách run Python với Gunicorn và Uvicorn Worker

#### Chạy trực tiếp

```bash
WEB_CONCURRENCY=4 \
gunicorn app.server:app \
  -w 4 \
  -k uvicorn.workers.UvicornWorker \
  -b 0.0.0.0:8000 \
  --timeout 120 \
  --log-level info
```

- `-w 4` (hoặc `WEB_CONCURRENCY=4`) đặt 4 worker process.
- `-k uvicorn.workers.UvicornWorker` để Gunicorn dùng event loop của Uvicorn cho FastAPI.
- Điều chỉnh `--timeout`, `--log-level`, `-b` theo nhu cầu.

#### Dùng file config (gunicorn.conf.py)

```python
# gunicorn.conf.py
bind = "0.0.0.0:8000"
workers = 6              # số worker mong muốn
worker_class = "uvicorn.workers.UvicornWorker"
timeout = 120
graceful_timeout = 30
loglevel = "info"
```

Chạy với config file:

```bash
gunicorn app.server:app -c gunicorn.conf.py
```

**Lưu ý**: Thường đặt `workers = 2 * CPU + 1` rồi đo thực tế để tinh chỉnh.

---

### 2. Cách chạy với Docker/Docker Compose

#### Option 1: Dùng worker của Uvicorn (dễ nhất)

Sửa `CMD` trong `Dockerfile` thành:

```dockerfile
CMD ["python", "-m", "uvicorn", "app.server:app", "--host", "0.0.0.0", "--port", "30000", "--workers", "4"]
```

- Thay `4` bằng số worker bạn muốn.
- Sau đó `docker compose -f deploy/docker-compose.prod.yaml up --build` để build lại.

#### Option 2: Chuyển sang Gunicorn + UvicornWorker (production chuẩn hơn)

Thay `CMD` trong `Dockerfile` thành:

```dockerfile
CMD ["gunicorn", "app.server:app", "-k", "uvicorn.workers.UvicornWorker", "-w", "4", "-b", "0.0.0.0:30000"]
```

- Ở đây `-w 4` là số worker.
- Nhớ đảm bảo trong image đã `pip install gunicorn uvicorn`.

