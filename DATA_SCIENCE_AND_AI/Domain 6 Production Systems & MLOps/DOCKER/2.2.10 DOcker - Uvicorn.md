R·ªìi, m√¨nh gi·∫£i th√≠ch step-by-step nh√© üöÄ

---

## 1. FastAPI b·∫£n ch·∫•t ch·ªâ l√† framework

FastAPI **kh√¥ng t·ª± qu·∫£n l√Ω worker**. Khi b·∫°n ch·∫°y `uvicorn main:app`, m·∫∑c ƒë·ªãnh ch·ªâ c√≥ **1 process**, t·ª©c 1 worker. N·∫øu mu·ªën scale nhi·ªÅu worker (t·∫≠n d·ª•ng nhi·ªÅu CPU core), b·∫°n c·∫ßn th√™m m·ªôt process manager nh∆∞ **Gunicorn** ho·∫∑c **Uvicorn v·ªõi --workers**.

---

## 2. Ch·∫°y nhi·ªÅu worker v·ªõi Uvicorn tr·ª±c ti·∫øp

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

- `--workers 4`: ch·∫°y 4 worker process song song.
    
- M·ªói worker l√† 1 process ri√™ng ‚Üí t·∫≠n d·ª•ng ƒëa core CPU.
    

L∆∞u √Ω: **worker > s·ªë core c≈©ng kh√¥ng c√≥ l·ª£i**, n√™n th∆∞·ªùng l·∫•y b·∫±ng s·ªë core ho·∫∑c g·∫•p ƒë√¥i (tu·ª≥ workload I/O hay CPU-bound).

---

																																																																																																																																																				## 3. D√πng Gunicorn + UvicornWorker (khuy√™n d√πng khi deploy)

```bash
gunicorn -k uvicorn.workers.UvicornWorker main:app -w 4 -b 0.0.0.0:8000
```

- `-w 4`: s·ªë worker process.
    
- Gunicorn qu·∫£n l√Ω worker, t·ª± restart khi crash, log chu·∫©n h∆°n.
    
- ƒê√¢y l√† setup ph·ªï bi·∫øn khi ch·∫°y production (Docker, server).
    

---

## 4. Worker vs Async

FastAPI b·∫£n ch·∫•t async, n√™n:

- M·ªôt worker **c√≥ th·ªÉ x·ª≠ l√Ω nhi·ªÅu request ƒë·ªìng th·ªùi** (nh·ªù async I/O).
    
- Nh∆∞ng CPU-bound task (t√≠nh to√°n n·∫∑ng) s·∫Ω block event loop ‚Üí nhi·ªÅu worker gi√∫p x·ª≠ l√Ω song song.
    

üëâ N·∫øu b·∫°n c√≥ CPU task n·∫∑ng ‚Üí n√™n th√™m **task queue** (Celery, RQ) ƒë·ªÉ t√°ch kh·ªèi web worker.

---

## 5. L∆∞u √Ω khi scale nhi·ªÅu worker

- **Kh√¥ng d√πng bi·∫øn global ƒë·ªÉ l∆∞u state** (vd: dict, list). V√¨ m·ªói worker l√† 1 process, kh√¥ng share memory. D√πng DB/Redis n·∫øu mu·ªën share state.
    
- Ki·ªÉm tra connection pool (Postgres, Redis, ‚Ä¶) ‚Üí m·ªói worker c·∫ßn pool ri√™ng, tr√°nh tr√†n k·∫øt n·ªëi.
    
- Load balancer/nginx/nginx ingress (khi Docker/K8s) th∆∞·ªùng ƒë·∫∑t tr∆∞·ªõc ƒë·ªÉ ph√¢n ph·ªëi traffic.
    

---

üëâ T√≥m l·∫°i:

- Dev/test: `uvicorn main:app --workers N`.
    
- Prod: `gunicorn -k uvicorn.workers.UvicornWorker main:app -w N`.
    
- N·∫øu workload n·∫∑ng CPU, c√¢n nh·∫Øc th√™m task queue.
    

---

B·∫°n c√≥ mu·ªën m√¨nh vi·∫øt lu√¥n **Dockerfile + CMD ch·∫°y Gunicorn-Uvicorn nhi·ªÅu worker** ƒë·ªÉ deploy production cho b·∫°n kh√¥ng?


---
B·∫°n copy l·∫°i ƒëo·∫°n m√¨nh gi·∫£i th√≠ch v·ª• **FastAPI nhi·ªÅu worker** üëç.  
M√¨nh ƒëo√°n l√† b·∫°n mu·ªën h·ªèi ti·∫øp: ‚ÄúDockerfile + CMD ch·∫°y Gunicorn‚ÄìUvicorn nhi·ªÅu worker trong production th√¨ vi·∫øt sao?‚Äù

M√¨nh vi·∫øt m·∫´u lu√¥n nh√©:

---

## üìÑ Dockerfile (v√≠ d·ª• chu·∫©n)

```dockerfile
FROM python:3.11-slim

# C√†i dependencies
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy source
COPY . .

# Expose port
EXPOSE 8000

# CMD ch·∫°y Gunicorn + UvicornWorker
CMD ["gunicorn", "-k", "uvicorn.workers.UvicornWorker", "main:app", \
     "-w", "4", "-b", "0.0.0.0:8000"]
```

---

## üê≥ Ch·∫°y Docker container

```bash
docker build -t my-fastapi-app .
docker run -p 8000:8000 my-fastapi-app
```

---

## üîß L∆∞u √Ω t·ªëi ∆∞u

- `-w 4`: s·ªë worker = th∆∞·ªùng l·∫•y **s·ªë core CPU** (ho·∫∑c x2 n·∫øu workload I/O-bound).
    
- C√≥ th·ªÉ th√™m `--timeout 60` (default 30s) n·∫øu API x·ª≠ l√Ω l√¢u.
    
- N·∫øu mu·ªën **reload khi dev**, c√≥ th·ªÉ ch·∫°y:
    
    ```bash
    uvicorn main:app --reload --host 0.0.0.0 --port 8000
    ```
    
- V·ªõi K8s ho·∫∑c Docker Swarm, b·∫°n c√≥ th·ªÉ scale th√™m **replica** thay v√¨ tƒÉng worker trong 1 container.
    

---

B·∫°n c√≥ mu·ªën m√¨nh vi·∫øt th√™m **docker-compose.yml** m·∫´u (c√≥ Postgres/Redis k√®m FastAPI) ƒë·ªÉ b·∫°n test local lu√¥n kh√¥ng?



---
<img src="https://r2cdn.perplexity.ai/pplx-full-logo-primary-dark%402x.png" style="height:64px;margin-right:32px"/>

# Gunicorn v·ªõi Uvicorn ?

Gunicorn + UvicornWorker l√† setup ‚ÄúGunicorn l√†m **process manager**‚Äù v√† m·ªói worker l√† m·ªôt process ch·∫°y **Uvicorn (ASGI server)** ƒë·ªÉ ph·ª•c v·ª• FastAPI/Starlette.[^1][^2]

## Khi n√†o d√πng Gunicorn v·ªõi Uvicorn?

- D√πng khi mu·ªën ch·∫°y **nhi·ªÅu process** ƒë·ªÉ t·∫≠n d·ª•ng ƒëa core v√† c√≥ c∆° ch·∫ø qu·∫£n l√Ω worker (restart/replace worker) ‚Äúchu·∫©n b√†i‚Äù theo ki·ªÉu Gunicorn.[^1]
- Uvicorn c√≥ th·ªÉ t·ª± ch·∫°y nhi·ªÅu workers, nh∆∞ng docs Uvicorn v·∫´n n√™u c√°ch ch·∫°y d∆∞·ªõi Gunicorn nh∆∞ m·ªôt l·ª±a ch·ªçn deployment ph·ªï bi·∫øn cho production.[^2][^1]


## L·ªánh ch·∫°y chu·∫©n

```bash
gunicorn app.main_app:app \
  -k uvicorn.workers.UvicornWorker \
  -w 4 \
  --bind 0.0.0.0:30020
```

Uvicorn docs ƒë∆∞a ƒë√∫ng m·∫´u `gunicorn -w 4 -k uvicorn.workers.UvicornWorker` ƒë·ªÉ ch·∫°y ASGI app v·ªõi nhi·ªÅu worker process.[^1]

## C√°c timeout quan tr·ªçng ·ªü Gunicorn (kh√°c Uvicorn)

- `--timeout`: n·∫øu worker ‚Äúim l·∫∑ng‚Äù qu√° l√¢u (th∆∞·ªùng do request treo), Gunicorn s·∫Ω kill/restart worker ƒë√≥ ƒë·ªÉ tr√°nh treo vƒ©nh vi·ªÖn. (√ù nghƒ©a th·ª±c chi·∫øn: *anti-hang*).[^3]
- `--graceful-timeout`: khi restart/shutdown, Gunicorn cho worker m·ªôt kho·∫£ng th·ªùi gian ƒë·ªÉ x·ª≠ l√Ω n·ªët tr∆∞·ªõc khi b·ªã kill m·∫°nh tay.[^4]


## ƒêi·ªÉm c·∫ßn ph√¢n bi·ªát (hay b·ªã nh·∫ßm)

- `uvicorn --timeout-keep-alive` ch·ªß y·∫øu l√† timeout cho **HTTP keep-alive idle** (gi·ªØa c√°c request), kh√¥ng ph·∫£i ‚Äúrequest processing timeout‚Äù.[^5]
- ‚ÄúRequest ch·∫°y DB query 5 ph√∫t‚Äù th∆∞·ªùng c·∫ßn ki·ªÉm so√°t b·∫±ng **DB statement_timeout / app-level timeout** ho·∫∑c d√πng Gunicorn `--timeout` ƒë·ªÉ tr√°nh worker treo m√£i.[^3]


## G·ª£i √Ω c·∫•u h√¨nh t·ªëi thi·ªÉu (th·ª±c t·∫ø)

```bash
gunicorn app.main_app:app \
  -k uvicorn.workers.UvicornWorker \
  -w 4 \
  --bind 0.0.0.0:30020 \
  --timeout 60 \
  --graceful-timeout 10
```

`--timeout` v√† `--graceful-timeout` l√† 2 tham s·ªë Gunicorn ƒë∆∞·ª£c m√¥ t·∫£ r√µ trong docs settings.[^4][^3]

B·∫°n ƒëang ch·∫°y service tr√™n m√°y m·∫•y vCPU v√† traffic c√≥ peak job ban ƒë√™m kh√¥ng? (s·ªë vCPU quy·∫øt ƒë·ªãnh s·ªë `-w` h·ª£p l√Ω).
<span style="display:none">[^10][^11][^12][^13][^14][^15][^16][^17][^18][^19][^20][^21][^6][^7][^8][^9]</span>

<div align="center">‚ÅÇ</div>

[^1]: https://www.uvicorn.org/deployment/

[^2]: https://fastapi.tiangolo.com/deployment/server-workers/

[^3]: https://betterstack.com/community/guides/scaling-python/gunicorn-explained/

[^4]: https://docs.gunicorn.org/en/20.x/settings.html

[^5]: https://www.uvicorn.org/settings/

[^6]: https://fastapi.xiniushu.com/sv/deployment/server-workers/

[^7]: https://github.com/Kludex/uvicorn-worker

[^8]: https://pypi.org/project/uvicorn-worker/

[^9]: https://www.reddit.com/r/Python/comments/1jikgd2/gunicorn_for_production/

[^10]: https://www.reddit.com/r/Python/comments/l1n4ea/what_do_gunicorn_workers_offer_over_uvicorn/

[^11]: https://github.com/fastapi/fastapi/issues/2501

[^12]: https://github.com/benoitc/gunicorn/issues/1493

[^13]: https://stackoverflow.com/questions/72296398/how-to-specify-uvicorn-workers-in-gunicorn-conf-file

[^14]: https://render.com/articles/fastapi-production-deployment-best-practices

[^15]: https://stackoverflow.com/questions/74206034/how-do-uvicorn-workers-work-and-how-many-do-i-need-for-a-slim-machine

[^16]: https://sentry.io/answers/number-of-uvicorn-workers-needed-in-production/

[^17]: https://github.com/benoitc/gunicorn/issues/2297

[^18]: https://www.reddit.com/r/django/comments/1hj9seo/gunicorn_vs_gunicorn_with_uvicorn_workers/

[^19]: https://stackoverflow.com/questions/72374634/how-many-uvicorn-workers-do-i-have-to-have-in-production

[^20]: https://bleepingcoder.com/gunicorn/218871310/clarify-what-how-timeout-and-graceful-timeout-work

[^21]: https://www.geeksforgeeks.org/python/fast-api-gunicorn-vs-uvicorn/

