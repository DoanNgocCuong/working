
# BƯỚC 1: PRE-DEPLOYMENT (30 phút)

## 1.1 Kiểm tra prerequisites
- Docker Desktop/Server: `docker --version` (>= 20.10)
- Docker Compose: `docker-compose --version` (>= 1.29)
- Git: `git --version`
- OpenAI API key: lấy từ https://platform.openai.com/api-keys
- Server: Ubuntu 22.04+ hoặc Ubuntu 20.04+ (recommend: t3.large on AWS = 2 vCPU, 8GB RAM)

## 1.2 Clone Mem0 repo
```bash
git clone https://github.com/mem0ai/mem0.git
cd mem0/server
```

---

# BƯỚC 2: ENVIRONMENT SETUP (10 phút)

## 2.1 Tạo .env file
```bash
# Copy from template
cp .env.example .env

# Edit .env
nano .env
# HOẶC
vi .env
```

## 2.2 Content của .env (để vào file)
```
# LLM Configuration
OPENAI_API_KEY=sk-your-actual-key-here

# Database Configuration (Postgres)
DATABASE_URL=postgresql://mem0_user:mem0_password@postgres:5432/mem0_db
POSTGRES_USER=mem0_user
POSTGRES_PASSWORD=mem0_password
POSTGRES_DB=mem0_db

# Vector Database (Qdrant)
QDRANT_URL=http://qdrant:6333
QDRANT_API_KEY=your-qdrant-api-key-optional

# Graph Database (Neo4j) - OPTIONAL
NEO4J_URL=neo4j://neo4j:7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=neo4j_password

# API Server
API_HOST=0.0.0.0
API_PORT=8000

# Other
LOG_LEVEL=info
ENVIRONMENT=production
```

**Lưu ý:** Sau này tạo secret management (AWS Secrets Manager / HashiCorp Vault), đừng commit .env vào Git

---

# BƯỚC 3: DOCKER COMPOSE (15 phút)

## 3.1 Docker Compose file (server/docker-compose.yml)

Save file này:

```yaml
version: '3.8'

services:
  # FastAPI Server - API endpoint
  api:
    image: mem0/mem0-api-server:latest
    container_name: mem0-api
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - DATABASE_URL=${DATABASE_URL}
      - QDRANT_URL=${QDRANT_URL}
      - NEO4J_URL=${NEO4J_URL}
      - NEO4J_USERNAME=${NEO4J_USERNAME}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - LOG_LEVEL=${LOG_LEVEL}
    depends_on:
      - postgres
      - qdrant
      - neo4j
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - mem0-network

  # PostgreSQL - Metadata & relationships
  postgres:
    image: postgres:16-alpine
    container_name: mem0-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - mem0-network

  # Qdrant - Vector Database
  qdrant:
    image: qdrant/qdrant:latest
    container_name: mem0-qdrant
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mem0-network

  # Neo4j - Graph Database (Optional nhưng recommended)
  neo4j:
    image: neo4j:5.15-enterprise
    container_name: mem0-neo4j
    environment:
      NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
      NEO4JLABS_PLUGINS: '["apoc"]'
      NEO4J_PLUGINS: '["apoc"]'
    ports:
      - "7687:7687"  # Bolt
      - "7474:7474"  # HTTP UI (localhost:7474)
    volumes:
      - neo4j_data:/var/lib/neo4j/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u neo4j -p ${NEO4J_PASSWORD} 'RETURN 1' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - mem0-network

  # Optional: pgAdmin - Database browser
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: mem0-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - postgres
    networks:
      - mem0-network

volumes:
  postgres_data:
  qdrant_data:
  neo4j_data:

networks:
  mem0-network:
    driver: bridge
```

## 3.2 Chạy Docker Compose
```bash
# Check config
docker-compose config

# Start services (detached mode)
docker-compose up -d

# Check status
docker-compose ps
docker-compose logs -f api

# Check individual service
docker-compose logs postgres
docker-compose logs qdrant
docker-compose logs neo4j
```

---

# BƯỚC 4: VERIFY DEPLOYMENT (10 phút)

## 4.1 Test API Health
```bash
curl http://localhost:8000/health
# Expected: {"status": "ok"}
```

## 4.2 Test Database connections
```bash
# Postgres
psql -h localhost -U mem0_user -d mem0_db -c "SELECT version();"

# Qdrant
curl http://localhost:6333/health

# Neo4j
curl -u neo4j:neo4j_password http://localhost:7687/
```

## 4.3 Test Mem0 API - Add Memory
```bash
curl -X POST http://localhost:8000/memories   -H "Content-Type: application/json"   -d '{
    "user_id": "user123",
    "message": "I like Python and Docker",
    "timestamp": "2025-12-11T10:00:00Z"
  }'
```

## 4.4 Test Mem0 API - Search Memory
```bash
curl -X GET "http://localhost:8000/memories/search?user_id=user123&query=python"
```

---

# BƯỚC 5: PRODUCTION HARDENING (30 phút)

## 5.1 Nginx Reverse Proxy (HTTPS, rate limiting)
```nginx
# File: /etc/nginx/sites-available/mem0.conf

upstream mem0_api {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name api.mem0.yourdomain.com;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.mem0.yourdomain.com;

    ssl_certificate /etc/letsencrypt/live/api.mem0.yourdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.mem0.yourdomain.com/privkey.pem;

    client_max_body_size 10M;

    # Rate limiting
    limit_req_zone \$binary_remote_addr zone=api_limit:10m rate=100r/s;
    limit_req zone=api_limit burst=200 nodelay;

    location / {
        proxy_pass http://mem0_api;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    location /health {
        access_log off;
        proxy_pass http://mem0_api;
    }
}
```

## 5.2 Secrets Management
```bash
# Use AWS Secrets Manager hoặc Vault thay vì .env
# Example AWS:
aws secretsmanager get-secret-value --secret-id mem0/prod --region us-east-1

# Inject vào container:
docker-compose -f docker-compose.prod.yml up -d
```

## 5.3 Database Backups (Daily)
```bash
# File: /usr/local/bin/backup-mem0.sh
#!/bin/bash

BACKUP_DIR="/mnt/backups/mem0"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Postgres backup
docker exec mem0-postgres pg_dump -U mem0_user mem0_db | gzip > \$BACKUP_DIR/postgres_\$TIMESTAMP.sql.gz

# Qdrant backup (snapshot)
curl -X POST http://localhost:6333/snapshots   -H "Content-Type: application/json"   -d '{}' | jq '.result.snapshot_description' > \$BACKUP_DIR/qdrant_\$TIMESTAMP.json

# Neo4j backup
docker exec mem0-neo4j neo4j-admin database backup mem0 --backup-dir=/var/backups

# Upload to S3
aws s3 sync \$BACKUP_DIR s3://my-backup-bucket/mem0/ --delete

# Keep only last 30 days
find \$BACKUP_DIR -type f -mtime +30 -delete
```

## 5.4 Monitoring Setup
```bash
# Start Prometheus + Grafana for metrics
docker run -d --name prometheus -p 9090:9090 prom/prometheus
docker run -d --name grafana -p 3000:3000 grafana/grafana

# Connect Mem0 API to Prometheus exporter
# (Add metrics endpoint to FastAPI)
```

---

# BƯỚC 6: PRODUCTION DEPLOYMENT CHECKLIST

✅ Docker Compose running & healthy
✅ All services pass health checks
✅ API accessible via Nginx HTTPS
✅ Rate limiting configured
✅ Database backups automated (daily)
✅ Monitoring/alerting setup (Prometheus/Grafana)
✅ Logs centralized (ELK stack hoặc CloudWatch)
✅ Secrets not in .env file
✅ SSL certificates auto-renewed (certbot)
✅ Auto-restart on failure (`restart: unless-stopped`)
✅ Resource limits set (CPU, memory)
✅ Network isolation (VPC/firewall)

---

# COMMON ISSUES & TROUBLESHOOTING

## Issue 1: API can't connect to Postgres
```bash
# Check DNS resolution in docker network
docker exec mem0-api nslookup postgres

# Check Postgres is listening
docker logs mem0-postgres | grep "ready to accept"

# Fix: Make sure depends_on is set & postgres healthcheck passes
```

## Issue 2: Qdrant storage full
```bash
# Check Qdrant disk usage
curl http://localhost:6333/health
# Look for "qdrant_storage_usage_bytes"

# Prune old collections if needed
curl -X DELETE http://localhost:6333/collections/old_collection
```

## Issue 3: Neo4j won't start (memory)
```bash
# Increase Docker memory limit in docker-compose.yml
neo4j:
  deploy:
    resources:
      limits:
        memory: 4G

# Or restart with more RAM
docker-compose down && docker-compose up -d
```

## Issue 4: High latency on memory retrieval
```bash
# Check Qdrant index optimization
curl http://localhost:6333/collections/memories

# If too many vectors, consider sharding collections by date/user
# Tune vector dimensions: lower = faster but less accurate
```

---

# SCALING RECOMMENDATIONS (Khi ARR > $500K)

## Horizontal Scaling
- Run multiple API instances behind load balancer
- Use managed PostgreSQL (AWS RDS, GCP Cloud SQL)
- Use managed Qdrant (Qdrant Cloud) instead of self-hosted
- Replicate Neo4j across 3+ nodes (cluster mode)

## Kubernetes Migration
```bash
# When traffic becomes significant, migrate to:
# - API on K8s with HPA
# - Postgres on AWS RDS (managed)
# - Qdrant on managed cloud
# - Neo4j cluster (Aura)

helm install mem0 ./helm-chart --values prod-values.yaml
```

---

# MAINTENANCE ROUTINE (Monthly)

1. **Update images** (monthly security patches)
   ```bash
   docker-compose pull
   docker-compose down && docker-compose up -d
   ```

2. **Vacuum Postgres** (optimize storage)
   ```bash
   docker exec mem0-postgres vacuumdb -U mem0_user -d mem0_db -v
   ```

3. **Check resource usage**
   ```bash
   docker stats
   df -h (disk space)
   free -h (memory)
   ```

4. **Review logs for errors**
   ```bash
   docker-compose logs --since 24h | grep -i error
   ```

5. **Test backup restore** (quarterly)
   ```bash
   # Restore from backup to staging, test queries
   ```
