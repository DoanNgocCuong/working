# ML Architecture và System Design

## Thảo luận về Kiến trúc ML System

### Vấn đề: Kiến trúc Model Serving với Anomaly Detector

**Vấn đề được đặt ra:**
- Kiến trúc hiện tại có Model Serving API và Anomaly Detector chạy tuần tự
- Nếu Model Serving API chết thì toàn bộ hệ thống dừng
- Nếu Anomaly Detector chết, có thể không phát hiện được bất thường

**Mặt hại của kiến trúc tuần tự:**
1. **Single point of failure**: Nếu Model Serving API chết thì toàn bộ hệ thống dừng
2. **Tăng latency**: Phải chờ Anomaly Detector xong mới đến Model Serving API
3. **Khó mở rộng về sau**: Không thể scale độc lập từng service
4. **Tốn memory**: Nếu validate data anomaly cần kéo data training lên serving service

**Giải pháp đề xuất:**
- Tách riêng các service để độc lập với nhau
- Nếu một service chết không ảnh hưởng service khác
- Có thể scale từng service độc lập
- Sử dụng cache để cải thiện performance
- Trong cùng 1 cụm thì latency không đáng kể

**Lưu ý về Anomaly Detector:**
- Anomaly detector có thể làm việc độc lập với Model Serving API
- Không nhất thiết phải kéo data training lên serving service
- Có thể sử dụng statistical methods hoặc lightweight models

---

## Cơ chế xử lý Timeout và Fallback LLM

Xem chi tiết trong file: `Cơ chế xử lý timeout.md`

### Tổng quan

Cơ chế fallback được triển khai trong `BaseLLM.predict()` để đảm bảo hệ thống luôn có phản hồi ngay cả khi model chính gặp sự cố. Fallback tự động chuyển sang `gpt-4o-mini` (OpenAI) khi model chính timeout > 1.5s hoặc gặp lỗi.

### Các điểm chính:

1. **Timeout chính**: 1.5 giây cho model chính
2. **Timeout fallback**: 4 giây cho model fallback
3. **Race condition**: Khi timeout, main và fallback chạy song song, task nào xong trước dùng trước
4. **Recovery**: Tự động fallback sang gpt-4o-mini khi main model fail

---

## Rate Limiting và Circuit Breaker

Xem chi tiết trong file: `RATE LIMIT và CIRCUIT BREAKER - Circuit Breaker và SSL Verification.md`

### Rate Limiting

**Mục đích**: Bảo vệ hệ thống khỏi DDoS và abuse

**Cấu hình mặc định:**
- Default: `100/minute`
- `/v1/conversations/end`: `100/minute`
- `/v1/activities/suggest`: `60/minute`
- `/health`: `300/minute`

### Circuit Breaker

**Mục đích**: Ngăn chặn cascading failures khi external APIs bị down

**Cấu hình:**
- Failure threshold: 5 lần
- Recovery timeout: 60 giây

**Áp dụng cho:**
- LLM API calls (`_invoke_llm`)
- Memory API calls (`extract_memories_from_api`)

### SSL Verification

**Mục đích**: Đảm bảo an toàn khi gọi external APIs

- Verify SSL certificate của server
- Ngăn chặn Man-in-the-Middle (MITM) attacks
- Production: Luôn enable (`SSL_VERIFY_ENABLED=True`)


