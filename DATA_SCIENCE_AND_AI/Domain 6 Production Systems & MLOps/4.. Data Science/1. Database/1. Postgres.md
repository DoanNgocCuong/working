## 1.1  t·∫°o b·∫£ng: studio_bot_workflow trong postgres

```

```

## 1.2 Xo√° to√†n b·ªô d·ªØ li·ªáu c·ªßa b·∫£ng 
```
TRUNCATE TABLE studio_bot_workflow;
```

`TRUNCATE TABLE studio_bot_workflow RESTART IDENTITY;`


- `TRUNCATE TABLE ...;` ‚Üí id **kh√¥ng** v·ªÅ l·∫°i 1.
    
- `TRUNCATE TABLE ... RESTART IDENTITY;` ‚Üí id **s·∫Ω** v·ªÅ l·∫°i 1 (n·∫øu sequence kh√¥ng c√≥ gi√° tr·ªã start kh√°c).

### Khi tƒÉng ID b·ªã v·∫•n ƒë·ªÅ 

1. C√°c l·ªánh ƒë·ªÉ ki·ªÉm tra v·∫•n ƒë·ªÅ  
2. Ch·ªâ ra v·∫•n ƒë·ªÅ  
3. Fix

```
SELECT id FROM studio_bot_workflow ORDER BY id DESC LIMIT 1;  
  
SELECT last_value FROM studio_bot_workflow_id_seq;
```

```
- Trong b·∫£ng `studio_bot_workflow` **ID cao nh·∫•t = 10011**
    
- Nh∆∞ng sequence `studio_bot_workflow_id_seq` **ƒëang ·ªü s·ªë 5**
    

‚û°Ô∏è **Sequence ƒëang ch·∫°y sai ho√†n to√†n** ‚Üí backend insert ti·∫øp ‚Üí n√≥ s·∫Ω c·ªë g√°n ID = 6 ‚Üí nh∆∞ng ID = 6 ƒë√£ t·ªìn t·∫°i ‚Üí **tr√πng kh√≥a ‚Üí 500**.
```

### TƒÉng id t·ª± ƒë·ªông

```
SELECT setval('studio_bot_workflow_id_seq', (SELECT MAX(id) FROM studio_bot_workflow));
```

```
# FIX D·ª®T ƒêI·ªÇM (b·∫Øt bu·ªôc ph·∫£i l√†m)

Ch·∫°y l·ªánh n√†y trong PostgreSQL:

`SELECT setval('studio_bot_workflow_id_seq', (SELECT MAX(id) FROM studio_bot_workflow));`

B·∫°n s·∫Ω th·∫•y sequence nh·∫£y l√™n:

`last_value = 10011`

Sau ƒë√≥ backend insert s·∫Ω sinh ti·∫øp:

`10012, 10013, 10014, ...`

‚û°Ô∏è **Kh√¥ng c√≤n b√°o l·ªói tr√πng ID n·ªØa.**
```

```
# ‚ùó T·∫°i sao sequence t·ª•t v·ªÅ 5?

C√≥ 3 l√Ω do ph·ªï bi·∫øn:

### 1. B·∫°n ƒë√£ import/restore DB th·ªß c√¥ng

Sequence kh√¥ng restore theo.

### 2. B·∫°n ƒë√£ TRUNCATE nh∆∞ng kh√¥ng d√πng RESTART

‚Üí Sequence b·ªã reset sai.

### 3. B·∫°n ƒë√£ ALTER/RENAME TABLE

‚Üí Sequence b·ªã detached.

### 4. B·∫°n khi ƒë·ªïi schema JSONB ‚Üí TEXT

C√≥ th·ªÉ ƒë√£ t·∫°o l·∫°i table (ho·∫∑c drop/restore table) kh√¥ng reset sequence chu·∫©n.
```

## 1.3 C√°ch l·∫•y l·∫°i history c·ªßa lesson_... trong postgres

# ‚úÖ **1. B·∫£ng MySQL b·∫°n cung c·∫•p**

|T√™n c·ªôt|MySQL Type|Ghi ch√∫|
|---|---|---|
|id|int, auto_increment|PRIMARY KEY|
|name|varchar(128)||
|description|varchar(2048)||
|scenario|json||
|create_at|bigint||
|update_at|bigint||
|is_loading|tinyint(1)|0/1|

---

# üü¶ **2. T∆∞∆°ng ƒë∆∞∆°ng trong PostgreSQL**

| MySQL            | PostgreSQL                            | Gi·∫£i th√≠ch                      |
| ---------------- | ------------------------------------- | ------------------------------- |
| `int`            | `INTEGER`                             | gi·ªëng nhau                      |
| `auto_increment` | `SERIAL` ho·∫∑c `GENERATED AS IDENTITY` | auto tƒÉng                       |
| `varchar(128)`   | `VARCHAR(128)`                        | gi·ªëng nhau                      |
| `varchar(2048)`  | `VARCHAR(2048)`                       | gi·ªëng nhau                      |
| `json`           | `JSONB` (khuy√™n d√πng) ho·∫∑c `JSON`     | JSONB nhanh h∆°n                 |
| `bigint`         | `BIGINT`                              | gi·ªëng                           |
| `tinyint(1)`     | **BOOLEAN** (0/1) ho·∫∑c `SMALLINT`     | PostgreSQL **kh√¥ng c√≥ tinyint** |


```
CREATE TABLE lesson_studio_bot (
    id SERIAL PRIMARY KEY,
    name VARCHAR(128),
    description VARCHAR(2048),
    scenario JSONB,
    create_at BIGINT,
    update_at BIGINT,
    is_loading BOOLEAN DEFAULT FALSE
);
```

```
ALTER TABLE lesson_studio_bot ADD COLUMN system_prompt TEXT;
```
```
ALTER TABLE lesson_studio_bot 
    ADD COLUMN IF NOT EXISTS system_prompt TEXT,
    ADD COLUMN IF NOT EXISTS provider_name VARCHAR(255),
    ADD COLUMN IF NOT EXISTS generation_params JSONB,
    ADD COLUMN IF NOT EXISTS system_extraction_variables JSONB,
    ADD COLUMN IF NOT EXISTS system_prompt_generation TEXT,
    ADD COLUMN IF NOT EXISTS system_extraction_profile JSONB,
    ADD COLUMN IF NOT EXISTS format_output TEXT,
    ADD COLUMN IF NOT EXISTS data_excel JSONB;
```

```
  
ALTER TABLE lesson_studio_bot  
    ALTER COLUMN system_extraction_variables TYPE TEXT;  
  
ALTER TABLE lesson_studio_bot  
    ALTER COLUMN system_extraction_profile TYPE TEXT;
```
---
# 1.4 # L·∫•y to√†n b·ªô c·ªôt v√† b·∫£ng trong ƒë√¢y 

```
SELECT 
    table_name, 
    column_name
FROM 
    information_schema.columns
WHERE 
    table_schema = 'public'
ORDER BY 
    table_name, 
    ordinal_position;
```

