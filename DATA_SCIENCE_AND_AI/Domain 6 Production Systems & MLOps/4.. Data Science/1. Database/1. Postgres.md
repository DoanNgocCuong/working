# 1. ...
## 1.1  t·∫°o b·∫£ng: studio_bot_workflow trong postgres

```

```

## 1.2 Xo√° to√†n b·ªô d·ªØ li·ªáu c·ªßa b·∫£ng 
```
TRUNCATE TABLE studio_bot_workflow;
```

`TRUNCATE TABLE studio_bot_workflow RESTART IDENTITY;`


- `TRUNCATE TABLE ...;` ‚Üí id **kh√¥ng** v·ªÅ l·∫°i 1.
    
- `TRUNCATE TABLE ... RESTART IDENTITY;` ‚Üí id **s·∫Ω** v·ªÅ l·∫°i 1 (n·∫øu sequence kh√¥ng c√≥ gi√° tr·ªã start kh√°c).

### Khi tƒÉng ID b·ªã v·∫•n ƒë·ªÅ 

1. C√°c l·ªánh ƒë·ªÉ ki·ªÉm tra v·∫•n ƒë·ªÅ  
2. Ch·ªâ ra v·∫•n ƒë·ªÅ  
3. Fix

```
SELECT id FROM studio_bot_workflow ORDER BY id DESC LIMIT 1;  
  
SELECT last_value FROM studio_bot_workflow_id_seq;
```

```
- Trong b·∫£ng `studio_bot_workflow` **ID cao nh·∫•t = 10011**
    
- Nh∆∞ng sequence `studio_bot_workflow_id_seq` **ƒëang ·ªü s·ªë 5**
    

‚û°Ô∏è **Sequence ƒëang ch·∫°y sai ho√†n to√†n** ‚Üí backend insert ti·∫øp ‚Üí n√≥ s·∫Ω c·ªë g√°n ID = 6 ‚Üí nh∆∞ng ID = 6 ƒë√£ t·ªìn t·∫°i ‚Üí **tr√πng kh√≥a ‚Üí 500**.
```

### TƒÉng id t·ª± ƒë·ªông

```
SELECT setval('studio_bot_workflow_id_seq', (SELECT MAX(id) FROM studio_bot_workflow));
```

```
# FIX D·ª®T ƒêI·ªÇM (b·∫Øt bu·ªôc ph·∫£i l√†m)

Ch·∫°y l·ªánh n√†y trong PostgreSQL:

`SELECT setval('studio_bot_workflow_id_seq', (SELECT MAX(id) FROM studio_bot_workflow));`

B·∫°n s·∫Ω th·∫•y sequence nh·∫£y l√™n:

`last_value = 10011`

Sau ƒë√≥ backend insert s·∫Ω sinh ti·∫øp:

`10012, 10013, 10014, ...`

‚û°Ô∏è **Kh√¥ng c√≤n b√°o l·ªói tr√πng ID n·ªØa.**
```

```
# ‚ùó T·∫°i sao sequence t·ª•t v·ªÅ 5?

C√≥ 3 l√Ω do ph·ªï bi·∫øn:

### 1. B·∫°n ƒë√£ import/restore DB th·ªß c√¥ng

Sequence kh√¥ng restore theo.

### 2. B·∫°n ƒë√£ TRUNCATE nh∆∞ng kh√¥ng d√πng RESTART

‚Üí Sequence b·ªã reset sai.

### 3. B·∫°n ƒë√£ ALTER/RENAME TABLE

‚Üí Sequence b·ªã detached.

### 4. B·∫°n khi ƒë·ªïi schema JSONB ‚Üí TEXT

C√≥ th·ªÉ ƒë√£ t·∫°o l·∫°i table (ho·∫∑c drop/restore table) kh√¥ng reset sequence chu·∫©n.
```


1. `TRUNCATE TABLE your_table;`
    - X√≥a to√†n b·ªô d·ªØ li·ªáu trong b·∫£ng r·∫•t nhanh, **kh√¥ng** reset ID/sequence, kh√¥ng ƒë·ªïi c·∫•u tr√∫c b·∫£ng.[^1][^2]
2. `TRUNCATE TABLE your_table RESTART IDENTITY;`
    - X√≥a to√†n b·ªô d·ªØ li·ªáu v√† reset c√°c c·ªôt IDENTITY/sequence v·ªÅ gi√° tr·ªã ban ƒë·∫ßu, b·∫£ng r·ªóng gi·ªëng l√∫c m·ªõi t·∫°o nh∆∞ng schema gi·ªØ nguy√™n.[^2][^3][^1]
3. `TRUNCATE TABLE your_table RESTART IDENTITY CASCADE;`
    - Nh∆∞ tr√™n, nh∆∞ng ƒë·ªìng th·ªùi truncate lu√¥n c√°c b·∫£ng c√≥ foreign key tham chi·∫øu t·ªõi b·∫£ng n√†y, gi√∫p c·∫£ c·ª•m b·∫£ng li√™n quan ƒë·ªÅu ‚Äúv·ªÅ 0‚Äù.[^3][^4][^1]

## Khi mu·ªën ‚Äús·∫°ch nh∆∞ m·ªõi‚Äù c·∫£ v·ªÅ file (√≠t d√πng)

- N·∫øu b·∫Øt bu·ªôc mu·ªën b·∫£ng th·∫≠t s·ª± gi·ªëng nh∆∞ v·ª´a create (k·ªÉ c·∫£ file tr√™n ƒëƒ©a), c√≥ th·ªÉ:
    
    sql
    
    `BEGIN; CREATE TABLE new_table ( ...ƒë·ªãnh nghƒ©a gi·ªëng old_table... ); DROP TABLE old_table; ALTER TABLE new_table RENAME TO old_table; COMMIT;`
    
    C√°ch n√†y t·∫°o b·∫£ng m·ªõi ho√†n to√†n, r·ªìi ƒë·ªïi t√™n thay th·∫ø b·∫£ng c≈©, th∆∞·ªùng ch·ªâ d√πng khi t·ªëi ∆∞u dung l∆∞·ª£ng l·ªõn ho·∫∑c x·ª≠ l√Ω bloat.[](https://andyatkinson.com/copy-swap-drop-postgres-table-shrink)‚Äã
    

Trong ƒëa s·ªë case (test, reset d·ªØ li·ªáu, ch·∫°y batch nhi·ªÅu l·∫ßn), ch·ªâ c·∫ßn¬†`TRUNCATE your_table RESTART IDENTITY [CASCADE]`¬†l√† ƒë·ªß ‚Äúv·ªÅ 0‚Äù ƒë√∫ng nhu c·∫ßu.[](https://www.tutorialsteacher.com/postgresql/truncate-tables)



## 1.3 C√°ch l·∫•y l·∫°i history c·ªßa lesson_... trong postgres

### ‚úÖ **1. B·∫£ng MySQL b·∫°n cung c·∫•p**

|T√™n c·ªôt|MySQL Type|Ghi ch√∫|
|---|---|---|
|id|int, auto_increment|PRIMARY KEY|
|name|varchar(128)||
|description|varchar(2048)||
|scenario|json||
|create_at|bigint||
|update_at|bigint||
|is_loading|tinyint(1)|0/1|

---

### üü¶ **2. T∆∞∆°ng ƒë∆∞∆°ng trong PostgreSQL**

| MySQL            | PostgreSQL                            | Gi·∫£i th√≠ch                      |
| ---------------- | ------------------------------------- | ------------------------------- |
| `int`            | `INTEGER`                             | gi·ªëng nhau                      |
| `auto_increment` | `SERIAL` ho·∫∑c `GENERATED AS IDENTITY` | auto tƒÉng                       |
| `varchar(128)`   | `VARCHAR(128)`                        | gi·ªëng nhau                      |
| `varchar(2048)`  | `VARCHAR(2048)`                       | gi·ªëng nhau                      |
| `json`           | `JSONB` (khuy√™n d√πng) ho·∫∑c `JSON`     | JSONB nhanh h∆°n                 |
| `bigint`         | `BIGINT`                              | gi·ªëng                           |
| `tinyint(1)`     | **BOOLEAN** (0/1) ho·∫∑c `SMALLINT`     | PostgreSQL **kh√¥ng c√≥ tinyint** |


```
CREATE TABLE lesson_studio_bot (
    id SERIAL PRIMARY KEY,
    name VARCHAR(128),
    description VARCHAR(2048),
    scenario JSONB,
    create_at BIGINT,
    update_at BIGINT,
    is_loading BOOLEAN DEFAULT FALSE
);
```

```
ALTER TABLE lesson_studio_bot ADD COLUMN system_prompt TEXT;
```
```
ALTER TABLE lesson_studio_bot 
    ADD COLUMN IF NOT EXISTS system_prompt TEXT,
    ADD COLUMN IF NOT EXISTS provider_name VARCHAR(255),
    ADD COLUMN IF NOT EXISTS generation_params JSONB,
    ADD COLUMN IF NOT EXISTS system_extraction_variables JSONB,
    ADD COLUMN IF NOT EXISTS system_prompt_generation TEXT,
    ADD COLUMN IF NOT EXISTS system_extraction_profile JSONB,
    ADD COLUMN IF NOT EXISTS format_output TEXT,
    ADD COLUMN IF NOT EXISTS data_excel JSONB;
```

```
  
ALTER TABLE lesson_studio_bot  
    ALTER COLUMN system_extraction_variables TYPE TEXT;  
  
ALTER TABLE lesson_studio_bot  
    ALTER COLUMN system_extraction_profile TYPE TEXT;
```
---
## 1.4 # L·∫•y to√†n b·ªô c·ªôt v√† b·∫£ng trong ƒë√¢y 

```
SELECT 
    table_name, 
    column_name
FROM 
    information_schema.columns
WHERE 
    table_schema = 'public'
ORDER BY 
    table_name, 
    ordinal_position;
```


## 1.5 Reset id v·ªÅ t·ª´ 1  b·∫±ng c√°ch s·ª≠ d·ª•ng seq

```postgres
-- 1) T·∫°o sequence m·ªõi ƒë·∫øm t·ª´ 1
CREATE SEQUENCE agenda_agent_prompting_id_seq_new START 1;

-- 2) G√°n l·∫°i id tƒÉng d·∫ßn t·ª´ 1 theo th·ª© t·ª± c≈©
UPDATE agenda_agent_prompting
SET id = s.new_id
FROM (
    SELECT id AS old_id,
           ROW_NUMBER() OVER (ORDER BY id) AS new_id
    FROM agenda_agent_prompting
) AS s
WHERE agenda_agent_prompting.id = s.old_id;

-- 3) ƒê·∫∑t default c·ªßa c·ªôt id d√πng sequence m·ªõi
ALTER TABLE agenda_agent_prompting
ALTER COLUMN id SET DEFAULT nextval('agenda_agent_prompting_id_seq_new');

-- 4) ƒê·ªìng b·ªô gi√° tr·ªã hi·ªán t·∫°i c·ªßa sequence
SELECT setval('agenda_agent_prompting_id_seq_new',
              (SELECT MAX(id) FROM agenda_agent_prompting));
```

Gi·ªù mu·ªën xo√°: agenda_agent_prompting_id_seq ƒëi

v√† rename agenda_agent_prompting_id_seq_new v·ªÅ agenda_agent_prompting_id_seq

ƒëi


```sql
-- 1) X√≥a sequence c≈©
DROP SEQUENCE IF EXISTS agenda_agent_prompting_id_seq;

-- 2) Rename sequence m·ªõi v·ªÅ t√™n c≈©
ALTER SEQUENCE agenda_agent_prompting_id_seq_new 
RENAME TO agenda_agent_prompting_id_seq;
```



```sql
-- ki·ªÉm tra xem sequence
SELECT sequencename FROM pg_sequences WHERE sequencename LIKE 'agenda_agent%';

-- Li√™n k·∫øt sequence v·ªõi c·ªôt id
ALTER SEQUENCE agenda_agent_prompting_id_seq 
OWNED BY agenda_agent_prompting.id;

-- Sau khi ch·∫°y xong, ki·ªÉm tra l·∫°i b·∫±ng:
SELECT pg_get_serial_sequence('agenda_agent_prompting', 'id');
```


---
# 2. cron job update c·ªôt n√†o ƒë√≥ v√†o 12h ƒë√™m 

```sql
-- C·∫≠p nh·∫≠t to√†n b·ªô

UPDATE studio_bot_workflow

SET provider_name = 'groq',

¬† ¬† generation_params = '{"model": "openai/gpt-oss-20b", "top_p": 1, "stream": false, "temperature": 0, "reasoning_effort": "low", "max_completion_tokens": 1024}';


-- [2025-12-11 18:47:33] Connected to robot_ai_workflow
-- [2025-12-11 18:47:33] Unsafe query: 'Update' statement without 'where' updates all table rows at once


-- Ch·ªâ c·∫≠p nh·∫≠t khi kh√°c gi√° tr·ªã (tr√°nh ghi ƒë√® kh√¥ng c·∫ßn thi·∫øt)

UPDATE studio_bot_workflow

SET provider_name = 'groq',

¬† ¬† generation_params = '{"model": "openai/gpt-oss-20b", "top_p": 1, "stream": false, "temperature": 0, "reasoning_effort": "low", "max_completion_tokens": 1024}'

WHERE provider_name <> 'groq'

¬† ¬†OR generation_params IS DISTINCT FROM '{"model": "openai/gpt-oss-20b", "top_p": 1, "stream": false, "temperature": 0, "reasoning_effort": "low", "max_completion_tokens": 1024}';
```



